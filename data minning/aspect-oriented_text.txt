5IEnumerable<String> (19 items)4 
aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop aop How do I intercept a method call in C#? <p>For a given class I would like to have tracing functionality i.e. I would like to log every method call (method signature and actual parameter values) and every method exit (just the method signature).    </p>

<p>How do I accomplish this assuming that:  </p>

<ul>
<li>I don't want to use any 3rd party
AOP libraries for C#,</li>
<li>I don't want to add duplicate code to all the methods that I want to trace,  </li>
<li>I don't want to change the public API of the class - users of the class should be able to call all the methods in exactly the same way.  </li>
</ul>

<p>To make the question more concrete let's assume there are 3 classes:  </p>

<pre><code> public class Caller 
 {
     public static void Call() 
     {
         Traced traced = new Traced();
         traced.Method1();
         traced.Method2(); 
     }
 }

 public class Traced 
 {
     public void Method1(String name, Int32 value) { }

     public void Method2(Object object) { }
 }

 public class Logger
 {
     public static void LogStart(MethodInfo method, Object[] parameterValues);

     public static void LogEnd(MethodInfo method);
 }
</code></pre>

<p>How do I invoke <em>Logger.LogStart</em> and <em>Logger.LogEnd</em> for every call to <em>Method1</em> and <em>Method2</em> without modifying the <em>Caller.Call</em> method and without adding the calls explicitly to <em>Traced.Method1</em> and <em>Traced.Method2</em>?</p>

<p>Edit:  What would be the solution if I'm allowed to slightly change the Call method?</p>
 Aspect Oriented Programming vs. Object-Oriented Programming <p>Like most developers here and in the entire world, I have been developing software systems using object-oriented programming (OOP) techniques for many years. So when I read that aspect-oriented programming (AOP) addresses many of the problems that traditional OOP doesn't solve completely or directly, I pause and think, is it real?</p>

<p>I have read a lot of information trying to learn the keys of this AOP paradigm and I´m in the same place, so, I wanted to better understand its benefits in real world application development.</p>

<p>Does somebody have the answer?</p>
 What is aspect-oriented programming? <p>I understand object oriented programming, and have been writing OO programs for a long time.  People seem to talk about aspect-oriented programming, but I've never really learned what it is or how to use it.  What is the basic paradigm?</p>

<p>This question is related, but doesn't quite ask it:</p>

<p><a href="http://stackoverflow.com/questions/232884/aspect-oriented-programming-vs-object-oriented-programming">Aspect-Oriented Programming vs. Object Oriented Programming</a></p>
 Aspect-oriented programming examples <p>Can anyone post an example of Aspect-oriented programming (AOP) that is <em>not</em> logging?</p>

<p>I've looked at several resources but all the examples are trivial logging. What is it useful for?</p>
 Do you use AOP (Aspect Oriented Programming) in production software? <p><a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming" rel="nofollow">AOP</a> is an interesting programming paradigm in my opinion. However, there haven't been discussions about it yet here on stackoverflow (at least I couldn't find them). What do you think about it in general? Do you use AOP in your projects? Or do you think it's rather a niche technology that won't be around for a long time or won't make it into the mainstream (like OOP did, at least in theory ;))? </p>

<p>If you do use AOP then please let us know which tools you use as well. Thanks!</p>
 What is the best implementation for AOP in .Net? <p>There is a lot of AOP implementation in C#, VB.net. this is some of AOP Implementations:  </p>

<ul>
<li>Aspect.NET</li>
<li>LOOM.NET</li>
<li>Enterprise Library 3.0 Policy Injection Application Block</li>
<li>Puzzle.NAspect</li>
<li>AspectDNG</li>
<li>Aspect#</li>
<li>Compose*</li>
<li>PostSharp </li>
<li>Seasar.NET</li>
<li>DotSpect (.SPECT)</li>
<li>The Spring.NET Framework as part of its functionality</li>
<li>Wicca and Phx.Morph</li>
<li>SetPoint</li>
<li>An exhaustive analysis on AOSD solutions for.NET is available from Twente University</li>
<li>...</li>
</ul>

<p>What is the best implementation for AOP in .Net? What I should use?</p>
 Spring AOP vs AspectJ <p>I am under the impression that Spring-AOP is best used for application specific tasks such as security, logging, transactions, etc. as it uses custom Java5 annotations as a framework. However, AspectJ seems to be more friendly design-patterns wise. </p>

<p>Can anyone highlight the various pros and cons of using Spring-AOP vs AspectJ in a spring application??</p>
 Ruby dependency injection libraries <p>I've been looking at some Ruby dependency injection libraries.  In particularly, I checked out  <a href="http://needle.rubyforge.org/" rel="nofollow">Needle</a> and <a href="http://copland.rubyforge.org/" rel="nofollow">Copland</a>.  They've been around for quite awhile, yet not a lot of usages.  </p>

<p>What are some of the pros and cons of using these two libraries? It sure seems like a lot of libraries / frameworks out there could make good use of these two libraries, e.g. <a href="http://github.com/sam/extlib/tree/master/lib/extlib/hook.rb" rel="nofollow">Merb / Datamapper's Hook</a>.</p>
 Aspect Oriented Programming in C# <p>HI, Any good resources to wrap my head around Aspect Oriented Programming?</p>

<p>PS:- I need to understand AO programming not the libraries or frameworks available for .NET or C# :) </p>
 Built-in AOP in C# - is it on the way? <p>In large apps I find myself really wishing I had built-in AOP facilities. As it stands in C# the best you can do is factories and RealProxys, PostSharp, ICorDebug, ICorProfiler or injection frameworks. There is no clean built-in way of doing AOP. </p>

<p>Is there any indication anywhere (blog post / internal discussion) that indicates that AOP is on the way? </p>
 Aspect-Oriented Objective-C Library? <p>Is there any Aspect-Oriented Objective-C library that I could perhaps use for iPhone development?</p>
 Anyone with Postsharp experience in production? <p>Does anyone out there has used <a href="http://www.postsharp.org/" rel="nofollow">Postsharp</a> AOP framework in production environment? Are there any pitfalls? In order to do some logging etc, can Postsharp be used in conjunction with log4net ?</p>

<p>Any tutorials on using Postsharp with Web Apps and/or log4net will be highly appreciated.</p>

<p>Thanks In Advance.</p>
 Aspect Oriented Programing (AOP) solutions for C# (.Net) and their features <p>I would like to ask for 3 information here:</p>

<ol>
<li><p>There is <strong>no integrated solution</strong> for Aspect Oriented Programing (AOP) in C# (.Net) <strong>from Microsoft</strong> is that correct ? Is there any such solution under development or planned ?</p></li>
<li><p><strong>What solutions are there</strong> that allow Aspect Oriented Programing (AOP) to be used in C# (.Net) ? What are they <strong>advantages/disadvantages</strong> ? I haven't find any comprihensive list that would contain all avatable options and some information for me to decide which is the one to use. The closest is <a href="http://csharp-source.net/open-source/aspect-oriented-frameworks">this list</a>.</p></li>
<li><p>What is (in your opinion) <strong>the best AOP</strong> solution <strong>for C#(.Net)</strong> considering following <strong>criteria:</strong></p>

<ol>
<li>it schould work similar to AspectJ and has similar syntax</li>
<li>simplicity of use: no XML configuration should be needed - just write some regular classes, some aspect classes and compile to weave it all together, then run.</li>
<li>should include all features of AspectJ. Support for generics.</li>
<li>solution should be stable, widely used and mainteined.</li>
<li>should offer weaving of binaries (so could be used ) or C# source code.</li>
<li>GUI tool for visualising (or even better - plugin to VS) is an advantage.</li>
</ol></li>
</ol>

<p>I think that if something fullfils most of criteria in 3. then it is a candidate for a generaly used solution. And I cannot find anywhere if some of existing solutions fits to my needs.</p>
 What ever happened to Aspect Oriented Programming? <p>I remember that in the late 1990s and early 2000s Aspect Oriented Programming (AOP) was supposed to be the "Next Big Thing". Nowadays I see some AOP still around, but it seems to have faded into the background.</p>
 Performance impact of using aop <p>We have started to use spring aop for cross cutting aspects of our application (security &amp; caching at the moment). </p>

<p>My manager worries about the performance impact of this technology although he fully understands the benefits.</p>

<p>My question, did you encounter performance problems introduced by the use of aop (specifically spring aop)?</p>
 Help and Information about Aspect Oriented Programming <p>I'm a newcomer to the idea of aspect-oriented programming but I would like to explore the idea of using it on my project for handling logging, reporting, etc.  To this end I have some questions:</p>

<ul>
<li>Should I bother exploring this path of AOP for these limited purposes?</li>
<li>What .NET Frameworks supporting AOP are available?</li>
<li>Which of these frameworks support a fluent interface (me hates XML config) :)</li>
</ul>
 What are the disadvantages of Aspect-Oriented Programming (AOP)? <p>What are the possible and critical disadvantages of Aspect-Oriented Programming?</p>

<p>For example: cryptic debugging for newbies (readability impact)</p>
 AOP... Should I unlearn OOP? <p>I have skimmed the online documentation, read the wiki entry, the posts and the blogs, but I'm still puzzled.</p>

<ul>
<li>What is, in a nutshell, <strong>Aspect Oriented Programming</strong> ?</li>
<li>Is it simply better then Object Oriented Programming ? Should I unlearn OOP ?</li>
<li>If not, how do I know when to use one or the other ? What are the main differences between the two ?</li>
<li>Can I refact one into the other ?</li>
</ul>

<p>I have always been an OO man and I want to know if I need to commit treason.</p>

<p>Seriously, I'm starting a new project soon and I want to make the right choices at the beginning.</p>
 How to make a simple dynamic proxy in C# <p>I want to build a dynamic proxy object to add certain functionality to an object.</p>

<p>basically i want to receive an object, wrap it with an object that looks identical to the original i got, and intercept all the calls.</p>

<pre><code>class Wrapper : DynamicProxy// dynamic proxy is not a reall class, but i guess something like this exists...
{
    public static T Wrap(T obj)
    {
        return (T) new Wrapper(obj);
    }

    public override object InterceptCall(MethodInfo info, object[] args)
    {
        // do stuff
    }

}
</code></pre>

<hr>

<p>Just to clarify, I want to do something similar to the WCF channel factory...</p>

<hr>

<p>I'm adding a bounty, because I need a good way to proxy classes (not interfaces) and to handle non virtual methods (as if I inherited and added a methond under the "new" keyword).
I'm sure all this is very possible as the .Net does it.</p>
 What are the different methods for injecting cross-cutting concerns? <p>What are the different methods for injecting cross-cutting concerns into a class so that I can minimize the coupling of the classes involved while keeping the code testable (TDD or otherwise)?</p>

<p>For example, consider if I have a class that requires both logging functionality and centralized exception management. Should I use DIP and inject both required concerns via an interface into the class that requires them? Should I use a service locater that I pass to each class that will require some cross cutting functionality? Is there a different solution altogether? Am I asking the wrong question entirely?</p>
 Aspect Orientated Programming in Qt <p>I'm trying to get my head around AOP and some Qt Code would really help.</p>

<p>From <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming" rel="nofollow">wikipedia</a> here is some sample code (easy for a Qt/C++ programmer to read):</p>

<pre><code>void transfer(Account fromAcc, Account toAcc, int amount, User user, Logger logger)
   throws Exception {
   logger.info("transferring money...");
   if (! checkUserPermission(user)){
     logger.info("User has no permission.");
     throw new UnauthorizedUserException();
   }
   if (fromAcc.getBalance() &lt; amount) {
     logger.info("Insufficient Funds, sorry :( ");
     throw new InsufficientFundsException();
   }

   fromAcc.withdraw(amount);
   toAcc.deposit(amount);

   //get database connection

   //save transactions

   logger.info("Successful transaction. :) ");
 }
</code></pre>

<p>And then "aspectized":</p>

<pre><code>void transfer(Account fromAcc, Account toAcc, int amount) throws Exception {


   if (fromAcc.getBalance() &lt; amount) {
     throw new InsufficientFundsException();
   }

   fromAcc.withdraw(amount);
   toAcc.deposit(amount);
 }

aspect Logger 
{

    void Bank.transfer(Account fromAcc, Account toAcc, int amount, User user, Logger logger)
    {     
        logger.info("transferring money...");
    }

    void Bank.getMoneyBack(User user, int transactionId, Logger logger)
    {
        logger.info("User requested money back");
    }

    // other crosscutting code...
}
</code></pre>

<p>Qt has signals and slots to decouple objects. But I still need to emit signals.</p>

<p>So: Can this be done with Qt or do I need some special framework/preprocessors as referenced in the wikipedia article?</p>

<p>I have a feeling that there must be some trick since Qt uses the Meta Object Compiler and some functionality might be "injected" with dynamic methods.... just spit-balling here ;)</p>

<p><strong>Edit</strong>: To give a better context: I really like the dynamic aspects (power) of the Qt meta object with signals and slots and would like to keep a Qt feel to it. Thus, my idea is to make use of slots (or signals) as <strong>point cuts</strong>. For example:</p>

<p>If I define <code>slot Bank::transfer(...)</code> and then <code>signal Bank::OnBeforeTranfer()</code> and <code>signal Bank::OnAfterTransfer()</code>. If I then connect them to other aspects say <code>Security::transfer()</code> and <code>Logger::transfer()</code> (all QObjects) I can block calls (like fail OnBeforeTransfer).</p>

<p>But, if we then take it to the <em>next evolution</em> to get less and cleaner code I would like to get rid of the <code>OnXXXX</code> signals and connect the <code>Bank::transfer</code> slot to <code>Security::transfer</code> slot and <code>Logger::transfer</code>. Anything dynamic in Qt? : Like order of calling slots and and preventing next call in the "<em>slot chain</em>"?</p>

<p>This whole context can still be considered AOP right? I'm trying to stick to "method level point cuts" or am I totally beside the point here?</p>
 Cool PostSharp aspects <p>I'm looking for interesting PostSharp aspects - anything that you found useful and wouldn't mind sharing.</p>
 Mono Cecil vs. PostSharp Core vs. Microsoft CCI for implementing AOP framework <p>Which is the better in terms of capabilities, easy of use, documentation, samples, community/support, VS integration, known implementations, long-term viability, and build speed to implement a custom AOP framework?</p>

<p>I'll start with what I know (I have only tried PostSharp to so far):</p>

<ul>
<li><strong>Microsoft Common Compiler
Instrastruture (CCI)</strong>: I've read that
is used for FxCop, ILMerge, Spec# and
Code Contracts. It seems to be very low level <a href="http://www.jasonbock.net/JB/Default.aspx?blog=entry.3dc8f8f4b5564b3380ce6e21bc56449c" rel="nofollow">as it does not even take care of correcting offsets for branch codes that are borken when IL is modified with it</a>.</li>
<li><strong>PostSharp</strong> is 5 years old, has many
capabilities for AOP (e.g. abstracts
some things you would need to have to
do manually with IL away), source
code available, developed/supported
by only one guy but he is planning on
making this a business, has
documentation but could be better,
builds take about twice as long, very
little samples on how to inject IL
and version 2.0 will be released soon
which promises to be much improved.</li>
<li><strong>Mono Cecil</strong>:  Written by one guy, part
of the Mono suite and there is a
plug-in for Reflector called Reflexil
that uses Mono Cecil.</li>
</ul>
 Unit Testing and PostSharp <p>I'm wondering what the best way to do this is... I'm interested in introducing PostSharp into one of my projects, but I'm not sure how to unit test classes marked with an attribute properly.</p>

<p>For example:</p>

<pre><code>public class hello {

    [MyAspectThatDoesSomethingToTheDatabaseWhenThisMethodGetsCalled]
    public int omg(string lol) {
        //fancy logic in here
    }
}
</code></pre>

<p>I'd like to test the logic in the omg() method, but in the unit tests I need to make sure that the aspect doesn't get called, because there isn't really a database.</p>

<p>Thoughts?</p>
 annotation equivalent of <aop:scoped-proxy> <p>I am moving from an xml config to annoations. i want to convert a session scoped bean that is </p>

<pre><code>&lt;aop:scoped-proxy&gt;
</code></pre>

<p>can this be done with annotations, and if not, what can i do to still keep that declaration working?</p>

<p><strong>edit:</strong>
I am interested in doing this in Spring 2.5</p>
 Simplest way to achieve automatic notification of property change <p>I know that there are solutions out there for implementing INotifyPropertyChanged, but none of them are as simple as: reference this library, create/add this attribute, done (I'm thinking Aspect-Oriented Programming here). Does anyone know of a really simple way to do this? Bonus points if the solution is free. </p>

<p>[EDIT: Really, I'm looking for a free solution, since PostSharp is pretty simple, but it costs $200 minimum.]</p>

<p>Here are some relevant links (none of which provide a simple enough answer):</p>

<ul>
<li><a href="http://www.codeproject.com/KB/miscctrl/Aspects.aspx" rel="nofollow">Aspect Examples (INotifyPropertyChanged via aspects)</a></li>
<li><a href="http://www.codeproject.com/KB/cs/LinFuPart6.aspx" rel="nofollow">LinFu</a></li>
<li><a href="http://www.codeproject.com/Articles/38865/INotifyPropertyChanged-auto-wiring-or-how-to-get-r.aspx" rel="nofollow">INotifyPropertyChanged auto wiring or how to get rid of redundant code</a></li>
<li><a href="http://shecht.wordpress.com/2009/12/12/inotifypropertychanged-with-unity-interception-aop/" rel="nofollow">INotifyPropertyChanged With Unity Interception AOP</a></li>
</ul>
 Advice on AOP with C# <p>I have an ASP.NET 3.5 SP1 Webforms Application.  I use the MVP pattern (supervising controller) with DI (autofac).  My presenters call to the repository contracts defined in my Domain (DDD) which are implemented in an Infrastructure project.</p>

<p>The repository methods the presenters call can hork, so I need to log exceptions and then set an error message on the View.</p>

<p>In the past I would have added <em>another</em> parameter to the Presenter constructors, stored the reference in a Base Presenter, and called a Log method in my Catch blocks.  I don't really like this, but it gets the job done.</p>

<p>I could go the route of using a factory to get the logging class <a href="http://jeffreypalermo.com/blog/constructor-over-injection-anti-pattern/" rel="nofollow">as described here</a>, but I'd like to explore AOP first, as it seems pretty interesting.</p>

<p>I have done the reading on compile-time vs runtime AOP, and I'd like to know what peoples' experiences are with the different solutions, pluses, minuses, words of advice, etc.</p>

<p>From the digging I have done it seems like there are 4 main frameworks for AOP in .NET</p>

<ul>
<li>Castle Windsor - I have stayed away from this in general because it does a whole lot of stuff I really don't need</li>
<li>Spring.net - sounds like it has a good track record but inspires fear through its xml configuration (I don't like non-fluent configurations)</li>
<li>PostSharp - Attribute driven (I like this) but at one point had <a href="http://stackoverflow.com/questions/62798/applying-aop/94083#94083">some line number issues</a>, not sure if they still exist</li>
<li>Unity - a whole lot of stuff I don't really need</li>
</ul>

<p>I see <a href="http://stackoverflow.com/questions/62798/applying-aop">another question</a> that has some good answers but its from a year and a half ago.  Are there newer, "better", frameworks that have been developed in the meantime, or enhancements made to existing solutions that should be taken into consideration? </p>

<p>For reference, I chose Autofac for DI because its fluent, simple to use, couldn't find any negative comments about it, and it just works.</p>

<p>Are there recommendations on which AOP framework I should try?  Thanks for reading all of this and for adding any thoughts.</p>
 AOP Fundamentals <p>Aspect-oriented programming is a subject matter that has been very difficult for me to find any good information on.  My old Software Engineering textbook only mentions it briefly (and vaguely), and the wikipedia and various other tutorials/articles I've been able to find on it give ultra-academic, highly-abstracted definitions of just what it is, how to use it, and when to use it. Definitions I just don't seem to understand.</p>

<p>My (very poor) understanding of AOP is that there are many aspects of producing a high-quality software system that don't fit neatly into a nice little cohesive package. Some classes, such as Loggers, Validators, DatabaseQueries, etc., will be used all over your codebase and thus will be highly-coupled.  My (again, <strong>very</strong> poor) understanding of AOP is that it is concerned with the best practices of how to handle these types of "universally-coupled" packages.</p>

<p><strong>Question :</strong> Is this true, or am I totally off? If I'm completely wrong, can someone please give a concise, laymen explanation for what AOP is, an example of a so-called <em>aspect</em>, and perhaps even provide a simple code example?</p>
 Can I do Aspect Oriented Programming in Scala? <p>I'm not talking about mimicking AOP features in Scala (i.e. using Traits instead of Aspects), I'm wondering is it possible to do true AOP in Scala (i.e. advices, aspects, joint points, weaving etc ...)   </p>
 How to unit test PostSharp aspects? <p>After asking this <a href="http://stackoverflow.com/questions/9533656/">question</a> about implementing an aspect with PostSharp, it came to my mind that I might have to update the code of this aspect in the future, and that I did not want to take the risk of breaking everything afterwards.</p>

<p>So, I started thinking about unit testing.</p>

<p>My first question is:</p>

<blockquote>
  <p>Is it relevant to think about unit testing an aspect?</p>
</blockquote>

<p>I would like the answer to be "yes", but if not, I expect getting other advices.</p>

<p>And then, if so, </p>

<blockquote>
  <p>How to implement unit testing for PostSharp aspects?</p>
</blockquote>
 Applying AOP <p>I've been using some basic AOP style solutions for cross-cutting concerns like security, logging, validation, etc.  My solution has envolved around <a href="http://www.castleproject.org/container/index.html">Castle Windsor</a> and DynamicProxy.  I've gone down this route because I can apply everything using a Boo based DSL and keep my code clean of Attributes.  I was told at the weekend to have a look at <a href="http://www.postsharp.org/">PostSharp</a> as it's supposed to be a "better" solution.  I've had a quick look at PostSharp, but I've been put off by the Attribute usage.</p>

<p>Has anyone tried both solutions and would care to share their experiences?</p>
 PostSharp - il weaving - thoughts <p>I am considering using Postsharp framework to ease the burden of application method logging.
It basically allows me to adorn methods with logging attribute and at compile time injects the logging code needed into the il. I like this solution as it keeps the noise out of the deign time code environment.
Any thoughts, experiences or better alternatives?</p>
 Logging, Aspect Oriented Programming, and Dependency Injection - Trying to make sense of it all <p>I know that logging is a prime use case for AOP. Additionally logging wrappers are also exemplified as cases when you want to use DI so that classes aren't coupled with a specific logging implementation. However, <a href="http://stackoverflow.com/questions/940831/how-to-use-log4net-with-dependency-injection/940872#940872">some consider logging wrappers an anti-pattern</a>. Primarily, such a view is because in most cases the wrapper tends to be simplistic and removes many of the features specific of the logging framework. If you implement those specific features, why not just use the framework directly. </p>

<p>I am aware of the <a href="http://netcommon.sourceforge.net/index.html">Common.Logging</a> facade that attempts to abstract a good amount of the features of log4Net, EntLib, NLog for you. However, even here we still have a dependency of sorts on Common.Logging. Not in a code/unit testing way regarding interfaces and such, but if the project dies (it's been over a year since the last release) or you want to latter switch to a logger not supported, that can cause problems.</p>

<p>That said, <strong>if logging is achieved via AOP, is it even necessary to use DI for the logging dependency</strong> (i.e. why not just directly reference say NLog)? Yes that AOP portion of code would be tightly coupled, but the logic of the classes that one wants to unit test is devoid of logging dependencies (at least before the weaving happens). It's at this point that I'm a bit lost (I haven't tried AOP yet). After weaving, would having not used DI for the AOP code cause problems for unit testing the method under test? Or can one unit test without weaving the AOP code? </p>

<p>Unless logging is a requirement of the user of the software, I'm not sure how useful it is to test that logging has occured with mocks. I would think that the business logic of the method under test is what most would be interested in testing. Lastly, if one wants to use TDD/BDD, wouldn't one have to use DI for the logging dependencies in the AOP code? Or would one just not <em>test drive</em> the AOP side of things? </p>

<p>As you can see, I'm trying to get a feel for what the most practical approach is for developing an application that would be using both AOP for cross-cutting-concerns and DI for design/testing. <strong>Since AOP is relatively new, and logging is the most common example, what is the recommended approach?</strong></p>
 Spring AOP: Annotation on any method called x not working <p>I am getting started with AOP for the first time.</p>

<p>I have my first aspect as follows:</p>

<pre><code>@Aspect
public class SyncLoggingAspect {
    private final Logger logger = Logger.getLogger(this.getClass());

    @Before("execution(public * *(..))")
    public void anyPublic() {
        System.out.println("HIT POINTCUT");
    }
}
</code></pre>

<p>This sucessfully proceeds to be invoked on any method call which is public.  However when I change it to this:</p>

<pre><code>@Before("execution(public * doPoll(..))")
public void anyPublic() {
    System.out.println("HIT POINTCUT");
}
</code></pre>

<p>I would expect it to work on any public method called "doPoll", yet when a method such as this is called nothing happens:</p>

<pre><code>public class GmailContactPoller extends ContactPoller&lt;GoogleUser, ContactPusher&lt;GoogleUser&gt;&gt; {
    Logger logger = Logger.getLogger(this.getClass());

    @Override
    public List&lt;? extends ContactPusher&lt;GoogleUser&gt;&gt; doPoll() throws PollException {
           ...
    }
}
</code></pre>

<p>Is there something I am missing with the EL syntax?  Or is this something to do with the inheritance hierarchy?  The superclass method of doPoll is abstract in an abstract class called Poller.  Does not having an interface cause problems?</p>

<p><b>Edit</b>:  I just noticed my IDE enables spring aspect tooling, and now I have the following compiler warning by the method:</p>

<p>"Description    Resource    Path    Location    Type
advice defined in datasync.aop.aspects.SyncLoggingAspect has not been applied [Xlint:adviceDidNotMatch] SyncLoggingAspect.java  /DataSync/src/main/datasync/aop/aspects"    </p>
 What is the difference between an Abstract Class and a Mixin? <p>I just found an <a href="http://www.infoq.com/news/2008/11/Qi4j">article</a> on a framework in Java that apparently allows it to support <a href="http://en.wikipedia.org/wiki/Mixin">Mixins</a> and something called Composite Oriented Programming (which for all I know might even be the same thing...)  I've also heard of/worked with AOP, and I'm not sure how it differs from this either...</p>
 What's aopalliance all about? And why is guice using it? <p>I'm using guice for dependency injection with aop from <a href="http://aopalliance.sourceforge.net/">aopalliance</a>. I can't quite figure out what's aopalliance all about and who implemented the version (dated from 2004) that's on their sourceforge page. Why is guice using this version instead of a more known package such as AspectJ?</p>

<p>Also, do you know of any tutorials on the aopalliance version?</p>

<p>Thanks</p>
 Best Aspect Oriented Framework for features / build performances in .net <p>In various projects I worked with, we had to use some AOP or dependency injection framework.</p>

<p>We used Enterprise LIbrary, Unity and PostSharp.  </p>

<p>For now, Postsharp is my best choice when it comes to the flexibiity I get over how I generate my aspects.</p>

<p>The only problem is the build time required once PostSharp is installed.  My developpers don't like to pay the time tax even in regard of all the godness comming from PostSharp.</p>

<p>So my question is : <strong>What AOP framework would you recommand for fast build time AND great fonctionnality</strong> ?</p>

<p>Thanks, your answers are greatly appreciated,</p>

<p>Patrick</p>
 Influencing AOP with attributes via IoC; code-smell or elegant? <p>I'm using <code>StructureMap</code> at the moment, generally with convention-based (<code>Scan()</code>) auto-configuration, and I'm looking to add decorator-based caching into the pipeline.</p>

<p>If I configure it manually that is fine, but <code>Scan()</code> is just so <em>convenient</em> when you get lots of dependencies... I'm toying with noting cache <em>suggestions</em> on the interface(s), for example:</p>

<pre><code>public interface IFoo {
    [CacheDuration(20)] // cache for 20 minutes
    string[] DoSomethingReusable();

    SomeType DoSomethingNonReusable(int key); // not cached
}
</code></pre>

<p>with the idea being that by adding a custom "convention" to <code>StructureMap</code>'s scanning (pretty easy) it can spot that one-or-more methods are decorated for caching, and automatically inject a generated caching decorator into that type's pipeline (generating a cache key from the interface/method name and parameter values).</p>

<p>On the plus side it makes adding caching very painless - just decorate the interface a little; but is is a code smell? And/or am I duplicating something that is already solved?</p>
 Call/Return feature of classic C++(C with Classes), what modern languages have it? <p>On page 57 of <a href="http://rads.stackoverflow.com/amzn/click/0201543303">The Design and Evolution of C++</a>, Dr. Stroustrup talks about a feature that was initially part of C with Classes, but it isn't part of modern C++(standard C++). The feature is called <code>call/return</code>. This is an example:</p>

<pre><code>class myclass
{
  call() { /* do something before each call to a function. */ }
  return() { /* do something else after each call to a function. */ }
  ...
};
</code></pre>

<p>I find this feature very interesting. Does any modern language have this particular feature?</p>
 Using Attributes to Call Methods <p>I have various individual methods which all need to perform the same functions before continuing on with their own implementation. Now I could implement these functions in each method, but I was wondering if there's a way to exploit <code>attributes</code> to do this? As a very simple example, all network calls have to check for a network connection. </p>

<pre><code>public void GetPage(string url)
{
   if(IsNetworkConnected())
      ...
   else
      ...           
}
</code></pre>

<p>This would work, but I'd have to call the <code>IsNetworkConnected</code> method for each method that uses the network and handle it individually. Instead, I'd like to do this</p>

<pre><code>[NetworkCall]
public void GetPage(string url)
{
   ...
}
</code></pre>

<p>If the network is unavailable, an error method is called instead and <code>GetPage</code> is ignored, otherwise <code>GetPage</code> is invoked.</p>

<p>This sounds very much like Aspect Orientated Programming, but I don't want to implement an entire framework for a few calls. This is more of a learning exercise than an implementation one, so I was curious as to how something like this would be best implemented.</p>
 Castle, AOP and Logging in .NET <p>Are there any tutorials or sample programs out there on using AOP, Castle, and logging in a .Net application?  I have found pieces out there but I am looking for something more to help me form a more complete picture.</p>

<p>Thanks,
-Brian</p>
 What is Aspect Oriented Programming? <h3>Duplicate:</h3>

<blockquote>
  <p><a href="http://stackoverflow.com/questions/242177/what-is-aspect-oriented-programming">What is aspect-oriented programming?</a></p>
</blockquote>

<p>Every time I here a podcast or read a blog entry about it, even here, they make it sound like string theory or something.  Is the best way to describe it OOP with Dependency Injection on steroids?</p>

<p>Every time someone tries to explain it, it’s like, Aspects, [Adults from Peanuts Cartoon sound],  Orthogonal, [more noise], cross cutting concerns, etc.  Seriously, can anyone describe it in layman’s terms. </p>
 Do you use AOP? and what for? <p>I am very interested in Aspect Orientated Programming (Spring, PostSharp etc). I can think of a couple of ways I would employ this, mainly logging or lazy load comes to mind. I was hoping to see what everyone else used it for? </p>

<p>Please list out the senarios you solve using AOP. (hopfully it may inspire some one else to pick it up too)</p>

<p>cheers</p>

<p>bones</p>
 Is AspectF (a Fluent Aspect Framework) an AOP-like design that can be used without much concern? <p><a href="http://msmvps.com/blogs/omar/Default.aspx" rel="nofollow">Omar Al Zabir</a> is looking for "a simpler way to do AOP style coding".</p>

<p>He created a framework called <a href="http://code.google.com/p/aspectf/" rel="nofollow">AspectF</a>, which is "a fluent and simple way to add Aspects to your code".</p>

<p><strong>It is not true AOP</strong>, because it doesn't do any compile time or runtime weaving, but does it accomplish the same goals as AOP?</p>

<p>Here's an example of AspectF usage:</p>

<pre><code>    public void InsertCustomerTheEasyWay(string firstName, string lastName, int age,
        Dictionary&lt;string, string&gt; attributes)
    {
        AspectF.Define
            .Log(Logger.Writer, "Inserting customer the easy way")
            .HowLong(Logger.Writer, "Starting customer insert", "Inserted customer in {1} seconds")
            .Retry()
            .Do(() =&gt;
                {
                    CustomerData data = new CustomerData();
                    data.Insert(firstName, lastName, age, attributes);
                });
    }
</code></pre>

<p>Here are some posts by the author that further clarify the aim of AspectF:</p>

<ul>
<li><a href="http://msmvps.com/blogs/omar/archive/2009/09/19/aspectf-fluent-way-to-put-aspects-into-your-code-for-separation-of-concern.aspx" rel="nofollow">AspectF fluent way to put Aspects into your code for separation of concern</a> (Blog)</li>
<li><a href="http://code.google.com/p/aspectf/" rel="nofollow">AspectF</a> (google code)</li>
<li><a href="http://www.codeproject.com/KB/tips/aspectf.aspx" rel="nofollow">AspectF Fluent Way to Add Aspects for Cleaner Maintainable Code</a> (CodeProject)</li>
</ul>

<p>According to the author, I gather that AspectF is <strong>not designed so much as an AOP replacement</strong>, but a way to achieve "separation of concern and keep code nice and clean".</p>

<p>Some thoughts/questions:</p>

<ul>
<li>Any thoughts on using this style of coding as project grows?        </li>
<li>Is it a scalable architecture?</li>
<li><strike>performance concerns?</strike></li>
<li>How does maintainability compare against a true AOP solution?</li>
</ul>
 Patterns for functional, dynamic and aspect-oriented programming <p>We have a very nice GoF book (Design Patterns: Elements of Reusable Object-Oriented Software) about patterns in Object Oriented Programming, and plenty of articles and resources in the web on this subject.</p>

<p>Are there any books (articles, resources) on patterns(best practices) for functional programming?</p>

<p>For dynamic programming in languages like Python and Ruby?</p>

<p>For AOP?</p>
 What Aspect-Oriented Programming (AOP) libraries for .NET are still actively developed? <p>I am trying to find a reasonably mature/stable and freely available (preferably open-source) library for doing AOP in .NET. I've been searching around a bit and found the products below; however, most of them seem dead:</p>

<ul>
<li><p><a href="http://www.sharpcrafters.com/postsharp" rel="nofollow"><strong>PostSharp</strong></a> &mdash; this is the AOP solution usually recommended for .NET, however it's a commercial product and thus some use restrictions apply. (However, it seems to be sort-of freely available for personal or open-source projects.)</p></li>
<li><p><a href="http://www.springframework.net/" rel="nofollow"><strong>Spring.NET</strong></a> &mdash; not exclusively about AOP, so it's probably too powerful if one only wants to do AOP. (?)</p></li>
<li><p><a href="http://entlib.codeplex.com/" rel="nofollow"><strong>Policy Injection Application Block</strong></a> &mdash; being from Microsoft, I would expect this to be at least maintained.</p></li>
<li><p><a href="http://www.castleproject.org/container/index.html" rel="nofollow"><strong>Castle Windsor</strong></a> together with <a href="http://www.castleproject.org/dynamicproxy/index.html" rel="nofollow"><strong>DynamicProxy</strong></a> &mdash; not primarily an AOP library, but apparently it can be used for that purpose.</p></li>
<li><p><a href="http://sourceforge.net/projects/aspectsharp/" rel="nofollow"><strong>Aspect#</strong></a> &mdash; this seems quite dead to me.</p></li>
<li><p><a href="http://aspectdotnet.codeplex.com/" rel="nofollow"><strong>Aspect.NET</strong></a> &mdash; this also seems quite dead to me.</p></li>
<li><p><strong>NAop</strong> &mdash; apparently no longer supported.</p></li>
<li><p><a href="http://sourceforge.net/projects/aopnet/" rel="nofollow"><strong>AOP.NET</strong></a> &mdash; this was supposed to be the successor to NAop, and also looks like it died a while ago.</p></li>
</ul>

<p>There's probably even more. From the above list I gather that the only real options for doing AOP on .NET is PostSharp (even though it's a commercial product), Spring.NET, Microsoft's Policy Injection Application Block, or perhaps Windsor.</p>

<p>Did I forget any major option?</p>

<hr>

<p><em>See also the question <a href="http://stackoverflow.com/questions/470535/suggestions-for-open-source-aspect-oriented-library-for-c">Suggestions for open source aspect-oriented library for C#</a> here on StackOverflow. I posted a new question because I'm specifically interested in the state of development/maintenance of various AOP solutions for .NET.</em></p>
 Mixing JDK and CGLIB proxies within Spring <p>I have an application running with Spring, and I'm using AOP in some places. Since I want to use the @Transactional annotation at interface level, I have to allow Spring to create JDK proxies. So, I don't set the <em>proxy-target-class</em> property to true. On the other hand, I don't want to create an interface for every single class I want advised: if the interface just doesn't make sense, I want to have just the implementation, and Spring should create a CGLIB proxy.</p>

<p>Everything was working perfectly, just as I described. But I wanted to have some other annotations (created by me) going in interfaces and being "inherited" by the implementation classes (just like the @Transactional one). Turns out that I can't do that with the built-in support for AOP in Spring (at least I could not figure it out how to do it after some research. The annotation in the interface is not visible in the implementation class, and hence that class does not get advised).</p>

<p>So I decided to implement my own <em>pointcut</em> and <em>interceptor</em>, allowing other method annotations to go on interfaces. Basically, my pointcut look for the annotation on the method and, until not found, in the same method (same name and parameter types) of the interfaces that the class or its superclasses implements.</p>

<p>The problem is: when I declare a DefaultAdvisorAutoProxyCreator bean, that will properly apply this pointcut/interceptor, the behavior of advising classes with no interfaces is broken. Apparently something goes wrong and Spring tries to proxy my classes twice, once with CGLIB and then with JDK.</p>

<p>This is my configuration file:</p>

<pre><code>&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:context="http://www.springframework.org/schema/context"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:tx="http://www.springframework.org/schema/tx"
    xmlns:aop="http://www.springframework.org/schema/aop" xmlns:task="http://www.springframework.org/schema/task"
    xsi:schemaLocation="
    http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
    http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-3.0.xsd"&gt;

    &lt;!-- Activates various annotations to be detected in bean classes: Spring's 
        @Required and @Autowired, as well as JSR 250's @Resource. --&gt;
    &lt;context:annotation-config /&gt;

    &lt;context:component-scan base-package="mypackage" /&gt;

    &lt;!-- Instruct Spring to perform declarative transaction management automatically 
        on annotated classes. --&gt;
    &lt;tx:annotation-driven transaction-manager="transactionManager" /&gt;

    &lt;bean class="org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator" /&gt;

    &lt;bean id="logger.advisor" class="org.springframework.aop.support.DefaultPointcutAdvisor"&gt;
        &lt;constructor-arg&gt;
            &lt;bean class="mypackage.MethodAnnotationPointcut"&gt;
                &lt;constructor-arg value="mypackage.Trace" /&gt;
            &lt;/bean&gt;
        &lt;/constructor-arg&gt;
        &lt;constructor-arg&gt;
            &lt;bean class="mypackage.TraceInterceptor" /&gt;
        &lt;/constructor-arg&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>

<p>This is the class I want to be proxied, with no interfaces:</p>

<pre><code>@Component
public class ServiceExecutorImpl
{
    @Transactional
    public Object execute(...)
    {
        ...
    }
}
</code></pre>

<p>When I try to <em>autowire</em> it in some other bean, like:</p>

<pre><code>public class BaseService {
   @Autowired
   private ServiceExecutorImpl serviceExecutorImpl;

   ...
}
</code></pre>

<p>I get the following exception:</p>

<pre><code>java.lang.IllegalArgumentException: Can not set mypackage.ServiceExecutorImpl field mypackage.BaseService.serviceExecutor to $Proxy26
</code></pre>

<p>This are some lines of the Spring output:</p>

<pre><code>13:51:12,672 [main] DEBUG [org.springframework.aop.framework.Cglib2AopProxy] - Creating CGLIB2 proxy: target source is SingletonTargetSource for target object [mypackage.ServiceExecutorImpl@1eb515]
...
13:51:12,782 [main] DEBUG [org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator] - Creating implicit proxy for bean 'serviceExecutorImpl' with 0 common interceptors and 1 specific interceptors
13:51:12,783 [main] DEBUG [org.springframework.aop.framework.JdkDynamicAopProxy] - Creating JDK dynamic proxy: target source is SingletonTargetSource for target object [mypackage.ServiceExecutorImpl$$EnhancerByCGLIB$$2eb5f51@5f31b0]
</code></pre>

<p>I could supply the full output if someone thinks it will help. I have no idea why Spring is trying to "double-proxy" my class, and why this just happens when I declare the DefaultAdvisorAutoProxyCreator bean.</p>

<p>I have been struggling with this for some time now, and any help or ideas would be very much appreciated.</p>

<p>EDIT:</p>

<p>This is my interceptor source code, as requested. It basically log the method execution (only methods annotated with @Trace get intercepted). If the method is annotated with @Trace(false), the logging is suspended until the method returns.</p>

<pre><code>public class TraceInterceptor
    implements
        MethodInterceptor
{

    @Override
    public Object invoke(
        MethodInvocation invocation )
        throws Throwable
    {
        if( ThreadExecutionContext.getCurrentContext().isLogSuspended() ) {
            return invocation.proceed();
        }

        Method method = AopUtils.getMostSpecificMethod( invocation.getMethod(),
            invocation.getThis().getClass() );
        Trace traceAnnotation = method.getAnnotation( Trace.class );

        if( traceAnnotation != null &amp;&amp; traceAnnotation.value() == false ) {
            ThreadExecutionContext.getCurrentContext().suspendLogging();
            Object result = invocation.proceed();
            ThreadExecutionContext.getCurrentContext().resumeLogging();
            return result;
        }

        ThreadExecutionContext.startNestedLevel();
        SimpleDateFormat dateFormat = new SimpleDateFormat( "dd/MM/yyyy - HH:mm:ss.SSS" );
        Logger.log( "Timestamp: " + dateFormat.format( new Date() ) );

        String toString = invocation.getThis().toString();
        Logger.log( "Class: " + toString.substring( 0, toString.lastIndexOf( '@' ) ) );

        Logger.log( "Method: " + getMethodName( method ) );
        Logger.log( "Parameters: " );
        for( Object arg : invocation.getArguments() ) {
            Logger.log( arg );
        }

        long before = System.currentTimeMillis();
        try {
            Object result = invocation.proceed();
            Logger.log( "Return: " );
            Logger.log( result );
            return result;
        } finally {
            long after = System.currentTimeMillis();
            Logger.log( "Total execution time (ms): " + ( after - before ) );
            ThreadExecutionContext.endNestedLevel();
        }
    }

    // Just formats a method name, with parameter and return types
    private String getMethodName(
        Method method )
    {
        StringBuffer methodName = new StringBuffer( method.getReturnType().getSimpleName() + " "
            + method.getName() + "(" );
        Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();

        if( parameterTypes.length == 0 ) {
            methodName.append( ")" );
        } else {
            int index;
            for( index = 0; index &lt; ( parameterTypes.length - 1 ); index++ ) {
                methodName.append( parameterTypes[ index ].getSimpleName() + ", " );
            }
            methodName.append( parameterTypes[ index ].getSimpleName() + ")" );
        }
        return methodName.toString();
    }
}
</code></pre>

<p>Thanks!</p>
 What is a good example of a program written using aspect-oriented techniques? <p>I'm not necessarily looking for an example of code written on an AOP language, but some code that thoroughly and effectively divides into aspects, rather than components, so I could read it and see how to do it well.</p>

<p>Most of the examples of aspects I've seen are only a small part of the program (locking, logging); I don't think I've ever seen a complete semi-non-trivial program that was primarily divided along aspects.</p>

<p>Anyone know some good ones?</p>
 Is AOP a type of decorator pattern? <p>I got asked this question in a interview. I clearly know what a decorator pattern is and how it can be used. But I was not able to think through this question in the interview.</p>

<p>This is the actual question asked.</p>

<blockquote>
  <p>Is AOP a variation of decorator pattern ? How does the AOP implementation vary from trademark decorator pattern ?</p>
</blockquote>
 How to get a dump of all local variables? <p>How can I get a dump of all local &amp; session variables when an exception occurs? I was thinking of writing some sort of reflection based function that would interrogate the calling function &amp; create a dump of variables &amp; values.</p>

<p>Is there an existing library that I can use?</p>

<p><strong>UPDATE</strong></p>

<p>After speaking to a colleague, I was pointed to AOP or Aspect Oriented Programming.  Here is what I understand ... Using AOP, one would simple decorate the methods &amp; classes with certain attributes. AOP framework then injects code in or around these classes &amp; methods.  There are two separate kinds of framework, one that injects code &amp; then compiles the assembly &amp; the second simply uses reflection &amp; traps the call which you have decorated and wraps whatever code around the method at runtime.</p>

<p>I hope all that makes sense.  I will be doing more research on this &amp; post my approach.</p>

<p>Thanks guys ...</p>
 
postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp postsharp What is IL Weaving? <p>I just saw <a href="http://ayende.com/Blog/archive/2008/10/09/first-steps-with-post-sharp.aspx">Ayende's post</a> today about PostSharp. I downloaded the code and tried it out, and I thought it was the coolest, most easy to use way to handle AOP that I've seen. </p>

<p>In his post, Ayende says that PostSharp accomplishes it's magic via <strong>IL Weaving</strong>. Now, at some abstract level I can deduce what that means, but I wanted to see if there was a more detailed answer out there. Unfortunately, for the first time in a very long time, Google came up empty for me. And so I thought this would be a great question for StackOverflow (since I've been a subscribe to Jeff's blog for a  couple years now and knew this site was doing its thing). </p>

<p>So what exactly is IL Weaving and how is it accomplished?</p>
 PostSharp and Visual Studio Code Coverage <p>I've recently started using PostSharp in some of my projects and have noticed an unfortunate side effect - the code coverage in all the projects its used with drops significantly.</p>

<p>I'm guessing the reason this happens is that the analyzer sees the PostSharp code and a lot of it isn't tested (i.e. boiler plate code for generic exception handling and logging). I could obviously write unit tests for every method that use the aspects, but if I'm honest it feels like a waste of time.</p>

<p>Has anybody got any experience with this kind of thing?</p>
 Opensource alternative to postSharp that supports easy custom attributes <p>Does anyone know a opensource alternative to postsharp thats as easy to use and supports attribute based stuff? I've seen AspectDNG which is slightly similar but creating those attributes is like c++ code and requires a different form of compilation</p>

<p>I know about windsor,ninject,Spring.Net,etc but none of them have custom attributes like postsharp.</p>

<p>I'm looking for some program that lets me use my own custom attributes with before,after events.</p>

<p>I would appreciate any suggestions.</p>

<p>Thank you</p>

<p><strong>Edit: This question specifically describing these points that it should support attributes has not been asked before. So,please don't close this question. It's not a duplicate.</strong></p>

<p>Edit: why am I afraid of postsharp? PostSharp has so far been the best,but it's commercial and looks uncertain / risky  to use the free version for a large project.We never know when they might probably discontinue their free version.</p>

<p>Edit: Thanks for all the votes and favorite adds. So far,I've found this : <a href="http://zinject.codeplex.com/">http://zinject.codeplex.com/</a> but it's in french. Please provide more suggestions if anyone of you find anything else.</p>
 Anyone with Postsharp experience in production? <p>Does anyone out there has used <a href="http://www.postsharp.org/" rel="nofollow">Postsharp</a> AOP framework in production environment? Are there any pitfalls? In order to do some logging etc, can Postsharp be used in conjunction with log4net ?</p>

<p>Any tutorials on using Postsharp with Web Apps and/or log4net will be highly appreciated.</p>

<p>Thanks In Advance.</p>
 Generating a custom compile time warning C# <p>I'm using VS2008 and would like to create a compile time warning / error based on custom attributes on a property (if it is possible).</p>

<p>There are two cases which interest me currently:</p>

<pre><code>  [MyAttribute (typeof(MyClass)]
</code></pre>

<p>Where MyClass has to implement an interface. Currently I assert this in the constructor of the attribute, however this doesn't make it easy to track down, due to the nature of the stack trace:</p>

<pre><code> public MyAttribute (Type MyClassType)
    {
         System.Diagnostics.Debug.Assert(typeof(MyInterface).IsAssignableFrom(MyClassType),
                                         "Editor must implement interface: " + typeof(MyInterface).Name);

    }
</code></pre>

<p>The second case which interests me is where I have a type defined in an attribute, if that type implements an interface, then a warning should be displayed if another attribute isn't present.</p>

<p>I.E. if (MyClass.Implements(SomeInterface) &amp;&amp; !Exists(SomeAttibute)) {  Generate Warning }</p>

<pre><code>[MyAttribute(typeof(MyClass)] 
// Comment next line to generate warning
[Foo ("Bar")]
</code></pre>

<p>Thanks!</p>
 Cool PostSharp aspects <p>I'm looking for interesting PostSharp aspects - anything that you found useful and wouldn't mind sharing.</p>
 Mono Cecil vs. PostSharp Core vs. Microsoft CCI for implementing AOP framework <p>Which is the better in terms of capabilities, easy of use, documentation, samples, community/support, VS integration, known implementations, long-term viability, and build speed to implement a custom AOP framework?</p>

<p>I'll start with what I know (I have only tried PostSharp to so far):</p>

<ul>
<li><strong>Microsoft Common Compiler
Instrastruture (CCI)</strong>: I've read that
is used for FxCop, ILMerge, Spec# and
Code Contracts. It seems to be very low level <a href="http://www.jasonbock.net/JB/Default.aspx?blog=entry.3dc8f8f4b5564b3380ce6e21bc56449c" rel="nofollow">as it does not even take care of correcting offsets for branch codes that are borken when IL is modified with it</a>.</li>
<li><strong>PostSharp</strong> is 5 years old, has many
capabilities for AOP (e.g. abstracts
some things you would need to have to
do manually with IL away), source
code available, developed/supported
by only one guy but he is planning on
making this a business, has
documentation but could be better,
builds take about twice as long, very
little samples on how to inject IL
and version 2.0 will be released soon
which promises to be much improved.</li>
<li><strong>Mono Cecil</strong>:  Written by one guy, part
of the Mono suite and there is a
plug-in for Reflector called Reflexil
that uses Mono Cecil.</li>
</ul>
 Unit Testing and PostSharp <p>I'm wondering what the best way to do this is... I'm interested in introducing PostSharp into one of my projects, but I'm not sure how to unit test classes marked with an attribute properly.</p>

<p>For example:</p>

<pre><code>public class hello {

    [MyAspectThatDoesSomethingToTheDatabaseWhenThisMethodGetsCalled]
    public int omg(string lol) {
        //fancy logic in here
    }
}
</code></pre>

<p>I'd like to test the logic in the omg() method, but in the unit tests I need to make sure that the aspect doesn't get called, because there isn't really a database.</p>

<p>Thoughts?</p>
 How to unit test PostSharp aspects? <p>After asking this <a href="http://stackoverflow.com/questions/9533656/">question</a> about implementing an aspect with PostSharp, it came to my mind that I might have to update the code of this aspect in the future, and that I did not want to take the risk of breaking everything afterwards.</p>

<p>So, I started thinking about unit testing.</p>

<p>My first question is:</p>

<blockquote>
  <p>Is it relevant to think about unit testing an aspect?</p>
</blockquote>

<p>I would like the answer to be "yes", but if not, I expect getting other advices.</p>

<p>And then, if so, </p>

<blockquote>
  <p>How to implement unit testing for PostSharp aspects?</p>
</blockquote>
 PostSharp - il weaving - thoughts <p>I am considering using Postsharp framework to ease the burden of application method logging.
It basically allows me to adorn methods with logging attribute and at compile time injects the logging code needed into the il. I like this solution as it keeps the noise out of the deign time code environment.
Any thoughts, experiences or better alternatives?</p>
 How do I find the return type of a method with System.Reflection.MethodBase in C#? <p>how do I find out the return type of a method from the MethodBase? I'm using PostSharp and trying to override the CompileTimeValidate(MethodBase method) method to make sure the attribute is applied to a method with the correct signature.</p>

<p>Thanks,</p>
 Filtering log4net on method name - can't quite get it <p>I'm using log4net to log my web app's progress, using Log4PostSharp to AOP-injectify all methods. This has the desired effect of logging (almost) everything and is fine.</p>

<p>I now have a requirement to log JUST Page_Load methods to a file / console. I can obviously hamstring the log4postsharp class to do that, but then I'd be losing all the other logging.</p>

<p>I've been looking at filters in log4net, starting with the StringMatch filter, but that only looks at the message being logged, and I'm after the method name. This put me onto the PropertyFilter, but still with no joy. My log4net.config snippet is thus:</p>

<pre><code>&lt;appender name="RollingLogFileAppender" type="log4net.Appender.RollingFileAppender"&gt;
  &lt;filter type="log4net.Filter.PropertyFilter"&gt;
    &lt;key value="LocationInfo.MethodName"/&gt;
    &lt;stringToMatch value="Page_Load"/&gt;
  &lt;/filter&gt;
  &lt;filter type="log4net.Filter.DenyAllFilter" /&gt;
  &lt;file value="d:\\xxxx\\yyyyy\\zzzzLog"/&gt;
</code></pre>

<p>As you can see, I'm trying to key into the MethodName of the logging event via  LocationInfo, but I'm still getting everything logged. EDIT: As mentioned in the comments, I've now included the DenyAllFilter that I added after RTFM ;-)</p>

<p>Can anyone assist?</p>

<p>Thank you,</p>

<p>Mike K.</p>
 Whats the difference between PostSharp and Castle Dynamic Proxy? <p>Just wondering what the main differences are between these libraries, how they differ in features and functionality.</p>

<p>Hoping for more information than I could find with a Google query...</p>
 PostSharp 2.0 BadImageFormatException <p>We have an application here which is using postsharp to wrap certain methods within a transaction aspect derived from MethodInterceptionAspect. We use NHibernate 2.0 as an ORM for the application. There is a failure within this block of code, </p>

<pre><code>public override void OnInvoke(MethodInterceptionArgs args)
{
    using (TransactionScope transaction = CreateTransactionScope())
    {
        args.Proceed();
        transaction.Complete();
    }
}
</code></pre>

<p>that results in the following error: System.BadImageFormatException: An attempt was made to load a program with an incorrect format. (Exception from HRESULT: 0x8007000B)
This only seems to happen for calls to save, and not delete or get calls. </p>

<p>I was wondering if anyone had encountered anything similar ever? </p>
 Suppressing PostSharp Multicast with Attribute <p>I've recently started experimenting with PostSharp and I found a particularly helpful aspect to automate implementation of INotifyPropertyChanged.  You can see the example <a href="http://www.sharpcrafters.com/solutions/ui#data-binding" rel="nofollow">here</a>.  The basic functionality is excellent (all properties will be notified), but there are cases where I might want to suppress notification.</p>

<p>For instance, I might know that a particular property is set once in the constructor and will never change again.  As such, there is no need to emit the code for NotifyPropertyChanged.  The overhead is minimal when classes are not frequently instantiated and I can prevent the problem by switching from an automatically generated property to a field-backed property and writing to the field.  However, as I'm learning this new tool, it would be helpful to know if there is a way to tag a property with an attribute to suppress the code generation.  I'd like to be able to do something like this:</p>

<pre><code>[NotifyPropertyChanged]
public class MyClass
{
    public double SomeValue { get; set; }

    public double ModifiedValue { get; private set; }

    [SuppressNotify]
    public double OnlySetOnce { get; private set; }

    public MyClass()
    {
        OnlySetOnce = 1.0;
    }
}
</code></pre>
 Remove PostSharp reference after build? <p>Is is possible to get postsharp to remove references to the postsharp assemblies during a build?</p>

<p>I have an exe i needs to have a very small footprint. I want to use some of the compile time weaving of postsharp but dont want to have to deploy PostSharp.dll with the exe.</p>

<p>I am using PostSharp 2 (2.0.4.1074 specifically)</p>
 Multiple aspects on one method <p>In my application I previously used regular C# attributes to "annotate" a method.  E.g.:</p>

<pre>
<code>
[Foo(SomeKey="A", SomeValue="3")]
[Foo(SomeKey="B", SomeValue="4")]
public void TheMethod()
{
   SpecialAttributeLogicHere();
}

</code>
</pre>

<p>What SpecialAttributeLogicHere() did, was to reflectively look at all the Foo-attributes that annotated this particular method.  It would then (on its own), create its own dictionary for all the keys and values.</p>

<p>I'm now trying to move to PostSharp, because the SpecialAttributeLogic could be put into an aspect (and removed from the method body which is much cleaner!), within OnEntry.  Foo will be replaced by an aspect that extends OnMethodBoundaryAspect.</p>

<p>I would still like to use it the following way:</p>

<pre><code>
[Foo(SomeKey="A", SomeValue="3")]
[Foo(SomeKey="B", SomeValue="4")]
</code></pre>

<p>But if Foo has an OnEntry, that means that the "SpecialAttributeLogic" will be executed twice. I basically need to "gather" all the keys and values from each Foo(), into a dictionary, which I then apply some logic to.</p>

<p>How to do this (or best practices) with PostSharp?  Thanks!</p>
 Simplest way to mock properties of PostSharp attribute <p>I'm using a PostSharp method attribute to do authorisation and auditing on my WCF service. It's working properly but now I'm trying to get my unit tests working with the attribute and am struggling to find a way to mock and inject the properties on the attribute.</p>

<p>My attribute is as below.</p>

<pre><code>[Serializable]
[AttributeUsage(AttributeTargets.Method, AllowMultiple = false, Inherited = false)]
public class AuthoriseAndAuditAttribute : OnMethodBoundaryAspect
{
    private static ILog logger = AppState.logger;

    private static Ninject.IKernel _kernel = MyKernel.Kernel;

    private UserRoleTypesEnum _requiredRole = UserRoleTypesEnum.None;

    [Inject]
    public IServiceAuthToken _serviceAuthToken { get; set; }

    [Inject]
    public UserSessionDataLayer _userSessionDataLayer { get; set; }

    public AuthoriseAndAuditAttribute(UserRoleTypesEnum role = UserRoleTypesEnum.None)
    {
        _requiredRole = role;
        _kernel.Inject(this);
    }

    public override void OnEntry(MethodExecutionArgs args)
    {
        // Get the user's session from cookie.
        UserSession userSession = GetUserSession();

        // Check that user is in the required role.
        bool isAuthorised = (_requiredRole == UserRoleTypesEnum.None || (userSession != null &amp;&amp; userSession.Roles.Contains(_requiredRole)));

        if (!isAuthorised)
        {
            logger.Warn("Not authorised for " + args.Method.Name + ".");
            throw new UnauthorizedAccessException();
        }
        else if (userSession != null)
        {
            Thread.CurrentPrincipal = new MyPrincipal(userSession);
        }
    }

    private UserSession GetUserSession()
    {
        if (_serviceAuthToken != null)
        {
            string sessionID = _serviceAuthToken.GetSessionID();

             if (!sessionID.IsNullOrBlank())
             {
                 return _userSessionDataLayer.GetForSessionID(sessionID);
             }
         }

         return null;
     }
}
</code></pre>

<p>I have a singleton class setting up the Ninject kernel:</p>

<pre><code>public class MyKernel
{
    public static StandardKernel Kernel { get; set; }

    static MyKernel()
    {
        Kernel = new StandardKernel();
        Kernel.Bind&lt;IServiceAuthToken&gt;().To&lt;ServiceAuthToken&gt;();
        Kernel.Bind&lt;UserSessionDataLayer&gt;().To&lt;UserSessionDataLayer&gt;();
    }
}
</code></pre>

<p>In my WCF service I use the PostSharp attribute as below:</p>

<pre><code>[AuthoriseAndAudit(UserRoleTypesEnum.Operator)]
public JSONResult&lt;bool&gt; IsAliveAuthorised()
{
   return new JSONResult&lt;bool&gt;() { Success = true, Result = true };
}
</code></pre>

<p>And in my unit test I'm using RhinoMocks to try and mock the two DI properties in the attribute.</p>

<pre><code> [TestMethod]
 public void IsAliveAuthorisedIsAuthorisedTest()
 {
     var mockServiceAuthToken = MockRepository.GenerateStrictMock&lt;ServiceAuthToken&gt;();
     mockServiceAuthToken.Stub(x =&gt; x.GetSessionID()).Return("x");
     var mockUserSessionDataLayer = MockRepository.GenerateStrictMock&lt;UserSessionDataLayer&gt;();
     mockUserSessionDataLayer.Stub(x =&gt; x.GetForSessionID(Arg&lt;string&gt;.Is.Anything)).Return(new UserSession());

     MyKernel.Kernel.Bind&lt;ServiceAuthToken&gt;().ToConstant(mockServiceAuthToken);
     MyKernel.Kernel.Bind&lt;UserSessionDataLayer&gt;().ToConstant(mockUserSessionDataLayer);

     var service = new MyService();
     Assert.IsTrue(service.IsAliveAuthorised().Result);
}
</code></pre>

<p>The issue I have is the mock objects in the unit test are never ending up being set as the properties on the attribute. What am I doing wrong or conversely is there a better way to do unit testing on a PostSharp attribute? Also bearing in mind I really want to minimise the use of the Ninject DI to the bare minimum.</p>
 How to write attribute that catches exceptions and removes stacktrace? <p>I wish to write an attribute for a function (or class) that will catch any exception thrown and set its <code>StackTrace</code> property to <code>string.Empty</code>. How can I do this?</p>

<p><strong>EDIT:</strong></p>

<p>If I cannot accomplish this in plain C#, how can I do this in C# with PostSharp?</p>
 What is the reason I get "Non abstract, non-.cctor-method in an interface"? <p>I have a very strange problem. I have an Interface defined in a dll as follows:</p>

<pre><code>public interface IKreator2
{
    string Name { get; set; }
    string Description { get; set; }

    INotifyPropertyChanged Settings { get; set; }

    InfiniRenderJob Job { get; set; }
    UserControl UI { get; set; }

    void Init();
    //void OnClose();
}
</code></pre>

<p>If I link to this dll in my WPF app the Debugger crashes on load (Internal Error: Unhandled Exception in the debugger::HandleIPCEvent, ID=0x246). If I debug the app with "debug unmanaged code" I get the following errors:</p>

<ul>
<li>First-chance exception at 0x76977945 (KernelBase.dll) in
InfiniRender.Host.exe: Microsoft C++ exception: EETypeLoadException
at memory location 0x0029c5b8.</li>
<li>First-chance exception at 0x76977945 (KernelBase.dll) in
InfiniRender.Host.exe: Microsoft C++ exception:  [rethrow] at memory
location 0x00000000.</li>
<li>A first chance exception of ype 'System.TypeLoadException' occurred
in InfiniRender.Host.exe</li>
<li>An unhandled exception of type 'System.TypeLoadException' occurred in
InfiniRender.Host.exe Additional information: Nicht abstrakte
Nicht-.cctor-Methode in einer Schnittstelle.</li>
</ul>

<p>At the Moment I have absolutly no clue what is going on. There isnt even an implentation of the interface and no class uses it. If I comment the method "Init" out, everything works as expected.
Any ideas??</p>

<p>[EDIT]
This is the MSIL for the Interface init method:</p>

<pre><code>.method public hidebysig newslot virtual 
      instance void  Init() cil managed
{
// Code size       96 (0x60)
.maxstack  3
.locals init ([0] class [mscorlib]System.Exception CS$0$0__ex)
IL_0000:  ldsfld     class [NLog]NLog.Logger '&lt;&gt;z__LoggingImplementationDetails'::l14
IL_0005:  callvirt   instance bool [NLog]NLog.Logger::get_IsTraceEnabled()
IL_000a:  brfalse.s  IL_001b

IL_000c:  ldsfld     class [NLog]NLog.Logger '&lt;&gt;z__LoggingImplementationDetails'::l14
IL_0011:  ldstr      "Entering: InfiniRender.IKreator2.Init()"
IL_0016:  call       instance void [NLog]NLog.Logger::Trace(string)
.try
{
  IL_001b:  newobj     instance void [mscorlib]System.NotSupportedException::.ctor()
  IL_0020:  throw

  IL_0021:  ldsfld     class [NLog]NLog.Logger '&lt;&gt;z__LoggingImplementationDetails'::l14
  IL_0026:  callvirt   instance bool [NLog]NLog.Logger::get_IsTraceEnabled()
  IL_002b:  brfalse.s  IL_003c

  IL_002d:  ldsfld     class [NLog]NLog.Logger '&lt;&gt;z__LoggingImplementationDetails'::l14
  IL_0032:  ldstr      "Leaving: InfiniRender.IKreator2.Init()"
  IL_0037:  call       instance void [NLog]NLog.Logger::Trace(string)
  IL_003c:  leave.s    IL_005f

}  // end .try
catch [mscorlib]System.Exception 
{
  IL_003e:  ldsfld     class [NLog]NLog.Logger '&lt;&gt;z__LoggingImplementationDetails'::l14
  IL_0043:  callvirt   instance bool [NLog]NLog.Logger::get_IsWarnEnabled()
  IL_0048:  brfalse.s  IL_005d

  IL_004a:  stloc.0
  IL_004b:  ldsfld     class [NLog]NLog.Logger '&lt;&gt;z__LoggingImplementationDetails'::l14
  IL_0050:  ldstr      "An exception occurred:\n{0}"
  IL_0055:  ldloc.0
  IL_0056:  call       instance void [NLog]NLog.Logger::Warn(string,
                                                             object)
  IL_005b:  rethrow
  IL_005d:  leave.s    IL_005f

}  // end handler
IL_005f:  ret
} // end of method IKreator2::Init
</code></pre>

<p>It seems to me, that NLog is to blame? Never had any issues with NLog until today...</p>
 Which Tools Perform Post-Compile Modification of IL? <p>A recent mention of PostSharp reminded me of this:</p>

<p>Last year where I worked, we were thinking of using PostSharp to inject instrumentation into our code. This was in a Team Foundation Server Team Build / Continuous Integration environment.</p>

<p>Thinking about it, I got a nagging feeling about the way PostSharp operates - it edits the IL that is generated by the compilers. This bothered me a bit. </p>

<p>I wasn't so much concerned that PostSharp would not do its job correctly; I was worried about the fact that this was the first time I could recall hearing about a tool like this. I was concerned that other tools might not take this into account.</p>

<p>Indeed, as we moved along, we <em>did</em> have some problems stemming from the fact that PostSharp was getting confused about which folder the original IL was in. This was breaking our builds. It appeared to be due to a conflict with the MSBUILD target that resolves project references. The conflict appeared to be due to the fact that PostSharp uses a temp directory to store the unmodified versions of the IL.</p>

<p>At any rate, I didn't have StackOverflow to refer to back then! Now that I do, I'd like to ask you all if you know of any other tools that edit IL as part of a build process; or whether Microsoft takes that sort of tool into account in Visual Studio, MSBUILD, Team Build, etc.</p>

<hr>

<p><strong>Update:</strong> Thanks for the answers.</p>

<p>The bottom line seems to be that, at least with VS 2010, Microsoft really <em>should</em> be aware that this sort of thing can happen. So if there are problems in this area in VS2010, then Microsoft may share the blame.</p>
 How to inject/generate plumbing code into methods decorated with an Attribute? <p>I was reading through some articles on Caching and Memoization and how to implement it easily using delegates and generics. The syntax was pretty straightforward, and it is surprisingly easy to implement, but I just feel due to the repetitive nature it should be possible to generate code based on an Attribute, instead of having to write the same plumbing code over and over.</p>

<p>Let's say we start off with the default example:</p>

<pre><code>class Foo
{
  public int Fibonacci(int n)
  {
    return n &gt; 1 ? Fibonacci(n-1) + Fibonacci(n-2) : n;
  }
}
</code></pre>

<p>And then to memoize this:</p>

<pre><code>// Let's say we have a utility class somewhere with the following extension method:
// public static Func&lt;TResult&gt; Memoize&lt;TResult&gt;(this Func&lt;TResult&gt; f)

class Foo
{
  public Func&lt;int,int&gt; Fibonacci = fib;

  public Foo()
  {
    Fibonacci = Fibonacci.Memoize();
  }

  public int fib(int n)
  {
    return n &gt; 1 ? Fibonacci(n-1) + Fibonacci(n-2) : n;
  }
}
</code></pre>

<p>I thought, wouldn't it be simpler to just make a code generator that spits out this code, once it finds a tagged method that matches one of the Memoize extension methods. So in stead of writing this plumbing code, I could just add an attribute:</p>

<pre><code>class Foo
{
  [Memoize]
  public int Fibonacci(int n)
  {
    return n &gt; 1 ? Fibonacci(n-1) + Fibonacci(n-2) : n;
  }
}
</code></pre>

<p>Honestly, I know this is looking more like compiler sugar that should be converted by a preprocessor than actual code generation but my question is:</p>

<ol>
<li>What do you think is the best way to find the methods in a c# source file that have a given attribute, parsing out the parametertypes and returntype, and generating a delegate that matches this fingerprint</li>
<li>What would be the best way to integrate this into the build process, without actually overwriting my code. Is it possible to do some preprocessing on the source files before passing it on to the compiler?</li>
</ol>

<p>Thanks for any and all ideas.</p>

<p><strong>Update</strong>:</p>

<p>I have looked into the Postsharp library as Shay had suggested, and it seemed very suited for the job on non time-critical applications like Transaction Management, Tracing or Security.</p>

<p>However when using it in a time-critical context it proved a LOT slower than the delegate. One million iterations of the Fibonacci example with each implementation resulted in a 80x slower runtime. (0.012ms postsharp vs 0.00015ms delegate per call)</p>

<p>But honestly the result is completely acceptable in the context in which I intend to use it. Thanks for the responses!</p>

<p><strong>Update2</strong>:</p>

<p>Apparently the author of Postsharp is working hard on a <a href="http://www.postsharp.org/blog/introducing-postsharp-20-2-amazing-runtime-performance-enhancements" rel="nofollow">release 2.0</a> which will include, among other things, performance improvements in produced code, and compile time. </p>
 PostSharp: Custom attributes are removed when using OnMethodInvocationAspect <p>I've got some aspect like this:</p>

<pre><code>public class MyAttribute : OnMethodInvocationAspect
{
    public int Offset { get; internal set; }

    public MyAttribute(int offset)
    {
        this.Offset = offset;
    }

    public override void OnInvocation(MethodInvocationEventArgs eventArgs)
    {
         //do some stuff
    }
}
</code></pre>

<p>Now I'm having my class, and I add my attribute to it:</p>

<pre><code>class MyClass
{
    [MyAttribute(0x10)]
    public int MyProp { get; set; }
}
</code></pre>

<p>Works all fine. Yet now I want to use reflection to get my offset; when I do</p>

<pre><code>typeof(MyClass).GetProperty("MyProp").GetCustomAttributes(true);
</code></pre>

<p>It returns nothing. How can I access my original Offset value (the property on my attribute)?</p>
 PostSharp OnMethodBoundaryAspect OnEntry Not Executing <p>I am running a .NET 4.0 Web Application (not web site) and PostSharp 1.5. I cannot get the OnEntry override method to execute using the OnMethodBoundaryAspect base class. Here is some relevant code:</p>

<pre><code>public sealed class MonitorAttribute : OnMethodBoundaryAspect {

    public string[] SomeValue { get; protected set; }         

    public MonitorAttribute (params string[] someValue){
        SomeValue = someValue;
    }

    public override void OnEntry(MethodExecutionEventArgs eventArgs){
        // do Something here
        base.OnEntry(eventArgs);
    }

}

public sealed class MyUsageClass : IMyUsageClass {

    [Monitor(new string[]{ 'Test' })
    public void SomeMethod {
        // Do something else in here
    }        

}
</code></pre>

<p>Am I missing something? It never hits the OnEntry method. I also tried replacing my PostSharp.dll and PostSharp.Laos.dll dependencies with the new 2.0 version. If it makes any difference <code>MyUsageClass</code> is instantiated by StructureMap.</p>
 Adding an OnException attribute using PostSharp <p>I am adventuring into some AOP and it seems with .NET PostSharp is the way to go. </p>

<p>I want to do some simple logging to the db when an exception occurs. However I am finding it difficult to find any real solid examples of using PostSharp beyond the basics. I tried the following:</p>

<pre><code>[Serializable]
public sealed class LogExceptionAttribute : ExceptionHandlerAspect
{
    public override void OnException(MethodExecutionEventArgs eventArgs)
    {
        //do some logging here
    }
}
</code></pre>

<p>And then attaching a <code>[LogException]</code> attribute to a method</p>

<p>But I get a compile error:</p>

<pre><code>Error   7  The type "CoDrivrBeta1.Classes.LogExceptionAttribute" or one of its ancestor should be decorated by an instance of MulticastAttributeUsageAttribute.  C:\work\CoDrivrBeta1\CoDrivrBeta1\EXEC  CoDrivrBeta1
</code></pre>

<p>I have to confess I am very new to this, but it seems like an interesting concept, I think i just need to be pointed in the right direction</p>
 Applying an attribute to an interface using PostSharp <p>I want to be able to apply an attribute to an interface so that every method in any class that implements that interface will have the attribute applied to it.</p>

<p>I assumed it would look something like this:</p>

<pre><code>[Serializable]
[AttributeUsage(AttributeTargets.All, Inherited = true)]
public sealed class TestAttribute : OnMethodBoundaryAspect
{
    ...
}
</code></pre>

<p>Yet when i apply it to an interface like below, the OnEntry/OnExit code in the attribute is never accessed when the method is called in the class implementing the interface:</p>

<pre><code>[Test]
public interface ISystemService
{
    List&lt;AssemblyInfo&gt; GetAssemblyInfo();
}
</code></pre>

<p>If i apply the attribute within the implementing class itself, as below, it works fine:</p>

<pre><code>[Test]
public class SystemService : ISystemService
{
    ...
}
</code></pre>

<p>What am i missing/doing wrong?</p>
 Assembly wide multicast attributes. Are they evil? <p>I am working on a project where we have several attributes in AssemblyInfo.cs, that are being multicast to methods of a particular class.</p>

<pre><code>[assembly: Repeatable(
AspectPriority = 2,
AttributeTargetAssemblies = "MyNamespace",
AttributeTargetTypes = "MyNamespace.MyClass", 
AttributeTargetMemberAttributes = MulticastAttributes.Public,
AttributeTargetMembers = "*Impl", Prefix = "Cls")]
</code></pre>

<p>What I don't like about this, is that it puts a piece of logic into AssemblyInfo (<strong>Info</strong>, mind you!), which for starters should not contain any logic at all. The worst part of it, is that the actual MyClass.cs does not have the attribute anywhere in the file, and it is completely unclear that methods of this class might have them. From my perspective it greatly hurts readability of the code (not to mention that overuse of PostSharp can make debugging a nightmare).Especially when you have multiple multicast attributes.</p>

<p>What is the best practice here? Is anyone out there is using PostSharp attributes like this?</p>
 IoC with AOP (PostSharp) in MonoDroid <p>I'm working on a MonoDroid app, and there really isn't a good DI solution yet (at least that I know of).</p>

<p>I've <a href="http://mgroves.com/monodroid-with-postsharp/" rel="nofollow">gotten PostSharp to work on MonoDroid</a>, and I'm using the Location Intercept aspect as a way to inject dependencies into fields/properties without using a service locator (outside of the aspect anyway).</p>

<p>Here's what I'm working with so far: <a href="https://github.com/mgroves/MonodroidStockPortfolio/blob/develop/MonoStockPortfolio/Framework/IoCAttribute.cs" rel="nofollow">https://github.com/mgroves/MonodroidStockPortfolio/blob/develop/MonoStockPortfolio/Framework/IoCAttribute.cs</a></p>

<p>It's rough, and definitely needs refactoring, but you get the idea from the basic structure.  However, I'm not completely convinced that this approach is the best way.  How would you go about using DI/IoC in a MonoDroid app, with or without PostSharp?</p>
 postsharp exception is null <p>I have a probleme with Postsharp.</p>

<p>i have this:</p>

<pre><code> [Serializable]
 public class MethodConnectionTracking: OnExceptionAspect
 {
  public override void OnException(MethodExecutionArgs args)
        {
            base.OnException(args);
        }
 }
</code></pre>

<p>and i used like this. In assemblyInfo.cs:</p>

<pre><code>[assembly: MethodConnectionTracking]
</code></pre>

<p>so, when an exception occurs in the assembly its executes OnException method. But, when i debug the method and i watch args (type: MethodExecutionArgs ) every property has a null value. args.Exception is null. And i need the exception type..</p>

<p>Anyone knows how can i fix this?</p>

<p>Thanks in advance</p>
 How to modify method arguments using PostSharp? <p>I need to do some stuff with parameteres passed into my method. How can I play with them (modify) using PostSharp ?</p>
 Best way of validating WCF and WebService method parameter values <p>I'm going to write a validation component to use it on different projects. I'm not really familiar with any of validation frameworks like Enterprise Library <a href="http://msdn.microsoft.com/en-us/library/dd140088.aspx" rel="nofollow" title="Validation Application Block">VAB</a>, <a href="http://fluentvalidation.codeplex.com/" rel="nofollow">Fluent</a>, <a href="http://conditions.codeplex.com/" rel="nofollow">CuttingEdge.Conditions</a> and so many others, however I don't have time to work with all of them to see which is better for my purpose.</p>

<p>I want this component to provide 2 different functionalities for me:</p>

<p><strong>First</strong>, I want to have some validators like EmailValidator, StringLengthValidator, MyCustomValidator and so on, that I can use them whenever I want in the code, like below:</p>

<pre><code>public class EmailValidator : RegexValidator // or StringValidator or whatever!
{
    public EmailValidator() : base("emailRegexHere")
    {
    }
public bool override DoValidate(string value)
    {
        return base.DoValidate(value);
    }
}
...

public void MyMethod(string email)
{
    EmailValidator validator = new EmailValidator();
    if(!validator.Validate(email))
        throw new NotValidatedException("email is invalid.");
    ...
}
</code></pre>

<p><strong>Second</strong>, I need to validate parameters by applying something like DataAnnotations to any method parameter that I want without any extra coding. One possible way I know is writing Aspects using <a href="http://www.sharpcrafters.com/" rel="nofollow">PostSharp</a> to inject code where method starts (OnMethodEntry). I've done Logging with Postsharp and it works great. </p>

<p>Also Microsoft introduces IParameterInspector to <a href="http://msdn.microsoft.com/en-us/library/ff647875.aspx" rel="nofollow">Perform Input Validation in WCF</a> which provide 2 methods BeforCall and AfterCall, but I think it only works for WCF.</p>

<p>To wrap up, I need to do validation in my WCF or WebService like this:</p>

<pre><code>[System.Web.Script.Services.ScriptService]
public class MyServiceClass : System.Web.Services.WebService
{
    [Aspects.Validate]
    [WebMethod(EnableSession = true)]
    public string SubmitComment([Validation.Required]string content,[Validation.Guid] string userId,[Validation.Required] [Validation.Name]string name, [Validation.Email]string email, string ipAddress)
    {
        ...
    }
}
</code></pre>

<p><strong>Note</strong>: this is just a sample code to demonstrate the behavior that I need, any other suggestions is well appreciated. Also is it a good idea that Validation.* annotations be changed to one annotation like ValidateParam(typeof(EmailValidator)) ?</p>

<p>Thanks in advance</p>
 PostSharp and uninitialized objects <p>Assumed I have an aspect implementing <code>IInstanceScopedAspect</code> and I have this aspect applied to methods in a type. How can I initialize the aspects when creating the object with <code>FormatterServices.GetUninitializedObject</code>? The constructor is not executed and therefore I get a <code>NullReferenceException</code> when I execute the method where the aspect is applied.</p>

<p>Is there a PostSharp API which can be used to initialize the object's aspects ?</p>
 Using PostSharp to intercept calls to Silverlight objects? <p>I'm working with PostSharp to intercept method calls to objects I don't own, but my aspect code doesn't appear to be getting called. The documentation seems pretty lax in the Silverlight area, so I'd appreciate any help you guys can offer :)</p>

<p>I have an attribute that looks like:</p>

<pre><code>public class LogAttribute : OnMethodInvocationAspect
{
  public override void OnInvocation(MethodInvocationEventArgs eventArgs)
  {
    // Logging code goes here...
  }
}
</code></pre>

<p>And an entry in my AssemblyInfo that looks like:</p>

<pre><code>[assembly: Log(AttributeTargetAssemblies = "System.Windows", AttributeTargetTypes = "System.Windows.Controls.*")]
</code></pre>

<p>So, my question to you is... what am I missing? Method calls under matching attribute targets don't appear to function.</p>
 Aspect Oriented Programming: What do you use PostSharp for? <p>I would like to ask users of the AOP framework Postsharp, what specifically are you using the framework for?</p>

<p>Also, I know it's use has a big negative impact on build times, but how about runtime performace?  Is there much of a hit?</p>

<p>Thanks,</p>

<p>S</p>
 Why use a post compiler? <p>I am battling to understand why a post compiler, like <a href="http://www.postsharp.org" rel="nofollow">PostSharp</a>, should ever be needed?</p>

<p>My understanding is that it just inserts code where attributed in the original code, so why doesn't the developer just do that code writing themselves? </p>

<p>I expect that someone will say it's easier to write since you can use attributes on methods and then not clutter them up boilerplate code, but that can be done using DI or reflection and a touch of forethought without a post compiler. I know that since I have said reflection, the performance elephant will now enter - but I do not care about the relative performance here, when the absolute performance for most scenarios is trivial (sub millisecond to millisecond).</p>
 Refactoring nasty legacy systems via AOP or other automated means? <p>I've recently been playing around with PostSharp, and it brought to mind a problem I faced a few years back: A client's developer had produced a web application, but they had not given a lot of thought to how they managed state information - storing it (don't ask me why) <em>statically</em> on the Application instance in IIS. Needless to say the system didn't scale and was  deeply flawed and unstable. But it was a big and very complex system and thus the cost of redeveloping it was prohibitive. My brief at the time was to try to refactor the code-base to impose proper decoupling between the components.</p>

<p>At the time I tried to using some kind of abstraction mechanism to allow me to intercept all calls to the static resource and redirect them to a component that would properly manage the state data. The problem was there was about 1000 complex references to be redirected (and I didn't have a lot of time to do it in) Manual coding (even with R#) proved to be just too time consuming - we scrapped the code base and rewrote it properly. it took over a year to rewrite.</p>

<p>What I wonder now is - had I had access to an assembly rewriter and/or Aspect oriented programming system (such as a PostSharp) could I have easily automated the refactoring process of finding the direct references and converted them to interface references that could be redirected automatically and supplied by factories.</p>

<p>Has anyone out there used PostSharp or similar systems to rehabilitate pathological legacy systems? How successful were the projects? Did you find after the fact that the effort was worth it? Would you do it again?</p>

<p><strong>UPDATE</strong>:
See <a href="http://aabs.wordpress.com/2009/10/22/can-aop-help-fix-bad-architectures/" rel="nofollow">this</a> blog post for more discussion.</p>
 How to use PostSharp with MOQ? <p>We are trying to use PostSharp, more specifically the OnMethodInvocationAspect, to intercept the methods of a class.</p>

<p>The code runs fine, but when testing it with MOQ, it seems to be messing up with my mocks.</p>

<p>If I remove the aspects, all tests succeed. But, if I turn the aspects back on, the expectations on the MOQ mocks are not met.</p>

<p>Here is a snippet taken from one of our unit tests:</p>

<pre><code>this.sgtrMock.Setup(r =&gt; r.RetrieveCurrentTaxes()).Returns(new[] {tax1, tax2});
this.service.LoadServiceTaxes();
this.sgtrMock.Verify(r =&gt; r.RetrieveCurrentTaxes(), Times.Once());
</code></pre>

<p>Any ideas about what can be happening? </p>
 Reduce PostSharp compile time overhead <p>We recently introduced <a href="http://www.postsharp.org/" rel="nofollow">PostSharp</a> into our code base and the compile time of our ASP.NET MVC project has doubled to quadrupled.  We have about 3 MVC projects and approximately 8 class library projects in our solution.</p>

<p>Obviously there will be overhead associated with PostSharp since it is <a href="http://www.postsharp.org/aop-net/compiletime-weaving" rel="nofollow">modifying the MSIL code</a>.  But a 2x to 4x overhead is quite an overhead. </p>

<p>Is this typical with PostSharp?</p>
 PostSharp OnMethodBoundaryAspect <p>I'm working on an aspect with postsharp 1.5 and OnMethodBoundaryAspect. 
I want my aspect have the following behavior by default:</p>

<p>1-If the attribute is used at class level the aspect is applied only on <strong>PUBLIC</strong> methods.</p>

<p>2-The user of the aspect can put the aspect in a private or protected method.</p>

<p>If I use this
[MulticastAttributeUsage(
MulticastTargets.Method, TargetMemberAttributes = MulticastAttributes.Public)]
the point 1 works, but the case 2 doesn't even build becaue is incompatible.</p>

<p>Then I tried to use:
AttributeTargetTypeAttributes = MulticastAttributes.Public;
in the constructor of the aspect, but doesn't work.</p>

<p>Thank you very much in advance.</p>
 AssemblyLoadException in postsharp, problem with arguments from referenced DLLs? <p>I'm just starting out with postsharp/AOP. I want to make some instrumentation for C# to track the usage of some addins that I write for a peice of software.</p>

<p>I am trying to use the OnMethodBoundaryAspect class to take note of the values of some of the parameters when the method is called. Those parameters are types which are referenced in an external DLL.</p>

<p>When I add my attribute to the method, the project won't build, I get the following error</p>

<p>Error   2   Unhandled exception (2.0.5.1204, 64 bit, CLR 2.0, Release): PostSharp.CodeModel.AssemblyLoadException: Error while loading the assembly "C:\Program Files\Autodesk\Revit Structure 2011\Program\RevitAPI.dll": Could not load file or assembly 'revitapi, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null' or one of its dependencies. Operation is not supported. (Exception from HRESULT: 0x80131515)</p>

<p>The REvitAPI.dll is the file with the type in it. I've also tested just adding the attribute to the project but not applying it to any methods, this also causes the error. So it appears its not related to the method parameter types itself, but merely the existence of this DLL. </p>

<p>Has anyone come across this issue before, or can anyone point me in the right direction of where to get some more info on this?</p>
 PostSharp on assemblies I don't have source for <p>In the examples on their website, PostSharp has a demo of intercepting calls in main system assemblies.  I have tried a few times to setup and replicate said intercept calls on assemblies I don't have the source code for with no success.</p>

<p>My approach was to simply place the assembly level attribute targeting the namespace and method I wanted to instrument.  This has never worked for me.</p>

<p>something like:    </p>

<p>[assembly: Trace("MyCategory", AttributeTargetTypes = "My.BusinessLayer.*")]</p>

<p>Am I missing something here? Can I not do a runtime injection of my instrumentation aspect on a assembly if I don't have the source pulled in for it?  I thought I could do runtime injections...</p>

<p>Thanks.</p>
 Log4PostSharp for PostSharp 2.0 and .NET framework 2.0 <p>I have a C# project targeting .NET framework 2.0. I also want to use PostSharp 2.0 Community Edition + Log4PostSharp. The problem is that it's not possible to use Log4PostSharp because it targets 3.5 framework. Also it's not possible to change Log4PostSharp's target framework to 2.0, because PostSharp.Sdk (2.0) is built against 3.5 framework.</p>

<p>Any suggestions what can be done to use Log4PostSharp 2.0 in a project targeting 2.0 framework?</p>
 Free analogue of the PostSharp required <p>I have heard of PostSharp, but I am wondering if there are any other similar tools - anything analogous to PostSharp?</p>

<p>Are there any libraries that could be used as an alternative to PostSharp? Any other tools that can post-process an assembly and inject code based on attributes? </p>

<p>Any free and/or open source alternatives to PostSharp would be especially interesting.</p>

<p>Thank you.</p>
 Generating immutable value object in C#: PostSharp or T4 templates? <p>I'm getting sick of boilerplate immutable value object code. Would either PostSharp or T4 templates allow me to do the following transformation?</p>

<p>Input:</p>

<pre><code>public struct Name
{
    public string FirstName;
    public string LastName;
}
</code></pre>

<p>Output:</p>

<pre><code>public struct Name : IEquatable&lt;Name&gt;
{
    private readonly string firstName;
    private readonly string lastName;

    public string FirstName { get { return this.firstName; } }
    public string LastName { get { return this.lastName; } }

    public Name(string firstName, string lastName)
    {
        this.firstName = firstName;
        this.lastName = lastName;
    }

    public bool Equals(Name other)
    {
        return this.FirstName == other.FirstName &amp;&amp; this.LastName == other.LastName;
    }
    public override bool Equals(object obj)
    {
        return obj is Name &amp;&amp; this.Equals((Name)obj);
    }
    public override int GetHashCode()
    {
        unchecked
        {
            int hash = 17;
            if (this.FirstName != null)
            {
                hash = hash * 29 + this.FirstName.GetHashCode();
            }
            if (this.LastName != null)
            {
                hash = hash * 29 + this.LastName.GetHashCode();
            }
            return hash;
        }
    }

    public static bool operator==(Name a, Name b)
    {
        return a.Equals(b);
    }
    public static bool operator !=(Name a, Name b)
    {
        return !(a == b);
    }
}
</code></pre>

<p>Obviously PostSharp would require a <code>[MakeImmutable]</code> annotation, which is fine. I'd want the option of generating either a <code>class</code> or <code>struct</code> depending on the original type. Also note that <code>GetHashCode</code> would have to omit the <code>null</code> checks for value-type members.</p>

<p>I am fairly sure either technology has this capability, but having not been anything but a consumer of PostSharp aspects/T4 templates myself, I don't know which would be a better or easier one for this task. Whichever answer you give, I'll go spend a day or two learning enough to make this work :).</p>
 PostSharp aspect resolving type <p>We are using dependency injection with and IoC (Unity) and now I want to make an aspect with PostSharp that would basically log enter/exit of a method. My problem is that my logger is configured and registered in the unity container. What should be the best approach to resolve the logger in my aspect? </p>

<p>Note: Using interceptors in unity is not an option. I want this to work without the class is resolved through unity.</p>
 Is it possible to add methods to classes with PostSharp? If yes, is it possible to then reference those methods from other classes? <p>Let's say I have a class <code>Abc</code>:</p>

<pre><code>class Abc {
}
</code></pre>

<p>and that I'd like to externally add some method <code>m()</code> to it. I guess it's probably possible to do this, although I am not sure how. Assuming it is possible to do that, let's then say Abc does have, from now on, a <code>m()</code> method.</p>

<p>Now, imagine I have other class <code>Def</code>:</p>

<pre><code>class Def {
    public void x(Abc abc) {
        abc.m();
    }
}
</code></pre>

<p>Would this code run with PostSharp? To the more distracted reader, the problem with this is that in a standard C# class program, our compiler might not know the <code>Abc</code> class has a <code>m()</code> method.</p>

<p>My gut feeling is that this wouldn't work with PostSharp. Am I mistaken?</p>
 signing dll and postsharp <p>I’ve got a problem with postsharp on my hudson CI server.  Whenever I try to sign a dll with specific version an error occurs. (Hudson is using MSBuild from cmd to build this project , building it as x86) : </p>

<p>POSTSHARP : postsharp error PS0099: Unhandled exception (2.0.8.1275, 32 bit, CLR 4.0, Release): PostSharp.Sdk.CodeModel.AssemblyLoadException: Error while loading the assembly " MyProject.general, <strong>version=1.0.5378.169</strong> , culture=neutral, publickeytoken=4c1c78190569e723": Cannot find an assembly named MyProject.General, <strong>Version=1.0.5378.169</strong>, Culture=neutral, PublicKeyToken=4c1c78190569e723'. [C:\HudsonHome\jobs\test\workspace\WCF\MyProject\ MyProject.project.WCF.Service.csproj]</p>

<p>(Bold text is the current version)</p>

<p>Also all csproj files are altered, adding a before build action that will replace old version to actual.</p>

<p><code>&lt;Target Name="BeforeBuild"&gt;
&lt;FileUpdate Condition="'$(CCNetLabel)' != ''" Files="Properties\AssemblyInfo.cs" Regex="       (\d+)[.](\d+)[.](\d+)[.](\d+)" ReplacementText="$(CCNetLabel)" /&gt;
&lt;/Target&gt;</code></p>

<p>CCNetLabel is an environmental variable that Hudson changed every time before build.
I understand that post sharp is looking for a dll of current version but it doesn’t exist. And I’m not sure why, on my project old CI server everything works fine.
I would be grateful for any pointers on this matter</p>
 How to inject an attribute using a PostSharp attribute? <p>How can I write a PostSharp aspect to apply an attribute to a class? The scenario I'm considering is a WCF entity (or domain object) that needs to be decorated with the <code>DataContract</code> attribute. It should also have a <code>Namespace</code> property. Like this:</p>

<pre><code>using System.Runtime.Serialization;

namespace MWS.Contracts.Search.V1
{
    namespace Domain
    {
        [DataContract(Namespace = XmlNamespaces.SchemaNamespace)]
        public class PagingContext
        {
            [DataMember]
            public int Page { get; set; }

            [DataMember]
            public int ResultsPerPage { get; set; }

            [DataMember]
            public int MaxResults { get; set; }
        }
    }
}
</code></pre>

<p>In the above example you can see what I want the output to look like. It has the DataContract attribute applied to the class. Doing this by hand is tedious and not unique. I'd really just like to write a single aspect that can be applied a my "Domain" namespace. It would then apply the serialization related attributes for me. This way I can just focus on developing entity objects, and not worry about the serialization pluming details. </p>

<p>I have found documentation on PostSharp's website for injecting code before, after, and instead of methods. However what I'm looking for is a way to inject an Attribute onto a type. </p>

<hr>

<p><strong>Here is the solution!</strong></p>

<pre><code>using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Runtime.Serialization;
using PostSharp.Aspects;
using PostSharp.Extensibility;
using PostSharp.Reflection;

namespace MWS.Contracts.Aspects
{
    // We set up multicast inheritance so  the aspect is automatically added to children types.
    [MulticastAttributeUsage(MulticastTargets.Class, Inheritance = MulticastInheritance.Strict)]
    [Serializable]
    public sealed class AutoDataContractAttribute : TypeLevelAspect, IAspectProvider
    {
        private readonly string xmlNamespace;

        public AutoDataContractAttribute(string xmlNamespace)
        {
            this.xmlNamespace = xmlNamespace;
        }

        // This method is called at build time and should just provide other aspects.
        public IEnumerable&lt;AspectInstance&gt; ProvideAspects(object targetElement)
        {
            var targetType = (Type) targetElement;

            var introduceDataContractAspect =
                new CustomAttributeIntroductionAspect(
                    new ObjectConstruction(typeof (DataContractAttribute).GetConstructor(Type.EmptyTypes)));

            introduceDataContractAspect.CustomAttribute.NamedArguments.Add("Namespace", xmlNamespace);

            var introduceDataMemberAspect =
                new CustomAttributeIntroductionAspect(
                    new ObjectConstruction(typeof (DataMemberAttribute).GetConstructor(Type.EmptyTypes)));

            // Add the DataContract attribute to the type.
            yield return new AspectInstance(targetType, introduceDataContractAspect);

            // Add a DataMember attribute to every relevant property.)))
            foreach (var property in
                targetType.GetProperties(BindingFlags.Public | BindingFlags.DeclaredOnly | BindingFlags.Instance)
                    .Where(property =&gt;
                           property.CanWrite &amp;&amp;
                           !property.IsDefined(typeof (NotDataMemberAttribute), false)))
                yield return new AspectInstance(property, introduceDataMemberAspect);
        }
    }

    [AttributeUsage(AttributeTargets.Property)]
    public sealed class NotDataMemberAttribute : Attribute
    {
    }
}
</code></pre>
 Usage of AspectPriority <p>I'm using PostSharp 2.1.5.1 and had a warning today:</p>

<blockquote>
  <p>Aspect dependencies (defined on
  "MyNamespace.MyAspect.MyVerificationAttribute") will be disabled from
  the Starter Edition in future versions. Use the AspectPriority
  property instead.</p>
</blockquote>

<p>Seems to me that following line is causing that warning:</p>

<pre><code>[AspectRoleDependency(AspectDependencyAction.Order, AspectDependencyPosition.After, StandardRoles.Tracing)]
</code></pre>

<p>Could someone point me to a correct example of how to use <code>AspectPriority</code>? Are the following examples up to date?</p>

<ul>
<li><p><a href="http://www.sharpcrafters.com/blog/post/introducing-postsharp-2-0-3-aspect-dependencies.aspx" rel="nofollow">http://www.sharpcrafters.com/blog/post/introducing-postsharp-2-0-3-aspect-dependencies.aspx</a> (section "Old Good Aspect Priority")</p></li>
<li><p><a href="http://www.sharpcrafters.com/blog/post/Day-3-Applying-Aspects-with-Multicasting-Part-2.aspx" rel="nofollow">http://www.sharpcrafters.com/blog/post/Day-3-Applying-Aspects-with-Multicasting-Part-2.aspx</a> (section "Aspect Priority")</p></li>
</ul>

<p>Thanks.</p>
 PostSharp inserting k__Backing Field into Entity Class, causing Database generation to fail <p>I'm creating a Database using the Microsoft Entity Framework and CodeFirst in C#. I want to use the Database in a WPF-Application, so the Entity-Classes should implement "INotifyPropertyChanged". </p>

<p>This can be done very elegantly using a PostSharp aspect, which triggers the PropertyChanged event automatically every time a property changes. If I create such an aspect and use it on my entity classes, I get the following exeption when trying to create the Database:</p>

<pre><code> \tSystem.Data.Entity.Edm.EdmNavigationProperty: Name: The specified name is not allowed:          '&lt;Name&gt;k__BackingField'.
</code></pre>

<p>Obviously PostSharp creates a property called "k__BackingField" which causes the database creation to fail, because it's an invalid name from the EntityFramework's point of view. Is there any way to circumvent this error without manually implementing "INotifyPropertyChanged" in every single Entity-Class?</p>

<p>P.S: English is not my native language, I would be very thankful if you informed me about possible mistakes in my postings.</p>

<p>Thank you in advance</p>
 
aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented aspect-oriented Aspect-Oriented Objective-C Library? <p>Is there any Aspect-Oriented Objective-C library that I could perhaps use for iPhone development?</p>
 Aspect Oriented Programming (AOP) in C NOT C++ — anyone doing it? <p>Has anyone seen or written their own framework for doing Aspect Oriented Programming in C?</p>

<p>Not C++ -- I've seen already that there's AspectC which is really C++.</p>

<p>Involved in embedded software development which requires C only.</p>

<p>I am not asking how to do it, only whether someone has done it already.</p>

<p><hr></p>

<p>EDIT:</p>

<p>Need clarification on one of the responses.</p>

<p>Mads Elvheim</p>

<p>It was not my <em>position</em> that AspectC is C++. Rather, I had searched for AOP for C and only gotten to <a href="http://www.aspectc.org/">http://www.aspectc.org/</a>, which certainly sounded from the URL like <em>the</em> place, but it begins, </p>

<blockquote>
  <p>"With the AspectC++ project we extend
  the AspectJ approach to C/C++. It is a
  set of C++ language extensions to
  facilitate aspect-oriented programming
  with C/C++"</p>
</blockquote>

<p>which made me think that there was no AOP from them just for C. The link you sent looks more promising, in that its web page title is "AOP for C". But here at this link, <a href="http://www.cs.ubc.ca/labs/spl/projects/aspectc.html">http://www.cs.ubc.ca/labs/spl/projects/aspectc.html</a>, I can't find any code, so I'm not sure. Do you know where to find code on that site?</p>

<p>As for <a href="http://sailhome.cs.queensu.ca/~bram/aspicere/index.html#examples">http://sailhome.cs.queensu.ca/~bram/aspicere/index.html#examples</a>, I've already found the code examples there, so I'll look at them.</p>
 Aspect Oriented Logging with Unity\T4\anything else <p>In my application we have a trace logger. We have log statements added at the beginning and end of most of the important methods tracing the method name and the parameter values. Now these trace statements are bloating the code and it is a bit of a pain to read through them.</p>

<p>I am considering how can I separate this aspect of the code from my business logic.</p>

<p>Today I was reading about Unity's interception framework. I had a passing thought if it is possible to intercept my method calls with a generic logger and log the method name and parameter values. I am not sure if it is possible to read method parameters using reflection. Can Unity be used like this?</p>

<p>Another idea was to run the T4 code generation engine to generate logging statements at the beginning and end of all methods decorated with a particular attribute. Since I know very little about T4, does anyone know if this can be accomplished?</p>

<p>Are there any other ways to separate the logging code from my business logic?</p>

<p>Cheers,
Unmesh</p>
 Run Code Before Every Function Call for a Class in C++ <p>I would like to run some code (perhaps a function) right before every function call for a class and all functions of the classes that inherit from that class.  I'd like to do this without actually editing every function, Is such a thing even possible?  </p>

<p>I would settle for having a function called as the first instruction of every function call instead of it being called right before.</p>
 How can Domain driven design be combined with aspect oriented programming? <p>I'm doing research and one point I want to cover is "What is the relationship between Domain-driven Design and Aspect oriented programming?"</p>

<p>I know that a main principle in DDD is separation of concerns and I understand that. What I'm not really certain is, whether aspects in AOP acts like "sub domains" in our domain in DDD. </p>

<p>Are these two concepts, basically the same thing. I mean, If I develop an application following AOP and DDD, at the end of the day will it be true that "a sub domain" == "an aspect".</p>

<p>I will also appreciate any other opinions what is the common between AOP and DDD.</p>
 C#: Wrapping methods in other methods <p>Is there a way to wrap methods in other methods transparently in C#? I want to achieve what is done by Moose's around functionality: <a href="http://search.cpan.org/perldoc?Moose::Manual::MethodModifiers" rel="nofollow">http://search.cpan.org/perldoc?Moose::Manual::MethodModifiers</a></p>

<p>EDIT: And by transparent I mean without modifying the original method.</p>
 Any mature AOP library to use in .Net world? <p>The library should at least compared to AspectJ, any?</p>
 Django: What exactly are signals good for? <p>I have a tough time understanding how signals work into my application (and how they work period). These are three areas where I assume they would apply (with my current knowledge):</p>

<ol>
<li>Send XML to a remote server for reporting (after a transaction is complete).</li>
<li>Re size an image and upload the thumbnail to S3 after a user uploads it.</li>
<li>Delete old images from S3 after a user deletes an image object from his account.</li>
</ol>

<p>Am I totally off base (I feel I might be). <strong>Am I getting signals and multi threading mixed up</strong>? If so, do they compare in there application? Are they only for decoupling? Also, what's the deal with making sure you instantiate them early and don't use a local function (because they'll get garbage collected)? Can someone elaborate on that? Should I put them all in request Middleware so that I don't have to worry?</p>
 Is there any attribute relating to AJAX to be set for ASP.NET MVC controller actions? <p>I want to use partial views with AJAX calls in ASP.NET MVC, and this is the first time I'm using it. I just searched to see if there is anything special I should know beforehand, and one of'em that I'm curious about, is to see if there is any special attribute that should be set or is related to AJAX calls? Something like <code>[ChildActionOnly]</code> or <code>[HttpGet]</code></p>
 Pointcuts and Aspect-Oriented Programming <p>How are pointcuts used in aspect-oriented programming language to add functionality into an existing program?</p>

<p>To my understanding, from this Wikipedia article - <a href="http://en.wikipedia.org/wiki/Pointcut" rel="nofollow">http://en.wikipedia.org/wiki/Pointcut</a></p>

<p>Pointcuts are placed into a specific spot in a piece of code, and when that point is reached, based on the evaluation of the pointcut, more code can be executed at a specific point somewhere in the code based on the evaluation of the pointcut.  Is this a correct understanding?</p>

<p>If so, then that would add functionality because the programmer can execute different piece of code based off that evaluation.</p>
 Authorization of UI Elements in .NET WinForms <p>I have a general question about the best approach for authorizing UI elements for application Roles. What I mean is an Administrator can see buttons, menu items, etc, that a regular User cannot see. What is the best practice for this?</p>

<p>I realize that there could be multiple screens based on Role (an Admin screen, the same screen duplicated for User, etc), that definitely seems like overkill. I also want to keep Separation of Concern so my authorization code is not intermingled with display functionality. In other words, I want to avoid:</p>

<pre><code>if( current_user.IsInRole("administrator") )
  button.Enabled = true;
</code></pre>

<p>I have been looking at Aspects with PostSharp, which seems <em>almost</em> exactly what I want to do, but it doesn't seem to logically extend to the UI.</p>

<p>I'm sure I'm missing something, what is it?</p>

<p>Thanks -</p>
 Does Delphi offer an event handler for form creation notifications? <p>Does Delphi provide some kind of event or hook for form creation (or more generally, form lifecycle events)?</p>

<p>So that if somewhere in the code a form is created and shown (modal or non-modal, dynamically or in the usual app starup stage), Delphi calls an event handler which allows to log / analyse / modify the form before it is shown?</p>

<p>I know there are options which involve introducing a base form class or a custom form creation procedure, but for existing applications which already have many forms it would be 'nice to have' a non-intrusive option to add something similar to cross-cutting concerns in Aspect oriented programming (AOP).</p>

<p>For example, if I had some code for usage statistics tracking which injects additional event handlers, I could simply add this functionality for every form, developers would not have to change the application code, only add code similar to this </p>

<pre><code>...
   Application.OnNewForm := MyNewFormCreated;
...

procedure TMyApp.MyNewFormCreated(Sender: TCustomForm);
begin
  // iterate over components and do other stuff with the new form
  ...
end;
</code></pre>
 Is it possible to add methods to classes with PostSharp? If yes, is it possible to then reference those methods from other classes? <p>Let's say I have a class <code>Abc</code>:</p>

<pre><code>class Abc {
}
</code></pre>

<p>and that I'd like to externally add some method <code>m()</code> to it. I guess it's probably possible to do this, although I am not sure how. Assuming it is possible to do that, let's then say Abc does have, from now on, a <code>m()</code> method.</p>

<p>Now, imagine I have other class <code>Def</code>:</p>

<pre><code>class Def {
    public void x(Abc abc) {
        abc.m();
    }
}
</code></pre>

<p>Would this code run with PostSharp? To the more distracted reader, the problem with this is that in a standard C# class program, our compiler might not know the <code>Abc</code> class has a <code>m()</code> method.</p>

<p>My gut feeling is that this wouldn't work with PostSharp. Am I mistaken?</p>
 How to inject an attribute using a PostSharp attribute? <p>How can I write a PostSharp aspect to apply an attribute to a class? The scenario I'm considering is a WCF entity (or domain object) that needs to be decorated with the <code>DataContract</code> attribute. It should also have a <code>Namespace</code> property. Like this:</p>

<pre><code>using System.Runtime.Serialization;

namespace MWS.Contracts.Search.V1
{
    namespace Domain
    {
        [DataContract(Namespace = XmlNamespaces.SchemaNamespace)]
        public class PagingContext
        {
            [DataMember]
            public int Page { get; set; }

            [DataMember]
            public int ResultsPerPage { get; set; }

            [DataMember]
            public int MaxResults { get; set; }
        }
    }
}
</code></pre>

<p>In the above example you can see what I want the output to look like. It has the DataContract attribute applied to the class. Doing this by hand is tedious and not unique. I'd really just like to write a single aspect that can be applied a my "Domain" namespace. It would then apply the serialization related attributes for me. This way I can just focus on developing entity objects, and not worry about the serialization pluming details. </p>

<p>I have found documentation on PostSharp's website for injecting code before, after, and instead of methods. However what I'm looking for is a way to inject an Attribute onto a type. </p>

<hr>

<p><strong>Here is the solution!</strong></p>

<pre><code>using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Runtime.Serialization;
using PostSharp.Aspects;
using PostSharp.Extensibility;
using PostSharp.Reflection;

namespace MWS.Contracts.Aspects
{
    // We set up multicast inheritance so  the aspect is automatically added to children types.
    [MulticastAttributeUsage(MulticastTargets.Class, Inheritance = MulticastInheritance.Strict)]
    [Serializable]
    public sealed class AutoDataContractAttribute : TypeLevelAspect, IAspectProvider
    {
        private readonly string xmlNamespace;

        public AutoDataContractAttribute(string xmlNamespace)
        {
            this.xmlNamespace = xmlNamespace;
        }

        // This method is called at build time and should just provide other aspects.
        public IEnumerable&lt;AspectInstance&gt; ProvideAspects(object targetElement)
        {
            var targetType = (Type) targetElement;

            var introduceDataContractAspect =
                new CustomAttributeIntroductionAspect(
                    new ObjectConstruction(typeof (DataContractAttribute).GetConstructor(Type.EmptyTypes)));

            introduceDataContractAspect.CustomAttribute.NamedArguments.Add("Namespace", xmlNamespace);

            var introduceDataMemberAspect =
                new CustomAttributeIntroductionAspect(
                    new ObjectConstruction(typeof (DataMemberAttribute).GetConstructor(Type.EmptyTypes)));

            // Add the DataContract attribute to the type.
            yield return new AspectInstance(targetType, introduceDataContractAspect);

            // Add a DataMember attribute to every relevant property.)))
            foreach (var property in
                targetType.GetProperties(BindingFlags.Public | BindingFlags.DeclaredOnly | BindingFlags.Instance)
                    .Where(property =&gt;
                           property.CanWrite &amp;&amp;
                           !property.IsDefined(typeof (NotDataMemberAttribute), false)))
                yield return new AspectInstance(property, introduceDataMemberAspect);
        }
    }

    [AttributeUsage(AttributeTargets.Property)]
    public sealed class NotDataMemberAttribute : Attribute
    {
    }
}
</code></pre>
 Usage of AspectPriority <p>I'm using PostSharp 2.1.5.1 and had a warning today:</p>

<blockquote>
  <p>Aspect dependencies (defined on
  "MyNamespace.MyAspect.MyVerificationAttribute") will be disabled from
  the Starter Edition in future versions. Use the AspectPriority
  property instead.</p>
</blockquote>

<p>Seems to me that following line is causing that warning:</p>

<pre><code>[AspectRoleDependency(AspectDependencyAction.Order, AspectDependencyPosition.After, StandardRoles.Tracing)]
</code></pre>

<p>Could someone point me to a correct example of how to use <code>AspectPriority</code>? Are the following examples up to date?</p>

<ul>
<li><p><a href="http://www.sharpcrafters.com/blog/post/introducing-postsharp-2-0-3-aspect-dependencies.aspx" rel="nofollow">http://www.sharpcrafters.com/blog/post/introducing-postsharp-2-0-3-aspect-dependencies.aspx</a> (section "Old Good Aspect Priority")</p></li>
<li><p><a href="http://www.sharpcrafters.com/blog/post/Day-3-Applying-Aspects-with-Multicasting-Part-2.aspx" rel="nofollow">http://www.sharpcrafters.com/blog/post/Day-3-Applying-Aspects-with-Multicasting-Part-2.aspx</a> (section "Aspect Priority")</p></li>
</ul>

<p>Thanks.</p>
 Spring.NET.AOP - ExceptionHandlerAdvice doesnt replace custom exception <p>this is my first and also I am beginner in Spring.NET and also AOP. </p>

<p>I would like use Aspect for Exception Hadling for replacing, wrap and modify my custom exceptions.</p>

<p>First I defined some entity and DAO. From method Save in DAO I will throw my exception.</p>

<p>FYI: This is silly sample </p>

<p><strong>Entity:</strong></p>

<pre><code>namespace ExceptionHandlingTutorial.Entities
{
    public class Customer
    {
        public long Id { get; set; }
        public string Name { get; set; }
    }
}
</code></pre>

<p><strong>DAO:</strong></p>

<pre><code>namespace ExceptionHandlingTutorial.Dao
{
    public interface ICustomerDao
    {
        void Save(Customer customer);
    }

    public class CustomerDao:ICustomerDao
    {
        #region Implementation of ICustomerDao

        public void Save(Customer customer)
        {
            throw new CustomerException(
                string.Format("Customer with id {0} already exist in repository",customer.Id));
        }

        #endregion
    }
}
</code></pre>

<p><strong>CustomException class definition is here:</strong></p>

<pre><code>namespace ExceptionHandlingTutorial
{
    public class CustomerException : Exception
    {
        public CustomerException(string msg)
            : base(msg)
        {

        }
    }
}
</code></pre>

<p>In app.config I defined <code>CustomerDao</code> object and <code>ExceptionHandlerAdvice</code> object which only replace <code>CustomerException</code> for <code>System.ArgumentException</code>.</p>

<p>I am not sure if <code>ExceptionHandlerAdvice</code> is auto-proxy and also I don’t how it identified targets.</p>

<p>I believe that it uses SpEL for define rules and when there is some exception it throws check list.
Ok this type of exception is in list some I will apply advice.</p>

<p>Can anybody explain to me how this aspect identified targets? For example I would like apply this aspect only for a few objects not all.</p>

<p>I use ref documentation Chapter 14.3 Exception handling but I couldnt find these information.</p>

<p><strong>Here is app.config:</strong></p>

<pre><code>&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;configuration&gt;

  &lt;configSections&gt;
    &lt;sectionGroup name="spring"&gt;
      &lt;section name="context" type="Spring.Context.Support.ContextHandler, Spring.Core"/&gt;
      &lt;section name="objects" type="Spring.Context.Support.DefaultSectionHandler, Spring.Core"/&gt;
    &lt;/sectionGroup&gt;
  &lt;/configSections&gt;

  &lt;spring&gt;

    &lt;context&gt;
      &lt;resource uri="config://spring/objects"/&gt;
    &lt;/context&gt;

    &lt;objects xmlns="http://www.springframework.net"&gt;

      &lt;object id="customerDao" 
              type="ExceptionHandlingTutorial.Dao.CustomerDao, ExceptionHandlingTutorial"/&gt;

      &lt;object id="exceptionHandlerAdvice" 
              type="Spring.Aspects.Exceptions.ExceptionHandlerAdvice, Spring.Aop"&gt;

        &lt;property name="ExceptionHandlers"&gt;
          &lt;list&gt;
            &lt;value&gt;on exception name CustomerException replace System.ArgumentException 'Something'&lt;/value&gt;
          &lt;/list&gt;
        &lt;/property&gt;

      &lt;/object&gt;

    &lt;/objects&gt;

  &lt;/spring&gt;
&lt;/configuration&gt;
</code></pre>

<p><strong>My main problem is that if I call method Save on DAO it throw exception type of CustomerException this exception is not replaced. Why?</strong></p>

<pre><code>try
            {
                var context = ContextRegistry.GetContext();
                var customerDao = (ICustomerDao)context["customerDao"];

                customerDao.Save(new Customer { Id = 1, Name = "Customer_1" });
            }
            catch (Exception ex)
            {

                Console.WriteLine(string.Format("Exception type: {0}\nException message: {1}\n",
                    ex.GetType(),ex.Message));
            }
</code></pre>

<p>Thrown exception is type of <code>CustomerException</code> not <code>ArgumentException</code>,</p>

<p>Also I tried use DSL for defined rules when advice apply:</p>

<pre><code>on exception (#e is T(ExceptionHandlingTutorial.CustomerException) translate new System.ArgumentException('XChange, Method Name'+ #method.Name, #e))
</code></pre>

<p>But still is throw exception type of CustomerException.</p>

<p>Thank you for help. </p>
 Where to place authentication check in ASP.NET <p>I have some code used to determine if a user is logged in and I want to put this on every page in an ASP.NET website so that only logged in users can view it. The problem is that the site is split into multiple projects/solutions so maintaining the single piece of code might be hard.</p>

<p>I was thinking I could create a class that inherits for <code>System.Web.UI.Page</code> and overrides <code>Page_Init</code>, but that would require changing all pages so they inherit from new new class. Also I don't think this will work across projects.</p>

<p>So then I thought approaching the problem from a different side: using AOP. I have never used Aspects before but it looks like I could use PostSharp to write an Aspect that injects code before every <code>Page_Init</code> (or maybe <code>Page_Load</code>?). This might work as a quick solution but I might run into problems if I need a page to not perform the authentication check (available to everyone).</p>

<p>Just to clarify, I already have a login solution; I am just looking for a checking that login on each page.</p>
 Creating an Aspect Oriented Property/Method from scratch <p>I have one (and only one) method that I want to use an aspect on.  It is <a href="http://msdn.microsoft.com/en-us/library/microsoft.practices.prism.modularity.imodule.initialize%28v=pandp.40%29.aspx" rel="nofollow">IModule.Initialize</a>. (The method is found in about 15 classes in my solution)</p>

<p>It would look like this:</p>

<pre><code>[LogToSplashScreen]
public void Initialize()
{
   RegisterViews();
   RegisterDesignTimeVMs();
}
</code></pre>

<p>I would like my aspect to run this before the method body executes:</p>

<pre><code>var moduleInfo = new ModuleInformation{ModuleName = "ClassNameHere"};
splashScreenService.ModuleLoadStart(moduleInformation);
</code></pre>

<p>And this after:</p>

<pre><code>splashScreenService.ModuleLoadEnd(moduleInformation);
</code></pre>

<hr>

<p><em>Side Note:</em><br>
I looked at this and thought, OK, time to try out PostSharp.  I have heard it is the AOP tool of champions.  So I fired up the NuGet package (expecting to get the free version) and installed it. </p>

<p>And it is loaded with DemoWare (ie extra installers).  I personally don't mind.  But I don't want my team to have to deal with an installer just so I can solve my little problem.</p>

<p>And demo aside, the fact that is has a UI will (I am guessing) make it hard for my build server.  (I use Package Restore.)</p>

<p>These are all things I would be willing to deal with if I was going "all in" on Aspect Oriented Programming.<br>
But I just need one...</p>

<hr>

<p><strong>Is there a way to "roll my own" with out a lot of headache?</strong></p>
 How to exit a method in the OnEntry method of a PostSharp aspect based on condition <p>I'd like the aspect to exit a method invocation based on a condition like the following:</p>

<pre><code>    [AttributeUsage(AttributeTargets.Method)]
    public class IgnoreIfInactiveAttribute : OnMethodBoundaryAspect
    {
        public override void OnEntry(MethodExecutionEventArgs eventArgs)
        {
             if (condition)
            {
                **// How can I make the method return here?**
            }
        }
    }
</code></pre>

<p>Any help much appreciated.</p>
 Aspect Oriented Programming Library/Framework for Actionscript 3? <p>I'm looking for a full featured AOP Library for Actionscript 3.</p>

<p>The following projects I noticed so far, but they all seem to have their problems:</p>

<ul>
<li><a href="http://farmcode.org/page/Sodality.aspx" rel="nofollow">http://farmcode.org/page/Sodality.aspx</a><br>
looks most promising so far, however it requires you to create a whole new class for every AOP "call" I believe, and it forces you to follow quite a lot of restrictions, anyone has experience with it?</li>
<li><a href="http://code.google.com/p/loom-as3/" rel="nofollow">http://code.google.com/p/loom-as3/</a><br>
this one is discontinued</li>
<li><a href="http://code.google.com/p/floxy/" rel="nofollow">http://code.google.com/p/floxy/</a><br>
dynamic proxy generation? this isn't really AOP as I know it, right?</li>
<li><a href="http://code.google.com/p/flemit/" rel="nofollow">http://code.google.com/p/flemit/</a><br>
dynamic byte code generation? this is something AOP needs I think, but not the full featured AOP framework I am looking for</li>
</ul>

<p>Does anyone know  of a better solution? Or does anyone have any experiences with AOP in Actionscript 3?</p>

<p>Best regards,</p>

<p>Tom</p>
 Implement Apect-oriented-like nested around filters with Ruby? <p>I'm trying to write a class that supports nested around filters without introducing an Aspect-oriented library.</p>

<pre><code>class Foo
  attr_accessor :around_filter

  def initialize
    #filters which wrap the following one are the ones with interesting logic
    #vanilla do-nothing filter
    @around_filter = lambda { yield } # or lambda {|&amp;blk| blk.call}
  end

  def bar
    #would execute the around filters however deeply nested, then "meaty code"
    @around_filter.call do
      #meaty code here
      puts 'done' 
    end
  end

  #I expected to point only to the topmost filter, hoping to recurse
  def add_around_filter(&amp;blk)
    prior_around_filter = @around_filter
    @around_filter = #??mystery code here?? refers to prior_around_filter
  end
end
</code></pre>

<p>The goal is to be able to add any number of around filters:</p>

<pre><code>foo = Foo.new
foo.add_around_filter do
  puts 'strawberry'
  yield
  puts 'blueberry'
end
foo.add_around_filter do
  puts 'orange'
  yield
  puts 'grape'
end
foo.bar #=&gt; orange, strawberry, done, blueberry, grape
</code></pre>

<p>I know there are a bunch of holes in the example.  I wrote only enough to covey the general direction, distilling from a much larger actual class.</p>

<p>Although I prefer <code>yield</code> syntax, I'm not opposed to block references:</p>

<pre><code>foo.add_around_filter do |&amp;blk|
  puts 'orange'
  blk.call
  puts 'grape'
end
</code></pre>

<p>I got this working only with a single around filter.  I tried lots of things with nesting, but never cracked the puzzle.  If you have a solution, I'd appreciate it a bunch!  </p>
 Loose programming in high level languages, how, why and how much? <p>I'm writing my code in haXe. This is quite irrelevant to the question though, as long as you keep in mind that it's a high level language and compareable with Java, ActionScript, JavaScript, C#, etc. (I'm using pseudocode here).</p>

<p>I'm going to work on a big project and am busy preparing now. For this question I'll create a small scenario though: a simple application which has a Main class (this one is executed when the application launches) and a LoginScreen class (this is basically a class that loads a login screen so that the user can login).</p>

<p>Typically I guess this would look like the following:</p>

<pre><code>Main constructor:
loginScreen = new LoginScreen()
loginScreen.load();

LoginScreen load():
niceBackground = loader.loadBitmap("somebg.png");
someButton = new gui.customButton();
someButton.onClick = buttonIsPressed;

LoginScreen buttonIsPressed():
socketConnection = new network.SocketConnection();
socketConnection.connect(host, ip);
socketConnection.write("login#auth#username#password");
socketConnection.onData = gotAuthConfirmation;

LoginScreen gotAuthConfirmation(response):
if response == "success" {
   //login success.. continue
}
</code></pre>

<p>This simple scenario adds the following dependencies and downsides to our classes:</p>

<ul>
<li>Main will not load without LoginScreen</li>
<li>LoginScreen will not load without the custom loader class</li>
<li>LoginScreen will not load without our custom button class</li>
<li>LoginScreen will not load without our custom SocketConnection class</li>
<li>SocketConnection (which will have to be accessed by a lot of different classes in the future) has been set inside LoginScreen now, which is actually quite irrelevant from it, apart from the fact that the LoginScreen requires a socket connection for the first time</li>
</ul>

<p>To solve these problems, I have been suggested to do "Event-Driven-Programming", or loose coupling. As far as I understand, this basically means that one has to make classes independent from each other and then bind them together in separate binders.</p>

<p>So question 1: is my view on it true or false? Does one have to use binders?</p>

<p>I heard Aspect Oriented Programming could help here. Unfortunately haXe does not support this configuration.</p>

<p>However, I do have access to an event library which basically allows me to create a signaller (public var loginPressedSignaller = new Signaller()), to fire a signaller (loginPressedSignaller.fire()) and to listen to a signalller (someClass.loginPressedSignaller.bind(doSomethingWhenLoginPressed)).</p>

<p>So, with little further investigation I figured this would change my previous setup to:</p>

<pre><code>Main:
public var appLaunchedSignaller = new Signaller();

Main constructor:
appLaunchedSignaller.fire();

LoginScreen:
public var loginPressedSignaller = new Signaller();

LoginScreen load():
niceBackground = !!! Question 2: how do we use Event Driven Programming to load our background here, while not being dependent on the custom loader class !!!
someButton = !!! same as for niceBackground, but for the customButton class !!!
someButton.onClick = buttonIsPressed;

LoginScreen buttonIsPressed():
loginPressedSignaller.fire(username, pass);

LoginScreenAuthenticator:
public var loginSuccessSignaller = new Signaller();
public var loginFailSignaller = new Signaller();

LoginScreenAuthenticator auth(username, pass):
socketConnection = !!! how do we use a socket connection here, if we cannot call a custom socket connection class !!!
socketConnection.write("login#auth#username#password");
</code></pre>

<p>This code is not finished yet, eg. I still have to listen for the server response, but you probably understand where I am getting stuck.</p>

<p>Question 2: Does this new structure make any sense? how should I solve the problems above mentioned in the !!! delimiters?</p>

<p>Then I heard about binders. So maybe I need to create a binder for each class, to connect everything together. Something like this:</p>

<pre><code>MainBinder:
feature = new Main();    

LoginScreenBinder:
feature = new LoginScreen();
MainBinder.feature.appLaunchedSignaller.bind(feature.load);
niceBackgroundLoader = loader.loadBitmap;
someButtonClass = gui.customButton();
</code></pre>

<p>etc... hopefully you understand what I mean. This post is getting a bit long so I have to wrap it up a bit.</p>

<p>Question 3: does this make any sense? Doesn't this make things unnecessarily complex?</p>

<p>Also, in the above "Binders" I only had to use classes which are instantiated once, eg. a login screen. What if there are multiple instances of a class, eg. a Player Class in a game of chess.</p>
 C# AOP Method Interception on child method calls? <p>My AOP (C#) implementation always intercepts the first (public) method call but not subsequent methods called within the first intercepted method, is this a limitation with ContextBoundObject AOP implementations or am I doing it wrong?</p>

<pre><code>[InterceptMe]
public void MethodOne()
{
    MethodTwo();
}

[InterceptMe]
public void MethodTwo() 
{ 
   //not intecepted from MethodOne Call 
}
</code></pre>

<p>Any Ideas?</p>
 Aspect Oriented Programming in C++ - Current supported alternatives <p>I have used AspectJ before for Java, and I recently have thought about checking which possibilities exist for the C++ language.</p>

<p>I heard about <a href="http://www.aspectc.org/" rel="nofollow">AspectC++</a>, but unlike AspectJ, AspectC++ seems to be abandoned in the sense that the latest release dates from 21.12.2005, according to their website.</p>

<p>I wonder if there are any more recent alternatives currently being used or developed nowadays, and which are still supported and having continuous updates and evolution, and also if any of such alternatives happen to have some sort of integration plugin for easier use within the Eclipse IDE.</p>

<p>In the event that there aren't, are there some most problematic limitations from AspectC++ that I should be aware of before considering to use it?</p>

<p>Thanks in advance.</p>
 Creating LinFu interceptors for all types within an assembly <p>I'm trying to create LinFu interceptors for all methods in my DAL assembly. While I can do something like this:</p>

<pre><code>[Intercepts(typeof(IFirstRepository))]
[Intercepts(typeof(ISecondaryRepository))]
[Intercepts(typeof(IIAnotherRepository))]
public class DalInterceptor : IInterceptor, IInitialize
{
... 
}
</code></pre>

<p>that's getting quite messy and needs manual updating every time a new repository is added to the assembly.</p>

<p>Is there a way to automatically create a proxy class for each type in the assembly?</p>

<p>UPDATE:</p>

<p>I've updated my proxy builder using the suggestion from the author himself (Mr Laureano) so I now have this:</p>

<pre><code>Func&lt;IServiceRequestResult, object&gt; createProxy = request =&gt;
{
    var proxyFactory = new ProxyFactory();
    DalInterceptor dalInterceptor = new DalLiteInterceptor();
    return proxyFactory.CreateProxy&lt;object&gt;(dalInterceptor);
};
</code></pre>

<p>The interceptor is set up as before. The issue I'm having now is that the proxy object doesn't include the constructors and methods of the original object (I'm guessing as I'm using object in the generic create method).</p>

<p>Do I just cast this back to the required type or am I doing something fundamentally wrong?</p>

<p>Thanks.</p>
 Disabling C++ code without macros <p>I hate macros. I'm trying to avoid using them as much as I can, but I occasionally need them to enable / disable features in my code. Typically:</p>

<pre><code>#ifdef THREAD_SAFE
  typedef boost::mutex Mutex;
  typedef boost::mutex::scoped_lock ScopedLock;
#else
  typedef struct M {            } Mutex;
  typedef struct S { S(M m) { } } ScopedLock;
#endif
</code></pre>

<p>This way I can leave my actual code unchanged. I'm trusting the compiler to remove the placebo code when the macro is undefined.</p>

<p>I'm aware that template specialization could be a solution, but that would involve a lot of rewriting / code duplicating.</p>

<p>No need to be a C++ expert to guess there's something wrong with the way I'm cheating on the compiler. I'm looking for a better solution.</p>
 Which are the most suitable languages to apply Aspect's Theme approach? <p>I am thinking about reading <a href="http://rads.stackoverflow.com/amzn/click/0321246748" rel="nofollow">Aspect-Oriented Analysis and Design: The Theme Approach</a>, yet I am hesitant. Is it possible to use what's taught in the book with AspectJ (for Java) or Post# in C#? Maybe with Aquarium in Ruby?</p>

<p>What would be the perfect language to suit the design process that's made with the book? I am more interested in the symmetrical approach to aspects.</p>

<p>Thanks</p>
 PostSharp Pointcuts <p>Before I start, I'd like to clarify that my current understanding of AOP terminology is as follows...</p>

<ul>
<li>Aspects are the AOP equivalent of Classes in OOP.</li>
<li>Advices are the AOP equivalent of Methods in OOP.</li>
<li>Pointcuts are the AOP equivalent of 'using' code in OOP. In OOP we invoke things. In AOP we weave things. The decision of <em>what</em> to weave <em>where</em> is defined by Pointcuts.</li>
</ul>

<p>Onto the actual question...</p>

<p>I have a logging aspect in PostSharp which I want to use (weave) on every method, excluding properties. Originally I was using the following on my aspect:</p>

<pre><code>[MulticastAttributeUsage(MulticastTargets.Method, TargetMemberAttributes = MulticastAttributes.Instance)]
</code></pre>

<p>However, I found the aspect was still being woven into properties, meaning I had to perform a secondary check at runtime to preclude my code from executing on properties:</p>

<pre><code>if (!methodName.StartsWith("set_") &amp;&amp; !methodName.StartsWith("get_")) {
</code></pre>

<p>This is not ideal. I should be able to define this behavior in my pointcut so that I don't have to perform any runtime checking.</p>

<p>I have been looking into the <code>MethodPointcut</code> attribute which appears to provide me with a callback to help the weaver select candidates for the advice at build time. <em>Please can I see an example?</em></p>

<p>Assuming this does work, I am still left thinking 'Why must I hardcode Pointcuts to my Advices?'. Aspects and Advices are the definition/implementation. Pointcuts are the usage. The two should be seperate.</p>
 How to chain message sinks in a context bound object (aspect oriented programming) <p>I am trying to use ContextBoundObject and message sinks to inject some aspects into my code.</p>

<p>My problem is that my aspect is being called only once - 
    when I make the call: myFacadee.GetValue("Tie")
    I would expect to see my caching aspect be called twice</p>

<ol>
<li>Once for the 'GetValue' method</li>
<li>Secondly for the 'GetValues' which is called internally in the
'GetValue' method</li>
</ol>

<p>However, it's being called only once for the first 'GetValue' method call.</p>

<p><em>How can change/fix the following code to make sure that all the methods on my 'MyFacade' object cause the caching aspect to be invoked. Even if they are being called by other methods in the same 'MyFacde' objec?</em></p>

<p>Here is a simplified example of what my code looks like:</p>

<p><strong>Test Application:</strong></p>

<pre><code>class Program
{
    static void Main(string[] args)
    {
        var myFacadee = new MyFacade();

        System.Console.WriteLine("Value:\t" + myFacadee.GetValue("Tie"));

        System.Console.ReadLine();
    }
}
</code></pre>

<p><strong>Facade:</strong></p>

<pre><code>[Cache]
public class MyFacade : ContextBoundObject
{
    public string GetValue(string name)
    {
        return GetValues().FirstOrDefault(x =&gt; x.EndsWith(name));
    }

    public List&lt;string&gt; GetValues()
    {
        return new List&lt;string&gt;
                   {
                       "You asked for a Shirt",
                       "You asked for a Pants",
                       "You asked for a Tie"
                   };
    }
}
</code></pre>

<p><strong>CacheAttribute:</strong></p>

<pre><code>[AttributeUsage(AttributeTargets.Class)]
public class CacheAttribute : ContextAttribute
{
    public CacheAttribute() : base("Security") { }

    public override void GetPropertiesForNewContext(IConstructionCallMessage ctorMsg)
    {
        ctorMsg.ContextProperties.Add(new CacheProperty());
    }
}
</code></pre>

<p><strong>CacheProperty:</strong></p>

<pre><code>public class CacheProperty : IContextProperty, IContributeObjectSink
{
    public IMessageSink GetObjectSink(MarshalByRefObject o, IMessageSink next)
    {
        return new CacheAspect(next);
    }

    public void Freeze(Context newContext)
    {
        // no op
    }

    public bool IsNewContextOK(Context ctx)
    {
        var newContextLogProperty = ctx.GetProperty("CacheProperty") as CacheProperty;
        if (newContextLogProperty == null)
        {
            Debug.Assert(false);
            return false;
        }
        return (true);
    }

    public string Name { get { return "CacheProperty"; } }
}
</code></pre>

<p><strong>CacheAspect:</strong></p>

<pre><code>internal class CacheAspect : IMessageSink
{
    internal CacheAspect(IMessageSink next)
    {
        _next = next;
    }

    private readonly IMessageSink _next;

    public IMessageSink NextSink
    {
        get { return _next; }
    }

    public IMessage SyncProcessMessage(IMessage msg)
    {
        Preprocess(msg);

        var returnMethod = _next.SyncProcessMessage(msg);

        return returnMethod;
    }

    public IMessageCtrl AsyncProcessMessage(IMessage msg, IMessageSink replySink)
    {
        throw new InvalidOperationException();
    }

    private void Preprocess(IMessage msg)
    {
        // We only want to process method calls
        if (!(msg is IMethodMessage)) return;

        var call = msg as IMethodMessage;
        var type = Type.GetType(call.TypeName);
        var callStr = type.Name + "." + call.MethodName;

        var argsString = call.Args.Aggregate((current, next) =&gt; current + ", " + next);

        Console.WriteLine("Try to get value form cache : {0} for {1}({2})", callStr, call.MethodName, argsString);
    }
}
</code></pre>
 Generating methods in design or in build time (C#) <p>I have an integration testing solution. I have my tests described in XML files. In order to capitalize on Visual Studio 2010 testing infrastructure, I have a C# class where every XML test file has an associated method that loads the XML file and executes its content. It looks like this:</p>

<pre><code>[TestClass]
public class SampleTests
{

    [TestMethod]
    public void Test1()
    {
        XamlTestManager.ConductTest();
    }

    [TestMethod]
    public void Test2()
    {
        XamlTestManager.ConductTest();
    }

    ...

    [TestMethod]
    public void TestN()
    {
        XamlTestManager.ConductTest();
    }
}
</code></pre>

<p>Each method name corresponds to an XML file name. Hence, I have to have the following files in my test directory:</p>

<ul>
<li>Test1.xml</li>
<li>Test2.xml</li>
<li>...</li>
<li>TestN.xml</li>
</ul>

<p><code>XamlTestManager.ConductTest()</code> uses the StackTrace class to get the name of the calling method and this way it can find the correct XML test file to load.  </p>

<p>I would like to get rid of the extra administration of adding/removing/renaming test methods whenever I change my tests, adding/removing/renaming an XML test file. <strong>How can I automagically generate this class or its methods during the compilation process based on the actual XML files in my test directory?</strong></p>

<p>Option 1:
I have considered PostSharp, but it does not allow me to look up the XML files and generate methods on the fly (or was I superficial?).<br>
Option 2:
The other idea was to build a Visual Studio custom tool that generates my code whenever it is executed. The downside here is the deployment. The custom tool needs to be registered to VS. I want a solution that can be committed into a repository, check it out to another computer and use it right away.
<em>(I believe in simplicity. "Check out and run" just simplifies the life of new developers soooooo much, if they do not need to go through a list of thing to install before they can compile run the application.)</em></p>

<p>Do you have any recommendation, how to get rid of the unnecessary maintenance issue?</p>

<p><strong>EDIT:</strong><br>
For the request of Justin, I add more details. We use <a href="http://bizunit.codeplex.com/" rel="nofollow">Bizunit</a> (fantastic!!!) as the basis of our framework with a truckload of custom made high level test steps. From these steps we can build our test like from lego blocks in a declarative manner. Our steps include like FileDrop, WebService invokation or even polling, firing up a full blown web server to simulate a partner web application, random data generator, data comparing steps etc. Here is an example test xml (in fact XAML):</p>

<pre><code>&lt;TestCase BizUnitVersion="4.0.154.0" Name="StackOverflowSample" xmlns="clr-namespace:BizUnit.Xaml;assembly=BizUnit" xmlns:nib="clr-namespace:MyCompany.IntegrationTest;assembly=BizUnit.MyCustomSteps" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"&gt;
  &lt;TestCase.SetupSteps&gt;
    &lt;nib:ClearStep FailOnError="True" RunConcurrently="False" /&gt;
    &lt;nib:LaunchSimulatedApp AppKernelCacheKey="provider" FailOnError="True" FireWakeUpCall="False" PortNumber="4000" RepresentedSystem="MyProviderService" RunConcurrently="False" /&gt;
    &lt;nib:HttpGetStep FailOnError="True" RunConcurrently="False" Url="http://localhost:10000/Home/StartSvgPolling"&gt;
      &lt;nib:HttpGetStep.Parameters&gt;
        &lt;x:String x:Key="PolledAddress"&gt;http://localhost:4000/SvgOutputPort.asmx&lt;/x:String&gt;
        &lt;x:String x:Key="PollingInterval"&gt;10&lt;/x:String&gt;
        &lt;x:String x:Key="FilterFile"&gt;&lt;/x:String&gt;
      &lt;/nib:HttpGetStep.Parameters&gt;
    &lt;/nib:HttpGetStep&gt;
  &lt;/TestCase.SetupSteps&gt;

  &lt;TestCase.ExecutionSteps&gt;
    &lt;nib:DocumentMergeStep FailOnError="True" OutputCacheKey="inputDocument" RunConcurrently="False"&gt;
      &lt;nib:DocumentMergeStep.InputDocuments&gt;
        &lt;nib:RandomLoader BoundingBox="Europe" LinkbackUrlPattern="http://MyProviderService/id={0}" MaxAmount="10" MaxID="100" MinAmount="10" MinID="0" NamePattern="EuropeanObject_{0}" NativeFormat="Svg" RepeatableRandomness="False" UriPrefix="European" /&gt;
        &lt;nib:RandomLoader BoundingBox="PacificIslands" LinkbackUrlPattern="http://MyProviderService/id={0}" MaxAmount="10" MaxID="100" MinAmount="10" MinID="0" NamePattern="PacificObject_{0}" NativeFormat="Svg" RepeatableRandomness="False" UriPrefix="Pacific" /&gt;
      &lt;/nib:DocumentMergeStep.InputDocuments&gt;
    &lt;/nib:DocumentMergeStep&gt;
    &lt;nib:PushToSimulatedApp AppKernelCacheKey="provider" ContentFormat="Svg" FailOnError="True" RunConcurrently="False"&gt;
      &lt;nib:PushToSimulatedApp.InputDocument&gt;
        &lt;nib:CacheLoader SourceCacheKey="inputDocument" /&gt;
      &lt;/nib:PushToSimulatedApp.InputDocument&gt;
    &lt;/nib:PushToSimulatedApp&gt;
    &lt;nib:GeoFilterStep FailOnError="True" OutputCacheKey="filteredDocument" RunConcurrently="False" SelectionBox="Europe"&gt;
      &lt;nib:GeoFilterStep.InputDocument&gt;
        &lt;nib:CacheLoader SourceCacheKey="inputDocument" /&gt;
      &lt;/nib:GeoFilterStep.InputDocument&gt;
    &lt;/nib:GeoFilterStep&gt;
    &lt;nib:DeepCompareStep DepthOfComparision="ID, Geo_2MeterAccuracy, PropertyBag, LinkbackUrl" FailOnError="True" RunConcurrently="False" Timeout="30000" TolerateAdditionalItems="False"&gt;
      &lt;nib:DeepCompareStep.ReferenceSource&gt;
        &lt;nib:CacheLoader SourceCacheKey="filteredDocument" /&gt;
      &lt;/nib:DeepCompareStep.ReferenceSource&gt;
      &lt;nib:DeepCompareStep.InvestigatedSource&gt;
        &lt;nib:SvgWebServiceLoader GeoFilter="Europe" NvgServiceUrl="http://localhost:10000/SvgOutputPort.asmx"/&gt;
      &lt;/nib:DeepCompareStep.InvestigatedSource&gt;
    &lt;/nib:DeepCompareStep&gt;
  &lt;/TestCase.ExecutionSteps&gt;

  &lt;TestCase.CleanupSteps&gt;
    &lt;nib:HttpGetStep FailOnError="True" RunConcurrently="False" Url="http://localhost:10000/Home/StopSvgPolling"&gt;
      &lt;nib:HttpGetStep.Parameters&gt;
        &lt;x:String x:Key="PolledAddress"&gt;http://localhost:4000/SvgOutputPort.asmx&lt;/x:String&gt;
      &lt;/nib:HttpGetStep.Parameters&gt;
    &lt;/nib:HttpGetStep&gt;
    &lt;nib:KillSimulatedApp AppKernelCacheKey="provider" FailOnError="True" PortNumber="4000" RunConcurrently="False" /&gt;
  &lt;/TestCase.CleanupSteps&gt;
&lt;/TestCase&gt;
</code></pre>

<p>This is what it does:  </p>

<ol>
<li>Invokes a Clear operation on the test subject</li>
<li>Launches a webserver on port 4000 as a simulated partner app under the name MyProviderService</li>
<li>Invokes the test subject via HTTP Get to poll the simulated partner</li>
<li>Creates a new document containing geo info from two random generated content</li>
<li>Pushes the document to the simulated partner - hence the test subject will pick it up via polling</li>
<li>The test applies a geo filter on the document</li>
<li>The deep compare step loads the filtered document as base of comparision, and loads the content of the test subject via a web service</li>
<li>As clean-up, it stops the polling via an HTTP GET step and kills the simulated partner's web server.</li>
</ol>

<p>The power of Bizunit is that merges the ease of creating tests in C# with intellisense and ease of maintaining/duplicating it in XAML files. For a quick easy read on how it works: <a href="http://kevinsmi.wordpress.com/2011/03/22/bizunit-4-0-overview/" rel="nofollow">http://kevinsmi.wordpress.com/2011/03/22/bizunit-4-0-overview/</a></p>
 AspectJ staticinitalization <p>i'm successfully intercepting the static initialization of classes with @MyAnnotation with this code:</p>

<pre><code>public aspect SomeAspect {
    pointcut printClassName() : staticinitialization(@MyAnnotation *);
    after() : printClassName() {
        System.out.println(getClass().getName());        
    }
}
</code></pre>

<p>The question is: how do i get the name of the loaded class? In the code above what's printed is the name of the aspect class, not the name of the loaded class.</p>

<p>Thanks,
Teo</p>
 AO Compiler: weaving process <p>I'm doing a presentation about Aspect Oriented Software Development. One of my subtopics is "AO Compiler: weaving process".<br />
I found nothing about it on the internet. Does anybody have some information about this Compiler? I really don't know what to write about it.<br />(I don't want you to do my work, I just need some help at the beginning!)<br /><br /></p>

<p>Here is a similiar question: <a href="http://stackoverflow.com/questions/8066327/aspectj-weaving">AspectJ Weaving</a>, but unfortunalety it doesn't have any answers yet.</p>
 Aspect-Oriented Programming Weakness? <p>Is there any major weakness for aspect-oriented programming? I like the idea of alleviating crosscutting concerns by limiting the calls towards one class inside its aspect. But to me, it is a little bit weird. </p>

<p>Question 1. Let's take the Logger class example. Every class/method may need to call some method of the Logger class. Writing all those calls inside the Logger aspect makes future modification easy. However, who should maintain the Logger's aspect? If the developer of the Logger class does this, he/she needs to have a global view of the whole project, which I think is kind of impossible if the project is large enough. On the other hand, if we allow everybody to modify the Logger's class, there will be too many people accessing the same piece of code. And if any of them makes a mistake, the code will fail. So, in general, who should maintain the aspects?</p>

<p>Question 2. Will the performance be a problem? I think one pointcut is like registering one event listener. If there are too many pointcut during runtime, will it slow down the program?</p>

<p>Thanks,</p>
 Afterthought seems not working, simple code <p>I wrote simple piece of code to get involved into Afterthought, but it doesn't work and I've got no idea why. A huge part of it is taken from other SO question: <a href="http://stackoverflow.com/questions/9944702/how-to-implement-simple-property-ammendment-with-afterthought">How to implement simple Property Ammendment with Afterthought</a>.</p>

<pre><code>using System;
using System.Collections.Generic;
using Afterthought;
namespace SecondAmendmentTest
{
    class Program
    {
        public class TestUser
        {
            public int Id { get; set; }
            public string FirstName { get; set; }
            public string LastName { get; set; }
            public bool HasChanged { get; set; }
            public void method()
            {
                Console.WriteLine("method");
            }
        }

        public class TestUserAmmendment&lt;T&gt; : Amendment&lt;T, T&gt; where T : TestUser
        {
            public TestUserAmmendment()
            {
                Properties
                    .AfterSet((instance, x, y, z, a) =&gt; instance.HasChanged = true);
                Methods.After(ExceptionMethod);
            }

            private object ExceptionMethod(T instance, string method, object[] parameters, object result)
            {
                throw new NotImplementedException();
            }
        }

        static void Main(string[] args)
        {
            TestUser tu = new TestUser();
            Console.WriteLine("Has changed: " + tu.HasChanged.ToString());
            Console.WriteLine("Performing changes...");
            tu.Id = 5;
            tu.FirstName = "name";
            tu.LastName = "lastname";
            Console.WriteLine("Has changed: " + tu.HasChanged.ToString());
            tu.method();
            Console.ReadKey();
        }
    }
}
</code></pre>

<p>It compiles, but no changes are made into output exe file. I've configured post build event. Build output:</p>

<pre><code>1&gt;------ Rebuild All started: Project: SecondAmendmentTest, Configuration: Debug Any CPU ------
1&gt;  SecondAmendmentTest -&gt; C:\Users\Lukasz\Documents\Visual Studio 11\Projects\SecondAmendmentTest\SecondAmendmentTest\bin\Debug\SecondAmendmentTest.exe
1&gt;  Amending SecondAmendmentTest.exe (5,559 seconds)
========== Rebuild All: 1 succeeded, 0 failed, 0 skipped ==========
</code></pre>

<p>And finally output from application after running:</p>

<pre><code>C:\Users\Lukasz\Documents\Visual Studio 11\Projects\SecondAmendmentTest\SecondAmendmentTest\bin\Debug&gt;SecondAmendmentTest.exe
Has changed: False
Performing changes...
Has changed: False
method
</code></pre>

<p>Neither HasChanged property were modified nor NotImplementedException was thrown. I'm using last sources from Git. Have you some ideas why it doesn't work? </p>

<p>EDIT: Here is entire solution: <a href="http://dl.dropbox.com/u/1014611/SecondAmendmentTest.zip" rel="nofollow">SecondAmendmentTest.zip</a></p>
 Is there a way to use PostSharp to make constructor parameters visible at the class level? <p>Say I have a lot of boilerplate code like this:</p>

<pre><code>class MyClass
{
    private readonly IDependencyA dependencyA;
    private readonly IDependencyB dependencyB;

    public MyClass(
        IDependencyA dependencyA,
        IDependencyB dependencyB)
    {
        if(dependencyA == null) throw ArgumentNullException("dependencyA");
        if(dependencyB == null) throw ArgumentNullException("dependencyB");
        this.dependencyA = dependencyA;
        this.dependencyB = dependencyB;

        ...
    }

    ...

    public void SomeMethod()
    {
        this.dependencyA.DoSomething(this.dependencyB);
    }
}
</code></pre>

<p>Is there a way to use something like PostSharp to remove the boilerplate code and make it look like this:</p>

<pre><code>class MyClass
{
    [ConstructorParametersAreClassMembers]
    public MyClass(
        IDependencyA dependencyA,
        IDependencyB dependencyB)
    {
        ...
    }

    ...

    public void SomeMethod()
    {
        this.dependencyA.DoSomething(this.dependencyB);
    }
}
</code></pre>

<p>Is that even possible?</p>

<p>Aside: this is actually the way it works by default in F#.</p>
 WCF service attribute to log method calls and exceptions <p>I have a requirement to log each method call in a WCF service, and any exceptions thrown.  This has led to a lot of redundant code, because each method needs to include boilerplate similar to this:</p>

<pre><code>[OperationContract]
public ResultBase&lt;int&gt; Add(int x, int y)
{
    var parameters = new object[] { x, y }
    MyInfrastructure.LogStart("Add", parameters);
    try
    {
        // actual method body goes here
    }
    catch (Exception ex)
    {
        MyInfrastructure.LogError("Add", parameters, ex);
        return new ResultBase&lt;int&gt;("Oops, the request failed", ex);
    }
    MyInfrastructure.LogEnd("Add", parameters);
}
</code></pre>

<p>Is there a way I can encapsulate all this logic into an attribute <code>MyServiceLoggingBehaviorAttribute</code>, which I could apply to the service class (or methods) like this:</p>

<pre><code>[ServiceContract]
[MyServiceLoggingBehavior]
public class MyService
{
}
</code></pre>

<hr/>

<p><strong>Note #1</strong> </p>

<p>I realize that this can be done using <a href="http://stackoverflow.com/questions/4133569/how-to-log-method-calls-on-targets-marked-with-an-attribute">Aspect-oriented programming</a>, but in C# the only way to do this is to modify bytecode, which requires the use of a third-party product like PostSharp.  I would like to avoid using commercial libraries.</p>

<p><strong>Note #2</strong></p>

<p>Note that Silverlight applications are the primary consumers of the service.</p>

<p><strong>Note #3</strong></p>

<p><a href="http://stackoverflow.com/questions/1178256/log-wcf-service-calls-with-parameter-information">WCF trace logging</a> is a good option in some cases, but it doesn't work here because, as noted above, I need to inspect, and in the case of an exception change, the return value.</p>
 How to intercept method call of a class <p>Is there anyway to intercept method call of a class so you can do AOP? </p>

<p>e.g.</p>

<p>I want the Teacher.Talk() performs differently in two scenarios:</p>

<pre><code>class School
{
    [Fun]
    public void Picnic {
        Teacher t = new Teacher();
        t.Talk();
    }

    public void Seminar{
        Teacher t = new Teacher();
        t.Talk();
    }
}
</code></pre>

<p>In above code, the function Picnic is decorated by Fun attribute, so the Talk function of the teacher is much more interesting than the one in Seminar function which is not decorated by the attribute.</p>

<p>I've checked Castle.DynamicProxy, but it uses proxy class and need some code modification. That doesn't help to solve my problem because I want to use the attribute to do the configuration, so that when the decision changes, very few code modifications will be needed.</p>

<p>Thanks a lot in advance!</p>
 What are best practices for AOP development? <p>I'm looking for best practices guidelines for developers seeking to learn AOP.</p>

<p>Anything from actual coding techniques to IDE suggestions would be a big help here.</p>

<p>UPDATE: In particular, I'm interested in techniques and guidelines for AOP in C#, Java and Ruby.</p>
 Need help creating a specific pointcut inside of a method <p>I started with an original question on
<a href="http://stackoverflow.com/questions/4759803/need-help-creating-a-specific-pointcut-that-utilizes-a-value-from-a-method-annota">Need help creating a specific pointcut that utilizes a value from a method annotation.</a></p>

<p>I decided I wanted to ask another question to change the approach I was taking.
I have a method (<em>navigation</em>), that has a call inside of that method to another method which I would like to have @Around advice.</p>

<pre><code>@RequestMapping(method = RequestMethod.GET)
public String navigation(ModelMap model) {
    ...        
            // Call Auto Handling
            logger.info("Call AutoHandling");
            this.processAutoHandling(callSession, FunctionalArea.PRE_MAIN_MENU);
        }
        ...

    return forward(returnView);
}
</code></pre>

<p>Is this possible as I cannot seem to get this to work if the method is inside of the same class.</p>

<p>This work if it was not on the object itself:</p>

<pre><code>@Around("execution(* *.processAutoHandling(..)) &amp;&amp;" +
        "args(callSession, functionalArea) &amp;&amp; " +
        "args(functionalArea) &amp;&amp; " +
        "target(bean)"
)
public Object processAutoHandlingCall2(ProceedingJoinPoint jp,
                                      CallSession callSession,
                                      FunctionalArea functionalArea,
                                      Object bean)
        throws Throwable {
    logger.debug("processAutoHandleCall");
    return jp.proceed();
}
</code></pre>

<p>With this call in my controller:</p>

<pre><code>autoHandlingComponent.processAutoHandling(callSession, FunctionalArea.PRE_MAIN_MENU);
</code></pre>

<p>instead of</p>

<pre><code>this.processAutoHandling(callSession, FunctionalArea.PRE_MAIN_MENU);
</code></pre>
 Aspect Oriented Programming in Ruby <p>What frameworks exist to add AOP to Ruby?  </p>
 AOP Separating Cross-cutting Concerns <p>I'm trying to start taking advantage of Aspect-Oriented programming for repetitive tasks.  I'm not sure how to go about separating concerns.  I'm using C# and for AOP I'm using Castle.DynamicProxy (using Autofac's InterceptedBy feature), but I'm hoping an answer to this question can be general enough advice to apply to other AOP solutions as well (maybe you can convince me to switch to a different AOP solution).</p>

<p>For example, I have something like the following interceptor that intercepts all method calls to a class.  It currently has two concerns: when a method is called, (1) measure how long the call took, and (2) log the name of the method before and after it is called.</p>



<pre class="lang-cs prettyprint-override"><code>public class TimeLoggingInterceptor : IInterceptor
{
    private ILog m_Log;
    public TimeLoggingInterceptor(ILog log)
    {
        m_Log = log;
    }
    public void Intercept(IInvocation invocation)
    {
        // Logging concerns
        string fullMethodName = invocation.TargetType.Name + "." + invocation.MethodInvocationTarget.Name;
        m_Log.Debug(fullMethodName + " started.");

        // Timing concerns
        DateTime beforeStamp = DateTime.UtcNow;

        // Call method
        invocation.Proceed();

        // Timing concerns
        DateTime afterStamp = DateTime.UtcNow;
        TimeSpan callTime = afterStamp - beforeStamp;

        // Logging concerns
        m_Log.Debug(fullMethodName + " finished. Took " + callTime.TotalMilliseconds + "ms.");
    }
}
</code></pre>

<p>I have an overwhelming feeling that the timing concerns here (measuring how long the method call took) should be separated from the logging concerns (writing to the log file) because...well, they're separate concerns.  I'm thinking of doing something like this, but I'm not sure how to approach ordering or where to put the <strong>callTime</strong> variable:</p>



<pre class="lang-cs prettyprint-override"><code>public class TimingInterceptor : IInterceptor
{
    private static ThreadLocal&lt;TimeSpan&gt; callTime = new ThreadLocal&lt;TimeSpan&gt;();
    public static TimeSpan CallTime
    {
        get
        {
            if (!callTime.IsValueCreated) throw new InvalidOperationException("callTime was never set");
            return callTime.Value;
        }
    }

    public void Intercept(IInvocation invocation)
    {
        // Timing concerns
        DateTime beforeStamp = DateTime.UtcNow;

        // Call method
        invocation.Proceed();

        // Timing concerns
        DateTime afterStamp = DateTime.UtcNow;
        callTime.Value = afterStamp - beforeStamp;
    }
}
public class LoggingInterceptor : IInterceptor
{
    private ILog m_Log;
    public LoggingInterceptor(ILog log)
    {
        m_Log = log;
    }

    public void Intercept(IInvocation invocation)
    {
        // Logging concerns
        string fullMethodName = invocation.TargetType.Name + "." + invocation.MethodInvocationTarget.Name;
        m_Log.Debug(fullMethodName + " started.");

        // Call method
        invocation.Proceed();

        // Logging concerns
        m_Log.Debug(fullMethodName + " finished. Took " + TimingInterceptor.CallTime.TotalMilliseconds + "ms.");
    }
}
</code></pre>

<p>Basically what I'm thinking needs to happen here is that, somehow, <strong>TimingInterceptor</strong> needs to directly intercept the methods, and then <strong>LoggingInterceptor</strong> needs to wrap around that.  </p>

<p>What approaches do people use to make sure these concerns will happen in the correct order?  Do I chain the interceptors, having LoggingInterceptor intercept TimingInterceptor's Intercept method? Or do I put some kind of <code>[InterceptOrder(1|2|3|...)]</code> attribute on the interceptor classes? Or can I put something like <code>[InterceptAfter(typeof(TimingInterceptor))]</code> on LoggingInterceptor?</p>

<p>And is there a better alternative to using a thread-local variable to keep track of the call time? <em>Yes, I'd like this to be thread safe</em>. I'm thinking keeping this variable on the stack might be preferred, but I'm not sure how LoggingInterceptor could get a handle to TimingInterceptor without introducing too much coupling (would be nice to be able to switch out the TimingInterceptor implementation without recompiling LoggingInterceptor).</p>
 What is the best way to have interceptors for POJO? <p>EJB 3.0 comes with the concept of Interceptors, but then again they are applicable to EJBs only. My project requires developing Interceptors for POJO classes. One option for this is to use Spring AOP. I want to know if it's worth the overhead of including the libraries such as commons-logging, spring-aop, cglib that are required for Spring AOP.</p>
 Aspect Oriented C (not C++) in Production Code <p>This is a question further derived from a previous one: <a href="http://stackoverflow.com/questions/1834485/aspect-oriented-programming-aop-in-c-not-c-anyone-doing-it">Aspect Oriented Programming (AOP) in C NOT C++ — anyone doing it?</a></p>

<p>The answers to that question point us to some research practices at queens university here: 
<a href="http://sailhome.cs.queensu.ca/~bram/aspicere/index.html" rel="nofollow">http://sailhome.cs.queensu.ca/~bram/aspicere/index.html</a>. </p>

<p>Beyond that research effort, does anyone know of real world usage of Aspect Oriented C in production code? If no, where do you think the difficulty is? If yes, what's the hurdle that makes it unpopular yet? </p>

<p>I think the benefit of AOP is obvious. But after AOP-Java becoming popular for a decade, AOP-C is still almost non-existent, there must be some reason. What's your insight on this? </p>
 C#: how to implement as "async" and "!" in F#? <p>Reading F# recently, it turns out to me that "async" and "!" (Bang! :p) are quite useful features. (Off topic, this is an example that programming language is not only an academic research topic, but a real-life, productivity design topic).</p>

<p>Below is from Luca Bolognese's PDC 2008 presentation:</p>

<pre><code>let internal loadPrices ticker = async {
    let url = "http://ichart.finance.yahoo.com/table.csv?s=" + ticker + "&amp;d=9&amp;e=30&amp;f=2008&amp;g=d&amp;a=2&amp;b=13&amp;c=1986&amp;ignore=.csv"
    let req = WebRequest.Create(url)
    let! resp = req.AsyncGetResponse() //athos: need F# Powerpack

    let stream = resp.GetResponseStream()
    let reader = new StreamReader(stream)
    let! csv = reader.AsyncReadToEnd()

    let prices =
        csv.Split([|'\n'|])
        |&gt; Seq.skip 1
        |&gt; Seq.map (fun line -&gt; line.Split([|','|]))
        |&gt; Seq.filter (fun values -&gt; values |&gt; Seq.length = 7)
        |&gt; Seq.map (fun values -&gt;
        System.DateTime.Parse(values.[0]),
        float values.[6])    

    return prices }
</code></pre>

<p>The charming part is, callback is handled gracefully: Programmers don't need to take care of BackgroundWorker or Theads' Join().</p>

<p>So, in C#, is there a graceful solution, to implement F# "aync" and "!" features?
For example, is it possible to do an "async...run...callback" as below or in a similar effortless way?</p>

<pre><code>public void GetApplicationSettings()
{ 
    async(objAsyncRunner = new System.Async.Runner() ) //similar to "using" in C#
    run // similar to "if" in C#
    {
        string url = "http://ichart.finance.yahoo.com/table.csv?s=" + ticker + "&amp;d=9&amp;e=30&amp;f=2008&amp;g=d&amp;a=2&amp;b=13&amp;c=1986&amp;ignore=.csv"
        var req = WebRequest.Create(url);
        var resp = req.AsyncGetResponse();
    }
    callback run // similar to "if else" in C#
    {
        var stream = resp.GetResponseStream();
        var reader = new StreamReader(stream);
        var csv = reader.AsyncReadToEnd();
    }
    callback // similar to "else" in C#
    {
        var prices = csv.Split('\n').....;
    }
}
</code></pre>

<p>ps. I know some you guys will say: athos, just use F#!
yeah... i'm not against F# but it needs time to change the whole department, before that i hope to borrow some merits from F#.</p>

<p>I know there are some Aspect programming concept to extend C# feature. However it still has not reached F# level.</p>

<p>For example, I can extend PostSharp from <a href="http://www.sharpcrafters.com" rel="nofollow">http://www.sharpcrafters.com</a> , so that by simple assigning an attribute to a method, to force it run in a dedicated thread asynchronously:</p>

<pre><code>[RunInADedicatedThread(Async = true)]
public void GetApplicationSettings()
{ ... }
</code></pre>

<p>provided the attribute is prepared:</p>

<pre><code>[Serializable]
[AttributeUsage( AttributeTargets.Method | AttributeTargets.Class )]
[MulticastAttributeUsage( MulticastTargets.Method )]
public sealed class RunInADedicatedThreadAttribute : MethodInterceptionAspect
// MethodInterceptionAspect is extending PostSharp
{
    public bool Async { get; set; }

    public override void OnInvoke( MethodInterceptionArgs args )
    {
        if (Async)
        {
            //MyThreadPool is my extention for PostSharp 
            MyThreadPool.GetThread().ExecuteAsync(
                () =&gt;
                    {
                        args.Proceed();
                    } );
            return;
        }
        MyThreadPool.GetThread().Execute( args.Proceed );
    }
}
</code></pre>

<p>This helps a bit, but it's still not F# level: </p>

<blockquote>
  <ul>
  <li>the "run in a dedicated thread, asynchronously" requests are not defined on the calling, but on the method GetApplicationSettings() itself! This method might as well be renamed to GetApplicationSettingsAsynchronously(), isn't it;</li>
  <li>also, this can't help the callback part;</li>
  <li>let alone the F# "async" feature to use less threads ... i can even drop this "advaced" feature for now...</li>
  </ul>
</blockquote>
 how to apply a Postsharp aspect solution wide (all classes in namespace) <p>I am trying to modify the sample trace app that ships with Postsharp so that the trace is applied to all classes in my namespace without explicitly putting the [QuickTrace] on top of each class. I have attached a screenshot. What am I doing wrong ? Right click open/view image for bigger picture. thank you</p>

<p><img src="http://i.stack.imgur.com/NZgHf.gif" alt="enter image description here"></p>
 C# and C/C++ integration for profiling <p>I am trying to do some profiles on some applications regarding low-level efficiency in OO 
frameworks, namely, instruction counts, cache-miss, TLB misses, and things of the sort. So far I was able to do these kind of measurements in Java mixing the <a href="http://icl.cs.utk.edu/papi/" rel="nofollow">Papi profiler</a> instrumentations with JNI and AspectJ to get the desired info.</p>

<p>I was wondering if anyone knows about something similar in C#, i.e., mixing C#, aspect oriented programming (AoP) and some kind calling interfaces between C and C#.</p>

<p>I've been googling and found there already is an AoP related framework for C# called AspectSharp, however it seems a bit complicated to configure and use it in Mono (which is what I use for C#).</p>

<p>So in conclusion I'm asking for help in</p>

<ul>
<li>AspectSharp</li>
<li>C/C++ &lt;=> C# interfaces (?)</li>
</ul>

<p>Thanks in advance</p>
 Handle with exception on auto proxy / proxy factory object <p>I start learning Spring.NET framework and I am very confusing with behavior of proxy, auto-proxy and exception handling.</p>

<p>for example I defined simple business object and from this object  I will throw custom exception.</p>

<pre class="lang-c# prettyprint-override"><code>namespace Aspect.Managers
{
    public interface IDbCustomerManager
    {
        Customer GetCustomerById(long id);
    }

    public class DbCustomerManager:IDbCustomerManager
    {

        public Customer GetCustomerById(long id)
        {
            throw new DbException(string.Format("Problem load customer with Id: {0}",id));
        }

    }
}
</code></pre>

<p>Second I defined Advice for handling with exception.</p>

<pre class="lang-c# prettyprint-override"><code>public class LogExThrowsAdvice:IThrowsAdvice
{
    public void AfterThrowing(MethodInfo method, Object[] args,
            Object target, DbException exception)
    {
        Console.WriteLine(exception.Message);

    }
}
</code></pre>

<p>And last I join togheter business object and advice with proxy.</p>

<p>In app.confing</p>

<p><strong>Advice:</strong></p>

<pre class="lang-xml prettyprint-override"><code>  &lt;object id="theLogExThrowsAdvice"
          type="Aspect.LogExThrowsAdvice, Log4NetInSpringNet"/&gt;
</code></pre>

<p><strong>Auto-Proxy</strong></p>

<pre class="lang-xml prettyprint-override"><code>  &lt;object id="theProxyCreator"
          type="Spring.Aop.Framework.AutoProxy.TypeNameAutoProxyCreator, Spring.Aop"&gt;
    &lt;property name="TypeNames" value="Aspect.Managers.DbCustomerManager*"/&gt;
    &lt;property name="InterceptorNames"&gt;
      &lt;list&gt;
        &lt;value&gt;theLogExThrowsAdvice&lt;/value&gt;
      &lt;/list&gt;
    &lt;/property&gt;
  &lt;/object&gt;
</code></pre>

<p>And test it:</p>

<pre class="lang-c# prettyprint-override"><code>            var springContext = ContextRegistry.GetContext();
            var dbMgr = (IDbCustomerManager)springContext["theDbCustomerManager"];
            dbMgr.GetCustomerById(1);
</code></pre>

<p>Exception is throwed, method AfterThrowing from LogExThrowsAdvice is not calling.</p>

<p>I try changed type of advice for type BeforeAdvice.</p>

<pre class="lang-c# prettyprint-override"><code> public class DbAccessAdvice:IMethodBeforeAdvice
{
    #region Implementation of IMethodBeforeAdvice

    public void Before(MethodInfo method, object[] args, object target)
    {
        Console.WriteLine("You try access to DB");
    }

    #endregion
}
</code></pre>

<p>and in app.config:</p>

<pre class="lang-xml prettyprint-override"><code>  &lt;object id="theDbAccessAdvice"
          type="Aspect.DbAccessAdvice, Log4NetInSpringNet"/&gt;


  &lt;object id="theProxyCreator"
          type="Spring.Aop.Framework.AutoProxy.TypeNameAutoProxyCreator, Spring.Aop"&gt;
    &lt;property name="TypeNames" value="Aspect.Managers.DbCustomerManager*"/&gt;
    &lt;property name="InterceptorNames"&gt;
      &lt;list&gt;
        &lt;value&gt;theDbAccessAdvice&lt;/value&gt;
        &lt;value&gt;theLogExThrowsAdvice&lt;/value&gt;
      &lt;/list&gt;
    &lt;/property&gt;
  &lt;/object&gt;
</code></pre>

<p>BeforeAdvice is fire but ThrowsAdvice no. Why?</p>

<p>I tried change auto proxy for proxy object factory and tried proxying interfaces IDbCustomerManager.</p>

<pre class="lang-xml prettyprint-override"><code>  &lt;object id="theProxy"
          type="Spring.Aop.Framework.ProxyFactoryObject, Spring.Aop"&gt;
    &lt;property name="ProxyInterfaces" value="Aspect.Managers.IDbCustomerManager"/&gt;
    &lt;property name="Target"&gt;
      &lt;object type="Aspect.Managers.DbCustomerManager"&gt;
      &lt;/object&gt;
    &lt;/property&gt;
    &lt;property name="InterceptorNames"&gt;
      &lt;list&gt;
        &lt;value&gt;theDbAccessAdvice&lt;/value&gt;
        &lt;value&gt;theLogAdvice&lt;/value&gt;
      &lt;/list&gt;
    &lt;/property&gt;
  &lt;/object&gt;
</code></pre>

<pre class="lang-c# prettyprint-override"><code>  var springContext = ContextRegistry.GetContext();
  var dbMgr = (IDbCustomerManager)springContext["theProxy"];
  dbMgr.GetCustomerById(1);
</code></pre>

<p>Before advice  is fired but throws advice are not? why? Only exception is throwed.</p>

<p>For me is magic how it really work.</p>

<p>I tried used Advisors instead advices:</p>

<pre class="lang-xml prettyprint-override"><code>  &lt;!--Advisor--&gt;
  &lt;object id="theDbAccessAdvisor"
          type="Spring.Aop.Support.RegularExpressionMethodPointcutAdvisor, Spring.Aop"&gt;
    &lt;property name="Pattern" value="Aspect*"/&gt;
    &lt;property name="Advice"  ref="theDbAccessAdvice"/&gt;
  &lt;/object&gt;

  &lt;object id="theLogAdvisor"
    type="Spring.Aop.Support.RegularExpressionMethodPointcutAdvisor, Spring.Aop"&gt;
    &lt;property name="Pattern" value="Aspect*"/&gt;
    &lt;property name="Advice"  ref="theLogAdvice"/&gt;
  &lt;/object&gt;
</code></pre>

<p>But same result before advice is fired but throws advice not.</p>

<p>I tried use also ExceptionHandleAdvice aspect from Spring.NET same exception is throwed but advice not.</p>

<pre class="lang-xml prettyprint-override"><code> &lt;object id="exAdvice"
          type="Spring.Aspects.Exceptions.ExceptionHandlerAdvice, Spring.Aop"&gt;
    &lt;property name="ExceptionHandlers"&gt;
      &lt;list&gt;
        &lt;value&gt;on exception name DbException swallow&lt;/value&gt;
      &lt;/list&gt;
    &lt;/property&gt;
  &lt;/object&gt;
</code></pre>

<p>This project is for me magic I upload all VS project here:</p>

<p><a href="http://hotfile.com/dl/135485464/93558e0/Log4Net.7z.html" rel="nofollow">http://hotfile.com/dl/135485464/93558e0/Log4Net.7z.html</a></p>

<p>Here is stackTrace of exception:</p>

<blockquote>
  <p>at Aspect.Managers.DbCustomerManager.GetCustomerById(Int64 id) in
  E:\C#
  PROJECTS\STUDY\SPRING.NET\Study.Spring.Net\Aspects\Logging\Log4Net\Managers\DbCustomerManager.cs:line
  20    at
  _dynamic_Aspect.Managers.DbCustomerManager.GetCustomerById(Object , Object[] )    at Spring.Reflection.Dynamic.SafeMethod.Invoke(Object
  target, Object[] arguments)    at
  Spring.Aop.Framework.DynamicMethodInvocation.InvokeJoinpoint()    at
  Spring.Aop.Framework.AbstractMethodInvocation.Proceed()    at
  Spring.Aspects.Exceptions.ExceptionHandlerAdvice.Invoke(IMethodInvocation
  invocation)</p>
</blockquote>

<p>Also if I try catch exception something like this:</p>

<pre class="lang-c# prettyprint-override"><code>        try
        {
            var springContext = ContextRegistry.GetContext();
            var dbMgr = (IDbCustomerManager)springContext["theDbCustomerManager"];
            dbMgr.GetCustomerById(1);
        }
        catch (Exception ex)
        {

            Console.WriteLine("{0}\n{1}", ex.GetType(), ex.Message);
        }
</code></pre>

<p>It is not possible..system show message is unhandled exception....</p>
 PostSharp attribute not inherited <p>I've created a type-level aspect in PostSharp, it adds some method preprocessing. I've applied it to the class, it works as advertised. However, in the classes derived from that one, it does not - method entry code is not hit.</p>

<p>How do I make my aspect inheritable, please?</p>

<p>I've tried adding <code>[AttributeUsage(AttributeTargets.Class, Inherited=true)]</code> to the aspect class - no effect.</p>
 Castle Windsor - set up of AOP outside application <p>We currently use Castle Windsor to manage dependency injection in our web applications. The DI registration code occurs within the applications themselves, so each application has roughly identical code within it's Global.asax <code>Application_Start()</code> method. We consider this appropriate since each application may need a different implementation of some of the interfaces in question.</p>

<p>I am now looking into AOP, specifically around authorisation. We would want to add attributes to methods in particular classes in a class library which define whether or not the user is permitted to execute that method. AOP sounds a good call for how to accomplish this.</p>

<p>The only thing that makes me uncomfortable is that each web application would have to set up the interceptors for itself. If one of the web applications configured the AOP stuff wrongly, we could end up with the unacceptable situation that authorisation code did not execute.</p>

<p>Is there some way that the class library could configure its own AOP, or that the responsibility of configuring AOP could be taken away from the web applications?</p>
 Is validation a cross cutting concern? <p>Some of my coworkers consider validation as an example of a cross cutting concern and think Aspect Oriented Programming is a good way to handle validation concerns. To use PostSharp notation they think something like this is a good idea:</p>

<pre><code>[InRange(20.0, 80.0)]
public double Weight
{
    get { return this.weight; }
    set { this.weight = value; }
}
</code></pre>

<p>My opinion is that validation is an inherent part of an algorithm and there is no need to push it behind the scenes using AOP. However it is much like a gut feeling and I have not a very clear justification for it. </p>

<p>When do you think it is a good idea to handle validation with AOP and when it is better to handle it inline with your main code? </p>
 
linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy linfu-dynamicproxy What are the differences between LinFu.DynamicProxy and Castle.DynamicProxy? <p>I am looking at adding logic to a library I am working on that would require the need for a Dynamic Proxy.  I would like to get some advice from user's who have used these two library's in a production environment.  Does one out perform the other, were there any shortcoming's which made you have to switch to the other, etc.  Basically tell me your experiences with the library's.  The answers will help me decide which one to use.</p>

<p>-- Edit --</p>

<p><hr /></p>

<p>I forgot to mention that the library I am developing will support Mono, therefore any knowledge you can share about the two libraries and their support for Mono would be great also.</p>
 NHibernate.ByteCode.LinFu.dll For NHibernate 3.2 <p>Where can I find the latest version of NHibernate.ByteCode.LinFu.dll that is compiled against NHibernate 3.2?</p>
 Nhibernate does not work after upgrade to version 2.1.2 <p>I recently changes my NHibernate implementation from Version 2.1.0 to 2.1.2. For lazy loading I used the LinFu implementation using : NHibernate.ByteCode.Linfu.</p>

<p>Since I changed to the newest version I got the following error:</p>

<pre><code> [SecurityException: That assembly does not allow partially trusted callers.]
  NHibernate.ByteCode.LinFu.ProxyFactory..cctor() +0
</code></pre>

<p>When debugging I came to the following error:</p>

<pre><code>   at NHibernate.ByteCode.LinFu.ProxyFactory..ctor()
   at NHibernate.ByteCode.LinFu.ProxyFactoryFactory.BuildProxyFactory()
   at NHibernate.Tuple.Entity.PocoEntityTuplizer.BuildProxyFactoryInternal(PersistentClass class, IGetter getter, ISetter setter)
   at NHibernate.Tuple.Entity.PocoEntityTuplizer.BuildProxyFactory(PersistentClass persistentClass, IGetter idGetter, ISetter idSetter)
   at NHibernate.Tuple.Entity.AbstractEntityTuplizer..ctor(EntityMetamodel entityMetamodel, PersistentClass mappingInfo)
   at NHibernate.Tuple.Entity.PocoEntityTuplizer..ctor(EntityMetamodel entityMetamodel, PersistentClass mappedEntity)
   at NHibernate.Tuple.Entity.EntityEntityModeToTuplizerMapping..ctor(PersistentClass mappedEntity, EntityMetamodel em)
   at NHibernate.Tuple.Entity.EntityMetamodel..ctor(PersistentClass persistentClass, ISessionFactoryImplementor sessionFactory)
   at NHibernate.Persister.Entity.AbstractEntityPersister..ctor(PersistentClass persistentClass, ICacheConcurrencyStrategy cache, ISessionFactoryImplementor factory)
   at NHibernate.Persister.Entity.SingleTableEntityPersister..ctor(PersistentClass persistentClass, ICacheConcurrencyStrategy cache, ISessionFactoryImplementor factory, IMapping mapping)
   at NHibernate.Persister.PersisterFactory.CreateClassPersister(PersistentClass model, ICacheConcurrencyStrategy cache, ISessionFactoryImplementor factory, IMapping cfg)
   at NHibernate.Impl.SessionFactoryImpl..ctor(Configuration cfg, IMapping mapping, Settings settings, EventListeners listeners)
   at NHibernate.Cfg.Configuration.BuildSessionFactory()
   at MyApplication.SessionManager..ctor() in C:\Projects\MyApps\MyApplication\SessionManager.cs:line 75
</code></pre>

<p>Is this because of the usage of NHibernate.ByteCode.LinFu? What can I do about it to make the application work again?</p>
 Ninject Interception dynamic proxy problems <p>I'm trying to set up interception to work with Ninject which we have been using as our dependency injection framework for a while.</p>

<p>I have downloaded the interception extension from NuGet and tried it with both the Castle Dynamicproxy implementation and the LinFu implementation but could not be either to work with our applications.</p>

<p>Castle gave an error when creating a proxy on a class that did not have a parameterless constructor, since all the service objects have their dependencies injected via the constructor this is a problem. The error is:</p>

<p>System.ArgumentException: Can not instantiate proxy of class: emedia.RapidSystems.Subscriber.Presenters.RRSubmissionPresenter.
Could not find a parameterless constructor.
Parameter name: constructorArguments</p>

<p>The LinFu interceptor worked better, right up until the code called a method with a generic parameter then it gave me the following:</p>

<p>System.ArgumentException: Generic types are not valid.
Parameter name: methodInfo</p>

<p>Here is a simplified version code for one of the classes I am trying to intercept:</p>

<pre><code>[LogCalls]
public class Repository&lt;T&gt; : IRepository&lt;T&gt;
        where T : class
{   
    public virtual T GetEntity&lt;TKey&gt;(ObjectContext context, TKey key)
    {
        var entity = GetEntity(context, key, _emptyLoadingStrategy);
        return entity;
    }

    public virtual IQueryable&lt;T&gt; GetAll(ObjectContext context)
    {
        var query = GetAll(context, _emptyLoadingStrategy);
        return query;
    }

    public virtual T Add(ObjectContext context, T entity)
    {
        context.AddObject(EntitySetName(context), entity);
        return entity;
    }

     //other code goes here

}
</code></pre>

<p>Add and GetAll work fine but the error happens when GetEntity is called on the proxy.</p>

<p>At this point I'm stuck, as neither interceptor works with the code base. Has anyone got Ninject interception working with a real complex production system, rather than a simple demo class, and if so how? I don't mind which interceptor I use as long as it works.</p>

<p>Or is interception with Ninject just not mature enough yet, and do I need to look at replacing the whole thing with something else like Unity?</p>
 Using Automapper with LinFu.DynamicProxy in commercial application <p>We want to use Automapper in commercial application (.NET 3.5). To get the clearance we need the source code of automapper.</p>

<p>We got the required automapper source code but after building the code we found that the size of automapper.dll 86KB while the DLL we were using was of 108 KB. Application was not working with this 86KB automapper dll</p>

<p>We looked into the code and found that another DLL LinFu.DynamicProxy of size 21KB . If I use this DLL with automapper DLL application works fine.</p>

<p>Based on that I conclude that the 108KB dll that I was using actually contains 86KB Automapper  + 21 KB LinFu.DynamicProxy.</p>

<p>Now I have question related to licensing. Do I need to get the approval for LinFu.DynamicProxy as well. It comes with GNU license.</p>
 Backing field for collection is null when using LinFu ProxyFactoryFactory in NHibernate <p>I am having a problem when I try switching from the Castle ProxyFactoryFactory to the LinFu ProxyFactoryFactory in NHibernate.</p>

<p>I have an entity like this:</p>

<pre><code>public class Foo
{
    private ISet&lt;Bar&gt; _bars = new HashedSet&lt;Bar&gt;();

    public virtual void AddBar(Bar bar)
    {
       if (!_bars.Contains(bar)
            _bars.Add(bar);

       bar.Foo = this;
    }
}
</code></pre>

<p>This is mapped with Fluent NHibernate like this:</p>

<pre><code>public class FooDbMap : ClassMap&lt;Foo&gt;
{
     public FooDbMap()
     {
          HasMany(x =&gt; x.Bars)
              .Access.CamelCaseField(Prefix.Underscore)
              .LazyLoad()
              .KeyColumn("FooId")
              .AsSet()
              .Cache.ReadWrite();
     }
}
</code></pre>

<p>The relationship is bi-directional and is mapped as such on the Bar side too.</p>

<p>The problem occurs when I call the AddBar method. The _bars collection is null, and a NullReferenceException is thrown.</p>

<p>The problem goes away if I switch back to the Castle ProxyFactoryFactory.</p>

<p>The error doesn't occur with all mapped collections, just this one instance.</p>

<p>The problem still occurs even if I change _bars to readonly! So someone is managing to set a readonly field back to null, even after the field has been assigned.</p>

<p>Any ideas?</p>
 Lin Fu Interceptor <p>How can i implement automatic InotifypropertyChanged with LinFu?</p>
 How to intercept, parse and compile? <p>This is a problem I've been struggling to solve for a while. I need a way to either replace code in the method with a parsed code from the template at compile time (PostSharp comes to mind) or to create a dynamic proxy (Linfu or Castle). So given a source code like this</p>

<pre><code>[Template]

private string GetSomething()

{

var template = [%=Customer.Name%]

}
</code></pre>

<p>I need it to be compiled into this</p>

<pre><code>private string GetSomething()

{

MemoryStream mStream = new MemoryStream();

            StreamWriter writer = new StreamWriter(mStream,System.Text.Encoding.UTF8);

writer.Write(@"" );

writer.Write(Customer.Name);

StreamReader sr = new StreamReader(mStream); 

writer.Flush();

mStream.Position = 0; 

return sr.ReadToEnd();

}
</code></pre>

<p>It is not important what technology is used. I tried with PostSharp's ImplementMethodAspect but got nowhere (due to lack of experience with it). I also looked into Linfu framework. Can somebody suggest some other approach or way to do this, I would really appreciate. My whole project depends on this.</p>

<p><strong>Assumptions:</strong></p>

<ol>
<li>Code can appear in any class.</li>
<li>Template code will always be annotated with attribute [Template]</li>
<li>Template method will always return string.</li>
</ol>

<p>Parsing of the code from one form to another is already done. Now I just need a way to replace it. </p>

<p>"Beefer" example:</p>

<pre><code>  [Test]
        public void can_parse_csharp_code_template3()
        {
            var template = @"&lt;template&gt; [%= GetUsing() %]
    namespace [%= GetModelNamespaceName(.metaPackage) %]
    {
    [%= .visibility.ToString().ToLower() %] class [%= .Name %] : INotifyPropertyChanged [%= If(.IsPersistent, "", PersistenObject"", """") %]
        {
            #region Constructors
            [%= ConstructorTemplate.Create(metaObject).GetParameterlessConstructorCode %]
            #endregion

            #region Attributes

            [%= From attribute In metaObject.attributes _
                Select (AttributeTemplate.Create(attribute).GetSourceCode) %]
            #endregion

            #region Relationships
            [%= From relationship As Relationship In metaObject.relationships _
                Select (RelationshipTemplateFactory.CreateFor(relationship).GetSourceCode()) %]
            #endregion

            #region Methods
            [%= From operation In metaObject.operations _
                Select (MethodTemplate.Create(operation).GetSourceCode) %]
            #endregion

            #region ""INotifyPropertyChanged""
            [%= GetOnPropertyChanged() %]
            #endregion
            }
        }&lt;/template&gt;";

            Console.WriteLine(TemplateParser.GetParsedResult(template));

        }
</code></pre>
 Where to find the LinFu bytecode provider for NH3.2? <p>It's not included within the 3.2 release of NHibernate and I cannot find it anywhere.<br>
Where can it be found?</p>
 Linfu dynamic proxy and Interface methods that return IEnumerable<object> <p>I am using Linfu to generate a proxy object for an interface. Everything works fine except when calling a method that returns an <code>IEnumerable&lt;object&gt;</code> I get an error something like this:</p>

<blockquote>
  <p>Unable to cast object of type '&lt; IEnumerableRpcCall >d__2' to type 'System.Collections.Generic.IEnumerable`1[System.String]'.</p>
</blockquote>

<p>FYI: <code>IEnumerableRpcCall</code> is the name of the method inside the interceptor code that does <code>yield return object</code> rather than <code>return object</code>.</p>

<p>It seems the problem is that linfu is returning a pointer to the method rather than an <code>IEnumerable</code>. Has anyone found a workaround for this?</p>
 Links for Source code required for LinFu.DynamicProxy Version 1.0.3.28303 <p>I require source code for LinFu.DynamicProxy Version 1.0.3.28303
Solution of code should open in Visual Studio 2008.</p>

<p>Thanks</p>
 LinFu.DynamicProxy: What should be returned from IInterceptor.Intercept? <p>I'm trying to write a dynamic proxy with LinFu, using the <code>IInterceptor</code> interface, but I'm having problems finding up-to-date documentation.</p>

<p>What should be returned from the <code>object Intercept(InvocationInfo info)</code> method? Do you have to invoke the method yourself and return the actual return value? It would be nice to just be able to let the call proceed after doing what ever you wanted to do in the interception.</p>

<p><strong>Edit:</strong></p>

<p>Trying to manually call the intercepted method seems to trigger the interception once again, resulting in a stack overflow exception. </p>

<p>I've also tried using the <code>IInvokeWrapper</code> interface, but I had the same issue there.</p>

<p>Thanks,</p>

<p>/Erik Öjebo</p>
 Can I use Linfu dynamic proxy to proxy an interface with generic parameters? <p>I am currently using Linfu to create dynamic proxys, and it works really well for normal interfaces. The problem is I now need to create a dynamic proxy for an interface with generic parameters. I do not know the types of the generic parameters (or even load the assemblies containing them) until runtime. Does anyone know if this is even possible?</p>
 
aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect aspect Multiple screen resolutions/aspect ratios (games) <p><strong>EDIT:</strong> Thanks for all your answers and comments. 
After thinking about it i would rephrase the core of the question to: "How to determine and limit the minimum resolution/ratio my game is able to run on". Because imo either the game becomes unplayable on the smallest screen/ratio (lack of detail) or supporting even the smallest screen/ratio degrades the experience for all the others significantly. Besides we do not even know what the smallest resolution is or can restrict it in any way other than disabling ldpi... which still doesn't tell us about the smallest mdpi. After all i'm not thinking about how to create a good result but about how to create a perfect result ;). Guess it's not possible (yet?).</p>

<p><strong>Note:</strong> This is purely about phones not tablets
Also this question is not that relevant for applications as it is for games which don't use the Android layout system.</p>

<p>I always found the definitions of which resolutions to expect somewhat vague.
I am aware of the <a href="http://developer.android.com/guide/practices/screens_support.html#testing">list</a> in the docs.</p>

<p>Now my first question is if this list is complete or in other words are manufacturer allowed to use other reolutions or aspect ratios.
My current approach is to view this list in terms of aspect ratios which looks something like that (Not sure if it's exact but you get the idea):</p>

<ul>
<li>ldpi: smallest aspect ratio 4:3</li>
<li>mdpi: smallest aspect ratio 3:2</li>
<li>hdpi: biggest aspect ratio 16:9</li>
</ul>

<p><img src="http://i.stack.imgur.com/mOdYD.png" alt="4:3">
<img src="http://i.stack.imgur.com/LtwMT.png" alt="3:2">
<img src="http://i.stack.imgur.com/oVy5Q.png" alt="16:9"></p>

<p>So if i want to cover a range of devices i figure out what my smallest and my biggest aspect ratios are and design the layout for the smallest while making it automatically grow to the biggest.
For example if i want to support all densities i design the screens for 4:3 and make it grow to 16:9. In case i remove ldpi support i would design for 3:2.
Of course this assumes there will never be an mdpi device with an aspect ratio of 4:3 which brings us back to my first question.</p>

<p>My preferred solution would be to indicate on the Android Market which aspect ratios my application can handle but that doesn't seem possible so far. </p>

<p>Does anyone have a better approach? (Keeping in mind that it's for games on phones only)</p>
 Strategies for Handling Multiple Screen Resolutions and Aspect Ratios in Web Development <p>Back in the day, 800 x 600 was the screen resolution to design for - and maybe 640 x 480. Then along came 1024 x 768, etc, etc, etc. </p>

<p>But then it gets worse: now we have not only different resolutions but also different aspect ratios. </p>

<p>What strategies do people use to accommodate today's ever-expanding range of screen sizes and aspect ratios? </p>

<p>(BTW - I was only thinking about laptop / desktop hardware, but of course there's smart-phones and tablets to consider too.)</p>
 Spring AOP vs AspectJ <p>I am under the impression that Spring-AOP is best used for application specific tasks such as security, logging, transactions, etc. as it uses custom Java5 annotations as a framework. However, AspectJ seems to be more friendly design-patterns wise. </p>

<p>Can anyone highlight the various pros and cons of using Spring-AOP vs AspectJ in a spring application??</p>
 Dealing with different aspect ratios in libgdx <p>I have implemented some screens using libgdx that would obviously use the Screen class provided by the libgdx framework. However, the implementation for these screens works only with pre-defined screen sizes. For example, if the sprite was meant for a 640 x 480 size screen (4:3 Aspect ratio), it won't work as intended on other screen sizes because the sprites go par the screen boundaries and are not scaled to the screen size at all. Moreover, if simple scaling would have been provided by the libgdx, the issue I am facing would have still been there because that would cause the aspect ratio of the game screen to change.</p>

<p>After researching on internet, I came across a <a href="http://www.java-gaming.org/index.php?topic=25685.new">blog/forum</a> that had discussed the same issue. I have implemented it and so far it is working fine. But I want to confirm whether this is the best option to achieve this or there are other better alternatives for achieving this. Below is the code to show how I am dealing with this legitimate problem. Please give a look.</p>

<p>FORUM LINK: <a href="http://www.java-gaming.org/index.php?topic=25685.new">http://www.java-gaming.org/index.php?topic=25685.new</a></p>

<pre><code> public class SplashScreen implements Screen{
//Aspect Ratio maintenance
private static final int VIRTUAL_WIDTH = 640;
private static final int VIRTUAL_HEIGHT = 480;
private static final float ASPECT_RATIO = (float)VIRTUAL_WIDTH/(float)VIRTUAL_HEIGHT;

private Camera camera;
private Rectangle viewport;
//------end------

MainGame TempMainGame;

public Texture splashScreen;
public TextureRegion splashScreenRegion;    
public SpriteBatch splashScreenSprite;

public SplashScreen(MainGame maingame)
{
    TempMainGame=maingame;
}
@Override
public void dispose() {
    splashScreenSprite.dispose();
    splashScreen.dispose();
}

@Override
public void render(float arg0) {
    //----Aspect Ratio maintenance

    // update camera
    camera.update();
    camera.apply(Gdx.gl10);

    // set viewport
    Gdx.gl.glViewport((int) viewport.x, (int) viewport.y,
                      (int) viewport.width, (int) viewport.height);

    // clear previous frame
    Gdx.gl.glClear(GL10.GL_COLOR_BUFFER_BIT);

    // DRAW EVERYTHING
//--maintenance end--


    splashScreenSprite.begin();
    splashScreenSprite.disableBlending();
    splashScreenSprite.draw(splashScreenRegion, 0, 0);
    splashScreenSprite.end();
}

@Override
public void resize(int width, int height) {
    //--Aspect Ratio Maintenance--
    // calculate new viewport
    float aspectRatio = (float)width/(float)height;
    float scale = 1f;
    Vector2 crop = new Vector2(0f, 0f);

    if(aspectRatio &gt; ASPECT_RATIO)
    {
        scale = (float)height/(float)VIRTUAL_HEIGHT;
        crop.x = (width - VIRTUAL_WIDTH*scale)/2f;
    }
    else if(aspectRatio &lt; ASPECT_RATIO)
    {
        scale = (float)width/(float)VIRTUAL_WIDTH;
        crop.y = (height - VIRTUAL_HEIGHT*scale)/2f;
    }
    else
    {
        scale = (float)width/(float)VIRTUAL_WIDTH;
    }

    float w = (float)VIRTUAL_WIDTH*scale;
    float h = (float)VIRTUAL_HEIGHT*scale;
    viewport = new Rectangle(crop.x, crop.y, w, h);
//Maintenance ends here--
}


@Override
public void show() {
    camera = new OrthographicCamera(VIRTUAL_WIDTH, VIRTUAL_HEIGHT); //Aspect Ratio Maintenance

    splashScreen = new Texture(Gdx.files.internal("images/splashScreen.png"));
    splashScreenRegion = new TextureRegion(splashScreen, 0, 0, 640, 480);
    splashScreenSprite = new SpriteBatch();

    if(Assets.load()) {
        this.dispose();
        TempMainGame.setScreen(TempMainGame.mainmenu);
    }   
}

}
</code></pre>

<p><strong>UPDATE:</strong> I recently came to know that libgdx has some of its own functionality to maintain aspect ratios which I would like to discuss here. While searching the aspect ratio issue across the internet, I came across several forums/developers who had this problem of "How to maintain the aspect ratio on different screen sizes?" One of the solutions that really worked for me was posted above.</p>

<p>Later on when I proceeded with implementing the touchDown() methods for the screen, I found that due to scaling on resize, the co-ordinates on which I had implemented touchDown() would change by a great amount. After working with some code to translate the co-ordinates in accordance with the screen resize, I reduced this amount to a great extent but I wasn't successful to maintain them with pin point accuracy. For example, if I had implemented touchDown() on a texture, resizing the screen would shift the touchListener on the texture region some pixels to the right or left, depending on the resize and this was obviously undesired.</p>

<p>Later on I came to know that the stage class has its own native functionality to maintain the aspect ratio (boolean stretch = false). Now that I have implemented my screen by using the stage class, the aspect ratio is maintained well by it. However on resize or different screen sizes, the black area that is generated always appears on the right side of the screen; that is the screen is not centered which makes it quite ugly if the black area is substantially large. </p>

<p>Can any community member help me out to resolve this problem??</p>
 Your thoughts on web design for 16:9 screens <p>I design web apps mainly for desktop use (not PDAs, phones etc) by co-workers and customers. As more users become equipped with 16:9-type screens the traditional screen layouts are no longer ergonomic.</p>

<p>For example, a long vertical navi bar might not fit completely or a complex form might need to be scrolled in order to move to the next input field.</p>

<p>How are you coping with this development? Are you spreading out more horizontally or sticking with the old layouts? Is it not really a problem?</p>

<p><strong>UPDATE</strong></p>

<p>Thanks for all the replies. I have found them useful. Here are some thoughts which occurred to me:</p>

<ul>
<li><p>I take the point that the 4:3 format may still be the most widely used, but I expect that to change. </p></li>
<li><p>Also, most users I visit here in the company have <em>all</em> their windows maximised (really!) so the idea of sizing the browser to fit the content doesn't help there.</p></li>
<li><p>In my case, most web apps involve search and display of information or data entry (some of which can involve large and complex forms). It's mainly the data entry apps which I'm concerned about. Perhaps AJAX and Tabbed controls might be a way forward there.</p></li>
</ul>
 Aspect-Oriented Objective-C Library? <p>Is there any Aspect-Oriented Objective-C library that I could perhaps use for iPhone development?</p>
 how do i keep the aspect ratio on image buttons in android? <p>i have 5 square ImageButtons that i want to have lined up side by side on the bottom of the screen.  I have each one set (different id's) as: </p>

<pre><code>        &lt;ImageButton
         android:id="@+id/box1" 
         android:layout_width="fill_parent"
         android:layout_height="wrap_content" 
         android:layout_gravity="center"
         android:adjustViewBounds="true"
         android:scaleType="fitXY"
         android:layout_weight="1"
         android:layout_margin="1dp"
         /&gt; 
</code></pre>

<p>and i have the background assigned in main java like this:</p>

<pre><code>    int[] imageIds = new int[] {R.id.box1,R.id.box2,R.id.box3,R.id.box4,R.id.box5};
    for(int i = 0; i&lt;5; i++){
        imageButtons[i] = (ImageButton) findViewById(imageIds[i]);
        imageButtons[i].setBackgroundResource(R.drawable.blank);
    }
</code></pre>

<p>what i would like to have it do is scale the width to fit neatly side-by-side at the bottom of the screen (which it does now ok), but have the height automatically scale to match the width as well. is this possible?  i don't want to use setImageSource because then it puts a border around the imagebutton.</p>
 How Can I Only Allow Uniform Resizing in a WPF Window? <p>I don't want my window to be resized either "only horizontally" or "only vertically." Is there a property I can set on my window that can enforce this, or is there a nifty code-behind trick I can use?</p>
 How to profile methods in Scala? <p>What is a standard way of profiling Scala method calls?</p>

<p>What I need are hooks around a method, using which I can use to start and stop Timers.</p>

<p>In Java I use aspect programming, aspectJ, to define the methods to be profiled and inject bytecode to achieve the same.</p>

<p>Is there a more natural way in Scala, where I can define a bunch of functions to be called before and after a function without losing any static typing in the process?</p>
 How to maintain widgets aspect ratio in Qt? <p>How is it possible to maintain widgets aspect ratio in Qt and what about centering the widget?</p>
 Aspect Oriented Programming (AOP) in C NOT C++ — anyone doing it? <p>Has anyone seen or written their own framework for doing Aspect Oriented Programming in C?</p>

<p>Not C++ -- I've seen already that there's AspectC which is really C++.</p>

<p>Involved in embedded software development which requires C only.</p>

<p>I am not asking how to do it, only whether someone has done it already.</p>

<p><hr></p>

<p>EDIT:</p>

<p>Need clarification on one of the responses.</p>

<p>Mads Elvheim</p>

<p>It was not my <em>position</em> that AspectC is C++. Rather, I had searched for AOP for C and only gotten to <a href="http://www.aspectc.org/">http://www.aspectc.org/</a>, which certainly sounded from the URL like <em>the</em> place, but it begins, </p>

<blockquote>
  <p>"With the AspectC++ project we extend
  the AspectJ approach to C/C++. It is a
  set of C++ language extensions to
  facilitate aspect-oriented programming
  with C/C++"</p>
</blockquote>

<p>which made me think that there was no AOP from them just for C. The link you sent looks more promising, in that its web page title is "AOP for C". But here at this link, <a href="http://www.cs.ubc.ca/labs/spl/projects/aspectc.html">http://www.cs.ubc.ca/labs/spl/projects/aspectc.html</a>, I can't find any code, so I'm not sure. Do you know where to find code on that site?</p>

<p>As for <a href="http://sailhome.cs.queensu.ca/~bram/aspicere/index.html#examples">http://sailhome.cs.queensu.ca/~bram/aspicere/index.html#examples</a>, I've already found the code examples there, so I'll look at them.</p>
 A simple way to put a UIImage in a UIButton <p>I have a UIButton in my iPhone app.  I set its size to 100x100.</p>

<p>I have an image that is 400x200 that I wish to display in the button.</p>

<p>The button STILL needs to stay at 100x100... and I want the image to downsize to fit... but
keep the correct aspect ratio.</p>

<p>I thought that's what "Aspect Fit" was used for.</p>

<p>Do I include my image with setImage, or setBackgroundImage?</p>

<p>Do I set AspectFit for the button?  or the image?  or the background image?</p>

<p>(I need the smaller images to INCREASE in size.  While larger images should DESCREASE in size.
Always keeping the button at 100x100.)</p>

<p>I've tried countless combinations of all of the above... and I just can't seem to get
everything to work at the same time:</p>

<ul>
<li>Don't change the button's size of 100x100.</li>
<li>Don't destroy the image's aspect ratio.</li>
<li>Always increase small images to fit the button.</li>
<li>Always decrease large images to fit the button.</li>
<li>Never clip any of the image edges.</li>
<li>Never require the "put UIButtons over all your UIimages" hack.</li>
<li>Don't require everyone to upgrade to v4.2.1 just to use new framework methods.</li>
</ul>

<p>I see so many apps, with so many fully-working image-buttons... that I can't believe I can't figure out this very simple, very common thing.</p>

<p>Ugh.</p>
 Maven/AJDT project in Eclipse <p>I need to use aspectj in a maven project. I installed the maven plugin for eclipse (m2e), the maven aspectj plugin, and also AJDT for Eclipse. So now, when i open a new project i have "Maven Project" and "AspectJ Project". how can i make a new project that is Maven AspectJ project?
I did not found any reference for that, so you are my only hope.
thanks</p>
 Is AspectF (a Fluent Aspect Framework) an AOP-like design that can be used without much concern? <p><a href="http://msmvps.com/blogs/omar/Default.aspx" rel="nofollow">Omar Al Zabir</a> is looking for "a simpler way to do AOP style coding".</p>

<p>He created a framework called <a href="http://code.google.com/p/aspectf/" rel="nofollow">AspectF</a>, which is "a fluent and simple way to add Aspects to your code".</p>

<p><strong>It is not true AOP</strong>, because it doesn't do any compile time or runtime weaving, but does it accomplish the same goals as AOP?</p>

<p>Here's an example of AspectF usage:</p>

<pre><code>    public void InsertCustomerTheEasyWay(string firstName, string lastName, int age,
        Dictionary&lt;string, string&gt; attributes)
    {
        AspectF.Define
            .Log(Logger.Writer, "Inserting customer the easy way")
            .HowLong(Logger.Writer, "Starting customer insert", "Inserted customer in {1} seconds")
            .Retry()
            .Do(() =&gt;
                {
                    CustomerData data = new CustomerData();
                    data.Insert(firstName, lastName, age, attributes);
                });
    }
</code></pre>

<p>Here are some posts by the author that further clarify the aim of AspectF:</p>

<ul>
<li><a href="http://msmvps.com/blogs/omar/archive/2009/09/19/aspectf-fluent-way-to-put-aspects-into-your-code-for-separation-of-concern.aspx" rel="nofollow">AspectF fluent way to put Aspects into your code for separation of concern</a> (Blog)</li>
<li><a href="http://code.google.com/p/aspectf/" rel="nofollow">AspectF</a> (google code)</li>
<li><a href="http://www.codeproject.com/KB/tips/aspectf.aspx" rel="nofollow">AspectF Fluent Way to Add Aspects for Cleaner Maintainable Code</a> (CodeProject)</li>
</ul>

<p>According to the author, I gather that AspectF is <strong>not designed so much as an AOP replacement</strong>, but a way to achieve "separation of concern and keep code nice and clean".</p>

<p>Some thoughts/questions:</p>

<ul>
<li>Any thoughts on using this style of coding as project grows?        </li>
<li>Is it a scalable architecture?</li>
<li><strike>performance concerns?</strike></li>
<li>How does maintainability compare against a true AOP solution?</li>
</ul>
 How do I find the natural size/dimensions of a Flash SWF file? <p>I've been given a Flash file (<code>.swf</code> extension) to put into a web page. Opening the file in my browser makes it quite blurry, so I'm assuming there is a natural size for the file, same as an image.</p>

<p>It's also rectangular so I need to work out the aspect ratio if I don't have an exact size. How would I find this information out?</p>
 Aspect Oriented Logging with Unity\T4\anything else <p>In my application we have a trace logger. We have log statements added at the beginning and end of most of the important methods tracing the method name and the parameter values. Now these trace statements are bloating the code and it is a bit of a pain to read through them.</p>

<p>I am considering how can I separate this aspect of the code from my business logic.</p>

<p>Today I was reading about Unity's interception framework. I had a passing thought if it is possible to intercept my method calls with a generic logger and log the method name and parameter values. I am not sure if it is possible to read method parameters using reflection. Can Unity be used like this?</p>

<p>Another idea was to run the T4 code generation engine to generate logging statements at the beginning and end of all methods decorated with a particular attribute. Since I know very little about T4, does anyone know if this can be accomplished?</p>

<p>Are there any other ways to separate the logging code from my business logic?</p>

<p>Cheers,
Unmesh</p>
 Resize UIImage by keeping Aspect ratio and width <p>I seen in many posts for resizing the image by keeping aspect ratio. These functions uses the fixed points(Width and Height) for RECT while resizing. But in my project, I need to resize the view based on the Width alone, Height should be taken automatically based on the aspect ratio.
anyone help me to achieve this.</p>
 device-aspect-ratio (media query) not working for Droid 2 <p>I have some content that needs varying styles ultimately based on aspect ratio (basically it's targeted at one platform but as a "would-be-nice" I want to make the content at least appear correct on other platforms). I'm finding that the Droid 2 (Android 2.2 stock) is not responding to any of these queries:</p>

<pre><code>only all and (device-aspect-ratio: 854/480)
only all and (device-aspect-ratio: 480/854)
only all and (aspect-ratio: 854/480)
only all and (aspect-ratio: 480/854)
</code></pre>

<p>Does the phone or the OS not support the aspect-ratio query? Is the Droid 2 full of sad? The aspect ratio tests work perfectly for iPhone 3GS/4/4S and iPad so far for me. Alternatively, what would someone suggest for handling Droid 2 / Nexus resolutions after my iOS aspect ratio tests if they don't actually support device aspect ratio.</p>

<p>I'm trying to shy away from using max-width because some Android devices in landscape are wider than an iPad in portrait and I was getting collisions where a device would incorrectly identify as an iPad based on a set width. Any insight would be appreciated.</p>
 Pure CSS Solution - Square Elements? <p>If I have a &lt;div&gt; with a relative width (such as <em>width: 50%</em>), is there a simple way to make it have the same width as it does height without resorting to JavaScript?</p>
 Configurable vs Component with Spring and AspectJ <p>When using AspectJ, why use @Component over @Configurable.</p>

<p>I've got Spring and AspectJ setup for @Transactional support, aspects on self-invocation, and injection into JPA entities. This works great. </p>

<p>I'm using @Component for most classes that need injection, and thus either having them injected into their dependencies. Or, when I can't, injecting the ApplicationContext and then using getBean() as a last resort. And I'm reserving @Configurable for only JPA entities (Hibernate) that need injection. I've also started using @Configurable for jUnit tests, to make writing tests easy. This also works great.</p>

<p>But I'm curious. If AspectJ is now auto-injecting (beanifying) anything with the @Configurable annotation, regardless of  how its constructed; getBean(), new(), @Autowired. Why wouldn't I just switch to using @Configurable for all my beans? Then I can do away with the application context and getBean() altogether, and just new() any classes I can't inject.</p>

<p>I realize that I made no mention of XML bean configuration. I don't shy away from that, but this project doesn't happen to require any. I just constructor or setter inject the dependencies when testing. very easy.</p>
 Run Code Before Every Function Call for a Class in C++ <p>I would like to run some code (perhaps a function) right before every function call for a class and all functions of the classes that inherit from that class.  I'd like to do this without actually editing every function, Is such a thing even possible?  </p>

<p>I would settle for having a function called as the first instruction of every function call instead of it being called right before.</p>
 How can Domain driven design be combined with aspect oriented programming? <p>I'm doing research and one point I want to cover is "What is the relationship between Domain-driven Design and Aspect oriented programming?"</p>

<p>I know that a main principle in DDD is separation of concerns and I understand that. What I'm not really certain is, whether aspects in AOP acts like "sub domains" in our domain in DDD. </p>

<p>Are these two concepts, basically the same thing. I mean, If I develop an application following AOP and DDD, at the end of the day will it be true that "a sub domain" == "an aspect".</p>

<p>I will also appreciate any other opinions what is the common between AOP and DDD.</p>
 C#: Wrapping methods in other methods <p>Is there a way to wrap methods in other methods transparently in C#? I want to achieve what is done by Moose's around functionality: <a href="http://search.cpan.org/perldoc?Moose::Manual::MethodModifiers" rel="nofollow">http://search.cpan.org/perldoc?Moose::Manual::MethodModifiers</a></p>

<p>EDIT: And by transparent I mean without modifying the original method.</p>
 Any mature AOP library to use in .Net world? <p>The library should at least compared to AspectJ, any?</p>
 How to scale SVG image to fill browser window? <p>This seems like it ought to be easy, but I'm just not getting something.</p>

<p>I want to make an HTML page containing a single SVG image that automatically scales to fit the browser window, without any scrolling and while preserving its aspect ratio.</p>

<p>For example, at the moment I have a 1024x768 SVG image; if the browser viewport is 1980x1000 then I want the image to display at 1333x1000 (fill vertically, centred horizontally).  If the browser was 800x1000 then I want it to display at 800x600 (fill horizontally, centred vertically).</p>

<p>Currently I have it defined like so:</p>

<pre><code>&lt;body style="height: 100%"&gt;
  &lt;div id="content" style="width: 100%; height: 100%"&gt;
    &lt;svg xmlns="http://www.w3.org/2000/svg" version="1.1"
         width="100%" height="100%"
         viewBox="0 0 1024 768"
         preserveAspectRatio="xMidYMid meet"&gt;
      ...
    &lt;/svg&gt;
  &lt;/div&gt;
&lt;/body&gt;
</code></pre>

<p>However this is scaling up to the full width of the browser (for a wide but short window) and producing vertical scrolling, which isn't what I want.</p>

<p>What am I missing?</p>
 Android Convert Px to Dp (Video Aspect Ratio) <blockquote>
  <p><strong>Possible Duplicate:</strong><br>
  <a href="http://stackoverflow.com/questions/4605527/converting-pixels-to-dp-in-android">converting pixels to dp in android</a>  </p>
</blockquote>



<p>I'm trying to convert pixels to dp.  What is the formula?</p>

<p>Lets convert 640 and 480 into dp.  The docs say this </p>

<blockquote>
  <p>The conversion of dp units to screen pixels is simple: px = dp * (dpi / 160)</p>
</blockquote>

<p>But I don't think that is what I need (and I don't know how to use this).  I guess I just need the forumla.  I have the code ready:</p>

<pre><code>DisplayMetrics metrics = new DisplayMetrics();
    getWindowManager().getDefaultDisplay().getMetrics(metrics);

    switch(metrics.densityDpi)
    {
         case DisplayMetrics.DENSITY_LOW:
         int sixForty = ?
         int fourEighty = ?
         break;

         case DisplayMetrics.DENSITY_MEDIUM:
         int sixForty = ?
         int fourEighty = ?
         break;

         case DisplayMetrics.DENSITY_HIGH:
         int sixForty = ?
         int fourEighty = ?
         break;
    }
</code></pre>
 Ignoring Aspectj during junit tests <p>Here is situation:</p>

<ol>
<li>We have class with defined aspect to it's methodA; </li>
<li>We have JUnit test for this methodA;</li>
</ol>

<p>When I run JUnit test it activates Aspect as well. Any thoughts how to ignore Aspects during unit tests? </p>

<p>I have separated tests for my Aspects and it works fine. So in my unit test I want to test only methodA without any attached aspects.  </p>

<p>I use spring 3.0 and its aspectj support.</p>

<p>Thanks in advance. </p>

<p>Regards,
Max</p>
 How to define fixed aspect-ratio for scatter-plot <p>I am plotting correlation coefficients (values = 0.0:1.0) for two isotopes measured in each individual from two populations. I would like to have a fixed aspect-ratio for my scatter-plot so that the x- and y-axis are exactly the same size no matter the graphics device. Suggestions?</p>

<p>This is my first plot in R, any comments on refinements to my code is appreciated? Finally, is it worth investing in learning the basic plotting techniques or should I jump right to ggplot2 or lattice?</p>

<p>My plot script:</p>

<pre><code>## Create dataset
WW_corr &lt;-
structure(list(South_N15 = c(0.7976495, 0.1796725, 0.5338347,
0.4103769, 0.7447027, 0.5080296, 0.7566544, 0.7432026, 0.8927161
), South_C13 = c(0.76706752, 0.02320767, 0.88429902, 0.36648357,
0.73840937, 0.0523504, 0.52145159, 0.50707858, 0.51874445), North_N15 = c(0.7483608,
0.4294148, 0.9283554, 0.8831571, 0.5056481, 0.1945943, 0.8492716,
0.5759033, 0.7483608), North_C13 = c(0.08114805, 0.47268136,
0.94975596, 0.06023815, 0.33652839, 0.53055943, 0.30228833, 0.8864435,
0.08114805)), .Names = c("South_N15", "South_C13", "North_N15",
"North_C13"), row.names = c(NA, -9L), class = "data.frame")

opar &lt;- par()

## Plot results
par(oma = c(1, 0, 0, 0), mar = c(4, 5, 2, 2))           
plot(1,1,xlim=c(0:1.0), ylim=c(0:1.0), type="n", las=1, bty="n", main = NULL,
     ylab=expression(paste("Correlation Coefficient (r) for ", delta ^{15},"N ",
                     "\u0028","\u2030","\u0029")),
     xlab=expression(paste("Correlation Coefficient (r) for ", delta ^{13},"C ",
                     "\u0028","\u2030","\u0029")))

points(WW_corr$South_N15, WW_corr$South_C13, pch = 23, cex = 1.25, 
       bg ="antiquewhite4", col = "antiquewhite4")
points(WW_corr$North_N15, WW_corr$North_C13, pch = 15, cex = 1.25,
       bg ="black")
axis(1, at = seq(0, 1.0, by = 0.1), labels = F, tick = TRUE, tck = -0.01)
axis(2, at = seq(0, 1.0, by = 0.1), labels = F, tick = TRUE, tck = -0.01)
abline(h=.86, v=.86, col = "gray60", lty = 2)
legend("topleft", c("North", "South"), pch = c(15, 23), 
       col = c("black", "antiquewhite4"), pt.bg = c("black", "antiquewhite4"),
       horiz=TRUE, bty = "n")

par(opar)
</code></pre>
 Corona SDK Cross Device Screen Resolution <p>This is going to be one of those awkward questions looking for an answer that probably doesn't exist, but here goes.</p>

<p>I've been developing some simple games using Corona and whilst the functionality seems to work pretty well across most of the physical devices I have tested on, the one main issue is the layout. I know you can't really build for every single device perfectly, but I'm wondering if there is a common method to make an app look good across as many screens as possible. I have access to these devices </p>

<ul>
<li>iPad 1 &amp; 2: 4:3 (1.33)</li>
<li>iPhone 960 × 640 3:2 (1.5)</li>
<li>iPhone 480x320 3:2 (1.5)</li>
<li>Galaxy Nexus 16:9 (1.77)</li>
</ul>

<p>From what I have seen, people aim to use 320x480 as a scaled resolution and then let Corona upscale to the correct device resolution (with any @2x images as required) but this leads to letterboxing or cropping depending on the config.lua scale setting. Whilst it does scale correctly, having a letterbox isn't great.</p>

<p>So would I be best to not specify a width&amp;height in the config file, but instead to use some sort of screen check at first to look for 1.33 / 1.5 / 1.77 aspect ratios? Surely with the whole point of Corona SDK, there would be some sort of 'typical' setup that developers use for the start of any new project?</p>

<p>Thank you</p>
 Cocos2d and the new iPhone 5 aspect ratio <p>I have just seen the <a href="http://www.youtube.com/watch?v=DYb855lAkFs">announcment of iPhone 5</a> and it says that the pixel resolution has changed to 1136*640, affecting in this way the ASPECT RATIO of the app.</p>

<p>How should I deal with this in my Cocos2d game? I got all the graphics done for the "old" 960*640 retina display screen and I guess that those will be distorted on the iPhone 5 screen.</p>

<p>Am I right? Or will there be the "old resolution" images shown without modifying the aspect ratio and leaving some screen black?</p>

<p><strong>EDIT:</strong> Is there a way to get Cocos2d to detect if it is iPhone 5 and in that case draw the background files in the top part of the screen (top 960 pixels) and get some other custom background files to be drawn in the remaining pixels (e.g. those could be some custom ad banners or some extra buttons available in our Game only for iPhone 5). </p>
 How to configure AspectJ with Load Time Weaving without Interface <p>On my project, I currently use AspectJ (not just Spring AOP due to some limitation) with the weaving at the Compile Time. In order to speed up the development on Eclipse, I want to do the weaving at the Load Time. I succeed to do that but with one major constraint: using an interface for my service that contained some transactional methods. <strong>If I declare the service with its implementation instead of its interface, in the caller class, there is no weaving and so no transaction supported.</strong></p>

<p>So <strong>if it is supported by AspectJ, how to configure AspectJ with Load Time Weaving without Interface ?</strong></p>

<p>I created a little project that reproduce the issue:</p>

<p>The following test fail.</p>

<p>The following test succeed if :</p>

<ul>
<li><p>the injected service is declared with its interface instead of its implementation (i.e. replace "@Inject MyServiceImpl service" by "@Inject MyService service"), the test succeed.</p></li>
<li><p>the weaving is executed during the compilation (the configuration, POM &amp; Spring application context, is obviously different in this case). But my goal is to do the weaving at the Load-Time to avoid a weaving phase every time I save a Java file.</p></li>
<li><p>Spring AOP (tx:annotation-driven mode="proxy"), that is a proxy-based solution, is used instead of AspectJ. But in this case, we encountered the self-invocation issue, i.e. a method within the target object calling some other method of the target object, won’t lead to an actual transaction at runtime even if the invoked method is marked with @Transactional.</p></li>
</ul>

<p>aspectj-ltw/src/test/java/mycompany/aspectj_ltw/MyServiceImplTest.java</p>

<pre><code>package mycompany.aspectj_ltw;

import static junit.framework.Assert.assertTrue;

import javax.inject.Inject;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = { "classpath:/META-INF/spring/applicationContext.xml" })
public class MyServiceImplTest {

    @Inject
    MyServiceImpl service;

    @Test
    public void shouldBeExecutedInTransaction() {
        assertTrue(this.service.isExecutedInTransaction());
    }
}
</code></pre>

<p>aspectj-ltw/src/main/java/mycompany/aspectj_ltw/MyService.java</p>

<pre><code>package mycompany.aspectj_ltw;

public interface MyService {

    boolean isExecutedInTransaction();

}
</code></pre>

<p>aspectj-ltw/src/main/java/mycompany/aspectj_ltw/MyServiceImpl.java</p>

<pre><code>package mycompany.aspectj_ltw;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionSynchronizationManager;

@Service
public class MyServiceImpl implements MyService {

    @Transactional
    public boolean isExecutedInTransaction() {
        return TransactionSynchronizationManager.isActualTransactionActive();
    }

}
</code></pre>

<p>aspectj-ltw/src/test/resources/META-INF/applicationContext.xml</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:aop="http://www.springframework.org/schema/aop" xmlns:context="http://www.springframework.org/schema/context"
    xmlns:jee="http://www.springframework.org/schema/jee" xmlns:tx="http://www.springframework.org/schema/tx"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd   http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd   http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd   http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-3.0.xsd   http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd"&gt;

    &lt;context:component-scan base-package="mycompany.aspectj_ltw" /&gt;

    &lt;context:load-time-weaver aspectj-weaving="on" /&gt;
    &lt;aop:config proxy-target-class="true"/&gt;
    &lt;aop:aspectj-autoproxy proxy-target-class="true"/&gt;
    &lt;tx:annotation-driven mode="aspectj"
        transaction-manager="transactionManager" proxy-target-class="true" /&gt;

    &lt;bean class="org.apache.commons.dbcp.BasicDataSource"
        destroy-method="close" id="dataSource"&gt;
        &lt;property name="driverClassName" value="org.h2.Driver" /&gt;
        &lt;property name="url" value="jdbc:h2:mem:mydb" /&gt;
        &lt;property name="username" value="sa" /&gt;
        &lt;property name="password" value="" /&gt;
    &lt;/bean&gt;
    &lt;bean class="org.springframework.jdbc.datasource.DataSourceTransactionManager"
        id="transactionManager"&gt;
        &lt;property name="dataSource" ref="dataSource" /&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>

<p>aspectj-ltw/src/test/resources/META-INF/aop.xml</p>

<pre><code>&lt;!DOCTYPE aspectj PUBLIC
        "-//AspectJ//DTD//EN" "http://www.eclipse.org/aspectj/dtd/aspectj.dtd"&gt;
&lt;aspectj&gt;
  &lt;weaver options="-showWeaveInfo -debug -verbose -XmessageHandlerClass:org.springframework.aop.aspectj.AspectJWeaverMessageHandler"&gt;
        &lt;include within="mycompany.aspectj_ltw..*"/&gt;
  &lt;/weaver&gt;
&lt;/aspectj&gt;
</code></pre>

<p>aspectj-ltw\pom.xml</p>

<pre><code>&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;mycompany&lt;/groupId&gt;
    &lt;artifactId&gt;aspectj-ltw&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;jar&lt;/packaging&gt;
    &lt;name&gt;aspectj-ltw&lt;/name&gt;

    &lt;properties&gt;
        &lt;spring.version&gt;3.0.5.RELEASE&lt;/spring.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;junit&lt;/groupId&gt;
            &lt;artifactId&gt;junit&lt;/artifactId&gt;
            &lt;version&gt;4.8.2&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-core&lt;/artifactId&gt;
            &lt;version&gt;${spring.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;
            &lt;version&gt;${spring.version}&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-aop&lt;/artifactId&gt;
            &lt;version&gt;${spring.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;
            &lt;version&gt;${spring.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-tx&lt;/artifactId&gt;
            &lt;version&gt;${spring.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
            &lt;artifactId&gt;aspectjrt&lt;/artifactId&gt;
            &lt;version&gt;1.7.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
            &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;
            &lt;version&gt;1.7.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;javax.inject&lt;/groupId&gt;
            &lt;artifactId&gt;javax.inject&lt;/artifactId&gt;
            &lt;version&gt;1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;cglib&lt;/groupId&gt;
            &lt;artifactId&gt;cglib-nodep&lt;/artifactId&gt;
            &lt;version&gt;2.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;commons-dbcp&lt;/groupId&gt;
            &lt;artifactId&gt;commons-dbcp&lt;/artifactId&gt;
            &lt;version&gt;1.4&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${spring.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.h2database&lt;/groupId&gt;
            &lt;artifactId&gt;h2&lt;/artifactId&gt;
            &lt;version&gt;1.2.143&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
            &lt;artifactId&gt;logback-core&lt;/artifactId&gt;
            &lt;version&gt;0.9.24&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
            &lt;version&gt;0.9.24&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;log4j-over-slf4j&lt;/artifactId&gt;
            &lt;version&gt;1.6.1&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;forkMode&gt;always&lt;/forkMode&gt;
                    &lt;argLine&gt;
                        -javaagent:C:/maven-2_local_repo/org/springframework/spring-instrument/3.0.5.RELEASE/spring-instrument-3.0.5.RELEASE.jar
                    &lt;/argLine&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
</code></pre>

<p>VM arguments to run the test:</p>

<pre><code>-javaagent:C:/maven-2_local_repo/org/springframework/spring-instrument/3.0.5.RELEASE/spring-instrument-3.0.5.RELEASE.jar
</code></pre>
 How do I resize a Silverlight 3 application and all child controls and keep aspect ratio <p>Hi<br>
I'm building a Silverlight 3 application and I would like it to resize depending on the size of the web browser.</p>

<p>I have found   <a href="http://community.irritatedvowel.com/blogs/pete%5Fbrowns%5Fblog/archive/2008/07/04/How-to-Resize-a-Silverlight-2-App-and-Keep-the-Same-Aspect-Ratio.aspx" rel="nofollow">http://community.irritatedvowel.com/blogs/pete%5Fbrowns%5Fblog/archive/2008/07/04/How-to-Resize-a-Silverlight-2-App-and-Keep-the-Same-Aspect-Ratio.aspx</a>  </p>

<p>But the solution suggested doesn't seem to work on silverlight 3 (one of my child controls disappears off the screen when I resize).</p>

<p>Any suggestions?</p>

<p>/Jimmy</p>
 Django: What exactly are signals good for? <p>I have a tough time understanding how signals work into my application (and how they work period). These are three areas where I assume they would apply (with my current knowledge):</p>

<ol>
<li>Send XML to a remote server for reporting (after a transaction is complete).</li>
<li>Re size an image and upload the thumbnail to S3 after a user uploads it.</li>
<li>Delete old images from S3 after a user deletes an image object from his account.</li>
</ol>

<p>Am I totally off base (I feel I might be). <strong>Am I getting signals and multi threading mixed up</strong>? If so, do they compare in there application? Are they only for decoupling? Also, what's the deal with making sure you instantiate them early and don't use a local function (because they'll get garbage collected)? Can someone elaborate on that? Should I put them all in request Middleware so that I don't have to worry?</p>
 Calculate Height for Image/Video based on Aspect Ratio and Width <p>I have a width: 240
I have aspect ratio: 2.40
I need to get the height based on those two variables.  What's the formula?</p>
 Handling different screen resolutions for background images in Android? <p>My Android app (a text-based games) uses background images a lot in order to provide a better visual ambience. For example, if the action in the game takes you into a tavern, then you get a background image of a tavern in the game. This is a vast improvement, graphically, over the boring black background that you would otherwise get.</p>

<p>It is also a problem, however, since android:background always stretches to the dimensions of the screen. The result is that the background images look very bad if the player swithces between portrait and landscape mode. And to make matters worse, many devices have very different aspect rations (e.g., 320x480 mdpi, 480x800 hdpi, and 480x852 hdpi) and even more variations are coming.</p>

<p>How do others solve this problem? Having individual images for the main resolutions/orientations is not an option for me, as this would result in the apk growing too large.</p>
 AspectJ: How to get pointcuts to advise classes located in other projects <p>This should be simple.</p>

<p><strong>Question</strong><bR>
How do you get a pointcut in one project to advise the code/classes within another project?
<hr>
<strong>Context</strong><br>
I'm working in eclipse with two projects.  For ease of explanation, let's call one <strong><em>science project</em></strong> and the other <strong><em>math project</em></strong> and say the science project relies on the math project and I'm developing in both projects, concurrently.  The math project is a core product, in production, and life will be easier if I don't modify the code much.</p>

<p>Currently, I'm debugging the interaction between these two projects. To assist with that, I'm writing an Aspect (within the science project) to log key information as the math code (and science code) executes.</p>

<p><hr>
<strong>Example</strong><br>
I running a simple example aspect along the lines of:</p>

<pre><code>package org.science.example;

public aspect ScientificLog {
    public pointcut testCut() : execution (public * *.*(..));
    before() : testCut() {
        //do stuff
    }
}
</code></pre>

<p><hr>
<strong>Problem</strong><br>
The problem is, no matter what pointcut I create, it only advises code from the <em>science project</em>.  No classes from <code>org.math.example</code> are crosscut, AT ALL!<br><br>I tried adding the <em>math project</em> to the <em>inpath</em> of the <em>science project</em> by going to <code>proect properties &gt; AspectJ Build &gt; Inpath</code> and clicking <em>add project</em> and choosing the <em>math project</em>.  That didn't work but it seems like I need to do something along those lines.</p>

<p>Thanks, in advance, for any suggestions...</p>

<p>-gMale
<hr>
EDIT 1:<br>
Since writing this, I've noticed the project is giving the following error:</p>

<pre>Caused by: org.aspectj.weaver.BCException: Unable to continue, this version of AspectJ
supports classes built with weaver version 6.0 but the class
com.our.project.adapter.GenericMessagingAdapter is version 7.0
when batch building BuildConfig[null] #Files=52 AopXmls=#0</pre>

<p>So maybe this is setup properly and the error is more subtle.  BTW, the class mentioned is from the "science project," so to speak.  This happens even after I clean the project.  I'm currently googling this error...<hr>
EDIT 2: <br>
I found the solution to the error above in
<a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=321280#c5" rel="nofollow">comment #5 here</a></p>

<p>The problem is the maven-aspectj-plugin's pom file declares a dependency on aspectjtools version 1.6.7. So, when configuring the plugin, that transient dependency has to be modified. Here's the related code snippet for the pom file that fixes the problem by specifying version 1.6.9 instead of 1.6.7:</p>

<pre><code>                    &lt;plugin&gt;
                            &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
                            &lt;artifactId&gt;aspectj-maven-plugin&lt;/artifactId&gt;
                            &lt;version&gt;1.3&lt;/version&gt;
                            &lt;dependencies&gt;
                                &lt;dependency&gt;
                                    &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
                                    &lt;artifactId&gt;aspectjtools&lt;/artifactId&gt;
                                    &lt;version&gt;1.6.9&lt;/version&gt;
                                &lt;/dependency&gt;
                            &lt;/dependencies&gt;
                            &lt;configuration&gt;
                                    &lt;source&gt;1.6&lt;/source&gt;
                                    &lt;target&gt;1.6&lt;/target&gt;
                            &lt;/configuration&gt;
                            &lt;executions&gt;
                                    &lt;execution&gt;
                                            &lt;goals&gt;
                                                    &lt;goal&gt;compile&lt;/goal&gt;
                                                    &lt;goal&gt;test-compile&lt;/goal&gt;
                                            &lt;/goals&gt;
                                    &lt;/execution&gt;
                            &lt;/executions&gt;
                    &lt;/plugin&gt;
</code></pre>
 Is there any way to get rid of these spring/aspectj warnings when building the project? <p>I've frequently put up with this for a long time, but I'm a little worried that it's slowing my build process down now. There are a good few seconds that are taken up as Spring/AspectJ reports these warnings. I'd rather try and make the cleanest build possible, even if it doesn't end up speeding it up.</p>

<p>Here are the warnings:</p>

<pre><code>Found @DeclareAnnotation while current release does not support it (see 'org.aspectj.weaver.bcel.AtAjAttributes')
advice defined in org.springframework.orm.jpa.aspectj.JpaExceptionTranslatorAspect has not been applied [Xlint:adviceDidNotMatch]
advice defined in org.springframework.mock.staticmock.AnnotationDrivenStaticEntityMockingControl has not been applied [Xlint:adviceDidNotMatch]
advice defined in org.springframework.mock.staticmock.AbstractMethodMockingControl has not been applied [Xlint:adviceDidNotMatch]
advice defined in org.springframework.scheduling.aspectj.AbstractAsyncExecutionAspect has not been applied [Xlint:adviceDidNotMatch]
</code></pre>

<p>I'm sure if you've used spring, you've seen these. Any way to get rid of them?</p>
 How to make a resolution independent camera preview on android? <p>I'm making an android 1.6 app that uses phone's camera.</p>

<p>In order to do this app resolution independent, I need to set a compatible aspect ratio for previewing camera on a SurfaceLayout. In 1.6 sdk there is no way to get supported sizes for the camera preview. It is possible to use a 4:3 or 3:2 aspect ratio and get no errors whith that?</p>

<p>On the other hand, I need a way to make a xml layout that represents this Surfacelayout in this (unknown) aspect ratio in every resolution. I assume that is not possible to change the SurfaceLayout size in runtime. Can I do it with "dp" units? The other way is making this layout programmatically?</p>

<p>There are some apps like Vignette or android camera application with some tricks to make something like that, like black bars (vignette) or fixed buttons bar, but I don't know how to do it in any kind of resolution.</p>

<p>Any ideas?</p>

<p>Thanks!</p>
 Is there any attribute relating to AJAX to be set for ASP.NET MVC controller actions? <p>I want to use partial views with AJAX calls in ASP.NET MVC, and this is the first time I'm using it. I just searched to see if there is anything special I should know beforehand, and one of'em that I'm curious about, is to see if there is any special attribute that should be set or is related to AJAX calls? Something like <code>[ChildActionOnly]</code> or <code>[HttpGet]</code></p>
 Objective C: How to fix aspect ratio of image (and not change to fit imageview frame) <p>I am using the UIImagePickerController to select images for my app. However I am facing some challenges with regards to maintaining aspect ratio of the selected images</p>

<p>For example,</p>

<p>I have a raw image on the phone as follows (not square image):</p>

<p><img src="http://i.stack.imgur.com/K1GxM.png" alt="enter image description here"></p>

<p>After selecting the image on iphone via the 'move and scale' page to crop image, the result is as follows: (aspect ratio is still maintained here)</p>

<p><img src="http://i.stack.imgur.com/JNyr9.png" alt="enter image description here"></p>

<p>My app will display the selected image in a UIImageView with a square frame (200 x 200). After setting the selected image to the UIImageView (UIImageView.image = selectedImage), the image's aspect ratio is not maintained but instead followed the frame of the UIImageView: (The image looks skewed now in my UIImageView):</p>

<p><img src="http://i.stack.imgur.com/PKPTj.png" alt="enter image description here"></p>

<p>Is there any way to maintain the aspect ratio of the image in this case?</p>

<p>EDIT: Update expected result</p>

<p>After some thinking, I realize that the best way to resolve my issue is to ensure that for such images (non square), I need to 'convert' them into square images i.e. fill the empty spaces on top and bottom of images to make a square e.g.</p>

<p>Expected image: (with the top and bottom borders added)</p>

<p><img src="http://i.stack.imgur.com/bDCKS.png" alt="enter image description here"></p>

<p>EDIT: Update with sample code</p>

<pre><code>- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingImage:(UIImage *)img editingInfo:(NSDictionary *)editInfo 
{

    self.imageView.contentMode = UIViewContentModeScaleAspectFill;

    self.imageView.image = image;
    [[picker parentViewController] dismissModalViewControllerAnimated:YES];

    //Compress image
    UIImage *image = [self scaleImage:img toSize:CGSizeMake(612.0,612.0)];

    self.imageData = UIImageJPEGRepresentation(image, 0.75);
}
</code></pre>

<p>By adding the code "self.imageView.contentMode = UIViewContentModeScaleAspectFill;", I was able to obtain the square image in the uiimageview</p>

<p><img src="http://i.stack.imgur.com/Ghk1k.png" alt="enter image description here"></p>

<p>But it seems like the original image was still not a square image, hence the skewing problem will still occur when I do "UIImage *image = [self scaleImage:img toSize:CGSizeMake(612.0,612.0)];". Is my assumption correct? Anyway to mitigate this issue as I will still need to display the 'compressed' image elsewhere in the app.</p>
 Fixed aspect ratio View <p>How would I go implementing a fixed aspect ratio <code>View</code>? I'd like to have items with 1:1 aspect ratio in a <code>GridView</code>. I think it's better to subclass the children than the <code>GridView</code>?</p>

<p>EDIT: I assume this needs to be done programmatically, that's no problem. Also, I don't want to limit the size, only the aspect ratio.</p>
 DrawFocusRect with given aspect ratio in Delphi <p>I want to be able to draw a FocusRect on an image, which keeps the aspect ratio of the image. My problem is, that the FocusRect only depends on the y coordinates of the mouse. I just don't know how to let the rectangle depent on both mouse coordinates...
This is my code:</p>

<pre><code>procedure TForm1.AuswahlRechteck; //Due to this procedure it doesn't matter in which corner the rectangle begins
begin                                                                           
  Image1.Canvas.DrawFocusRect(Rect(X0,Y0,MX,MY));
  Image1.Canvas.DrawFocusRect(Rect(X0,MY,MX,Y0));
  Image1.Canvas.DrawFocusRect(Rect(MX,MY,X0,Y0));
  Image1.Canvas.DrawFocusRect(Rect(MX,Y0,X0,MY));
end;

procedure TForm1.Image1MouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
  X0:=X;
  MX:=X;
  Y0:=Y;
  MY:=Y;
  AuswahlRechteck;
  InMove:=true;
end;

procedure TForm1.Image1MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if InMove then
  begin
    AuswahlRechteck;
    MY:=Y;
    MX:=X;
    if (((MX &lt; X0) AND (MY &gt; Y0)) OR ((MX &gt; X0) AND (MY &lt; Y0))) then MX:=Round(X0-((MY-Y0)*Image1.Width/Image1.Height))
    else MX:=Round(X0+((MY-Y0)*Image1.Width/Image1.Height));    
    AuswahlRechteck;
  end;
end;
</code></pre>

<p>Could someone help me please?</p>

<p>Henry</p>
 Autowired dependency not injected in Aspect in Spring MVC <p>I am not able to <code>@Autowire</code> the Service Layer Instance in Aspect. In Aspect the reference to the <code>@Autowired</code> bean is NULL and it throws <code>NullPointerException</code>. Any help will be much appreciated. I think, I messed up with configuration.</p>

<p>Following is my <code>servlet-context.xml</code>:</p>

<pre><code>&lt;!-- Activates various annotations to be detected in bean classes --&gt;
&lt;context:annotation-config /&gt;
&lt;context:spring-configured /&gt;       

&lt;!-- Scans the classpath of this application for @Components to deploy as beans --&gt;
&lt;context:component-scan base-package="xx.yy" /&gt;

&lt;!--  an @AspectJ aspect will be interpreted as an aspect by Spring AOP and beans in the context will be advised accordingly --&gt;
&lt;aop:aspectj-autoproxy /&gt;

&lt;beans:bean id="loggingAspect" class="xx.yy.aop.aspects.LoggingAspect" /&gt;
&lt;beans:bean id="authenticationAspect" class="xx.yy.aop.aspects.AuthenticationAspect" /&gt;

&lt;!-- Enables the Spring MVC @Controller programming model --&gt;
&lt;annotation-driven /&gt;
</code></pre>

<p>Following is my Aspect:</p>

<pre><code>@Configurable
@Component
@Aspect
public class AuthenticationAspect {
private static final Logger logger = LoggerFactory.getLogger(AuthenticationAspect.class);

@Autowired
private LoginService loginService;

    //.... 
}
</code></pre>

<p>Here is my controller using the <code>@Authentication</code> Annotation defined above:</p>

<pre><code>@Controller
@RequestMapping("/user")
public class UsersController {

@Autowired
private UserService userService;

@Authenticate
@RequestMapping(value="/{userId}/profile", method=RequestMethod.GET)    
public String displayUser(WebRequest webRequest, @PathVariable("userId") String userId, Model model) {
    User user = userService.findUser(Long.valueOf(userId));  
    model.addAttribute("user", user);
    model.addAttribute("AccordionMenuTab","5");
    model.addAttribute("selectedLink","profile");
    return "profile";
}
</code></pre>

<p>I am getting following exception:</p>

<pre><code>Oct 8, 2011 3:12:48 AM org.apache.catalina.core.StandardWrapperValve invoke
SEVERE: Servlet.service() for servlet appServlet threw exception
java.lang.NullPointerException
    at xx.yy.controller.UsersController.displayUser_aroundBody1$advice(UsersController.java:28)
    at xx.yy.controller.UsersController.displayUser(UsersController.java:1)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
    at java.lang.reflect.Method.invoke(Method.java:597)
    at org.springframework.web.bind.annotation.support.HandlerMethodInvoker.invokeHandlerMethod(HandlerMethodInvoker.java:176)
    at org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter.invokeHandlerMethod(AnnotationMethodHandlerAdapter.java:426)
    at org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter.handle(AnnotationMethodHandlerAdapter.java:414)
    at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:790)
    at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:719)
    at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:644)
    at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:549)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:617)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)
    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)
    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
    at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)
    at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)
    at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)
    at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)
    at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)
    at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)
    at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:859)
    at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588)
    at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)
    at java.lang.Thread.run(Thread.java:662)
</code></pre>
 Spring AOP vs AspectJ startup perf/memory reqs <p>I am trying to improve the startup performance for our wars, since we are essentially hosting a services based backend where we have around 50+ wars (one for each service).  Deployment of all these services at once sometimes causes PermGen and also the restarting of the server can take quite awhile.  So I am trying to evaluate all the possibilities of the architecture (WLS, Spring, Hibernate, CXF) for performance gains.</p>

<p>All our transactions are done through Spring AOP and some of our SLA/Policies utilize AOP Pointcuts. </p>

<p>I have seen some cases where our Spring AOP pointcuts were either poorly created or we had to many that would cause JUnits to PermGen.  Where it appears like much of the startup time is the creation of the pointcuts and retrieval of the pointcut objects (so I merged some of our custom Pointcut/Interceptor classes into a single class and single Pointcut, which reduced the amount of Pointcuts created at startup by about 30%).</p>

<p>Is it worth converting all of this to AspectJ (which I haven't used before) in order to get some benefits out of compile time weaving?  Would this provide better speed for startup performance as well as memory usage?</p>

<p>I have looked at the posts:</p>

<p><a href="http://stackoverflow.com/questions/4690860/spring-aop-slow-startup-time">Spring AOP slow startup time</a></p>

<p><a href="http://stackoverflow.com/questions/1606559/spring-aop-vs-aspectj">Spring AOP vs AspectJ</a></p>

<p>And I am definitely looking purely from a way to take the load off of the startup and memory requirements, and only want to make an attempt to migrate if it is worth the effort.</p>
 Capturing View.setOnClickListener() defined through XML <p>I'm using AspectJ with Android and I'm successfully capturing calls to <code>View.setOnClickListener()</code> with this aspect:</p>

<pre><code>public aspect Test {

    pointcut callPointcut(View view, OnClickListener listener) : call(void View.setOnClickListener(OnClickListener)) &amp;&amp; target(view) &amp;&amp; args(listener);

    @SuppressAjWarnings // Exported advice
    before(View view, OnClickListener listener) : callPointcut(view, listener)
    {
        Log.d("AspectJ", "Attempt to set onClick listener on view " + Integer.toHexString(view.getId()));
        Log.d("AspectJ", "Aspect has executed.");
        Log.d("AspectJ", listener.toString());
    }
}
</code></pre>

<p>Unfortunately, this does not capture listeners set up with <code>android:onClick</code> in the layout XML. Is there any way to capture this?</p>
 Defining two layouts for two aspect ratios (4:3 and 16:9) <p>Following <a href="http://msdn.microsoft.com/en-us/library/windows/apps/hh780612.aspx" rel="nofollow">the Microsoft scale guidelines</a> there is a part where it says:</p>

<blockquote>
  <p>When designing a fixed layout, start by designing your layout for the baseline resolutions: 1024x768 and 1366x768. </p>
</blockquote>

<p>Is it possible to define two layouts for two aspect ratios (to use with the <code>ViewBox</code>) so they can change automatically depending on the screen's aspect ratio (and maybe change between the fill mode and full screen mode) ?</p>
 How to define / configure priority for multiple aspects using Spring AOP (or AspectJ) <p>I have been able to define multiple aspects (one is @Before and another is @Around) using Spring AOP (combined with AspectJ annotations) over a business service class.</p>

<p>Currently they are getting called one by one (in sequence). However I would like to know how the priority of calling the aspects can be defined and where.</p>

<p>Please guide me with respect to Spring AOP. Please note that I am using Spring 2.5.3 framework.</p>

<p>Thanks in advance.</p>
 Autowiring Unmanaged Beans Annotated With @Component <p>I want to use @AutoWired to inject a non-managed bean configured with @Component into a managed bean.  I'm pretty sure I have the configuration right, but for some reason I keep getting the exception:</p>

<pre><code>No unique bean of type [foo.Baz] is defined: Unsatisfied dependency of type [class foo.Baz]: expected at least 1 matching bean
</code></pre>

<p>Based on the error, I'm guessing it's not able to find the Baz class, but I'm not sure why.  It's my understanding that the context:spring-configured element in the XML config was supposed to allow me to do this.  I also made sure to include the appropriate jar files (spring-weaving.jar and aspectjweaver.jar).</p>

<p>Here's a simple example of my set up.</p>

<p>My XML config:</p>

<pre><code>&lt;beans ...&gt;
    ...

    &lt;context:annotation-config/&gt;
    &lt;context:spring-configured/&gt;
    &lt;context:component-scan base-package="foo"/&gt;

    &lt;bean id="bar" class="foo.Bar"/&gt;
    ...
&lt;/beans&gt;
</code></pre>

<p>I have one managed bean:</p>

<pre><code>package foo;

public class Bar {

    @Autowired
    private Baz baz;

    public void setBaz(Baz baz) {
        this.baz = baz;
    }

    ...
}
</code></pre>

<p>And one unmanaged bean:</p>

<pre><code>package foo;

@Component
public class Baz {
    ...
}
</code></pre>

<p>Is there something I'm missing?</p>

<p><em>EDIT</em>: The log lists the beans its instantiating, and foo.Baz isn't one of them.  I don't know why it's not picking up the @Component annotated class.</p>
 Trouble configuring AspectJ LTW with Tomcat and Spring <p>I'm having some problems getting load-time weaving to work with Spring in my Tomcat 6 webapp. I only want to use it for transactions (so that self-invocation respects transactional annotations, which it doesn't with AOP proxying). It appears that the weaver is being loaded, but my annotated classes aren't actually being woven. When I step through my code, I don't see any transaction boundaries in SQL logs, as I was seeing with regular AOP proxy configuration. Here's my setup:</p>

<p>In server.xml:</p>

<pre><code>&lt;Context path="/api" allowLinking="true" reloadable="false" docBase="/usr/local/apache-tomcat-6.0.18/webapps/API/ROOT" workDir="/usr/local/apache-tomcat-6.0.18/webapps/API/ROOT/work"&gt;
  &lt;Loader loaderClass="org.springframework.instrument.classloading.tomcat.TomcatInstrumentableClassLoader"/&gt;
&lt;/Context&gt;
</code></pre>

<p>I've got spring-tomcat-weaver.jar tomcat/lib directory, and the following jars on my Tomcat classpath:</p>

<p>tomcat/webapps/API/ROOT/WEB-INF/lib/aspectjweaver.jar
tomcat/webapps/API/ROOT/WEB-INF/lib/spring-aspects.jar</p>

<p>This is in the bean config file where the annotated service classes are defined:</p>

<pre><code>&lt;tx:annotation-driven transaction-manager="txManager" mode="aspectj"/&gt;
</code></pre>

<p>In one of the many other bean config files in my context:</p>

<pre><code>&lt;aop:aspectj-autoproxy&gt;
  &lt;aop:include name="methodTimer"/&gt;
&lt;/aop:aspectj-autoproxy&gt;


&lt;context:load-time-weaver aspectj-weaving="on"/&gt;
&lt;context:annotation-config /&gt;

&lt;bean name="methodTimer" class="tv.current.web.aop.MethodTimer" /&gt;
</code></pre>

<p>I want MethodTimer to use regular AOP proxying, not LTW - LTW should only apply to @Transactional annotations. As described here: <a href="http://static.springsource.org/spring/docs/2.5.x/reference/aop.html#aop-aj-configure" rel="nofollow">http://static.springsource.org/spring/docs/2.5.x/reference/aop.html#aop-aj-configure</a>. If I comment out <code>&lt;aop:aspectj-autoproxy&gt;</code> element, I don't get any of the weaving info log messages I see otherwise. Speaking of which, here they are; you can see that aspects are getting loaded but nothing is actually being woven:</p>

<pre><code>Aug 28, 2009 6:34:42 PM org.apache.catalina.core.ApplicationContext log
INFO: Initializing Spring root WebApplicationContext
[TomcatInstrumentableClassLoader@34fe7e0e] info AspectJ Weaver Version 1.6.5 built on Thursday Jun 18, 2009 at 03:42:32 GMT
[TomcatInstrumentableClassLoader@34fe7e0e] info register classloader org.springframework.instrument.classloading.tomcat.TomcatInstrumentableClassLoader@34fe7e0e
[TomcatInstrumentableClassLoader@34fe7e0e] info using configuration file:/usr/local/apache-tomcat-6.0.18/webapps/API/ROOT/WEB-INF/lib/spring-aspects.jar!/META-INF/aop.xml
[TomcatInstrumentableClassLoader@34fe7e0e] warning ignoring duplicate definition: jar:file:/usr/local/apache-tomcat-6.0.18/webapps/API/ROOT/WEB-INF/lib/spring-aspects.jar!/META-INF/aop.xml
[TomcatInstrumentableClassLoader@34fe7e0e] info register aspect org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect
[TomcatInstrumentableClassLoader@34fe7e0e] info register aspect org.springframework.transaction.aspectj.AnnotationTransactionAspect
[TomcatInstrumentableClassLoader@34fe7e0e] info processing reweavable type org.springframework.beans.factory.aspectj.AbstractInterfaceDrivenDependencyInjectionAspect$ConfigurableDeserializationSupport: org/springframework/beans/factory/aspectj/AbstractInterfaceDrivenDependencyInjectionAspect.aj
[TomcatInstrumentableClassLoader@34fe7e0e] info successfully verified type org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect exists.  Originates from org/springframework/beans/factory/aspectj/D:\projects\spring\spring\aspectj\src\org\springframework\beans\factory\aspectj\AnnotationBeanConfigurerAspect.aj
[TomcatInstrumentableClassLoader@34fe7e0e] info successfully verified type org.springframework.beans.factory.aspectj.AbstractInterfaceDrivenDependencyInjectionAspect exists.  Originates from org/springframework/beans/factory/aspectj/D:\projects\spring\spring\aspectj\src\org\springframework\beans\factory\aspectj\AbstractInterfaceDrivenDependencyInjectionAspect.aj
[TomcatInstrumentableClassLoader@34fe7e0e] weaveinfo Type 'org.springframework.beans.factory.aspectj.AbstractInterfaceDrivenDependencyInjectionAspect$ConfigurableDeserializationSupport' (AbstractInterfaceDrivenDependencyInjectionAspect.aj) has intertyped method from 'org.springframework.beans.factory.aspectj.AbstractInterfaceDrivenDependencyInjectionAspect' (D:\projects\spring\spring\aspectj\src\org\springframework\beans\factory\aspectj\AbstractInterfaceDrivenDependencyInjectionAspect.aj:'java.lang.Object org.springframework.beans.factory.aspectj.AbstractInterfaceDrivenDependencyInjectionAspect$ConfigurableDeserializationSupport.readResolve()')
</code></pre>

<p>As you can see from the logs, I don't have my own aop.xml file, I am using the default one in spring-aspects.jar, which is as follows:</p>

<pre><code>&lt;aspectj&gt;

    &lt;!--
    &lt;weaver options="-showWeaveInfo"/&gt;
    --&gt;

    &lt;aspects&gt;
      &lt;aspect name="org.springframework.beans.factory.aspectj.AnnotationBeanConfigurerAspect"/&gt;
      &lt;aspect name="org.springframework.transaction.aspectj.AnnotationTransactionAspect"/&gt;
    &lt;/aspects&gt;

&lt;/aspectj&gt;
</code></pre>

<p>I don't need to start Tomcat with <code>-javaagent:/path/to/spring-agent.jar</code>, correct? Because I specified the right ClassLoader in server.xml and am seeing the loader getting used. Am I mistaken about this? Do I need spring-agent.jar anywhere, either in tomcat/lib or my tomcat classpath? Do I need aspectjweaver.jar in tomcat/lib? What else am I missing? Any help would be greatly appreciated as I have been wrestling with this for almost two days now.</p>

<p>Edit: One more (perhaps very important) detail I omitted - I'm developing in Eclipse and using the Sysdeo Tomcat Plugin to start Tomcat. Will try starting Tomcat from the command line and see if that makes a difference...</p>
 How can I use a singleton class in AOP (aspect oriented programming)? <p>Language by choice is AspectJ but I am open for a generic answer.</p>
 
dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy dynamicproxy Castle DynamicProxy - Failure when creating proxy involving a GTP used as a GTR <p>OK, now I'm really confused.</p>

<p>I originally had <a href="http://stackoverflow.com/questions/4382624/cant-get-rhinomocks-to-emit-a-mock-that-follows-the-generic-type-restriction-ru">this problem</a>, which is, according to posters, an issue with the version of Castle.DynamicProxy that's ILMerged into the latest Rhino.Mocks library. It has, according to several authorities on the subject, been fixed in the latest Castle, but that library has not made it into a new Rhino.Mocks. Most people are saying "just download the Rhino source and the latest Castle and build your own version".</p>

<p>So, I did exactly that; I grabbed a ZIP of the Rhino trunk source from Ayende's GitHub, opened it up, and built it. Then, like a good little TDDer, I created a unit test to make sure my changes worked (because the latest Castle folds DynamicProxy into Core, requiring some significant referencing changes):</p>

<pre><code>    [Test]
    public void MockOfInterfaceMethodWithInterfaceGTR()
    {
        var mock = mocks.DynamicMock&lt;ITestRestrictedInterface&gt;();
        Assert.NotNull(mock);
        Expect.Call(mock.TestMethod(new Object2())).IgnoreArguments().Return(5);
        mocks.ReplayAll();
        Assert.AreEqual(5, mock.TestMethod(new Object2()));
    }

...

internal interface ITestGenericInterface&lt;TRest&gt; where TRest:IObject1
{
    int TestMethod&lt;T&gt;(T input) where T : TRest;
}

internal interface ITestRestrictedInterface:ITestGenericInterface&lt;IObject2&gt; { }

internal interface IObject1 { }
internal interface IObject2:IObject1 { }

internal class Object2:IObject2 { } 
</code></pre>

<p>The result, when run in my own production code with the latest released Rhino? Failure with the following message: </p>

<blockquote>
  <p>System.TypeLoadException : Method 'TestMethod' on type
  'ITestRestrictedInterfaceProxy83ad369cdf41472c857f61561d434436' from
  assembly 'DynamicProxyGenAssembly2, Version=0.0.0.0, Culture=neutral,
  PublicKeyToken=null' tried to implicitly implement an interface method
  with weaker type parameter constraints.</p>
</blockquote>

<p>...However, when I copy and paste this test into a fixture in the Rhino.Mocks.Tests project, without making any changes to referenced libraries, the test PASSES. I have made zero changes to the downloaded source. I have made ZERO changes to the test method and related interfaces/objects on both sides. I built a new Rhino.Mocks DLL (without IL-merging the Castle libs) and copied it with Castle libs back to my production solution, re-ran the test, and it still fails with the same message.</p>

<p>WTF?</p>
 What are the differences between LinFu.DynamicProxy and Castle.DynamicProxy? <p>I am looking at adding logic to a library I am working on that would require the need for a Dynamic Proxy.  I would like to get some advice from user's who have used these two library's in a production environment.  Does one out perform the other, were there any shortcoming's which made you have to switch to the other, etc.  Basically tell me your experiences with the library's.  The answers will help me decide which one to use.</p>

<p>-- Edit --</p>

<p><hr /></p>

<p>I forgot to mention that the library I am developing will support Mono, therefore any knowledge you can share about the two libraries and their support for Mono would be great also.</p>
 NHibernate.ByteCode.LinFu.dll For NHibernate 3.2 <p>Where can I find the latest version of NHibernate.ByteCode.LinFu.dll that is compiled against NHibernate 3.2?</p>
 Applying AOP <p>I've been using some basic AOP style solutions for cross-cutting concerns like security, logging, validation, etc.  My solution has envolved around <a href="http://www.castleproject.org/container/index.html">Castle Windsor</a> and DynamicProxy.  I've gone down this route because I can apply everything using a Boo based DSL and keep my code clean of Attributes.  I was told at the weekend to have a look at <a href="http://www.postsharp.org/">PostSharp</a> as it's supposed to be a "better" solution.  I've had a quick look at PostSharp, but I've been put off by the Attribute usage.</p>

<p>Has anyone tried both solutions and would care to share their experiences?</p>
 Castle Windsor InternalsVisibleTo Silverlight <p>I'm using Castle Windsor for SL v2.5.1.0. I have it proxy internal classes (the interfaces are public of course, but the implementation is internal, so that the consumer is only aware of the interface).</p>

<p>I'm using the following attributes in my assembly with the internal classes </p>

<pre><code>[assembly: InternalsVisibleTo("Castle.Core, PublicKey=002400000480000094000000060200000024000052534131000400000100010077F5E87030DADCCCE6902C6ADAB7A987BD69CB5819991531F560785EACFC89B6FCDDF6BB2A00743A7194E454C0273447FC6EEC36474BA8E5A3823147D214298E4F9A631B1AFEE1A51FFEAE4672D498F14B000E3D321453CDD8AC064DE7E1CF4D222B7E81F54D4FD46725370D702A05B48738CC29D09228F1AA722AE1A9CA02FB")]
[assembly: InternalsVisibleTo("Castle.Windsor, PublicKey=002400000480000094000000060200000024000052534131000400000100010077F5E87030DADCCCE6902C6ADAB7A987BD69CB5819991531F560785EACFC89B6FCDDF6BB2A00743A7194E454C0273447FC6EEC36474BA8E5A3823147D214298E4F9A631B1AFEE1A51FFEAE4672D498F14B000E3D321453CDD8AC064DE7E1CF4D222B7E81F54D4FD46725370D702A05B48738CC29D09228F1AA722AE1A9CA02FB")]
[assembly: InternalsVisibleTo("DynamicProxyGenAssembly2")]
</code></pre>

<p>In full .NET 4.0 mode, with the .NET 4.0 Castle assemblies, this works fine and my types are proxied OK. In Silverlight, with the Silverlight Castle assemblies, I get:</p>

<pre><code>Type ConsoleApplication4.MyTypeToBeProxied is not public. Can not create proxy for types that are not accessible.
</code></pre>

<p>Also, just in troubleshooting the problem, adding the following seems to make no difference...:</p>

<pre><code>[assembly: InternalsVisibleTo("System.Core, PublicKey=00000000000000000400000000000000")]
[assembly: InternalsVisibleTo("System.Core, PublicKey=" +
"00240000048000009400000006020000002400005253413100040000010001008d56c76f9e8649" +
"383049f383c44be0ec204181822a6c31cf5eb7ef486944d032188ea1d3920763712ccb12d75fb7" +
"7e9811149e6148e5d32fbaab37611c1878ddc19e20ef135d0cb2cff2bfec3d115810c3d9069638" +
"fe4be215dbf795861920e5ab6f7db2e2ceef136ac23d5dd2bf031700aec232f6c6b1c785b4305c" +
"123b37ab")]
</code></pre>

<p>and I've also verified at runtime that the name of the dynamically hosted assembly in SL is still in fact DynamicProxyGenAssembly2.</p>

<p>Any ideas? Thanks.</p>

<p><strong>EDIT</strong>:</p>

<p>I found the problem I think:</p>

<p>Castle for .NET 4.0 has:</p>

<pre><code>private bool IsAccessible(Type target)
{
  //      ....
  return ((target.IsPublic || target.IsNestedPublic) || internalAndVisibleToDynProxy);

}
</code></pre>

<p>in the DefaultProxyBuilder...and SL 4 has</p>

<pre><code>private bool IsAccessible(Type target)
{
    target.IsNested();
    return (target.IsPublic || target.IsNestedPublic);
}
</code></pre>

<p>Is this something that can be fixed in the Castle source? Or do I need to/should I sub-class the DefaultProxyFactory?</p>
 Whats the difference between PostSharp and Castle Dynamic Proxy? <p>Just wondering what the main differences are between these libraries, how they differ in features and functionality.</p>

<p>Hoping for more information than I could find with a Google query...</p>
 Getting underlying type of a proxy object <p>I'm using Castle DynamicProxy and my ViewModels are a proxy, something like this:</p>

<pre>
namespace MyApplication.ViewModels
{
   public class MyViewModel : BaseViewModel, IMyViewModel
   {
   }
}
</pre>

<p>a proxy of my viewmodel looks like this though:</p>

<p>{Name = "IRootViewModelProxyffecb133f590422098ca7c0ac13b8f98" FullName = "IRootViewModelProxyffecb133f590422098ca7c0ac13b8f98"}</p>

<p>I want to get the actual type or namespace of the actual type that is being proxied. Is there any way to do this? I want something that returns MyApplication.ViewModels.MyViewModel type. If I'm using concreate class as proxies, BaseType returns the actual class that is being proxied, but when using the interface, BaseType would return System.Object.</p>
 Castle DynamicProxy : How to Proxy Equals when proxying an interface? <p>I need to use Castle DynamicProxy to proxy an interface by providing an instance of it to ProxyGenerator.CreateInterfaceProxyWithTarget. I also need to make sure that calls to Equals, GetHashCode and ToString hits the methods on the concrete instance, that I am passing, and I can't get that to work. </p>

<p>In other words, I'd like this small sample to print <code>True</code> twice, while in fact it prints <code>True,False</code>:</p>

<pre><code>using System;
using Castle.Core.Interceptor;
using Castle.DynamicProxy;

public interface IDummy
{
    string Name { get; set; }
}

class Dummy : IDummy
{
    public string Name { get; set; }

    public bool Equals(IDummy other)
    {
        if (ReferenceEquals(null, other)) return false;
        if (ReferenceEquals(this, other)) return true;
        return Equals(other.Name, Name);
    }

    public override bool Equals(object obj)
    {
        return Equals(obj as IDummy);
    }      
}

class Program
{
    static void Main(string[] args)
    {
        var g = new ProxyGenerator();
        IDummy first = new Dummy() {Name = "Name"};
        IDummy second = new Dummy() {Name = "Name"};
        IDummy firstProxy = g.CreateInterfaceProxyWithTarget(first, new ConsoleLoggerInterceptor());
        IDummy secondProxy = g.CreateInterfaceProxyWithTarget(second, new ConsoleLoggerInterceptor());

        Console.WriteLine(first.Equals(second));         
        Console.WriteLine(firstProxy.Equals(secondProxy));
    }
}

internal class ConsoleLoggerInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        Console.WriteLine("Invoked " + invocation.Method.Name);
    }
}
</code></pre>

<p>Is this possible with DynamicProxy ? How ?</p>
 DynamicProxy Generation Speed <p>I'm trying to troubleshoot some startup time concerns. After doing some profiling, I've found the main culprit is ClassProxyGenerator.GenerateCode. This takes 400-600ms per type the first time. So if the entry point to the application has 8 dependencies (in a chain) which need proxies generated, the startup time of the application goes up by 4.8 seconds. This might not seem like a lot, but to a user, it seems like ages.</p>

<p>Any advice for improving this?</p>

<p>Update:</p>

<p>I can reproduce the time with the following console application:</p>

<pre><code>        var container = new WindsorContainer();
        container.Register(Component.For&lt;Interceptor&gt;()); // dummy IInterceptor...does nothing
        container.Register(Component.For&lt;IMyRepository, MyAbstractRepository&gt;().Interceptors&lt;Interceptor&gt;());
        var t = DateTime.Now;
        var instance = container.Resolve&lt;IMyRepository&gt;();
        Debug.WriteLine("Resolved in " + (DateTime.Now - t).TotalMilliseconds);
</code></pre>

<p>Outputs somewhere between 550ms and 750ms.</p>

<p>IMyRepository is a repository interface for 30 entity types (generated by a T4 template). It has 31 IQueryables, 31 Save overloads, and 31 Delete overloads. MyAbstractRepository is a partial abstract class. It declares the same 3 x 31 methods.</p>

<p>If I remove all the save and delete methods and leave just the 31 IQueryables AND don't register the abstract repository </p>

<pre><code>  container.Register(Component.For&lt;IMyRepository&gt;().Interceptors&lt;Interceptor&gt;());
</code></pre>

<p>I still run around 250ms for the initial generation. </p>

<p>This is a very (very very) fast machine...so anything in the real world will likely perform slower than the numbers listed above.</p>
 Why does getting the mocked instance created with Moq throw a System.BadImageFormatException? <p>This question may be related to <a href="http://stackoverflow.com/questions/305345/moq-multi-interface-question">another</a> question and it certainly results with a System.BadImageFormatException. Maybe it's the same thing but exposed differently?</p>

<p>I have the following the code:</p>

<pre><code>public interface IFoo&lt;T&gt; where T : class, new() {
  T FooMethod(object o);
}

public interface IFooRepo {
  F GetFoo&lt;T, F&gt;() where T : class, new() where F : IFoo&lt;T&gt;;
}
</code></pre>

<p>Then I have a test that mocks IFooRepo using Moq like so:</p>

<pre><code>var instance = new Mock&lt;IFooRepo&gt;().Object;
</code></pre>

<p>The above code runs fine except when debugging the test with Visual Studio 2008. When I step over the above line a System.BadImageFormatException is thrown from System.Reflection.Emit via Castle.DynamicProxy. Could this be similar to <a href="http://groups.google.com/group/RhinoMocks/msg/500daa19f20c9748" rel="nofollow">something</a> Ayende Rahien posted?</p>

<p>Now the workaround is to implement a fake for IFooRepo but I'm curious as to why a bad image is generated for this kind of scenario and is there a fix? Is System.Reflection.Emit buggy? Or am I missing something obvious in my own code?</p>

<p><strong>EDIT</strong>: Posted the incorrect signature for GetFoo(). Corrected the signature to GetFoo&lt;T, F&gt;(), which correctly reproduces the problem. With the GDR installed this problem persists.</p>

<p><strong>EDIT</strong>: It seems that if the constraint on F includes type parameter T BadImageFormatException is raised. But I change it to, say <code>where F : class, new()</code>, then everything works as expected.</p>
 Make object dynamically implement an interface in code <p>I want to make this test pass - anyone got an idea how to do that?</p>

<pre><code>public class Something
{
    public string Name {get; set}
}

public interface IWithId
{
    public Guid Id {get; set}
}

public class IdExtender 
{
    public static Object Extend(object toExtend)
    {
        ...?
    }
}

public class Tests 
{
    [Test]
    public void Should_extend_any_object()
    {
        var thing = new Something { Name = "Hello World!"};
        var extended = IdExtender.Extend(thing);
        Assert.IsTrue(extended is IWithId);
        Assert.IsTrue(extended.Id is Guid);
        Assert.IsTrue(extened.Name == "Hello World!");
    }
}
</code></pre>

<p>I guess something like this could be done with castle dynamic proxy, linfu,etc... but how?</p>
 How to detect if a Type is a generated DynamicProxy without referencing Castle DynamicProxy? <p>I am using castle DynamicProxy and was wondering if there is a way of detecting if a Type is a proxy without referencing Castle DynamicProxy?</p>

<p>So while I am using Castle DynamicProxy as an example I would like code that would work for any in memory generated type.</p>

<pre><code>var generator = new ProxyGenerator();


var classProxy = generator.CreateClassProxy&lt;Hashtable&gt;();
Debug.WriteLine(classProxy.GetType().Is....);


var interfaceProxy = generator.CreateInterfaceProxyWithoutTarget&lt;ICollection&gt;();
Debug.WriteLine(interfaceProxy.GetType().Is....);
</code></pre>

<p>Thanks</p>
 Using dynamic proxy on NHibernate objects <p>I'm trying to use Castle.DynamicProxy2 to cleanup code within NHibernate persisted classes. Here is a simple version of it.</p>

<p>The Pet class:</p>

<pre><code>public class Pet
{
    public int Id { get; set; }
    public string Name { get; set; }
    public int Age { get; set; }
}
</code></pre>

<p>And its mapping file:</p>

<pre><code>&lt;class name="Pet" table="Pet"&gt;
  &lt;id name="Id" column="Id" unsaved-value="0"&gt;
    &lt;generator class="native"/&gt;
  &lt;/id&gt;
  &lt;property name="Name" column="Name"/&gt;
  &lt;property name="Age" column="Age"/&gt;
&lt;/class&gt;
</code></pre>

<p>There is a need to audit instances of the Pet class. Normally, the properties Name and Age would not be auto-properties and would contain logic to record value changes. Now, I'm thinking of using proxies to inject auditing logic within property setters. To do that, I created the Auditor IInterceptor:</p>

<pre><code>public class Auditor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        // Do something to record changes
        invocation.Proceed();
    }
}
</code></pre>

<p>It's simple enough to create an audited instance of the Pet class using Castle.DynamicProxy2.</p>

<pre><code>Pet aPet = proxyGenerator.CreateClassProxy&lt;Pet&gt;(new Auditor());
aPet.Name = "Muffles"; // The Auditor instance would record this.
aPet.Age = 4;          // and this too...
</code></pre>

<p>Now here comes the problem. Since Pet is persisted, the system would need to work on instances of Pet fetched via NHibernate. What I want to happen is that NHibernate to return instances of Pet proxy automatically like so:</p>

<pre><code>// I would imagine an instance of Auditor being created implicitly
ICriteria criteria = session.CreateCriteria(typeof(Pet));
criteria.Add(Expression.Expression.Eq("Name", "Muffles"));

// return a list of Pet proxies instead
// so changes can be recorded.
IList&lt;Pet&gt; result = criteria.List&lt;Pet&gt;();

Pet aPet = result[0];
aPet.Age = aPet.Age + 1;

// I expect this to succeed since the proxy is still a Pet instance
session.Save(aPet);
</code></pre>

<p>I've though of something like this to get around it:</p>

<pre><code>ICriteria criteria = session.CreateCriteria(ProxyHelper.GetProxyType&lt;Pet&gt;());
criteria.Add(Expression.Expression.Eq("Name", "Muffles"));

// use List() instead of List&lt;T&gt;()
// and IList instead of IList&lt;Pet&gt;
IList results = criteria.List();
</code></pre>

<p>where <code>ProxyHelper.GetProxyType&lt;Pet&gt;()</code> would return the cached Pet proxy type. The main disadvantage is that this solution would not work on generic lists (e.g. <code>IList&lt;Pet&gt;</code>). The existing system I'm trying to clean up makes use of them extensively.</p>

<p>So I'm hoping if anyone has any workaround or any insight on whether or not what I'm doing is advisable.</p>

<p>Thanks a million,</p>

<p>Carlos</p>
 Nhibernate does not work after upgrade to version 2.1.2 <p>I recently changes my NHibernate implementation from Version 2.1.0 to 2.1.2. For lazy loading I used the LinFu implementation using : NHibernate.ByteCode.Linfu.</p>

<p>Since I changed to the newest version I got the following error:</p>

<pre><code> [SecurityException: That assembly does not allow partially trusted callers.]
  NHibernate.ByteCode.LinFu.ProxyFactory..cctor() +0
</code></pre>

<p>When debugging I came to the following error:</p>

<pre><code>   at NHibernate.ByteCode.LinFu.ProxyFactory..ctor()
   at NHibernate.ByteCode.LinFu.ProxyFactoryFactory.BuildProxyFactory()
   at NHibernate.Tuple.Entity.PocoEntityTuplizer.BuildProxyFactoryInternal(PersistentClass class, IGetter getter, ISetter setter)
   at NHibernate.Tuple.Entity.PocoEntityTuplizer.BuildProxyFactory(PersistentClass persistentClass, IGetter idGetter, ISetter idSetter)
   at NHibernate.Tuple.Entity.AbstractEntityTuplizer..ctor(EntityMetamodel entityMetamodel, PersistentClass mappingInfo)
   at NHibernate.Tuple.Entity.PocoEntityTuplizer..ctor(EntityMetamodel entityMetamodel, PersistentClass mappedEntity)
   at NHibernate.Tuple.Entity.EntityEntityModeToTuplizerMapping..ctor(PersistentClass mappedEntity, EntityMetamodel em)
   at NHibernate.Tuple.Entity.EntityMetamodel..ctor(PersistentClass persistentClass, ISessionFactoryImplementor sessionFactory)
   at NHibernate.Persister.Entity.AbstractEntityPersister..ctor(PersistentClass persistentClass, ICacheConcurrencyStrategy cache, ISessionFactoryImplementor factory)
   at NHibernate.Persister.Entity.SingleTableEntityPersister..ctor(PersistentClass persistentClass, ICacheConcurrencyStrategy cache, ISessionFactoryImplementor factory, IMapping mapping)
   at NHibernate.Persister.PersisterFactory.CreateClassPersister(PersistentClass model, ICacheConcurrencyStrategy cache, ISessionFactoryImplementor factory, IMapping cfg)
   at NHibernate.Impl.SessionFactoryImpl..ctor(Configuration cfg, IMapping mapping, Settings settings, EventListeners listeners)
   at NHibernate.Cfg.Configuration.BuildSessionFactory()
   at MyApplication.SessionManager..ctor() in C:\Projects\MyApps\MyApplication\SessionManager.cs:line 75
</code></pre>

<p>Is this because of the usage of NHibernate.ByteCode.LinFu? What can I do about it to make the application work again?</p>
 How can I create a DynamicProxy for a WCF proxy that is generated by ChannelFactory<T>? <p>I am using ChannelFactory to create a proxy at run-time for a WCF service. I would like to use the DynamicProxy Castle project to create a dynamic proxy on top of the WCF proxy so that I can intercept calls and do impersonation.</p>

<p>I'm getting an error when I try this though... the error message is:</p>

<blockquote>
  <p>'this' type cannot be an interface itself.</p>
</blockquote>

<p>My code is this (where T is a service contract interface):</p>

<pre><code>var generator = new ProxyGenerator();

return (T)generator.CreateInterfaceProxyWithTarget(typeof(T), channel, 
    new[] { new ImpersonationInterceptor() } );
</code></pre>

<p>The problem must have to do with the fact that the service proxy generated by ChannelFactory is generated at runtime, but is there any way around this problem?</p>
 What's the simplest way to intercept a method call for added functionality? <p>Suppose i have a repository that returns a list of <code>Post</code>s. The repository interface has a <code>GetAll()</code> method which does what it suggests.</p>

<p>Now in keeping with the theory that i shouldn't be putting domain logic in the repository, i want to intercept calls to the concrete <code>GetAll()</code> method such that i can add the following logic to the <code>GetAll()</code> result:</p>

<pre><code>return GetAll().OrderByDescending(p =&gt; p.Posted).ToList();
</code></pre>

<p>The reason i want to intercept this is because (1) i don't want to have the client remember to call an extension method (<code>OrderByDescending</code> or some useless wrapper of that), i want it called every time and (2) i don't want to have all my concrete implementations have to remember to order the <code>GetAll()</code> result - i want this logic in a single place external to any repository.</p>

<p>What's the easiest way to do this?</p>

<p>I'm already using <a href="http://structuremap.net/structuremap/" rel="nofollow">StructureMap</a> so if i can intercept with this it might be a low cost option. But i don't think SM intercepts method calls, just the creation of the object instance?</p>

<p>Do i need to go to a <a href="http://msmvps.com/blogs/jon_skeet/archive/2007/02/27/wacky-ideas-1-inheritance-is-dead-long-live-mix-ins.aspx" rel="nofollow">proxy or mixin</a> pattern? Do i need to go all-in with Castle <a href="http://kozmic.pl/dynamic-proxy-tutorial/" rel="nofollow">Dynamic Proxy</a>? Or is there <a href="http://ayende.com/Blog/archive/2007/07/02/7-Approaches-for-AOP-in-.Net.aspx" rel="nofollow">another method</a> i should consider or perhaps a combination?</p>

<p>I'm really interested in a concrete suggestion to my particular example above. I'm novice to AOP so please be gentle.</p>
 Trying to make a Logging Interceptor for StructureMap using DynamicProxy <p>I'm trying to log calls from the UI (DNN module) to some of various services it uses, in a effort to profile how people are interacting with the site. I'm using StructureMap 2.5.3.0 and Log4Net</p>

<p>I got things working well on individual class/instance pairs, but I have to configure things like this:</p>

<pre><code>ObjectFactory.Configure(ce =&gt;
        ce.ForRequestedType&lt;IRegService&gt;()
          .TheDefaultIsConcreteType&lt;RegService&gt;()
          .EnrichWith(LoggingEnrichment.InterfaceLogger&lt;IRegService&gt;));
</code></pre>

<p>Having the <code>IRegService</code> twice felt a bit messy, but I can live with it.</p>

<p>The logging is implemented like this:</p>

<pre><code>public class LoggingEnrichment
{
    public static object InterfaceLogger&lt;TInterface&gt;(object concrete)
    {
        return InterfaceLogger(typeof(TInterface), concrete);
    }

    public static object InterfaceLogger(Type iinterface, object concrete)
    {
        var dynamicProxy = new ProxyGenerator();
        return dynamicProxy.CreateInterfaceProxyWithTarget(iinterface, concrete, new LogInterceptor());
    }
}

public class LogInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        var watch = new Stopwatch();
        watch.Start();
        invocation.Proceed();
        watch.Stop();
        ILog logger = LogManager.GetLogger(typeof(LogInterceptor));
        var sb = new StringBuilder();
        sb.AppendFormat("Calling: {0}.{1}\n", invocation.InvocationTarget.GetType(), invocation.MethodInvocationTarget.Name);
        var param = invocation.Method.GetParameters();
        if (param.Length &gt; 0) sb.Append("With:\n");
        for (int i = 0; i &lt; param.Length; i++)
        {
            sb.AppendFormat("\t{0}\n\t\t{1}", param[i].Name, invocation.GetArgumentValue(i));
        }
        if(invocation.Method.ReturnType != typeof(void))
        {
            sb.AppendFormat("Returning: {0}\n", invocation.ReturnValue ?? "null");
        }
        sb.AppendFormat("In: {0}ms\n", watch.ElapsedMilliseconds);
        logger.Debug(sb.ToString());
    }
}
</code></pre>

<p>This works, but has a couple issues:</p>

<ol>
<li>I have to manually configure each service &lt;-> interface pair</li>
<li>I only want to wire up the logging when the service is called from the UI</li>
</ol>

<p>I tried to get around this by implementing a TypeInterceptor for StructureMap:</p>

<pre><code>public class ApplicationRegistry : Registry
{
    public ApplicationRegistry()
    {
        RegisterInterceptor(new LoggingInterceptor());
        Scan(scanner =&gt;
        {
            scanner.TheCallingAssembly();
            var codeBase = System.Reflection.Assembly.GetExecutingAssembly().CodeBase.Replace("file:///", String.Empty);
            codeBase = codeBase.Substring(0, codeBase.LastIndexOf("/"));
            scanner.AssembliesFromPath(codeBase);
            scanner.WithDefaultConventions();
            scanner.LookForRegistries();
        });
    }
}

public class LoggingInterceptor :TypeInterceptor
{
    public object Process(object target, IContext context)
    {
        var newTarget = target;
        if (context.BuildStack.Current != null &amp;&amp; context.BuildStack.Current.RequestedType != null)
        {
            newTarget = LoggingEnrichment.InterfaceLogger(context.BuildStack.Current.RequestedType, target);
        }
        return newTarget;
    }

    public bool MatchesType(Type type)
    {
        return type.Name.EndsWith("Service", StringComparison.OrdinalIgnoreCase);
    }
}
</code></pre>

<p>But I'm getting a problem with that where the call to <code>Process</code> is giving me a class that doesn't implement the interface defined by the build context. This has resulted in having to change the implementation of the <code>InterfaceLogger</code> to</p>

<pre><code>    public static object InterfaceLogger(Type iinterface, object concrete)
    {
        if(!iinterface.IsAssignableFrom(concrete.GetType())) return concrete;
        var dynamicProxy = new ProxyGenerator();
        var interfaceProxy = dynamicProxy.CreateInterfaceProxyWithTarget(iinterface, concrete, new LogInterceptor());
        return interfaceProxy;
    }
</code></pre>

<p>A breakpoint on the <code>return interfaceProxy;</code> is never reached, this indicates that <code>context.BuildStack.Current.RequestedType</code> isn't returning the right interface. The odd thing is that all my classes seem to be injected correctly.</p>

<p>Also, even if this was working I'd still have the issue of only wanting to intercept the calls from the UI layer.</p>

<p>I'm looking for a way my first 2 issues, and also what I'm doing wrong with the <code>TypeInterceptor</code></p>
 In Castle.DynamicProxy is it possible to change a mixin value after initialisation? <p>I noticed that DynamicProxy objects can implement an <a href="http://api.castleproject.org/html/T_Castle_Core_Interceptor_IChangeProxyTarget.htm" rel="nofollow">IChangeProxyTarget</a> interface, which allows you to do something like <code>((IChangeProxyTarget)myProxyObj).ChangeInvocationTarget(newTarget)</code>.</p>

<p>Is there a way to similarly change the mixin implementation on a DynamicProxy object? Obviously this is more complex and nuanced than changing the target in ways I have not fully thought through (due to varying interface implementations, multiplicity of mixins etc) but the concept is not entirely inconceivable.</p>

<p>Or lacking that, any ideas with regards achieving this, in a reasonably performant fashion? I have some theoretical ideas regarding hacking this in but it seems extremely, extremely convoluted:</p>

<ol>
<li>Define a MixinSwitcher class (and accompanying IMixinSwitcher interface) with <code>Action&lt;object, object&gt; DoSwitch</code> property</li>
<li>Mix an instance of this in when creating DP object `MixinSwitcher mixinSwitcher = new MixinSwitcher(); proxyGenerationOptions.AddMixinInstance(mixinSwitcher);</li>
<li>Create DP object <code>var dpObj = proxyGenerator.Create...</code> - ensure that IMixinSwitcher is added to the interfaces to implement</li>
<li>Use reflection on to find the relevant mixin MemberInfo from <code>dpObj.Gettype()</code></li>
<li>Use System.Reflection.Emit to generate a fast setter for this property.</li>
<li>Set <code>mixinSwitcher.DoSwitch = (SRE setter method here)</code></li>
<li>((IMixinSwitcher)dpObj).DoSwitch(dpObj, newMixinValue)</li>
<li>Profit... or brain melt?</li>
</ol>

<p>The step 1 class can be genericised to allow it to target specific/multiple implementations; steps 4-5 cached for extra performance, and the general step 1 implementation could be cleaned up.</p>

<p>Even so I don't deny it is pretty mad - is there a better way?</p>
 Castle Dynamic Proxy not intercepting method calls when invoked from within the class <p>I have run into a bit of (what I think is) strange behaviour when using Castle's Dynamic Proxy.  </p>

<p>With the following code:</p>

<pre><code>class Program
{
    static void Main(string[] args)
    {
        var c = new InterceptedClass();
        var i = new Interceptor();

        var cp = new ProxyGenerator().CreateClassProxyWithTarget(c, i);

        cp.Method1();
        cp.Method2();

        Console.ReadLine();
    }
}

public class Interceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        Console.WriteLine(string.Format("Intercepted call to: " + invocation.Method.Name));

        invocation.Proceed();
    }
}

public class InterceptedClass
{
    public virtual void Method1()
    {
        Console.WriteLine("Called Method 1");
        Method2();
    }

    public virtual void Method2()
    {
        Console.WriteLine("Called Method 2");
    }
}
</code></pre>

<p>I was expecting to get the output:</p>

<ul>
<li>Intercepted call to: Method1 </li>
<li>Called Method 1 </li>
<li>Intercepted call to: Method2</li>
<li>Called Method 2</li>
<li>Intercepted call to: Method2</li>
<li>Called Method 2</li>
</ul>

<p>However what I got was:</p>

<ul>
<li>Intercepted call to: Method1 </li>
<li>Called Method 1</li>
<li>Called Method 2 </li>
<li>Intercepted call to: Method2</li>
<li>Called Method 2</li>
</ul>

<p>As far as I can tell then the dynamic proxy is only able to proxy method calls if the call comes from outside the class itself as Method2 was intercepted when called from Program but not from within InterceptedClass.  </p>

<p>I can kind of understand that when making calls from within the proxied class it would no longer go through the proxy, but just wanted to check that this was expected and if it is then see if there is there anyway to get all calls intercepted regardless of where they're called from?</p>

<p>Thanks </p>
 Ninject Interception dynamic proxy problems <p>I'm trying to set up interception to work with Ninject which we have been using as our dependency injection framework for a while.</p>

<p>I have downloaded the interception extension from NuGet and tried it with both the Castle Dynamicproxy implementation and the LinFu implementation but could not be either to work with our applications.</p>

<p>Castle gave an error when creating a proxy on a class that did not have a parameterless constructor, since all the service objects have their dependencies injected via the constructor this is a problem. The error is:</p>

<p>System.ArgumentException: Can not instantiate proxy of class: emedia.RapidSystems.Subscriber.Presenters.RRSubmissionPresenter.
Could not find a parameterless constructor.
Parameter name: constructorArguments</p>

<p>The LinFu interceptor worked better, right up until the code called a method with a generic parameter then it gave me the following:</p>

<p>System.ArgumentException: Generic types are not valid.
Parameter name: methodInfo</p>

<p>Here is a simplified version code for one of the classes I am trying to intercept:</p>

<pre><code>[LogCalls]
public class Repository&lt;T&gt; : IRepository&lt;T&gt;
        where T : class
{   
    public virtual T GetEntity&lt;TKey&gt;(ObjectContext context, TKey key)
    {
        var entity = GetEntity(context, key, _emptyLoadingStrategy);
        return entity;
    }

    public virtual IQueryable&lt;T&gt; GetAll(ObjectContext context)
    {
        var query = GetAll(context, _emptyLoadingStrategy);
        return query;
    }

    public virtual T Add(ObjectContext context, T entity)
    {
        context.AddObject(EntitySetName(context), entity);
        return entity;
    }

     //other code goes here

}
</code></pre>

<p>Add and GetAll work fine but the error happens when GetEntity is called on the proxy.</p>

<p>At this point I'm stuck, as neither interceptor works with the code base. Has anyone got Ninject interception working with a real complex production system, rather than a simple demo class, and if so how? I don't mind which interceptor I use as long as it works.</p>

<p>Or is interception with Ninject just not mature enough yet, and do I need to look at replacing the whole thing with something else like Unity?</p>
 ASP.NET MVC3 controller AOP proxy not intercepting all methods, only IController.Execute <p>I have a project with several layers - among them the web front end (ASP.NET MVC3) and the service back end (mainly business logic). The project is a few months old, so everything is working as expected. Now I am trying to add a logging aspect to some of the MVC3 controller methods using custom <code>[Log]</code> attributes.</p>

<p>I am using <a href="http://docs.castleproject.org/Windsor.MainPage.ashx" rel="nofollow">Castle Windsor</a> for dependency injection. To get a logging aspect I leverage <a href="http://castleproject.org/dynamicproxy/" rel="nofollow">Castle DynamicProxy</a> through <a href="http://www.simpleaspects.com/" rel="nofollow">SNAP</a>. Controllers are being resolved using <a href="http://docs.castleproject.org/Windsor.Windsor-tutorial-part-two-plugging-Windsor-in.ashx" rel="nofollow"><code>WindsorControllerFactory</code></a> from Krzysztof Koźmic's helpful tutorial - but I modified it to look for the default interface for the controller (see below).</p>

<p>In my service layer:</p>

<pre><code>[Log(LoggingLevel.Info)]
public void Save(MyBusinessDto dto)
{
    // business logic and other checks

    this.repository.Save(mbo);
}
</code></pre>

<p>In my web front end's <a href="http://stw.castleproject.org/Windsor.Installers.ashx" rel="nofollow"><code>IWindsorInstaller</code></a> for controllers:</p>

<pre><code>private static BasedOnDescriptor FindControllers()
{
    return AllTypes
            .FromThisAssembly()
            .BasedOn&lt;IController&gt;()
            .WithService.DefaultInterface();
}
</code></pre>

<p>In my (slightly customized) <code>WindsorControllerFactory</code> that looks for the default interface for the controller:</p>

<pre><code>protected override IController GetControllerInstance(RequestContext requestContext, Type controllerType)
{
    if (controllerType == null)
    {
        throw new HttpException(404, string.Format(Error404, requestContext.HttpContext.Request.Path));
    }

    string controllerName = controllerType.Name;
    string defaultInterfaceName = 'I' + controllerName;
    Type defaultInterface = controllerType.GetInterface(defaultInterfaceName);

    object controller = this.kernel.Resolve(defaultInterface);

    return (IController)controller;
}
</code></pre>

<p>In my controllers:</p>

<pre><code>public class MyBusinessController : MyBusinessControllerBase, IMyBusinessController
{
    [Log(LoggingLevel.Debug)]
    public ActionResult CreateOrUpdate(MyBusinessFormModel fm)
    {
        // Convert form model to data transfer object,
        // perform validation and other checks

        this.service.Save(dto);

        return View(fm);
    }
}
</code></pre>

<p>This all works fine in the service project, but in the controllers the methods are not being intercepted.</p>

<ul>
<li>I have confirmed that the <code>WindsorControllerFactory</code> returns proxied controllers.</li>
<li>I have confirmed that the controllers have the interceptor registered.</li>
<li>I have confirmed that the <code>MasterProxy</code> in SNAP intercepts the controller - but it only intercepts <code>IController.Execute(RequestContext requestContext)</code>.</li>
</ul>

<p><strong>How can I intercept all controller methods that have my <code>[Log]</code> attribute?</strong></p>

<p>Update 1: I have considered using DynamicProxy directly instead of SNAP, but this is secondary to getting it to work for controllers as well.</p>

<p>Update 2+4: It seems that SNAP is <strike>missing from github</strike> <a href="https://github.com/TylerBrinks/Snap/" rel="nofollow">back on github</a>.</p>

<p>Update 3: This is what I see in the Visual Studio debugger when breaking in the <code>WindsorControllerFactory</code> (see above). The inspected <code>controller</code> variable is what is returned to MVC, and it is indeed proxied.</p>

<ul>
<li><code>controller</code>  {Castle.Proxies.IMyBusinessControllerProxy}
<ul>
<li><code>__interceptors</code>  {Castle.DynamicProxy.IInterceptor[1]}
<ul>
<li><code>[0]</code> {Snap.MasterProxy}</li>
</ul></li>
<li><code>__target</code>    {My.Business.Web.Controllers.MyBusinessController}
<ul>
<li><code>service</code> {Castle.Proxies.IMyBusinessServiceProxy}</li>
<li>(other contructor injections)</li>
</ul></li>
<li><code>MyInjectedProperty</code>  {My.Business.Useful.MyOtherType}</li>
</ul></li>
</ul>
 Using Automapper with LinFu.DynamicProxy in commercial application <p>We want to use Automapper in commercial application (.NET 3.5). To get the clearance we need the source code of automapper.</p>

<p>We got the required automapper source code but after building the code we found that the size of automapper.dll 86KB while the DLL we were using was of 108 KB. Application was not working with this 86KB automapper dll</p>

<p>We looked into the code and found that another DLL LinFu.DynamicProxy of size 21KB . If I use this DLL with automapper DLL application works fine.</p>

<p>Based on that I conclude that the 108KB dll that I was using actually contains 86KB Automapper  + 21 KB LinFu.DynamicProxy.</p>

<p>Now I have question related to licensing. Do I need to get the approval for LinFu.DynamicProxy as well. It comes with GNU license.</p>
 Using DynamicProxy as a decorator pattern in windsor container <p>I am looking for some info on using and configuring windsor to provide a dynamic proxy to intercept calls to an instance of another class.  </p>

<p>My class represents a resource that should be retained as a long lived instance by the container for performance reasons.  However, sometimes this resource can transition into ununusable state, and requires renewing.  I would like the container to handle this so client code doesn't have to.  I can create my own factory to do this, I would like to know if there is some Windsor registration coolness to do it for me so I don't have to create the separate factory class :)</p>

<p>Here is some pseudo code to demonstrate the problem:</p>

<pre><code>public interface IVeryImportantResource
{
    void SomeOperation();
}

public class RealResource : IVeryImportantResource
{
    public bool Corrupt { get; set; }

    public void SomeOperation()
    {
        //do some real implementation
    }
}

public class RealResourceInterceptor : IInterceptor
{
    private readonly IKernel kernel;

    public RealResourceInterceptor(IKernel Kernel)
    {
        kernel = Kernel;
    }

    public void Intercept(IInvocation invocation)
    {
        RealResource resource = invocation.InvocationTarget as RealResource;

        if(resource.Corrupt)
        {
            //tidy up this instance, as it is corrupt
            kernel.ReleaseComponent(resource);
            RealResource newResource = kernel.Resolve&lt;RealResource&gt;(); //get a new one
            //now what i would like to happen is something like this
            //but this property has no setter, so this doesn't work
            //also, i would like to know how to register RealResourceInterceptor as well RealResourceInterceptor
            invocation.InvocationTarget = newResource;
        }
        invocation.Proceed();
    }
}
</code></pre>

<p>Any ideas how to implement something like my RealResourceInterceptor class, and also how to configure the container to use it?  Thanks!</p>
 Castle Windsor: How to retrieve proxy for specific instance? <p>I'm using Castle Windsor in my project. Some registered components are intercepted. Because the components are registered through interfaces, Castle Windsor creates interface proxies (Castle Windsor creates a standalone type which implements the interface and delegates to the real implementation by using composition). Unfortunately you cannot execute methods within the real implementation of the interface, because the proxy would be bypassed.</p>

<p>Is there a way to get the instance of the proxy which represents the real implementation within the real implementation?</p>

<p>Here is an example of what I would like to achieve. I want to intercept always the Get method. Please don't come with alternative ways to refactor this sample because this is not my production code but just something invented for demonstration.</p>

<pre><code>public interface IProvider
{
    bool IsEmpty { get; }
    object Get();
}

public class ProxyBypassingProvider : IProvider
{
    public bool IsEmpty
    {
        // Calls method directly, not through the proxy.
        get { return Get() == null; }
    }

    public object Get()
    {
        return new Object();
    }
}

public class InterceptedProvider : IProvider
{
    private IProvider _this; // Should hold the proxy instance.

    public bool IsEmpty
    {
        // Calls method through proxy.
        get { return _this.Get() == null; }
    }

    public object Get()
    {
        return new Object();
    }
}
</code></pre>

<p>How can I set the field _this to the instance of the proxy?</p>

<p>Best Regards<br />
Oliver Hanappi</p>

<p>PS: Here is a real world example.</p>

<pre><code>public interface IPresentationModel
{
    IView View { get; }
}

public interface IView
{
    void SetModel(IPresentationModel model);
}

public PresentationModel : IPresentationModel
{
    public IView View { get; private set; }

    public PresentationModel(IView view)
    {
        View = view;
        View.SetModel(this);
    }
}
</code></pre>

<p>I'm resolving a transient presentation model. It gets a transient view injected. Because the view needs to know about the presentation model, the presentation model calls IView.SetModel(this) to let the view know about its presentation model.<br />
The problem is now, that although the resolved IPresentationModel is a proxy, the SetModel method gets only the real implementation. Therefore, when the view calls methods on the presentation model, no interceptors are being fired.</p>

<p>The only solution I have found until now, is to set the view's presentation model manually after I have resolved my presentation model.</p>

<pre><code>var model = _container.Resolve&lt;IPresentationModel&gt;();
model.View.SetModel(model);
</code></pre>

<p>I think, this solution is not really solved very well.</p>
 Castle Windsor Interceptor for private/protected method <p>Is it true that in order for castle windsor's interceptor to intercept a method, that method needs to be declare public?</p>
 Should Castle DynamicProxy IInterceptor or ProxyGenerator be cached? <p>I'm using StructureMap to Enrich some of my objects with an instance call to</p>

<p><code>ProxyGenerator.CreateInterfaceProxyWithTarget(myObject, MYInterceptor)</code></p>

<p>Currently I have the <code>MYInterceptor</code> inside my container, should I implement any type of caching for the interceptor?</p>

<p>The second question should I register my <code>ProxyGenerator</code> inside my container and if so, should I apply any type of caching to it?</p>
 What really interceptors do with my c# class? <p>I was asked to implement castle dynamic proxy in my asp.net web application and i was going through couple of articles which i got from <a href="http://www.castleproject.org/" rel="nofollow">Castle Project</a> and <a href="http://www.codeproject.com/KB/cs/hamiltondynamicproxy.aspx" rel="nofollow">Code Project</a> about castle dynamic proxy in asp.net web application.... </p>

<p>Both articles delt with creating interceptors but i can't get the idea why interceptors are used with classes.... Why should i intercept my class which is behaving properly?</p>
 Is it possible to add a property to a type, via a DynamicProxy? <p>I'm using Castle DynamicProxy to create a proxy of a given type at runtime - including a couple mixins.</p>

<p>I'm trying to figure out if it's possible to also add arbitrary properties to the proxy, e.g.:</p>

<pre><code>class BaseType
{
  string Foo { get; set; }
}
</code></pre>

<p>and at runtime, I create a new type, that would look like this:</p>

<pre><code>class BaseTypeProxy3848484etc
{
  string Foo { get; set; }
  OtherType Bar { get; set; }
}
</code></pre>

<p>In theory, it seems like this <em>should</em> be possible-- maybe I'm just not seeing how to do it with Castle... Any thoughts? Thanks!</p>
 Add attributes to class & properties on the fly <p>Is there anything in castle that can let me add attributes to a class on the fly?</p>

<p>I have a dto in a project that I want to use as a data contract in a wcf service. I'd need to add a </p>

<pre><code>[DataContract]
</code></pre>

<p>attribute to the class and then </p>

<pre><code>[DataMember]
</code></pre>

<p>to each of the properties.</p>

<p>I could just replicate the class in the service layer and then copy the list to a new list of the new type but thats a ballache. There must be something in dynamicproxy or somewhere?</p>

<p>w://</p>
 How can multiple interfaces with multiple classes be merged using DynamicProxy? <p>Suppose we have an interface ICat that is derived from ICatBase and ICatExtension as shown below. For both distinct interfaces, an implementation is available, CatBase and CatExtension. How can Castle's DynamicProxy be used to merge these into an instance of ICat?</p>

<p>Is it possible to create a proxy in which ICatExtension is implemented by CatExtension and ICatBase is 'implemented' by an interceptor? How can this be achieved?</p>

<pre><code>public interface ICatBase
{
   string Name { get; set; }
   int Age { get; set; }
}

public interface ICatExtension
{
   string Description { get; }
}

public interface ICat : ICatBase, ICatExtension
{
}

public class CatBase : ICatBase
{
   public string Name { get; set; }
   public int Age { get; set; }
}

public class CatExtension : ICatExtension
{
   public string Description
   {
      get { return "Furry"; }
   }
}
</code></pre>

<p><strong>EDIT</strong></p>

<p>I have been trying to use mixins to make this work, but the code below results in a NotImplementedException. </p>

<pre><code>var generator = new ProxyGenerator();
var options = new ProxyGenerationOptions();
options.AddMixinInstance(new CatBase());
options.AddMixinInstance(new CatExtension());
var cat  = generator.CreateInterfaceProxyWithoutTarget&lt;ICat&gt;(options);        
cat.Name = "Joey";
</code></pre>

<p>This is a DynamicProxy2 error: There are no interceptors specified for method 'Void set_Name(System.String)' which has no target. When calling method without target there is no implementation to 'proceed' to and it is the responsibility of the interceptor to mimic the implementation (set return value, out arguments etc)</p>

<p>I could create a custom interceptor that intercepts calls and dispatches to the correct interface, but I feel there must be an easier/better way. Am I correct?</p>

<p><strong>EDIT #2</strong></p>

<p>Thank you, Krzysztof! Using the lines below was the solution.</p>

<pre><code>var generator = new ProxyGenerator();
var options = new ProxyGenerationOptions();
options.AddMixinInstance(new CatBase());
options.AddMixinInstance(new CatExtension());

var cat = (ICat)generator.CreateClassProxyWithTarget(typeof(object), new[] { typeof(ICat)}, new object(), options);
</code></pre>

<p><strong>EDIT #3</strong></p>

<p>As a final step, I have configured a Windsor container to create the proxy from this example. The only way I was able to do this, was by specifying a name "Cat" and resolving an instance of System.Object by specifying the name and casting to the <code>ICat</code> interface afterwards.</p>

<pre><code>WindsorContainer container = new WindsorContainer();
container.Register(
    Castle.MicroKernel.Registration.Component.For&lt;object&gt;().
        Named("Cat").
        Proxy.AdditionalInterfaces(typeof (ICat)).
        Proxy.MixIns(new CatBase()).
        Proxy.MixIns(new CatExtension())
    );

var cat = (ICat)container.Resolve(typeof(object), "Cat");
</code></pre>

<p>Is there a more elegant way to this in which I can just ask the container for an ICat instance, without referring to a particular name?</p>
 Autofac: Tips for increasing performance when using DynamicProxy? <p>I just start using DynamicProxy2 today. And found it caused significant performance drop.</p>

<p>See the code below. Test1 is 10 times slower than Test2.</p>

<p>Any tips for increasing performance when using DynamicProxy?</p>

<pre><code>class Program
{
    public void Main()
    {
        for (int i = 0; i &lt; 3; i++)
        {
            var stopWatch = Stopwatch.StartNew();
            int count = 1 * 1000 * 1000;

            Test1(count);
            //Test2(count);

            long t = stopWatch.ElapsedMilliseconds;
            Console.WriteLine(t.ToString() + " milliseconds");
            Console.WriteLine(((double)count/(t/1000)).ToString() + " records/1 seconds");
        }
    }

    void Test1(int count)
    {
        var builder = new ContainerBuilder();
        builder.RegisterType&lt;TestViewModel&gt;()
            .EnableClassInterceptors()
            .InterceptedBy(typeof(NotifyPropertyChangedInterceptor));
        builder.RegisterType&lt;NotifyPropertyChangedInterceptor&gt;();

        var container = builder.Build();
        for (int i = 0; i &lt; count; i++)
        {
            container.Resolve&lt;TestViewModel&gt;();
        }
    }

    void Test2(int count)
    {
        var builder = new ContainerBuilder();
        builder.RegisterType&lt;TestViewModel&gt;();

        var container = builder.Build();
        for (int i = 0; i &lt; count; i++)
        {
            container.Resolve&lt;TestViewModel&gt;();
        }
    }
}

public class TestViewModel : INotifyPropertyChanged
{
    [Notify]
    public virtual string Value { get; set; }
    public event PropertyChangedEventHandler PropertyChanged;
}

/// &lt;summary&gt;
/// Copied from: http://serialseb.blogspot.com/2008/05/implementing-inotifypropertychanged.html
/// &lt;/summary&gt;
public class NotifyPropertyChangedInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        // let the original call go through first, so we can notify *after*
        invocation.Proceed();
        if (invocation.Method.Name.StartsWith("set_"))
        {
            string propertyName = invocation.Method.Name.Substring(4);
            var pi = invocation.TargetType.GetProperty(propertyName);

            // check that we have the attribute defined
            if (Attribute.GetCustomAttribute(pi, typeof(NotifyAttribute)) == null)
                return;

            // get the field storing the delegate list that are stored by the event.
            FieldInfo info = invocation.TargetType.GetFields(BindingFlags.Instance | BindingFlags.NonPublic)
                .Where(f =&gt; f.FieldType == typeof(PropertyChangedEventHandler))
                .FirstOrDefault();

            if (info != null)
            {
                // get the value of the field
                PropertyChangedEventHandler evHandler = info.GetValue(invocation.InvocationTarget) as PropertyChangedEventHandler;
                // invoke the delegate if it's not null (aka empty)
                if (evHandler != null)
                    evHandler.Invoke(invocation.TargetType, new PropertyChangedEventArgs(propertyName));
            }
        }
    }
}
</code></pre>

<p><strong>Update:</strong></p>

<p>On my machine, Test1 takes about 45 seconds, Test2 takes about 4.5 seconds. After read <a href="http://stackoverflow.com/users/13163/krzysztof-kozmic">Krzysztof Koźmic</a>'s answer, I tried to put <em>NotifyPropertyChangedInterceptor</em> into singleton scope:</p>

<pre><code>builder.RegisterType&lt;NotifyPropertyChangedInterceptor&gt;().SingleInstance();
</code></pre>

<p>that saved me about 4 seconds. Now Test1 takes about 41 seconds.</p>

<p><strong>Update 2:</strong></p>

<p>Test3 takes about 8.3 seconds on my machine. So it seems using Autofac or DynamicProxy alone performance is not a very big problem (in my project), but combining them together would cause great performance drop.</p>

<pre><code>    public void Test3(int count)
    {
        var generator = new Castle.DynamicProxy.ProxyGenerator();
        for (int i = 0; i &lt; count; i++)
        {
            generator.CreateClassProxy(typeof(TestViewModel), 
                new NotifyPropertyChangedInterceptor());
        }
    }
</code></pre>
 Ninject: Possible to use injection constructor when type is being proxied for AoP? <p>I'm doing a project ground up using Ninject 2 and one question bugs me:</p>

<p>If you are to intercept methods on your type, you need to wrap it into proxy (castle dynamic proxy to be specific). Unless said type has a parameterless constructor, proxy creation fails. If it has, this constructor is being used when type instance is being resolved from the kernel.</p>

<p>Unfortunately, this means that my injection constructor with parameters is being neglected and I have to resort to property injection. I have some reluctance to couple my domain types with [Inject] attribute on properties.</p>

<p>Is there any way to use injection constructor with proxies for AoP using Ninject?</p>
 Is it possible to create dynamic proxies without having base class or interface? <p>Is it possible to create a dynamic proxy using common libraries like <code>Castle Dynamic Proxy</code> without having any base class or interface? I'm indeed interested to have dynamic on-the-fly classes in run-time.</p>
 Moq + Castle Dynamic Proxy - exception mocking nested generic interfaces <p>I'm receiving an argument exception from Castle Dynamic Proxy, while using Moq to create a mock of object that is implementing a nested generic interface with generic method that has an interface constraint.</p>

<p>The exception is: System.ArgumentException : Cannot set parent to an interface.</p>

<p>Happens while accessing Object property of the mock directly after the mock creation. (Call stack is at the bottom for the sake of readability)</p>

<p>The code is simple and self-describing:</p>

<pre><code>    public interface A&lt;T&gt;
    {
        void Method&lt;Z&gt;() where Z : T; 
    }

    public interface B
    {
    }

    [Test]
    public void MockNestedGenericInterfaceTest()
    {
        Mock&lt;A&lt;B&gt;&gt; mock = new Mock&lt;A&lt;B&gt;&gt;();
        var o = mock.Object; //argument exception here
    }
</code></pre>

<p>Test does not generate an exception if where Z : T clause is removed.</p>

<p>I did some research and found a ticket <a href="http://code.google.com/p/moq/issues/detail?id=259" rel="nofollow" title="here">here</a>. I'm using latest versions of Moq and Castle.</p>

<p>Is there a workaround for this problem? The only way I see it working is a manual mock implementation. Rhino mocks did not work for me either.</p>

<p>Thank you.</p>

<p>Call stack:</p>

<pre><code>at System.Reflection.Emit.TypeBuilder.SetParent(Type parent)
</code></pre>

<p>at Castle.DynamicProxy.Generators.Emitters.GenericUtil.CopyGenericArguments(MethodInfo methodToCopyGenericsFrom, Dictionary<code>2 name2GenericType, ApplyGenArgs genericParameterGenerator)
at Castle.DynamicProxy.Generators.Emitters.AbstractTypeEmitter.CopyGenericParametersFromMethod(MethodInfo methodToCopyGenericsFrom)
at Castle.DynamicProxy.Generators.InvocationTypeGenerator.Generate(ClassEmitter class, ProxyGenerationOptions options, INamingScope namingScope)
at Castle.DynamicProxy.Contributors.InterfaceProxyWithoutTargetContributor.GetInvocationType(MetaMethod method, ClassEmitter emitter, ProxyGenerationOptions options)
at Castle.DynamicProxy.Contributors.InterfaceProxyWithoutTargetContributor.GetMethodGenerator(MetaMethod method, ClassEmitter class, ProxyGenerationOptions options, OverrideMethodDelegate overrideMethod)
at Castle.DynamicProxy.Contributors.CompositeTypeContributor.ImplementMethod(MetaMethod method, ClassEmitter class, ProxyGenerationOptions options, OverrideMethodDelegate overrideMethod)
at Castle.DynamicProxy.Contributors.CompositeTypeContributor.Generate(ClassEmitter class, ProxyGenerationOptions options)
at Castle.DynamicProxy.Generators.InterfaceProxyWithoutTargetGenerator.GenerateType(String typeName, Type proxyTargetType, Type[] interfaces, INamingScope namingScope)
at Castle.DynamicProxy.Generators.InterfaceProxyWithTargetGenerator.GenerateCode(Type proxyTargetType, Type[] interfaces, ProxyGenerationOptions options)
at Castle.DynamicProxy.ProxyGenerator.CreateInterfaceProxyWithoutTarget(Type interfaceToProxy, Type[] additionalInterfacesToProxy, ProxyGenerationOptions options, IInterceptor[] interceptors)
at Moq.Proxy.CastleProxyFactory.CreateProxy(ICallInterceptor interceptor, Type[] interfaces, Object[] arguments)
at Moq.Mock</code>1.b__0()
at Moq.Mock<code>1.InitializeInstance()
at Moq.Mock</code>1.OnGetObject()
at Moq.Mock`1.get_Object() </p>
 Backing field for collection is null when using LinFu ProxyFactoryFactory in NHibernate <p>I am having a problem when I try switching from the Castle ProxyFactoryFactory to the LinFu ProxyFactoryFactory in NHibernate.</p>

<p>I have an entity like this:</p>

<pre><code>public class Foo
{
    private ISet&lt;Bar&gt; _bars = new HashedSet&lt;Bar&gt;();

    public virtual void AddBar(Bar bar)
    {
       if (!_bars.Contains(bar)
            _bars.Add(bar);

       bar.Foo = this;
    }
}
</code></pre>

<p>This is mapped with Fluent NHibernate like this:</p>

<pre><code>public class FooDbMap : ClassMap&lt;Foo&gt;
{
     public FooDbMap()
     {
          HasMany(x =&gt; x.Bars)
              .Access.CamelCaseField(Prefix.Underscore)
              .LazyLoad()
              .KeyColumn("FooId")
              .AsSet()
              .Cache.ReadWrite();
     }
}
</code></pre>

<p>The relationship is bi-directional and is mapped as such on the Bar side too.</p>

<p>The problem occurs when I call the AddBar method. The _bars collection is null, and a NullReferenceException is thrown.</p>

<p>The problem goes away if I switch back to the Castle ProxyFactoryFactory.</p>

<p>The error doesn't occur with all mapped collections, just this one instance.</p>

<p>The problem still occurs even if I change _bars to readonly! So someone is managing to set a readonly field back to null, even after the field has been assigned.</p>

<p>Any ideas?</p>
 CastleDynamic proxy: NullReferenceException when calling method of a proxy <p>I'm using <em>StructureMap</em> to have an instance of an interface and I wrap it into a proxy with <em>Castle DynamicProxy</em>:</p>

<pre><code>var proxy = generator.CreateInterfaceProxyWithTarget&lt;T&gt;(
    ObjectFactory.GetInstance&lt;T&gt;()
    , new SwitchInterceptor(isGranted, foundUser));
</code></pre>

<p>In the interceptor of type <code>IInterceptor</code>, I've got this code:</p>

<pre><code>public override void Intercept(IInvocation invocation)
{
    if (this.CanExecute)
    {
        invocation.Proceed();
    }
}
</code></pre>

<p>When CanExecute is <code>true</code>, it always work but <strong>sometimes</strong> when CanExecute is <code>false</code>, I've got a weird <code>NullReferenceException</code> with a realy small stacktrace:</p>

<pre><code>at Castle.Proxies.IGrantedReadProxy.ExecuteSomething()
</code></pre>

<p>I'm really lost and I don't know where to look. Do you have any idea about what the problem is?</p>
 Dynamic Proxying IEnumerable<T> <p>I'm trying to create a dynamic proxy to a list of objects of a specific class.
For example:</p>

<pre><code>var proxy = generator.CreateInterfaceProxyWithoutTarget(typeof (IEnumerable&lt;string&gt;),
                                                        interceptor);
</code></pre>

<p>But I get the following exception:</p>

<blockquote>
  <p>Cannot resolve method System.Collections.Generic.IEnumerator`1[System.__Canon] GetEnumerator() because the declaring type of the method handle System.Collections.Generic.IEnumerable`1[T] is generic. Explicitly provide the declaring type to GetMethodFromHandle. </p>
</blockquote>

<p>I'm trying to proxy an IEnumerable&lt;> in order to cache calls to generate the list itself.</p>
 NuGet: NHibernate, Castle.Core 3.0 and where is ProxyFactoryFactory? <p>I installed with NuGet the packages NHibernate and Castle.Core 3.0 for a new project. Usually we copied around the dlls manually; it is the first time I do that with NuGet.</p>

<p>Now I can't find out how to configure the ProxyFactoryFactory, or let's say, I can't find it. I referenced NHibernate and Castle.Core (the only dll I could find in the Castle.Core - package) within the project, and configured the following:</p>

<pre><code>&lt;property name="proxyfactory.factory_class"&gt;
    NHibernate.ByteCode.Castle.ProxyFactoryFactory, 
    NHibernate.ByteCode.Castle
&lt;/property&gt;
</code></pre>

<p>This leads to:</p>

<blockquote>
<pre><code>Class Initialization method Tests.UnitTest1.MyClassInitialize threw exception.
NHibernate.Bytecode.UnableToLoadProxyFactoryFactoryException:
NHibernate.Bytecode.UnableToLoadProxyFactoryFactoryException: Unable
to load type 'NHibernate.ByteCode.Castle.ProxyFactoryFactory,
NHibernate.ByteCode.Castle' during configuration of proxy factory class.
</code></pre>
</blockquote>

<p>Obviously this dll is missing, but where can I find that? There is a package in NuGet called <code>Castle.DynamicProxy</code>, but it is marked as obsolete.</p>

<p>p.s.: In the description of the Castle.Core 3.0 - package, it is said: ... including DynamicProxy ...</p>
 Turn off signing for Castle DynamicProxy <p>I am having problems when trying to use a TypedFactoryFacility in Castle.</p>

<p>I'm using Castle v3.0.0 and I've created a ViewFactory, using </p>

<pre><code>injector.AddFacility(Of TypedFactoryFacility)()
</code></pre>

<p>and:</p>

<pre><code>container.Register(CMR.Component.For(Of IDialogViewFactory)().AsFactory())
</code></pre>

<p>This code all works fine on my machine, but when deploying it to users on VMs (who don't have local admin rights), they get the following error:</p>

<pre><code>Unable to obtain public key for StrongNameKeyPair.
</code></pre>

<p>There's various threads around, but nothing that seems to solve my issue - how can I use DynamicProxy on machines who don't / can't have access to C:\Documents and Settings\All Users\Application Data\Microsoft\Crypto\</p>

<p>In the <a href="https://gist.github.com/2049289" rel="nofollow">stack trace of the error</a> is the line</p>

<pre><code>Castle.DynamicProxy.ModuleScope.CreateModule(signStrongName As Boolean)
</code></pre>

<p>Which seems to suggest strong naming can be turned off somehow but I can't figure out how?</p>
 Calls to properties inside non-intercepted methods are not forwarded to target object <p>I have a change tracking framework that tracks changed made to domain objects on the client. It uses Castle.Windsor as the tool for creating proxy objects. After I changed Castle to version 3.0 calls of properties inside methods that are not intercepted are not forwarded to the target object anymore.</p>

<p><img src="http://www.pictureupload.de/originals/pictures/200312135214_ct.png" alt="sequence diagram"></p>

<p>ChangeTracker is a class of my own that handles the tracking of the changed made to the inner object.</p>

<p>A custom ProxyGenerationHook is used, which worked correctly with Castle 2.5:</p>

<pre><code>private sealed class ProxyGenerationHook : IProxyGenerationHook
{
    public void MethodsInspected()
    { }

    public void NonProxyableMemberNotification(Type type, MemberInfo memberInfo)
    { }

    public bool ShouldInterceptMethod(Type type, MethodInfo methodInfo)
    {
       if (methodInfo == null)
       {
          throw ExceptionBuilder.ArgumentNull("methodInfo");
       }

       string methodName = methodInfo.Name;
       bool result = methodName.StartsWith("set_", StringComparison.OrdinalIgnoreCase) ||
                     methodName.StartsWith("get_", StringComparison.OrdinalIgnoreCase);

       return result;
    }
 }
</code></pre>

<p>This is the domain class used:</p>

<pre><code>public class Person
{
  public virtual int Id { set; get; }
  public virtual string Name { set; get; }

  protected virtual int Age { set; get; }

  public void SetAgeTo(int value)
  {
     Age = value;
  }
}
</code></pre>

<p>Is this now the intended behaviour or is this a bug of Castle 3.0?</p>
 Dynamic cast to generic type <p>Just a quickie before the weekend rolls in...</p>

<p>I have a Method with the following signature, that I need to invoke:</p>

<pre><code>public interface IObjectProvider&lt;T&gt;
{
    T Get(Predicate&lt;T&gt; condition);
}
</code></pre>

<p>This will provide me with a <code>T</code> from whatever kind of source, that meets the predicate criteria.</p>

<p>Now, this has to be called from a context where all I have is the following:</p>

<pre><code>//the actual predicate that's going to be evaluated
var predicate = predicateProperty.GetValue(invocation.InvocationTarget, null);

//The type that should go into the call as type param
Type relationTargetType = relationDefinition.RelatedType;
</code></pre>

<p>As you might guess, the compiler won't let me use the <code>predicate</code> variable as parameter. What I need to do is convert this object into a Predicate, but Generic type params must be compile-time-constant, so this won't work.</p>

<p>I've started messing around with this, but no success so far:</p>

<pre><code>Type genericPredicateType = typeof(Predicate&lt;&gt;);
Type specificPredicateType= genericPredicateType.MakeGenericType(relationTargetType);
Convert.ChangeType(predicate, specificPredicateType)
</code></pre>

<p>How on earth can I mash this up?</p>

<p><strong>EDIT:</strong> I thought this was a rather use-case-agnostic question, but obviously I was wrong. So, since there is such a fuss as to what I do, what I have and why and whatnot, here's a lot more background info. I am trying to resolve relations between objects in a Proxy (Castle Dynamic Proxy). The following Snippet should explain the kind of relation I want to depict:</p>

<pre><code>public class Order
{
    public virtual int Id { get; set; } // OR-Mapped
    public virtual DateTime OrderDate { get; set; } // OR-Mapped

    [RelatedObject(typeof(Address), "DeliveryAddressPredicate")]
    public virtual Address DeliveryAddress { get; set; }

    public Predicate&lt;Address&gt; DeliveryAddressPredicate
    {
        get { return new Predicate&lt;Address&gt;(a =&gt; OrderDate &gt;= a.ValidFrom &amp;&amp; OrderDate &lt;= a.ValidTo); }
    }
}

public class Address
{
    public virtual DateTime ValidFrom { get; set; } // OR-Mapped
    public virtual DateTime ValidTo { get; set; } // OR-Mapped

    //Not OR-Mapped
    [RelatedList(typeof(Order), "OrdersPredicate")]
    public virtual IList&lt;Order&gt; Orders { get; set; }

    public Predicate&lt;Order&gt; OrdersPredicate
    {
        get { return new Predicate&lt;Order&gt;(o =&gt; o.OrderDate &gt;= ValidFrom &amp;&amp; o.OrderDate &lt;= ValidTo); }
    }
</code></pre>

<p>To sum it up, this is supposed to become a Fuzzy OR-Mapping, meant to extend NHibernate in a project or two.</p>

<p>How did I mean to get this to work? The address is proxied, and when a call to a property with one of my CustomAttributes is made, i use DynamicProxy's IInterceptor interface to resolve the relation. The main problem is that this resolving has to happen in the IInterceptor.Intercept() Method which has only one Param (<a href="http://www.codeproject.com/Articles/9055/Castle-s-DynamicProxy-for-NET" rel="nofollow">see here</a>), and I have no generic type param available. So, in the end it all boils down to a simple .Net question again: I have a <code>Type</code> stored in a variable and a <code>Method</code> that has to be called with a parameter generic of the aforesaid type...</p>

<p>Sorry for any mistakes made (like calling <code>var</code> a <code>Type</code> - man that was a rough one), it's been quite a day ;-)</p>
 How can we reduce the property proxying overhead of NHibernate? <p>We are using Fluent NHibernate 1.3.0.727 and NHibernate 3.3.0.4000 to map our properties to columns in the database. Here is an abbreviated sample of one of our ClassMaps:</p>

<pre><code>    public class TankMap : ClassMap&lt;Tank&gt;
    {
        public TankMap()
        {
            Id(o =&gt; o.Id);
            Map(o =&gt; o.TankSystem);
        }
    }
</code></pre>

<p>In this case the TankSystem property is a <strong>string</strong>.</p>

<p>In parts of our application there is a lot of calculations that involve accessing the mapped properties (such as TankSystem) numerous times. When we profile the application, simply accessing these properties takes a up a considerable amount of time because each time they are accessed, it has to go through the NHibernate.Proxy.DefaultLazyInitializer.Intercept method.</p>

<p>We need to make our calculations as fast as possible and would like to avoid this proxying overhead. One approach is to copy the properties that we want (eg. TankSystem) into arrays and use the arrays any time we want to access this information, but then this is not a very object-oriented approach.</p>

<p><strong>Update:</strong></p>

<p>We have tried mapping our properties using Not.LazyLoad, for example:</p>

<pre><code>Map(o =&gt; o.TankSystem).Not.LazyLoad();
</code></pre>

<p>However, this does not seem to have any effect on whether this property is actually proxied.</p>

<p>Is there any kind of option to avoid/reduce this proxying overhead?</p>
 How to avoid double construction of proxy with DynamicProxy::CreateClassProxyWithTarget? <p>I am decorating an existing object using the <code>CreateClassProxyWithTarget</code> method. However, the constructor and therefore, initialization code, is being called twice. I already have a "constructed" instance (the target). I understand why this happens, but is there a way to avoid it, other than using an empty constructor?</p>

<p>Edit: Here is some code:</p>

<p>First the proxy creation:</p>

<pre><code>public static T Create&lt;T&gt;(T i_pEntity) where T : class
{
  object pResult = m_pGenerator.CreateClassProxyWithTarget(typeof(T),
                                                           new[] 
                                                             { 
                                                                typeof(IEditableObject),
                                                                typeof(INotifyPropertyChanged) ,
                                                                typeof(IMarkerInterface),
                                                                typeof(IDataErrorInfo)
                                                             },                                                               
                                                           i_pEntity,
                                                           ProxyGenerationOptions.Default,
                                                           new BindingEntityInterceptor&lt;T&gt;(i_pEntity));
  return (T)pResult;
}
</code></pre>

<p>I use this for example with an object of the following class:</p>

<pre><code>public class KatalogBase : AuditableBaseEntity
{
   public KatalogBase()
   {
     Values     = new HashedSet&lt;Values&gt;();
     Attributes = new HashedSet&lt;Attributes&gt;();
   }
   ...
}
</code></pre>

<p>If i now call <code>BindingFactory.Create(someKatalogBaseObject);</code> the <code>Values</code> and <code>Attributes</code>
properties are beeing initialized again.</p>
 Castle.Windsor: Changes for factories and interceptors in 3.1? <p>The following code passes as-is with Castle.Windsor 2.5.3 but fails after upgrading to 3.1.0</p>

<p>The exception is an InvalidProxyConstructorArgumentsException and it states "Can not instantiate proxy of class: Test. Could not find a parameterless constructor."</p>

<pre><code>    static void Main(string[] args)
    {
        var container = new WindsorContainer();
        container.Register(Component.For&lt;Interceptor&gt;(),
                           Component.For&lt;Test&gt;().UsingFactoryMethod(() =&gt; new Test(""))
                                                .Interceptors&lt;Interceptor&gt;());

        var test = container.Resolve&lt;Test&gt;(); //THROWS IN 3.1.0
    }
}

public class Test
{
    public readonly string S;

    public Test(string s)
    {
        S = s;
    }
}

public class Interceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        invocation.Proceed();
    }
}
</code></pre>

<p>In my real code Test is a MongoDatabase that is being constructed using a factory method and injected into a Repository.  </p>

<p>In my real code I'm also using an inheritor to an AbstractFacility to register the interceptor. This way I don't have to register the interceptor for each component. Both forms of interceptor usage seem to work/fail (in 2.5.3/3.1.0) the same way on later resolution.  For reference here is a shortened version of the facility:</p>

<pre><code>public class Facility : AbstractFacility
{
    protected override void Init() { Kernel.ComponentRegistered += KernelComponentRegistered; }

    static void KernelComponentRegistered(string key, IHandler handler)
    {
        if (typeof(IInterceptor).IsAssignableFrom(handler.ComponentModel.Implementation)) return;
        handler.ComponentModel.Interceptors.AddIfNotInCollection(InterceptorReference.ForKey("SomeInterceptor"));
    }
}
</code></pre>

<p>I looked at the Castle.Windsor source code and the throwing code is expecting to wrap a proxy around the class it is given which is why it's looking for a parameterless constructor.  However in 2.5.3 I think the proxy generation code never got executed and the container resolves (correctly in my mind) to a non-proxy version of Test/MongoDatabase</p>

<p>So two questions I guess:
1) What's changed?
2) How do I keep my interceptor registration without generating a proxy for the object resolved by the factory method?  Or I guess how does a proxy get generated using a factory method for the component...</p>
 How to write interceptor for methods returning IEnumerable 

<p>I wrote simple interceptor (with Castle.DynamicProxy) to handle database connection life cycle. I.e. all services have Connection property which opens new one on first use. Connection is being closed automatically after each method call:</p>

<pre class="lang-cs prettyprint-override"><code>class CloseConnectionInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        try
        {
            invocation.Proceed();
        }
        finally
        {
            var hasConnection = invocation.InvocationTarget as IHasConnection;
            if (hasConnection.IsConnectionOpen)
            {
                hasConnection.Connection.Dispose();
                hasConnection.Connection = null;
            }
        }
    }
}

interface IHasConnection
{
    bool IsConnectionOpen { get; }
    Connection Connection { get; set; }
}
</code></pre>

<p>It works well except for methods returning iterator:</p>

<pre class="lang-cs prettyprint-override"><code>[Test]
public void ConnectionClosedByProxy()
{
    // arrange
    var service = new MyService();
    var proxy = new ProxyGenerator()
        .CreateInterfaceProxyWithTarget&lt;IMyService&gt;(
            service, new CloseConnectionInterceptor());

    // act
    proxy.GetList();

    // assert: works!!!
    Assert.IsFalse(service.IsConnectionOpen);
}

[Test]
public void IteratorLeavesOpenConnection()
{
    // arrange
    var service = new MyService();
    var proxy = new ProxyGenerator()
        .CreateInterfaceProxyWithTarget&lt;IMyService&gt;(
            service, new CloseConnectionInterceptor());

    // act
    proxy.GetEnumerable().ToList();

    // assert: bad, bad, bad!
    Assert.IsTrue(service.IsConnectionOpen);
}
</code></pre>

<p>See full example here: <a href="https://gist.github.com/4087483" rel="nofollow">https://gist.github.com/4087483</a></p>

<p>If there is "using (new Connection())" statement inside my GetEnumerable method then it works as expected - connection is being closed after last access to iterator. Is it possible to catch this moment in interceptor? Or should I proxy not only method but also resulting IEnumerable?</p>
 Castle DynamicProxy2: Get the Target inside an Interceptor? <p>I'm using Castle DynamicProxy2 to "tack on" interfaces to retrieve fields from a dictionary.  For example, given the following class:</p>

<pre><code>public class DataContainer : IDataContainer
{
    private Dictionary&lt;string, object&gt; _Fields = null;

    public Dictionary&lt;string, object&gt; Data
    {
        get { return _Fields ?? (_Fields = new Dictionary&lt;string, object&gt;()); }
    }
}
</code></pre>

<p>I want to use the following interface as an interface proxy to extract the "Name" value out of the Fields dictionary:</p>

<pre><code>public interface IContrivedExample
{
    string Name { get; }
}
</code></pre>

<p>From an interceptor, I want to get the "target" DataContainer, and return the "Name" value:</p>

<pre><code>public void Intercept(IInvocation invocation)
{
    object fieldName = omitted; // get field name based on invocation information

    DataContainer container = ???; // this is what I'm trying to figure out
    invocation.ReturnValue = container.Fields[fieldName];
}

// Somewhere in code
var c = new DataContainer();
c.Fields.Add("Name", "Jordan");

var pg = new ProxyGenerator();
IContrivedExample ice = (IContrivedExample) pg.CreateInterfaceProxyWithTarget(..., c, ...);
Debug.Assert(ice.Name == "Jordan");
</code></pre>

<p>Any thoughts on how to get the underlying target</p>

<p>Note: this is a contrived example I'm using to establish some context around the question I have.</p>
 Castle.DynamicProxy2 and Adding a Property at Run Time <p>I am using Castle.DynamicProxy2 and I am instantiating my proxy as such:</p>

<pre><code>private static T GenerateProxy()
{   
    ArrayList addtlInterfaces = new ArrayList();

    addtlInterfaces.Add(typeof (INotifyPropertyChanged));
    addtlInterfaces.Add(typeof (EntityStatus));

    object entityProxy = ProxyGenerator.CreateClassProxy(typeof(T), 
                                                          addtlInterfaces.ToArray(typeof(Type)) as Type[],
                                                          ProxyGenerationOptions.Default,
                                                          new IInterceptor[] { new LazyInterceptor() });


    return (T)entityProxy;
}
</code></pre>

<p>My interface of IEntityStatus looks like such:</p>

<pre><code>public interface  IEntityStatus
{
    bool IsDirty
    { get; set;}
}
</code></pre>

<p>I need to be able to use that property during run time so that when my DTO has a property changed event the event could set the DTO to dirty.  However because it is an interface and has no explicit implementation I am at a loss as to how to do this.  Creating a delegate for the get and set method is an option I would like to avoid.  So is there another way to achieve what I am looking to achieve?</p>

<p>I realize I could set up a collection of all my active DTOs and when the property changed event fires on one of the DTOs I could update that collection to show that this particular DTO is dirty, but I would really like for this information to be a part of the proxied DTO for pure syntactic ease.</p>

<p>Look forward to responses!</p>
 Castle.DynamicProxy2 generate proxy of delegate type <p>Is there a way to create a proxy of a delegate type and have it implement additional interfaces in DynamicProxy2 and also being able to intercept calls to the generated delegate?</p>

<p>The way i normaly generate proxies throws an exception because delegate types are sealed.</p>
 castle dynamic proxy creation <p>I am implementing a design where my layer would sit between client and server, and whatever objects i get from server, i would wrap it in a transparent proxy and give to the client, that way i can keep a track of what changed in the object, so when saving it back, i would only send changed information.</p>

<p>I looked at castle dynamic proxy, linfu, although they can generate a proxy type, but they cant take existing objects and wrap them instead.</p>

<p>Wondering if its possible to do with these frameworks, or if there any other frameworks that enable this...</p>
 can you use castle dynamic proxies on web services references? <p>Is it possible to create a dynamic proxy on the a web service reference that has been added to a visual studio project?</p>

<p>I've added the web service reference in the normal way and tried to create a dynamic proxy using castle to wrap the method invocation in a try/catch to translate any SoapExceptions, but on running it I'm getting a lot of errors around non serializable classes?</p>

<p>has anyone done anything like this?</p>

<p>thanks</p>
 
linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu linfu What are the differences between LinFu.DynamicProxy and Castle.DynamicProxy? <p>I am looking at adding logic to a library I am working on that would require the need for a Dynamic Proxy.  I would like to get some advice from user's who have used these two library's in a production environment.  Does one out perform the other, were there any shortcoming's which made you have to switch to the other, etc.  Basically tell me your experiences with the library's.  The answers will help me decide which one to use.</p>

<p>-- Edit --</p>

<p><hr /></p>

<p>I forgot to mention that the library I am developing will support Mono, therefore any knowledge you can share about the two libraries and their support for Mono would be great also.</p>
 NHibernate.ByteCode.LinFu.dll For NHibernate 3.2 <p>Where can I find the latest version of NHibernate.ByteCode.LinFu.dll that is compiled against NHibernate 3.2?</p>
 Nhibernate does not work after upgrade to version 2.1.2 <p>I recently changes my NHibernate implementation from Version 2.1.0 to 2.1.2. For lazy loading I used the LinFu implementation using : NHibernate.ByteCode.Linfu.</p>

<p>Since I changed to the newest version I got the following error:</p>

<pre><code> [SecurityException: That assembly does not allow partially trusted callers.]
  NHibernate.ByteCode.LinFu.ProxyFactory..cctor() +0
</code></pre>

<p>When debugging I came to the following error:</p>

<pre><code>   at NHibernate.ByteCode.LinFu.ProxyFactory..ctor()
   at NHibernate.ByteCode.LinFu.ProxyFactoryFactory.BuildProxyFactory()
   at NHibernate.Tuple.Entity.PocoEntityTuplizer.BuildProxyFactoryInternal(PersistentClass class, IGetter getter, ISetter setter)
   at NHibernate.Tuple.Entity.PocoEntityTuplizer.BuildProxyFactory(PersistentClass persistentClass, IGetter idGetter, ISetter idSetter)
   at NHibernate.Tuple.Entity.AbstractEntityTuplizer..ctor(EntityMetamodel entityMetamodel, PersistentClass mappingInfo)
   at NHibernate.Tuple.Entity.PocoEntityTuplizer..ctor(EntityMetamodel entityMetamodel, PersistentClass mappedEntity)
   at NHibernate.Tuple.Entity.EntityEntityModeToTuplizerMapping..ctor(PersistentClass mappedEntity, EntityMetamodel em)
   at NHibernate.Tuple.Entity.EntityMetamodel..ctor(PersistentClass persistentClass, ISessionFactoryImplementor sessionFactory)
   at NHibernate.Persister.Entity.AbstractEntityPersister..ctor(PersistentClass persistentClass, ICacheConcurrencyStrategy cache, ISessionFactoryImplementor factory)
   at NHibernate.Persister.Entity.SingleTableEntityPersister..ctor(PersistentClass persistentClass, ICacheConcurrencyStrategy cache, ISessionFactoryImplementor factory, IMapping mapping)
   at NHibernate.Persister.PersisterFactory.CreateClassPersister(PersistentClass model, ICacheConcurrencyStrategy cache, ISessionFactoryImplementor factory, IMapping cfg)
   at NHibernate.Impl.SessionFactoryImpl..ctor(Configuration cfg, IMapping mapping, Settings settings, EventListeners listeners)
   at NHibernate.Cfg.Configuration.BuildSessionFactory()
   at MyApplication.SessionManager..ctor() in C:\Projects\MyApps\MyApplication\SessionManager.cs:line 75
</code></pre>

<p>Is this because of the usage of NHibernate.ByteCode.LinFu? What can I do about it to make the application work again?</p>
 Ninject Interception dynamic proxy problems <p>I'm trying to set up interception to work with Ninject which we have been using as our dependency injection framework for a while.</p>

<p>I have downloaded the interception extension from NuGet and tried it with both the Castle Dynamicproxy implementation and the LinFu implementation but could not be either to work with our applications.</p>

<p>Castle gave an error when creating a proxy on a class that did not have a parameterless constructor, since all the service objects have their dependencies injected via the constructor this is a problem. The error is:</p>

<p>System.ArgumentException: Can not instantiate proxy of class: emedia.RapidSystems.Subscriber.Presenters.RRSubmissionPresenter.
Could not find a parameterless constructor.
Parameter name: constructorArguments</p>

<p>The LinFu interceptor worked better, right up until the code called a method with a generic parameter then it gave me the following:</p>

<p>System.ArgumentException: Generic types are not valid.
Parameter name: methodInfo</p>

<p>Here is a simplified version code for one of the classes I am trying to intercept:</p>

<pre><code>[LogCalls]
public class Repository&lt;T&gt; : IRepository&lt;T&gt;
        where T : class
{   
    public virtual T GetEntity&lt;TKey&gt;(ObjectContext context, TKey key)
    {
        var entity = GetEntity(context, key, _emptyLoadingStrategy);
        return entity;
    }

    public virtual IQueryable&lt;T&gt; GetAll(ObjectContext context)
    {
        var query = GetAll(context, _emptyLoadingStrategy);
        return query;
    }

    public virtual T Add(ObjectContext context, T entity)
    {
        context.AddObject(EntitySetName(context), entity);
        return entity;
    }

     //other code goes here

}
</code></pre>

<p>Add and GetAll work fine but the error happens when GetEntity is called on the proxy.</p>

<p>At this point I'm stuck, as neither interceptor works with the code base. Has anyone got Ninject interception working with a real complex production system, rather than a simple demo class, and if so how? I don't mind which interceptor I use as long as it works.</p>

<p>Or is interception with Ninject just not mature enough yet, and do I need to look at replacing the whole thing with something else like Unity?</p>
 Using Automapper with LinFu.DynamicProxy in commercial application <p>We want to use Automapper in commercial application (.NET 3.5). To get the clearance we need the source code of automapper.</p>

<p>We got the required automapper source code but after building the code we found that the size of automapper.dll 86KB while the DLL we were using was of 108 KB. Application was not working with this 86KB automapper dll</p>

<p>We looked into the code and found that another DLL LinFu.DynamicProxy of size 21KB . If I use this DLL with automapper DLL application works fine.</p>

<p>Based on that I conclude that the 108KB dll that I was using actually contains 86KB Automapper  + 21 KB LinFu.DynamicProxy.</p>

<p>Now I have question related to licensing. Do I need to get the approval for LinFu.DynamicProxy as well. It comes with GNU license.</p>
 LinFu version in NHibernate 2.1 <p>I'm migrating the data layer of our application to NH version 2.1.0 (from 2.0.1) and noticed the use of LinFu. I discovered that framework and want to use it in other pieces of the application, especially I want to use the LinFu.Reflection.dll, which requires a reference to LinFu.DynamicProxy and here comes the trouble, the 1.0 final version of LinFu that I can find on google.code is not the same version used by NHibernate itself. Do I need to rebuild NHibernate.ByteCode.LinFu.dll changing the reference to the available version? If not, what else?</p>
 Creating LinFu interceptors for all types within an assembly <p>I'm trying to create LinFu interceptors for all methods in my DAL assembly. While I can do something like this:</p>

<pre><code>[Intercepts(typeof(IFirstRepository))]
[Intercepts(typeof(ISecondaryRepository))]
[Intercepts(typeof(IIAnotherRepository))]
public class DalInterceptor : IInterceptor, IInitialize
{
... 
}
</code></pre>

<p>that's getting quite messy and needs manual updating every time a new repository is added to the assembly.</p>

<p>Is there a way to automatically create a proxy class for each type in the assembly?</p>

<p>UPDATE:</p>

<p>I've updated my proxy builder using the suggestion from the author himself (Mr Laureano) so I now have this:</p>

<pre><code>Func&lt;IServiceRequestResult, object&gt; createProxy = request =&gt;
{
    var proxyFactory = new ProxyFactory();
    DalInterceptor dalInterceptor = new DalLiteInterceptor();
    return proxyFactory.CreateProxy&lt;object&gt;(dalInterceptor);
};
</code></pre>

<p>The interceptor is set up as before. The issue I'm having now is that the proxy object doesn't include the constructors and methods of the original object (I'm guessing as I'm using object in the generic create method).</p>

<p>Do I just cast this back to the required type or am I doing something fundamentally wrong?</p>

<p>Thanks.</p>
 LinFu IoC Best Practices on High Traffic Websites <p>We’re in the final stages of putting together a quite high traffic website (approx 6 million page impressions per week) and are using LinFu as the IoC container within the new architecture.</p>

<p>We have a pretty standard setup:</p>

<pre><code>Web Layer
 |
IServices &lt;- Services Implementation
 |
IDataRepository &lt;- DataRepository Implementation
 |
DataBase
</code></pre>

<p>In the web layer, we have an instance of the LinFu ServiceContainer (a singleton in our implementation) that provides instances of Services objects as required by the pages. Each of the classes within the DataRepository assembly is also created in the same way (each Services constructor takes in the interfaces of DataRepository objects that it requires).</p>

<p>A quick example would be:</p>

<pre><code>IWeatherServices
{
    Weather GetForecast();
    Weather GetPrediction();
}

[Implements(typeof(IWeatherServices))
WeatherServices(IWeatherForecastRepository, IWeatherPredictionRepository) : IWeatherServices
{
    // implementation of methods
}
</code></pre>

<p>(and similar functionality again for the DataRepository classes)</p>

<p>We’ve left the lifecycle type as the default at the moment (I believe this is PerRequest).</p>

<p>My main questions would be:</p>

<ul>
<li>Should we be keeping the ServiceContainer as a singleton within the web app?</li>
<li>Should the LifecycleType on the implementing classes be kept as the default values?</li>
</ul>

<p>I know this is a little open-ended but we're in the process of tuning during load testing so am very interested in the general opinion.</p>
 Backing field for collection is null when using LinFu ProxyFactoryFactory in NHibernate <p>I am having a problem when I try switching from the Castle ProxyFactoryFactory to the LinFu ProxyFactoryFactory in NHibernate.</p>

<p>I have an entity like this:</p>

<pre><code>public class Foo
{
    private ISet&lt;Bar&gt; _bars = new HashedSet&lt;Bar&gt;();

    public virtual void AddBar(Bar bar)
    {
       if (!_bars.Contains(bar)
            _bars.Add(bar);

       bar.Foo = this;
    }
}
</code></pre>

<p>This is mapped with Fluent NHibernate like this:</p>

<pre><code>public class FooDbMap : ClassMap&lt;Foo&gt;
{
     public FooDbMap()
     {
          HasMany(x =&gt; x.Bars)
              .Access.CamelCaseField(Prefix.Underscore)
              .LazyLoad()
              .KeyColumn("FooId")
              .AsSet()
              .Cache.ReadWrite();
     }
}
</code></pre>

<p>The relationship is bi-directional and is mapped as such on the Bar side too.</p>

<p>The problem occurs when I call the AddBar method. The _bars collection is null, and a NullReferenceException is thrown.</p>

<p>The problem goes away if I switch back to the Castle ProxyFactoryFactory.</p>

<p>The error doesn't occur with all mapped collections, just this one instance.</p>

<p>The problem still occurs even if I change _bars to readonly! So someone is managing to set a readonly field back to null, even after the field has been assigned.</p>

<p>Any ideas?</p>
 Duck typing / dynamic proxies on existing instances of objects <p>I have an object handed into our library and passed through various processes. I need to attach some additional information to these objects as they pass through various stages and out the other end - a kind of dynamic decorator pattern, I guess, except adding additional properties rather than changing existing behaviour.</p>

<p>I was hoping to use LinFu or Castle to create a dynamic proxy and implement an additional interface on the object to store this. Components that know about the extended interface could cast and access it - whilst those that are not are oblivious, as the underlying type has not changed.</p>

<p>However, I hadn't appreciated that all these mechanisms assume you have control over the point at which the type is initially created - which I don't.</p>

<p>Does anyone have suggestions on how I could better approach this?</p>

<p>Many thanks</p>
 Is there a better way to do IOC in asp.net-mvc? <p>I have an asp.net-mvc site and I am using LinFu to do IOC.  I ran into an issue where a number of actions have a dependency that I want to inject into the controller but i only want to initialize the dependency if i call the action that depends on it.</p>

<p>so in my controller I have this code in my controller:</p>

<pre><code>   public PersonController
   {

    private IPeopleImporter _peopleImporter;

    public override void Initialize(LinFu.IoC.Interfaces.IServiceContainer source)
    {
        _peopleImporter= source.GetService&lt;IPeopleImporter&gt;();
        base.Initialize(source);
    }

    public JsonResult GetDetails(int id)
    {
        var p = _peopleImporter.Get(id);
        var personDetails = new {p.Id, p.FirstName, p.LastName, StandardId = p.StandardIdLogin, p.PersonNumber};
        return Json(personDetails);
    }
   }
</code></pre>

<p>to initiatize PeopleImporter is pretty expensive so my issue is that I want to solve two things:</p>

<ol>
<li><p>I want to make the implementatioo of IPeopleImporter "pluggable" so I can IOC in the interface into the controller</p></li>
<li><p>I have a lot of actions so I don't want the cost of initiatizing the IPeopleImporter if the user never calls the specific action that needs it.  It seems like in the code above I do that initiatization on every call of PersonController</p></li>
</ol>

<p>My initiatization code is like this:</p>

<pre><code>this.AddService(typeof(IPeopleImporter), typeof(DatabaseImporter), LifecycleType.Singleton);
</code></pre>

<p>This seems like common pattern / issue.  Is there a recommended solution.  in the meantime, the alternative (to avoid the performance hit is to simple "new" up the concete implmentation inside the controller (and avoid IOC) ?</p>
 Dynamic Proxy generation with LinFu <p>I am trying to build a dynamic proxy for an interface with LinFu. The proxy should just implement the getter methods of the properties that are defined by the interface and return for instance a value from a dictionary, where the key is the property name.</p>

<p><a href="http://code.google.com/p/linfu/" rel="nofollow">link text</a></p>
 ninject Linfu databound proxy object <p>I have the following scenario.</p>

<p>I have a ViewModel object (It's just a regular object, that impliments INotifyPropertyChanged).  I'm binding this object to a view, written in WPF.  When I bind it it works fine, events fire, and things are updated, perfect!!!</p>

<p>Now I've tried to introduce some validation into the object, I'm checking argument values before the method is called, and throwing an ArgumentException if they're bad.</p>

<p>I'm using Ninject for my DI, and I've decided to use LinFu for the proxy factory.  I'm using a static attribute on the method that I want to intercept.  I'm also loading the LinfuIntegration Module before any of my other modules.  As soon as I put an attribute on the object, it appears as though none of the INotifyPropertyChanged events are being fired.  Actually when I look at the event it's still null, which tells me that my view hasn't subscribed to it.</p>

<p>I tried to do the same with the Castle Dynamic proxy, and got the same results</p>

<p>Has anyone out there used a any of the proxy options in Ninject to a databound object in WPF.
My guess is has something to do with the proxy being a subclass of what WPF expects to actually be there, but I'm not sure.
I'll post some code if you need it, but I figured I'd put the question out there first.</p>

<p>thank</p>

<p>Josh</p>
 LinFu - can't quite see how to do what I want <p>Just found LinFu - looks very impressive, but I can't <em>quite</em> see how to do what I want to do  - which is multiple inheritance by mixin (composition/delegation as I'd say in my VB5/6 days - when I had a tool to generate the tedious repetitive delegation code - it was whilst looking for a C# equivalent that I found LinFu).</p>

<p>FURTHER EDIT: TO clarify what I mean by composition/delegation and mixin. </p>

<pre><code>public class Person : NEOtherBase, IName, IAge 
{

    public Person()
    {

    }

    public Person(string name, int age)
    {
        Name = name;
        Age = age;
    }

    //Name "Mixin" - you'd need this code in any object that wanted to
    //use the NameObject to implement IName
    private NameObject _nameObj = new NameObject();

    public string Name
    {
        get { return _nameObj.Name; }
        set { _nameObj.Name = value; }
    }
    //--------------------

    //Age "Mixin" you'd need this code in any object that wanted to
    //use the AgeObject to implement IAge
    private AgeObject _ageObj = new AgeObject();

    public int Age
    {
        get { return _ageObj.Age; }
        set { _ageObj.Age = value; }
    }
    //------------------

}

public interface IName
{
    string Name { get; set; }
}

public class NameObject : IName
{
    public NameObject()
    {}

    public NameObject(string name)
    {
        _name = name;
    }

    private string _name;
    public string Name { get { return _name; } set { _name = value; } }

}

public interface IAge 
{
    int Age { get; set; }
}

public class AgeObject : IAge
{
    public AgeObject()
    {}

    public AgeObject(int age)
    {
        _age = age;
    }

    private int _age;
    public int Age { get { return _age; } set { _age = value; } }

}
</code></pre>

<p>Imagine objects with many more properties, used in many more "subclasses" and you start to see the tedium. A code-gernation tool would actually be just <em>fine</em>...</p>

<p>So, LinFu....
The mixin example below is fine but I'd want to have an actual Person <em>class</em> (as above) - what's the LinFu-esque way of doing that? Or have I missed the whole point? </p>

<p>EDIT: I need to be able to do this with classes that are already subclassed.</p>

<pre><code>DynamicObject dynamic = new DynamicObject();

IPerson person = null;

// This will return false
bool isPerson = dynamic.LooksLike&lt;IPerson&gt;();

// Implement IPerson
dynamic.MixWith(new HasAge(18));
dynamic.MixWith(new Nameable("Me"));

// Now that it’s implemented, this
// will be true
isPerson = dynamic.LooksLike&lt;IPerson&gt;();

if (isPerson)
    person = dynamic.CreateDuck&lt;IPerson&gt;();

// This will return “Me”
string name = person.Name;

// This will return ‘18’
int age = person.Age;
</code></pre>
 castle dynamic proxy creation <p>I am implementing a design where my layer would sit between client and server, and whatever objects i get from server, i would wrap it in a transparent proxy and give to the client, that way i can keep a track of what changed in the object, so when saving it back, i would only send changed information.</p>

<p>I looked at castle dynamic proxy, linfu, although they can generate a proxy type, but they cant take existing objects and wrap them instead.</p>

<p>Wondering if its possible to do with these frameworks, or if there any other frameworks that enable this...</p>
 Finding target of LinFu proxy object <p>This is pretty much a duplicate question but instead of using Castle Dynamic Proxy I'm using LinFu <a href="http://stackoverflow.com/questions/1415675/getting-underlying-type-of-a-proxy-object">http://stackoverflow.com/questions/1415675/getting-underlying-type-of-a-proxy-object</a></p>

<p>I'm using automapper to create proxies of interfaces that I'm sending to my viewmodel in Asp.net MVC.  My problem is from what I can tell that MVC's default MetadataProvider find the properties and metadata by calling .GetType() on the model.</p>

<p>So what happens is EditorFor() and DisplayFor() templates don't generate any fields.  What I need to do is find the proxy target type and then generate my templates.  I know I can just parse the name and use GetType( "thename" ) but was wondering if there was an easy way.</p>
 Lin Fu Interceptor <p>How can i implement automatic InotifypropertyChanged with LinFu?</p>
 How to intercept, parse and compile? <p>This is a problem I've been struggling to solve for a while. I need a way to either replace code in the method with a parsed code from the template at compile time (PostSharp comes to mind) or to create a dynamic proxy (Linfu or Castle). So given a source code like this</p>

<pre><code>[Template]

private string GetSomething()

{

var template = [%=Customer.Name%]

}
</code></pre>

<p>I need it to be compiled into this</p>

<pre><code>private string GetSomething()

{

MemoryStream mStream = new MemoryStream();

            StreamWriter writer = new StreamWriter(mStream,System.Text.Encoding.UTF8);

writer.Write(@"" );

writer.Write(Customer.Name);

StreamReader sr = new StreamReader(mStream); 

writer.Flush();

mStream.Position = 0; 

return sr.ReadToEnd();

}
</code></pre>

<p>It is not important what technology is used. I tried with PostSharp's ImplementMethodAspect but got nowhere (due to lack of experience with it). I also looked into Linfu framework. Can somebody suggest some other approach or way to do this, I would really appreciate. My whole project depends on this.</p>

<p><strong>Assumptions:</strong></p>

<ol>
<li>Code can appear in any class.</li>
<li>Template code will always be annotated with attribute [Template]</li>
<li>Template method will always return string.</li>
</ol>

<p>Parsing of the code from one form to another is already done. Now I just need a way to replace it. </p>

<p>"Beefer" example:</p>

<pre><code>  [Test]
        public void can_parse_csharp_code_template3()
        {
            var template = @"&lt;template&gt; [%= GetUsing() %]
    namespace [%= GetModelNamespaceName(.metaPackage) %]
    {
    [%= .visibility.ToString().ToLower() %] class [%= .Name %] : INotifyPropertyChanged [%= If(.IsPersistent, "", PersistenObject"", """") %]
        {
            #region Constructors
            [%= ConstructorTemplate.Create(metaObject).GetParameterlessConstructorCode %]
            #endregion

            #region Attributes

            [%= From attribute In metaObject.attributes _
                Select (AttributeTemplate.Create(attribute).GetSourceCode) %]
            #endregion

            #region Relationships
            [%= From relationship As Relationship In metaObject.relationships _
                Select (RelationshipTemplateFactory.CreateFor(relationship).GetSourceCode()) %]
            #endregion

            #region Methods
            [%= From operation In metaObject.operations _
                Select (MethodTemplate.Create(operation).GetSourceCode) %]
            #endregion

            #region ""INotifyPropertyChanged""
            [%= GetOnPropertyChanged() %]
            #endregion
            }
        }&lt;/template&gt;";

            Console.WriteLine(TemplateParser.GetParsedResult(template));

        }
</code></pre>
 is linfu 2.3 released anywhere? <p>i see projects and articles that reference linfu.core version 2.3 but when i go <a href="http://code.google.com/p/linfu/downloads/list" rel="nofollow">to the linfu website here</a>, i only see version 2.2.</p>

<p>does anyone know where to download linfu.core version 2.3 ??</p>
 cost of .net dynamic proxies <p>What is the cost of using dynamic proxies?</p>

<p>I do not want to clutter my project with Interface Implementations, so I am considering using Dynamic proxies created by some 3rd party library like LinFu , Castle, Unity etc. Do they generate one instance per interface or do I get one for each call.</p>

<p>It is a web app, so whats the performance problem in the long run. </p>

<p>I am also using EF 4.1 (CTP5 at the moment), so if does create proxy classes itself, which makes me wonder if I can use EF's own Dynamic Proxy creating tools.</p>

<p>P.S. yes my interfaces are implemented by concrete classes along with other interfaces and base classes, but sometimes I only need the interface portion of it and not the extra stuff that comes with the concrete class.</p>

<p>All interfaces declare just some part of an EF4.1 POCO. So just getters and setters.</p>
 Where to find the LinFu bytecode provider for NH3.2? <p>It's not included within the 3.2 release of NHibernate and I cannot find it anywhere.<br>
Where can it be found?</p>
 Proxy exposing multiple interfaces with Ninject.Extensions.Interception.Linfu <p>I'm using <code>Ninject.Extensions.Interception</code> (more specifically, <code>InterceptAttribute</code>) and <code>Ninject.Extensions.Interception.Linfu</code> proxying to implement a logging mechanism in my C# app, but I am facing some problems when a proxied class implements several interfaces.</p>

<p>I've a class which implements an interface and inherits from an abstract class.</p>

<pre><code>public class MyClass : AbstractClass, IMyClass {
  public string SomeProperty { get; set; }
}


public class LoggableAttribute : InterceptAttribute { ... }

public interface IMyClass {
  public string SomeProperty { get; set; }
}

public abstract class AbstractClass {

  [Loggable]
  public virtual void SomeMethod(){ ... }
}    
</code></pre>

<p>When I try to get an instance of MyClass from ServiceLocator, the <em>Loggable</em> attribute causes it to return a proxy.</p>

<pre><code>var proxy = _serviceLocator.GetInstance&lt;IMyClass&gt;();
</code></pre>

<p>The problem is the proxy returned only recognizes the <em>AbstractClass</em> interface, exposing <em>SomeMethod()</em>. Consequentially, I receive an <code>ArgumentException</code> when I try to access the inexistent <em>SomeProperty</em>.</p>

<pre><code>//ArgumentException
proxy.SomeProperty = "Hi";
</code></pre>

<p>In this case, is there a way of using mixin or some other technique to create a proxy exposing multiple interfaces?</p>

<p>Thanks</p>

<p>Paulo</p>
 Linfu dynamic proxy and Interface methods that return IEnumerable<object> <p>I am using Linfu to generate a proxy object for an interface. Everything works fine except when calling a method that returns an <code>IEnumerable&lt;object&gt;</code> I get an error something like this:</p>

<blockquote>
  <p>Unable to cast object of type '&lt; IEnumerableRpcCall >d__2' to type 'System.Collections.Generic.IEnumerable`1[System.String]'.</p>
</blockquote>

<p>FYI: <code>IEnumerableRpcCall</code> is the name of the method inside the interceptor code that does <code>yield return object</code> rather than <code>return object</code>.</p>

<p>It seems the problem is that linfu is returning a pointer to the method rather than an <code>IEnumerable</code>. Has anyone found a workaround for this?</p>
 Late Binding with LinFu & Oracle.DataAccess <p>is there a good example of the late binding features of the LinFu framework? I developed a framework which is hard linked against a certain version of an Oracle client. Now I would like to be able to configure the version of the client without the need to rebuild the app. How can I do that with LinFu?</p>

<p>Regards,</p>

<p>Alex</p>
 LINFU Creation of View Wrapper <p>I need to create a dynamic object that implements a view.  For instance, if I have a view:</p>

<pre><code>public interface IMyView
{
   int Key { get; set; }
   string Name { get; set; }

   void DoSomething();
}
</code></pre>

<p>I need <a href="http://code.google.com/p/linfu/" rel="nofollow">LINFU</a> to create a proxy for this without knowing about the properties, methods, and potentially events; I simply need the default of it to be that it returns null.  Is this supported?  If so, how do I do that without knowing the specifics of IMyView (will have various interfaces that I need to basically create a dummy).</p>
 Links for Source code required for LinFu.DynamicProxy Version 1.0.3.28303 <p>I require source code for LinFu.DynamicProxy Version 1.0.3.28303
Solution of code should open in Visual Studio 2008.</p>

<p>Thanks</p>
 LinFu.DynamicProxy: What should be returned from IInterceptor.Intercept? <p>I'm trying to write a dynamic proxy with LinFu, using the <code>IInterceptor</code> interface, but I'm having problems finding up-to-date documentation.</p>

<p>What should be returned from the <code>object Intercept(InvocationInfo info)</code> method? Do you have to invoke the method yourself and return the actual return value? It would be nice to just be able to let the call proceed after doing what ever you wanted to do in the interception.</p>

<p><strong>Edit:</strong></p>

<p>Trying to manually call the intercepted method seems to trigger the interception once again, resulting in a stack overflow exception. </p>

<p>I've also tried using the <code>IInvokeWrapper</code> interface, but I had the same issue there.</p>

<p>Thanks,</p>

<p>/Erik Öjebo</p>
 Can I use Linfu dynamic proxy to proxy an interface with generic parameters? <p>I am currently using Linfu to create dynamic proxys, and it works really well for normal interfaces. The problem is I now need to create a dynamic proxy for an interface with generic parameters. I do not know the types of the generic parameters (or even load the assemblies containing them) until runtime. Does anyone know if this is even possible?</p>
 
log4postsharp log4postsharp log4postsharp log4postsharp log4postsharp log4postsharp log4postsharp log4postsharp Filtering log4net on method name - can't quite get it <p>I'm using log4net to log my web app's progress, using Log4PostSharp to AOP-injectify all methods. This has the desired effect of logging (almost) everything and is fine.</p>

<p>I now have a requirement to log JUST Page_Load methods to a file / console. I can obviously hamstring the log4postsharp class to do that, but then I'd be losing all the other logging.</p>

<p>I've been looking at filters in log4net, starting with the StringMatch filter, but that only looks at the message being logged, and I'm after the method name. This put me onto the PropertyFilter, but still with no joy. My log4net.config snippet is thus:</p>

<pre><code>&lt;appender name="RollingLogFileAppender" type="log4net.Appender.RollingFileAppender"&gt;
  &lt;filter type="log4net.Filter.PropertyFilter"&gt;
    &lt;key value="LocationInfo.MethodName"/&gt;
    &lt;stringToMatch value="Page_Load"/&gt;
  &lt;/filter&gt;
  &lt;filter type="log4net.Filter.DenyAllFilter" /&gt;
  &lt;file value="d:\\xxxx\\yyyyy\\zzzzLog"/&gt;
</code></pre>

<p>As you can see, I'm trying to key into the MethodName of the logging event via  LocationInfo, but I'm still getting everything logged. EDIT: As mentioned in the comments, I've now included the DenyAllFilter that I added after RTFM ;-)</p>

<p>Can anyone assist?</p>

<p>Thank you,</p>

<p>Mike K.</p>
 Log4PostSharp for PostSharp 2.0 and .NET framework 2.0 <p>I have a C# project targeting .NET framework 2.0. I also want to use PostSharp 2.0 Community Edition + Log4PostSharp. The problem is that it's not possible to use Log4PostSharp because it targets 3.5 framework. Also it's not possible to change Log4PostSharp's target framework to 2.0, because PostSharp.Sdk (2.0) is built against 3.5 framework.</p>

<p>Any suggestions what can be done to use Log4PostSharp 2.0 in a project targeting 2.0 framework?</p>
 Postsharp and log4net and log4postsharp <p>I stumbled upon log4postsharp <a href="http://code.google.com/p/postsharp-user-plugins/wiki/Log4PostSharp" rel="nofollow">site</a> which is a great tool that uses postsharp for injecting log4net statements into your code at compile time.</p>

<p>The current version of log4postsharp uses Postsharp 1.0 which has some limitations. Does anyone know if there is somewhere a compiled version of log4postsharp that uses Postsharp 1.5 available?</p>
 Log4Postsharp (dead?) with postsharp 2.0 or drop for ELMAH? <p>Does anyone know if the latest build (march 2010 - i beleive called log4postsharp 2.0) is compatible with postsharp 2.0 community edition?</p>

<p>I have used postsharp 1.5 together the log4postsharp in the past and was very pleased with the outcome.</p>

<p>But log4postsharp seems to be dead, is this true?</p>

<p>SHould i concentrate more on ELMAH?  I really wanted to continue to use log4net...</p>

<p>Any ideas or insight really appreciated</p>

<p>Thanks</p>
 tools/library to do noninvasive logging <p>I am wondering if any tool can help do noninvasive logging for a third party assembly library.  Can log4net/Postsharp do it?</p>
 AOP Ignoring logsuccess <p>We are using PostSharp as our AOP engine and somehow it is acting really weird. I know that it puts hook points before and after the function and it logs LogEntry and LogSuccess events just before and after the attributed function is called. </p>

<p>I am having our event logging module configured such that user can be awarded different amount of points on both LogEntry and LogSuccess.</p>

<p>Now, when LogEntry happens and I have set it to give 10 points then the person gets 10 X 2 =20  points. But if I set user to get some points on LogSuccess then user does not get any points at all.</p>

<p>Somehow, I feel like LogEntry point value is overriding LogSuccess points.</p>

<p>I have no idea why it is doing that and on top of that I see exactly one event in my database with correct points there.</p>

<p>Has anybody observed this king of behavior from AOPs before?</p>

<p>Thanks,</p>
 asp.net mvc log4postsharp <p>Hi Iam trying to use log4post sharp for logging purposes, As far as Iam aware I have followed the instructions to get this up and running, I  have not installed postsharp, rather I got the library files and midified my cs proj file to target those file, I have also tried installing postsharp on my machine. In either case I end up with this error</p>

<p>Error   5   The plug-in "Log4PostSharp" required by the type "Log4PostSharp.LogAttribute" was not found.    </p>

<p>I have tried googling this and it seems there is no trace of this issue anywhere on the web.</p>

<p>One difference between my implementation with other examples is that the postsharp dll that they use is PostSharp.public, mine is just PostSharp. I have tried searching for the former dll but cannot find it anywhere, the download only contains PostSharp.dll. I feel this may be the issue as I have followd all the insturctions to the letter to get this up and running. Any Ideas People?</p>
 Log4PostSharp project by inheriting from the ready-made (and working) custom attribute <p>Need to modify Log4PostSharp project by inheriting from the ready-made (and working) custom attribute. It looks similar to this:</p>

<pre><code>  [AttributeUsage(
    AttributeTargets.Assembly | AttributeTargets.Class | AttributeTargets.Constructor | AttributeTargets.Method | AttributeTargets.Module | AttributeTargets.Struct,
    AllowMultiple = true,
    Inherited = false)]
  [MulticastAttributeUsage(
  MulticastTargets.InstanceConstructor | MulticastTargets.StaticConstructor | MulticastTargets.Method,
    AllowMultiple = true)]
#if SILVERLIGHT
  [RequirePostSharp("Log4PostSharp", "Log4PostSharp.Weaver.SilverlightLogTask")]
#else
  [RequirePostSharp("Log4PostSharp", "Log4PostSharp.Weaver.LogTask")]
  [Serializable]
#endif
  public sealed class LogWithExceptionAttribute : LogAttribute
  {
    public LogWithExceptionAttribute()
    {
      ExceptionLevel = LogLevel.Error;
    }

    ...
  }
</code></pre>

<p>This is how I've chosen to annotate some unit-test code:</p>

<pre><code>[LogWithException]
private void DoThrowException()
{
  throw new Exception("test exception");
}
</code></pre>

<p>Wanted to try to debug the compile-time process, tried to compile from the command line but couldn't get any hint:</p>

<pre><code>&gt; msbuild Log4PostSharp.Test.csproj /p:PostSharpBuild=Diag /p:PostSharpTrace="AssemblyBinding;Project" /v:detailed
</code></pre>

<p>Which is the right way to tackle the problem? What is the wrong thing I am trying to do?</p>
 
decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator decorator ASP.NET MVC Routing Via Method Attributes <p>In the <a href="http://blog.stackoverflow.com/2009/05/podcast-54/">StackOverflow Podcast #54</a>, Jeff mentions they register their URL routes in the StackOverflow codebase via an attribute above the method that handles the route. Sounds like a good concept (with the caveat that Phil Haack brought up regarding route priorities).</p>

<p>Could someone provide some sample to make this happen?</p>

<p>Also, any "best practices" for using this style of routing?</p>
 Zend Framework: How do I remove the decorators on a Zend Form Hidden Element? <p>I'm trying to remove the default decorators on a hidden form element. By default, the hidden element is displayed like this:</p>

<pre><code>&lt;dt&gt;Hidden Element Label (if I had set one)&lt;/dt&gt;
&lt;dd&gt;&lt;input type="hidden" name="foobar" value="1" id="foobar"&gt;&lt;/dd&gt;
</code></pre>

<p>I don't want my hidden element to take up space on my page. I want to remove all the default decorators so all I'm left with is the input tag.</p>

<pre><code>&lt;input type="hidden" name="foobar" value="1" id="foobar"&gt;
</code></pre>

<p>How can I achieve this?</p>
 Please help me understand the "Decorator Pattern" with a real world example. <p>I was studying the <em>Decorator Pattern</em> as documented in <a href="http://en.wikipedia.org/wiki/Design_Patterns">GOF</a>. It seems like a complicated design pattern to me.</p>

<p>So please, help me understand the <em>Decorator Pattern</em>. Could someone give a use-case example of where this is useful in the real world?</p>
 Rails Patterns - Decorator vs Presenter <p>All sorts of talk lately in the Rails community about decorators, presenters.  </p>

<p>What is the essential difference between the two?  If there are, what are the cues that tell me to use one or the other? Or perhaps to use the two in conjunction?</p>
 How do I use ViewScripts on Zend_Form File Elements? <p>I am using this ViewScript for my standard form elements:</p>

<pre><code>&lt;div class="field" id="field_&lt;?php echo $this-&gt;element-&gt;getId(); ?&gt;"&gt;
   &lt;?php if (0 &lt; strlen($this-&gt;element-&gt;getLabel())) : ?&gt;
      &lt;?php echo $this-&gt;formLabel($this-&gt;element-&gt;getName(), $this-&gt;element-&gt;getLabel());?&gt;
   &lt;?php endif; ?&gt;
   &lt;span class="value"&gt;&lt;?php echo $this-&gt;{$this-&gt;element-&gt;helper}(
      $this-&gt;element-&gt;getName(),
      $this-&gt;element-&gt;getValue(),
      $this-&gt;element-&gt;getAttribs()
   ) ?&gt;&lt;/span&gt;
   &lt;?php if (0 &lt; $this-&gt;element-&gt;getMessages()-&gt;length) : ?&gt;
       &lt;?php echo $this-&gt;formErrors($this-&gt;element-&gt;getMessages()); ?&gt;
   &lt;?php endif; ?&gt;
   &lt;?php if (0 &lt; strlen($this-&gt;element-&gt;getDescription())) : ?&gt;
      &lt;span class="hint"&gt;&lt;?php echo $this-&gt;element-&gt;getDescription(); ?&gt;&lt;/span&gt;
   &lt;?php endif; ?&gt;
&lt;/div&gt;
</code></pre>

<p>Trying to use that ViewScript alone results in an error:</p>

<blockquote>
  <p>Exception caught by form: No file
  decorator found... unable to render
  file element</p>
</blockquote>

<p>Looking at <a href="http://framework.zend.com/wiki/display/ZFFAQ/Forms" rel="nofollow">this FAQ</a> revealed part of my problem, and I updated my form element decorators like this:</p>

<pre><code>'decorators' =&gt; array(
   array('File'),
   array('ViewScript', array('viewScript' =&gt; 'form/field.phtml'))
)
</code></pre>

<p>Now it's rendering the file element twice, once within my view script, and extra elements with the file element outside my view script:</p>

<pre><code>&lt;input type="hidden" name="MAX_FILE_SIZE" value="8388608" id="MAX_FILE_SIZE" /&gt;
&lt;input type="hidden" name="UPLOAD_IDENTIFIER" value="4b5f7335a55ee" id="progress_key" /&gt;
&lt;input type="file" name="upload_file" id="upload_file" /&gt;
&lt;div class="field" id="field_upload_file"&gt;
    &lt;label for="upload_file"&gt;Upload File&lt;/label&gt;
    &lt;span class="value"&gt;&lt;input type="file" name="upload_file" id="upload_file" /&gt;&lt;/span&gt;
&lt;/div&gt;
</code></pre>

<p>Any ideas on how to handle this properly with a ViewScript?</p>

<hr>

<p><strong>UPDATE:</strong> Based on Shaun's solution, here's my final code:</p>

<p>Form Element:</p>

<pre><code>$this-&gt;addElement('file', 'upload_file', array(
    'disableLoadDefaultDecorators' =&gt; true,
    'decorators' =&gt; array('File', array('ViewScript', array(
        'viewScript' =&gt; '_form/file.phtml',
        'placement' =&gt; false,
    ))),
    'label' =&gt; 'Upload',
    'required' =&gt; false,
    'filters' =&gt; array(),
    'validators' =&gt; array(array('Count', false, 1),),
));
</code></pre>

<p>View Script:</p>

<pre><code>&lt;?php
$class .= 'field ' . strtolower(end(explode('_',$this-&gt;element-&gt;getType())));
if ($this-&gt;element-&gt;isRequired()) {
    $class .= ' required';
}
if ($this-&gt;element-&gt;hasErrors()) {
    $class .= ' errors';
}
?&gt;
&lt;div class="&lt;?php echo $class; ?&gt;" id="field_&lt;?php echo $this-&gt;element-&gt;getId(); ?&gt;"&gt;
    &lt;?php if (0 &lt; strlen($this-&gt;element-&gt;getLabel())): ?&gt;
        &lt;?php echo $this-&gt;formLabel($this-&gt;element-&gt;getFullyQualifiedName(), $this-&gt;element-&gt;getLabel());?&gt;
    &lt;?php endif; ?&gt;
    &lt;span class="value"&gt;&lt;?php echo $this-&gt;content; ?&gt;&lt;/span&gt;
    &lt;?php if ($this-&gt;element-&gt;hasErrors()): ?&gt;
        &lt;?php echo $this-&gt;formErrors($this-&gt;element-&gt;getMessages()); ?&gt;
    &lt;?php endif; ?&gt;
    &lt;?php if (0 &lt; strlen($this-&gt;element-&gt;getDescription())): ?&gt;
        &lt;p class="hint"&gt;&lt;?php echo $this-&gt;element-&gt;getDescription(); ?&gt;&lt;/p&gt;
    &lt;?php endif; ?&gt;
&lt;/div&gt;
</code></pre>
 when do we need Decorator Pattern? <p>when do we need to go for Decorator pattern? If possible give me a real world example that suits that pattern...</p>
 Django: Staff Decorator <p>I'm trying to write a "staff only" decorator for Django, but I can't seem to get it to work:</p>

<pre><code>def staff_only(error='Only staff may view this page.'):
    def _dec(view_func):
        def _view(request, *args, **kwargs):
            u = request.user
            if u.is_authenticated() and u.is_staff:
                return view_func(request, *args, **kwargs)
            messages.error(request, error)
            return HttpResponseRedirect(request.META.get('HTTP_REFERER', reverse('home')))
        _view.__name__ = view_func.__name__
        _view.__dict__ = view_func.__dict__
        _view.__doc__ = view_func.__doc__
        return _view
    return _dec
</code></pre>

<p>Trying to <a href="http://passingcuriosity.com/2009/writing-view-decorators-for-django/">follow lead from here</a>. I'm getting:</p>

<blockquote>
  <p><code>'WSGIRequest' object has no attribute '__name__'</code></p>
</blockquote>

<p>But if I take those 3 lines out, I just get a useless "Internal Server Error". What am I doing wrong here?</p>
 Decorators in Ruby (migrating from Python) <p>I'm spending today learning Ruby from a Python perspective.  One thing I have completely failed to grapple with is an equivalent of decorators.  To pare things down I'm trying to replicate a trivial Python decorator:</p>

<pre>
#! /usr/bin/env python

import math

def document(f):
    def wrap(x):
        print "I am going to square", x
        f(x)
    return wrap

@document
def square(x):
    print math.pow(x, 2)

square(5)
</pre>

<p>Running this gives me:</p>

<pre>
I am going to square 5
25.0
</pre>

<p>So, I want to create a function square(x), but decorate it so it alerts me as to what it's going to square before it does it.  Let's get rid of the sugar to make it more basic:</p>

<pre>
...
def square(x):
    print math.pow(x, 2)
square = document(square)
...
</pre>

<p>So, how do I replicate this in Ruby?  Here's my first attempt:</p>

<pre>
#! /usr/bin/env ruby

def document(f)
    def wrap(x)
      puts "I am going to square", x
      f(x)
      end
    return wrap
    end

def square(x)
    puts x**2
    end

square = document(square)

square(5)
</pre>

<p>Running this generates:</p>

<pre>
./ruby_decorate.rb:8:in `document': wrong number of arguments (0 for 1) (ArgumentError)
    from ./ruby_decorate.rb:15:in `'
</pre>

<p>Which I guess it because parentheses aren't mandatory and it's taking my "return wrap" as an attempt to "return wrap()".  I know of no way to refer to a function without calling it.</p>

<p>I've tried various other things, but nothing gets me far.</p>
 dynamically decorating objects in c# <p>is it possible to easily and <em>dynamically</em> decorate an object?</p>

<p>for example, lets say I have a <code>List&lt;PointF&gt;</code>. this list is actually a plot of the sine function. I'd like to go through these points and add a flag to each PointF of whether it's a peak or not.</p>

<p>but I don't want to create a new extended SpecialPointF or whatever, that has a boolean property.</p>

<p>judge me all you want for being lazy, but laziness is how awesome ideas are born (also bad ideas)</p>

<p>Edit: I'll accept boxing solutions as well as any interesting hack you can come up with. there's nothing really stopping me from deriving. I just want to know if there's a more fun way.</p>
 Decorator design pattern, function bug <p><em>This is homework...I'm not asking for answers, I just have a bug I'm not sure what to do with.  Thanks!</em></p>

<p>The bug in question probably has nothing to do with the assignment itself, but here is the assignment description anyways:</p>

<p>I'm working on an assignment (in C++) meant to teach use of the decorator design pattern through the classic example of a pizza with toppings.  (My professor may as well have lifted it straight from <a href="http://simplestcodings.com/2010/12/26/decorator-design-pattern-example-ni-c/" rel="nofollow">http://simplestcodings.com/2010/12/26/decorator-design-pattern-example-ni-c/</a>).  I'm running into a little problem that I was wondering if someone could help me with.</p>

<p>I have a main menu(pizzeria) object that takes input from the user and performs the desired actions on a pizza.  Users start with a basic pizza and then can add toppings to it until they're done.  So the first thing that my "newPizza" function does is declare the new Pizza as a <code>Plain</code>, which is a subclass of abstract class <code>Pizza</code>.</p>

<p>Then they get to enter their choice of toppings.  Each time, a pointer to the same <code>Pizza</code> object is sent to the <code>addToppings()</code> function, the new decoration is added, and the pointer is returned.  Each decoration inherits from a price category, which inherits from <code>pizzaToppings</code>, which inherits from <code>Pizza</code>.</p>

<p>This is the relevant part of the main order function:</p>

<pre><code>Pizza* Menu::newPizza()
{
cout &lt;&lt; "\nNew Pizza";

//accept the next choice
int choose = 0;

//create the new pizza
Plain * currentPizza = new Plain();

//until they choose to end the order
while (choose != 3)
{
    //accept the choice
    cin &gt;&gt; choose;

    switch (choose)
    {
        //if they want to add a new topping
    case 1:
        {
            //add topping to current pizza
           //and this is where the problem is spotted by the compiler
            addTopping(currentPizza);
            break;
        }
</code></pre>

<p>The issue is that when I try to send the pointer <code>currentPizza</code> to the function <code>addTopping()</code>, I get 
"Run-Time Check Failure #3 - The variable 'currentPizza' is being used without being initialized."</p>

<p>Didn't I  just initialize it right there on line 7?</p>

<p>If I hit "continue", the program keeps going, and works, but I get that same error every time I call the function.  Is it just a syntax error somewhere, or do I have some actual issue here?</p>

<p>Thanks!!</p>

<p>[edit:]</p>

<p>The addTopping() function:</p>

<pre><code>Pizza* Menu::addTopping(Pizza* thisPizza)
{
cout &lt;&lt; "\nAdd topping";

//declare choose int
int choose = 0;

//accept number of topping
cin &gt;&gt; choose;

//decide which one to add
switch (choose)
{

//mozzarella
case 1:
    {
        thisPizza = new Mozzarella(thisPizza);
        break;
    }
//mushrooms
case 2:
    {
        thisPizza = new Mushrooms(thisPizza);
        break;
    }

//another 13 possible toppings, won't bore you with the details ;)

}

cout &lt;&lt; "\nEnd add topping\n";

return thisPizza;
}
</code></pre>
 C#: Elegant way to wrap method calls <p>Apologies for the fairly ambiguous title but what I'm trying to achieve is probably better stated in code.</p>

<p>I have a WCF client. When I'm calling methods I would like to wrap each call in some error handling code. So, instead of exposing the methods directly, I've created the following helper function on the client class:</p>

<pre><code>    public T HandleServiceCall&lt;T&gt;(Func&lt;IApplicationService, T&gt; serviceMethod)
    {
        try
        {
            return serviceMethod(decorator);
        }
        [...]
    }
</code></pre>

<p>And the client code uses it like this:</p>

<pre><code>service.HandleServiceCall(channel =&gt; channel.Ping("Hello"));
</code></pre>

<p>And the call to Ping gets nicely wrapped in some logic that will try to handle any errors.</p>

<p>This works great except that I now have a requirement to know which methods are actually being called on the service. Initially , I was hoping to just inspect the <code>Func&lt;IApplicationService, T&gt;</code> using Expression trees but didn't get very far.</p>

<p>Finally, I settled on a Decorator pattern:</p>

<pre><code>    public T HandleServiceCall&lt;T&gt;(Func&lt;IApplicationService, T&gt; serviceMethod)
    {
        var decorator = new ServiceCallDecorator(client.ServiceChannel);
        try
        {
            return serviceMethod(decorator);
        }
        [...]
        finally
        {
            if (decorator.PingWasCalled)
            {
                Console.Writeline("I know that Ping was called")
            }
        }
    }
</code></pre>

<p>And the Decorator itself:</p>

<pre><code>    private class ServiceCallDecorator : IApplicationService
    {
        private readonly IApplicationService service;

        public ServiceCallDecorator(IApplicationService service)
        {
            this.service = service;
            this.PingWasCalled = new Nullable&lt;bool&gt;();
        }

        public bool? PingWasCalled
        {
            get;
            private set;
        }

        public ServiceResponse&lt;bool&gt; Ping(string message)
        {
            PingWasCalled = true;
            return service.Ping(message);
        }
    }
</code></pre>

<p>It's really clunky and quite a lot of code. <em>Is there a more elegant way of doing this?</em></p>
 Design considerations for temporarily transforming a player into an animal in a role playing game <p>I am working on a role playing game for fun and to practice design patterns. I would like players to be able to transform themselves into different animals. For example, a Druid might be able to shape shift into a cheetah. Right now I'm planning on using the decorator pattern to do this but my question is - how do I make it so that when a druid is in the cheetah form, they can only access skills for the cheetah? In other words, they should not be able to access their normal Druid skills.</p>

<p>Using the decorator pattern it appears that even in the cheetah form my druid will be able to access their normal druid skills.</p>

<pre><code>class Druid : Character
{
   // many cool druid skills and spells
   void LightHeal(Character target) { }
}

abstract class CharacterDecorator : Character
{
    Character DecoratedCharacter;
}

class CheetahForm : CharacterDecorator
{
    Character DecoratedCharacter;
    public CheetahForm(Character decoratedCharacter)
    {
       DecoratedCharacter= decoratedCharacter;
    }

    // many cool cheetah related skills
    void CheetahRun()
    {
       // let player move very fast
    }
}
</code></pre>

<p>now using the classes</p>

<pre><code>Druid myDruid = new Druid();
myDruid.LightHeal(myDruid); // casting light heal here is fine
myDruid = new CheetahForm(myDruid);
myDruid.LightHeal(myDruid); // casting here should not be allowed
</code></pre>

<p>Hmmmm...now that I think about it, will myDruid be unable to us the <code>Druid</code> class spells/skills unless the class is down-casted? But even if that's the case, is there a better way to ensure that <code>myDruid</code> at this point is locked out from all <code>Druid</code> related spells/skills until it is cast back to a <code>Druid</code> (since currently it's in <code>CheetahForm</code>)</p>
 Is it possible to decorate include(...) in django urls with login_required? <p>I have a few restricted areas on the site, for which I would like to specify <code>login_required</code> decorator. However I would like to do that once per inclusion in main urls.py, not per individual url in included urls.py</p>

<p>So instead of:</p>

<p>/private/urls.py:</p>

<pre><code>(r'^profile/$', login_required(profile)),
</code></pre>

<p>I'd do something along the lines:</p>

<p>/urls.py</p>

<pre><code>urlpatterns = patterns('',
                      ...
                      (r'^private/', login_required(include('private'))),
                      )
</code></pre>

<p>Except that it doesn't work, unfortunately.</p>
 Is AOP a type of decorator pattern? <p>I got asked this question in a interview. I clearly know what a decorator pattern is and how it can be used. But I was not able to think through this question in the interview.</p>

<p>This is the actual question asked.</p>

<blockquote>
  <p>Is AOP a variation of decorator pattern ? How does the AOP implementation vary from trademark decorator pattern ?</p>
</blockquote>
 Ninject dependency injection with Decorator pattern <p>Say, I have such classes hierarchy:</p>

<pre><code>public interface IRepository { }

public class SomeSimpleRepository : IRepository {}
</code></pre>

<p>Now I want to "decorate" SomeSimpleRepository with additional functions</p>

<pre><code>public class MoreAdvancedRespository : IRepository 
{ 
    private readonly IRepository _originalRepository;

    public MoreAdvancedRespository(IRepository original) 
    { }
}
</code></pre>

<p>After awhile another one..</p>

<pre><code>public class TrickyRepository : IRepository
{
    private readonly IRepository _originalRepository;

    public TrickyRepository (IRepository original) 
    { }
}
</code></pre>

<p>Now, I need to accomplish binding. In application I need the instance of TrickyRepository, to be intialized with MoreAdvancedRespository. So, I need to write something like:</p>

<pre><code>Bind&lt;IRepository&gt;().To&lt;TrickyRepository&gt;.With ??
</code></pre>

<p>Here I'm confused, I need somehow to say, take MoreAdvancedRespository but intialize it with SomeSimpleRepository. This is a kind of chain of dependencies that have to be resolved against one interface.</p>

<p>Does any one have suggestion on this?</p>
 Decorator Pattern vs Inheritance with examples <p>I've been experimenting with the decorator pattern to extend functionality of code you do not want to touch for example and I see how to implement it however I am now unsure why you don't just inherit from the original class and extend that way.</p>

<p>I have read that the decorator pattern allows you to add functionality at runtime whereas inheritance means its there at compile time.</p>

<p>I don't understand this.</p>

<p>Could someone explain this, provide examples and explain when its better to use decorator vs inheritance.</p>

<p>Thanks</p>
 What naming convention do you use for the Decorator Pattern? <p>I just recently really truly groked dependency injection and the wonder of the Decorator design pattern and am using it all over the place.</p>

<p>As wonderful as it is however, one thing that I've been having difficulty with is naming my decorator classes so I would just like to know what others do.  Do you always append the word Decorator?  Do you incorporate the name of the interface its decorating?  Do they get their own namespace?</p>

<p>What do you guys do?</p>
 How can make Django permission_required decorator not to redirect already logged-in users to login page, but display some message <p>How can make Django permission_required decorator not to redirect already logged-in users to login page, but display some message like Insufficient permissions?</p>

<p>Thank you.</p>
 Applying the Decorator Pattern to Forms <p>I am trying to apply the Decorator Design Pattern to the following situation:</p>

<p>I have 3 different kind of forms: Green, Yellow, Red.</p>

<p>Now, each of those forms can have different set of attributes. They can have a minimize box disabled, a maximized box disabled and they can be always on top.</p>

<p>I tried to model this the following way:</p>

<pre><code>              Form &lt;---------------------------------------FormDecorator
              /\                                                  /\
     |---------|-----------|               |----------------------|-----------------|
GreenForm  YellowForm   RedForm  MinimizeButtonDisabled MaximizedButtonDisabled AlwaysOnTop
</code></pre>

<p>Here is my GreenForm code:</p>

<pre><code>public class GreenForm : Form {
    public GreenForm() {
        this.BackColor = Color.GreenYellow;
    }

    public override sealed Color BackColor {
        get { return base.BackColor; }
        set { base.BackColor = value; }
    }
}
</code></pre>

<p>FormDecorator:</p>

<pre><code>public abstract class FormDecorator : Form {
    private Form _decoratorForm;

    protected FormDecorator(Form decoratorForm) {
        this._decoratorForm = decoratorForm;
    }
}
</code></pre>

<p>and finally NoMaximizeDecorator:</p>

<pre><code>public class NoMaximizeDecorator : FormDecorator
{
    public NoMaximizeDecorator(Form decoratorForm) : base(decoratorForm) {
        this.MaximizeBox = false;
    }
}
</code></pre>

<p>So here is the running code:</p>

<pre><code>static void Main()
{
    Application.EnableVisualStyles();
    Application.SetCompatibleTextRenderingDefault(false);
    Application.Run(CreateForm());
}

static Form CreateForm() {
    Form form = new GreenForm();
    form = new NoMaximizeDecorator(form);
    form = new NoMinimizeDecorator(form);

    return form;
}
</code></pre>

<p>The problem is that I get a form that isn't green and that still allows me to maximize it. It is only taking in consideration the NoMinimizeDecorator form. I do comprehend why this happens but I'm having trouble understanding how to make this work with this Pattern.</p>

<p>I know probably there are better ways of achieving what I want. I made this example as an attempt to apply the Decorator Pattern to something. Maybe this wasn't the best pattern I could have used(if one, at all) to this kind of scenario. Is there any other pattern more suitable than the Decorator to accomplish this? Am I doing something wrong when trying to implement the Decorator Pattern?</p>

<p>Thanks</p>
 Zend_Framework Decorators Wrap Label and ViewHelper inside a div <p>I am new to this, zend decoration malarchy, but i have two significant questions that i cant get my head around. Question one is followed by some example</p>

<pre><code>$decorate = array(
    array('ViewHelper'),
    array('Description'),
    array('Errors', array('class'=&gt;'error')),
    array('Label', array('tag'=&gt;'div', 'separator'=&gt;' ')),
    array('HtmlTag', array('tag' =&gt; 'li', 'class'=&gt;'element')),
);

...

$name = new Zend_Form_Element_Text('title');
$name-&gt;setLabel('Title')
    -&gt;setDescription("No --- way");

$name-&gt;setDecorator($decorate);
</code></pre>

<p>Which outputs</p>

<pre><code>&lt;li class="element"&gt;
    &lt;label for="title" class="required"&gt;Title&lt;/label&gt; 
    &lt;input type="text" name="title" id="title" value=""&gt;
    &lt;p class="hint"&gt;No --- way&lt;/p&gt;
    &lt;ul class="error"&gt;
        &lt;li&gt;Value is required and can't be empty&lt;/li&gt;
    &lt;/ul&gt;
&lt;/li&gt;
</code></pre>

<h1>The Question #1</h1>

<p>How do i wrap the <code>label</code> and the <code>input</code> around a div tag? So the output is as follows:</p>

<pre><code>&lt;li class="element"&gt;
    &lt;div&gt;
        &lt;label for="title" class="required"&gt;Title&lt;/label&gt; 
        &lt;input type="text" name="title" id="title" value=""&gt;
    &lt;/div&gt;
    &lt;p class="hint"&gt;No --- way&lt;/p&gt;
    &lt;ul class="error"&gt;
        &lt;li&gt;Value is required and can't be empty&lt;/li&gt;
    &lt;/ul&gt;
&lt;/li&gt;
</code></pre>

<hr>

<h1>The Question #2</h1>

<p>What is up with the order of the <code>elements</code> in the <code>$decorate</code> array? <em>They MAKE NO SENSE!</em></p>
 Decorator pattern for classes with many properties <p>I have this simple class:</p>

<pre><code>public class DataBag
{
    public string UserControl { get; set; }
    public string LoadMethod { get; set; }
    public dynamic Params { get; set; }
    public int Height { get; set; }

    public DataBag(string Control, 
        object vars, string lm)
    {
        UserControl = Control;
        LoadMethod = lm;
        Params = vars;
        Height = 0;
    }
}
</code></pre>

<p>I then would like to create a decorator for it that would add a bunch of it's own properties. Question is what's the most concise and elegant way to provide access to decorated properties?  </p>

<p>So far I have two options: either I provide a <code>get-set</code> pair for every of four decorated properties in decorator (wich seems tideous and mouthful and basically it's what I want to avoid) or I inherit <code>DataBag</code> from <code>DynamicObject</code> and then somehow manage to get decorated properties using <code>TryGetMember</code> method (which is dynamic and does not seem to be the right way to do things in C#).</p>

<p>Any advice?</p>
 Can a django template know whether the view it is invoked from has the @login_required decorator? <p>Let's say that I have a system that has some pages that are public (both non-authenticated users and logged-in users can view) and others which only logged-in users can view. </p>

<p>I want the template to show slightly different content for each of these two classes of pages. The @login_required view decorator is always used on views which only logged-in users can view. However, my template would need to know whether this decorator is used on the view from which the template was invoked from.</p>

<p>Please keep in mind that I do not care whether the user is logged in or not for the public pages. What I care about is whether a page can be viewed by the general public, and the absence of a @login_required decorator will tell me that.</p>

<p>Can anyone throw me a hint on how the template would know whether a particular decorator is being used on the view from which the template invoked from?</p>
 How to use C#-like attributes in C++ <p>I'm considering the use of C++ for a personal project. I would like to make it platform independent (no Mono please, since some platforms don't yet support it), and that's why I considered C++.</p>

<p>I have one doubt, however. I've grown quite fond of C#'s attributes, and I would like to know if I can use something similar in C++.</p>

<p>Also, is it possible to use the decorator pattern for this?</p>

<p>EDIT: I would now consider other possibilities or approximations for this matter, ie. some way to attach additional behavior to a class in runtime.</p>

<p>EDIT 2: Java is not an option, because some devices I'd like to port it to don't support java.</p>
 Class decorator to declare static member (e.g., for log4net)? <p>I'm using log4net, and we have a lot of this in our code:</p>

<pre><code>public class Foo {
    private static readonly ILog log = LogManager.GetLogger(typeof(Foo));
    ....
}
</code></pre>

<p>One downside is that it means we're pasting this 10-word section all over, and every now and then somebody forgets to change the class name.  The <a href="http://log4net.sourceforge.net/release/1.2.0.30316/doc/manual/faq.html" rel="nofollow">log4net FAQ</a> also mentions this alternative possibility, which is even more verbose:</p>

<pre><code>public class Foo {
    private static readonly ILog log = LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);
    ...
}
</code></pre>

<p>Is it possible to write a decorator to define this?  I'd really like to say simply:</p>

<pre><code>[LogMe]  // or perhaps: [LogMe("log")]
public class Foo {
    ...
}
</code></pre>

<p>I've done similar things in other languages, but never a statically-compiled language like C#.  Can I define class members from a decorator?</p>

<p><strong>Edit</strong>: Heh.  I'm a Lisp programmer.  I appreciate the suggestions to switch languages, but really, if I was going to switch languages for better metaprogramming capabilities, I'd go all the way to Lisp instead of being half-assed about it.  Unfortunately using a different language isn't an option on this project.</p>
 A problem when using the decorator design pattern <p>We are currently using the decorator design pattern to perform some caching.  So we have a bunch of classes that look something like this:</p>

<pre><code>interface IComponent
{
  object Operation();
  object AnotherOperation();
}
public ConcreteComponentA : IComponent
{
  public object Operation()
  {
    return new object();
  }
  public object AnotherOperation()
  {
    return new object();
  }
}
public ConcreteDecoratorA : IComponent
{
  protected IComponent component;
  public object Operation()
  {
    if(!this.cache.Contains("key")
    {
      this.cache["key"] = this.component.Operation();
    }
    return this.cache["key"];
}
</code></pre>

<p>So if a client wanted to use caching they would create a new ConcreteDecoratorA and pass in a ConcreteComponentA to the constructor.  The problem we are facing is, imagine that AnotherOperation() requires a call to Operation in order to do it's work.  ConcreteComponentA might now look something like this:</p>

<pre><code>public ConcreteComponentA : IComponent
{
  public object Operation()
  {
    return new object();
  }
  public object AnotherOperation()
  {
    object a = this.Operation();
    // Do some other work
    return a;
  }
}
</code></pre>

<p>The problem is that when calling Operation() method from within AnotherOperation() method, the decorator implementation will never be called, because obviously the decorator is not in the inheritance hierarchy of ConcreteComponentA.</p>

<p>So have we made a poor design decision somewhere or is this just a limitation of the decorator design pattern that we have to accept?</p>

<p>Note that in my real world example, ConcreteComponentA is a wrapper to a third party system that we do not have control over.  We have developed IComponent and a bunch of POCOs that we work with to abstract away that third party system.  In this case we have to make two calls to their system in order to get the data required, it's just about where we make those two calls.</p>
 WPF- Validation -The validation error message goes behind the other controls because of AdornerDecorator <p>I have implemented IDataErrorInfo in my ViewModel to return a string if the text box has error.</p>

<pre><code>    public string this[string columnName]
    {
        get { return "Error-- This is a long error message - sd"; }
    }
</code></pre>

<p>But this error message goes behind the other control on the UI as shown below.</p>

<p><img src="http://i.stack.imgur.com/92x0R.jpg" alt="alt text"></p>

<p>Below is the xaml:</p>

<pre><code>&lt;Window x:Class="Test.Window1"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Window1" Height="600" Width="600"&gt;

&lt;Window.Resources&gt;        

    &lt;ControlTemplate x:Key="validationTemplateNew"&gt;
        &lt;DockPanel LastChildFill="True"&gt;
            &lt;TextBlock Name="ErrorText" DockPanel.Dock="Bottom" Foreground="White" Background="Red" 
                                   FontSize="12" Padding="2" FontFamily="Trebuchet MS" 
                                   Margin="5,5,0,0"                                        
                                   TextWrapping="Wrap"                                        
                                   Text="{Binding [0].ErrorContent}" &gt;&lt;/TextBlock&gt;
            &lt;AdornedElementPlaceholder Name="ErrorTextBox" /&gt;
        &lt;/DockPanel&gt;
    &lt;/ControlTemplate&gt;
    &lt;Style x:Key="ValidationStyle" TargetType="{x:Type TextBox}"&gt;
        &lt;Style.Triggers&gt;
            &lt;Trigger Property="Validation.HasError" Value="True"&gt;
                &lt;Setter Property="BorderBrush" Value="Red" /&gt;
                &lt;Setter Property="BitmapEffect"&gt;
                    &lt;Setter.Value&gt;
                        &lt;BitmapEffectGroup&gt;
                            &lt;OuterGlowBitmapEffect GlowColor="Red" GlowSize="3" Noise="0.6"&gt;&lt;/OuterGlowBitmapEffect&gt;
                        &lt;/BitmapEffectGroup&gt;
                    &lt;/Setter.Value&gt;
                &lt;/Setter&gt;                    
            &lt;/Trigger&gt;
        &lt;/Style.Triggers&gt;
    &lt;/Style&gt;
&lt;/Window.Resources&gt;

&lt;Grid&gt;
    &lt;ItemsControl Name="ItemCtrl"&gt;

        &lt;AdornerDecorator&gt;
            &lt;TextBox 
             FontSize="11" 
             Margin="10" 
             Width="250"      
             VerticalAlignment="Center"                                         
             Text="{Binding Path=StrText, ValidatesOnDataErrors=True, 
                    UpdateSourceTrigger=PropertyChanged}" 
             Validation.ErrorTemplate="{StaticResource validationTemplateNew}"
            Style="{StaticResource ValidationStyle}"

             &gt;
            &lt;/TextBox&gt;
        &lt;/AdornerDecorator&gt;
        &lt;TextBox Width="250" Text="ASDFASFASDFASDFASDFASDFASDF"/&gt;
        &lt;TextBox Width="250" Text="ASDFASFASDFASDFASDFASDFASDF"/&gt;
        &lt;TextBox Width="250" Text="ASDFASFASDFASDFASDFASDFASDF"/&gt;
        &lt;TextBox Width="250" Text="ASDFASFASDFASDFASDFASDFASDF"/&gt;
        &lt;TextBox Width="250" Text="ASDFASFASDFASDFASDFASDFASDF"/&gt;
    &lt;/ItemsControl&gt;        
&lt;/Grid&gt;

&lt;/Window&gt;
</code></pre>

<p>Please let me know how to use AdornerDecorator such that the error message overlaps the other controls and doesn't go behind.</p>

<p>My application is such that if I don't use AdornerDecorator, the error message is not displayed at all. </p>
 How to change the tag of the default Errors decorator within Zend_Form? <p>I'm trying to change the tag of the Errors decorator, currently it's:</p>

<pre><code>&lt;ul class="errors"&gt;
  &lt;li&gt;error message&lt;/li&gt;
&lt;/ul&gt;
</code></pre>

<p>I'd like to remove the <code>&lt;ul&gt;</code> wrapper and change the <code>&lt;li&gt;</code> by ie <code>&lt;p&gt;</code>.</p>

<p>I tried a lot of things, but can't get it to work..</p>

<p>Any ideas?</p>
 Is a car with a bumper sticker subclass of a car? <p>I am not an expert in OOPS and or design patterns. </p>

<p>I have come across this situation: Is a car with a bumper sticker subclass of a car? </p>

<p>If not then how can I add dynamic properties to instance of an object? For example a car, a car with bumper sticker etc.</p>

<p>Not all cars come with a bumper sticker. One can add a bumper sticker and even more than one bumper sticker. I can not implement a sticker with car, afaik, implementing me will force me to add stickers. A bumper sticker on a car is one new property that came into existence after car (object?) was created.</p>
 Create custom FrameworkContentElement to add diagonal line over text in WPF <p>Is there any way to create a custom <code>FrameworkContentElement</code> (or an <code>Inline</code>) that draws a diagonal line over its content?</p>

<p>Something like Strike-through decoration but with a diagonal shape:
<img src="http://i.stack.imgur.com/OqEK2.png" alt="example of strike-through and diagonal decorations"></p>

<p>It is not possible to inherent from <code>TextDecoration</code> or <code>TextEffect</code> (they are sealed).</p>

<p>Any idea?</p>
 What is the shortest way to implement a proxy or decorator class in c#? <p>When you have a class car that implements IVehicle and you want to wrap it in a decorator that forwards all calls to car and counts them, how would you do it?</p>

<p>In Ruby I could just build a decorator without any methods and use method_missing to forward all calls to the car object.</p>

<p>In Java I could build a Proxy object that runs all code through one method and forwards it afterwards.</p>

<p>Is there any similiar thing i can do in C#?</p>

<p><hr /></p>

<p>update:</p>

<p>based on the answeres and what i´ve read about System.Reflection.Emit it should be possible to write a method similiar to this:</p>

<pre><code>Type proxyBuilder(Type someType, delagate functionToBeApplied, Object forward)
</code></pre>

<p>where type implements all interface of someType, executes functionToBeApplied and then forwards the method call to object while returning its return.</p>

<p>Is there some lib that does just that or would i have to write my own?</p>
 Decorating A Method In ASP.NET? <p>Me again..  I hear the phrase 'decorating / decorate' a method being thrown about a lot in tutorials I have read / watched.  But I just don't understand what it means AND what it actually does??  Can anyone point me in the direction of some information on beginning to use them (Very novice tutorial would be good)</p>
 Applying the decorator pattern polymorphically and coupling problems in C++ <p>I am trying to make a C++ implementation of the board game <a href="http://en.wikipedia.org/wiki/Carcassonne%5F%28board%5Fgame%29" rel="nofollow">Carcassonne</a>.  I am trying to make a tile object which has four sides and one of three basic terrains(field, road, city).</p>

<p>The best interface for tile creation I could think of was of the form:</p>

<pre><code>City city;
city_city_city_city = new Tile(city, city, city, city);
</code></pre>

<p>Where a Tile class is defined somewhat as follows...</p>

<pre><code>class Tile
{
 public:
  Tile(Terrain&amp; top_terrain,
       Terrain&amp; right_terrain, 
       Terrain&amp; bottom_terrain,
       Terrain&amp; left_terrain)
    {   
      top_side_.reset(top_terrain.Decorate(new TopSide()));
      right_side_.reset(right_terrain.Decorate(new RightSide());
      bottom_side_.reset(bottom_terrain.Decorate(new BottomSide()));
      left_side_.reset(left_terrain.Decorate(new LeftSide()));
    }

 private:
 boost::scoped_ptr&lt;TopSide&gt; top_side_;
 boost::scoped_ptr&lt;RightSide&gt; right_side_;
 boost::scoped_ptr&lt;BottomSide&gt; bottom_side_;
 boost::scoped_ptr&lt;LeftSide&gt; left_side_;
};
</code></pre>

<p>I wanted the constructor to initialize each specific Side(TopSide, RightSide, BottomSide, LeftSide) that inherits from the base class Side.  The idea was to define a virtual Decorate method in the Terrain class that would return an instance of a SideDecorator for the specific type of Terrain.</p>

<p>Depending on the Type of terrain the side has, it will have a different number/type of TerrainSegments.  For example:  A Side with a Field has the need for only one FieldSegment, whereas a Side with a Road needs three Segments: a RoadSegment and two FieldSegments.  Thus the  adding of a tile to the board will need Sides with different implementations and members. </p>

<p>I could make concrete classes like TopFieldSide, BottomRoadSide, etc, but I figured the decorator pattern would be cleaner.  The thing I am not sure about however is whether or not the polymorphic use of the Decorate() method is a misuse.</p>

<p>Certainly I could create Tiles of the form:</p>

<pre><code>Tile(CityDecorator(new TopSide), 
     CityDecorator(new RightSide),
     FieldDecorator(new BottomSide),
     RoadDecorator(new LeftSide));
</code></pre>

<p>But the previous version seems much cleaner.</p>

<p>My question being... Is this an acceptable approach or is there a simplier/cleaner way that I am missing?</p>

<p>My use of this approach is running me into coupling problems because I have to include the path to SideDecorator in Terrain and Terrain is used in SideDecorator and in derived classes.  The simple directive #include "side_decorator.h" in the terrain.h causes many compile errors making it hard to tell if it is a forward declaration problem or what something else unoticed in my code...</p>
 Django options for making variables widely available <p>Every time I open a page I want to get the currently active project id.  This will be done by chacking the subdomain and verifying the currently logged in user can view it.  </p>

<p>Once I reach my view I want to be able to do</p>

<pre><code>tasks = Task.objects.filter(project = current_project)
</code></pre>

<p>WHere current_project (or CURRENT_PROJECT or <strong>current_project</strong> ???) has already been setup.</p>

<p>Can anyone explain the pros/cons of the various approaches I have found in the docs and put me on the right track?</p>

<ol>
<li>Sessions</li>
<li>Middleware</li>
<li>Threading</li>
<li>builtins</li>
</ol>

<p><strong>This was how I did it in the end:</strong></p>

<p>Decorator:</p>

<pre><code>def check4project(fn):

    current_project = 'fred'
    def check(*args, **kw):
        kw['project']=current_project
        return fn(*args, **kw)
    return check
</code></pre>

<p>View example</p>

<pre><code>@login_required
@check4project
@tweetpost
def index(request, project=0):

    print project
</code></pre>
 When is it appropriate to create a Decorator for an object, and when is it appropriate to rewrite your object to allow Strategies to be applied? <p>For example, suppose I have a Product class that I can add to a shopping cart. I may want to be able to package it together with another item when it is also in the cart and add a 15% discount.</p>

<p>Should the product class be decorated with a new subclass allowing deals, or should product class be redesigned to allow the cart attach a price reduction "strategy" object to the Product, reducing the price?</p>

<p>This is an abstract example, so take it where you will. </p>
 Understanding UML of DoFactory Design Pattern - Decorator <p>I am trying to understand UML diagram describing Decorator Pattern at link below</p>

<p><a href="http://www.dofactory.com/Patterns/PatternDecorator.aspx" rel="nofollow">http://www.dofactory.com/Patterns/PatternDecorator.aspx</a></p>

<p>I don't understand why there is a "Aggregation" relation between Decorator and Component.</p>

<p>I believe it should be composition as Decorator cannot exist without the base component.</p>
 Setting decorators to Zend_Form_Element_Checkbox <p>I have a zend form comprised of 4 subforms.
1 of these subforms has 4 elements, and one of those elements is a zend_form_element_checkbox.
I have 4 different display groups (1 for each subform) - one is : 'billing address', one is 'credit card info' , 'notifications' and 'misc'</p>

<p>Assuming that 'notifications' is the part that has the checkbox element, if i dont use any decorators except the following, and dont use any display groups, everything displays as expected i.e.:</p>

<p>Notify me   [] &lt;------ is the checkbox</p>

<p>These are the css im using for the dd and dt tags in the form</p>

<pre><code>dt{
    display: block;
    margin: 0;
    padding: 0 0 10px 10px;
    width: 220px;
    text-align: left;
}

dd{
   display: inherit;
   margin: 0;
   padding: 0 0 10px 10px;
   width: 200px;
   float: left;
}
</code></pre>

<p>Now, when i'm displaying the sub-form as a display group, i'm using this:</p>

<pre><code>$notificationsGroup-&gt;setDecorators(array(
     'FormElements',
      'FieldSet',
      array('HtmlTag',
             array('tag'=&gt;'div',
                   'style'=&gt;'width:90%;padding-left:45px;padding-bottom:25px;'))
                    ));
</code></pre>

<p>The end result is, all the elements come within the display group except for the actual check box (like - only the box - the label for the check box comes within the display group)</p>

<p>I have tried using other tags, and nothing seems to be working.
Is it something to do with the 'div' tag ? Something else I'm missing?
Appreciate all thoughts and responses.</p>
 What is the difference between a mixin and the decorator pattern? <p>The Decorator Pattern is dynamic extension-at-runtime of classes.  It dynamically forms a is-a relationship.  </p>

<p>I started to wonder if I was over-complicating my API by using the Decorator Pattern after I got <a href="http://stackoverflow.com/questions/591402/what-is-the-difference-between-an-abstract-class-and-a-mixin">this answer</a> about the difference between a mixin and an abstract class.</p>
 Can I use the decorator pattern to wrap a method body? <p>I have a bunch of methods with varying signatures.  These methods interact with a fragile data connection, so we often use a helper class to perform retries/reconnects, etc.  Like so:</p>

<pre><code>MyHelper.PerformCall( () =&gt; { doStuffWithData(parameters...) });
</code></pre>

<p>And this works fine, but it can make the code a little cluttery.  What I would prefer to do is decorate the methods that interact with the data connection like so:</p>

<pre><code>[InteractsWithData]
protected string doStuffWithData(parameters...)
{
     // do stuff...
}
</code></pre>

<p>And then essentially, whenever <code>doStuffWithData</code> is called, the body of that method would be passed in as an <code>Action</code> to <code>MyHelper.PerformCall()</code>.  How do I do this?</p>
 WPF Moving Adorner outside the AdornerLayer or Window <p>I have an adorner which is moving along with the mouse cursor. However as soon as the mouse moves outside the window the adorner gets cut off. </p>

<p>Is it possible to expand the adorner layer to the whole screen or create a new adorner layer.</p>
 Error Adorner in a Scrollviewer <p>I'm trying to ensure that my error adorners don't get clipped by my scrollviewer's bounds. I have a series of textboxes that are at the edge of a fixed width scrollviewer (no horizontal scrolling, only vertical).  I then have adorners that flag textboxes with errors.</p>

<p>The problem is that the adorners get clipped at the edge of the scrollviewer.</p>

<p>Any ideas?</p>

<p>*Note:  I have tried wrapping everything in AdornerDecorator.</p>
 Appending or Prepending HTML Tags to Zend Form Element <p>For the purposes of styling I have the need to put an opening <code>&lt;div&gt;</code> at the beginning of one element, and a closing <code>&lt;/div&gt;</code> tag at the end of another. Looking over the docs for HtmlDecorator I can't seem to figure out how to get it right, or if this is even the right decorator to use. It seems wasteful to have to create my own decorator simply to achieve this.</p>
 Django is_staff decorator problem <p>I am trying to limit access to pages using 2 user levels. Superuser and admin.
Super user is a regular Django user with 'is_superuser' assigned.
Admin user is also a regular user with only the 'is_staff' permission assigned.</p>

<p>The problem is that when i use this decorator for an admin user, it doesn't pass the test:</p>

<pre><code>@permission_required('is_staff')
def my_view(....)
</code></pre>

<p>@permission_required('is_staff') returns false for anonymous users. (correct)
@permission_required('is_superuser') only returns true for superusers (correct)
@permission_required('is_staff') returns FALSE for users with the 'is_staff' perm assigned. (wrong).</p>

<p>Any thoughts?</p>
 tcl: wrap a proc of the same name <p>I want to replace the definition of "proc N" with a proc of the same name and calling conventions, but with a little extra error detection code.</p>

<p>In python I could do what I want like below, but I don't have any grasp of how namespaces and function handles work in tcl.</p>

<pre><code>__orig_N = N
def N(arg1, arg2):
    if arg1 != 'GOOD VALUE':
        exit('arg1 is bad')
    return __orig_N(arg1, arg2)
</code></pre>
 Why is my Object still using a method even though I have overriden it? <p><strong>Possible Repeat</strong>: <a href="http://stackoverflow.com/questions/4404978/why-my-virtual-method-is-not-overriden">Why my Virtual method is not overriden?</a></p>

<p>I've been going through the Head First Design Patterns. On a side note, I started this book as a prerequisite to Code Complete 2. Anyway, I'm working with the Decorator pattern (<a href="http://oreilly.com/catalog/hfdesignpat/chapter/ch03.pdf" rel="nofollow">the chapter can actually even be read online)</a>.</p>

<p>So, I have 4 classes:</p>

<ol>
<li>Beverage Class - Abstract</li>
<li>Espresso Class - Inherits Beverage</li>
<li>BeverageDecorator Class - Abstract</li>
<li>Mocha Class - Inherits Beverage Decotrator</li>
</ol>

<p>Here is the source code for classes 1, 3, 4.</p>

<p><strong>Beverage Class:</strong></p>

<pre><code>    public abstract class Beverage
{
    public Beverage()
    {
        Description = "Unknown Beverage";
    }

    public String getDescription()
    {
        return Description;
    }

    public abstract double cost();

    public String Description { get; set; }

}
</code></pre>

<p><strong>BeverageDecorator Class:</strong></p>

<pre><code>    public abstract class BeverageDecorator : Beverage
{
    public new abstract String getDescription();
}
</code></pre>

<p><strong>Mocha Class:</strong></p>

<pre><code>    public class Mocha : BeverageDecorator
{
    Beverage beverage;

    public Mocha(Beverage beverage)
    {
        this.beverage = beverage;
    }

    public override string getDescription()
    {
        return beverage.Description + ", Mocha";
    }

    public override double cost()
    {
        return beverage.cost() + .20;
    }
}
</code></pre>

<p>So they are pretty straight-forward. Then when I put this code in the Main() method I keep getting an "Unknown Beverage" description.</p>

<pre><code>        static void Main(string[] args)
    {

        Beverage beverage = new Espresso();
        beverage = new Mocha(beverage);
        Console.WriteLine(beverage.Description +
            " $" + beverage.cost());

        Console.Read();

    }
</code></pre>

<p><strong>Mocha</strong> goes from the class it inherits - Beverage Decorator - to the class above that - Beverage Class. Even though I have the method in the Beverage Decorator and I override it. Why is this happening? I know it has something to do with being abstract classes but I just can't seem to figure it out. </p>
 C++ Decorator pattern <p>I've a <em>vector</em> and several classes (located in separate files) to modify the one.<br>
I want to have global access to the <code>std::vector</code>, but only within the derived classes
when each call stores the result of previous and the last object should return the total result</p>

<p>Could you explain how to build a high-performance interface using Decorator pattern with <code>std::vector</code>?<br>
I may be wrong, and may need other pattern.</p>

<pre><code>// A.h
class A () {
      public : 
           vector&lt;int&gt; set(vector&lt;int&gt; &amp;vec);

            //return total result
           vector&lt;int&gt; get() {
               return vector;
           }
};

// B.h
class B () {
    //add new elements into vector
    //for example, add 2,3,4
};

// C.h
class C () {
    //remove some elements from vector
    //for example, remove last element
};

//...

// main.cpp
#include "A.h"
#include "B.h"
#include "C.h"

int main () {

    vector&lt;int&gt; set;
    set.push_back(1); //1

    C obj(new B(new A()));
    obj.set(set);
    obj.get(); // stores 1,2,3 (added by classes A, B, C)
}
</code></pre>

<p>So, I don't want to do like this:</p>

<pre><code>vector&lt;int&gt; set1;
set1.push_back(1);

A *A_init;
A_init-&gt;set(set1); //add 1

vector&lt;int&gt; set2 = A_init-&gt;get();

B *B_init;
B_init-&gt;set(set2); //add 2, stores 1,2

vector&lt;int&gt; set3 = B_init-&gt;get();

C *C_init;
C_init-&gt;set(set3); //add 3, stores 1,2,3

vector&lt;int&gt; set4 = C_init-&gt;get();

/..
</code></pre>

<p>And I want to do like this:</p>

<pre><code>vector&lt;int&gt; set;
set.push_back(1);

C obj(new B(new A()));
obj.set(set);
obj.get(); // stores 1,2,3
</code></pre>

<p>I've a simple impementation of a pattern Decorator.<br>
But it is not quite what I need ((</p>

<pre><code>#include &lt;iostream&gt;
#include &lt;memory&gt;

class A {
    public:
        virtual void operation() = 0;
    };

class Component : public A {
    public:
        virtual void operation() {
            std::cout&lt;&lt;"World!"&lt;&lt;std::endl;
        }
};

class B : public A {
    std::unique_ptr&lt;A&gt; add;

public:
    B(A *component): add(component) {}

    virtual void operation() {
        std::cout &lt;&lt; ", ";
        add-&gt;operation();
    }
};

class C : public A {
    std::unique_ptr&lt;A&gt; add;

public:
    C(A *component): add(component) {}

    virtual void operation() {
            std::cout &lt;&lt; "Hello";
            add-&gt;operation();
    }
};

int main() {
    C obj(new B(new Component()));
    obj.operation(); // prints "Hello, World!\n"

    return 0;
}
</code></pre>

<p>PS:
Sorry for not so clear explanation, because I don't know English so well</p>
 Decorator pattern implementation <p>Trying to implement the decorator pattern in C# from the code in the "Head First Design Patterns" book (written in Java).</p>

<p>I am just starting out with C# and am therefore still new to the syntax, so I am not sure why I can't get the commented line of code below to work.</p>

<p>Here is the first abstract-base class and its derived classes in the Decorator pattern:</p>

<pre><code>using System;

public abstract class Beverage
{
    private String m_description;

    // get a description of the beverage
    public virtual String Description { get { return m_description; } }

    // calculate cost of the beverage
    public abstract double Cost();
}

// HouseBlend coffee implements Beverage
public class HouseBlend : Beverage
{
    // Constructor
    public HouseBlend() { m_description = "House Blend"; }

    // calculate base cost of House Blend
    public override double Cost() { return 0.89; }
}

// DarkRoast coffee implements Beverage
public class DarkRoast : Beverage
{
    // Constructor
    public DarkRoast() { m_description = "Dark Roast"; }

    // calculate base cost of Dark Roast
    public override double Cost() { return 1.00; }
}

// Espresso coffee implements Beverage
public class Espresso : Beverage
{
    // Constructor
    public Espresso() { m_description = "Espresso"; }

    // calculate base cost of Espresso
    public override double Cost() { return 1.99; }
}
</code></pre>

<p>The offending code is in the Cost() method of the Mocha class:</p>

<pre><code>using System;

// abstract base class CondimentDecorator is-a Beverage
public abstract class CondimentDecorator : Beverage {}

// Mocha implements the CondimentDecorater
public class Mocha : CondimentDecorator
{
    // Condiment decorator has-a Beverage (recursion!)
    private Beverage m_beverage;

    // Constructor binds the object passed to member var
    public Mocha(Beverage beverage)
    {
        this.m_beverage = beverage;
    }

    // getter implements abstract class Description
    public override String Description
    {
        get
        {
            return m_beverage.Description + ", Mocha";
        }
    }

    // get the Cost of the condiment plus the base-cost
    // of the original beverage
    public new double Cost()               // ERROR: 'Mocha.Cost()' hides inherited
    {                                      // member 'Beverage.Cost()'
        return 0.20 + m_beverage.Cost();
    }
}
</code></pre>
 What design pattern would this be, and is it a good idea? (C#) <p>I've got a class that I want to extend functionality to in a decorator/adapter kind of a way, only I don't want my extending class to have to know anything about the kinds of classes it is extending, and I don't want to have to write a new class for each type of object I want to extend.  All objects I would want to extend off of, though, share a common base class, <code>Team</code>.  This sounds ripe for a use of generics, so here was my initial idea:</p>

<pre><code>public class TournamentTeam&lt;T&gt; : T
   where T : Team
{
   private int mSeed;

   public TournamentTeam(T team, int seed)
      : base(team)
   {
      /*
       * error checking stuff here
       */

      // set class variables
      this.mSeed = seed;
   }

   public int Seed
   {
      get { return this.mSeed; }
   }
}
</code></pre>

<p>This would have done what I wanted, as now if I want to access members of T, the new class has all of them.  The base constructor would take care of setting up the state in a way such that the extended class didn't need to worry about it.  I also wouldn't have to know what methods to override in order to point to an internal object in a decorator/facade type manner.  Needless to say, this didn't compile.  So, I tried something a little different.</p>

<pre><code>    public class TournamentTeam&lt;T&gt; : Team
        where T : Team
    {
        #region class variables
        private int mSeed;
        private T mTeam;
        #endregion

        public TournamentTeam(int seed, T team)
            : base(team)
        {
            /*
             * error checking stuff here
             */

            // set class variables
            this.mSeed = seed;
            this.mTeam = team;
        }

        public int Seed
        {
            get { return this.mSeed; }
        }

        public T Team
        {
            get { return this.mTeam; }
        }
    }
</code></pre>

<p>OK, now if I want to get at the functionality of the "base class", I just call the Team property and I'm good to go.  And, since it's generic, I don't have to do any boxing to get to the functionality.  it works, it aint pretty, but it works.</p>

<p>What pattern is this, if one exists, and what pitfalls do yall see with this idea?  Is there a better way to accomplish this?</p>
 Using RABL with Draper to render to_json <p>I've got some fairly complex JSON responses in my application for my <code>Ticket</code> model and I'd like my <code>TicketDecorator</code> to be the one who builds those responses.</p>

<p>However, I've already setup and API for my system and use RABL to build those JSON responses, so I'd like to reuse the templates that I've already created.</p>

<p>I'm wondering if it's possible to render a RABL template from within a method inside <code>TicketDecorator</code>, something like this:</p>

<p>Here is my RABL template <code>tickets/show.json.rabl</code></p>

<pre><code>object @ticket

attributes :id, :link, :reported_ago_in_words_with_reporter,
           :last_updated_in_words_with_updater, :priority_label, :status,
           :location, :category_list

node(:attachment_urls) { |ticket| [ asset_path(ticket.first_attachment_url),     asset_path(ticket.second_attachment_url), asset_path(ticket.third_attachment_url) ] }

node(:comment_count) { |ticket| ticket.comments.count }

child :recent_comments do
  extends 'comments/index'
end
</code></pre>

<p>and here is my <code>TicketDecorator</code> method:</p>

<pre><code>class TicketDecorator &lt; ApplicationDecorator
  def as_json
    h.render(template: "tickets/show", formats: :json)
  end
end
</code></pre>

<p>However, this doesn't work because I can't sucessfully set @ticket, and I get an error saying:  <code>undefined method `first_attachment_url' for nil:NilClass</code> because <code>@ticket</code> is nil.</p>

<p>Anybody have any good solutions on how I can make these two work nicely together?</p>

<p>My only real thought would be rendering the template to a string and using RABL manually, but I'm not sure how I'd be able to call <code>render_to_string</code> inside of Draper since its not a view helper.</p>

<p>Any thoughts about that?</p>
 Same condition as decorator and as normal function? <p>I want to check a certain argument value against a regex-pattern and only continue if they match. This happens in many places within my app, so I decided to let a function do the checking and call that function whenever I need it. Now, in most cases, I need that check to be performed right at the beginning of a view, so I created it as a decorator like so:</p>

<pre><code>def validate(f):
    def _inner(request, argument=None):
        if argument is None:
            return HttpResponse(content="No argument given", status=400)
        elif not re.match('^SOME_REGEX$', argument):
            return HttpResponse(content="Invalid argument", status=400)
        else:
            return f(request, argument)
    return _inner
</code></pre>

<p>But there are other cases where I need to call that checker from <strong>within</strong> a function, as part of nested conditions. It seems I can't call it directly, e.g. <code>validate(argument)</code>. Is there any way I can use the same code as a decorator as well as a normal function? Or do I have to type it twice?</p>
 Naive implementation of decorator pattern in Objective-C <p>I have read from the book <em>Cocoa Design Patterns</em> that the decorator pattern is used in many <code>Cocoa</code> classes, including <code>NSAttributedString</code> (which does not inherit from <code>NSString</code>). I <a href="http://www.koders.com/objectivec/fid6E9728FBD2B4BDFC1619FCCB27155000FDBEED8A.aspx" rel="nofollow">looked at an implementation <code>NSAttributedString.m</code></a> and it was over my head, but I would be interested to know if anyone on SO has successfully implemented this pattern AND they are willing to share.</p>

<p>The requirements are adapted from <a href="http://en.wikipedia.org/wiki/File%3aDecorator_UML_class_diagram.svg" rel="nofollow">this decorator pattern reference</a> and since there are no abstract classes in Objective-C, the <code>Component</code> and <code>Decorator</code> should be suitably similar enough to abstract classes and serve their original purpose (i.e. I don't think they can be protocols, because you have to be able to do <code>[super operation]</code>.</p>

<p>I would be really thrilled to see some of your implementations of decorator.</p>
 
castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy castle-dynamicproxy Castle DynamicProxy - Failure when creating proxy involving a GTP used as a GTR <p>OK, now I'm really confused.</p>

<p>I originally had <a href="http://stackoverflow.com/questions/4382624/cant-get-rhinomocks-to-emit-a-mock-that-follows-the-generic-type-restriction-ru">this problem</a>, which is, according to posters, an issue with the version of Castle.DynamicProxy that's ILMerged into the latest Rhino.Mocks library. It has, according to several authorities on the subject, been fixed in the latest Castle, but that library has not made it into a new Rhino.Mocks. Most people are saying "just download the Rhino source and the latest Castle and build your own version".</p>

<p>So, I did exactly that; I grabbed a ZIP of the Rhino trunk source from Ayende's GitHub, opened it up, and built it. Then, like a good little TDDer, I created a unit test to make sure my changes worked (because the latest Castle folds DynamicProxy into Core, requiring some significant referencing changes):</p>

<pre><code>    [Test]
    public void MockOfInterfaceMethodWithInterfaceGTR()
    {
        var mock = mocks.DynamicMock&lt;ITestRestrictedInterface&gt;();
        Assert.NotNull(mock);
        Expect.Call(mock.TestMethod(new Object2())).IgnoreArguments().Return(5);
        mocks.ReplayAll();
        Assert.AreEqual(5, mock.TestMethod(new Object2()));
    }

...

internal interface ITestGenericInterface&lt;TRest&gt; where TRest:IObject1
{
    int TestMethod&lt;T&gt;(T input) where T : TRest;
}

internal interface ITestRestrictedInterface:ITestGenericInterface&lt;IObject2&gt; { }

internal interface IObject1 { }
internal interface IObject2:IObject1 { }

internal class Object2:IObject2 { } 
</code></pre>

<p>The result, when run in my own production code with the latest released Rhino? Failure with the following message: </p>

<blockquote>
  <p>System.TypeLoadException : Method 'TestMethod' on type
  'ITestRestrictedInterfaceProxy83ad369cdf41472c857f61561d434436' from
  assembly 'DynamicProxyGenAssembly2, Version=0.0.0.0, Culture=neutral,
  PublicKeyToken=null' tried to implicitly implement an interface method
  with weaker type parameter constraints.</p>
</blockquote>

<p>...However, when I copy and paste this test into a fixture in the Rhino.Mocks.Tests project, without making any changes to referenced libraries, the test PASSES. I have made zero changes to the downloaded source. I have made ZERO changes to the test method and related interfaces/objects on both sides. I built a new Rhino.Mocks DLL (without IL-merging the Castle libs) and copied it with Castle libs back to my production solution, re-ran the test, and it still fails with the same message.</p>

<p>WTF?</p>
 What are the differences between LinFu.DynamicProxy and Castle.DynamicProxy? <p>I am looking at adding logic to a library I am working on that would require the need for a Dynamic Proxy.  I would like to get some advice from user's who have used these two library's in a production environment.  Does one out perform the other, were there any shortcoming's which made you have to switch to the other, etc.  Basically tell me your experiences with the library's.  The answers will help me decide which one to use.</p>

<p>-- Edit --</p>

<p><hr /></p>

<p>I forgot to mention that the library I am developing will support Mono, therefore any knowledge you can share about the two libraries and their support for Mono would be great also.</p>
 Applying AOP <p>I've been using some basic AOP style solutions for cross-cutting concerns like security, logging, validation, etc.  My solution has envolved around <a href="http://www.castleproject.org/container/index.html">Castle Windsor</a> and DynamicProxy.  I've gone down this route because I can apply everything using a Boo based DSL and keep my code clean of Attributes.  I was told at the weekend to have a look at <a href="http://www.postsharp.org/">PostSharp</a> as it's supposed to be a "better" solution.  I've had a quick look at PostSharp, but I've been put off by the Attribute usage.</p>

<p>Has anyone tried both solutions and would care to share their experiences?</p>
 Castle Windsor InternalsVisibleTo Silverlight <p>I'm using Castle Windsor for SL v2.5.1.0. I have it proxy internal classes (the interfaces are public of course, but the implementation is internal, so that the consumer is only aware of the interface).</p>

<p>I'm using the following attributes in my assembly with the internal classes </p>

<pre><code>[assembly: InternalsVisibleTo("Castle.Core, PublicKey=002400000480000094000000060200000024000052534131000400000100010077F5E87030DADCCCE6902C6ADAB7A987BD69CB5819991531F560785EACFC89B6FCDDF6BB2A00743A7194E454C0273447FC6EEC36474BA8E5A3823147D214298E4F9A631B1AFEE1A51FFEAE4672D498F14B000E3D321453CDD8AC064DE7E1CF4D222B7E81F54D4FD46725370D702A05B48738CC29D09228F1AA722AE1A9CA02FB")]
[assembly: InternalsVisibleTo("Castle.Windsor, PublicKey=002400000480000094000000060200000024000052534131000400000100010077F5E87030DADCCCE6902C6ADAB7A987BD69CB5819991531F560785EACFC89B6FCDDF6BB2A00743A7194E454C0273447FC6EEC36474BA8E5A3823147D214298E4F9A631B1AFEE1A51FFEAE4672D498F14B000E3D321453CDD8AC064DE7E1CF4D222B7E81F54D4FD46725370D702A05B48738CC29D09228F1AA722AE1A9CA02FB")]
[assembly: InternalsVisibleTo("DynamicProxyGenAssembly2")]
</code></pre>

<p>In full .NET 4.0 mode, with the .NET 4.0 Castle assemblies, this works fine and my types are proxied OK. In Silverlight, with the Silverlight Castle assemblies, I get:</p>

<pre><code>Type ConsoleApplication4.MyTypeToBeProxied is not public. Can not create proxy for types that are not accessible.
</code></pre>

<p>Also, just in troubleshooting the problem, adding the following seems to make no difference...:</p>

<pre><code>[assembly: InternalsVisibleTo("System.Core, PublicKey=00000000000000000400000000000000")]
[assembly: InternalsVisibleTo("System.Core, PublicKey=" +
"00240000048000009400000006020000002400005253413100040000010001008d56c76f9e8649" +
"383049f383c44be0ec204181822a6c31cf5eb7ef486944d032188ea1d3920763712ccb12d75fb7" +
"7e9811149e6148e5d32fbaab37611c1878ddc19e20ef135d0cb2cff2bfec3d115810c3d9069638" +
"fe4be215dbf795861920e5ab6f7db2e2ceef136ac23d5dd2bf031700aec232f6c6b1c785b4305c" +
"123b37ab")]
</code></pre>

<p>and I've also verified at runtime that the name of the dynamically hosted assembly in SL is still in fact DynamicProxyGenAssembly2.</p>

<p>Any ideas? Thanks.</p>

<p><strong>EDIT</strong>:</p>

<p>I found the problem I think:</p>

<p>Castle for .NET 4.0 has:</p>

<pre><code>private bool IsAccessible(Type target)
{
  //      ....
  return ((target.IsPublic || target.IsNestedPublic) || internalAndVisibleToDynProxy);

}
</code></pre>

<p>in the DefaultProxyBuilder...and SL 4 has</p>

<pre><code>private bool IsAccessible(Type target)
{
    target.IsNested();
    return (target.IsPublic || target.IsNestedPublic);
}
</code></pre>

<p>Is this something that can be fixed in the Castle source? Or do I need to/should I sub-class the DefaultProxyFactory?</p>
 Whats the difference between PostSharp and Castle Dynamic Proxy? <p>Just wondering what the main differences are between these libraries, how they differ in features and functionality.</p>

<p>Hoping for more information than I could find with a Google query...</p>
 Getting underlying type of a proxy object <p>I'm using Castle DynamicProxy and my ViewModels are a proxy, something like this:</p>

<pre>
namespace MyApplication.ViewModels
{
   public class MyViewModel : BaseViewModel, IMyViewModel
   {
   }
}
</pre>

<p>a proxy of my viewmodel looks like this though:</p>

<p>{Name = "IRootViewModelProxyffecb133f590422098ca7c0ac13b8f98" FullName = "IRootViewModelProxyffecb133f590422098ca7c0ac13b8f98"}</p>

<p>I want to get the actual type or namespace of the actual type that is being proxied. Is there any way to do this? I want something that returns MyApplication.ViewModels.MyViewModel type. If I'm using concreate class as proxies, BaseType returns the actual class that is being proxied, but when using the interface, BaseType would return System.Object.</p>
 Castle DynamicProxy : How to Proxy Equals when proxying an interface? <p>I need to use Castle DynamicProxy to proxy an interface by providing an instance of it to ProxyGenerator.CreateInterfaceProxyWithTarget. I also need to make sure that calls to Equals, GetHashCode and ToString hits the methods on the concrete instance, that I am passing, and I can't get that to work. </p>

<p>In other words, I'd like this small sample to print <code>True</code> twice, while in fact it prints <code>True,False</code>:</p>

<pre><code>using System;
using Castle.Core.Interceptor;
using Castle.DynamicProxy;

public interface IDummy
{
    string Name { get; set; }
}

class Dummy : IDummy
{
    public string Name { get; set; }

    public bool Equals(IDummy other)
    {
        if (ReferenceEquals(null, other)) return false;
        if (ReferenceEquals(this, other)) return true;
        return Equals(other.Name, Name);
    }

    public override bool Equals(object obj)
    {
        return Equals(obj as IDummy);
    }      
}

class Program
{
    static void Main(string[] args)
    {
        var g = new ProxyGenerator();
        IDummy first = new Dummy() {Name = "Name"};
        IDummy second = new Dummy() {Name = "Name"};
        IDummy firstProxy = g.CreateInterfaceProxyWithTarget(first, new ConsoleLoggerInterceptor());
        IDummy secondProxy = g.CreateInterfaceProxyWithTarget(second, new ConsoleLoggerInterceptor());

        Console.WriteLine(first.Equals(second));         
        Console.WriteLine(firstProxy.Equals(secondProxy));
    }
}

internal class ConsoleLoggerInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        Console.WriteLine("Invoked " + invocation.Method.Name);
    }
}
</code></pre>

<p>Is this possible with DynamicProxy ? How ?</p>
 DynamicProxy Generation Speed <p>I'm trying to troubleshoot some startup time concerns. After doing some profiling, I've found the main culprit is ClassProxyGenerator.GenerateCode. This takes 400-600ms per type the first time. So if the entry point to the application has 8 dependencies (in a chain) which need proxies generated, the startup time of the application goes up by 4.8 seconds. This might not seem like a lot, but to a user, it seems like ages.</p>

<p>Any advice for improving this?</p>

<p>Update:</p>

<p>I can reproduce the time with the following console application:</p>

<pre><code>        var container = new WindsorContainer();
        container.Register(Component.For&lt;Interceptor&gt;()); // dummy IInterceptor...does nothing
        container.Register(Component.For&lt;IMyRepository, MyAbstractRepository&gt;().Interceptors&lt;Interceptor&gt;());
        var t = DateTime.Now;
        var instance = container.Resolve&lt;IMyRepository&gt;();
        Debug.WriteLine("Resolved in " + (DateTime.Now - t).TotalMilliseconds);
</code></pre>

<p>Outputs somewhere between 550ms and 750ms.</p>

<p>IMyRepository is a repository interface for 30 entity types (generated by a T4 template). It has 31 IQueryables, 31 Save overloads, and 31 Delete overloads. MyAbstractRepository is a partial abstract class. It declares the same 3 x 31 methods.</p>

<p>If I remove all the save and delete methods and leave just the 31 IQueryables AND don't register the abstract repository </p>

<pre><code>  container.Register(Component.For&lt;IMyRepository&gt;().Interceptors&lt;Interceptor&gt;());
</code></pre>

<p>I still run around 250ms for the initial generation. </p>

<p>This is a very (very very) fast machine...so anything in the real world will likely perform slower than the numbers listed above.</p>
 Why does getting the mocked instance created with Moq throw a System.BadImageFormatException? <p>This question may be related to <a href="http://stackoverflow.com/questions/305345/moq-multi-interface-question">another</a> question and it certainly results with a System.BadImageFormatException. Maybe it's the same thing but exposed differently?</p>

<p>I have the following the code:</p>

<pre><code>public interface IFoo&lt;T&gt; where T : class, new() {
  T FooMethod(object o);
}

public interface IFooRepo {
  F GetFoo&lt;T, F&gt;() where T : class, new() where F : IFoo&lt;T&gt;;
}
</code></pre>

<p>Then I have a test that mocks IFooRepo using Moq like so:</p>

<pre><code>var instance = new Mock&lt;IFooRepo&gt;().Object;
</code></pre>

<p>The above code runs fine except when debugging the test with Visual Studio 2008. When I step over the above line a System.BadImageFormatException is thrown from System.Reflection.Emit via Castle.DynamicProxy. Could this be similar to <a href="http://groups.google.com/group/RhinoMocks/msg/500daa19f20c9748" rel="nofollow">something</a> Ayende Rahien posted?</p>

<p>Now the workaround is to implement a fake for IFooRepo but I'm curious as to why a bad image is generated for this kind of scenario and is there a fix? Is System.Reflection.Emit buggy? Or am I missing something obvious in my own code?</p>

<p><strong>EDIT</strong>: Posted the incorrect signature for GetFoo(). Corrected the signature to GetFoo&lt;T, F&gt;(), which correctly reproduces the problem. With the GDR installed this problem persists.</p>

<p><strong>EDIT</strong>: It seems that if the constraint on F includes type parameter T BadImageFormatException is raised. But I change it to, say <code>where F : class, new()</code>, then everything works as expected.</p>
 Make object dynamically implement an interface in code <p>I want to make this test pass - anyone got an idea how to do that?</p>

<pre><code>public class Something
{
    public string Name {get; set}
}

public interface IWithId
{
    public Guid Id {get; set}
}

public class IdExtender 
{
    public static Object Extend(object toExtend)
    {
        ...?
    }
}

public class Tests 
{
    [Test]
    public void Should_extend_any_object()
    {
        var thing = new Something { Name = "Hello World!"};
        var extended = IdExtender.Extend(thing);
        Assert.IsTrue(extended is IWithId);
        Assert.IsTrue(extended.Id is Guid);
        Assert.IsTrue(extened.Name == "Hello World!");
    }
}
</code></pre>

<p>I guess something like this could be done with castle dynamic proxy, linfu,etc... but how?</p>
 How to detect if a Type is a generated DynamicProxy without referencing Castle DynamicProxy? <p>I am using castle DynamicProxy and was wondering if there is a way of detecting if a Type is a proxy without referencing Castle DynamicProxy?</p>

<p>So while I am using Castle DynamicProxy as an example I would like code that would work for any in memory generated type.</p>

<pre><code>var generator = new ProxyGenerator();


var classProxy = generator.CreateClassProxy&lt;Hashtable&gt;();
Debug.WriteLine(classProxy.GetType().Is....);


var interfaceProxy = generator.CreateInterfaceProxyWithoutTarget&lt;ICollection&gt;();
Debug.WriteLine(interfaceProxy.GetType().Is....);
</code></pre>

<p>Thanks</p>
 Using dynamic proxy on NHibernate objects <p>I'm trying to use Castle.DynamicProxy2 to cleanup code within NHibernate persisted classes. Here is a simple version of it.</p>

<p>The Pet class:</p>

<pre><code>public class Pet
{
    public int Id { get; set; }
    public string Name { get; set; }
    public int Age { get; set; }
}
</code></pre>

<p>And its mapping file:</p>

<pre><code>&lt;class name="Pet" table="Pet"&gt;
  &lt;id name="Id" column="Id" unsaved-value="0"&gt;
    &lt;generator class="native"/&gt;
  &lt;/id&gt;
  &lt;property name="Name" column="Name"/&gt;
  &lt;property name="Age" column="Age"/&gt;
&lt;/class&gt;
</code></pre>

<p>There is a need to audit instances of the Pet class. Normally, the properties Name and Age would not be auto-properties and would contain logic to record value changes. Now, I'm thinking of using proxies to inject auditing logic within property setters. To do that, I created the Auditor IInterceptor:</p>

<pre><code>public class Auditor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        // Do something to record changes
        invocation.Proceed();
    }
}
</code></pre>

<p>It's simple enough to create an audited instance of the Pet class using Castle.DynamicProxy2.</p>

<pre><code>Pet aPet = proxyGenerator.CreateClassProxy&lt;Pet&gt;(new Auditor());
aPet.Name = "Muffles"; // The Auditor instance would record this.
aPet.Age = 4;          // and this too...
</code></pre>

<p>Now here comes the problem. Since Pet is persisted, the system would need to work on instances of Pet fetched via NHibernate. What I want to happen is that NHibernate to return instances of Pet proxy automatically like so:</p>

<pre><code>// I would imagine an instance of Auditor being created implicitly
ICriteria criteria = session.CreateCriteria(typeof(Pet));
criteria.Add(Expression.Expression.Eq("Name", "Muffles"));

// return a list of Pet proxies instead
// so changes can be recorded.
IList&lt;Pet&gt; result = criteria.List&lt;Pet&gt;();

Pet aPet = result[0];
aPet.Age = aPet.Age + 1;

// I expect this to succeed since the proxy is still a Pet instance
session.Save(aPet);
</code></pre>

<p>I've though of something like this to get around it:</p>

<pre><code>ICriteria criteria = session.CreateCriteria(ProxyHelper.GetProxyType&lt;Pet&gt;());
criteria.Add(Expression.Expression.Eq("Name", "Muffles"));

// use List() instead of List&lt;T&gt;()
// and IList instead of IList&lt;Pet&gt;
IList results = criteria.List();
</code></pre>

<p>where <code>ProxyHelper.GetProxyType&lt;Pet&gt;()</code> would return the cached Pet proxy type. The main disadvantage is that this solution would not work on generic lists (e.g. <code>IList&lt;Pet&gt;</code>). The existing system I'm trying to clean up makes use of them extensively.</p>

<p>So I'm hoping if anyone has any workaround or any insight on whether or not what I'm doing is advisable.</p>

<p>Thanks a million,</p>

<p>Carlos</p>
 How can I create a DynamicProxy for a WCF proxy that is generated by ChannelFactory<T>? <p>I am using ChannelFactory to create a proxy at run-time for a WCF service. I would like to use the DynamicProxy Castle project to create a dynamic proxy on top of the WCF proxy so that I can intercept calls and do impersonation.</p>

<p>I'm getting an error when I try this though... the error message is:</p>

<blockquote>
  <p>'this' type cannot be an interface itself.</p>
</blockquote>

<p>My code is this (where T is a service contract interface):</p>

<pre><code>var generator = new ProxyGenerator();

return (T)generator.CreateInterfaceProxyWithTarget(typeof(T), channel, 
    new[] { new ImpersonationInterceptor() } );
</code></pre>

<p>The problem must have to do with the fact that the service proxy generated by ChannelFactory is generated at runtime, but is there any way around this problem?</p>
 What's the simplest way to intercept a method call for added functionality? <p>Suppose i have a repository that returns a list of <code>Post</code>s. The repository interface has a <code>GetAll()</code> method which does what it suggests.</p>

<p>Now in keeping with the theory that i shouldn't be putting domain logic in the repository, i want to intercept calls to the concrete <code>GetAll()</code> method such that i can add the following logic to the <code>GetAll()</code> result:</p>

<pre><code>return GetAll().OrderByDescending(p =&gt; p.Posted).ToList();
</code></pre>

<p>The reason i want to intercept this is because (1) i don't want to have the client remember to call an extension method (<code>OrderByDescending</code> or some useless wrapper of that), i want it called every time and (2) i don't want to have all my concrete implementations have to remember to order the <code>GetAll()</code> result - i want this logic in a single place external to any repository.</p>

<p>What's the easiest way to do this?</p>

<p>I'm already using <a href="http://structuremap.net/structuremap/" rel="nofollow">StructureMap</a> so if i can intercept with this it might be a low cost option. But i don't think SM intercepts method calls, just the creation of the object instance?</p>

<p>Do i need to go to a <a href="http://msmvps.com/blogs/jon_skeet/archive/2007/02/27/wacky-ideas-1-inheritance-is-dead-long-live-mix-ins.aspx" rel="nofollow">proxy or mixin</a> pattern? Do i need to go all-in with Castle <a href="http://kozmic.pl/dynamic-proxy-tutorial/" rel="nofollow">Dynamic Proxy</a>? Or is there <a href="http://ayende.com/Blog/archive/2007/07/02/7-Approaches-for-AOP-in-.Net.aspx" rel="nofollow">another method</a> i should consider or perhaps a combination?</p>

<p>I'm really interested in a concrete suggestion to my particular example above. I'm novice to AOP so please be gentle.</p>
 Trying to make a Logging Interceptor for StructureMap using DynamicProxy <p>I'm trying to log calls from the UI (DNN module) to some of various services it uses, in a effort to profile how people are interacting with the site. I'm using StructureMap 2.5.3.0 and Log4Net</p>

<p>I got things working well on individual class/instance pairs, but I have to configure things like this:</p>

<pre><code>ObjectFactory.Configure(ce =&gt;
        ce.ForRequestedType&lt;IRegService&gt;()
          .TheDefaultIsConcreteType&lt;RegService&gt;()
          .EnrichWith(LoggingEnrichment.InterfaceLogger&lt;IRegService&gt;));
</code></pre>

<p>Having the <code>IRegService</code> twice felt a bit messy, but I can live with it.</p>

<p>The logging is implemented like this:</p>

<pre><code>public class LoggingEnrichment
{
    public static object InterfaceLogger&lt;TInterface&gt;(object concrete)
    {
        return InterfaceLogger(typeof(TInterface), concrete);
    }

    public static object InterfaceLogger(Type iinterface, object concrete)
    {
        var dynamicProxy = new ProxyGenerator();
        return dynamicProxy.CreateInterfaceProxyWithTarget(iinterface, concrete, new LogInterceptor());
    }
}

public class LogInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        var watch = new Stopwatch();
        watch.Start();
        invocation.Proceed();
        watch.Stop();
        ILog logger = LogManager.GetLogger(typeof(LogInterceptor));
        var sb = new StringBuilder();
        sb.AppendFormat("Calling: {0}.{1}\n", invocation.InvocationTarget.GetType(), invocation.MethodInvocationTarget.Name);
        var param = invocation.Method.GetParameters();
        if (param.Length &gt; 0) sb.Append("With:\n");
        for (int i = 0; i &lt; param.Length; i++)
        {
            sb.AppendFormat("\t{0}\n\t\t{1}", param[i].Name, invocation.GetArgumentValue(i));
        }
        if(invocation.Method.ReturnType != typeof(void))
        {
            sb.AppendFormat("Returning: {0}\n", invocation.ReturnValue ?? "null");
        }
        sb.AppendFormat("In: {0}ms\n", watch.ElapsedMilliseconds);
        logger.Debug(sb.ToString());
    }
}
</code></pre>

<p>This works, but has a couple issues:</p>

<ol>
<li>I have to manually configure each service &lt;-> interface pair</li>
<li>I only want to wire up the logging when the service is called from the UI</li>
</ol>

<p>I tried to get around this by implementing a TypeInterceptor for StructureMap:</p>

<pre><code>public class ApplicationRegistry : Registry
{
    public ApplicationRegistry()
    {
        RegisterInterceptor(new LoggingInterceptor());
        Scan(scanner =&gt;
        {
            scanner.TheCallingAssembly();
            var codeBase = System.Reflection.Assembly.GetExecutingAssembly().CodeBase.Replace("file:///", String.Empty);
            codeBase = codeBase.Substring(0, codeBase.LastIndexOf("/"));
            scanner.AssembliesFromPath(codeBase);
            scanner.WithDefaultConventions();
            scanner.LookForRegistries();
        });
    }
}

public class LoggingInterceptor :TypeInterceptor
{
    public object Process(object target, IContext context)
    {
        var newTarget = target;
        if (context.BuildStack.Current != null &amp;&amp; context.BuildStack.Current.RequestedType != null)
        {
            newTarget = LoggingEnrichment.InterfaceLogger(context.BuildStack.Current.RequestedType, target);
        }
        return newTarget;
    }

    public bool MatchesType(Type type)
    {
        return type.Name.EndsWith("Service", StringComparison.OrdinalIgnoreCase);
    }
}
</code></pre>

<p>But I'm getting a problem with that where the call to <code>Process</code> is giving me a class that doesn't implement the interface defined by the build context. This has resulted in having to change the implementation of the <code>InterfaceLogger</code> to</p>

<pre><code>    public static object InterfaceLogger(Type iinterface, object concrete)
    {
        if(!iinterface.IsAssignableFrom(concrete.GetType())) return concrete;
        var dynamicProxy = new ProxyGenerator();
        var interfaceProxy = dynamicProxy.CreateInterfaceProxyWithTarget(iinterface, concrete, new LogInterceptor());
        return interfaceProxy;
    }
</code></pre>

<p>A breakpoint on the <code>return interfaceProxy;</code> is never reached, this indicates that <code>context.BuildStack.Current.RequestedType</code> isn't returning the right interface. The odd thing is that all my classes seem to be injected correctly.</p>

<p>Also, even if this was working I'd still have the issue of only wanting to intercept the calls from the UI layer.</p>

<p>I'm looking for a way my first 2 issues, and also what I'm doing wrong with the <code>TypeInterceptor</code></p>
 In Castle.DynamicProxy is it possible to change a mixin value after initialisation? <p>I noticed that DynamicProxy objects can implement an <a href="http://api.castleproject.org/html/T_Castle_Core_Interceptor_IChangeProxyTarget.htm" rel="nofollow">IChangeProxyTarget</a> interface, which allows you to do something like <code>((IChangeProxyTarget)myProxyObj).ChangeInvocationTarget(newTarget)</code>.</p>

<p>Is there a way to similarly change the mixin implementation on a DynamicProxy object? Obviously this is more complex and nuanced than changing the target in ways I have not fully thought through (due to varying interface implementations, multiplicity of mixins etc) but the concept is not entirely inconceivable.</p>

<p>Or lacking that, any ideas with regards achieving this, in a reasonably performant fashion? I have some theoretical ideas regarding hacking this in but it seems extremely, extremely convoluted:</p>

<ol>
<li>Define a MixinSwitcher class (and accompanying IMixinSwitcher interface) with <code>Action&lt;object, object&gt; DoSwitch</code> property</li>
<li>Mix an instance of this in when creating DP object `MixinSwitcher mixinSwitcher = new MixinSwitcher(); proxyGenerationOptions.AddMixinInstance(mixinSwitcher);</li>
<li>Create DP object <code>var dpObj = proxyGenerator.Create...</code> - ensure that IMixinSwitcher is added to the interfaces to implement</li>
<li>Use reflection on to find the relevant mixin MemberInfo from <code>dpObj.Gettype()</code></li>
<li>Use System.Reflection.Emit to generate a fast setter for this property.</li>
<li>Set <code>mixinSwitcher.DoSwitch = (SRE setter method here)</code></li>
<li>((IMixinSwitcher)dpObj).DoSwitch(dpObj, newMixinValue)</li>
<li>Profit... or brain melt?</li>
</ol>

<p>The step 1 class can be genericised to allow it to target specific/multiple implementations; steps 4-5 cached for extra performance, and the general step 1 implementation could be cleaned up.</p>

<p>Even so I don't deny it is pretty mad - is there a better way?</p>
 Castle Dynamic Proxy not intercepting method calls when invoked from within the class <p>I have run into a bit of (what I think is) strange behaviour when using Castle's Dynamic Proxy.  </p>

<p>With the following code:</p>

<pre><code>class Program
{
    static void Main(string[] args)
    {
        var c = new InterceptedClass();
        var i = new Interceptor();

        var cp = new ProxyGenerator().CreateClassProxyWithTarget(c, i);

        cp.Method1();
        cp.Method2();

        Console.ReadLine();
    }
}

public class Interceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        Console.WriteLine(string.Format("Intercepted call to: " + invocation.Method.Name));

        invocation.Proceed();
    }
}

public class InterceptedClass
{
    public virtual void Method1()
    {
        Console.WriteLine("Called Method 1");
        Method2();
    }

    public virtual void Method2()
    {
        Console.WriteLine("Called Method 2");
    }
}
</code></pre>

<p>I was expecting to get the output:</p>

<ul>
<li>Intercepted call to: Method1 </li>
<li>Called Method 1 </li>
<li>Intercepted call to: Method2</li>
<li>Called Method 2</li>
<li>Intercepted call to: Method2</li>
<li>Called Method 2</li>
</ul>

<p>However what I got was:</p>

<ul>
<li>Intercepted call to: Method1 </li>
<li>Called Method 1</li>
<li>Called Method 2 </li>
<li>Intercepted call to: Method2</li>
<li>Called Method 2</li>
</ul>

<p>As far as I can tell then the dynamic proxy is only able to proxy method calls if the call comes from outside the class itself as Method2 was intercepted when called from Program but not from within InterceptedClass.  </p>

<p>I can kind of understand that when making calls from within the proxied class it would no longer go through the proxy, but just wanted to check that this was expected and if it is then see if there is there anyway to get all calls intercepted regardless of where they're called from?</p>

<p>Thanks </p>
 Ninject Interception dynamic proxy problems <p>I'm trying to set up interception to work with Ninject which we have been using as our dependency injection framework for a while.</p>

<p>I have downloaded the interception extension from NuGet and tried it with both the Castle Dynamicproxy implementation and the LinFu implementation but could not be either to work with our applications.</p>

<p>Castle gave an error when creating a proxy on a class that did not have a parameterless constructor, since all the service objects have their dependencies injected via the constructor this is a problem. The error is:</p>

<p>System.ArgumentException: Can not instantiate proxy of class: emedia.RapidSystems.Subscriber.Presenters.RRSubmissionPresenter.
Could not find a parameterless constructor.
Parameter name: constructorArguments</p>

<p>The LinFu interceptor worked better, right up until the code called a method with a generic parameter then it gave me the following:</p>

<p>System.ArgumentException: Generic types are not valid.
Parameter name: methodInfo</p>

<p>Here is a simplified version code for one of the classes I am trying to intercept:</p>

<pre><code>[LogCalls]
public class Repository&lt;T&gt; : IRepository&lt;T&gt;
        where T : class
{   
    public virtual T GetEntity&lt;TKey&gt;(ObjectContext context, TKey key)
    {
        var entity = GetEntity(context, key, _emptyLoadingStrategy);
        return entity;
    }

    public virtual IQueryable&lt;T&gt; GetAll(ObjectContext context)
    {
        var query = GetAll(context, _emptyLoadingStrategy);
        return query;
    }

    public virtual T Add(ObjectContext context, T entity)
    {
        context.AddObject(EntitySetName(context), entity);
        return entity;
    }

     //other code goes here

}
</code></pre>

<p>Add and GetAll work fine but the error happens when GetEntity is called on the proxy.</p>

<p>At this point I'm stuck, as neither interceptor works with the code base. Has anyone got Ninject interception working with a real complex production system, rather than a simple demo class, and if so how? I don't mind which interceptor I use as long as it works.</p>

<p>Or is interception with Ninject just not mature enough yet, and do I need to look at replacing the whole thing with something else like Unity?</p>
 ASP.NET MVC3 controller AOP proxy not intercepting all methods, only IController.Execute <p>I have a project with several layers - among them the web front end (ASP.NET MVC3) and the service back end (mainly business logic). The project is a few months old, so everything is working as expected. Now I am trying to add a logging aspect to some of the MVC3 controller methods using custom <code>[Log]</code> attributes.</p>

<p>I am using <a href="http://docs.castleproject.org/Windsor.MainPage.ashx" rel="nofollow">Castle Windsor</a> for dependency injection. To get a logging aspect I leverage <a href="http://castleproject.org/dynamicproxy/" rel="nofollow">Castle DynamicProxy</a> through <a href="http://www.simpleaspects.com/" rel="nofollow">SNAP</a>. Controllers are being resolved using <a href="http://docs.castleproject.org/Windsor.Windsor-tutorial-part-two-plugging-Windsor-in.ashx" rel="nofollow"><code>WindsorControllerFactory</code></a> from Krzysztof Koźmic's helpful tutorial - but I modified it to look for the default interface for the controller (see below).</p>

<p>In my service layer:</p>

<pre><code>[Log(LoggingLevel.Info)]
public void Save(MyBusinessDto dto)
{
    // business logic and other checks

    this.repository.Save(mbo);
}
</code></pre>

<p>In my web front end's <a href="http://stw.castleproject.org/Windsor.Installers.ashx" rel="nofollow"><code>IWindsorInstaller</code></a> for controllers:</p>

<pre><code>private static BasedOnDescriptor FindControllers()
{
    return AllTypes
            .FromThisAssembly()
            .BasedOn&lt;IController&gt;()
            .WithService.DefaultInterface();
}
</code></pre>

<p>In my (slightly customized) <code>WindsorControllerFactory</code> that looks for the default interface for the controller:</p>

<pre><code>protected override IController GetControllerInstance(RequestContext requestContext, Type controllerType)
{
    if (controllerType == null)
    {
        throw new HttpException(404, string.Format(Error404, requestContext.HttpContext.Request.Path));
    }

    string controllerName = controllerType.Name;
    string defaultInterfaceName = 'I' + controllerName;
    Type defaultInterface = controllerType.GetInterface(defaultInterfaceName);

    object controller = this.kernel.Resolve(defaultInterface);

    return (IController)controller;
}
</code></pre>

<p>In my controllers:</p>

<pre><code>public class MyBusinessController : MyBusinessControllerBase, IMyBusinessController
{
    [Log(LoggingLevel.Debug)]
    public ActionResult CreateOrUpdate(MyBusinessFormModel fm)
    {
        // Convert form model to data transfer object,
        // perform validation and other checks

        this.service.Save(dto);

        return View(fm);
    }
}
</code></pre>

<p>This all works fine in the service project, but in the controllers the methods are not being intercepted.</p>

<ul>
<li>I have confirmed that the <code>WindsorControllerFactory</code> returns proxied controllers.</li>
<li>I have confirmed that the controllers have the interceptor registered.</li>
<li>I have confirmed that the <code>MasterProxy</code> in SNAP intercepts the controller - but it only intercepts <code>IController.Execute(RequestContext requestContext)</code>.</li>
</ul>

<p><strong>How can I intercept all controller methods that have my <code>[Log]</code> attribute?</strong></p>

<p>Update 1: I have considered using DynamicProxy directly instead of SNAP, but this is secondary to getting it to work for controllers as well.</p>

<p>Update 2+4: It seems that SNAP is <strike>missing from github</strike> <a href="https://github.com/TylerBrinks/Snap/" rel="nofollow">back on github</a>.</p>

<p>Update 3: This is what I see in the Visual Studio debugger when breaking in the <code>WindsorControllerFactory</code> (see above). The inspected <code>controller</code> variable is what is returned to MVC, and it is indeed proxied.</p>

<ul>
<li><code>controller</code>  {Castle.Proxies.IMyBusinessControllerProxy}
<ul>
<li><code>__interceptors</code>  {Castle.DynamicProxy.IInterceptor[1]}
<ul>
<li><code>[0]</code> {Snap.MasterProxy}</li>
</ul></li>
<li><code>__target</code>    {My.Business.Web.Controllers.MyBusinessController}
<ul>
<li><code>service</code> {Castle.Proxies.IMyBusinessServiceProxy}</li>
<li>(other contructor injections)</li>
</ul></li>
<li><code>MyInjectedProperty</code>  {My.Business.Useful.MyOtherType}</li>
</ul></li>
</ul>
 Using DynamicProxy as a decorator pattern in windsor container <p>I am looking for some info on using and configuring windsor to provide a dynamic proxy to intercept calls to an instance of another class.  </p>

<p>My class represents a resource that should be retained as a long lived instance by the container for performance reasons.  However, sometimes this resource can transition into ununusable state, and requires renewing.  I would like the container to handle this so client code doesn't have to.  I can create my own factory to do this, I would like to know if there is some Windsor registration coolness to do it for me so I don't have to create the separate factory class :)</p>

<p>Here is some pseudo code to demonstrate the problem:</p>

<pre><code>public interface IVeryImportantResource
{
    void SomeOperation();
}

public class RealResource : IVeryImportantResource
{
    public bool Corrupt { get; set; }

    public void SomeOperation()
    {
        //do some real implementation
    }
}

public class RealResourceInterceptor : IInterceptor
{
    private readonly IKernel kernel;

    public RealResourceInterceptor(IKernel Kernel)
    {
        kernel = Kernel;
    }

    public void Intercept(IInvocation invocation)
    {
        RealResource resource = invocation.InvocationTarget as RealResource;

        if(resource.Corrupt)
        {
            //tidy up this instance, as it is corrupt
            kernel.ReleaseComponent(resource);
            RealResource newResource = kernel.Resolve&lt;RealResource&gt;(); //get a new one
            //now what i would like to happen is something like this
            //but this property has no setter, so this doesn't work
            //also, i would like to know how to register RealResourceInterceptor as well RealResourceInterceptor
            invocation.InvocationTarget = newResource;
        }
        invocation.Proceed();
    }
}
</code></pre>

<p>Any ideas how to implement something like my RealResourceInterceptor class, and also how to configure the container to use it?  Thanks!</p>
 Castle Windsor: How to retrieve proxy for specific instance? <p>I'm using Castle Windsor in my project. Some registered components are intercepted. Because the components are registered through interfaces, Castle Windsor creates interface proxies (Castle Windsor creates a standalone type which implements the interface and delegates to the real implementation by using composition). Unfortunately you cannot execute methods within the real implementation of the interface, because the proxy would be bypassed.</p>

<p>Is there a way to get the instance of the proxy which represents the real implementation within the real implementation?</p>

<p>Here is an example of what I would like to achieve. I want to intercept always the Get method. Please don't come with alternative ways to refactor this sample because this is not my production code but just something invented for demonstration.</p>

<pre><code>public interface IProvider
{
    bool IsEmpty { get; }
    object Get();
}

public class ProxyBypassingProvider : IProvider
{
    public bool IsEmpty
    {
        // Calls method directly, not through the proxy.
        get { return Get() == null; }
    }

    public object Get()
    {
        return new Object();
    }
}

public class InterceptedProvider : IProvider
{
    private IProvider _this; // Should hold the proxy instance.

    public bool IsEmpty
    {
        // Calls method through proxy.
        get { return _this.Get() == null; }
    }

    public object Get()
    {
        return new Object();
    }
}
</code></pre>

<p>How can I set the field _this to the instance of the proxy?</p>

<p>Best Regards<br />
Oliver Hanappi</p>

<p>PS: Here is a real world example.</p>

<pre><code>public interface IPresentationModel
{
    IView View { get; }
}

public interface IView
{
    void SetModel(IPresentationModel model);
}

public PresentationModel : IPresentationModel
{
    public IView View { get; private set; }

    public PresentationModel(IView view)
    {
        View = view;
        View.SetModel(this);
    }
}
</code></pre>

<p>I'm resolving a transient presentation model. It gets a transient view injected. Because the view needs to know about the presentation model, the presentation model calls IView.SetModel(this) to let the view know about its presentation model.<br />
The problem is now, that although the resolved IPresentationModel is a proxy, the SetModel method gets only the real implementation. Therefore, when the view calls methods on the presentation model, no interceptors are being fired.</p>

<p>The only solution I have found until now, is to set the view's presentation model manually after I have resolved my presentation model.</p>

<pre><code>var model = _container.Resolve&lt;IPresentationModel&gt;();
model.View.SetModel(model);
</code></pre>

<p>I think, this solution is not really solved very well.</p>
 Castle Windsor Interceptor for private/protected method <p>Is it true that in order for castle windsor's interceptor to intercept a method, that method needs to be declare public?</p>
 Should Castle DynamicProxy IInterceptor or ProxyGenerator be cached? <p>I'm using StructureMap to Enrich some of my objects with an instance call to</p>

<p><code>ProxyGenerator.CreateInterfaceProxyWithTarget(myObject, MYInterceptor)</code></p>

<p>Currently I have the <code>MYInterceptor</code> inside my container, should I implement any type of caching for the interceptor?</p>

<p>The second question should I register my <code>ProxyGenerator</code> inside my container and if so, should I apply any type of caching to it?</p>
 What really interceptors do with my c# class? <p>I was asked to implement castle dynamic proxy in my asp.net web application and i was going through couple of articles which i got from <a href="http://www.castleproject.org/" rel="nofollow">Castle Project</a> and <a href="http://www.codeproject.com/KB/cs/hamiltondynamicproxy.aspx" rel="nofollow">Code Project</a> about castle dynamic proxy in asp.net web application.... </p>

<p>Both articles delt with creating interceptors but i can't get the idea why interceptors are used with classes.... Why should i intercept my class which is behaving properly?</p>
 Is it possible to add a property to a type, via a DynamicProxy? <p>I'm using Castle DynamicProxy to create a proxy of a given type at runtime - including a couple mixins.</p>

<p>I'm trying to figure out if it's possible to also add arbitrary properties to the proxy, e.g.:</p>

<pre><code>class BaseType
{
  string Foo { get; set; }
}
</code></pre>

<p>and at runtime, I create a new type, that would look like this:</p>

<pre><code>class BaseTypeProxy3848484etc
{
  string Foo { get; set; }
  OtherType Bar { get; set; }
}
</code></pre>

<p>In theory, it seems like this <em>should</em> be possible-- maybe I'm just not seeing how to do it with Castle... Any thoughts? Thanks!</p>
 Add attributes to class & properties on the fly <p>Is there anything in castle that can let me add attributes to a class on the fly?</p>

<p>I have a dto in a project that I want to use as a data contract in a wcf service. I'd need to add a </p>

<pre><code>[DataContract]
</code></pre>

<p>attribute to the class and then </p>

<pre><code>[DataMember]
</code></pre>

<p>to each of the properties.</p>

<p>I could just replicate the class in the service layer and then copy the list to a new list of the new type but thats a ballache. There must be something in dynamicproxy or somewhere?</p>

<p>w://</p>
 How can multiple interfaces with multiple classes be merged using DynamicProxy? <p>Suppose we have an interface ICat that is derived from ICatBase and ICatExtension as shown below. For both distinct interfaces, an implementation is available, CatBase and CatExtension. How can Castle's DynamicProxy be used to merge these into an instance of ICat?</p>

<p>Is it possible to create a proxy in which ICatExtension is implemented by CatExtension and ICatBase is 'implemented' by an interceptor? How can this be achieved?</p>

<pre><code>public interface ICatBase
{
   string Name { get; set; }
   int Age { get; set; }
}

public interface ICatExtension
{
   string Description { get; }
}

public interface ICat : ICatBase, ICatExtension
{
}

public class CatBase : ICatBase
{
   public string Name { get; set; }
   public int Age { get; set; }
}

public class CatExtension : ICatExtension
{
   public string Description
   {
      get { return "Furry"; }
   }
}
</code></pre>

<p><strong>EDIT</strong></p>

<p>I have been trying to use mixins to make this work, but the code below results in a NotImplementedException. </p>

<pre><code>var generator = new ProxyGenerator();
var options = new ProxyGenerationOptions();
options.AddMixinInstance(new CatBase());
options.AddMixinInstance(new CatExtension());
var cat  = generator.CreateInterfaceProxyWithoutTarget&lt;ICat&gt;(options);        
cat.Name = "Joey";
</code></pre>

<p>This is a DynamicProxy2 error: There are no interceptors specified for method 'Void set_Name(System.String)' which has no target. When calling method without target there is no implementation to 'proceed' to and it is the responsibility of the interceptor to mimic the implementation (set return value, out arguments etc)</p>

<p>I could create a custom interceptor that intercepts calls and dispatches to the correct interface, but I feel there must be an easier/better way. Am I correct?</p>

<p><strong>EDIT #2</strong></p>

<p>Thank you, Krzysztof! Using the lines below was the solution.</p>

<pre><code>var generator = new ProxyGenerator();
var options = new ProxyGenerationOptions();
options.AddMixinInstance(new CatBase());
options.AddMixinInstance(new CatExtension());

var cat = (ICat)generator.CreateClassProxyWithTarget(typeof(object), new[] { typeof(ICat)}, new object(), options);
</code></pre>

<p><strong>EDIT #3</strong></p>

<p>As a final step, I have configured a Windsor container to create the proxy from this example. The only way I was able to do this, was by specifying a name "Cat" and resolving an instance of System.Object by specifying the name and casting to the <code>ICat</code> interface afterwards.</p>

<pre><code>WindsorContainer container = new WindsorContainer();
container.Register(
    Castle.MicroKernel.Registration.Component.For&lt;object&gt;().
        Named("Cat").
        Proxy.AdditionalInterfaces(typeof (ICat)).
        Proxy.MixIns(new CatBase()).
        Proxy.MixIns(new CatExtension())
    );

var cat = (ICat)container.Resolve(typeof(object), "Cat");
</code></pre>

<p>Is there a more elegant way to this in which I can just ask the container for an ICat instance, without referring to a particular name?</p>
 Autofac: Tips for increasing performance when using DynamicProxy? <p>I just start using DynamicProxy2 today. And found it caused significant performance drop.</p>

<p>See the code below. Test1 is 10 times slower than Test2.</p>

<p>Any tips for increasing performance when using DynamicProxy?</p>

<pre><code>class Program
{
    public void Main()
    {
        for (int i = 0; i &lt; 3; i++)
        {
            var stopWatch = Stopwatch.StartNew();
            int count = 1 * 1000 * 1000;

            Test1(count);
            //Test2(count);

            long t = stopWatch.ElapsedMilliseconds;
            Console.WriteLine(t.ToString() + " milliseconds");
            Console.WriteLine(((double)count/(t/1000)).ToString() + " records/1 seconds");
        }
    }

    void Test1(int count)
    {
        var builder = new ContainerBuilder();
        builder.RegisterType&lt;TestViewModel&gt;()
            .EnableClassInterceptors()
            .InterceptedBy(typeof(NotifyPropertyChangedInterceptor));
        builder.RegisterType&lt;NotifyPropertyChangedInterceptor&gt;();

        var container = builder.Build();
        for (int i = 0; i &lt; count; i++)
        {
            container.Resolve&lt;TestViewModel&gt;();
        }
    }

    void Test2(int count)
    {
        var builder = new ContainerBuilder();
        builder.RegisterType&lt;TestViewModel&gt;();

        var container = builder.Build();
        for (int i = 0; i &lt; count; i++)
        {
            container.Resolve&lt;TestViewModel&gt;();
        }
    }
}

public class TestViewModel : INotifyPropertyChanged
{
    [Notify]
    public virtual string Value { get; set; }
    public event PropertyChangedEventHandler PropertyChanged;
}

/// &lt;summary&gt;
/// Copied from: http://serialseb.blogspot.com/2008/05/implementing-inotifypropertychanged.html
/// &lt;/summary&gt;
public class NotifyPropertyChangedInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        // let the original call go through first, so we can notify *after*
        invocation.Proceed();
        if (invocation.Method.Name.StartsWith("set_"))
        {
            string propertyName = invocation.Method.Name.Substring(4);
            var pi = invocation.TargetType.GetProperty(propertyName);

            // check that we have the attribute defined
            if (Attribute.GetCustomAttribute(pi, typeof(NotifyAttribute)) == null)
                return;

            // get the field storing the delegate list that are stored by the event.
            FieldInfo info = invocation.TargetType.GetFields(BindingFlags.Instance | BindingFlags.NonPublic)
                .Where(f =&gt; f.FieldType == typeof(PropertyChangedEventHandler))
                .FirstOrDefault();

            if (info != null)
            {
                // get the value of the field
                PropertyChangedEventHandler evHandler = info.GetValue(invocation.InvocationTarget) as PropertyChangedEventHandler;
                // invoke the delegate if it's not null (aka empty)
                if (evHandler != null)
                    evHandler.Invoke(invocation.TargetType, new PropertyChangedEventArgs(propertyName));
            }
        }
    }
}
</code></pre>

<p><strong>Update:</strong></p>

<p>On my machine, Test1 takes about 45 seconds, Test2 takes about 4.5 seconds. After read <a href="http://stackoverflow.com/users/13163/krzysztof-kozmic">Krzysztof Koźmic</a>'s answer, I tried to put <em>NotifyPropertyChangedInterceptor</em> into singleton scope:</p>

<pre><code>builder.RegisterType&lt;NotifyPropertyChangedInterceptor&gt;().SingleInstance();
</code></pre>

<p>that saved me about 4 seconds. Now Test1 takes about 41 seconds.</p>

<p><strong>Update 2:</strong></p>

<p>Test3 takes about 8.3 seconds on my machine. So it seems using Autofac or DynamicProxy alone performance is not a very big problem (in my project), but combining them together would cause great performance drop.</p>

<pre><code>    public void Test3(int count)
    {
        var generator = new Castle.DynamicProxy.ProxyGenerator();
        for (int i = 0; i &lt; count; i++)
        {
            generator.CreateClassProxy(typeof(TestViewModel), 
                new NotifyPropertyChangedInterceptor());
        }
    }
</code></pre>
 Ninject: Possible to use injection constructor when type is being proxied for AoP? <p>I'm doing a project ground up using Ninject 2 and one question bugs me:</p>

<p>If you are to intercept methods on your type, you need to wrap it into proxy (castle dynamic proxy to be specific). Unless said type has a parameterless constructor, proxy creation fails. If it has, this constructor is being used when type instance is being resolved from the kernel.</p>

<p>Unfortunately, this means that my injection constructor with parameters is being neglected and I have to resort to property injection. I have some reluctance to couple my domain types with [Inject] attribute on properties.</p>

<p>Is there any way to use injection constructor with proxies for AoP using Ninject?</p>
 Is it possible to create dynamic proxies without having base class or interface? <p>Is it possible to create a dynamic proxy using common libraries like <code>Castle Dynamic Proxy</code> without having any base class or interface? I'm indeed interested to have dynamic on-the-fly classes in run-time.</p>
 Moq + Castle Dynamic Proxy - exception mocking nested generic interfaces <p>I'm receiving an argument exception from Castle Dynamic Proxy, while using Moq to create a mock of object that is implementing a nested generic interface with generic method that has an interface constraint.</p>

<p>The exception is: System.ArgumentException : Cannot set parent to an interface.</p>

<p>Happens while accessing Object property of the mock directly after the mock creation. (Call stack is at the bottom for the sake of readability)</p>

<p>The code is simple and self-describing:</p>

<pre><code>    public interface A&lt;T&gt;
    {
        void Method&lt;Z&gt;() where Z : T; 
    }

    public interface B
    {
    }

    [Test]
    public void MockNestedGenericInterfaceTest()
    {
        Mock&lt;A&lt;B&gt;&gt; mock = new Mock&lt;A&lt;B&gt;&gt;();
        var o = mock.Object; //argument exception here
    }
</code></pre>

<p>Test does not generate an exception if where Z : T clause is removed.</p>

<p>I did some research and found a ticket <a href="http://code.google.com/p/moq/issues/detail?id=259" rel="nofollow" title="here">here</a>. I'm using latest versions of Moq and Castle.</p>

<p>Is there a workaround for this problem? The only way I see it working is a manual mock implementation. Rhino mocks did not work for me either.</p>

<p>Thank you.</p>

<p>Call stack:</p>

<pre><code>at System.Reflection.Emit.TypeBuilder.SetParent(Type parent)
</code></pre>

<p>at Castle.DynamicProxy.Generators.Emitters.GenericUtil.CopyGenericArguments(MethodInfo methodToCopyGenericsFrom, Dictionary<code>2 name2GenericType, ApplyGenArgs genericParameterGenerator)
at Castle.DynamicProxy.Generators.Emitters.AbstractTypeEmitter.CopyGenericParametersFromMethod(MethodInfo methodToCopyGenericsFrom)
at Castle.DynamicProxy.Generators.InvocationTypeGenerator.Generate(ClassEmitter class, ProxyGenerationOptions options, INamingScope namingScope)
at Castle.DynamicProxy.Contributors.InterfaceProxyWithoutTargetContributor.GetInvocationType(MetaMethod method, ClassEmitter emitter, ProxyGenerationOptions options)
at Castle.DynamicProxy.Contributors.InterfaceProxyWithoutTargetContributor.GetMethodGenerator(MetaMethod method, ClassEmitter class, ProxyGenerationOptions options, OverrideMethodDelegate overrideMethod)
at Castle.DynamicProxy.Contributors.CompositeTypeContributor.ImplementMethod(MetaMethod method, ClassEmitter class, ProxyGenerationOptions options, OverrideMethodDelegate overrideMethod)
at Castle.DynamicProxy.Contributors.CompositeTypeContributor.Generate(ClassEmitter class, ProxyGenerationOptions options)
at Castle.DynamicProxy.Generators.InterfaceProxyWithoutTargetGenerator.GenerateType(String typeName, Type proxyTargetType, Type[] interfaces, INamingScope namingScope)
at Castle.DynamicProxy.Generators.InterfaceProxyWithTargetGenerator.GenerateCode(Type proxyTargetType, Type[] interfaces, ProxyGenerationOptions options)
at Castle.DynamicProxy.ProxyGenerator.CreateInterfaceProxyWithoutTarget(Type interfaceToProxy, Type[] additionalInterfacesToProxy, ProxyGenerationOptions options, IInterceptor[] interceptors)
at Moq.Proxy.CastleProxyFactory.CreateProxy(ICallInterceptor interceptor, Type[] interfaces, Object[] arguments)
at Moq.Mock</code>1.b__0()
at Moq.Mock<code>1.InitializeInstance()
at Moq.Mock</code>1.OnGetObject()
at Moq.Mock`1.get_Object() </p>
 CastleDynamic proxy: NullReferenceException when calling method of a proxy <p>I'm using <em>StructureMap</em> to have an instance of an interface and I wrap it into a proxy with <em>Castle DynamicProxy</em>:</p>

<pre><code>var proxy = generator.CreateInterfaceProxyWithTarget&lt;T&gt;(
    ObjectFactory.GetInstance&lt;T&gt;()
    , new SwitchInterceptor(isGranted, foundUser));
</code></pre>

<p>In the interceptor of type <code>IInterceptor</code>, I've got this code:</p>

<pre><code>public override void Intercept(IInvocation invocation)
{
    if (this.CanExecute)
    {
        invocation.Proceed();
    }
}
</code></pre>

<p>When CanExecute is <code>true</code>, it always work but <strong>sometimes</strong> when CanExecute is <code>false</code>, I've got a weird <code>NullReferenceException</code> with a realy small stacktrace:</p>

<pre><code>at Castle.Proxies.IGrantedReadProxy.ExecuteSomething()
</code></pre>

<p>I'm really lost and I don't know where to look. Do you have any idea about what the problem is?</p>
 Dynamic Proxying IEnumerable<T> <p>I'm trying to create a dynamic proxy to a list of objects of a specific class.
For example:</p>

<pre><code>var proxy = generator.CreateInterfaceProxyWithoutTarget(typeof (IEnumerable&lt;string&gt;),
                                                        interceptor);
</code></pre>

<p>But I get the following exception:</p>

<blockquote>
  <p>Cannot resolve method System.Collections.Generic.IEnumerator`1[System.__Canon] GetEnumerator() because the declaring type of the method handle System.Collections.Generic.IEnumerable`1[T] is generic. Explicitly provide the declaring type to GetMethodFromHandle. </p>
</blockquote>

<p>I'm trying to proxy an IEnumerable&lt;> in order to cache calls to generate the list itself.</p>
 NuGet: NHibernate, Castle.Core 3.0 and where is ProxyFactoryFactory? <p>I installed with NuGet the packages NHibernate and Castle.Core 3.0 for a new project. Usually we copied around the dlls manually; it is the first time I do that with NuGet.</p>

<p>Now I can't find out how to configure the ProxyFactoryFactory, or let's say, I can't find it. I referenced NHibernate and Castle.Core (the only dll I could find in the Castle.Core - package) within the project, and configured the following:</p>

<pre><code>&lt;property name="proxyfactory.factory_class"&gt;
    NHibernate.ByteCode.Castle.ProxyFactoryFactory, 
    NHibernate.ByteCode.Castle
&lt;/property&gt;
</code></pre>

<p>This leads to:</p>

<blockquote>
<pre><code>Class Initialization method Tests.UnitTest1.MyClassInitialize threw exception.
NHibernate.Bytecode.UnableToLoadProxyFactoryFactoryException:
NHibernate.Bytecode.UnableToLoadProxyFactoryFactoryException: Unable
to load type 'NHibernate.ByteCode.Castle.ProxyFactoryFactory,
NHibernate.ByteCode.Castle' during configuration of proxy factory class.
</code></pre>
</blockquote>

<p>Obviously this dll is missing, but where can I find that? There is a package in NuGet called <code>Castle.DynamicProxy</code>, but it is marked as obsolete.</p>

<p>p.s.: In the description of the Castle.Core 3.0 - package, it is said: ... including DynamicProxy ...</p>
 Turn off signing for Castle DynamicProxy <p>I am having problems when trying to use a TypedFactoryFacility in Castle.</p>

<p>I'm using Castle v3.0.0 and I've created a ViewFactory, using </p>

<pre><code>injector.AddFacility(Of TypedFactoryFacility)()
</code></pre>

<p>and:</p>

<pre><code>container.Register(CMR.Component.For(Of IDialogViewFactory)().AsFactory())
</code></pre>

<p>This code all works fine on my machine, but when deploying it to users on VMs (who don't have local admin rights), they get the following error:</p>

<pre><code>Unable to obtain public key for StrongNameKeyPair.
</code></pre>

<p>There's various threads around, but nothing that seems to solve my issue - how can I use DynamicProxy on machines who don't / can't have access to C:\Documents and Settings\All Users\Application Data\Microsoft\Crypto\</p>

<p>In the <a href="https://gist.github.com/2049289" rel="nofollow">stack trace of the error</a> is the line</p>

<pre><code>Castle.DynamicProxy.ModuleScope.CreateModule(signStrongName As Boolean)
</code></pre>

<p>Which seems to suggest strong naming can be turned off somehow but I can't figure out how?</p>
 Calls to properties inside non-intercepted methods are not forwarded to target object <p>I have a change tracking framework that tracks changed made to domain objects on the client. It uses Castle.Windsor as the tool for creating proxy objects. After I changed Castle to version 3.0 calls of properties inside methods that are not intercepted are not forwarded to the target object anymore.</p>

<p><img src="http://www.pictureupload.de/originals/pictures/200312135214_ct.png" alt="sequence diagram"></p>

<p>ChangeTracker is a class of my own that handles the tracking of the changed made to the inner object.</p>

<p>A custom ProxyGenerationHook is used, which worked correctly with Castle 2.5:</p>

<pre><code>private sealed class ProxyGenerationHook : IProxyGenerationHook
{
    public void MethodsInspected()
    { }

    public void NonProxyableMemberNotification(Type type, MemberInfo memberInfo)
    { }

    public bool ShouldInterceptMethod(Type type, MethodInfo methodInfo)
    {
       if (methodInfo == null)
       {
          throw ExceptionBuilder.ArgumentNull("methodInfo");
       }

       string methodName = methodInfo.Name;
       bool result = methodName.StartsWith("set_", StringComparison.OrdinalIgnoreCase) ||
                     methodName.StartsWith("get_", StringComparison.OrdinalIgnoreCase);

       return result;
    }
 }
</code></pre>

<p>This is the domain class used:</p>

<pre><code>public class Person
{
  public virtual int Id { set; get; }
  public virtual string Name { set; get; }

  protected virtual int Age { set; get; }

  public void SetAgeTo(int value)
  {
     Age = value;
  }
}
</code></pre>

<p>Is this now the intended behaviour or is this a bug of Castle 3.0?</p>
 Dynamic cast to generic type <p>Just a quickie before the weekend rolls in...</p>

<p>I have a Method with the following signature, that I need to invoke:</p>

<pre><code>public interface IObjectProvider&lt;T&gt;
{
    T Get(Predicate&lt;T&gt; condition);
}
</code></pre>

<p>This will provide me with a <code>T</code> from whatever kind of source, that meets the predicate criteria.</p>

<p>Now, this has to be called from a context where all I have is the following:</p>

<pre><code>//the actual predicate that's going to be evaluated
var predicate = predicateProperty.GetValue(invocation.InvocationTarget, null);

//The type that should go into the call as type param
Type relationTargetType = relationDefinition.RelatedType;
</code></pre>

<p>As you might guess, the compiler won't let me use the <code>predicate</code> variable as parameter. What I need to do is convert this object into a Predicate, but Generic type params must be compile-time-constant, so this won't work.</p>

<p>I've started messing around with this, but no success so far:</p>

<pre><code>Type genericPredicateType = typeof(Predicate&lt;&gt;);
Type specificPredicateType= genericPredicateType.MakeGenericType(relationTargetType);
Convert.ChangeType(predicate, specificPredicateType)
</code></pre>

<p>How on earth can I mash this up?</p>

<p><strong>EDIT:</strong> I thought this was a rather use-case-agnostic question, but obviously I was wrong. So, since there is such a fuss as to what I do, what I have and why and whatnot, here's a lot more background info. I am trying to resolve relations between objects in a Proxy (Castle Dynamic Proxy). The following Snippet should explain the kind of relation I want to depict:</p>

<pre><code>public class Order
{
    public virtual int Id { get; set; } // OR-Mapped
    public virtual DateTime OrderDate { get; set; } // OR-Mapped

    [RelatedObject(typeof(Address), "DeliveryAddressPredicate")]
    public virtual Address DeliveryAddress { get; set; }

    public Predicate&lt;Address&gt; DeliveryAddressPredicate
    {
        get { return new Predicate&lt;Address&gt;(a =&gt; OrderDate &gt;= a.ValidFrom &amp;&amp; OrderDate &lt;= a.ValidTo); }
    }
}

public class Address
{
    public virtual DateTime ValidFrom { get; set; } // OR-Mapped
    public virtual DateTime ValidTo { get; set; } // OR-Mapped

    //Not OR-Mapped
    [RelatedList(typeof(Order), "OrdersPredicate")]
    public virtual IList&lt;Order&gt; Orders { get; set; }

    public Predicate&lt;Order&gt; OrdersPredicate
    {
        get { return new Predicate&lt;Order&gt;(o =&gt; o.OrderDate &gt;= ValidFrom &amp;&amp; o.OrderDate &lt;= ValidTo); }
    }
</code></pre>

<p>To sum it up, this is supposed to become a Fuzzy OR-Mapping, meant to extend NHibernate in a project or two.</p>

<p>How did I mean to get this to work? The address is proxied, and when a call to a property with one of my CustomAttributes is made, i use DynamicProxy's IInterceptor interface to resolve the relation. The main problem is that this resolving has to happen in the IInterceptor.Intercept() Method which has only one Param (<a href="http://www.codeproject.com/Articles/9055/Castle-s-DynamicProxy-for-NET" rel="nofollow">see here</a>), and I have no generic type param available. So, in the end it all boils down to a simple .Net question again: I have a <code>Type</code> stored in a variable and a <code>Method</code> that has to be called with a parameter generic of the aforesaid type...</p>

<p>Sorry for any mistakes made (like calling <code>var</code> a <code>Type</code> - man that was a rough one), it's been quite a day ;-)</p>
 How can we reduce the property proxying overhead of NHibernate? <p>We are using Fluent NHibernate 1.3.0.727 and NHibernate 3.3.0.4000 to map our properties to columns in the database. Here is an abbreviated sample of one of our ClassMaps:</p>

<pre><code>    public class TankMap : ClassMap&lt;Tank&gt;
    {
        public TankMap()
        {
            Id(o =&gt; o.Id);
            Map(o =&gt; o.TankSystem);
        }
    }
</code></pre>

<p>In this case the TankSystem property is a <strong>string</strong>.</p>

<p>In parts of our application there is a lot of calculations that involve accessing the mapped properties (such as TankSystem) numerous times. When we profile the application, simply accessing these properties takes a up a considerable amount of time because each time they are accessed, it has to go through the NHibernate.Proxy.DefaultLazyInitializer.Intercept method.</p>

<p>We need to make our calculations as fast as possible and would like to avoid this proxying overhead. One approach is to copy the properties that we want (eg. TankSystem) into arrays and use the arrays any time we want to access this information, but then this is not a very object-oriented approach.</p>

<p><strong>Update:</strong></p>

<p>We have tried mapping our properties using Not.LazyLoad, for example:</p>

<pre><code>Map(o =&gt; o.TankSystem).Not.LazyLoad();
</code></pre>

<p>However, this does not seem to have any effect on whether this property is actually proxied.</p>

<p>Is there any kind of option to avoid/reduce this proxying overhead?</p>
 How to avoid double construction of proxy with DynamicProxy::CreateClassProxyWithTarget? <p>I am decorating an existing object using the <code>CreateClassProxyWithTarget</code> method. However, the constructor and therefore, initialization code, is being called twice. I already have a "constructed" instance (the target). I understand why this happens, but is there a way to avoid it, other than using an empty constructor?</p>

<p>Edit: Here is some code:</p>

<p>First the proxy creation:</p>

<pre><code>public static T Create&lt;T&gt;(T i_pEntity) where T : class
{
  object pResult = m_pGenerator.CreateClassProxyWithTarget(typeof(T),
                                                           new[] 
                                                             { 
                                                                typeof(IEditableObject),
                                                                typeof(INotifyPropertyChanged) ,
                                                                typeof(IMarkerInterface),
                                                                typeof(IDataErrorInfo)
                                                             },                                                               
                                                           i_pEntity,
                                                           ProxyGenerationOptions.Default,
                                                           new BindingEntityInterceptor&lt;T&gt;(i_pEntity));
  return (T)pResult;
}
</code></pre>

<p>I use this for example with an object of the following class:</p>

<pre><code>public class KatalogBase : AuditableBaseEntity
{
   public KatalogBase()
   {
     Values     = new HashedSet&lt;Values&gt;();
     Attributes = new HashedSet&lt;Attributes&gt;();
   }
   ...
}
</code></pre>

<p>If i now call <code>BindingFactory.Create(someKatalogBaseObject);</code> the <code>Values</code> and <code>Attributes</code>
properties are beeing initialized again.</p>
 Castle.Windsor: Changes for factories and interceptors in 3.1? <p>The following code passes as-is with Castle.Windsor 2.5.3 but fails after upgrading to 3.1.0</p>

<p>The exception is an InvalidProxyConstructorArgumentsException and it states "Can not instantiate proxy of class: Test. Could not find a parameterless constructor."</p>

<pre><code>    static void Main(string[] args)
    {
        var container = new WindsorContainer();
        container.Register(Component.For&lt;Interceptor&gt;(),
                           Component.For&lt;Test&gt;().UsingFactoryMethod(() =&gt; new Test(""))
                                                .Interceptors&lt;Interceptor&gt;());

        var test = container.Resolve&lt;Test&gt;(); //THROWS IN 3.1.0
    }
}

public class Test
{
    public readonly string S;

    public Test(string s)
    {
        S = s;
    }
}

public class Interceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        invocation.Proceed();
    }
}
</code></pre>

<p>In my real code Test is a MongoDatabase that is being constructed using a factory method and injected into a Repository.  </p>

<p>In my real code I'm also using an inheritor to an AbstractFacility to register the interceptor. This way I don't have to register the interceptor for each component. Both forms of interceptor usage seem to work/fail (in 2.5.3/3.1.0) the same way on later resolution.  For reference here is a shortened version of the facility:</p>

<pre><code>public class Facility : AbstractFacility
{
    protected override void Init() { Kernel.ComponentRegistered += KernelComponentRegistered; }

    static void KernelComponentRegistered(string key, IHandler handler)
    {
        if (typeof(IInterceptor).IsAssignableFrom(handler.ComponentModel.Implementation)) return;
        handler.ComponentModel.Interceptors.AddIfNotInCollection(InterceptorReference.ForKey("SomeInterceptor"));
    }
}
</code></pre>

<p>I looked at the Castle.Windsor source code and the throwing code is expecting to wrap a proxy around the class it is given which is why it's looking for a parameterless constructor.  However in 2.5.3 I think the proxy generation code never got executed and the container resolves (correctly in my mind) to a non-proxy version of Test/MongoDatabase</p>

<p>So two questions I guess:
1) What's changed?
2) How do I keep my interceptor registration without generating a proxy for the object resolved by the factory method?  Or I guess how does a proxy get generated using a factory method for the component...</p>
 How to write interceptor for methods returning IEnumerable 

<p>I wrote simple interceptor (with Castle.DynamicProxy) to handle database connection life cycle. I.e. all services have Connection property which opens new one on first use. Connection is being closed automatically after each method call:</p>

<pre class="lang-cs prettyprint-override"><code>class CloseConnectionInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        try
        {
            invocation.Proceed();
        }
        finally
        {
            var hasConnection = invocation.InvocationTarget as IHasConnection;
            if (hasConnection.IsConnectionOpen)
            {
                hasConnection.Connection.Dispose();
                hasConnection.Connection = null;
            }
        }
    }
}

interface IHasConnection
{
    bool IsConnectionOpen { get; }
    Connection Connection { get; set; }
}
</code></pre>

<p>It works well except for methods returning iterator:</p>

<pre class="lang-cs prettyprint-override"><code>[Test]
public void ConnectionClosedByProxy()
{
    // arrange
    var service = new MyService();
    var proxy = new ProxyGenerator()
        .CreateInterfaceProxyWithTarget&lt;IMyService&gt;(
            service, new CloseConnectionInterceptor());

    // act
    proxy.GetList();

    // assert: works!!!
    Assert.IsFalse(service.IsConnectionOpen);
}

[Test]
public void IteratorLeavesOpenConnection()
{
    // arrange
    var service = new MyService();
    var proxy = new ProxyGenerator()
        .CreateInterfaceProxyWithTarget&lt;IMyService&gt;(
            service, new CloseConnectionInterceptor());

    // act
    proxy.GetEnumerable().ToList();

    // assert: bad, bad, bad!
    Assert.IsTrue(service.IsConnectionOpen);
}
</code></pre>

<p>See full example here: <a href="https://gist.github.com/4087483" rel="nofollow">https://gist.github.com/4087483</a></p>

<p>If there is "using (new Connection())" statement inside my GetEnumerable method then it works as expected - connection is being closed after last access to iterator. Is it possible to catch this moment in interceptor? Or should I proxy not only method but also resulting IEnumerable?</p>
 Castle DynamicProxy2: Get the Target inside an Interceptor? <p>I'm using Castle DynamicProxy2 to "tack on" interfaces to retrieve fields from a dictionary.  For example, given the following class:</p>

<pre><code>public class DataContainer : IDataContainer
{
    private Dictionary&lt;string, object&gt; _Fields = null;

    public Dictionary&lt;string, object&gt; Data
    {
        get { return _Fields ?? (_Fields = new Dictionary&lt;string, object&gt;()); }
    }
}
</code></pre>

<p>I want to use the following interface as an interface proxy to extract the "Name" value out of the Fields dictionary:</p>

<pre><code>public interface IContrivedExample
{
    string Name { get; }
}
</code></pre>

<p>From an interceptor, I want to get the "target" DataContainer, and return the "Name" value:</p>

<pre><code>public void Intercept(IInvocation invocation)
{
    object fieldName = omitted; // get field name based on invocation information

    DataContainer container = ???; // this is what I'm trying to figure out
    invocation.ReturnValue = container.Fields[fieldName];
}

// Somewhere in code
var c = new DataContainer();
c.Fields.Add("Name", "Jordan");

var pg = new ProxyGenerator();
IContrivedExample ice = (IContrivedExample) pg.CreateInterfaceProxyWithTarget(..., c, ...);
Debug.Assert(ice.Name == "Jordan");
</code></pre>

<p>Any thoughts on how to get the underlying target</p>

<p>Note: this is a contrived example I'm using to establish some context around the question I have.</p>
 Castle.DynamicProxy2 and Adding a Property at Run Time <p>I am using Castle.DynamicProxy2 and I am instantiating my proxy as such:</p>

<pre><code>private static T GenerateProxy()
{   
    ArrayList addtlInterfaces = new ArrayList();

    addtlInterfaces.Add(typeof (INotifyPropertyChanged));
    addtlInterfaces.Add(typeof (EntityStatus));

    object entityProxy = ProxyGenerator.CreateClassProxy(typeof(T), 
                                                          addtlInterfaces.ToArray(typeof(Type)) as Type[],
                                                          ProxyGenerationOptions.Default,
                                                          new IInterceptor[] { new LazyInterceptor() });


    return (T)entityProxy;
}
</code></pre>

<p>My interface of IEntityStatus looks like such:</p>

<pre><code>public interface  IEntityStatus
{
    bool IsDirty
    { get; set;}
}
</code></pre>

<p>I need to be able to use that property during run time so that when my DTO has a property changed event the event could set the DTO to dirty.  However because it is an interface and has no explicit implementation I am at a loss as to how to do this.  Creating a delegate for the get and set method is an option I would like to avoid.  So is there another way to achieve what I am looking to achieve?</p>

<p>I realize I could set up a collection of all my active DTOs and when the property changed event fires on one of the DTOs I could update that collection to show that this particular DTO is dirty, but I would really like for this information to be a part of the proxied DTO for pure syntactic ease.</p>

<p>Look forward to responses!</p>
 Castle.DynamicProxy2 generate proxy of delegate type <p>Is there a way to create a proxy of a delegate type and have it implement additional interfaces in DynamicProxy2 and also being able to intercept calls to the generated delegate?</p>

<p>The way i normaly generate proxies throws an exception because delegate types are sealed.</p>
 castle dynamic proxy creation <p>I am implementing a design where my layer would sit between client and server, and whatever objects i get from server, i would wrap it in a transparent proxy and give to the client, that way i can keep a track of what changed in the object, so when saving it back, i would only send changed information.</p>

<p>I looked at castle dynamic proxy, linfu, although they can generate a proxy type, but they cant take existing objects and wrap them instead.</p>

<p>Wondering if its possible to do with these frameworks, or if there any other frameworks that enable this...</p>
 can you use castle dynamic proxies on web services references? <p>Is it possible to create a dynamic proxy on the a web service reference that has been added to a visual studio project?</p>

<p>I've added the web service reference in the normal way and tried to create a dynamic proxy using castle to wrap the method invocation in a try/catch to translate any SoapExceptions, but on running it I'm getting a lot of errors around non serializable classes?</p>

<p>has anyone done anything like this?</p>

<p>thanks</p>
 help building castle dynamic proxy <p>So I pulled the source from <a href="https://svn.castleproject.org/svn/castle/DynamicProxy/trunk/" rel="nofollow">https://svn.castleproject.org/svn/castle/DynamicProxy/trunk/</a></p>

<p>Open it up in vs.net 2008</p>

<p>problems:</p>

<ol>
<li>vs.net can't open the assembly.cs</li>
<li>assembly signing failed</li>
</ol>

<p>What am I doing, rather NOT doing?</p>

<p><b>Update</b></p>

<p>So I downloaded nant, setup the .bat file in my PATH so it works in cmd prompt.</p>

<p>I ran:</p>

<p>nant default.build</p>

<p>Getting this error:</p>

<p>build failed,  \buildscripts\common-project.xml (48,3)
invalid element . Unknown task or datatype.</p>

<p>How exactly do I build the dynamicProxy project now?</p>

<p><b>update</b>
This is what I did, see screenshot:</p>

<p>oh and my nant is:</p>

<p>@echo off
"E:\dev\tools\nant-bin\nant-0.86-nightly-2009-05-05\bin\Nant.exe" %*</p>

<p><img src="http://img697.imageshack.us/img697/5623/castlebuildscreenshot.png" alt="http://img697.imageshack.us/img697/5623/castlebuildscreenshot.png"></p>
 Wrapping existing objects to intercept method/property calls in .NET <p>I have a situation where I would like to intercept calls to properties in .NET. I have been looking at DynamicProxy in Castle and it seems to work fine.  But it seems in order to use it I have to start with a new object, meaning I can't do something like this:</p>

<pre><code>MyType myType = new MyType();
myType.Property = "Test";

...

MyType wrappedMyType = proxyBuilder.Wrap(myType, new MyInterceptor());
wrappedMyType.Property = "Test2";
</code></pre>

<p>Am I just missing something?</p>

<p>EDIT:</p>

<p>Oh god, it should of course be wrappedMyType. Big mistake. Sorry. :(</p>
 DynamicProxy2 and Proxy Chaining <p>I have the need to proxy the property types of a proxy. So the case would be:</p>

<p>I have interface IMyInterface:</p>

<pre><code>public interface IMyInterface
{
    public String Name {get; set;}
    public Int Id {get;set;}
}
</code></pre>

<p>I can mock the interface just fine but I want to be able to mock, for instance, the Name property. I realize that String cannot be mocked because it is sealed. The functionality that I would like to see would be:</p>

<pre><code>IMyInterfaceMock.Name.Equals() 
</code></pre>

<p>should be handled by an Interceptor. I can't envision that this is even possible with the existing framework because I would be changing the type of the property but I was wondering if there was a clever way to achieve this. Is there any way I could interject into the proxy generation and modify the proxy's property's return type? </p>

<p>I don't think it's possible with DynamicProxy2 as it stands but I was wondering if anyone knew some magic. </p>
 Create an InterfaceProxyWithoutTarget with a default constructor <p>Using Castle.DynamicProxy, I "simply" would like to get an Interface-Proxy-Without-Target, but... With a default-constructor so I be able to reuse the proxy-type.</p>

<p><strong>UPDATE</strong></p>

<p>I mean doing something like...</p>

<pre><code>var proxy = generator.CreateInterfaceProxyWithoutTarget(typeof(TInterface) ...);
var proxyType = proxy.GetType();
var newproxy = Activator.CreateInstance(proxyType);
</code></pre>

<p>...Except that generated type do not implement default-constructor.</p>

<p>My actual context is related to WCF customization, but that's another story.</p>
 
interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors interceptors Filters vs Interceptors in Struts 2 <p>What's the difference, really, between filters and interceptors?  I realize that interceptors fire before and after an action, recursively, and filters can be configured to fire on actions and on certain url patterns.  But how do you know when to use each one?</p>

<p>In the book I'm reading on Struts 2, it seems that interceptors are being pushed and I even followed a tutorial to write an Authentication Interceptor to make sure a user is logged in.  However, if the user tries to access a URL that doesn't have an action associated with it, the interceptor doesn't catch it, which means I'd have to associate an action with every jsp that I want to be secure.  That doesn't seem right.</p>

<p>I can make an Authentication Filter that handles URLs so that I don't have to do that, but then, what's the point of interceptors?</p>
 Using EJB interceptors after a method call <p>I know one can use interceptors before a method call by using the @AroundInvoke annotation.</p>

<p>What I would like to do is execute certain code after the method call, so that I can for example create a log entry before and after a method execution.</p>

<p>Is this possible with EJB3, or do I need to use AOP?</p>
 setting no cache for different parts of spring mvc 3 using WebContentInterceptor? <p>Hi there I have developed a dynamic web application that uses Ajax to fetch data from databases and keep the GUI up to date but while testing it with IE8 I am experiencing caching issues.</p>

<p>I used the following code in my webmvc-config.xml file to stop the browser from caching:</p>

<p><code>&lt;mvc:annotation-driven /&gt;
    &lt;mvc:interceptors&gt;
        &lt;bean id="webContentInterceptor" 
          class="org.springframework.web.servlet.mvc.WebContentInterceptor"&gt;
        &lt;property name="cacheSeconds" value="0"/&gt;
        &lt;property name="useExpiresHeader" value="true"/&gt;
        &lt;property name="useCacheControlHeader" value="true"/&gt;
        &lt;property name="useCacheControlNoStore" value="true"/&gt;
    &lt;/bean&gt;
    &lt;/mvc:interceptors&gt;</code></p>

<p>and it works exactly as it should, but the problem is that now the browser obviously doesn't cache anything.  what I want to know is how to modify that xml code so that it applies to the Ajax parts of the web app (which are controlled using 5 Controller files); so that the icons..etc are still cached? The path to these controller files would be something like "/admin/**"</p>

<p>I know that the Spring WebContentInterceptor has properties such as "setCacheMappings" and "setPathMatcher" but there is nowhere online that I can find examples of these being using in the xml config file.</p>

<p>ANY help would be much appreciated, it's really doing my head in.. Thanks. Jake</p>
 Why does audit logging using Hibernate Interceptor hang at SocketInputStream.socketRead0? <p>This is baffling to me.  I have searched numerous forums for clues.  In the postFlush method, I open a new hibernate (v. 3.3 - also tried v.3.5) session using a distinct session factory.  I use c3p0 v. 0.9 for connection pooling.  I start a new transaction, save the auditLog object, and commit the transaction.  This works beautifully for all my entities save one.  When attempting to commit the auditLog after deleting a ChemoRegimen entity, the application hangs (this also happens with create and update).  No exception is thrown, but upon suspending the thread I find the following stack trace (this is a Swing app):</p>

<pre><code>Thread [AWT-EventQueue-0] (Suspended)   
SocketInputStream.socketRead0(FileDescriptor, byte[], int, int, int) line: not available [native method]    
SocketInputStream.read(byte[], int, int) line: 129  
VisibleBufferedInputStream.readMore(int) line: 145  
VisibleBufferedInputStream.ensureBytes(int) line: 114   
VisibleBufferedInputStream.read() line: 73  
PGStream.ReceiveChar() line: 274    
QueryExecutorImpl.processResults(ResultHandler, int) line: 1660 
QueryExecutorImpl.execute(Query[], ParameterList[], ResultHandler, int, int, int) line: 407 
Jdbc4PreparedStatement(AbstractJdbc2Statement).executeBatch() line: 2737    
NewProxyPreparedStatement.executeBatch() line: 1723 
BatchingBatcher.doExecuteBatch(PreparedStatement) line: 70  
BatchingBatcher(AbstractBatcher).executeBatch() line: 268   
ActionQueue.executeActions(List) line: 266  
ActionQueue.executeActions() line: 167  
DefaultFlushEventListener(AbstractFlushingEventListener).performExecutions(EventSource) line: 321   
DefaultFlushEventListener.onFlush(FlushEvent) line: 50  
SessionImpl.flush() line: 1027  
SessionImpl.managedFlush() line: 365    
JDBCTransaction.commit() line: 137  **[This is where I commit the auditLog]**
MomsInterceptor.postFlush(Iterator) line: 254   
DefaultFlushEventListener(AbstractFlushingEventListener).postFlush(SessionImplementor) line: 375    
DefaultFlushEventListener.onFlush(FlushEvent) line: 51  
SessionImpl.flush() line: 1027  
SessionImpl.managedFlush() line: 365    
JDBCTransaction.commit() line: 137  
HibernateDAO.makeTransient(Entity) line: 119    
ChemoServices.deleteChemoRegimen(ChemoRegimen, String, Session) line: 290   
</code></pre>

<p>I am using PostgreSQL 8.4 as the backend with the 9.0 jdbc4 driver.  The postgresql.log shows [with my comments in brackets]:</p>

<p><strong>[First, the chemo_regimen is deleted]</strong><BR></p>

<pre><code>2011-05-11 12:19:06 CDT moms postgres LOG:  00000: execute &lt;unnamed&gt;: delete from moms_chemo_regimen where crxreg_id=$1&lt;BR&gt;
</code></pre>

<p>....<BR>
<strong>[A lot of cascaded deletes]</strong><BR>
...<BR>
<strong>[Then, my transaction begins in the interceptor session]</strong><BR></p>

<pre><code>2011-05-11 12:19:06 CDT moms postgres LOG:  00000: execute S_1: BEGIN
2011-05-11 12:19:06 CDT moms postgres LOG:  00000: execute &lt;unnamed&gt;: select nextval ('moms_patient_change_log_seq')
</code></pre>

<p><strong>[The audit-log record is inserted]</strong><BR></p>

<pre><code>2011-05-11 12:19:06 CDT moms postgres LOG:  00000: execute &lt;unnamed&gt;: insert into moms_patient_change_log (patclog_pat_id, patclog_action, patclog_reason, patclog_date, patclog_user_name, patclog_guid, patclog_id) values ($1, $2, $3, $4, $5, $6, $7)
2011-05-11 12:19:06 CDT moms postgres DETAIL:  parameters: $1 = '17108', $2 = 'Deleted ChemoRegimen ABVD', $3 = NULL, $4 = '2011-05-11 12:19:06.813', $5 = 'daver', $6 = 'BFAA9D91-7A4E-835E-7A57-B72B2A79A4F1', $7 = '520'
</code></pre>

<p>And that is it.  The audit-log insert transaction never completes. The transaction to delete the chemo-regimen also is never committed. I am able to perform CRUD on ChemoRegimen fine when not auditing it.  A snippet of the ChemoRegimen entity is below:</p>

<pre><code>public class ChemoRegimen extends MOMSEntity implements Auditable
{
  public static final String UNSCHEDULED = "UNSCHEDULED";

  private Date date = new Date();
  private Patient patient;
  private WorkingProtocol protocol;
  private Physician approvingPhysician;
  private boolean canChangeCycles;
  private List&lt;ChemoEncounter&gt; chemoEncounters = new ArrayList&lt;ChemoEncounter&gt;();
  private boolean complete;
  private Icdm icdm;&lt;BR&gt;
  ...&lt;BR&gt;
}
</code></pre>

<p>This is my interceptor:</p>

<pre><code>public class MomsInterceptor extends EmptyInterceptor
{
  private static Logger logger = Logger.getLogger( MomsInterceptor.class.getName() );
  private static Configuration configuration;
  private static SessionFactory sessionFactory;

//Create the initial SessionFactory from the default configuration files
  static
  {
    initSessionFactory();
  }

  public static void initSessionFactory()
  {
    try
    {
      configuration = new Configuration().configure();
      sessionFactory = configuration.buildSessionFactory();
    }
    catch ( Throwable ex )
    {
      // We have to catch Throwable, otherwise we will miss
      // NoClassDefFoundError and other subclasses of Error
      logger.severe( "Building SessionFactory failed - " + ex.getMessage() );
      System.err.println( "Building SessionFactory failed - " + ex.getMessage() );
      throw new ExceptionInInitializerError( ex.getMessage() );
    }
  }

  private Set&lt;Auditable&gt; inserts = new HashSet&lt;Auditable&gt;();
  private Set&lt;UpdatedEntity&gt; updates = new HashSet&lt;UpdatedEntity&gt;();
  private Set&lt;Auditable&gt; deletes = new HashSet&lt;Auditable&gt;();
  private boolean audit;

  public MomsInterceptor(boolean audit)
  {
    super();
    this.audit = audit;
  }

  private class UpdatedEntity
  {
    private Auditable auditable;
    private String[] propertyNames;
    private Object[] currentState;
    private Object[] previousState;
    private Type[] types;

    public UpdatedEntity( Auditable auditable, String[] propertyNames, Type[] types, Object[] currentState, Object[] previousState )
    {
      super();
      this.auditable = auditable;
      this.propertyNames = propertyNames;
      this.currentState = currentState;
      this.previousState = previousState;
      this.types = types;
    }

    public Auditable getAuditable()
    {
      return auditable;
    }

    public String[] getPropertyNames()
    {
      return propertyNames;
    }

    public Object[] getCurrentState()
    {
      return currentState;
    }

    public Object[] getPreviousState()
    {
      return previousState;
    }

    public Type[] getTypes()
    {
      return types;
    }

    /**
     * Return the previous value of the property name prop or null if the property name is not found.
     * @param prop
     * @return
     */
    public Object getPrevious( String prop )
    {
      int i = 0;
      for ( String name : propertyNames )
      {
        if ( prop.equals( name ) )
          return previousState[i];
        i++;
      }

      return null;
    }
  }

  public boolean onSave( Object entity, Serializable id, Object[] state, String[] propertyNames, Type[] types ) throws CallbackException
  {
    boolean modified = false;
    if ( entity instanceof MutableEntity ) // Update create info.
    {
      MutableEntity me = (MutableEntity)entity;
      int i = findPropertyNameIndex( "createUser", propertyNames );
      if ( i &gt;= 0 )
        state[i] = SessionController.userName;
      i = findPropertyNameIndex( "modifyUser", propertyNames );
      if ( i &gt;= 0 )
        state[i] = SessionController.userName;
      modified = true;

      if ( audit &amp;&amp; entity instanceof Auditable ) 
        inserts.add( (Auditable)entity );
    }

    return modified;
  }

  private int findPropertyNameIndex( String name, String[] propertyNames )
  {
    int i = -1;
    if ( propertyNames.length == 0 )
      return i;

    for ( String p : propertyNames )
    {
      i++;
      if ( p.equals( name ) )
        return i;
    }

    return -1;
  }

  public boolean onFlushDirty( Object entity, Serializable id, Object[] currentState, Object[] previousState, String[] propertyNames, Type[] types )
      throws CallbackException
  {
    boolean modified = false;

    if ( entity instanceof MutableEntity ) // Update modify info.
    {
      MutableEntity me = (MutableEntity)entity;
      int i = findPropertyNameIndex( "modifyUser", propertyNames );
      if ( i &gt;= 0 )
        currentState[i] = SessionController.userName;
      i = findPropertyNameIndex( "modifyDate", propertyNames );
      if ( i &gt;= 0 )
        currentState[i] = new Date();
      modified = true;

      if ( audit &amp;&amp; entity instanceof Auditable )
        updates.add( new UpdatedEntity( (Auditable)entity, propertyNames, types, currentState, previousState ) );
    }

    return modified;
  }

  @Override
  public void onDelete( Object entity, Serializable id, Object[] state, String[] propertyNames, Type[] types )
  {
    if ( audit &amp;&amp; entity instanceof Auditable )
      deletes.add( (Auditable)entity );
  }

  @Override
  public void postFlush( Iterator iterator ) throws CallbackException
  {
    if ( inserts.isEmpty() &amp;&amp; deletes.isEmpty() &amp;&amp; updates.isEmpty() )
      return;

    Session session = sessionFactory.openSession();
    session.setFlushMode( FlushMode.COMMIT );
    session.beginTransaction();

    try
    {
      String action = null;
      for ( Auditable entity : inserts )
      {
        action = "Created " + entity.getClass().getSimpleName() + " " + entity.toString();
        session.save( new PatientChangeLog( entity.getPatient(), action, entity.getReason(), SessionController.userName ) );
      }
      for ( Auditable entity : deletes )
      {
        action = "Deleted " + entity.getClass().getSimpleName() + " " + entity.toString();
        session.save( new PatientChangeLog( entity.getPatient(), action, entity.getReason(), SessionController.userName ) );
      }
      for ( UpdatedEntity entity : updates )
      {
        Auditable a = entity.getAuditable();
        StringBuffer actionBuf = new StringBuffer( "Updated " + a.getClass().getSimpleName() + " " + a.toString() + ": changed " );
        int count = 0;
        for ( int i = 0; i &lt; entity.getPropertyNames().length; i++ )
        {
          String prop = entity.getPropertyNames()[i];
          Type type = entity.getTypes()[i];
          Object curValue = entity.getCurrentState()[i];
          Object prevValue = entity.getPreviousState()[i];

          //Don't consider the id field or the metadata fields.
          if ( prop.equals( "id" ) || prop.equals( "createUser" ) || prop.equals( "createDate" ) || prop.equals( "modifyUser" ) 
              || prop.equals( "modifyDate" ) || prop.equals( "guid" ) )
            continue;

          if ( prevValue == null )
            prevValue = new String( "" );
          if ( curValue == null )
            curValue = new String( "" );
          if ( !prevValue.equals( curValue ) )
          {
            if ( count &gt; 0 )
              actionBuf.append( " and " );
            actionBuf.append( prop ).append( " from '" ).append( prevValue ).append( "' to '" ).append( curValue ).append( "'" );
            count++;
          }   
        }

        Patient p = (Patient)entity.getPrevious( "patient" );  //In case the patient is changed, tie it to the previous patient.
        session.save( new PatientChangeLog( p, actionBuf.toString(), a.getReason(), SessionController.userName ) );
      }

      session.getTransaction().commit();
    }
    catch ( HibernateException e )
    {
      try
      {
        session.getTransaction().rollback();
      }
      catch ( Exception hex )
      {
        throw new RuntimeException( hex );
      }
      throw new RuntimeException( e );
    }
    finally
    {
      inserts.clear();
      updates.clear();
      deletes.clear();
      session.close();
    }
  }
}
</code></pre>

<p>Any help would be greatly appreciated.</p>
 Help needed with Spring/Hibernate Lazy-loading <p>I know that this has been discussed lot of times. I just can't understand how this work or where my mistake is.<br>
I think giving you a reduced example is the best way to show you what I'm trying to do and what assumptions I'm taking... </p>

<p>I have a Product class with a name. The name is a String property that is lazy.</p>

<p>My DAO:</p>

<pre><code>public abstract class HibernateProductDAO extends HibernateDaoSupport implements ProductDAO
{
    public List getAll()
    {
        return this.getHibernateTemplate().find("from " + this.getDomainClass().getSimpleName());
    }
}
</code></pre>

<p>My Service Interface:</p>

<pre><code>public interface ProductService {
    //This methods are Transactional, but same exception error is thrown if there weren't
    @Transactional
    public Product getProduct();
    @Transactional
    public String getName(Product tp);
}
</code></pre>

<p>My Service Implementation:</p>

<pre><code>public class ProductServiceImpl implements ProductService  {
    private ProductDAO productDAO;
    public Product getProduct() {
        List ps = this.productDAO.getAll();
        return (Product) ps.get(0);
    }
    public String getName(Product p){
        return p.getName();
    }
}
</code></pre>

<p>My Main class:</p>

<pre><code>public class Main {
    private ProductService productService;
    public static void main(String[] args) {
        Main main= new Main();          
        main.productService= (ProductService)(new ClassPathXmlApplicationContext("applicationContext.xml")).getBean("productProxy");
        //load the product without the name
        Product p = main.productService.getProduct();
        //load the lazy name
        System.out.println(main.productService.getName(p));  //EXCEPTION IS THROWN IN THIS LINE
    }
    public void setProductService(ProductService productService) {
        this.productService= productService;
    }

    public ProductService getProductService() {
        return productService;
    }
</code></pre>

<p>My applicationContext.xml:</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:util="http://www.springframework.org/schema/util"
   xmlns:jee="http://www.springframework.org/schema/jee"
   xmlns:lang="http://www.springframework.org/schema/lang"
   xmlns:aop="http://www.springframework.org/schema/aop"
   xmlns:tx="http://www.springframework.org/schema/tx"
   xmlns:sca="http://xmlns.oracle.com/weblogic/weblogic-sca"&gt;

    &lt;bean id="dataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource"&gt;
        &lt;property name="driverClassName"&gt;&lt;value&gt;oracle.jdbc.driver.OracleDriver&lt;/value&gt;&lt;/property&gt;
        &lt;property name="url"&gt;&lt;value&gt;jdbc:oracle:thin:@${hostname}:${port}:${schema}&lt;/value&gt;&lt;/property&gt;
        &lt;property name="username"&gt;&lt;value&gt;${username}&lt;/value&gt;&lt;/property&gt;
        &lt;property name="password"&gt;&lt;value&gt;${password}&lt;/value&gt;&lt;/property&gt;
    &lt;/bean&gt;

    &lt;!-- Hibernate SessionFactory --&gt;
    &lt;bean id="sessionFactory" class="org.springframework.orm.hibernate3.annotation.AnnotationSessionFactoryBean"&gt;
        &lt;property name="dataSource"&gt;&lt;ref local="dataSource"/&gt;&lt;/property&gt;
        &lt;property name="configLocation"&gt;&lt;value&gt;hibernate.cfg.xml&lt;/value&gt;&lt;/property&gt;
        &lt;property name="configurationClass"&gt;&lt;value&gt;org.hibernate.cfg.AnnotationConfiguration&lt;/value&gt;&lt;/property&gt;
    &lt;/bean&gt;

    &lt;!-- Transaction manager for a single Hibernate SessionFactory (alternative to JTA) --&gt;
    &lt;bean id="transactionManager" class="org.springframework.orm.hibernate3.HibernateTransactionManager"&gt;
        &lt;property name="sessionFactory"&gt;&lt;ref local="sessionFactory"/&gt;&lt;/property&gt;
    &lt;/bean&gt;

    &lt;bean id="hibernateTemplate" class="org.springframework.orm.hibernate3.HibernateTemplate"&gt;
        &lt;property name="sessionFactory"&gt;&lt;ref bean="sessionFactory"/&gt;&lt;/property&gt;
        &lt;property name="allowCreate" value="true"/&gt;
    &lt;/bean&gt; 
    &lt;bean id="productDAO" class="product.model.data.ProductDAO" &gt;
        &lt;property name="sessionFactory" ref="sessionFactory"/&gt;
&lt;/bean&gt;
    &lt;bean id="hibernateInterceptor"
      class="org.springframework.orm.hibernate3.HibernateInterceptor"&gt;
        &lt;property name="sessionFactory"&gt;
            &lt;ref bean="sessionFactory"/&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
    &lt;bean id="productService"
      class="product.services.ProductServiceImpl"&gt;
        &lt;property name="productDAO"&gt;
            &lt;ref bean="ProductDAO"/&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
    &lt;bean id="productProxy"
      class="org.springframework.aop.framework.ProxyFactoryBean"&gt;
        &lt;property name="target"&gt;
             &lt;ref bean="productService"/&gt;
        &lt;/property&gt;
        &lt;property name="proxyInterfaces"&gt;
             &lt;value&gt;product.services.ProductService&lt;/value&gt;
        &lt;/property&gt;
        &lt;property name="interceptorNames"&gt;
            &lt;list&gt;
                &lt;value&gt;hibernateInterceptor&lt;/value&gt;
            &lt;/list&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>

<p>The exception fragment:</p>

<pre><code>11:59:57,775 [main] DEBUG org.springframework.orm.hibernate3.SessionFactoryUtils  - Opening Hibernate Session
11:59:57,775 [main] DEBUG org.hibernate.impl.SessionImpl  - opened session at timestamp: 12749723977
11:59:57,777 [main] ERROR org.hibernate.LazyInitializationException  - could not initialize proxy - no Session 
org.hibernate.LazyInitializationException: could not initialize proxy - no Session
    at org.hibernate.proxy.AbstractLazyInitializer.initialize(AbstractLazyInitializer.java:108)
    at org.hibernate.proxy.AbstractLazyInitializer.getImplementation(AbstractLazyInitializer.java:150)
    at org.hibernate.proxy.pojo.cglib.CGLIBLazyInitializer.invoke(CGLIBLazyInitializer.java:150)
</code></pre>

<p>Am I right if I assume that the HibernateInterceptor keeps the Hibernate Session Open among the different calls? If I'm so, Why is the session closed after loading the product object?</p>

<p>I read somewhere that I also can use OpenSessionInViewInterceptor, but I can't make it work. How would you add that interceptor to this little example?</p>

<p>Is there any code mistake or missunderstanding on how this work?</p>

<p>Do you know any simple example code I can download to check how this work?</p>

<p>Thanks in advance,
Neuquino</p>
 Castle.Core.InterceptorAttribute not injecting interceptor <p>Based on the <a href="http://stw.castleproject.org/Windsor.Interceptors.ashx" rel="nofollow">documentation for Castle.Core.InterceptorAttribute</a>, I am trying to make this simple test pass, and am having no luck:</p>

<pre><code>using NUnit.Framework;
using Castle.DynamicProxy;
using Castle.Core;
using Castle.MicroKernel;
using Castle.MicroKernel.Registration;


public interface IIntercepted { string get(); }

[Interceptor(typeof(TestInterceptor))]
public class Intercepted : IIntercepted
{
    public virtual string get() { return "From Service"; }
}

public class TestInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        invocation.Proceed();
        invocation.ReturnValue = "From Proxy";
    }
}
[TestFixture]
public class TestFixture
{
    [Test]
    public void Test_interception()
    {
        var container = new DefaultKernel();
        container.Register(
            Component.For&lt;TestInterceptor&gt;().LifeStyle.Transient,
            Component.For&lt;IIntercepted&gt;().ImplementedBy&lt;Intercepted&gt;());

        var instance = container.Resolve&lt;IIntercepted&gt;();
        Assert.That(instance.get(), Is.EqualTo("From Proxy"));
    }
}
</code></pre>

<p>In stepping through the tests, <code>instance</code> is not a proxy and <code>get()</code> returns "From Service".  It seems to me that in this case, I should not need to make <code>get()</code> virtual, but did so just to be sure.  I have the feeling I am missing something obvious and fundamental here, like is there a facility that needs to be registered here to make the container aware of the Interceptor attribute?  I can't find any documentation to that effect.  Can someone tell me what I am doing wrong?</p>

<p>I am using Castle version 2.5 and the 4.0 version of the .Net Framework.</p>
 struts2 session expired application scope <p>my app uses struts2+spring+hibernate and I was doing some session-interceptor-login-authorisation system and its working alright, now that I try to implement the session expired part I'm running into problems:
first the session interceptor checks  for every request to see if a user is on session if not then  its redirected to the login page, otherwise its let through the action requested  .</p>

<ul>
<li><p>so if the user has just began the app the login page pops up  </p></li>
<li><p>if the session has timeout because of the  session-timeout property in web.xml its then redirected to a login page</p></li>
</ul>

<p>Now I had a request that a session expired message be displayed.
So I decided to use the app scope and set some variables like UserLoggedIn 
and now back to the interceptor I can check for the user to be in session and if its null check the app scope for the variable UserLoggedIn so if founded then session is expired (sessionExpired.jsp) otherwise  login.jsp.
the problem is that whenever I close the browser and reopen it, the app scope its still there and UserLoggedIn variable with it so  lets say I want to start the browser and my app
 so the session interceptor its fired it doesn't find a user on session GReat!! but it found the UserLoggedIn variable which is telling that this is not a brand new start so the session expired message its pop up. I know its kind of confusing Im not sure if this is the right way to do this session expired thing; its my first try.</p>

<p>any advice, alternative methods, etc, will be really appreciated </p>

<p>pd: I know that there are better approaches into securing your app like spring security
    I devoted 2 days but failed and because of  the time factor Im cant keep trying whit it </p>
 What is the best way to have interceptors for POJO? <p>EJB 3.0 comes with the concept of Interceptors, but then again they are applicable to EJBs only. My project requires developing Interceptors for POJO classes. One option for this is to use Spring AOP. I want to know if it's worth the overhead of including the libraries such as commons-logging, spring-aop, cglib that are required for Spring AOP.</p>
 Can you use a static method in WCF that accesses HttpContext.Current.Items? <p>I have an interceptor that picks data from a message header on a WCF request. See below:</p>

<pre><code>public object AfterReceiveRequest(ref Message request, IClientChannel channel, InstanceContext instanceContext)
{
    _CurrentRequest = request;
    SetupSecurityPrincipal();
    ThreadExtension.PersonID = GetIntHeader(HeaderKeys.PersonID);
    return null;
}
</code></pre>

<p><code>ThreadExtension</code> (ignore the name, means nothing) is a class with static properties that provide a get/set to <code>HttpContext.Current</code>. See below:</p>

<pre><code>public class ThreadExtension
{
    public static int? PersonID
    {
        get { return (int?)HttpContext.Current.Items["PersonID"]; }
        set { HttpContext.Current.Items["PersonID"] = value; }
    }
}
</code></pre>

<p>So the problem is on requests from our web end to our WCF web services, sometimes the information in <code>ThreadContext</code> changes if we have 2 requests that happen close enough together, resulting in one person's data in another person's session. </p>

<p>So my question is, what are we doing wrong? Is the use of static properties here not the right approach? Ideally, we just need something that is tied to the request in WCF so we can get to it in a few places without passing the data around all the time.</p>

<p>Any help or advice you can provide would be greatly appreciated.</p>
 method selector on one of many interceptors for a service registered in Castle.Windsor <p>Using Castle.Windsor, how would I go about adding a IProxyGenerationHook or selector for one of several interceptors defined for a specific service. For example consider the following component registration:</p>

<pre><code> container.Register( _
    Component.For(Of IDataLoader) _
    .ImplementedBy(Of sqlldrDataLoader) _
    .Interceptors(Of LoggingInterceptor, FancySchmancyInterceptor))
</code></pre>

<p>The IDataLoader service has several methods. I want the following:
a) LoggingInterceptor will intercept every method.
b) FancySchmancyInterceptor should only intercept a subset of methods as defined in a selector of some description.</p>

<p>Many thanks,
Ryan.</p>
 Struts2 and multiple active wizards / workflows <p>I'm currently working on a Struts2 application that integrates a wizard / workflow in order to produce the desired results. To make it more clear, there is a business object that is changed on three different pages (mostly with AJAX calls). At the moment I'm using a ModelDriven action (that's extended by all the actions working with the same business object) coupled with the Scope interceptor. While this works okay if the user is handling data for only one business object at a time, if the user opens the wizard for different objects in multiple tabs (and we all do this when we want to finish things faster) everything will get messy, mostly due to the fact that I have only one business object stored in the session.</p>

<p>I have read a few articles about using a Conversation Scope Interceptor (<a href="http://www.vitarara.org/cms/struts_2_cookbook/using_a_conversation_scope" rel="nofollow" title="Mark Menard's take on using a conversation scope">main article</a>) and about using the Scope plug-in (<a href="http://code.google.com/p/struts2scopeplugin/" rel="nofollow">here</a>). However, both approaches seem to have problems:</p>

<ul>
<li>the Conversation Scope Interceptor doesn't auto-expire the conversations, nor does it integrate properly with Struts2;</li>
<li>the Scope plug-in lacks proper documentation and the last build was made in 2007 (and actually includes some of the ideas written by Mark Menard when he defines his Conversation Scope Interceptor, though it doesn't use the same code).</li>
</ul>

<p>Spring's WebFlow plug-in seems a bit too complex to be used at the moment. I'm currently looking for something that can be implemented in a few hours time, though I don't mind if you can suggest something that works as needed, even if it requires more time than I'd currently want to spend on this now.</p>

<p>So, seasoned Struts2 developers, what do you suggest? How should I implement this?</p>
 ipojo custom handlers - auto attached handlers - issue in attaching to specific components <p>I have an issues concerning the custom auto handlers in ipojo. I have created an handler (say Handler-Auto), I want this handler to be auto attached to a POJO component instances (say Comp-1) without touching the metadata of POJO components.
To achieve this, we need to set the "org.apache.felix.ipojo.handler.auto.primitive" variable in the system property with the list of handlers as specified in the below link:</p>

<p><a href="https://issues.apache.org/jira/browse/FELIX-2594?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel#issue-tabs" rel="nofollow">https://issues.apache.org/jira/browse/FELIX-2594?page=com.atlassian.jira.plugin.system.issuetabpanels:all-tabpanel#issue-tabs</a></p>

<p>The problem  is, when I do like this, my handler (Handler-Auto) is attached to all the components or instances that are created or deployed over the system. To intercept methods or fields from a  particular component we need to add filter at the handler.  But its too late to add filter after attaching handlers with all unnecessary stuffs.</p>

<p>Instead of attaching the handler to all the components,   Is there anyway that, this handler (Handler-Auto) can me made to be attached to a specific components or instances ? as per the user wish.</p>

<p>It would be great if we have this feature and it ll become very dynamic.</p>

<p>Please help if there is any other way to do this or what could be the solution to achieve this ??</p>

<p>thanks for your help in advance!</p>

<p>Thanks,
Sadish </p>
 Is the ArroundInvoke method gets invoked if it were invoked from another ejb method? <p>I've  the following case:</p>

<pre><code>@Interceptors(MyInterceptClass.class)
public void ejbMethod1()
{

}


@Interceptors(MyInterceptClass.class)
public void ejbMethod2()
{
    ejbMethod1();
}
</code></pre>

<p>Is calling ejbMethod2 causes TWO interceptor calls to be executed?</p>

<p>Thanks.</p>
 Proxy is created, and interceptor is in the __interceptors array, but the interceptor is never called <p>This is the first time I've used interceptors with the fluent registration and I'm missing something.  With the following registration, I can resolve an IProcessingStep, and it's a proxy class and the interceptor is in the __interceptors array, but for some reason, the interceptor is not called.  Any ideas what I'm missing?</p>

<p>Thanks,
Drew</p>

<pre><code>AllTypes.Of&lt;IProcessingStep&gt;()
 .FromAssembly(Assembly.GetExecutingAssembly())
 .ConfigureFor&lt;IProcessingStep&gt;(c =&gt; c
  .Unless(Component.ServiceAlreadyRegistered)
  .LifeStyle.PerThread
  .Interceptors(InterceptorReference.ForType&lt;StepLoggingInterceptor&gt;()).First
  ),
Component.For&lt;StepMonitorInterceptor&gt;(),
Component.For&lt;StepLoggingInterceptor&gt;(),
Component.For&lt;StoreInThreadInterceptor&gt;()


public abstract class BaseStepInterceptor : IInterceptor
{
 public void Intercept(IInvocation invocation)
 {
  IProcessingStep processingStep = (IProcessingStep)invocation.InvocationTarget;
  Command cmd = (Command)invocation.Arguments[0];
  OnIntercept(invocation, processingStep, cmd);
 }

 protected abstract void OnIntercept(IInvocation invocation, IProcessingStep processingStep, Command cmd);
}

public class StepLoggingInterceptor : BaseStepInterceptor
{
 private readonly ILogger _logger;

 public StepLoggingInterceptor(ILogger logger)
 {
  _logger = logger;
 }

 protected override void OnIntercept(IInvocation invocation, IProcessingStep processingStep, Command cmd)
 {
  _logger.TraceFormat("&lt;{0}&gt; for cmd:&lt;{1}&gt; - begin", processingStep.StepType, cmd.Id);

  bool exceptionThrown = false;

  try
  {
   invocation.Proceed();
  }
  catch
  {
   exceptionThrown = true;
   throw;
  }
  finally
  {
   _logger.TraceFormat("&lt;{0}&gt; for cmd:&lt;{1}&gt; - end &lt;{2}&gt; times:&lt;{3}&gt;",
        processingStep.StepType, cmd.Id,
        !exceptionThrown &amp;&amp; processingStep.CompletedSuccessfully 
         ? "succeeded" : "failed",
        cmd.CurrentMetric==null ? "{null}" : cmd.CurrentMetric.ToString());
  }
 }
}
</code></pre>
 Ambient filter / interceptors for domain classes in Gorm / Grails? <p>I just integrated a logging concept for my Grails system and used the filter mechanism to log access to my controllers and actions. The good thing is that I can define one filter for all controller and actions. </p>

<p>With domain classes I do only know the interceptor concept where I have to write an interceptor for every individual domain class. Is there a concept similar to filters for domain classes where I can define an interceptor for ALL domain classes?</p>

<p>Many thanks in advance,
Joerg.  </p>

<p>UPDATE 1:
Thank you for the tip on the Audit Logging Plugin by Stefan. The Audit Logging Plugin looks like the easiest alternative but produces too many rows/logs for my taste and does not use the grails/log4j logging system.</p>

<p>Currently, my requirements are:</p>

<ol>
<li><p>Log the insert/update/delete for all domain classes (in order to log only the incidents, not every change to every field/column)</p></li>
<li><p>Log to the Grails logging system (log4j) in order to log to stdout, individual database tables, or email (The level might be, e.g., INFO or TRACE)</p></li>
<li><p>Log to a special domain class (db table) in order to build a log visualization / management system on top of it (via Grails controller &amp; actions). Here it would be great to configure if the logs are in the same or another database/grails-app (in order to split the log management system later on).</p></li>
</ol>

<p>As far as I know a simple "change" logging can be done via:</p>

<ol>
<li><p>Individual log statements in domain classes (requires insert/update/delete events in every domain class)</p></li>
<li><p>Define a "Log" Superclass which inherits the insert/update/delete events (makes it hard to make indivudal insert/update/delete events in special domain classes)</p></li>
<li><p>Define a Filter for all controllers but only save/update/delete actions (problem: does not log changes to domain classes without an controller or if multiple domain classes are touched in one action)</p></li>
</ol>

<p>Hope this helps other. Nevertheless, Did I miss something? </p>
 JSON serialization (using Jquery plugin) w/ Struts2 interceptors - <p>I'm trying to implement <a href="http://code.google.com/p/struts2-jquery/wiki/SelectTag#A_simple_Doubleselect_with_Topics" rel="nofollow">http://code.google.com/p/struts2-jquery/wiki/SelectTag#A_simple_Doubleselect_with_Topics</a> but I can't seem to combine the json interceptor with other interceptors successfully. </p>

<p>In my struts.xml:</p>

<pre><code>&lt;package name="admin" namespace="/admin" extends="struts-default,json-default"&gt;
    &lt;action name="LoadLists" method="loadLists" class="test.JSONAction"&gt;
        &lt;interceptor-ref name="json"&gt;
            &lt;param name="contentType"&gt;application/json&lt;/param&gt;
            &lt;!--interceptor added to override this property below--&gt;
            &lt;param name="excludeNullProperties"&gt;true&lt;/param&gt; 
        &lt;/interceptor-ref&gt;
        &lt;result name="success" type="json"/&gt;
        &lt;interceptor-ref name="servletConfig"/&gt;
    &lt;/action&gt;
&lt;/package&gt;
</code></pre>

<p>Here's some of the action class code.  </p>

<p>Note that I need the <code>session</code> variable and therefore have added the <code>&lt;interceptor-ref name="servletConfig"/&gt;</code> line above to set the session variable so that it can be used in the following Java code:</p>

<pre><code>public String loadLists() {
    items = (List&lt;String&gt;) session.get("itemsList");
    if (itemSelected.equals...
    // Do stuff to process the list and generate the second list...            
}

public void setItemSelected(String itemSelected) {
    this.itemSelected = itemSelected;
}
</code></pre>

<p>BUT when I have <code>&lt;interceptor-ref name="servletConfig"/&gt;</code>, error logs show: </p>

<pre><code>org.apache.struts2.json.JSONInterceptor.debug:68 - Content type must be 'application/json' or 'application/json-rpc'. Ignoring request with content type application/x-www-form-urlencoded
</code></pre>

<p>and the variable <code>itemSelected</code> never gets set because the json serialization is ignored!</p>

<p>If I remove <code>&lt;interceptor-ref name="servletConfig"/&gt;</code> then I can't access the session!</p>

<p>What am I missing?</p>
 Performance with Castle Windsor Interceptors <p>As suggested by many, logging is better managed through AOP, and in my case, using Castle Windsor interceptors.</p>

<p>I am currently developing a web app and we just added an interceptor to log every method that is called (the methods are tagged by a custom attribute therefore I can choose the method I want to log).  When I test the web app the performance is awful.  Sometimes it might take up to 10 seconds for a page to render.  Without the interceptor the pages load instantly.</p>

<p>Are there any tips when adding interceptors and performance or is it actually this slow?</p>
 EJB3 Interceptors for logging <p>In an MDB application, Can the EJB3 Interceptor be configured to log the Non bean class methods, which are inturn invoked by the bean method (OnMessage)?</p>

<p>Thanks in advance</p>
 Add Unmapped Data to NHibernate <p>I have an object I'm trying to persist to a legacy database with NHibernate.  I have all of the relevant columns from a table mapped in my domain object, but have a few fields in the table that must be populated for the structure of the legacy db.</p>

<p>Following a few recommendations, I created and registered an NHibernate interceptor to do this for me.</p>

<pre><code> public class CustomLineItemInterceptor : EmptyInterceptor
 {

  public override bool OnSave(object entity, object id, object[] state, string[] propertyNames, IType[] types)
  {
    var lineItem = entity as SomeCustomLineItem;

    if (lineItem == null)
    return false;


    List&lt;string&gt; propertyNameList = propertyNames.ToList();
    List&lt;IType&gt; typeList = types.ToList();
    List&lt;object&gt; stateList = state.ToList();

    propertyNameList.Add("Source");   // the unmapped column in the database
    typeList.Add(NHibernateUtil.String);
    stateList.Add("My Application's Name");  // the value I need to persist

    state = stateList.ToArray();
    propertyNames = propertyNameList.ToArray();
    types = typeList.ToArray();

    return true;
    }
}
</code></pre>

<p>I've looked at this <a href="http://stackoverflow.com/questions/824316/nhibernate-add-unmapped-column-in-interceptor">NHibernate add unmapped column in interceptor</a> and <a href="http://stackoverflow.com/questions/579885/unmapped-columns-in-nhibernate">Unmapped Columns in NHibernate?</a> without finding the answer.</p>

<p>What I'm seeing is that I the OnSave method does fire, but I get nothing stored in the database (or the SQL query generated by NHibernate).</p>

<p>What am I doing wrong?</p>
 Castle Windsor - Interceptors & Threads <p>As part of the project I am working on I am using interceptors to capture the result of a call to a service and then fire off an email when appropriate.</p>

<p>The code makes use of a thread to update the status in the background and clients are given a previously cached version until the updated value becomes available. The status is not updated any more frequently than five minutes at a time to reduce server load.</p>

<p>The interceptors seem to ignore the thread and validate based on the result given. I can trigger the email to send after the value has been updated (i.e. another client has requested the value after the thread has previously run) and can trigger an email that way.</p>

<p>But I was wondering if anyone had any suggestions on using interceptors with threads?</p>

<p>Thanks :)</p>
 Scope interceptor in struts2 <p>Is there any sample code where I can see the use of scope interceptor in Struts2? I want to pass a parameter from one action to other action (configured through struts.xml) &amp; want to use scope interceptor.</p>

<p>Since I'm new to struts 2, can any one provide sample of using scope interceptor?</p>

<p>Thanks!</p>
 Determine implementer of an ejb3 interface in jboss <p>How can I get the implementing class of an EJB3 interface at runtime in the JBoss container?  This is similar to reflection.  With reflection, however, I get a proxy class which is probably part of the interceptor framework. </p>
 Castle Windsor Interceptor on Caliburn View Model <p>I would like create own aspects with Castle Windsor Interceptor and apply on View Model classes.</p>

<p>As I said I use Caliburn MVVM framework and on DI I use Caste Windsor. Everything works good.</p>

<p>For example I created simple loggging interceptors, here is:</p>

<pre><code>public class LoggingInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        Console.Write("Log: Method Called: " + invocation.Method.Name);
        invocation.Proceed();
    }
}
</code></pre>

<p>This is simple View Model class - it is "tab item" :</p>

<pre><code>public class TabViewModel : Screen, 
    ITabViewModel
{

}
</code></pre>

<p>When I configure IoC with Fluent API I would like apply this interceptor on View Model class.</p>

<pre><code>       container.Register(Component
                    .For&lt;LoggingInterceptor&gt;()
                    .LifeStyle
                        .Singleton
                    .Named("LogAspect"));

        container.Register(Component
                    .For&lt;ITabViewModel&gt;()
                    .ImplementedBy&lt;TabViewModel&gt;()
                    .LifeStyle
                        .Transient
                    .Named("TabViewModel")
                    .Interceptors&lt;LoggingInterceptor&gt;());
</code></pre>

<p>When I tried pick view model from IoC: </p>

<pre><code>var tabItem = IoC.Get&lt;ITabViewModel&gt;();
ActivateItem(tabItem);
</code></pre>

<p>I got this message:</p>

<blockquote>
  <p>A default view was not found for Castle.Proxies.ITabViewModelProxy. 
  Views searched for include:  Castle.Proxies.IITabViewModelProxy
  Castle.Proxies.ITabViewModelProxys.IDefault
  Castle.Proxies.ITabViewModelProxys.Default</p>
</blockquote>

<p>Also I tried this way for interceptor applicaion.</p>

<pre><code>[Interceptor(typeof(LoggingInterceptor))]
public class TabViewModel : Screen, 
    ITabViewModel
{

}
</code></pre>

<p>Ok, I know that Caliburn framework match View and View Model by naming convention.</p>

<p>When I try pick implementation of ITabViewModel I get ITabViewModelProxy and for ITabViewModelProxy I didn’t register any View.</p>

<p>Target of proxy is TabViewModel but I think problem is with naming mismatch.</p>

<p>I dont want rename ViewModel because I would like configure proxies from XML files.</p>

<p>So what is correct way? </p>

<p>Thank you for help </p>
 Autofac + Castle DynamicProxy: Order of interceptors <p>I'm using Castle DynamicProxy with Autofac. I have an object for which I've created a proxy, and I have two interceptors that act on the proxy, one for logging an exception and the second for for altering the return value of the method. The registration code looks like the following:</p>

<pre><code>var builder = new ContainerBuilder();

builder.Register(c =&gt; c.Resolve&lt;ProxyGenerator&gt;()
    .CreateClassProxy&lt;Foo&gt;(
        c.Resolve&lt;ResultProcessorInterceptor&gt;(),
        c.Resolve&lt;ExceptionLoggingInterceptor&gt;()))
    .As&lt;Foo&gt;();
</code></pre>

<p>By supplying the arguments in this order, I'm finding that I get the result that I want, i.e., the exception is logged and the result is processed. If I reverse the order of the arguments, the logging doesn't occur. </p>

<p>My question, then: registered in this way, are the interceptors guaranteed to execute in the same order every time? Or is there a better way to ensure that the order will be what I intend every time?</p>

<p>FWIW, I looked at the IInterceptorSelector interface. Perhaps I'm missing something--which is not unlikely--but it looked like that wasn't relevant in this case. But I'd be happy to be corrected if I'm wrong. </p>

<p>I can supply a longer code sample if necessary.</p>

<p>musicologyman</p>
 how to use many interceptors for each type of url spring security 2 <p>I want to use two interceptors, one for my struts actions and the second for my webservices.
Is it possible to have one interceptor to test urls like /rest/documents and the second one for all the other requests ?
Thnx </p>
 
decorator-chaining decorator-chaining Decorator Chaining of Repositories and Specialized Repositories with Dependancy Injection <p>Right now I'm trying to figure out a way to do things smarter, and in the course of doing so all i've managed to do is use a full bottle of excedrin in a single day.</p>

<p>Assume i have an interface called IRepository like so.</p>

<pre><code> public interface IRepository&lt;T&gt;
 {
    T Get(int id);
    void Add(T value);
    void Update(T value);
    void Delete(T value);
    ...
 }
</code></pre>

<p>And assume i have an implementation like </p>

<pre><code>public class NHibernateRepository&lt;T&gt;
{
    ...
}
</code></pre>

<p>Now, all is fine and good, i can do all my basic operations against the repository to support all CRUD functionality, but i may want specialized operations, so assume i have an interface like this:</p>

<pre><code>public interface IUserRepository : IRepository&lt;User&gt;
{
     IList&lt;User&gt; GetUsersByRole(Role role);
}
</code></pre>

<p>And an implementation like such:</p>

<pre><code>public class UserRepository : NHibernateRepository&lt;User&gt;, IUserRepository
{
    ....
}
</code></pre>

<p>Ok, so that is the basic setup, now there's one more thing that i want to do. I want to have logging and transaction and things like that all transparently. So what i would like to do is use a dependency injection framework like Castle Windsor or StructureMap so that when i ask for IRepository, i'll get it wrapped by a LoggingRepository and a TransactionRepository, both of which implement IRepository.</p>

<p>So, what i want to do is something like this:</p>

<pre><code>IUserRepository repository = container.Resolve&lt; IUserRepository&gt;();
</code></pre>

<p>and have it return a user repository that's wrapped in the Logging and Transaction decorators, but i can't think of a way that this will ever work. The only way i can think of getting this to work is by implementing UserRepository like such:</p>

<pre><code>public class UserRepository : DecoratorRepository&lt;T&gt;, IUserRepository
{
    protected IRepository&lt;T&gt; Repository { get; set; }

    public UserRepository(IRepository&lt;T&gt; innerRepository)
    {
        Repository = innerRepository;
    }
}
</code></pre>

<p>This would mean that we would use Dependancy Injection to create a decorated repository and pass that into the constructor of the UserRepository and then use that as the repository in which we run operations against.  This would work, but i still don't think it's ideal.</p>

<p>So, my question is, am I right in that this is the only way to do this, or am I not understanding this correctly or just missing something all together. Also, if you have run up against this problem before, how did you solve this problem?</p>
 Does it matter when a decorator gets called (at the beginning or at the end of the method) in the decorator pattern? <p>I'm implementing a decorator pattern in Javascript. </p>

<p>I've seen the example <a href="http://en.wikipedia.org/wiki/Decorator%5Fpattern" rel="nofollow">here</a> in Wikipedia</p>

<pre><code>// Class to be decorated
function Coffee() {
    this.cost = function() {
  return 1;
    };
}

// Decorator A
function Milk(coffee) {
    this.cost = function() {
  return coffee.cost() + 0.5;
    };  
}

// Decorator B
function Whip(coffee) {
    this.cost = function() {
  return coffee.cost() + 0.7;
    };
}

// Decorator C
function Sprinkles(coffee) {
    this.cost = function() {
  return coffee.cost() + 0.2;
    };
}

// Here's one way of using it
var coffee = new Milk(new Whip(new Sprinkles(new Coffee())));
alert( coffee.cost() );

// Here's another
var coffee = new Coffee();
coffee = new Sprinkles(coffee);
coffee = new Whip(coffee);
coffee = new Milk(coffee);
alert(coffee.cost());
</code></pre>

<p>Now my question is for the pattern to <strong>still be</strong> a decorator pattern, does it matter if the parent class is called at the beginning or the end of the cost() function?  </p>

<p>Now granted I realize that this depends on what each of the decorators do...for instance if your are multiplying or dividing in your decorator instead of adding or subtracting, it will of course warrant a different result.</p>

<p>But is there any reason to make the call before or after other than the reason I stated in the previous paragraph?</p>
 
interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor interceptor Is there a way to intercept setters and getters in C#? <p>In both Ruby and PHP (and I guess other languages as well) there are some utility methods that are called whenever a property is set. ( <strong>*instance_variable_set*</strong> for Ruby, <strong>*__set*</strong> for PHP).</p>

<p>So, let's say I have a C# class like this:</p>

<pre><code>public class Person
{
    public string FirstName { get; set; }
    public string LastName { get; set; }
}
</code></pre>

<p>Now, let's say that if any property setter from the <code>Person</code> class is called, I want to call another method first, and then continue with the default behaviour of the setter, and the same applies for the property setters.</p>

<p>Is this possible?</p>

<hr>

<p><em><strong>Edit:</em></strong>
I want to do this without defining a backing field.</p>
 NHibernate session management and lazy loading <p>I am having a heck of a time trying to figure out my session management woes in NHibernate. I am assuming that a lot of my trouble is due to lack of knowledge of IoC and AOP concepts; at least that is what I am thinking by where Fabio Maulo keeps directing me.</p>

<p>Anyways, my problem is that I have a win forms application that is making "get" calls and binding the result to a grid. After binding the user may perform some kind of "write" action and those result in the session being closed after the write in an attempt to use the session per use concept. Then the user may scroll through the grid which causes the lazy loading to kick off and now the session has been closed and I get an exception.</p>

<p>I do not want to make my view cognizant of my sessions, I don't want to send off a KillAllSessions when the user closes the form. Plus a user may have multiple forms open at any given time further compounding the issues associated with that method. I essentially want all of this to work "behind the scenes".</p>

<p>So my idea thus far is to intercept the lazy loading call and check to see if the session is open and if not re-open it, get the information then re-close it. However, as far as I can tell, which isn't much, this is essentially how the lazy loading works anyways. It is intercepted by the proxy factory (NHibernate.Bytecode.Castle) and then retrieves the data using the session. So I need to actually intercept that call then pass it on to the original intended intercept after re-opening the session. So that is my idea.</p>

<p>My question is essentially first of all is this even the right way to go about this? Second if it is I don't even know where to start. I have never done any intercepting of method calls, I knew of it in theory but not in practice. I know there are libraries out there that do this kind of thing such as Rhino Commons, but I want to take this opportunity to learn and become a better programmer. I am trying to understand AOP and Context Bound Objects but currently I am not grokking it. Could some of you folks please help a guy out?</p>
 NHibernate: difference Interceptor and Listener <p>Looking at all the possibilites of creation / update columns in NHibernate I mostly (<a href="http://stackoverflow.com/questions/551701/how-do-i-implement-changetime-and-changeuser-columns-using-nhibernate">Stackoverflow question</a>, <a href="http://ayende.com/Blog/archive/2009/04/29/nhibernate-ipreupdateeventlistener-amp-ipreinserteventlistener.aspx" rel="nofollow">Ayende Rahien</a>) see solutions with Listeners. </p>

<p>The programmer who was programming this in my company used an Interceptor to achieve the same thing.</p>

<p>Is there any difference between those two solutions ? (Is on of them obsolete, is one of them preferred and what are the advantages and / or disadvantes)</p>
 Is it possible to wire a Spring MVC Interceptor using annotations? <p>Is it possible to wire a Spring MVC Interceptor using annotations and if so could someone provide me with an example of how to do so?</p>

<p>By wire via annotation I am referring to doing as little in the XML configuration as possible. For example in this configuration file I found at <a href="http://www.vaannila.com/spring/spring-interceptors.html">http://www.vaannila.com/spring/spring-interceptors.html</a>;</p>

<pre><code>&lt;bean class="org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping" p:interceptors-ref="loggerInterceptor" /&gt;
&lt;bean id="loggerInterceptor" class="com.vaannila.interceptor.LoggerInterceptor" /&gt;
</code></pre>

<p>How little configuration could you get away with there? I imagine an <code>@Autowired</code> would remove the need to explicitly declare the bean in line 2, but would it be possible to get rid of line 1 with an annotation as well?</p>
 How do I use a circuit breaker? <p>I'm looking for ways to make remote calls to services out of my control until a connect is successful. I also don't want to simply set a timer where an action gets executed every <em>n</em> seconds/minutes until successful. After a bunch of research it appears that the circuit breaker pattern is a great fit.</p>

<p>I found an <a href="http://davybrion.com/blog/2009/07/protecting-your-application-from-remote-problems/" rel="nofollow">implementation</a> that uses an Castle Windsor interceptor, which looks awesome. The only problem is I don't know how to use it. From the few articles I found regarding the topic the only usage example I was able to find was to simply use the circuit breaker to call an action only <em>once</em>, which doesn't seem very useful. From that it seems I need to simply run my action using the circuit breaker in a <code>while(true)</code> loop. </p>

<p>How do I use the Windsor interceptor to execute an action making a call to an external service until it is successful without slamming our servers?</p>

<p>Could someone please fill in the missing pieces?</p>

<h3>Here is what I was able to come up with</h3>

<pre><code>while(true)
{
    try
    {
        service.Subscribe();
        break;
    }
    catch (Exception e)
    {
        Console.WriteLine("Gotcha!");

        Thread.Sleep(TimeSpan.FromSeconds(10));
    }
}

Console.WriteLine("Success!");

public interface IService
{
    void Subscribe();
}

public class Service : IService
{
    private readonly Random _random = new Random();

    public void Subscribe()
    {
        var a = _random.Next(0, 10) % 2421;
        if(_random.Next(0, 10) % 2 != 0)
            throw new AbandonedMutexException();
    }
}
</code></pre>

<p>Based on that I think I now understand this concept as well as how to apply it.</p>
 Filters vs Interceptors in Struts 2 <p>What's the difference, really, between filters and interceptors?  I realize that interceptors fire before and after an action, recursively, and filters can be configured to fire on actions and on certain url patterns.  But how do you know when to use each one?</p>

<p>In the book I'm reading on Struts 2, it seems that interceptors are being pushed and I even followed a tutorial to write an Authentication Interceptor to make sure a user is logged in.  However, if the user tries to access a URL that doesn't have an action associated with it, the interceptor doesn't catch it, which means I'd have to associate an action with every jsp that I want to be secure.  That doesn't seem right.</p>

<p>I can make an Authentication Filter that handles URLs so that I don't have to do that, but then, what's the point of interceptors?</p>
 How can I intercept execution of all the methods in a Java application using Groovy? <p>Is it possible to intercept all the methods called in a application? I'd like to do something with them, and then let them execute. I tried to override this behaviour in <code>Object.metaClass.invokeMethod</code>, but it doesn't seem to work. </p>

<p>Is this doable?</p>
 how to get authenticated user id from wcf in nhibernate <p>Hi
I have implemented NHibernate custom context (ICurrentSessionContext).
In this context I inject the NHibernate session so I have Session per call pattern setup.
Ok, now I have made an interceptor that takes userId of the current logged user.
Now I do this:</p>

<pre><code>public ISession CurrentSession()
{
  // Get the WCF InstanceContext:
  var contextManager = OperationContext.Current.InstanceContext.Extensions.Find&lt;NHibernateContextManager&gt;();
  if (contextManager == null)
  {
    throw new InvalidOperationException(
      @"There is no context manager available.
      Check whether the NHibernateContextManager is added as InstanceContext extension.
      Make sure the service is being created with the NhServiceHostFactory.
      This Session Provider is intended only for WCF services.");
   }

   var session = contextManager.Session;
   AuditLogInterceptor interceptor = new AuditLogInterceptor();
   if (session == null)
   {
     session = this._factory.OpenSession(interceptor);
     interceptor.Session = session;

     contextManager.Session = session;
   }

   return contextManager.Session;
}
</code></pre>

<p>My AuditLogInterceptor takes UserId but I don't know how (from where) to get this userId.
Please help.</p>
 Using EJB interceptors after a method call <p>I know one can use interceptors before a method call by using the @AroundInvoke annotation.</p>

<p>What I would like to do is execute certain code after the method call, so that I can for example create a log entry before and after a method execution.</p>

<p>Is this possible with EJB3, or do I need to use AOP?</p>
 Exception handler in Spring MVC <p>I want to create an exception handler which will intercept all controllers in my project. Is that possible to do? Looks like I have to put a handler method in each controller. Thanks for your help. I have a spring controller that sends Json response. So if an exception happens I want to send an error response which can be controlled from one place.</p>
 Where and how to use interceptors in web application? <p>I am interested in interceptor concept in recent times. I know that this concept is used in many libraries like NHibernate, Entity Framework and others. But i am interested in how to use this concept in ASP.NET MVC web application. </p>

<p>Where it is usefull to use it in Mvc Web application? </p>

<p>Is there any open source Asp.Net Mvc project which use interceptors ?</p>

<p>Asp.net Mvc already support a kind of interceptor for controller with filters. It is better to use filters instead of interceptors ? </p>
 NHibernate: Meaning of interceptors return value <p>I think this is an easy question, but my googling is weak on this.</p>

<p>I had the problem described in the following link with regard to a generated ID and cascading:</p>

<p>https://www.hibernate.org/hib_docs/nhibernate/html/example-parentchild.html (towards the bottom)</p>

<p>I fixed it using their suggested method of an Interceptor.  Everything appears to be working, so I am happy.</p>

<p>That said, I have no idea what the significance of the return value is from methods such as:</p>

<pre><code>    public override bool OnLoad(object entity, object id, object[] state, string[] propertyNames, IType[] types)
    {
        if (entity is Persistent) ((Persistent)entity).OnLoad();
        return false;
    }

    public override bool OnSave(object entity, object id, object[] state, string[] propertyNames, IType[] types)
    {
        if (entity is Persistent) ((Persistent)entity).OnSave();
        return false;
    }
</code></pre>

<p>In both cases false is returned.</p>

<p>When I google about NHibernate Interceptors I see plenty of examples of how to write one.  Some instead return true (<a href="http://www.lostechies.com/blogs/rhouston/archive/2008/03/27/creating-a-timestamp-interceptor-in-nhibernate.aspx" rel="nofollow">http://www.lostechies.com/blogs/rhouston/archive/2008/03/27/creating-a-timestamp-interceptor-in-nhibernate.aspx</a>).  I have no idea what the difference is here.  My code is working, but Interceptors seem useful to me so I'd like to have a better understanding.</p>
 StructureMap Interceptors <p>I have a bunch of services that implement various interfaces. eg, IAlbumService, IMediaService etc.</p>

<p>I want to log calls to each method on these interfaces. How do I do this using StructureMap?</p>

<p>I realise this is pretty much the same as this <a href="http://stackoverflow.com/questions/420891/how-do-i-tell-windsor-to-add-an-interceptor-to-all-components-registered-that-imp">question</a> it is just that I am not using windsor.</p>
 How do you chain beforeInterceptors together? <p>I have a controller that inherits from a class with a <code>beforeInterceptor</code>.</p>

<p>Here is my base class.</p>

<pre><code>class FooBase {
    def beforeInterceptor = [action: {parentInterceptor()}]

    def parentInterceptor() {
        render("Snarge")
    }
}
</code></pre>

<p>Here is the version of the controller that does not work.</p>

<pre><code>class BrokenController extends FooBase
{
    def beforeInterceptor = [action: {childInterceptor()}]

    def childInterceptor() {
        super.beforeInterceptor.action.call()
        render("Bar")
    }

    def index = {
        render("Foo")
    }
}
</code></pre>

<p>Here is a version that <em>does</em> work</p>

<pre><code>class WorkingController extends FooBase
{
    def beforeInterceptor = {
        super.beforeInterceptor.action.call()
        render("Bar")
    }

    def index = {
        render("Foo")
    }
}
</code></pre>

<p>When I call index on <code>WorkingController</code>, I get the output <code>SnargeBarFoo</code>.  When I call index on <code>BrokenController</code> I get an <code>IllegalAccessError</code></p>

<p>I suppose I have a version that works, so my question is more about what is going on here?  Why can one version access the parent class from the child class, but the other cannot?</p>

<p>The use case I'm looking for is being able to use the interceptor functions with the <code>except</code> functionality.  That requires being able to chain interceptors when they are implemented using a map. </p>
 setting no cache for different parts of spring mvc 3 using WebContentInterceptor? <p>Hi there I have developed a dynamic web application that uses Ajax to fetch data from databases and keep the GUI up to date but while testing it with IE8 I am experiencing caching issues.</p>

<p>I used the following code in my webmvc-config.xml file to stop the browser from caching:</p>

<p><code>&lt;mvc:annotation-driven /&gt;
    &lt;mvc:interceptors&gt;
        &lt;bean id="webContentInterceptor" 
          class="org.springframework.web.servlet.mvc.WebContentInterceptor"&gt;
        &lt;property name="cacheSeconds" value="0"/&gt;
        &lt;property name="useExpiresHeader" value="true"/&gt;
        &lt;property name="useCacheControlHeader" value="true"/&gt;
        &lt;property name="useCacheControlNoStore" value="true"/&gt;
    &lt;/bean&gt;
    &lt;/mvc:interceptors&gt;</code></p>

<p>and it works exactly as it should, but the problem is that now the browser obviously doesn't cache anything.  what I want to know is how to modify that xml code so that it applies to the Ajax parts of the web app (which are controlled using 5 Controller files); so that the icons..etc are still cached? The path to these controller files would be something like "/admin/**"</p>

<p>I know that the Spring WebContentInterceptor has properties such as "setCacheMappings" and "setPathMatcher" but there is nowhere online that I can find examples of these being using in the xml config file.</p>

<p>ANY help would be much appreciated, it's really doing my head in.. Thanks. Jake</p>
 Ninject Interception - breaking changes when porting to Ninject 3.0 <p>I will describe my environment: I have Ninject + Ninject Interception Extension working to enable auto registration of interceptors for all methods, marked with a special attribute. It is a common AoP + attributes + DI container scenario.</p>

<p>My problem is:
When porting to latest version of Ninject and Ninject Interception Extension - 3.0 I start to get an exception when my interceptors are supposed to run. My InterceptorRegistrationStrategy works fine when resolving the attributed type and registering interceptors. But running the intercepted method results in following exception:</p>

<pre><code>System.ArgumentException : Interface not found.
at System.RuntimeTypeHandle.VerifyInterfaceIsImplemented(RuntimeTypeHandle handle, RuntimeTypeHandle interfaceHandle)
at System.RuntimeType.GetInterfaceMap(Type ifaceType)
at Ninject.Extensions.Interception.Advice.Advice.MatchesMethod(IProxyRequest request)
at System.Linq.Enumerable.WhereListIterator`1.MoveNext()
at System.Collections.Generic.List`1..ctor(IEnumerable`1 collection)
at System.Linq.Enumerable.ToList(IEnumerable`1 source)
at Ninject.Extensions.Interception.Registry.AdviceRegistry.GetInterceptorsForRequest(IProxyRequest request)
at Ninject.Extensions.Interception.Registry.AdviceRegistry.GetInterceptors(IProxyRequest request)
at Ninject.Extensions.Interception.Wrapper.StandardWrapper.CreateInvocation(IProxyRequest request)
at Ninject.Extensions.Interception.Wrapper.DynamicProxyWrapper.Intercept(IInvocation castleInvocation)
at Castle.DynamicProxy.AbstractInvocation.Proceed()
at Infrastructure.Tests.Persistance.Conversations.NinjectConversationInterceptorBehavior.ShouldCreateInterceptorOnImplicitConversation() in NinjectConversationInterceptorBehavior.cs: line 74 
</code></pre>

<p>I'm kinda left to resort to Reflector and using Ninject Interception Extension sources to do something about this problem, paired with not enough documentation it leaves me in a bad position.</p>

<p>Anyone got the same exception when porting to Ninject 3.0?</p>

<p>Here's the code I use to register the interceptors based on the attribute automatically:</p>

<pre><code>public class NinjectConversationInterceptorRegistrationStrategy : InterceptorRegistrationStrategy
{
    public NinjectConversationInterceptorRegistrationStrategy(IAdviceFactory adviceFactory,
                                                              IAdviceRegistry adviceRegistry)
        : base(adviceFactory, adviceRegistry)
    {
    }

    public override void Execute(IPlan plan)
    {
        var pcAttribute = plan.Type.GetOneAttribute&lt;PersistenceConversationalAttribute&gt;();

        if (pcAttribute != null)
        {
            if (pcAttribute.MethodsIncludeMode == MethodsIncludeMode.Implicit)
            {
                foreach (var mi in GetCandidateMethods(plan.Type))
                {
                    RegisterMethodInterceptors(plan.Type, mi);
                    if (!plan.Has&lt;ProxyDirective&gt;())
                    {
                        plan.Add(new ProxyDirective());
                    }
                }
            }
            else
            {
                foreach (
                    var mi in
                        GetCandidateMethods(plan.Type).Where(
                            mi =&gt; mi.HasAttribute&lt;PersistenceConversationAttribute&gt;()))
                {
                    if (!mi.IsVirtual)
                    {
                        throw new InvalidOperationException(
                            string.Format("[PersistentCoversation] attribute used on non-virtual method {0}.{1}",
                                          mi.DeclaringType.Name,
                                          mi.Name));
                    }
                    RegisterMethodInterceptors(plan.Type, mi);
                    if (!plan.Has&lt;ProxyDirective&gt;())
                    {
                        plan.Add(new ProxyDirective());
                    }
                }
            }
        }
    }

    protected virtual void RegisterMethodInterceptors(Type type, MethodInfo method)
    {
        IAdvice advice = this.AdviceFactory.Create(method);
        advice.Callback = GetIntercepor;
        this.AdviceRegistry.Register(advice);
    }

    protected virtual IInterceptor GetIntercepor(IProxyRequest arg)
    {
        var interceptor = new NinjectConversationLazyInterceptor(arg.Kernel);
        return interceptor;
    }

    protected override bool ShouldIntercept(MethodInfo methodInfo)
    {
        if (IsPropertySetter(methodInfo))
        {
            return false;
        }
        var ret = base.ShouldIntercept(methodInfo);
        return ret;
    }

    private static bool IsPropertySetter(MethodBase methodInfo)
    {
        return methodInfo.IsSpecialName &amp;&amp; methodInfo.Name.StartsWith("set_");
    }
}
</code></pre>
 Apache CXF - Set HTTP header <p>I have to set some http header fields in a Apache CXF client:</p>

<p>I tried it via Interceptor:</p>

<pre><code>    public class HttpHeaderInterceptor extends AbstractPhaseInterceptor&lt;Message&gt; {

    private String userId;
    private String xAuthorizeRoles;
    private String host;


    public HttpHeaderInterceptor() {
        super(Phase.POST_PROTOCOL);
    }

    @Override
    public void handleMessage(Message message) throws Fault {
        Map&lt;String, List&gt; headers = (Map&lt;String, List&gt;) message.get(Message.PROTOCOL_HEADERS);
        try {
            System.out.println("HttpHeaderInterceptor Host: " + host + " UserId: " + userId + " X-AUTHORIZE-roles: " + xAuthorizeRoles);
            headers.put("Host", Collections.singletonList(host));
            headers.put("UserId", Collections.singletonList(userId));
            headers.put("X-AUTHORIZE-roles", Collections.singletonList(xAuthorizeRoles));
        } catch (Exception ce) {
            throw new Fault(ce);
        }
    }

    public void setUserId(String userId) {
        this.userId = userId;
    }

    public void setxAuthorizeRoles(String xAuthorizeRoles) {
        this.xAuthorizeRoles = xAuthorizeRoles;
    }

    public void setHost(String host) {
        this.host = host;
    }
}
</code></pre>

<p>in my dynamic client class the methode:</p>

<pre><code>public void setHttHeaderInterceptor(String userId, String xAuthorizeRoles){
    Client cxfClient = ClientProxy.getClient(this.abgWebServicePort);
    HttpHeaderInterceptor httpHeaderInterceptor = new HttpHeaderInterceptor();
    httpHeaderInterceptor.setHost("example.org");
    httpHeaderInterceptor.setUserId(userId);
    httpHeaderInterceptor.setxAuthorizeRoles(xAuthorizeRoles);
    cxfClient.getOutInterceptors().add(httpHeaderInterceptor);
}
</code></pre>

<p>is called before I invoke the remote service:</p>

<p>For each call the userId and the xAuthorizeRoles should vary but when I inspect by calls via tcpdump all calls have the same values in the header fields.</p>

<p>Any ideas?</p>
 NHibernate IInterceptor implementation(add properties to DB table that original domain class doesn't have) <p>How is possible to set some special column values when update/insert entities via NHibernate without extending domain classes with special properties?</p>

<p>for example: in my case i would like to get object and just moment before update/insert db add to that object some additional information (like user id or computer name) by using IInterceptor.In other words i would like to add few columns to DB Table with no specifying new properties in original object's class. Do i have to configure/change/add to my Object.hbm.xml or App.config in that case?
The problem is that i can't change my original objects and base classes.So i have to figure out if possible to add information to DB table with no changing of original objects(even no inherit from any base classes)</p>

<p>Example:</p>

<p>Original Object has : FirstName ,LastName,Birthday,Address properties</p>

<p>Customer.hbm.xml has:</p>

<p>


</p>

<p>My Interceptor class has method:</p>

<p>public bool OnSave(object entity, object id, object[] state, string[] propertyNames, NHibernate.Type.IType[] types)</p>

<p>at that moment or even maybe before save i have to add to the DB Customer table additional 2 columns (Computer Name and User Name for example ) that propertyNames[] and state[] parameters don't have them from the beginning,so that shuld be done on the fly.</p>

<p>MY DB Customer table has all the columns that i have described above.</p>

<p>Thank you.</p>
 NHibernate Interceptor - What is it <p>I am new in NHibernate, you can say I am almost at dummy level :( . What I want to know is that what is NHibernate Interceptor, and for what purpose does it serve in an application?</p>

<p>Also, <a href="http://msdn.microsoft.com/en-us/magazine/ee819139.aspx" rel="nofollow">in this article</a>, I learned that using NHibernate makes a desktop application slower at startup, so to avoid this, I need to save the configuration in a file, and later load it from the saved file. How can I do that? I didn't find anything specific in that tutorial</p>
 nhibernate dynamically bind a class <p>Hey, So I may be completely off the mark here but I'm still new to nhibernate so bare with me.</p>

<p>I've read this article </p>

<p><a href="http://www.mattfreeman.co.uk/2009/01/nhibernate-21-trunk-entity-name-some-inheritance-and-dynamic-component/" rel="nofollow">http://www.mattfreeman.co.uk/2009/01/nhibernate-21-trunk-entity-name-some-inheritance-and-dynamic-component/</a></p>

<p>And am looking for a way to dynamically change my mapping at runtime to bind to a different table using a one-to-many dependent on a value in my parent object.</p>

<p>Here are my mappings</p>

<pre><code> &lt;bag name="Data" mutable="true" &gt;
     &lt;key&gt;
       &lt;column name="Log_Link" /&gt;
       &lt;column name="channel" /&gt;
     &lt;/key&gt;
   &lt;one-to-many class="Fluent.Entities.Meters.FTIMeterChannelData, Poco" entity-name="30" /&gt;
 &lt;/bag&gt;
</code></pre>

<p>and</p>

<pre><code>&lt;hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" default-access="property" auto-import="true" default-cascade="none" default-lazy="true"&gt;
  &lt;class xmlns="urn:nhibernate-mapping-2.2" mutable="true" name="Fluent.Entities.Meters.FTIMeterChannelData, Poco" table="loggerData" entity-name="30"&gt;
    &lt;composite-id mapped="false" unsaved-value="undefined"&gt;
      &lt;key-property name="Channel" type="System.Int32"&gt;
        &lt;column name="channel" /&gt;
      &lt;/key-property&gt;
      &lt;key-property name="LogLink" type="System.Int32"&gt;
        &lt;column name="Log_Link" /&gt;
      &lt;/key-property&gt;
    &lt;/composite-id&gt;
    &lt;property name="Date" type="System.DateTime"&gt;
      &lt;column name="hhdate" /&gt;
    &lt;/property&gt;
  &lt;/class&gt;

  &lt;class xmlns="urn:nhibernate-mapping-2.2" mutable="true" name="Fluent.Entities.Meters.FTIMeterChannelData, Poco" table="loggerData10" entity-name="15"&gt;
    &lt;composite-id mapped="false" unsaved-value="undefined"&gt;
      &lt;key-property name="Channel" type="System.Int32"&gt;
        &lt;column name="channel" /&gt;
      &lt;/key-property&gt;
      &lt;key-property name="LogLink" type="System.Int32"&gt;
        &lt;column name="Log_Link" /&gt;
      &lt;/key-property&gt;
    &lt;/composite-id&gt;
    &lt;property name="ReadingType" type="System.Char"&gt;
      &lt;column name="readingtype" /&gt;
    &lt;/property&gt;
  &lt;/class&gt;
&lt;/hibernate-mapping&gt;
</code></pre>

<p>now as the article states I should be able to change the entity name using an interceptor</p>

<pre><code> class LoggerDataInterceptor : EmptyInterceptor
    {
        public override string GetEntityName(object entity)
        {
            return Convert.ToString("20");
        }
    }
</code></pre>

<p>Now the question is two fold.</p>

<p>Firstly I can't seem to get this interceptor to fire, despite declaring it when opening my session, and secondly am I completely barking mad and is this never going to work?</p>
 In Castle Windsor, can I register a Interface component and get a proxy of the implementation? <p>Lets consider some cases:</p>

<pre><code>_windsor.Register(Component.For&lt;IProductServices&gt;().ImplementedBy&lt;ProductServices&gt;().Interceptors(typeof(SomeInterceptorType));
</code></pre>

<p>In this case, when I ask for a IProductServices  windsor will proxy the interface to intercept  the interface method calls.
If instead I do this :</p>

<pre><code>_windsor.Register(Component.For&lt;ProductServices&gt;().Interceptors(typeof(SomeInterceptorType));
</code></pre>

<p>then I cant ask for windsor to resolve IProductServices, instead I ask for ProductServices and it will return a dynamic subclass that will intercept virtual method calls.
Of course the dynamic subclass still implements 'IProductServices'</p>

<p>My question is : Can I register the Interface component like the first case, and get the subclass proxy like in the second case?. </p>

<p>There are two reasons  for me wanting this:<br>
1 - Because the code that is going to resolve cannot know about the ProductServices class, only about the IProductServices interface.
2 - Because some event invocations that pass the sender as a parameter, will pass the ProductServices object, and in the first case this object is a field on the dynamic proxy, not the real object returned by windsor. Let me give an example of how this can complicate things : Lets say I have a custom collection that does something when their items notify a property change:</p>

<pre><code>private void ItemChanged(object sender, PropertyChangedEventArgs e)
    {
        int senderIndex = IndexOf(sender);
        SomeActionOnItemIndex(senderIndex);
    }
</code></pre>

<p>This code will fail if I added an interface proxy, because the sender will be the field in the interface proxy and the IndexOf(sender) will return -1.</p>
 Add objects to association in OnPreInsert, OnPreUpdate <p>I have an event listener (for Audit Logs) which needs to append audit log entries to the association of the object:</p>

<pre><code>public Company : IAuditable {
    // Other stuff removed for bravety
    IAuditLog IAuditable.CreateEntry() {
        var entry = new CompanyAudit();
        this.auditLogs.Add(entry);
        return entry;
    }
    public virtual IEnumerable&lt;CompanyAudit&gt; AuditLogs {
        get { return this.auditLogs }
    }
}
</code></pre>

<p>The <code>AuditLogs</code> collection is mapped with <strong>cascading</strong>:</p>

<pre><code>public class CompanyMap : ClassMap&lt;Company&gt; {
    public CompanyMap() {
        // Id and others removed fro bravety
        HasMany(x =&gt; x.AuditLogs).AsSet()
            .LazyLoad()
            .Access.ReadOnlyPropertyThroughCamelCaseField()
            .Cascade.All();
    }
}
</code></pre>

<p>And the listener just asks the auditable object to create log entries so it can update them:</p>

<pre><code>internal class AuditEventListener : IPreInsertEventListener, IPreUpdateEventListener {
    public bool OnPreUpdate(PreUpdateEvent ev) {
        var audit = ev.Entity as IAuditable;
        if (audit == null)
            return false;
        Log(audit);
        return false;
    }


    public bool OnPreInsert(PreInsertEvent ev) {
        var audit = ev.Entity as IAuditable;
        if (audit == null)
            return false;

        Log(audit);
        return false;
    }
    private static void Log(IAuditable auditable) {
        var entry = auditable.CreateAuditEntry();  // Doing this for every auditable property
        entry.CreatedAt = DateTime.Now;
        entry.Who = GetCurrentUser(); // Might potentially execute a query as it links current user with log entry
        // Also other information is set for entry here
    }
}
</code></pre>

<p>The problem with it though is that it throws <code>TransientObjectException</code> when commiting the transaction:</p>

<pre><code>NHibernate.TransientObjectException : object references an unsaved transient instance - save the transient instance before flushing. Type: CompanyAudit, Entity: CompanyAudit
    at NHibernate.Engine.ForeignKeys.GetEntityIdentifierIfNotUnsaved(String entityName, Object entity, ISessionImplementor session)
    at NHibernate.Type.EntityType.GetIdentifier(Object value, ISessionImplementor session)
    at NHibernate.Type.ManyToOneType.NullSafeSet(IDbCommand st, Object value, Int32 index, Boolean[] settable, ISessionImplementor session)
    at NHibernate.Persister.Collection.AbstractCollectionPersister.WriteElement(IDbCommand st, Object elt, Int32 i, ISessionImplementor session)
    at NHibernate.Persister.Collection.AbstractCollectionPersister.PerformInsert(Object ownerId, IPersistentCollection collection, IExpectation expectation, Object entry, Int32 index, Boolean useBatch, Boolean callable, ISessionImplementor session)
    at NHibernate.Persister.Collection.AbstractCollectionPersister.Recreate(IPersistentCollection collection, Object id, ISessionImplementor session)
    at NHibernate.Action.CollectionRecreateAction.Execute()
    at NHibernate.Engine.ActionQueue.Execute(IExecutable executable)
    at NHibernate.Engine.ActionQueue.ExecuteActions(IList list)
    at NHibernate.Engine.ActionQueue.ExecuteActions()
    at NHibernate.Event.Default.AbstractFlushingEventListener.PerformExecutions(IEventSource session)
    at NHibernate.Event.Default.DefaultFlushEventListener.OnFlush(FlushEvent event)
    at NHibernate.Impl.SessionImpl.Flush()
    at NHibernate.Transaction.AdoTransaction.Commit()
</code></pre>

<p>As the <strong>cascading is set to All</strong> I expected NH to handle this. I also tried to modify the collection using <code>state</code> but pretty much the same happens.</p>

<p>So the question is <strong>what is the last chance to modify object's associations before it gets saved</strong>?</p>

<p>Thanks,<br>
Dmitriy.</p>
 nhibernate intercept select query <p>I'm looking at the nhibernate interceptor. It seems to be able to intercept save, update and delete queries but is there anyway I can intercept a select query.</p>

<p>The problem I have is that I automatically want to append some additional sql filters to the executing sql statement in certain cases.</p>

<p>Any thoughts</p>

<p>Thanks
Mat</p>
 Is is possible to intercept a static method on an object you don't own and did not create? <p>Referring to my possible answer to this question: <a href="http://stackoverflow.com/questions/2907535/how-would-you-audit-asp-net-membership-tables-while-recording-what-user-made-the/2911616#2911616">http://stackoverflow.com/questions/2907535/how-would-you-audit-asp-net-membership-tables-while-recording-what-user-made-the/2911616#2911616</a></p>

<p>Is it possible to intercept a call, coming from code you do not own, to a ctor on a sealed internal class that you do not own with the intention of manipulating the object before returning?</p>

<p>Concrete example:</p>

<p><code>SqlMembershipProvider</code>, for all of it's data access, instantiates a connection helper class, <code>System.Web.DataAccess.SqlConnectionHolder</code>.  </p>

<p>The desired result is to intercept this instantiation and perform an operation on the public connection that is opened in the ctor of <code>System.Web.DataAccess.SqlConnectionHolder</code> before letting execution continue.</p>

<p><strong>UPDATE:</strong>
So, as leppie observed regarding my example, what I say I want isn't what I want at all.</p>

<p>The target is now <code>System.Web.DataAccess.SqlConnectionHelper.GetConnection()</code></p>

<p>So, can we intercept the call to this method?</p>

<pre><code>internal static SqlConnectionHolder GetConnection(string connectionString, bool revertImpersonation)
</code></pre>

<p>Is this possible. If so, an brief example would be appreciated.</p>
 Redirect to another action in an interceptor in struts 2 <p>I am currently in the process of learning Struts 2 and I am currently building a simple application where unverified users are redirected to a login form.</p>

<p>I have a login form and action functional which takes the users credentials, verifies them and stores a User object in the session however I am now trying to prevent access to pages before the login has taken place and I am trying to do this with an interceptor.</p>

<p>My problem is that I have written an interceptor that checks whether the User object has been saved in the session but if it has not I want to redirect to the login page and can't find any way of doing this without bypassing struts and using the HttpServletResponse.sendRedirect method </p>

<p>Configuration: </p>

<pre><code>&lt;package name="mypackage" extends="struts-default" namespace="/admin"&gt;

    &lt;interceptors&gt;
        &lt;interceptor name="login" class="my.LoginInterceptor" /&gt;
    &lt;/interceptors&gt;

    &lt;default-interceptor-ref name="login"/&gt;

    &lt;action name="login" class="my.LoginAction"&gt;
        &lt;result name="input"&gt;/admin/login.jsp&lt;/result&gt;
        &lt;result name="success" type="redirect"&gt;/admin&lt;/result&gt;
    &lt;/action&gt;

    &lt;action name="private" class="my.PrivateAction"&gt;
        &lt;result&gt;/admin/private.jsp&lt;/result&gt;
    &lt;/action&gt;

&lt;/package&gt;
</code></pre>

<p>The interceptor code:</p>

<pre><code>@Override
public String intercept(ActionInvocation inv) throws Exception {

    Map&lt;String, Object&gt; session = inv.getInvocationContext().getSession();

    Object user = session.get("user");
    if(user == null) {

                      // redirect to the 'login' action here            

    }
    else {
        return inv.invoke();
    }

}
</code></pre>
 NHibernate inteceptor not called for changes in many-to-many set/list <p>I have an application that uses NHibrenate and I'm using an interceptor based solution for logging/auditing.</p>

<p>Basically I have a class inheriting from EmptyInterceptor and overriding OnFlushDirty, OnSave and OnDelete.</p>

<p>Everything works perfectly - except - when I add or remove from a set or list that is mapped using many-to-many without changing any other properties none of the interceptor methods are called.</p>

<p>How can I hook into NHibrenate and detect those changes?</p>

<p>The class looks like:</p>

<pre><code>public class SomeClass
{
  ... properties ..
  private Iesi.Collections.ISet _setOfOthers = new Iesi.Collections.HashedSet();
  public virtual Iesi.Collections.ISet SetOfOthers
  {
    get { return _setOfOthers; }
    set { _setOfOthers = value; }       
  }
  ... some more properties ...
</code></pre>

<p>}</p>

<p>With this hbm mapping:</p>

<pre><code>&lt;class name="MyAssembly.SomeClass, MyAssembly" table="[SomeClass]"&gt;
   ... properties ..
   &lt;set name="SetOfOthers" table="SomeClass_SetOfOthers" cascade="none"&gt;
      &lt;key column="Owner" /&gt;
      &lt;many-to-many column="Item" class="MyAssembly.OtherClass, MyAssembly" /&gt;
   &lt;/set&gt;
   .. some more properties ...
&lt;/class&gt;
</code></pre>

<p>I'm using NHibrenate 2.0.1 (if that makes any difference), this is not a good time in the project life cycle to upgrade NHibrenate - but I will upgrade if I absolutely have to.</p>

<p>Thanks.</p>
 What's the simplest way to intercept a method call for added functionality? <p>Suppose i have a repository that returns a list of <code>Post</code>s. The repository interface has a <code>GetAll()</code> method which does what it suggests.</p>

<p>Now in keeping with the theory that i shouldn't be putting domain logic in the repository, i want to intercept calls to the concrete <code>GetAll()</code> method such that i can add the following logic to the <code>GetAll()</code> result:</p>

<pre><code>return GetAll().OrderByDescending(p =&gt; p.Posted).ToList();
</code></pre>

<p>The reason i want to intercept this is because (1) i don't want to have the client remember to call an extension method (<code>OrderByDescending</code> or some useless wrapper of that), i want it called every time and (2) i don't want to have all my concrete implementations have to remember to order the <code>GetAll()</code> result - i want this logic in a single place external to any repository.</p>

<p>What's the easiest way to do this?</p>

<p>I'm already using <a href="http://structuremap.net/structuremap/" rel="nofollow">StructureMap</a> so if i can intercept with this it might be a low cost option. But i don't think SM intercepts method calls, just the creation of the object instance?</p>

<p>Do i need to go to a <a href="http://msmvps.com/blogs/jon_skeet/archive/2007/02/27/wacky-ideas-1-inheritance-is-dead-long-live-mix-ins.aspx" rel="nofollow">proxy or mixin</a> pattern? Do i need to go all-in with Castle <a href="http://kozmic.pl/dynamic-proxy-tutorial/" rel="nofollow">Dynamic Proxy</a>? Or is there <a href="http://ayende.com/Blog/archive/2007/07/02/7-Approaches-for-AOP-in-.Net.aspx" rel="nofollow">another method</a> i should consider or perhaps a combination?</p>

<p>I'm really interested in a concrete suggestion to my particular example above. I'm novice to AOP so please be gentle.</p>
 NHibernate AssertException: Interceptor.OnPrepareStatement(SqlString) returned null or empty SqlString <p>I am trying to switch a table from being a many-to-one mapping to being many-to-many with an intermediate mapping table. However, when I switched it over and tried to do a query on it with NHibernate, it's giving me this error: "Interceptor.OnPrepareStatement(SqlString) returned null or empty SqlString."</p>

<p>My query was originally something more complex, but I switched it to a basic fetch all and I'm still having the problem:</p>

<pre><code>Session.QueryOver&lt;T&gt;().Future();
</code></pre>

<p>It would seem to either be a problem in my model mapping files or something in my database.</p>

<p>Here are my model mappings:</p>

<pre><code>&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" assembly="GBI.Core" namespace="GBI.Core.Models"&gt;

&lt;class name="Market" table="gbi_Market"&gt;
    &lt;id name="Id" column="MarketId"&gt;
        &lt;generator class="identity" /&gt;
    &lt;/id&gt;
    &lt;property name="Name" /&gt;
    &lt;property name="Url" /&gt;
    &lt;property name="Description" type="StringClob" /&gt;
    &lt;property name="Rating" /&gt;
    &lt;property name="RatingComment" /&gt;
    &lt;property name="RatingCommentedOn" /&gt;
    &lt;many-to-one name="RatingCommentedBy" column="RatingCommentedBy" lazy="proxy"&gt;&lt;/many-to-one&gt;
    &lt;property name="ImageFilename" /&gt;
    &lt;property name="CreatedOn" /&gt;
    &lt;property name="ModifiedOn" /&gt;
    &lt;property name="IsDeleted" /&gt;

    &lt;many-to-one name="CreatedBy" column="CreatedBy" lazy="proxy"&gt;&lt;/many-to-one&gt;
    &lt;many-to-one name="ModifiedBy" column="ModifiedBy" lazy="proxy"&gt;&lt;/many-to-one&gt;

    &lt;set name="Content" where="IsDeleted=0 and ParentContentId is NULL" order-by="Ordering asc, CreatedOn asc, Name asc" lazy="extra"&gt;
        &lt;key column="MarketId" /&gt;
        &lt;one-to-many class="MarketContent" /&gt;
    &lt;/set&gt;

    &lt;set name="FastFacts" where="IsDeleted=0" order-by="Ordering asc, CreatedOn asc, Name asc" lazy="extra"&gt;
        &lt;key column="MarketId" /&gt;
        &lt;one-to-many class="MarketFastFact" /&gt;
    &lt;/set&gt;

    &lt;set name="NewsItems" table="gbi_NewsItem_Market_Map" lazy="true"&gt;
        &lt;key column="MarketId" /&gt;
        &lt;many-to-many class="NewsItem" fetch="join" column="NewsItemId" where="IsDeleted=0"/&gt;
    &lt;/set&gt;

    &lt;!--&lt;set name="MarketUpdates" table="gbi_Market_MarketUpdate_Map" lazy="extra"&gt;
        &lt;key column="MarketId" /&gt;
        &lt;many-to-many class="MarketUpdate" fetch="join" column="MarketUpdateId" where="IsDeleted=0" order-by="CreatedOn desc" /&gt;
    &lt;/set&gt;--&gt;

    &lt;set name="Documents" table="gbi_Market_Document_Map" lazy="true"&gt;
        &lt;key column="MarketId" /&gt;
        &lt;many-to-many class="Document" fetch="join" column="DocumentId" where="IsDeleted=0"/&gt;
    &lt;/set&gt;
&lt;/class&gt;
</code></pre>

<p></p>

<pre><code>&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" assembly="GBI.Core" namespace="GBI.Core.Models"&gt;

&lt;class name="MarketUpdate" table="gbi_MarketUpdate"&gt;
    &lt;id name="Id" column="MarketUpdateId"&gt;
        &lt;generator class="identity" /&gt;
    &lt;/id&gt;
    &lt;property name="Description" /&gt;
    &lt;property name="CreatedOn" /&gt;
    &lt;property name="ModifiedOn" /&gt;
    &lt;property name="IsDeleted" /&gt;

    &lt;!--&lt;many-to-one name="Market" column="MarketId" lazy="proxy"&gt;&lt;/many-to-one&gt;--&gt;

    &lt;set name="Comments" where="IsDeleted=0" order-by="CreatedOn desc" lazy="extra"&gt;
        &lt;key column="MarketUpdateId" /&gt;
        &lt;one-to-many class="MarketUpdateComment" /&gt;
    &lt;/set&gt;

    &lt;many-to-one name="CreatedBy" column="CreatedBy" lazy="proxy"&gt;&lt;/many-to-one&gt;
    &lt;many-to-one name="ModifiedBy" column="ModifiedBy" lazy="proxy"&gt;&lt;/many-to-one&gt;
&lt;/class&gt;
</code></pre>

<p></p>

<pre><code>&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" assembly="GBI.Core" namespace="GBI.Core.Models"&gt;

&lt;class name="MarketUpdateMarketMap" table="gbi_Market_MarketUpdate_Map"&gt;
    &lt;id name="Id" column="MarketUpdateMarketMapId"&gt;
        &lt;generator class="identity" /&gt;
    &lt;/id&gt;
    &lt;property name="CreatedOn" /&gt;
    &lt;property name="ModifiedOn" /&gt;
    &lt;property name="IsDeleted" /&gt;

    &lt;many-to-one name="CreatedBy" column="CreatedBy" lazy="proxy"&gt;&lt;/many-to-one&gt;
    &lt;many-to-one name="ModifiedBy" column="ModifiedBy" lazy="proxy"&gt;&lt;/many-to-one&gt;

    &lt;many-to-one name="MarketUpdate" column="MarketUpdateId" lazy="proxy"&gt;&lt;/many-to-one&gt;
    &lt;many-to-one name="Market" column="MarketId" lazy="proxy"&gt;&lt;/many-to-one&gt;
&lt;/class&gt;
</code></pre>

<p></p>

<p>As I mentioned, MarketUpdate was originally a many-to-one with Market (MarketId column is still in there, but I'm ignoring it. Could this be a problem?). But I've added in the Market_MarketUpdate_Map table to make it a many-to-many.</p>

<p>I'm running in circles trying to figure out what this could be. I couldn't find any reference to this error when searching. And it doesn't provide much detail.</p>

<p>Using:</p>

<p>NHibernate 2.2</p>

<p>.NET 4.0</p>

<p>SQL Server 2005</p>
 Configuring interceptor in Spring <p>I am using Spring 3.0 </p>

<p>I need to write an interceptor which intercepts all urls. in my application</p>

<p>I wrote one intercptor </p>

<pre><code>public class HelloInterceptor extends HandlerInterceptorAdapter {
</code></pre>

<p>how can i configure it in  spring-servlet.xml.</p>
 Proper mvc:interceptor configuration in Spring <p>i have kind of a problem. I need to call on each request postHandle method in this interceptor:</p>

<pre><code>public class DiMenuInterceptor extends HandlerInterceptorAdapter {

   @Autowired
   private IDiCategoryService categoryService;


   @Override
   public void postHandle(HttpServletRequest request,
        HttpServletResponse response, Object handler,
        ModelAndView modelAndView) throws Exception {

       modelAndView.addObject("category", categoryService.getCategoryInTree());
   }
}
</code></pre>

<p>so i put into servlet configuration this lines and everything work fine.</p>

<pre><code>&lt;bean class="org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping" p:interceptors-ref="menuInterceptor" /&gt;

&lt;bean id="menuInterceptor" class="cz.cosi.DiMenuInterceptor" /&gt;
</code></pre>

<p>But now i have to change configuration and use <code>&lt;mvc:interceptors&gt;</code></p>

<p>With this configuration i'am getting series of null pointer exception on modelAndView in postHandle method, becouse postHandle method is called more than once per request. </p>

<pre><code> &lt;mvc:interceptors&gt;
    &lt;bean class="cz.cosi.DiMenuInterceptor" /&gt;
 &lt;/mvc:interceptors&gt;
</code></pre>

<p>With this configuration it is working, but only for request serverAdress/anything. For request serverAdress/anything/something is postHandle not called.</p>

<pre><code>&lt;mvc:interceptors&gt;
   &lt;mvc:interceptor&gt;
     &lt;mvc:mapping path="/*" /&gt;
     &lt;bean class="cz.cosi.DiMenuInterceptor" /&gt;
   &lt;/mvc:interceptor&gt;
&lt;/mvc:interceptors&gt;
</code></pre>

<p>part of servlet configuration</p>

<pre><code>&lt;mvc:annotation-driven /&gt;

&lt;bean id="messageSource"
    class="org.springframework.context.support.ReloadableResourceBundleMessageSource"&gt;
    &lt;property name="basename" value="classpath:messages" /&gt;
    &lt;property name="defaultEncoding" value="UTF-8" /&gt;       

&lt;/bean&gt;

&lt;mvc:resources mapping="/css/**" location="/css/" /&gt;
&lt;mvc:resources mapping="/images/**" location="/images/" /&gt;
&lt;mvc:resources mapping="/js/**" location="/js/" /&gt;

&lt;mvc:interceptors&gt;
    &lt;bean class="cz.cosi.DiMenuInterceptor" /&gt;
&lt;/mvc:interceptors&gt;

&lt;tx:jta-transaction-manager /&gt;

&lt;tx:annotation-driven /&gt;

&lt;bean id="transactionManager"
    class="org.springframework.orm.hibernate3.HibernateTransactionManager"&gt;
    &lt;property name="sessionFactory" ref="sessionFactory" /&gt;
&lt;/bean&gt;
</code></pre>

<p>It seems, that the problem might somehow related to resources, because with exceptions are not properly loaded images, styles and javascripts. Without mvc:resources its working correctly, but this is not a solution. </p>

<p>My question is, how to properly configure DiMenuInterceptor with <code>&lt;mvc:interceptors&gt;</code>. Thanks very much for the advices.</p>

<p>stack: </p>

<pre><code>2011-04-14 09:56:02,487 [http-8080-3] DEBUG (FilterChainProxy.java:195) ? Converted URL to lowercase, from: '/images/core/users/super_admin.png'; to: '/images/core/users/super_admin.png'
2011-04-14 09:56:02,533 [http-8080-3] DEBUG (FilterChainProxy.java:202) ? Candidate is: '/images/core/users/super_admin.png'; pattern is /images/**; matched=true
2011-04-14 09:56:02,533 [http-8080-3] DEBUG (FilterChainProxy.java:158) ? /images/core/users/super_admin.png has an empty filter list
14.4.2011 9:56:02 org.apache.catalina.core.StandardWrapperValve invoke
SEVERE: Servlet.service() for servlet spring threw exception
java.lang.NullPointerException
    at cz.cosi.DiMenuInterceptor.postHandle(DiMenuInterceptor.java:41)
    at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:801)
    at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:719)
    at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:644)
    at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:549)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:617)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)
    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)
    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
    at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:88)
    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:76)
    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
    at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:163)
    at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:237)
    at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:167)
    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)
    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)
    at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)
    at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)
    at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:127)
    at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)
    at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)
    at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:298)
    at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:859)
    at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:588)
    at org.apache.tomcat.util.net.JIoEndpoint$Worker.run(JIoEndpoint.java:489)
    at java.lang.Thread.run(Thread.java:595)
</code></pre>

<p>Maybe i found a solution, but it is definitely not the best. For now it seems, that is working.</p>

<pre><code>&lt;mvc:interceptors&gt;
    &lt;mvc:interceptor&gt;
        &lt;mvc:mapping path="/*" /&gt;
        &lt;bean class="cz.cosi.DiMenuInterceptor" /&gt;
    &lt;/mvc:interceptor&gt;
    &lt;mvc:interceptor&gt;
         &lt;mvc:mapping path="/search/**" /&gt;
        &lt;bean class="cz.cosi.DiMenuInterceptor" /&gt;
    &lt;/mvc:interceptor&gt;

    &lt;mvc:interceptor&gt;
         &lt;mvc:mapping path="/context/**" /&gt;
        &lt;bean class="cz.cosi.DiMenuInterceptor" /&gt;
    &lt;/mvc:interceptor&gt;
    &lt;mvc:interceptor&gt;
          &lt;mvc:mapping path="/member/**" /&gt;
        &lt;bean class="cz.cosi.DiMenuInterceptor" /&gt;
    &lt;/mvc:interceptor&gt;

&lt;/mvc:interceptors&gt;
</code></pre>
 Why does audit logging using Hibernate Interceptor hang at SocketInputStream.socketRead0? <p>This is baffling to me.  I have searched numerous forums for clues.  In the postFlush method, I open a new hibernate (v. 3.3 - also tried v.3.5) session using a distinct session factory.  I use c3p0 v. 0.9 for connection pooling.  I start a new transaction, save the auditLog object, and commit the transaction.  This works beautifully for all my entities save one.  When attempting to commit the auditLog after deleting a ChemoRegimen entity, the application hangs (this also happens with create and update).  No exception is thrown, but upon suspending the thread I find the following stack trace (this is a Swing app):</p>

<pre><code>Thread [AWT-EventQueue-0] (Suspended)   
SocketInputStream.socketRead0(FileDescriptor, byte[], int, int, int) line: not available [native method]    
SocketInputStream.read(byte[], int, int) line: 129  
VisibleBufferedInputStream.readMore(int) line: 145  
VisibleBufferedInputStream.ensureBytes(int) line: 114   
VisibleBufferedInputStream.read() line: 73  
PGStream.ReceiveChar() line: 274    
QueryExecutorImpl.processResults(ResultHandler, int) line: 1660 
QueryExecutorImpl.execute(Query[], ParameterList[], ResultHandler, int, int, int) line: 407 
Jdbc4PreparedStatement(AbstractJdbc2Statement).executeBatch() line: 2737    
NewProxyPreparedStatement.executeBatch() line: 1723 
BatchingBatcher.doExecuteBatch(PreparedStatement) line: 70  
BatchingBatcher(AbstractBatcher).executeBatch() line: 268   
ActionQueue.executeActions(List) line: 266  
ActionQueue.executeActions() line: 167  
DefaultFlushEventListener(AbstractFlushingEventListener).performExecutions(EventSource) line: 321   
DefaultFlushEventListener.onFlush(FlushEvent) line: 50  
SessionImpl.flush() line: 1027  
SessionImpl.managedFlush() line: 365    
JDBCTransaction.commit() line: 137  **[This is where I commit the auditLog]**
MomsInterceptor.postFlush(Iterator) line: 254   
DefaultFlushEventListener(AbstractFlushingEventListener).postFlush(SessionImplementor) line: 375    
DefaultFlushEventListener.onFlush(FlushEvent) line: 51  
SessionImpl.flush() line: 1027  
SessionImpl.managedFlush() line: 365    
JDBCTransaction.commit() line: 137  
HibernateDAO.makeTransient(Entity) line: 119    
ChemoServices.deleteChemoRegimen(ChemoRegimen, String, Session) line: 290   
</code></pre>

<p>I am using PostgreSQL 8.4 as the backend with the 9.0 jdbc4 driver.  The postgresql.log shows [with my comments in brackets]:</p>

<p><strong>[First, the chemo_regimen is deleted]</strong><BR></p>

<pre><code>2011-05-11 12:19:06 CDT moms postgres LOG:  00000: execute &lt;unnamed&gt;: delete from moms_chemo_regimen where crxreg_id=$1&lt;BR&gt;
</code></pre>

<p>....<BR>
<strong>[A lot of cascaded deletes]</strong><BR>
...<BR>
<strong>[Then, my transaction begins in the interceptor session]</strong><BR></p>

<pre><code>2011-05-11 12:19:06 CDT moms postgres LOG:  00000: execute S_1: BEGIN
2011-05-11 12:19:06 CDT moms postgres LOG:  00000: execute &lt;unnamed&gt;: select nextval ('moms_patient_change_log_seq')
</code></pre>

<p><strong>[The audit-log record is inserted]</strong><BR></p>

<pre><code>2011-05-11 12:19:06 CDT moms postgres LOG:  00000: execute &lt;unnamed&gt;: insert into moms_patient_change_log (patclog_pat_id, patclog_action, patclog_reason, patclog_date, patclog_user_name, patclog_guid, patclog_id) values ($1, $2, $3, $4, $5, $6, $7)
2011-05-11 12:19:06 CDT moms postgres DETAIL:  parameters: $1 = '17108', $2 = 'Deleted ChemoRegimen ABVD', $3 = NULL, $4 = '2011-05-11 12:19:06.813', $5 = 'daver', $6 = 'BFAA9D91-7A4E-835E-7A57-B72B2A79A4F1', $7 = '520'
</code></pre>

<p>And that is it.  The audit-log insert transaction never completes. The transaction to delete the chemo-regimen also is never committed. I am able to perform CRUD on ChemoRegimen fine when not auditing it.  A snippet of the ChemoRegimen entity is below:</p>

<pre><code>public class ChemoRegimen extends MOMSEntity implements Auditable
{
  public static final String UNSCHEDULED = "UNSCHEDULED";

  private Date date = new Date();
  private Patient patient;
  private WorkingProtocol protocol;
  private Physician approvingPhysician;
  private boolean canChangeCycles;
  private List&lt;ChemoEncounter&gt; chemoEncounters = new ArrayList&lt;ChemoEncounter&gt;();
  private boolean complete;
  private Icdm icdm;&lt;BR&gt;
  ...&lt;BR&gt;
}
</code></pre>

<p>This is my interceptor:</p>

<pre><code>public class MomsInterceptor extends EmptyInterceptor
{
  private static Logger logger = Logger.getLogger( MomsInterceptor.class.getName() );
  private static Configuration configuration;
  private static SessionFactory sessionFactory;

//Create the initial SessionFactory from the default configuration files
  static
  {
    initSessionFactory();
  }

  public static void initSessionFactory()
  {
    try
    {
      configuration = new Configuration().configure();
      sessionFactory = configuration.buildSessionFactory();
    }
    catch ( Throwable ex )
    {
      // We have to catch Throwable, otherwise we will miss
      // NoClassDefFoundError and other subclasses of Error
      logger.severe( "Building SessionFactory failed - " + ex.getMessage() );
      System.err.println( "Building SessionFactory failed - " + ex.getMessage() );
      throw new ExceptionInInitializerError( ex.getMessage() );
    }
  }

  private Set&lt;Auditable&gt; inserts = new HashSet&lt;Auditable&gt;();
  private Set&lt;UpdatedEntity&gt; updates = new HashSet&lt;UpdatedEntity&gt;();
  private Set&lt;Auditable&gt; deletes = new HashSet&lt;Auditable&gt;();
  private boolean audit;

  public MomsInterceptor(boolean audit)
  {
    super();
    this.audit = audit;
  }

  private class UpdatedEntity
  {
    private Auditable auditable;
    private String[] propertyNames;
    private Object[] currentState;
    private Object[] previousState;
    private Type[] types;

    public UpdatedEntity( Auditable auditable, String[] propertyNames, Type[] types, Object[] currentState, Object[] previousState )
    {
      super();
      this.auditable = auditable;
      this.propertyNames = propertyNames;
      this.currentState = currentState;
      this.previousState = previousState;
      this.types = types;
    }

    public Auditable getAuditable()
    {
      return auditable;
    }

    public String[] getPropertyNames()
    {
      return propertyNames;
    }

    public Object[] getCurrentState()
    {
      return currentState;
    }

    public Object[] getPreviousState()
    {
      return previousState;
    }

    public Type[] getTypes()
    {
      return types;
    }

    /**
     * Return the previous value of the property name prop or null if the property name is not found.
     * @param prop
     * @return
     */
    public Object getPrevious( String prop )
    {
      int i = 0;
      for ( String name : propertyNames )
      {
        if ( prop.equals( name ) )
          return previousState[i];
        i++;
      }

      return null;
    }
  }

  public boolean onSave( Object entity, Serializable id, Object[] state, String[] propertyNames, Type[] types ) throws CallbackException
  {
    boolean modified = false;
    if ( entity instanceof MutableEntity ) // Update create info.
    {
      MutableEntity me = (MutableEntity)entity;
      int i = findPropertyNameIndex( "createUser", propertyNames );
      if ( i &gt;= 0 )
        state[i] = SessionController.userName;
      i = findPropertyNameIndex( "modifyUser", propertyNames );
      if ( i &gt;= 0 )
        state[i] = SessionController.userName;
      modified = true;

      if ( audit &amp;&amp; entity instanceof Auditable ) 
        inserts.add( (Auditable)entity );
    }

    return modified;
  }

  private int findPropertyNameIndex( String name, String[] propertyNames )
  {
    int i = -1;
    if ( propertyNames.length == 0 )
      return i;

    for ( String p : propertyNames )
    {
      i++;
      if ( p.equals( name ) )
        return i;
    }

    return -1;
  }

  public boolean onFlushDirty( Object entity, Serializable id, Object[] currentState, Object[] previousState, String[] propertyNames, Type[] types )
      throws CallbackException
  {
    boolean modified = false;

    if ( entity instanceof MutableEntity ) // Update modify info.
    {
      MutableEntity me = (MutableEntity)entity;
      int i = findPropertyNameIndex( "modifyUser", propertyNames );
      if ( i &gt;= 0 )
        currentState[i] = SessionController.userName;
      i = findPropertyNameIndex( "modifyDate", propertyNames );
      if ( i &gt;= 0 )
        currentState[i] = new Date();
      modified = true;

      if ( audit &amp;&amp; entity instanceof Auditable )
        updates.add( new UpdatedEntity( (Auditable)entity, propertyNames, types, currentState, previousState ) );
    }

    return modified;
  }

  @Override
  public void onDelete( Object entity, Serializable id, Object[] state, String[] propertyNames, Type[] types )
  {
    if ( audit &amp;&amp; entity instanceof Auditable )
      deletes.add( (Auditable)entity );
  }

  @Override
  public void postFlush( Iterator iterator ) throws CallbackException
  {
    if ( inserts.isEmpty() &amp;&amp; deletes.isEmpty() &amp;&amp; updates.isEmpty() )
      return;

    Session session = sessionFactory.openSession();
    session.setFlushMode( FlushMode.COMMIT );
    session.beginTransaction();

    try
    {
      String action = null;
      for ( Auditable entity : inserts )
      {
        action = "Created " + entity.getClass().getSimpleName() + " " + entity.toString();
        session.save( new PatientChangeLog( entity.getPatient(), action, entity.getReason(), SessionController.userName ) );
      }
      for ( Auditable entity : deletes )
      {
        action = "Deleted " + entity.getClass().getSimpleName() + " " + entity.toString();
        session.save( new PatientChangeLog( entity.getPatient(), action, entity.getReason(), SessionController.userName ) );
      }
      for ( UpdatedEntity entity : updates )
      {
        Auditable a = entity.getAuditable();
        StringBuffer actionBuf = new StringBuffer( "Updated " + a.getClass().getSimpleName() + " " + a.toString() + ": changed " );
        int count = 0;
        for ( int i = 0; i &lt; entity.getPropertyNames().length; i++ )
        {
          String prop = entity.getPropertyNames()[i];
          Type type = entity.getTypes()[i];
          Object curValue = entity.getCurrentState()[i];
          Object prevValue = entity.getPreviousState()[i];

          //Don't consider the id field or the metadata fields.
          if ( prop.equals( "id" ) || prop.equals( "createUser" ) || prop.equals( "createDate" ) || prop.equals( "modifyUser" ) 
              || prop.equals( "modifyDate" ) || prop.equals( "guid" ) )
            continue;

          if ( prevValue == null )
            prevValue = new String( "" );
          if ( curValue == null )
            curValue = new String( "" );
          if ( !prevValue.equals( curValue ) )
          {
            if ( count &gt; 0 )
              actionBuf.append( " and " );
            actionBuf.append( prop ).append( " from '" ).append( prevValue ).append( "' to '" ).append( curValue ).append( "'" );
            count++;
          }   
        }

        Patient p = (Patient)entity.getPrevious( "patient" );  //In case the patient is changed, tie it to the previous patient.
        session.save( new PatientChangeLog( p, actionBuf.toString(), a.getReason(), SessionController.userName ) );
      }

      session.getTransaction().commit();
    }
    catch ( HibernateException e )
    {
      try
      {
        session.getTransaction().rollback();
      }
      catch ( Exception hex )
      {
        throw new RuntimeException( hex );
      }
      throw new RuntimeException( e );
    }
    finally
    {
      inserts.clear();
      updates.clear();
      deletes.clear();
      session.close();
    }
  }
}
</code></pre>

<p>Any help would be greatly appreciated.</p>
 problem with i18n (internationalization) with Spring and Velocity <p>I am having a problem in setting up internationalization with Spring.
Here is my config.</p>

<pre><code>    &lt;bean id="messageSource"
            class="org.springframework.context.support.ResourceBundleMessageSource"&gt;
            &lt;property name="basename" value="localization" /&gt;
    &lt;/bean&gt;
    &lt;!-- declare the resolver --&gt;
    &lt;bean id="localeResolver"
            class="org.springframework.web.servlet.i18n.CookieLocaleResolver"&gt;
            &lt;property name="defaultLocale" value="sv" /&gt;
    &lt;/bean&gt;
    &lt;mvc:interceptors&gt;
            &lt;bean class="org.springframework.web.servlet.i18n.LocaleChangeInterceptor" /&gt;
    &lt;/mvc:interceptors&gt;
    &lt;mvc:annotation-driven /&gt;
</code></pre>

<p>It always showing me English even when I request with <code>?locale=sv</code> (Swedish). </p>

<p>I am using Spring with Velocity. </p>

<p>any idea?
thanks</p>
 Spring HandlerInterceptor vs Servlet Filters <p><a href="http://static.springsource.org/spring/docs/current/javadoc-api/org/springframework/web/servlet/HandlerInterceptor.html" rel="nofollow">HandlerInterceptor</a>s in Spring can now be configured to be invoked only on certain URLs using <code>&lt;mvc:interceptors&gt;</code>.</p>

<p>Servlet Filters can achieve same functionality (logging, security etc). So which one should be used?</p>

<p>I think with Interceptors, one can use <code>ModelAndView</code> object to work with Models so it has more advantages. Can anyone draw out scenarios where Filters or Interceptors have advantages over the other?</p>
 How to define order of method interceptors in Guice? <p>Sometimes there's a need to know the order of method interceptors that intercept a method call in Guice. A simple example scenario would be to use guice-persist provided @Transactional method interceptor with a custom @Retry method interceptor. The retry interceptor must be run outside of the transactional interceptor to make sure the retries are not executed within the same transaction.</p>

<p>In Spring you could use the Ordered interface for the interceptor to make sure the transaction interceptor is executed within the retry interceptor. Is there a way to achieve the same in Guice?</p>
 Interceptor in JSF <p>I want to know can we use interceptor in JSF ( like we use in spring ) . And how to do that?</p>
 Spring MVC 3, Interceptor on all excluding some defined paths <p>Is it possible to apply an interceptor to all controllers and actions, except some that are defined?</p>

<p>Just to be clear, I am not interested in applying an interceptor on a list of defined ones. I want to define those to exclude.</p>

<p>Thanks!</p>
 NHibernate interceptor / hook for Lazy-Loaded collections / Cascade <p>Lately I have had about enough of creating ViewModel boilerplate code, so I ended up adding the NotifyPropertyChanged-functionality to a DynamicProxy-based solution.</p>

<p>In order to have all of WPF's Changenotification mechanisms working for my implementation, all I have to do now is exchange my Collections with ObservableCollections, which unfortunately brings along a performance issue (change notification for every record added / removed, so not fit for bulk usage because UI gets way too busy trying to keep up with the list of changes).</p>

<p>Thus, In my models, collections of other models (HasMany relationships, that is) are not held within a list, but within a ObservableCollection-derivate that has two Methods <code>SuspendCollectionChangeNotification</code> and <code>ResumeCollectionChangeNotification</code> (A bit like the implementation shown <a href="http://stackoverflow.com/questions/7687000/fast-performing-and-thread-safe-observable-collection">here</a>).</p>

<p>The infrastructure is all there, now I'm looking for an Interceptor hook that enables me to call <code>Suspend()</code> before NHibernate Loads Child data and <code>Resume()</code> after it's done.</p>

<p>I'm a bit afraid I will end up adding this to the proxy I mentioned above, which has a good grasp of the properties that are being requested, but it would be just lovely to keep this in an NHibernate Interceptor...</p>
 Autofac using DynamicProxy2 Interception with WcfIntegration <p>I'm struggling to wire up a service interface using WcfIntegration with an IInterceptor.</p>

<p>There are examples for each in the autofac documentation but nothing that combines the two.</p>

<p>Here is the documentation for the <a href="http://code.google.com/p/autofac/wiki/WcfIntegration" rel="nofollow">WcfIntegration</a> and look here for the <a href="http://code.google.com/p/autofac/wiki/DynamicProxy2" rel="nofollow">DynamicProxy2</a>
documentation.</p>

<p>Has anyone successfully wired up an interceptor with WcfIntegration using Autofac?</p>

<p>Example code I'd have expected to work:</p>

<pre><code>            builder.Register(c =&gt; new CacheInterceptor())
            .Named&lt;IInterceptor&gt;("cache-calls");

        builder
            .RegisterType&lt;ChannelFactory&lt;IEnquiryService&gt;&gt;()
            .AsSelf()
            .WithParameter(new NamedParameter("endpointConfigurationName", "EnquiryService"))
            .SingleInstance();

        builder
            .Register(c =&gt; c.Resolve&lt;ChannelFactory&lt;IEnquiryService&gt;&gt;().CreateChannel())
            .As&lt;IEnquiryService&gt;()
            .EnableInterfaceInterceptors()
            .InterceptedBy("cache-calls");
</code></pre>

<p>EDIT: </p>

<p>Seems like a bug has been logged on <a href="http://code.google.com/p/autofac/issues/detail?id=361&amp;q=dynamicproxy2" rel="nofollow">autofac site.</a> Any work arounds for this?</p>
 Is there any sort of Interceptor implementation in sqlite <p>I'm wondering, is there a way to intercept DML operations in sqlite?? I'm looking to implement a something like a audit system to pickup inserts and updates on the database and log the changes on these events.</p>

<p>I've looked at using triggers but that didn't suffice as there was no way(that I know of) to define a global trigger, and manually managing triggers for over 100 tables doesn't sound like a good idea...longterm! </p>

<p>I'm open to any suggestions, so please fire away!</p>
 Castle Windsor - Releasing Interceptor with Transient Lifestyle <p>It is stated in the <a href="http://stw.castleproject.org/Default.aspx?Page=Interceptors&amp;NS=Windsor&amp;AspxAutoDetectCookieSupport=1" rel="nofollow">documentation</a> that you should always make interceptors transient. If I have this sample code;</p>

<pre class="lang-cs prettyprint-override"><code>//register interceptor
container.Register(Classes.FromAssemblyNamed("Sample.Interceptors")
.BasedOn&lt;Castle.DynamicProxy.IInterceptor&gt;()
.LifestyleTransient());

//Configure components to intercept
 container.Register(Classes.FromAssemblyNamed("Sample.Component")
.IncludeNonPublicTypes().InNamespace("Sample.Component", true)
            .Configure(c=&gt;
                c.Interceptors(InterceptorReference.ForType&lt;SampleInterceptor&gt;())
                 .Anywhere.LifestyleSingleton())
                 .WithService.DefaultInterfaces()
                );
</code></pre>

<p>Should I worry about releasing <code>SampleInterceptor</code>, or will it be released automatically once the service in <code>Sample.Component</code> has been released by the container?</p>
 Spring 3 Interceptor Order <p>I have a Spring 3 Web App that implements two interceptors. Im using a config class annotated @Configuration. The code is as follows:</p>

<pre><code>    @Override
public void addInterceptors(InterceptorRegistry registry) {
    // TODO Auto-generated method stub
    super.addInterceptors(registry);
    registry.addInterceptor(homeInterceptor()).addPathPatterns("/");
    registry.addInterceptor(allInterceptor());
}
</code></pre>

<p>No matter what order I add the interceptors to the registry, the allInterceptor's preHandle function is always called before the homeInterceptor's preHandle. Does anyone know how to control the order that interceptors are invoked?</p>

<p>Thanks!</p>
 Grails intercept form submit to modify params <p><strong>Why do I need this:</strong></p>

<p>I am working in a project which allows user to choose date in <a href="http://en.wikipedia.org/wiki/Vikram_Samvat" rel="nofollow">Nepali Bikram Sambat Date</a> format (which is incompatible with <code>Java</code> and <code>SQL's</code> "DATE"). I did it by modifying <code>org.codehaus.groovy.grails.plugins.web.taglib.FormTagLib</code> class's <code>datePicker</code> <code>tagLibrary</code>.  And modifying the scaffolding template <code>list.gsp</code>.</p>

<p><img src="http://i.stack.imgur.com/MnQkE.png" alt="enter image description here"></p>

<p><strong>My problem :</strong></p>

<p>When user chooses Nepali date from browser and submits the form, I want to read the <code>[day, month, year]</code> and convert it into <code>Java Date</code> object and save into database. (The date will be converted back to Nepali Bikram Sambat when it will be displayed into view).</p>

<p>I tried to print the params in the controller but all the params are already mapped/wrapped into corresponding objects - along with my Nepali Date. So I get sysout of Java's Date from code below :</p>

<pre><code>println params.date
</code></pre>

<p>I am wondering how can I intercept the form submit request and modify the date params into English date. I see one solution - using JavaScript ( and rewrite my conversion code into JavaScript) before form submit to convert the params. And just wanted to confirm is there a easy way - like interceptor/filter etc.</p>
 Test beforeInterceptor in integration test in grails <p>Is there a way to test this interceptor? It's beign ignored in my test.</p>

<p>Code:</p>

<pre><code>class BaseDomainController {
    def beforeInterceptor = {
        throw new RuntimeException()
        if(!isAdmin()){
            redirect(controller: 'login', action: 'show')
            return
        }
    }
}

class BaseDomainControllerSpec extends IntegrationSpec{

    BaseDomainController controller = new BaseDomainController()

    def 'some test'(){
        given: 
            controller.index()
        expect:
            thrown(RuntimeException)
    }

}
</code></pre>
 Global interceptor - runs before every action <p>How can I create an interceptor that will run before EVERY action in my application, without the need to specify it for every action separately?</p>
 NHibernate Interceptor Auditing Inserted Object Id <p>I am using NHibernate interceptors to log information about Updates/Inserts/Deletes to my various entities.</p>

<p>Included in the information logged is the Entity Type and the Unique Id of the entity modified. The unique Id is marked as a <code>&lt;generator class="identity"&gt;</code> in the NHibernate mapping file.</p>

<p>The obvious problem is when logging an Insert operation using IInterceptor.OnSave() the Id of the entity has not yet been assigned.</p>

<p>How can I obtain the Id of the inserted entity before logging the audit information?</p>

<p>(I have looked into NHibernate Listeners PostSave event but can't get them working with the Spring.net configuration being used, so I would like to stick with interceptors if at all possible)</p>

<p>Code:</p>

<pre><code>    // object id parameter is null...
    public override bool OnSave(object entity, object id, object[] state, 
        string[] propertyNames, IType[] types)
    {            
        AddAuditItem(entity, INSERT);
        return false;            
    }
</code></pre>
 Problem with Windsor Calls to "Genericized" Methods After Adding an Interceptor <p>I have an application that was working fine that uses Windsor for IoC.  I want to log the method calls, parameters, and execution time of all calls made to components instantiated by Windsor, so I implemented a LoggingInterceptor that implements IInterceptor, that contains:</p>

<pre><code>Stopwatch sw = new System.Diagnostics.Stopwatch();
sw.Start();
invocation.Proceed();  // EXCEPTION IS THROWN HERE
sw.Stop();
Logger.Debug(.....
</code></pre>

<p>Now operations that previously worked fine are throwing VerificationExceptions with the following message:</p>

<p>Method Repositories.RepositoryBase.GetAll: type argument 'ET' violates the constraint of type parameter 'ET'.</p>

<p>The signature of the method is:</p>

<pre><code>public IList&lt;ET&gt; GetAll&lt;ET&gt;() where ET : EntityBase2, IEntity2
</code></pre>

<p>(where EntityBase2 and IEntity2 are from LLBLGenPro) </p>

<p>The caller of the method is as follows:</p>

<pre><code>public IList&lt;ServerEntity&gt; GetServers()
{
   return GetRepository&lt;IServerRepository&gt;().GetAll&lt;ServerEntity&gt;();
}
</code></pre>

<p>(where GetRepository&lt;>() is just a wrapper around ServiceLocator)</p>

<p>If I comment out the interceptor from the castle configuration, it all works fine again.  </p>

<p>Why is this happening now, and is there a fix so I can use my logging interceptor?</p>

<p>thanks</p>
 Struts2 Interceptor *after* JSP is rendered - how? <p>I was wondering if I can capture the result of an action after the result returns and the JSP is rendered. I want to be able to take the entire result (generated HTML) and push it into memcached so I can bring it via Nginx with-out hitting the application server. Any ideas?</p>

<p>PS: I know I can run the interceptor after the action executes but before the result returns and the JSP is rendered, but not after the JSP is rendered.</p>
 Struts 2 File Upload Interceptor configuration problem <p>I'm having two problems when trying to configure the Struts 2 File Upload Interceptor in my application. I want to change the parameter <code>maximumSize</code> (the default value is 2 MB, I need it to be 5 MB) and the message resource <code>struts.messages.error.file.too.large</code> (the app locale is pt_BR, so the message is in portuguese, not english).</p>

<p>The app current configuration follows:</p>

<p><strong>struts.properties</strong></p>

<pre><code>struts.locale=pt_BR 
struts.custom.i18n.resources=MessageResources
</code></pre>

<p><strong>struts.xml</strong></p>

<pre><code>&lt;package name="default" namespace="/" extends="struts-default"&gt;
    &lt;interceptors&gt;
        &lt;interceptor name="login" class="br.com.probank.interceptor.LoginInterceptor"/&gt;
        &lt;interceptor-stack name="defaultLoginStack"&gt;
            &lt;interceptor-ref name="login" /&gt;
            &lt;interceptor-ref name="defaultStack"/&gt;
        &lt;/interceptor-stack&gt;
    &lt;/interceptors&gt;

    &lt;default-interceptor-ref name="defaultLoginStack" /&gt;
    ...
&lt;/package&gt;

...
&lt;package name="proposta" namespace="/proposta" extends="default"&gt;
    &lt;action name="salvarAnexoProposta" method="salvarAnexoProposta" class="br.com.probank.action.AnexoPropostaAction"&gt;
        &lt;interceptor-ref name="defaultLoginStack"&gt;
            &lt;param name="fileUpload.maximumSize"&gt;5242880&lt;/param&gt;
        &lt;/interceptor-ref&gt;
        &lt;result name="success"&gt;/jsp/listagemAnexosPropostaForm.jsp&lt;/result&gt;
        &lt;result name="input"&gt;/jsp/crudAnexoPropostaForm.jsp&lt;/result&gt;
        &lt;result name="error"&gt;/jsp/error.jsp&lt;/result&gt;
        &lt;result name="redirect" type="redirect"&gt;${redirectLink}&lt;/result&gt;
    &lt;/action&gt;
&lt;/package&gt;
</code></pre>

<p><strong>MessageResources.properties</strong></p>

<pre><code>...
struts.messages.error.file.too.large=O tamanho do arquivo...
</code></pre>

<p>There is nothing special about my Action implementation and my JSP code. They follow the example found <a href="http://struts.apache.org/2.1.6/docs/file-upload-interceptor.html" rel="nofollow">http://struts.apache.org/2.1.6/docs/file-upload-interceptor.html</a>. When I try to upload a file with more than 5 MB the app shows the message "the request was rejected because its size (6229458) exceeds the configured maximum (2097152)" - the default File Upload message with the default maximumSize value.</p>

<p>I try to put the message resource <code>struts.messages.error.file.too.large</code> in a struts-messages.properties but the message didn't change after that. What is the proper way to configure the File Upload Interceptor? I'm using Struts 2 2.1.7. Thanks in advance.</p>
 Lazy load a collection of data from a service, not the database <p>My domain objects support custom fields that are stored in such a way that requires metadata and logic to be applied before their values can be stored and retrieved.  </p>

<p>I already have a Custom Field Repository that handles the persistence of custom fields, and I don't want to try to recreate that logic in NHibernate mappings.</p>

<p>I would however like to support lazy loading of my custom fields.  It would be nice if I could somehow trick the proxy into calling my dedicated repository for loading and saving rather than going through the NHibernate engine.  </p>

<p>One way I solved this problem was to implement an interceptor which worked, but I took a performance hit when loading large amounts of data, because the dedicated repository was called each time an entity was loaded.  It would be nice instead, if those calls to load custom fields were done lazily!  From what I understand lazy loading cannot be done in an interceptor.</p>

<p>I have looked into implementing a custom user type (IUserType and IUserCollectionType), but the documentation is very limited, and I want to learn if it is even possible to do what I want before I go down the path of trying.</p>

<p>Here is an example of one of my domain objects:</p>

<pre><code>public class ContactEntity : ICustomFieldContainer
{
      public long ContactId { get; set; }
      public String FirstName { get; set; }
      public String LastName { get; set; }  
      #region ICustomFieldContainer Members  
      public List&lt;CustomFieldEntity&gt; CustomFields { get; set; }  
      #endregion

}
</code></pre>
 Castle Windsor Interceptor for private/protected method <p>Is it true that in order for castle windsor's interceptor to intercept a method, that method needs to be declare public?</p>
 
aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio aspect-ratio Multiple screen resolutions/aspect ratios (games) <p><strong>EDIT:</strong> Thanks for all your answers and comments. 
After thinking about it i would rephrase the core of the question to: "How to determine and limit the minimum resolution/ratio my game is able to run on". Because imo either the game becomes unplayable on the smallest screen/ratio (lack of detail) or supporting even the smallest screen/ratio degrades the experience for all the others significantly. Besides we do not even know what the smallest resolution is or can restrict it in any way other than disabling ldpi... which still doesn't tell us about the smallest mdpi. After all i'm not thinking about how to create a good result but about how to create a perfect result ;). Guess it's not possible (yet?).</p>

<p><strong>Note:</strong> This is purely about phones not tablets
Also this question is not that relevant for applications as it is for games which don't use the Android layout system.</p>

<p>I always found the definitions of which resolutions to expect somewhat vague.
I am aware of the <a href="http://developer.android.com/guide/practices/screens_support.html#testing">list</a> in the docs.</p>

<p>Now my first question is if this list is complete or in other words are manufacturer allowed to use other reolutions or aspect ratios.
My current approach is to view this list in terms of aspect ratios which looks something like that (Not sure if it's exact but you get the idea):</p>

<ul>
<li>ldpi: smallest aspect ratio 4:3</li>
<li>mdpi: smallest aspect ratio 3:2</li>
<li>hdpi: biggest aspect ratio 16:9</li>
</ul>

<p><img src="http://i.stack.imgur.com/mOdYD.png" alt="4:3">
<img src="http://i.stack.imgur.com/LtwMT.png" alt="3:2">
<img src="http://i.stack.imgur.com/oVy5Q.png" alt="16:9"></p>

<p>So if i want to cover a range of devices i figure out what my smallest and my biggest aspect ratios are and design the layout for the smallest while making it automatically grow to the biggest.
For example if i want to support all densities i design the screens for 4:3 and make it grow to 16:9. In case i remove ldpi support i would design for 3:2.
Of course this assumes there will never be an mdpi device with an aspect ratio of 4:3 which brings us back to my first question.</p>

<p>My preferred solution would be to indicate on the Android Market which aspect ratios my application can handle but that doesn't seem possible so far. </p>

<p>Does anyone have a better approach? (Keeping in mind that it's for games on phones only)</p>
 Strategies for Handling Multiple Screen Resolutions and Aspect Ratios in Web Development <p>Back in the day, 800 x 600 was the screen resolution to design for - and maybe 640 x 480. Then along came 1024 x 768, etc, etc, etc. </p>

<p>But then it gets worse: now we have not only different resolutions but also different aspect ratios. </p>

<p>What strategies do people use to accommodate today's ever-expanding range of screen sizes and aspect ratios? </p>

<p>(BTW - I was only thinking about laptop / desktop hardware, but of course there's smart-phones and tablets to consider too.)</p>
 Dealing with different aspect ratios in libgdx <p>I have implemented some screens using libgdx that would obviously use the Screen class provided by the libgdx framework. However, the implementation for these screens works only with pre-defined screen sizes. For example, if the sprite was meant for a 640 x 480 size screen (4:3 Aspect ratio), it won't work as intended on other screen sizes because the sprites go par the screen boundaries and are not scaled to the screen size at all. Moreover, if simple scaling would have been provided by the libgdx, the issue I am facing would have still been there because that would cause the aspect ratio of the game screen to change.</p>

<p>After researching on internet, I came across a <a href="http://www.java-gaming.org/index.php?topic=25685.new">blog/forum</a> that had discussed the same issue. I have implemented it and so far it is working fine. But I want to confirm whether this is the best option to achieve this or there are other better alternatives for achieving this. Below is the code to show how I am dealing with this legitimate problem. Please give a look.</p>

<p>FORUM LINK: <a href="http://www.java-gaming.org/index.php?topic=25685.new">http://www.java-gaming.org/index.php?topic=25685.new</a></p>

<pre><code> public class SplashScreen implements Screen{
//Aspect Ratio maintenance
private static final int VIRTUAL_WIDTH = 640;
private static final int VIRTUAL_HEIGHT = 480;
private static final float ASPECT_RATIO = (float)VIRTUAL_WIDTH/(float)VIRTUAL_HEIGHT;

private Camera camera;
private Rectangle viewport;
//------end------

MainGame TempMainGame;

public Texture splashScreen;
public TextureRegion splashScreenRegion;    
public SpriteBatch splashScreenSprite;

public SplashScreen(MainGame maingame)
{
    TempMainGame=maingame;
}
@Override
public void dispose() {
    splashScreenSprite.dispose();
    splashScreen.dispose();
}

@Override
public void render(float arg0) {
    //----Aspect Ratio maintenance

    // update camera
    camera.update();
    camera.apply(Gdx.gl10);

    // set viewport
    Gdx.gl.glViewport((int) viewport.x, (int) viewport.y,
                      (int) viewport.width, (int) viewport.height);

    // clear previous frame
    Gdx.gl.glClear(GL10.GL_COLOR_BUFFER_BIT);

    // DRAW EVERYTHING
//--maintenance end--


    splashScreenSprite.begin();
    splashScreenSprite.disableBlending();
    splashScreenSprite.draw(splashScreenRegion, 0, 0);
    splashScreenSprite.end();
}

@Override
public void resize(int width, int height) {
    //--Aspect Ratio Maintenance--
    // calculate new viewport
    float aspectRatio = (float)width/(float)height;
    float scale = 1f;
    Vector2 crop = new Vector2(0f, 0f);

    if(aspectRatio &gt; ASPECT_RATIO)
    {
        scale = (float)height/(float)VIRTUAL_HEIGHT;
        crop.x = (width - VIRTUAL_WIDTH*scale)/2f;
    }
    else if(aspectRatio &lt; ASPECT_RATIO)
    {
        scale = (float)width/(float)VIRTUAL_WIDTH;
        crop.y = (height - VIRTUAL_HEIGHT*scale)/2f;
    }
    else
    {
        scale = (float)width/(float)VIRTUAL_WIDTH;
    }

    float w = (float)VIRTUAL_WIDTH*scale;
    float h = (float)VIRTUAL_HEIGHT*scale;
    viewport = new Rectangle(crop.x, crop.y, w, h);
//Maintenance ends here--
}


@Override
public void show() {
    camera = new OrthographicCamera(VIRTUAL_WIDTH, VIRTUAL_HEIGHT); //Aspect Ratio Maintenance

    splashScreen = new Texture(Gdx.files.internal("images/splashScreen.png"));
    splashScreenRegion = new TextureRegion(splashScreen, 0, 0, 640, 480);
    splashScreenSprite = new SpriteBatch();

    if(Assets.load()) {
        this.dispose();
        TempMainGame.setScreen(TempMainGame.mainmenu);
    }   
}

}
</code></pre>

<p><strong>UPDATE:</strong> I recently came to know that libgdx has some of its own functionality to maintain aspect ratios which I would like to discuss here. While searching the aspect ratio issue across the internet, I came across several forums/developers who had this problem of "How to maintain the aspect ratio on different screen sizes?" One of the solutions that really worked for me was posted above.</p>

<p>Later on when I proceeded with implementing the touchDown() methods for the screen, I found that due to scaling on resize, the co-ordinates on which I had implemented touchDown() would change by a great amount. After working with some code to translate the co-ordinates in accordance with the screen resize, I reduced this amount to a great extent but I wasn't successful to maintain them with pin point accuracy. For example, if I had implemented touchDown() on a texture, resizing the screen would shift the touchListener on the texture region some pixels to the right or left, depending on the resize and this was obviously undesired.</p>

<p>Later on I came to know that the stage class has its own native functionality to maintain the aspect ratio (boolean stretch = false). Now that I have implemented my screen by using the stage class, the aspect ratio is maintained well by it. However on resize or different screen sizes, the black area that is generated always appears on the right side of the screen; that is the screen is not centered which makes it quite ugly if the black area is substantially large. </p>

<p>Can any community member help me out to resolve this problem??</p>
 Your thoughts on web design for 16:9 screens <p>I design web apps mainly for desktop use (not PDAs, phones etc) by co-workers and customers. As more users become equipped with 16:9-type screens the traditional screen layouts are no longer ergonomic.</p>

<p>For example, a long vertical navi bar might not fit completely or a complex form might need to be scrolled in order to move to the next input field.</p>

<p>How are you coping with this development? Are you spreading out more horizontally or sticking with the old layouts? Is it not really a problem?</p>

<p><strong>UPDATE</strong></p>

<p>Thanks for all the replies. I have found them useful. Here are some thoughts which occurred to me:</p>

<ul>
<li><p>I take the point that the 4:3 format may still be the most widely used, but I expect that to change. </p></li>
<li><p>Also, most users I visit here in the company have <em>all</em> their windows maximised (really!) so the idea of sizing the browser to fit the content doesn't help there.</p></li>
<li><p>In my case, most web apps involve search and display of information or data entry (some of which can involve large and complex forms). It's mainly the data entry apps which I'm concerned about. Perhaps AJAX and Tabbed controls might be a way forward there.</p></li>
</ul>
 how do i keep the aspect ratio on image buttons in android? <p>i have 5 square ImageButtons that i want to have lined up side by side on the bottom of the screen.  I have each one set (different id's) as: </p>

<pre><code>        &lt;ImageButton
         android:id="@+id/box1" 
         android:layout_width="fill_parent"
         android:layout_height="wrap_content" 
         android:layout_gravity="center"
         android:adjustViewBounds="true"
         android:scaleType="fitXY"
         android:layout_weight="1"
         android:layout_margin="1dp"
         /&gt; 
</code></pre>

<p>and i have the background assigned in main java like this:</p>

<pre><code>    int[] imageIds = new int[] {R.id.box1,R.id.box2,R.id.box3,R.id.box4,R.id.box5};
    for(int i = 0; i&lt;5; i++){
        imageButtons[i] = (ImageButton) findViewById(imageIds[i]);
        imageButtons[i].setBackgroundResource(R.drawable.blank);
    }
</code></pre>

<p>what i would like to have it do is scale the width to fit neatly side-by-side at the bottom of the screen (which it does now ok), but have the height automatically scale to match the width as well. is this possible?  i don't want to use setImageSource because then it puts a border around the imagebutton.</p>
 How Can I Only Allow Uniform Resizing in a WPF Window? <p>I don't want my window to be resized either "only horizontally" or "only vertically." Is there a property I can set on my window that can enforce this, or is there a nifty code-behind trick I can use?</p>
 How to maintain widgets aspect ratio in Qt? <p>How is it possible to maintain widgets aspect ratio in Qt and what about centering the widget?</p>
 A simple way to put a UIImage in a UIButton <p>I have a UIButton in my iPhone app.  I set its size to 100x100.</p>

<p>I have an image that is 400x200 that I wish to display in the button.</p>

<p>The button STILL needs to stay at 100x100... and I want the image to downsize to fit... but
keep the correct aspect ratio.</p>

<p>I thought that's what "Aspect Fit" was used for.</p>

<p>Do I include my image with setImage, or setBackgroundImage?</p>

<p>Do I set AspectFit for the button?  or the image?  or the background image?</p>

<p>(I need the smaller images to INCREASE in size.  While larger images should DESCREASE in size.
Always keeping the button at 100x100.)</p>

<p>I've tried countless combinations of all of the above... and I just can't seem to get
everything to work at the same time:</p>

<ul>
<li>Don't change the button's size of 100x100.</li>
<li>Don't destroy the image's aspect ratio.</li>
<li>Always increase small images to fit the button.</li>
<li>Always decrease large images to fit the button.</li>
<li>Never clip any of the image edges.</li>
<li>Never require the "put UIButtons over all your UIimages" hack.</li>
<li>Don't require everyone to upgrade to v4.2.1 just to use new framework methods.</li>
</ul>

<p>I see so many apps, with so many fully-working image-buttons... that I can't believe I can't figure out this very simple, very common thing.</p>

<p>Ugh.</p>
 How do I find the natural size/dimensions of a Flash SWF file? <p>I've been given a Flash file (<code>.swf</code> extension) to put into a web page. Opening the file in my browser makes it quite blurry, so I'm assuming there is a natural size for the file, same as an image.</p>

<p>It's also rectangular so I need to work out the aspect ratio if I don't have an exact size. How would I find this information out?</p>
 Resize UIImage by keeping Aspect ratio and width <p>I seen in many posts for resizing the image by keeping aspect ratio. These functions uses the fixed points(Width and Height) for RECT while resizing. But in my project, I need to resize the view based on the Width alone, Height should be taken automatically based on the aspect ratio.
anyone help me to achieve this.</p>
 device-aspect-ratio (media query) not working for Droid 2 <p>I have some content that needs varying styles ultimately based on aspect ratio (basically it's targeted at one platform but as a "would-be-nice" I want to make the content at least appear correct on other platforms). I'm finding that the Droid 2 (Android 2.2 stock) is not responding to any of these queries:</p>

<pre><code>only all and (device-aspect-ratio: 854/480)
only all and (device-aspect-ratio: 480/854)
only all and (aspect-ratio: 854/480)
only all and (aspect-ratio: 480/854)
</code></pre>

<p>Does the phone or the OS not support the aspect-ratio query? Is the Droid 2 full of sad? The aspect ratio tests work perfectly for iPhone 3GS/4/4S and iPad so far for me. Alternatively, what would someone suggest for handling Droid 2 / Nexus resolutions after my iOS aspect ratio tests if they don't actually support device aspect ratio.</p>

<p>I'm trying to shy away from using max-width because some Android devices in landscape are wider than an iPad in portrait and I was getting collisions where a device would incorrectly identify as an iPad based on a set width. Any insight would be appreciated.</p>
 Pure CSS Solution - Square Elements? <p>If I have a &lt;div&gt; with a relative width (such as <em>width: 50%</em>), is there a simple way to make it have the same width as it does height without resorting to JavaScript?</p>
 How to scale SVG image to fill browser window? <p>This seems like it ought to be easy, but I'm just not getting something.</p>

<p>I want to make an HTML page containing a single SVG image that automatically scales to fit the browser window, without any scrolling and while preserving its aspect ratio.</p>

<p>For example, at the moment I have a 1024x768 SVG image; if the browser viewport is 1980x1000 then I want the image to display at 1333x1000 (fill vertically, centred horizontally).  If the browser was 800x1000 then I want it to display at 800x600 (fill horizontally, centred vertically).</p>

<p>Currently I have it defined like so:</p>

<pre><code>&lt;body style="height: 100%"&gt;
  &lt;div id="content" style="width: 100%; height: 100%"&gt;
    &lt;svg xmlns="http://www.w3.org/2000/svg" version="1.1"
         width="100%" height="100%"
         viewBox="0 0 1024 768"
         preserveAspectRatio="xMidYMid meet"&gt;
      ...
    &lt;/svg&gt;
  &lt;/div&gt;
&lt;/body&gt;
</code></pre>

<p>However this is scaling up to the full width of the browser (for a wide but short window) and producing vertical scrolling, which isn't what I want.</p>

<p>What am I missing?</p>
 Android Convert Px to Dp (Video Aspect Ratio) <blockquote>
  <p><strong>Possible Duplicate:</strong><br>
  <a href="http://stackoverflow.com/questions/4605527/converting-pixels-to-dp-in-android">converting pixels to dp in android</a>  </p>
</blockquote>



<p>I'm trying to convert pixels to dp.  What is the formula?</p>

<p>Lets convert 640 and 480 into dp.  The docs say this </p>

<blockquote>
  <p>The conversion of dp units to screen pixels is simple: px = dp * (dpi / 160)</p>
</blockquote>

<p>But I don't think that is what I need (and I don't know how to use this).  I guess I just need the forumla.  I have the code ready:</p>

<pre><code>DisplayMetrics metrics = new DisplayMetrics();
    getWindowManager().getDefaultDisplay().getMetrics(metrics);

    switch(metrics.densityDpi)
    {
         case DisplayMetrics.DENSITY_LOW:
         int sixForty = ?
         int fourEighty = ?
         break;

         case DisplayMetrics.DENSITY_MEDIUM:
         int sixForty = ?
         int fourEighty = ?
         break;

         case DisplayMetrics.DENSITY_HIGH:
         int sixForty = ?
         int fourEighty = ?
         break;
    }
</code></pre>
 How to define fixed aspect-ratio for scatter-plot <p>I am plotting correlation coefficients (values = 0.0:1.0) for two isotopes measured in each individual from two populations. I would like to have a fixed aspect-ratio for my scatter-plot so that the x- and y-axis are exactly the same size no matter the graphics device. Suggestions?</p>

<p>This is my first plot in R, any comments on refinements to my code is appreciated? Finally, is it worth investing in learning the basic plotting techniques or should I jump right to ggplot2 or lattice?</p>

<p>My plot script:</p>

<pre><code>## Create dataset
WW_corr &lt;-
structure(list(South_N15 = c(0.7976495, 0.1796725, 0.5338347,
0.4103769, 0.7447027, 0.5080296, 0.7566544, 0.7432026, 0.8927161
), South_C13 = c(0.76706752, 0.02320767, 0.88429902, 0.36648357,
0.73840937, 0.0523504, 0.52145159, 0.50707858, 0.51874445), North_N15 = c(0.7483608,
0.4294148, 0.9283554, 0.8831571, 0.5056481, 0.1945943, 0.8492716,
0.5759033, 0.7483608), North_C13 = c(0.08114805, 0.47268136,
0.94975596, 0.06023815, 0.33652839, 0.53055943, 0.30228833, 0.8864435,
0.08114805)), .Names = c("South_N15", "South_C13", "North_N15",
"North_C13"), row.names = c(NA, -9L), class = "data.frame")

opar &lt;- par()

## Plot results
par(oma = c(1, 0, 0, 0), mar = c(4, 5, 2, 2))           
plot(1,1,xlim=c(0:1.0), ylim=c(0:1.0), type="n", las=1, bty="n", main = NULL,
     ylab=expression(paste("Correlation Coefficient (r) for ", delta ^{15},"N ",
                     "\u0028","\u2030","\u0029")),
     xlab=expression(paste("Correlation Coefficient (r) for ", delta ^{13},"C ",
                     "\u0028","\u2030","\u0029")))

points(WW_corr$South_N15, WW_corr$South_C13, pch = 23, cex = 1.25, 
       bg ="antiquewhite4", col = "antiquewhite4")
points(WW_corr$North_N15, WW_corr$North_C13, pch = 15, cex = 1.25,
       bg ="black")
axis(1, at = seq(0, 1.0, by = 0.1), labels = F, tick = TRUE, tck = -0.01)
axis(2, at = seq(0, 1.0, by = 0.1), labels = F, tick = TRUE, tck = -0.01)
abline(h=.86, v=.86, col = "gray60", lty = 2)
legend("topleft", c("North", "South"), pch = c(15, 23), 
       col = c("black", "antiquewhite4"), pt.bg = c("black", "antiquewhite4"),
       horiz=TRUE, bty = "n")

par(opar)
</code></pre>
 Corona SDK Cross Device Screen Resolution <p>This is going to be one of those awkward questions looking for an answer that probably doesn't exist, but here goes.</p>

<p>I've been developing some simple games using Corona and whilst the functionality seems to work pretty well across most of the physical devices I have tested on, the one main issue is the layout. I know you can't really build for every single device perfectly, but I'm wondering if there is a common method to make an app look good across as many screens as possible. I have access to these devices </p>

<ul>
<li>iPad 1 &amp; 2: 4:3 (1.33)</li>
<li>iPhone 960 × 640 3:2 (1.5)</li>
<li>iPhone 480x320 3:2 (1.5)</li>
<li>Galaxy Nexus 16:9 (1.77)</li>
</ul>

<p>From what I have seen, people aim to use 320x480 as a scaled resolution and then let Corona upscale to the correct device resolution (with any @2x images as required) but this leads to letterboxing or cropping depending on the config.lua scale setting. Whilst it does scale correctly, having a letterbox isn't great.</p>

<p>So would I be best to not specify a width&amp;height in the config file, but instead to use some sort of screen check at first to look for 1.33 / 1.5 / 1.77 aspect ratios? Surely with the whole point of Corona SDK, there would be some sort of 'typical' setup that developers use for the start of any new project?</p>

<p>Thank you</p>
 Cocos2d and the new iPhone 5 aspect ratio <p>I have just seen the <a href="http://www.youtube.com/watch?v=DYb855lAkFs">announcment of iPhone 5</a> and it says that the pixel resolution has changed to 1136*640, affecting in this way the ASPECT RATIO of the app.</p>

<p>How should I deal with this in my Cocos2d game? I got all the graphics done for the "old" 960*640 retina display screen and I guess that those will be distorted on the iPhone 5 screen.</p>

<p>Am I right? Or will there be the "old resolution" images shown without modifying the aspect ratio and leaving some screen black?</p>

<p><strong>EDIT:</strong> Is there a way to get Cocos2d to detect if it is iPhone 5 and in that case draw the background files in the top part of the screen (top 960 pixels) and get some other custom background files to be drawn in the remaining pixels (e.g. those could be some custom ad banners or some extra buttons available in our Game only for iPhone 5). </p>
 How do I resize a Silverlight 3 application and all child controls and keep aspect ratio <p>Hi<br>
I'm building a Silverlight 3 application and I would like it to resize depending on the size of the web browser.</p>

<p>I have found   <a href="http://community.irritatedvowel.com/blogs/pete%5Fbrowns%5Fblog/archive/2008/07/04/How-to-Resize-a-Silverlight-2-App-and-Keep-the-Same-Aspect-Ratio.aspx" rel="nofollow">http://community.irritatedvowel.com/blogs/pete%5Fbrowns%5Fblog/archive/2008/07/04/How-to-Resize-a-Silverlight-2-App-and-Keep-the-Same-Aspect-Ratio.aspx</a>  </p>

<p>But the solution suggested doesn't seem to work on silverlight 3 (one of my child controls disappears off the screen when I resize).</p>

<p>Any suggestions?</p>

<p>/Jimmy</p>
 Calculate Height for Image/Video based on Aspect Ratio and Width <p>I have a width: 240
I have aspect ratio: 2.40
I need to get the height based on those two variables.  What's the formula?</p>
 Handling different screen resolutions for background images in Android? <p>My Android app (a text-based games) uses background images a lot in order to provide a better visual ambience. For example, if the action in the game takes you into a tavern, then you get a background image of a tavern in the game. This is a vast improvement, graphically, over the boring black background that you would otherwise get.</p>

<p>It is also a problem, however, since android:background always stretches to the dimensions of the screen. The result is that the background images look very bad if the player swithces between portrait and landscape mode. And to make matters worse, many devices have very different aspect rations (e.g., 320x480 mdpi, 480x800 hdpi, and 480x852 hdpi) and even more variations are coming.</p>

<p>How do others solve this problem? Having individual images for the main resolutions/orientations is not an option for me, as this would result in the apk growing too large.</p>
 How to make a resolution independent camera preview on android? <p>I'm making an android 1.6 app that uses phone's camera.</p>

<p>In order to do this app resolution independent, I need to set a compatible aspect ratio for previewing camera on a SurfaceLayout. In 1.6 sdk there is no way to get supported sizes for the camera preview. It is possible to use a 4:3 or 3:2 aspect ratio and get no errors whith that?</p>

<p>On the other hand, I need a way to make a xml layout that represents this Surfacelayout in this (unknown) aspect ratio in every resolution. I assume that is not possible to change the SurfaceLayout size in runtime. Can I do it with "dp" units? The other way is making this layout programmatically?</p>

<p>There are some apps like Vignette or android camera application with some tricks to make something like that, like black bars (vignette) or fixed buttons bar, but I don't know how to do it in any kind of resolution.</p>

<p>Any ideas?</p>

<p>Thanks!</p>
 Objective C: How to fix aspect ratio of image (and not change to fit imageview frame) <p>I am using the UIImagePickerController to select images for my app. However I am facing some challenges with regards to maintaining aspect ratio of the selected images</p>

<p>For example,</p>

<p>I have a raw image on the phone as follows (not square image):</p>

<p><img src="http://i.stack.imgur.com/K1GxM.png" alt="enter image description here"></p>

<p>After selecting the image on iphone via the 'move and scale' page to crop image, the result is as follows: (aspect ratio is still maintained here)</p>

<p><img src="http://i.stack.imgur.com/JNyr9.png" alt="enter image description here"></p>

<p>My app will display the selected image in a UIImageView with a square frame (200 x 200). After setting the selected image to the UIImageView (UIImageView.image = selectedImage), the image's aspect ratio is not maintained but instead followed the frame of the UIImageView: (The image looks skewed now in my UIImageView):</p>

<p><img src="http://i.stack.imgur.com/PKPTj.png" alt="enter image description here"></p>

<p>Is there any way to maintain the aspect ratio of the image in this case?</p>

<p>EDIT: Update expected result</p>

<p>After some thinking, I realize that the best way to resolve my issue is to ensure that for such images (non square), I need to 'convert' them into square images i.e. fill the empty spaces on top and bottom of images to make a square e.g.</p>

<p>Expected image: (with the top and bottom borders added)</p>

<p><img src="http://i.stack.imgur.com/bDCKS.png" alt="enter image description here"></p>

<p>EDIT: Update with sample code</p>

<pre><code>- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingImage:(UIImage *)img editingInfo:(NSDictionary *)editInfo 
{

    self.imageView.contentMode = UIViewContentModeScaleAspectFill;

    self.imageView.image = image;
    [[picker parentViewController] dismissModalViewControllerAnimated:YES];

    //Compress image
    UIImage *image = [self scaleImage:img toSize:CGSizeMake(612.0,612.0)];

    self.imageData = UIImageJPEGRepresentation(image, 0.75);
}
</code></pre>

<p>By adding the code "self.imageView.contentMode = UIViewContentModeScaleAspectFill;", I was able to obtain the square image in the uiimageview</p>

<p><img src="http://i.stack.imgur.com/Ghk1k.png" alt="enter image description here"></p>

<p>But it seems like the original image was still not a square image, hence the skewing problem will still occur when I do "UIImage *image = [self scaleImage:img toSize:CGSizeMake(612.0,612.0)];". Is my assumption correct? Anyway to mitigate this issue as I will still need to display the 'compressed' image elsewhere in the app.</p>
 DrawFocusRect with given aspect ratio in Delphi <p>I want to be able to draw a FocusRect on an image, which keeps the aspect ratio of the image. My problem is, that the FocusRect only depends on the y coordinates of the mouse. I just don't know how to let the rectangle depent on both mouse coordinates...
This is my code:</p>

<pre><code>procedure TForm1.AuswahlRechteck; //Due to this procedure it doesn't matter in which corner the rectangle begins
begin                                                                           
  Image1.Canvas.DrawFocusRect(Rect(X0,Y0,MX,MY));
  Image1.Canvas.DrawFocusRect(Rect(X0,MY,MX,Y0));
  Image1.Canvas.DrawFocusRect(Rect(MX,MY,X0,Y0));
  Image1.Canvas.DrawFocusRect(Rect(MX,Y0,X0,MY));
end;

procedure TForm1.Image1MouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
  X0:=X;
  MX:=X;
  Y0:=Y;
  MY:=Y;
  AuswahlRechteck;
  InMove:=true;
end;

procedure TForm1.Image1MouseMove(Sender: TObject; Shift: TShiftState; X,
  Y: Integer);
begin
  if InMove then
  begin
    AuswahlRechteck;
    MY:=Y;
    MX:=X;
    if (((MX &lt; X0) AND (MY &gt; Y0)) OR ((MX &gt; X0) AND (MY &lt; Y0))) then MX:=Round(X0-((MY-Y0)*Image1.Width/Image1.Height))
    else MX:=Round(X0+((MY-Y0)*Image1.Width/Image1.Height));    
    AuswahlRechteck;
  end;
end;
</code></pre>

<p>Could someone help me please?</p>

<p>Henry</p>
 Defining two layouts for two aspect ratios (4:3 and 16:9) <p>Following <a href="http://msdn.microsoft.com/en-us/library/windows/apps/hh780612.aspx" rel="nofollow">the Microsoft scale guidelines</a> there is a part where it says:</p>

<blockquote>
  <p>When designing a fixed layout, start by designing your layout for the baseline resolutions: 1024x768 and 1366x768. </p>
</blockquote>

<p>Is it possible to define two layouts for two aspect ratios (to use with the <code>ViewBox</code>) so they can change automatically depending on the screen's aspect ratio (and maybe change between the fill mode and full screen mode) ?</p>
 Resizing N # of squares to be as big as possible while still fitting into box of X by Y dimensions. (Thumbnails!) <p>I have N squares.
I have a Rectangular box.
I want all the squares to fit in the box.
I want the squares to be as large as possible.</p>

<p>How do I calculate the largest size for the squares such that they all fit in the box?</p>

<p>This is for thumbnails in a thumbnail gallery.</p>

<pre><code>int function thumbnailSize(
    iItems, // The number of items to fit.
    iWidth, // The width of the container.
    iHeight, // The height of the container.
    iMin // The smallest an item can be.
)
{
    // if there are no items we don't care how big they are!    
    if (iItems = 0) return 0;

    // Max size is whichever dimension is smaller, height or width.
    iDimension = (iWidth min iHeight);

    // Add .49 so that we always round up, even if the square root
    // is something like 1.2.  If the square root is whole (1, 4, etc..)
    // then it won't round up.
    iSquare = (round(sqrt(iItems) + 0.49));

    // If we arrange our items in a square pattern we have the same
    // number of rows and columns, so we can just divide by the number
    // iSquare, because iSquare = iRows = iColumns.
    iSize = (iDimension / iSquare);

    // Don't use a size smaller than the minimum.
    iSize = (iSize max iMin);

    return iSize;
 }
</code></pre>

<p>This code currently works OK.  The idea behind it is to take the smallest dimension of the rectangular container, pretend the container is a square of that dimension, and then assume we have an equal number of rows and columns, just enough to fit iItems squares inside.</p>

<p>This function works great if the container is mostly squarish.  If you have a long rectangle, though, the thumbnails come out smaller than they could be.  For instance, if my rectangle is 100 x 300, and I have three thumbnails, it should return 100, but instead returns 33.</p>
 Get aspect ratio of a monitor <p>I want to get aspect ratio of a monitor as two digits : width and height. For example 4 and 3, 5 and 4, 16 and 9.</p>

<p>I wrote some code for that task. Maybe it is any easier way to do that ? For example, some library function =\</p>

<pre><code>/// &lt;summary&gt;
/// Aspect ratio.
/// &lt;/summary&gt;
public struct AspectRatio
{
    int _height;
    /// &lt;summary&gt;
    /// Height.
    /// &lt;/summary&gt;
    public int Height
    {
        get
        {
            return _height;
        }
    }

    int _width;
    /// &lt;summary&gt;
    /// Width.
    /// &lt;/summary&gt;
    public int Width
    {
        get
        {
            return _width;
        }
    }

    /// &lt;summary&gt;
    /// Ctor.
    /// &lt;/summary&gt;
    /// &lt;param name="height"&gt;Height of aspect ratio.&lt;/param&gt;
    /// &lt;param name="width"&gt;Width of aspect ratio.&lt;/param&gt;
    public AspectRatio(int height, int width)
    {
        _height = height;
        _width = width;
    }
}



public sealed class Aux
{
    /// &lt;summary&gt;
    /// Get aspect ratio.
    /// &lt;/summary&gt;
    /// &lt;returns&gt;Aspect ratio.&lt;/returns&gt;
    public static AspectRatio GetAspectRatio()
    {
        int deskHeight = Screen.PrimaryScreen.Bounds.Height;
        int deskWidth = Screen.PrimaryScreen.Bounds.Width;

        int gcd = GCD(deskWidth, deskHeight);

        return new AspectRatio(deskHeight / gcd, deskWidth / gcd);
    }

    /// &lt;summary&gt;
    /// Greatest Common Denominator (GCD). Euclidean algorithm. 
    /// &lt;/summary&gt;
    /// &lt;param name="a"&gt;Width.&lt;/param&gt;
    /// &lt;param name="b"&gt;Height.&lt;/param&gt;
    /// &lt;returns&gt;GCD.&lt;/returns&gt;
    static int GCD(int a, int b)
    {
        return b == 0 ? a : GCD(b, a % b);
    }
</code></pre>

<p>}</p>
 Android:Aspect ratio in cropped image captured from camera <p>Can we provide aspect ratio for the image captured from camera that is cropped at runtime.so for the parameter </p>

<pre><code>1.intent.putExtra("crop","true");      works
2.intent.putExtra("aspectX",730);      not working
3.intent.putExtra("aspectY",1115);     not working
4.intent.putExtra("outputX",730);      not working
5.intent.putExtra("outputY",1115);     not working
</code></pre>

<p><strong> :While it is working for the image taken from gallery</strong></p>

<p>Is this the way to provide aspect ratio or not for image captured by camera activity?I need your help?
Thanks</p>

<p>UPDATE-->   CODE</p>

<pre><code>public void onClick(DialogInterface dialog, int item)
                {
                    Intent intent = new Intent();
                    intent.putExtra("crop", "true"); 
                    intent.putExtra("aspectX", 730);
                    intent.putExtra("aspectY", 735);
                    intent.putExtra("outputX", 730);
                    intent.putExtra("outputY", 735);

                    if(item==0)
                    {
                        intent.setAction("android.media.action.IMAGE_CAPTURE");
                        startActivityForResult(intent, PICK_FROM_CAMERA);
                    }
</code></pre>
 Reconstructing Aspect Ratio of Rectangular Objects in Images <p>I'm working on a little project that does "scan" sheets of paper using a camera (specifically the iPhone camera).</p>

<p>Workflow:</p>

<p>Lets users take pictures of sheets of paper while I will afterwards detect corners/the outline so I know the 4 corner points of the original sheet of paper in the photograph. It is then easy to inverse the perspective transformation of the camera to gain a "flat" image of the photographed sheet of paper.</p>

<p><strong>However, my question is:</strong> how do I maintain or even calculate the correct (original) aspect ratio?</p>

<p><img src="http://i.stack.imgur.com/AjFTn.png" alt="Image of UI with detected corners of sheet of paper (can't post images, sorry)"></p>

<p>As you can see above I have the coordinates for the corner points and I also know how to construct a matrix to map the top left corner to the point (0,0), the top right corner to (width,0), the bottom right corner to (width, height) and the bottom left corner to (0,height).</p>

<p><strong>The question now is:</strong> How do I get the correct width/height aspect ratio the sheet of paper originally has. I'm pretty sure I can figure it out using the angles to determine the perspective transformation but I'm stuck finding the right formula. I also have a hunch that I also would need the focal length of the camera but it would be great not to need that.</p>

<p>Any ideas would be appreciated.</p>
 How can I have flexible css image sizing with max height and width while preserving image aspect ratio, without javascript? <p>I really thought this would be elsewhere on stack overflow, but I searched fruitlessly for length of time. Forgive me if I missed it.</p>

<p>I have a set of images who need to be made as large as possible (width: 100% to container elem) as long as the container does not grow too wide or the image too tall because of the container width.  Aspect ratio needs to be preserved.</p>

<p>I thought I could do this with</p>

<pre><code>img { width: 100%; height: auto; max-width: 500px; max-height: 250px; }
</code></pre>

<p>The idea was that if the image hit either the max-width or the max-height given the width and the aspect ratio, it would no longer grow.  In reality, this causes the image width to size as wide as possible, but breaks the aspect ratio (squishing the image to max-height) when it is too tall, instead of preventing the image from growing wider.</p>

<p>Is there a better way to go about this?  I would like to avoid javascript if possible.  My tests are in Firefox 9. </p>
 C# : How to calculate aspect ratio <p>I am relatively new to programming. I need to calculate the aspect ratio(16:9 or 4:3) from a given dimension say axb. How can I achieve this using C#. Any help would be deeply appreciated.</p>

<pre><code>public string AspectRatio(int x, int y)
{
 //code am looking for
 return ratio
}
</code></pre>

<p>Thanks.</p>
 How to determine a projected (if 3D) aspect ratio (if set) of a figure in Matlab to specify a proper paper size? <p>I saw many Q&amp;A here about squeezing space out of Matlab figures. However I want to squeeze space resulted from a possibly fixed aspect, i.e. to choose proper paper size for figure printing when aspect is fixed.</p>

<p>Quite often I work with DEM/map/image thus I use <code>axis image</code>. Now if I want to produce a high resolution image I do something like</p>

<pre><code>set(gcf,'PaperUnits','inches','PaperPosition',[0 0 4 3])
print('-dpng','-r300','somefile.png')
</code></pre>

<p>as described in <a href="http://www.mathworks.com/support/solutions/en/data/1-16WME/?solution=1-16WME" rel="nofollow">Matlab KB</a>.</p>

<p>The problem here is to determine a proper aspect such that I can specify proper paper size that would leave no white/background stripes on either sides.</p>

<p>Apparently if I have a map (let's say 1000x2000 cells) with aspect ratio of 0.5, and I'm printing it on 4"x3" paper, I'll get background stripes on the sides. This is quite annoying as I'd prefer 1.5"x3" paper + axes &amp; labels or so. Right now I have to manually adjust paper size.</p>

<p>This is inconvenient as I'd like a universal solution. For instance I may print a plot into file that I expect to occupy 4"x3" as well that has <strong>no</strong> fixed aspect. Or I may want to print a 3D figure. I'm aware of daspect and pbaspect, but how can I know how it is currently drawn?</p>

<p>Perhaps I can derive current 2D aspect from <code>get(gca,'Position')</code> and then scale it to my maximum allowed desired size (e.g., 4"x3") while respecting whether <em>DataAspectRatioMode</em> (?) property is set to <em>manual</em>. Is it the way to proceed or is there a better way?</p>
 TinyMCE prevent image resizing <p>I am adding an image to a TinyMCE editor using:</p>

<pre><code>var params = {
             src: filename,
             title: "Attached image: " + filename,
             width: 500
             };

ed.execCommand("mceInsertContent", false, ed.dom.createHTML("img", params));
</code></pre>

<p>This insert the image correctly in the editor. However, when the user clicks on the image he has the ability of resizing it.</p>

<p>I would like to know if there is a way to:</p>

<ol>
<li>Prevent the user to resize only in one direction (i.e. how do I keep a fixed aspect ratio for the image)</li>
<li>Completely prevent the user to resize the image </li>
</ol>
 Large images don't render in Chrome? <p>Very large images will not render in Google Chrome (although the scrollbars will still behave as if the image is present). The same images will often render just fine in other browsers.</p>

<p>Here are two sample images. <strong>If you're using Google Chrome, you won't see the long red bar:</strong></p>

<p><strong>Short Blue</strong><br>
<a href="http://i.stack.imgur.com/ApGfg.png" rel="nofollow">http://i.stack.imgur.com/ApGfg.png</a></p>

<p><strong>Long Red</strong><br>
<a href="http://i.stack.imgur.com/J2eRf.png" rel="nofollow">http://i.stack.imgur.com/J2eRf.png</a></p>

<p>As you can see, the browser thinks the longer image is there, but it simply doesn't render. The image format doesn't seem to matter either: I've tried both PNGs and JPEGs. I've also tested this on two different machines running different operating systems (Windows and OSX). This is obviously a bug, but can anyone think of a workaround that would force Chrome to render large images?</p>
 Aspect ratios - how to go about them? (D3D viewport setup) <p>Allright - seems my question was as cloudy as my head. Lets try again.</p>

<p>I have 3 properties while configuring viewports for a D3D device:
- The resolution the device is running in (full-screen).
- The physical aspect ratio of the monitor (as fraction and float:1, so for ex. 4:3 &amp; 1.33).
- The aspect ratio of the source resolution (source resolution itself is kind of moot and tells us little more than the aspect ratio the rendering wants and the kind of resolution that would be ideal to run in).</p>

<p>Then we run into this:</p>

<pre><code>// -- figure out aspect ratio adjusted VPs  -- 

m_nativeVP.Width = xRes;
m_nativeVP.Height = yRes;
m_nativeVP.X = 0;
m_nativeVP.Y = 0;
m_nativeVP.MaxZ = 1.f;
m_nativeVP.MinZ = 0.f;

FIX_ME // this does not cover all bases -- fix!
uint xResAdj, yResAdj;  
if (g_displayAspectRatio.Get() &lt; g_renderAspectRatio.Get())
{
  xResAdj = xRes;
  yResAdj = (uint) ((float) xRes / g_renderAspectRatio.Get());
}
else if (g_displayAspectRatio.Get() &gt; g_renderAspectRatio.Get())
{
  xResAdj = (uint) ((float) yRes * g_renderAspectRatio.Get());
  yResAdj = yRes;    
}
else // ==
{
  xResAdj = xRes;
  yResAdj = yRes;
}

m_fullVP.Width = xResAdj;
m_fullVP.Height = yResAdj;
m_fullVP.X = (xRes - xResAdj) &gt;&gt; 1;  
m_fullVP.Y = (yRes - yResAdj) &gt;&gt; 1;  
m_fullVP.MaxZ = 1.f;
m_fullVP.MinZ = 0.f;
</code></pre>

<p>Now as long as g_displayAspectRatio <em>equals</em> the ratio of xRes/yRes (= adapted from device resolution), all is well and this code will do what's expected of it. But as soon as those 2 values are no longer related (for example, someone runs a 4:3 resolution on a 16:10 screen, hardware-stretched) another step is required to compensate, and I've got trouble figuring out how exactly.</p>

<p>(and p.s I use C-style casts on atomic types, live with it :-) ) </p>
 How do I find a dimension of aspect ratio 4:3 which fits within a predetermined size? <p>The problem here is I have a display window of size x by y, and I need to display an image inside the window without any scrolling, and to maintain the aspect ratio of 4:3. I have the following snippet of code:</p>

<pre><code>// Lock the current height, calculate new width of the canvas and scale the viewport.
// get width of the movie canvas
qreal width = canvas_-&gt;width();

// Find the height of the video
qreal height = (width/4.0) * 3;

// find original width and height for video to calculate scaling factor
qreal videoWidth = movieData_-&gt;GetWidth();
qreal videoHeight = movieData_-&gt;GetHeight();

// calculate scaling factor
qreal scaleFactorWidth = width/videoWidth;
qreal scaleFactorHeight = height/videoHeight;
</code></pre>

<p>Of course, by using either the height, or the width as the 'anchor', one way or other the new image will cause scrolling (assuming the original image is larger than the window in the first place). How do I find a dimension of aspect ratio 4:3 which fits within a predetermined size?</p>

<p><b>Edit</b>
I would need to pass in a scale factor for both x and y to do the scaling</p>

<pre><code>canvas_-&gt;scale(scaleFactorWidth, scaleFactorHeight);
</code></pre>
 Resizing an image <p>The code below works very well for resizing an image by aspect ratio by height and I can also create a separate function by width. But i'm not always sure if an image will need to be shrunk by height or width. </p>

<p>For example if the space that the image needs to be resized into is 100 width and 100 height and an image is 150 by 90 then its the width that would need to be shrunk. If the image is 80 by 160 then the height would need to be shrunk.</p>

<p>So what i'm asking is how could the code below be modified so it shrinks an image by aspect ratio to fit parameters of both width and height? Thanks.</p>

<pre><code>jQuery.fn.resizeHeightMaintainRatio = function(newHeight){
if (this.aspectRatio == undefined) 
this.aspectRatio = parseInt($(this).width() / $(this).height());
$(this).height(newHeight); 
$(this).width(newHeight * this.aspectRatio);
}
</code></pre>

<p>I've edited the code yet again, since on further inspection neither my updated version nor Dan's seemed to work properly. The aspect ratio was lost so here's yet another. I've tried it on one image and so far so good. Here it is, </p>

<pre><code>    jQuery.fn.resizeMaintainRatio = function(newHeight, newWidth){
      widthRatio = parseInt($(this).width() / newWidth);
      heightRatio = parseInt($(this).height() / newHeight);

      if(heightRatio &gt; widthRatio)
      {

        this.aspectRatio = parseInt($(this).css("width") / $(this).css("height"));

        $(this).css("height", newHeight);
        $(this).css("width", newHeight * this.aspectRatio);

      }
      else{

        this.aspectRatio = parseInt($(this).css("height") / $(this).css("width"));

        $(this).css("width", newWidth);
        $(this).css("height", newWidth * this.aspectRatio);

      }

    }
</code></pre>

<p>NOTE AGAIN: after further use the above code works very strangely, try this instead - 
<a href="http://plugins.jquery.com/project/kepresize" rel="nofollow">http://plugins.jquery.com/project/kepresize</a></p>
 How to "smart resize" a displayed image to original aspect ratio <p>I have an application in which end-users can size and position images in a designer. Since the spec calls for the image to be "stretched" to the containing control, the end user can end up with an awkwardly stretched image.</p>

<p>To help the user with image sizing I am thinking of implementing a smart resizer function which would allow the the user to easily fix the aspect ratio of the picture so that it no longer appears stretched.</p>

<p>The quick way to solve this is to actually provide two options: 1) scale from width 2) scale from height. The user chooses the method and the algorithm adjusts the size of the picture by using the original aspect ratio. For example: A picture is displayed as 200x200 on the designer but the original image is 1024x768 pixels. The user chooses "Smart Size from width" and the new size becomes ~200x150 since the original aspect ratio is ~1.333</p>

<p>That's OK, but how could I make the algorithm smarter and not bother the user by asking which dimension the recalculation should be based on? </p>
 Finding and enforcing an aspect ratio <p>I have a control on my form , and i want to be able to control the width, and have the height of the control change to maintain its original aspect ratio. So that brings me to the following questions:</p>

<h2>Questions:</h2>

<ul>
<li>How do you determine the <em>exact</em> aspect ratio of a control?</li>
<li>What do i do in the resize event to set the height to the correct aspect for the new width?</li>
</ul>
 android ImageButton scale and maintain aspect ratio <p>i have a screen that i'm trying to layout... </p>

<p>basically, i'm trying to evenly distribute 4 ImageButton objects vertically on a screen... i used this <a href="http://andmobidev.blogspot.com/2010/01/setting-width-of-view-using-percentage.html" rel="nofollow">here</a> to evenly distribute the items, but now am having a terrible time getting the images to scale but maintain aspect ratio... if i use scaleType="centerInside" they don't scale, if i use "fitXY" they don't maintain aspect ratio... here is what the layout looks like:</p>

<p><img src="http://i.stack.imgur.com/QrbjS.png" alt="enter image description here"></p>

<p>and here is the code:
    </p>

<pre><code>    &lt;ImageButton android:id="@+id/share_song" 
        android:layout_width="fill_parent" android:text=""
        android:layout_marginLeft="0dp"
        android:layout_marginTop="15dp"
        android:layout_marginRight="5dp"
        android:layout_marginBottom="5dp"
        android:gravity="left" 
        android:src="@drawable/share_song_button_sel"
        android:adjustViewBounds="true"
        android:background="#0000"
        android:scaleType="fitXY"
      android:layout_height="0dp"
      android:layout_weight="1"
        &gt;&lt;/ImageButton&gt;
    &lt;Button 
        android:layout_width="wrap_content" 
        android:text="" android:id="@+id/tag_a_song"
        android:layout_marginLeft="5dp"
        android:layout_marginTop="10dp"
        android:layout_marginRight="0dp"
        android:layout_marginBottom="5dp"
        android:gravity="right" 
        android:layout_gravity="right"
        android:background="@drawable/song_check_in_button_sel"
      android:layout_height="0dp"
      android:layout_weight="1"
        &gt;&lt;/Button&gt;
    &lt;Button android:id="@+id/match_button" 
        android:layout_width="wrap_content" android:text=""
        android:layout_marginLeft="0dp"
        android:layout_marginTop="10dp"
        android:layout_marginRight="0dp"
        android:layout_marginBottom="5dp"
        android:gravity="left" 
        android:background="@drawable/music_match_button_sel"
      android:layout_height="0dp"
      android:layout_weight="1"
        &gt;&lt;/Button&gt;
    &lt;Button android:id="@+id/friends_button" 
        android:layout_width="wrap_content" android:text=""
        android:layout_marginLeft="0dp"
        android:layout_marginTop="10dp"
        android:layout_marginRight="0dp"
        android:layout_marginBottom="5dp"
        android:gravity="right" 
        android:layout_gravity="right"
        android:background="@drawable/my_friends_music_button_sel"
      android:layout_height="0dp"
      android:layout_weight="1"
        &gt;&lt;/Button&gt;

    &lt;LinearLayout
      xmlns:android="http://schemas.android.com/apk/res/android"
      android:layout_width="fill_parent"
      android:layout_height="0dp"
      android:layout_weight="1"
      android:orientation="horizontal"
      android:layout_marginRight="0dp"
      android:layout_marginLeft="0dp"
      android:layout_marginTop="0dp"
      android:padding="0dp" 
      &gt;
    &lt;LinearLayout
      xmlns:android="http://schemas.android.com/apk/res/android"
      android:layout_width="fill_parent"
      android:layout_height="65dp"
      android:orientation="horizontal"
      android:layout_marginRight="0dp"
      android:layout_marginLeft="0dp"
      android:layout_marginTop="0dp"
      android:padding="0dp" 
      android:layout_gravity="bottom"
      &gt;
    &lt;ImageView android:src="@drawable/trending_bar"
        android:layout_width="fill_parent"
        android:layout_height="wrap_content"
        android:layout_gravity="top"
      android:layout_marginRight="0dp"
      android:layout_marginLeft="0dp"
      android:layout_marginTop="10dp"
      android:scaleType="fitXY"
        &gt;
        &lt;/ImageView&gt;
        &lt;/LinearLayout&gt;
    &lt;/LinearLayout&gt; 
</code></pre>

<p></p>

<p>hopefully someone can help</p>
 android - getContext without activity <p>Is it possible to get device aspect ratio before launching any activity?</p>

<p>I am trying to setup the width based on whether my device is identified as 'long' or 'not_long'. This should be available long before the activity is launched but I am not sure where I can get this variable. Activity is NOT available at the time this method is executed. Also in order to avoid memory leaks I do not want to pass activity into the class that contains the following method.</p>

<p>Here is the failing call method: </p>

<pre><code>public int getDefaultWidth() { 
        Configuration myConfig = new Configuration();
        myConfig.setToDefaults();
        myConfig = getResources().getConfiguration();

        switch (myConfig.screenLayout &amp; Configuration.SCREENLAYOUT_LONG_MASK) {

            case Configuration.SCREENLAYOUT_LONG_NO: {
                return this._defaultWidth;
            }
            case Configuration.SCREENLAYOUT_LONG_YES: {
                return this._defaultWidthLong;
            }
            case Configuration.SCREENLAYOUT_LONG_UNDEFINED: {
                return this._defaultWidth;
            }
        }
        return this._defaultWidth;
    }
</code></pre>

<p>Thank you in advance!</p>
 CSS: resizing logo while maintaining aspect with browser <pre><code>#logo {
    background: url(/images/logo.png) 0 0 no-repeat;
    width: 268px;
    height: 96px;
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 1000;
}
</code></pre>

<p>This is my logo css and when I change the height and width to x% It just cuts of the bottom and right side of my logo image. How can I style my logo so that it stays at 5% of the browser width  while maintaining aspect? Thanks</p>
 Is there a list of screen resolutions for all Android based phones and tablets? <p>If not, is there a list of screen resolutions for the most popular Android phones and tablets.</p>
 Resizing while maintaining aspect ratio and rounding to even integers <p>I am allowing the user to resize an image while trying to maintain the original aspect ratio of the image.</p>

<p>For each resize operation I have an "offset" variable which indicates the width and height change.  This is based on the mouse movement, so it could be any combination of values depending on how much they moved the mouse while resizing.</p>

<p>What I am doing now is taking the larger of the two values (x and y change) and using that to calculate the other value at the same aspect ratio.  Here is my code:</p>

<pre><code>if (Math.Abs(offset.X) &gt; Math.Abs(offset.Y))
{
    offset.Y = (int)(offset.X / AspectRatio);
}
else
{
    offset.X = (int)(offset.Y * AspectRatio);
}
</code></pre>

<p>Aspect ratio is the standard width/height value.</p>

<p>The problem with my code is that it's using integer values so it's rounding and causing the aspect ratio to warp.</p>

<p>I assume what I need to do is snap to integer values that are evenly divisible by the aspect ratio, or something to that end.  But I don't know how to do it by modifying these x and y "offset" values.</p>
 How to [window setAspectRatio:size] to a x,y+92 format <p>I'm creating an OS X application, and I have a video player in a web view that covers 100% of the height and width of a window The player has 16:9 format, plus 92px in height for ads and player controls.</p>

<p>So I want to set the window's aspect ratio, so that when a user resizes the window, the aspect ratio of the video is maintained, <em>including</em> the extra 92px in height.</p>

<p>at the moment, I used;</p>

<pre><code>[window setAspectRatio:window.frame.size];
</code></pre>

<p>But obviously that also proportionally adds to the 92px constant and thus alters the video player's aspect ratio.</p>

<p>Can someone help me out here?</p>
 UIButton imageView - after UIViewContentModeScaleAspectFill how to move the image up? <p>I want to capture a picture using camera according to my guideline. When I saved it into a button and do the aspect ratio, the image focuses onto the middle part of the image. This would have been fine have I centered the guideline. But I want the guideline to be higher. Thus, I would like to move the image lower. Here is the code</p>

<pre><code>[personPhotoButton setImage:[info objectForKey:@"UIImagePickerControllerOriginalImage"] forState:UIControlStateNormal];
[[personPhotoButton imageView] setContentMode:UIViewContentModeScaleAspectFill];
</code></pre>

<p>I like the image in the button move down to show the upper potion of the image.</p>
 Resize UILabel correct on top of UIImageView <p>My problem is as follows:
I have on top of a <code>UIImageView</code> some labels. The image is a formular and the <code>UILabel</code>s represents the entries.
If I rotate the device the image inside <code>UIImageView</code> gets resized with option "aspect fit".
How can I achieve that the <code>UILabel</code> is also resized and aligned correct?
The normal options for resizing aren't working as needed.
The <code>UIImageView</code> is zoomable with minimumZoomScale and maximumZoomScale set.</p>

<p>Thanks.</p>
 OpenGL stretched shapes - aspect ratio <p>I got my openGL view at a size of (lets say..) 800(width)x600(height).
Then i got a 2D object of coords:</p>

<pre><code>0.0 , 0.0
0.1 , 0.0
0.1 , 0.1
0.0 , 0.1
</code></pre>

<p>this, as you understand is supposed to be a square (based on analogy).
But on my openGL view prints this stretched. Now, i understand why this is happening. Its basically because im working on the default matrix of -1,1.
And since my resolution of 800x600 doesnt have an aspect ratio of 1, my shape is getting stretched.</p>

<p>Now im more interested on how to fix this. Ive read about functions like glFrustum, glOrtho, glViewPort which are happening on the projection matrix and can address such issues. Thing is, im not sure on using them. What i basically want is keep the above coords when making a square and actually apear as a square on my View.</p>

<p>Whats the correct way of addressing this issue?</p>
 Aspect-ratio, using CSS and image doesn't render correcty? <p>Im just wondering if this is a browser rendering issue or incorrect css.
A nice way to scale a div in a defined aspect-ratio is, using a transparent image as a child element.
I have a small demo here. Under need this question.  </p>

<p>But why doesn't it work nicely if I want a height of 100%.</p>

<p>I tested this in FF10,  Safari 5.1.2, IE8 and IE9. (only ie8 seems to render correctly...)</p>

<p>Hope somebody can explain the problem and maybe come up with a solution.</p>

<p>Regards,
Rik </p>

<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="uk"&gt;
&lt;head&gt;
    &lt;title&gt;test&lt;/title&gt;
    &lt;style&gt;
      html
    , body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: green;
    }

/*  AUTO WIDTH - doesnt render correct when scaling the browser window to a smaller size */
    .holder1 {
        position: relative;
        display: inline-block;
        height: 100%;
        width: auto;
        background: yellow;
        border-right: 1px solid red;
    }

    .holder1 .ratio {
        display: block;
        height: 100%;
        width: auto;
    }

/*  AUTO HEIGHT - works fine */
    .holder2 {
        position: relative;
        display: inline-block;
        height: auto;
        width: 100%;
        background: yellow;
        border-right: 1px solid red;
    }

    .holder2 .ratio {
        display: block;
        height: auto;
        width: 100%;
    }


    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;span class="holder1"&gt;
        &lt;img src="/images/empty_image.png" class="ratio" alt="Ratio image"&gt;
    &lt;/span&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
 How to resize an image by keeping its aspect ration in Windows phone <p>I want to resize the image that I am going to display by keeping its aspect ratio.</p>

<p>How can I achieve that. ?</p>

<pre><code>    public MainPage()
    {
        InitializeComponent();

        myImage = new Image();
        Uri uri = new Uri("Penguins.jpg", UriKind.Relative);
        bit = new BitmapImage(uri);

        myImage.Source = bit;
        imagePanel.Children.Add(myImage);
    }
</code></pre>

<p>Here the image is stored in the variable bit. How can I resize it by keeping its aspect ratio ?</p>

<p>Thanks.</p>
 on Android, embedded html5 video tag would stretch the video playback <p>I have a video tag with width and height set to a dimension that does not fit the video's aspect ratio. When I see the page on an Android tablet, the video playback is stretched to fill the video 'frame'. Whereas on ipad or desktop browsers it will be centered.</p>

<pre><code>&lt;video width="xxx" height="yyy"&gt;
   &lt;source ...&gt;
   ...
&lt;/video&gt;
</code></pre>

<p>If I only use width but not height, then the video will maintain its aspect ratio but I want to keep the height and center the video playback.</p>

<p>Is there anyway to accomplish this on Android browsers?</p>

<p>Thanks,</p>
 
iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor iinterceptor NHibernate IInterceptor implementation(add properties to DB table that original domain class doesn't have) <p>How is possible to set some special column values when update/insert entities via NHibernate without extending domain classes with special properties?</p>

<p>for example: in my case i would like to get object and just moment before update/insert db add to that object some additional information (like user id or computer name) by using IInterceptor.In other words i would like to add few columns to DB Table with no specifying new properties in original object's class. Do i have to configure/change/add to my Object.hbm.xml or App.config in that case?
The problem is that i can't change my original objects and base classes.So i have to figure out if possible to add information to DB table with no changing of original objects(even no inherit from any base classes)</p>

<p>Example:</p>

<p>Original Object has : FirstName ,LastName,Birthday,Address properties</p>

<p>Customer.hbm.xml has:</p>

<p>


</p>

<p>My Interceptor class has method:</p>

<p>public bool OnSave(object entity, object id, object[] state, string[] propertyNames, NHibernate.Type.IType[] types)</p>

<p>at that moment or even maybe before save i have to add to the DB Customer table additional 2 columns (Computer Name and User Name for example ) that propertyNames[] and state[] parameters don't have them from the beginning,so that shuld be done on the fly.</p>

<p>MY DB Customer table has all the columns that i have described above.</p>

<p>Thank you.</p>
 NHibernate inteceptor not called for changes in many-to-many set/list <p>I have an application that uses NHibrenate and I'm using an interceptor based solution for logging/auditing.</p>

<p>Basically I have a class inheriting from EmptyInterceptor and overriding OnFlushDirty, OnSave and OnDelete.</p>

<p>Everything works perfectly - except - when I add or remove from a set or list that is mapped using many-to-many without changing any other properties none of the interceptor methods are called.</p>

<p>How can I hook into NHibrenate and detect those changes?</p>

<p>The class looks like:</p>

<pre><code>public class SomeClass
{
  ... properties ..
  private Iesi.Collections.ISet _setOfOthers = new Iesi.Collections.HashedSet();
  public virtual Iesi.Collections.ISet SetOfOthers
  {
    get { return _setOfOthers; }
    set { _setOfOthers = value; }       
  }
  ... some more properties ...
</code></pre>

<p>}</p>

<p>With this hbm mapping:</p>

<pre><code>&lt;class name="MyAssembly.SomeClass, MyAssembly" table="[SomeClass]"&gt;
   ... properties ..
   &lt;set name="SetOfOthers" table="SomeClass_SetOfOthers" cascade="none"&gt;
      &lt;key column="Owner" /&gt;
      &lt;many-to-many column="Item" class="MyAssembly.OtherClass, MyAssembly" /&gt;
   &lt;/set&gt;
   .. some more properties ...
&lt;/class&gt;
</code></pre>

<p>I'm using NHibrenate 2.0.1 (if that makes any difference), this is not a good time in the project life cycle to upgrade NHibrenate - but I will upgrade if I absolutely have to.</p>

<p>Thanks.</p>
 Autofac using DynamicProxy2 Interception with WcfIntegration <p>I'm struggling to wire up a service interface using WcfIntegration with an IInterceptor.</p>

<p>There are examples for each in the autofac documentation but nothing that combines the two.</p>

<p>Here is the documentation for the <a href="http://code.google.com/p/autofac/wiki/WcfIntegration" rel="nofollow">WcfIntegration</a> and look here for the <a href="http://code.google.com/p/autofac/wiki/DynamicProxy2" rel="nofollow">DynamicProxy2</a>
documentation.</p>

<p>Has anyone successfully wired up an interceptor with WcfIntegration using Autofac?</p>

<p>Example code I'd have expected to work:</p>

<pre><code>            builder.Register(c =&gt; new CacheInterceptor())
            .Named&lt;IInterceptor&gt;("cache-calls");

        builder
            .RegisterType&lt;ChannelFactory&lt;IEnquiryService&gt;&gt;()
            .AsSelf()
            .WithParameter(new NamedParameter("endpointConfigurationName", "EnquiryService"))
            .SingleInstance();

        builder
            .Register(c =&gt; c.Resolve&lt;ChannelFactory&lt;IEnquiryService&gt;&gt;().CreateChannel())
            .As&lt;IEnquiryService&gt;()
            .EnableInterfaceInterceptors()
            .InterceptedBy("cache-calls");
</code></pre>

<p>EDIT: </p>

<p>Seems like a bug has been logged on <a href="http://code.google.com/p/autofac/issues/detail?id=361&amp;q=dynamicproxy2" rel="nofollow">autofac site.</a> Any work arounds for this?</p>
 Problem with Windsor Calls to "Genericized" Methods After Adding an Interceptor <p>I have an application that was working fine that uses Windsor for IoC.  I want to log the method calls, parameters, and execution time of all calls made to components instantiated by Windsor, so I implemented a LoggingInterceptor that implements IInterceptor, that contains:</p>

<pre><code>Stopwatch sw = new System.Diagnostics.Stopwatch();
sw.Start();
invocation.Proceed();  // EXCEPTION IS THROWN HERE
sw.Stop();
Logger.Debug(.....
</code></pre>

<p>Now operations that previously worked fine are throwing VerificationExceptions with the following message:</p>

<p>Method Repositories.RepositoryBase.GetAll: type argument 'ET' violates the constraint of type parameter 'ET'.</p>

<p>The signature of the method is:</p>

<pre><code>public IList&lt;ET&gt; GetAll&lt;ET&gt;() where ET : EntityBase2, IEntity2
</code></pre>

<p>(where EntityBase2 and IEntity2 are from LLBLGenPro) </p>

<p>The caller of the method is as follows:</p>

<pre><code>public IList&lt;ServerEntity&gt; GetServers()
{
   return GetRepository&lt;IServerRepository&gt;().GetAll&lt;ServerEntity&gt;();
}
</code></pre>

<p>(where GetRepository&lt;>() is just a wrapper around ServiceLocator)</p>

<p>If I comment out the interceptor from the castle configuration, it all works fine again.  </p>

<p>Why is this happening now, and is there a fix so I can use my logging interceptor?</p>

<p>thanks</p>
 Lazy load a collection of data from a service, not the database <p>My domain objects support custom fields that are stored in such a way that requires metadata and logic to be applied before their values can be stored and retrieved.  </p>

<p>I already have a Custom Field Repository that handles the persistence of custom fields, and I don't want to try to recreate that logic in NHibernate mappings.</p>

<p>I would however like to support lazy loading of my custom fields.  It would be nice if I could somehow trick the proxy into calling my dedicated repository for loading and saving rather than going through the NHibernate engine.  </p>

<p>One way I solved this problem was to implement an interceptor which worked, but I took a performance hit when loading large amounts of data, because the dedicated repository was called each time an entity was loaded.  It would be nice instead, if those calls to load custom fields were done lazily!  From what I understand lazy loading cannot be done in an interceptor.</p>

<p>I have looked into implementing a custom user type (IUserType and IUserCollectionType), but the documentation is very limited, and I want to learn if it is even possible to do what I want before I go down the path of trying.</p>

<p>Here is an example of one of my domain objects:</p>

<pre><code>public class ContactEntity : ICustomFieldContainer
{
      public long ContactId { get; set; }
      public String FirstName { get; set; }
      public String LastName { get; set; }  
      #region ICustomFieldContainer Members  
      public List&lt;CustomFieldEntity&gt; CustomFields { get; set; }  
      #endregion

}
</code></pre>
 Intercept Properties With Castle Windsor IInterceptor <p>Does anyone have a suggestion on a better way to intercept a properties with Castle DynamicProxy? Specifcally, I need the PropertyInfo that I'm intercepting, but it's not directly on the IInvocation, so what I do is:</p>

<pre><code>        public static PropertyInfo GetProperty(this MethodInfo method)
    {
        bool takesArg = method.GetParameters().Length == 1;
        bool hasReturn = method.ReturnType != typeof(void);
        if (takesArg == hasReturn) return null;
        if (takesArg)
        {
            return method.DeclaringType.GetProperties()
                .Where(prop =&gt; prop.GetSetMethod() == method).FirstOrDefault();
        }
        else
        {
            return method.DeclaringType.GetProperties()
                .Where(prop =&gt; prop.GetGetMethod() == method).FirstOrDefault();
        }
    }
</code></pre>

<p>Then in my IInterceptor:</p>

<pre><code>  #region IInterceptor Members

    public void Intercept(IInvocation invocation)
    {
        bool doSomething =                                 invocation.Method.GetProperty().GetCustomAttributes(true).OfType&lt;SomeAttribute&gt;().Count() &gt; 0;

    }

    #endregion
</code></pre>

<p>Thanks.</p>
 NHibernate IInterceptor implementation(without extending domain classes with special properties) <p>How is possible to set some special column values when update/insert entities via NHibernate without extending domain classes with special properties?</p>

<p>for example: in my case i would like to get object and just moment before update/insert db 
add to that object some additional information (like user id or computer name) by using IInterceptor.In other words i would like to add few columns to DB Table with no specifying new properties in original object's class.
Do i have to configure/change/add to my Object.hbm.xml or App.config in that case?</p>

<p>Thank you </p>
 Castle.Windsor Register AllTypes With An Interceptor <p>Why does the following not intercept calls to IBusinessService with the LogAspect?</p>

<pre><code>container.Register(AllTypes.Of&lt;IBusinessService&gt;()
    .FromAssembly(Assembly.GetExecutingAssembly())
    .ConfigureFor&lt;BusinessService&gt;(
        c =&gt; c.Named(typeof(BusinessService).Name)
            .Interceptors(InterceptorReference.ForType&lt;LogAspect&gt;()).Anywhere));
</code></pre>

<p>If I register each implementation of IBusinessService using the Component.For syntax then it works.</p>
 NHibernate add unmapped column in interceptor <p>I'm trying to save a mapped entity using NHibernate but my insert to the database fails because the underlying table has a column that does not allow nulls and IS NOT mapped in my domain object. The reason it isn't mapped is because the column in question supports a legacy application and has no relevance to my application - so I'd like to not pollute my entity with the legacy property.</p>

<p>I know I could use a private field inside my class - but this still feels nasty to me. I've <a href="http://stackoverflow.com/questions/579885/unmapped-columns-in-nhibernate">read</a> that I can use an NHibernate interceptor and override the OnSave() method to add in the new column right before my entity is saved. This is proving difficult since I can't work out how to add an instance of Nhibernate.type.IType to the types parameter of my interceptor's OnSave.</p>

<p>My Entity roughly looks like this:</p>

<pre><code>public class Client
{
    public virtual int Id { get; set; }
    public virtual int ParentId { get; set; }
    public virtual string Name { get; set; }
    public virtual string Phone { get; set; }
    public virtual string Email { get; set; }
    public virtual string Url { get; set; }
}
</code></pre>

<p>And my interceptor</p>

<pre><code> public class ClientInterceptor : EmptyInterceptor
{

    public override bool OnSave(object entity, object id, object[] state, string[] propertyNames, NHibernate.Type.IType[] types)
    {
        if (entity is Client)
        {
            /*
              manually add the COM_HOLD column to the Client entity
            */
            List&lt;string&gt; pn_list = propertyNames.ToList();
            pn_list.Add("COM_HOLD");
            propertyNames = pn_list.ToArray();

            List&lt;Object&gt; _state = state.ToList();
            _state.Add(false);
            state = _state.ToArray();

            //somehow add an IType to types param ??

         }
         return base.OnSave(entity, id, state, propertyNames, types);
    }
}
</code></pre>

<p>Does anyone have any ideas on how to do this properly?</p>
 Castle DynamicProxy2: Get the Target inside an Interceptor? <p>I'm using Castle DynamicProxy2 to "tack on" interfaces to retrieve fields from a dictionary.  For example, given the following class:</p>

<pre><code>public class DataContainer : IDataContainer
{
    private Dictionary&lt;string, object&gt; _Fields = null;

    public Dictionary&lt;string, object&gt; Data
    {
        get { return _Fields ?? (_Fields = new Dictionary&lt;string, object&gt;()); }
    }
}
</code></pre>

<p>I want to use the following interface as an interface proxy to extract the "Name" value out of the Fields dictionary:</p>

<pre><code>public interface IContrivedExample
{
    string Name { get; }
}
</code></pre>

<p>From an interceptor, I want to get the "target" DataContainer, and return the "Name" value:</p>

<pre><code>public void Intercept(IInvocation invocation)
{
    object fieldName = omitted; // get field name based on invocation information

    DataContainer container = ???; // this is what I'm trying to figure out
    invocation.ReturnValue = container.Fields[fieldName];
}

// Somewhere in code
var c = new DataContainer();
c.Fields.Add("Name", "Jordan");

var pg = new ProxyGenerator();
IContrivedExample ice = (IContrivedExample) pg.CreateInterfaceProxyWithTarget(..., c, ...);
Debug.Assert(ice.Name == "Jordan");
</code></pre>

<p>Any thoughts on how to get the underlying target</p>

<p>Note: this is a contrived example I'm using to establish some context around the question I have.</p>
 Castle Interceptors With Fluent Interface <p>I'm trying to get an interceptor I've written to work, but for some reason it doesn't seem to be instantiating the interceptor when I request my components.  I'm doing something like this (forgive me if this doesn't quite compile, but you should get the idea):</p>

<pre><code>container.Register(
    Component.For&lt;MyInterceptor&gt;().LifeStyle.Transient,
    AllTypes.Pick().FromAssembly(...).If(t =&gt; typeof(IView).IsAssignableFrom(t)).
    Configure(c =&gt; c.LifeStyle.Is(LifestyleType.Transient).Named(...).
                   Interceptors(new InterceptorReference(typeof(MyInterceptor)).
    WithService.FromInterface(typeof(IView)));
</code></pre>

<p>I've put breakpoints in the constructor for the Interceptor and it doesn't seem to be instantiating it at all.  </p>

<p>In the past I've registered my interceptors using the XML configuration, but I'm keen to use the fluent interface.</p>

<p>Any help would be greatly appreciated!</p>
 Register custom NHibernate Interceptor via Windsor <p>I created a simple AuditInterceptor: EmptyInterceptor now I wonder how can I register this new interceptor with my application using Windsor?</p>
 Castle.Core.InterceptorAttribute not injecting interceptor <p>Based on the <a href="http://stw.castleproject.org/Windsor.Interceptors.ashx" rel="nofollow">documentation for Castle.Core.InterceptorAttribute</a>, I am trying to make this simple test pass, and am having no luck:</p>

<pre><code>using NUnit.Framework;
using Castle.DynamicProxy;
using Castle.Core;
using Castle.MicroKernel;
using Castle.MicroKernel.Registration;


public interface IIntercepted { string get(); }

[Interceptor(typeof(TestInterceptor))]
public class Intercepted : IIntercepted
{
    public virtual string get() { return "From Service"; }
}

public class TestInterceptor : IInterceptor
{
    public void Intercept(IInvocation invocation)
    {
        invocation.Proceed();
        invocation.ReturnValue = "From Proxy";
    }
}
[TestFixture]
public class TestFixture
{
    [Test]
    public void Test_interception()
    {
        var container = new DefaultKernel();
        container.Register(
            Component.For&lt;TestInterceptor&gt;().LifeStyle.Transient,
            Component.For&lt;IIntercepted&gt;().ImplementedBy&lt;Intercepted&gt;());

        var instance = container.Resolve&lt;IIntercepted&gt;();
        Assert.That(instance.get(), Is.EqualTo("From Proxy"));
    }
}
</code></pre>

<p>In stepping through the tests, <code>instance</code> is not a proxy and <code>get()</code> returns "From Service".  It seems to me that in this case, I should not need to make <code>get()</code> virtual, but did so just to be sure.  I have the feeling I am missing something obvious and fundamental here, like is there a facility that needs to be registered here to make the container aware of the Interceptor attribute?  I can't find any documentation to that effect.  Can someone tell me what I am doing wrong?</p>

<p>I am using Castle version 2.5 and the 4.0 version of the .Net Framework.</p>
 Filtering objects OnLoad NHibernate IInterceptor <p>I am having a problem loading objects using NHibernate. These entities have reference to files which no longer exist. When NHibernate assigns the 'Path' property of these entities these entities try to load the file which results in a an exception. The exception causes the loading transaction to roll-back completely.</p>

<p>I would like to keep my entities unchanged so they keep loading the file once Path is set. 
In the case that I am loading from DB i would like to skip these entities and load the rest of my project.</p>

<p>I was thinking about using an IInterceptor to get this done. Basiccally i would like to filter my file based objects before I load them. </p>

<p>I would like to hear any thoughts about similar problems and whether my 'solution' is feasible and possible.</p>

<p>Greetings,
Martijn </p>
 saving objects in NHibernate IInterceptor <p>I set up an IInterceptor for ILoggable objects in my domain model. And on OnFlushDirty event, i am trying to save a log (audit). But while doing this, my code goes into an infinite loop. </p>

<p>_logrepository.Save(log) calls OnFlushDirty even if log is not an ILoggable object (it is because entity is still the previous object)</p>

<p>Is there a way to use .Save (without opening another session) in IInterceptor, or how do I insert a log into database in IInterceptor?</p>

<pre><code>
public override bool OnFlushDirty(object entity, object id, object[] currentState, object[] previousState, string[] propertyNames, NHibernate.Type.IType[] types)
    {
      //find diffs, log each change
      if (entity is ILoggable && entity is NamedEntity)
      {
        var namedEntity = entity as NamedEntity;
        for (var i = 0; i &lt; currentState.Count(); i++)
        {
          if (currentState[i] != previousState[i])
          {
            var log = new Log()
                        {
                          Description = "update",
                          InDate = namedEntity.ModifiedDate.Value,
                          ItemId = namedEntity.Id,
                          ItemType = namedEntity.GetType().Name,
                          NewValue = currentState[i].ToString(),
                          OldValue = previousState[i].ToString(),
                          PropertyName = propertyNames[i],
                          UserId = namedEntity.ModifiedByUserId.Value
                        };

            // calling save calls onflushdirty again, where entity is not log, but the same entity of the first call
            ObjectFactory.GetInstance().Save(log);
          }
        }
      }
      return base.OnFlushDirty(entity, id, currentState, previousState, propertyNames, types);
    }
</code></pre>
 Register an Interceptor with Castle Fluent Interface <p>I am trying to implement <a href="http://groups.google.com/group/autofac/browse_thread/thread/f10badba5fe0d546/e64f2e757df94e61?lnk=gst&amp;q=transaction#e64f2e757df94e61" rel="nofollow">nhibernate transaction handling</a> through Interceptors and couldn’t figure out how to register the interface through fluent mechanism.  </p>

<p>I see a   </p>

<pre><code>Component.For&lt;ServicesInterceptor&gt;().Interceptors
</code></pre>

<p>but not sure how to use it. Can someone help me out? <a href="http://stackoverflow.com/questions/1188957/castle-interceptors-with-fluent-interface">This example</a> seemed a little complex.</p>
 Proxy is created, and interceptor is in the __interceptors array, but the interceptor is never called <p>This is the first time I've used interceptors with the fluent registration and I'm missing something.  With the following registration, I can resolve an IProcessingStep, and it's a proxy class and the interceptor is in the __interceptors array, but for some reason, the interceptor is not called.  Any ideas what I'm missing?</p>

<p>Thanks,
Drew</p>

<pre><code>AllTypes.Of&lt;IProcessingStep&gt;()
 .FromAssembly(Assembly.GetExecutingAssembly())
 .ConfigureFor&lt;IProcessingStep&gt;(c =&gt; c
  .Unless(Component.ServiceAlreadyRegistered)
  .LifeStyle.PerThread
  .Interceptors(InterceptorReference.ForType&lt;StepLoggingInterceptor&gt;()).First
  ),
Component.For&lt;StepMonitorInterceptor&gt;(),
Component.For&lt;StepLoggingInterceptor&gt;(),
Component.For&lt;StoreInThreadInterceptor&gt;()


public abstract class BaseStepInterceptor : IInterceptor
{
 public void Intercept(IInvocation invocation)
 {
  IProcessingStep processingStep = (IProcessingStep)invocation.InvocationTarget;
  Command cmd = (Command)invocation.Arguments[0];
  OnIntercept(invocation, processingStep, cmd);
 }

 protected abstract void OnIntercept(IInvocation invocation, IProcessingStep processingStep, Command cmd);
}

public class StepLoggingInterceptor : BaseStepInterceptor
{
 private readonly ILogger _logger;

 public StepLoggingInterceptor(ILogger logger)
 {
  _logger = logger;
 }

 protected override void OnIntercept(IInvocation invocation, IProcessingStep processingStep, Command cmd)
 {
  _logger.TraceFormat("&lt;{0}&gt; for cmd:&lt;{1}&gt; - begin", processingStep.StepType, cmd.Id);

  bool exceptionThrown = false;

  try
  {
   invocation.Proceed();
  }
  catch
  {
   exceptionThrown = true;
   throw;
  }
  finally
  {
   _logger.TraceFormat("&lt;{0}&gt; for cmd:&lt;{1}&gt; - end &lt;{2}&gt; times:&lt;{3}&gt;",
        processingStep.StepType, cmd.Id,
        !exceptionThrown &amp;&amp; processingStep.CompletedSuccessfully 
         ? "succeeded" : "failed",
        cmd.CurrentMetric==null ? "{null}" : cmd.CurrentMetric.ToString());
  }
 }
}
</code></pre>
 How to do URL authentication in struts2 <p>I am using struts2.1.6 + Spring 2.5 I have four modules in my application.</p>

<ol>
<li>Registration Module</li>
<li>Admin Module</li>
<li>Quote Module</li>
<li>Location Module.</li>
</ol>

<p>In registration module the customer can register himself and only after registering he is supposed to have access of the remaining three modules.</p>

<p>I want to implement something like if the action being called belongs to the registration module it will work as normal but if the action being called belongs to the rest of those three modules it first should check if the user is logged-in and session has not timed-out. if yes it should proceed normally otherwise it should redirect to the login page.</p>

<p>Through research I have found out that interceptors could be used for this purpose but before proceeding I thought its better to get some feedback on it from experts. </p>

<p>Please suggest how it should be done and If possible put some code suggestions.</p>

<p>Here is my <b>struts.xml</b> file(The struts.xml contains four different config files belonging to each module):</p>

<pre><code>    &lt;struts&gt;
    &lt;include file="struts-default.xml" /&gt;
    &lt;constant name="struts.i18n.reload" value="false" /&gt;
    &lt;constant name="struts.objectFactory" value="spring" /&gt;
    &lt;constant name="struts.devMode" value="false" /&gt;
    &lt;constant name="struts.serve.static.browserCache" value="false" /&gt;
    &lt;constant name="struts.enable.DynamicMethodInvocation" value="true" /&gt;
    &lt;constant name="struts.multipart.maxSize" value="10000000" /&gt;
    &lt;constant name="struts.multipart.saveDir" value="C:/Temporary_image_location" /&gt;

    &lt;include file="/com/action/mappingFiles/registration_config.xml" /&gt;
    &lt;include file="/com/action/mappingFiles/admin_config.xml" /&gt;
    &lt;include file="/com/action/mappingFiles/quote.xml" /&gt;
    &lt;include file="/com/action/mappingFiles/location_config.xml" /&gt;

&lt;/struts&gt;
</code></pre>

<p>The sample <b>registration_config.xml</b> file is:</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE struts PUBLIC "-//Apache Software Foundation//DTD Struts Configuration 2.0//EN" "http://struts.apache.org/dtds/struts-2.0.dtd"&gt;
&lt;struts&gt;
    &lt;package name="registration" extends="struts-default"
        namespace="/my_company"&gt;

        &lt;action name="LoginView" class="registration" method="showLoginView"&gt;
            &lt;result&gt;....&lt;/result&gt;
            &lt;result name="input"&gt;...&lt;/result&gt;
        &lt;/action&gt;
         &lt;/package&gt;
&lt;/struts&gt;
</code></pre>

<p>The sample <b>admin_config.xml</b> file is:</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
    &lt;!DOCTYPE struts PUBLIC "-//Apache Software Foundation//DTD Struts Configuration 2.0//EN" "http://struts.apache.org/dtds/struts-2.0.dtd"&gt;
    &lt;struts&gt;
        &lt;package name="admin" extends="struts-default"
            namespace="/my_company"&gt;

            &lt;action name="viewAdmin" class="admin" method="showAdminView"&gt;
                &lt;result&gt;....&lt;/result&gt;
                &lt;result name="input"&gt;...&lt;/result&gt;
            &lt;/action&gt;
             &lt;/package&gt;
    &lt;/struts&gt;
</code></pre>

<p>Same code is there in the rest of two struts2 xml config files. I have used the same namespace in all the four config files with the different package names(As you can see)</p>
 Is it better to create proxies for table with multi-faceted domains or use inheritance? <p>I'm using NHibernate and Dynamic Proxy. I have one table (Customer) with generic fields: charField1, charField2, etc. One record in this table may represent company A while another record may represent company B. However, a different domain model will exist for company A's data than company B's data because they require different information. Likewise, Company A will make use of a different business logic layer than Company B.</p>

<p>Because of this, CompanyA's record would have different associations with different tables than Company B.</p>

<p>I have been reading about the use of proxies and their capabilities in NHibernate and it seems like this could be useful for my scenario; however, <strong>would it be better to simply inherit from BaseCompanyTable?</strong></p>

<p>If I use a proxy, I'm imagining creating interfaces that simply have the appropriate mappings to other tables/domains based on the company's mapping type and that is what the interceptor would handle. My ViewModel would then query only that company information and have the interfaces to deal with. When it saves, the business logic would validate it, post it, the interceptor would only save the BaseCompanyTable.</p>
 Is it possible to get label of any text field inside any interceptor? <p>I have made a custom interceptor to display the error messages in my own format. It is successful to an extent. </p>

<p>But i would like to know can we get label of any textfield directly from invocation object?</p>

<p>Thanks in advance</p>
 DynamicProxy2: CreateClassProxyWithTarget + IInterceptor <p>If I've missed this in another question I apologize; I looked for a good while before deciding I had a unique question... I want to use DynamicProxy2 to provide interception for a WPF application's model classes.  This is so that I do not have to fully implement INotifyPropertyChanged everywhere.  For instance, the below class should fully participate in two-way data binding once proxied and intercepted:</p>

<pre><code>public class ModelExample : INotifyPropertyChanged
{
    public event PropertyChangedEventHandler PropertyChanged;

    public int Id{ get; set; }
    public string Uri{ get; set; }
    public string Name{ get; set; }
}
</code></pre>

<p>I have found that I can create a new instance of the model class and intercept calls to it by calling the CreateClassProxy method: </p>

<pre><code>new ProxyGenerator().CreateClassProxy&lt;T&gt;(interceptors);
</code></pre>

<p>Unfortunately, this forces me to allow the <code>ProxyGenerator</code> class to create my model instances, and I'm getting those back from my middle tier, i.e. they already exist.  I need to wrap existing objects, so I <strong>think</strong> I need to call <code>CreateClassProxyWithTarget</code> instead:</p>

<pre><code>new ProxyGenerator().CreateClassProxyWithTarget(instance, interceptors);
</code></pre>

<p>However, when I do that my interceptor stops functioning.  I'm pretty sure it's not the interceptor's fault... it's a very simple object.  Here's its interface:</p>

<pre><code>public interface IFluentInterceptor : IInterceptor
{
    IFluentInterceptor Before(Action&lt;IInvocation&gt; before);
    IFluentInterceptor After(Action&lt;IInvocation&gt; after);
    IFluentInterceptor Finally(Action&lt;IInvocation&gt; @finally);
    IFluentInterceptor RunCondition(Func&lt;IInvocation, bool&gt; runCondition);
    IFluentInterceptor OnError(Func&lt;IInvocation, Exception, bool&gt; onError);
}
</code></pre>

<p>The <code>FluentInterceptor</code> type implements this.  The <code>Before</code>, <code>After</code>, etc. methods are too simple to show; they all add to action queues that are meant to be used during method invocation, then each method returns <code>this</code>, allowing for method chaining.</p>

<p>The below code doesn't work, but I can't figure out why:</p>

<pre><code>new ProxyGenerator().CreateClassProxyWithTarget(instance, new FluentInterceptor()
    .After(invocation =&gt;
    {
        if (!invocation.Method.Name.StartsWith("set_")) return;
        string propertyName = invocation.Method.Name.Substring(4);
        FieldInfo info = invocation.TargetType.GetFields(BindingFlags.Instance | BindingFlags.NonPublic)
            .Where(f =&gt; f.FieldType.Equals(typeof (PropertyChangedEventHandler)))
            .FirstOrDefault();
        if (info == null) return;
        var handler = info.GetValue(invocation.InvocationTarget) as PropertyChangedEventHandler;
        if (handler != null) handler.Invoke(invocation.TargetType, new PropertyChangedEventArgs(propertyName));
    }));
</code></pre>

<p>If I try that with <code>CreateClassProxy</code>, it works like a charm.  Does anybody see what I'm doing wrong?</p>

<p>Thanks!</p>
 how to use many interceptors for each type of url spring security 2 <p>I want to use two interceptors, one for my struts actions and the second for my webservices.
Is it possible to have one interceptor to test urls like /rest/documents and the second one for all the other requests ?
Thnx </p>
 Error response in json format for Spring interceptor <p>I am writing a REST based web service. I need to return all the responses as JSON format. I have an interceptor to validate my authentication parameters. On authentication failure scenario, I have to return the error response in JSON format.</p>

<p>Currently i am doing </p>

<p>response.setHeader("Content-Type","application/json");
response.sendError(HttpServletResponse.SC_UNAUTHORIZED, "{\"error\":\"Missing Authentication Parameters\"}");</p>

<p>The response body is coming as below.</p>

<p>JBoss Web/2.1.3.GA - Error report <h1>HTTP Status 401 - {&quot;error&quot;:&quot;Missing Authentication Parameters&quot;}</h1><p><b>type</b> Status report</p><p><b>message</b> {&quot;error&quot;:&quot;Missing Authentication Parameters&quot;}</p><p><b>description</b> This request requires HTTP authentication ({&quot;error&quot;:&quot;Missing Authentication Parameters&quot;}).</p><h3>JBoss Web/2.1.3.GA</h3></p>

<p>I need just the JSON string in response. Please help me.</p>
 Is there any source code that goes along with the Castle Windsor Logging Interceptor Example? <p>This is a great wiki article: <a href="http://docs.castleproject.org/Windsor.Introduction-to-AOP-With-Castle.ashx" rel="nofollow">http://docs.castleproject.org/Windsor.Introduction-to-AOP-With-Castle.ashx</a></p>

<p>However, it is missing code for the DataContractSerialize. I am pretty sure that this method is fairly simple, but, for completeness, it would be great to have an example.</p>

<p>Does one exists? Or, is there a working example of the code?</p>

<p>Thanks</p>

<p>S</p>
 
aspectmap Add Aspects to ASP.NET MVC controller using AspectMap <p>We're looking at using an AOP framework for handling things like logging, tracing, and exception handling. I've built a prototype using PostSharp and now I'm trying to build the same functionality using AspectMap.</p>

<p>In a nutshell, I have an ASP.NET MVC 3 application and I want an aspect that I can easily attach to my controller methods that shows the entry, exit, execution time, and argument values. My PoC is the basic MVC 3 Internet Application template (File > New > Project > Web > ASP.NET MVC 3 Web Application > Internet). What I've done so far...</p>

<p>Created an AspectsRegistry</p>

<pre><code>public class PoCRegistry : AspectsRegistry
{
    public PoCRegistry()
    {
        ForAspect&lt;ProfileAttribute&gt;().HandleWith&lt;ProfileHandler&gt;();
    }
}
</code></pre>

<p>Created a StructureMapControllerFactory</p>

<pre><code>public class StuctureMapControllerFactory : DefaultControllerFactory
{
    protected override IController GetControllerInstance( RequestContext requestContext, Type controllerType )
    {
        if( controllerType == null ) return null;

        try
        {
            return ObjectFactory.GetInstance( controllerType ) as Controller;
        }
        catch( StructureMapException )
        {
            Debug.WriteLine( ObjectFactory.WhatDoIHave() );
            throw;
        }
    }
}
</code></pre>

<p>Registered everything in Application_Start</p>

<pre><code>protected void Application_Start()
{
    AreaRegistration.RegisterAllAreas();

    RegisterGlobalFilters( GlobalFilters.Filters );
    RegisterRoutes( RouteTable.Routes );

    ObjectFactory.Initialize( ie =&gt; ie.AddRegistry( new PoCRegistry() ) );
    ControllerBuilder.Current.SetControllerFactory( new StuctureMapControllerFactory() );
}
</code></pre>

<p>At this point the application works, and I can see it's using my StructureMapControllerFactory to build the controller (debugger steps into that code). The problem is that I can't figure out where or how to "enrich" the controller that is generated. In the <a href="http://www.chrissurfleet.co.uk/post/2012/05/29/AspectMap-%E2%80%93-Aspect-Oriented-Programming-for-Complete-Beginners.aspx" rel="nofollow">tutorial</a> it says I need to use something like the following:</p>

<pre><code>For&lt;ICaseController&gt;()
    .Use&lt;CaseController&gt;()
    .EnrichWith( AddAspectsTo&lt;CaseController&gt; );
</code></pre>

<p>But in the tutorial that goes in the AspectRegistry, which doesn't seem like the right place in this situation because the registry isn't responsible for resolving the controller request, the controller factory is. Unfortunately the GetInstance() method in the controller factory returns an <code>object</code> and the EnrichWith() method needs a <code>SmartInstance</code>.</p>

<p>At this point I'm stuck. Any hints, pointers, or assistance would be appreciated.</p>
 
reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit reflection.emit Curiosity: Why does Expression<...> when compiled run faster than a minimal DynamicMethod? <p>I'm currently doing some last-measure optimizations, mostly for fun and learning, and discovered something that left me with a couple of questions.</p>

<p>First, the questions:</p>

<ol>
<li>When I construct a method in-memory through the use of <a href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.dynamicmethod.aspx">DynamicMethod</a>, and use the debugger, is there any way for me to step into the generated assembly code, when vieweing the code in the disassembler view? The debugger seems to just step over the whole method for me</li>
<li>Or, if that's not possible, is it possible for me to somehow save the generated IL code to disk as an assembly, so that I can inspect it with <a href="http://www.red-gate.com/products/reflector/">Reflector</a>?</li>
<li>Why does the <code>Expression&lt;...&gt;</code> version of my simple addition method (Int32+Int32 => Int32) run faster than a minimal DynamicMethod version?</li>
</ol>

<p>Here's a short and complete program that demonstrates. On my system, the output is:</p>

<pre><code>DynamicMethod: 887 ms
Lambda: 1878 ms
Method: 1969 ms
Expression: 681 ms
</code></pre>

<p>I expected the lambda and method calls to have higher values, but the DynamicMethod version is consistently about 30-50% slower (variations probably due to Windows and other programs). Anyone know the reason?</p>

<p>Here's the program:</p>

<pre><code>using System;
using System.Linq.Expressions;
using System.Reflection.Emit;
using System.Diagnostics;

namespace Sandbox
{
    public class Program
    {
        public static void Main(String[] args)
        {
            DynamicMethod method = new DynamicMethod("TestMethod",
                typeof(Int32), new Type[] { typeof(Int32), typeof(Int32) });
            var il = method.GetILGenerator();

            il.Emit(OpCodes.Ldarg_0);
            il.Emit(OpCodes.Ldarg_1);
            il.Emit(OpCodes.Add);
            il.Emit(OpCodes.Ret);

            Func&lt;Int32, Int32, Int32&gt; f1 =
                (Func&lt;Int32, Int32, Int32&gt;)method.CreateDelegate(
                    typeof(Func&lt;Int32, Int32, Int32&gt;));
            Func&lt;Int32, Int32, Int32&gt; f2 = (Int32 a, Int32 b) =&gt; a + b;
            Func&lt;Int32, Int32, Int32&gt; f3 = Sum;
            Expression&lt;Func&lt;Int32, Int32, Int32&gt;&gt; f4x = (a, b) =&gt; a + b;
            Func&lt;Int32, Int32, Int32&gt; f4 = f4x.Compile();
            for (Int32 pass = 1; pass &lt;= 2; pass++)
            {
                // Pass 1 just runs all the code without writing out anything
                // to avoid JIT overhead influencing the results
                Time(f1, "DynamicMethod", pass);
                Time(f2, "Lambda", pass);
                Time(f3, "Method", pass);
                Time(f4, "Expression", pass);
            }
        }

        private static void Time(Func&lt;Int32, Int32, Int32&gt; fn,
            String name, Int32 pass)
        {
            Stopwatch sw = new Stopwatch();
            sw.Start();
            for (Int32 index = 0; index &lt;= 100000000; index++)
            {
                Int32 result = fn(index, 1);
            }
            sw.Stop();
            if (pass == 2)
                Debug.WriteLine(name + ": " + sw.ElapsedMilliseconds + " ms");
        }

        private static Int32 Sum(Int32 a, Int32 b)
        {
            return a + b;
        }
    }
}
</code></pre>
 Why is Calli Faster Than a Delegate Call? <p>I was playing around with Reflection.Emit and found about about the little-used <a href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.ilgenerator.emitcalli.aspx" rel="nofollow"><code>EmitCalli</code></a>. Intrigued, I wondered if it's any different from a regular method call, so I whipped up the code below:</p>

<pre><code>using System;
using System.Diagnostics;
using System.Reflection.Emit;
using System.Runtime.InteropServices;
using System.Security;

[SuppressUnmanagedCodeSecurity]
static class Program
{
    const long COUNT = 1 &lt;&lt; 22;
    static readonly byte[] multiply = IntPtr.Size == sizeof(int) ?
      new byte[] { 0x8B, 0x44, 0x24, 0x04, 0x0F, 0xAF, 0x44, 0x24, 0x08, 0xC3 }
    : new byte[] { 0x0f, 0xaf, 0xca, 0x8b, 0xc1, 0xc3 };

    static void Main()
    {
        var handle = GCHandle.Alloc(multiply, GCHandleType.Pinned);
        try
        {
            //Make the native method executable
            uint old;
            VirtualProtect(handle.AddrOfPinnedObject(),
                (IntPtr)multiply.Length, 0x40, out old);
            var mulDelegate = (BinaryOp)Marshal.GetDelegateForFunctionPointer(
                handle.AddrOfPinnedObject(), typeof(BinaryOp));

            var T = typeof(uint); //To avoid redundant typing

            //Generate the method
            var method = new DynamicMethod("Mul", T,
                new Type[] { T, T }, T.Module);
            var gen = method.GetILGenerator();
            gen.Emit(OpCodes.Ldarg_0);
            gen.Emit(OpCodes.Ldarg_1);
            gen.Emit(OpCodes.Ldc_I8, (long)handle.AddrOfPinnedObject());
            gen.Emit(OpCodes.Conv_I);
            gen.EmitCalli(OpCodes.Calli, CallingConvention.StdCall,
                T, new Type[] { T, T });
            gen.Emit(OpCodes.Ret);

            var mulCalli = (BinaryOp)method.CreateDelegate(typeof(BinaryOp));

            var sw = Stopwatch.StartNew();
            for (int i = 0; i &lt; COUNT; i++) { mulDelegate(2, 3); }
            Console.WriteLine("Delegate: {0:N0}", sw.ElapsedMilliseconds);
            sw.Reset();

            sw.Start();
            for (int i = 0; i &lt; COUNT; i++) { mulCalli(2, 3); }
            Console.WriteLine("Calli:    {0:N0}", sw.ElapsedMilliseconds);
        }
        finally { handle.Free(); }
    }

    delegate uint BinaryOp(uint a, uint b);

    [DllImport("kernel32.dll", SetLastError = true)]
    static extern bool VirtualProtect(
        IntPtr address, IntPtr size, uint protect, out uint oldProtect);
}
</code></pre>

<p>I ran the code in x86 mode and x64 mode. The results?</p>

<blockquote>
  <p>32-bit:</p>
  
  <ul>
  <li>Delegate version: 994</li>
  <li>Calli version: 46</li>
  </ul>
  
  <p>64-bit:</p>
  
  <ul>
  <li>Delegate version: 326</li>
  <li>Calli version: 83</li>
  </ul>
</blockquote>

<p>I guess the question's obvious by now... why is there such a huge speed difference?</p>

<hr>

<p><strong>Update:</strong></p>

<p>I created a 64-bit P/Invoke version as well:</p>

<blockquote>
  <ul>
  <li>Delegate version: 284</li>
  <li>Calli version: 77</li>
  <li>P/Invoke version: 31</li>
  </ul>
</blockquote>

<p>Apparently, P/Invoke is faster... is this a problem with my benchmarking, or is there something going on I don't understand? (I'm in release mode, by the way.)</p>
 Creating method dynamically, and executing it <p><strong>Background:</strong></p>

<p>I want to define few <code>static</code> methods in C# , and generate IL code as byte array, from one of these methods, selected at runtime (on client), and send the byte array over network to another machine (server) where it should be executed after re-generating the IL code from the byte array. </p>

<p><strong>My Attempt:</strong> (<a href="http://en.wikipedia.org/wiki/Proof_of_concept">POC</a>)</p>

<pre><code>public static class Experiment
{
    public static int Multiply(int a, int b)
    {
        Console.WriteLine("Arguments ({0}, {1})", a, b);
        return a * b;
    }
}
</code></pre>

<p>And then I get the IL code of the method body, as:</p>

<pre><code>BindingFlags flags = BindingFlags.Public | BindingFlags.Static;
MethodInfo meth = typeof(Experiment).GetMethod("Multiply", flags);
byte[] il = meth.GetMethodBody().GetILAsByteArray();
</code></pre>

<p>So far I didn't create anything dynamically. But I've IL code as byte array, and I want to create an assembly, then a module in it, then a type, then a method - all dynamically. When creating the method body of the dynamically created method, I use the IL code which I got using reflection in the above code.</p>

<p>The code-generation code is as follows:</p>

<pre><code>AppDomain domain = AppDomain.CurrentDomain;
AssemblyName aname = new AssemblyName("MyDLL");
AssemblyBuilder assemBuilder = domain.DefineDynamicAssembly(
                                               aname, 
                                               AssemblyBuilderAccess.Run);

ModuleBuilder modBuilder = assemBuilder.DefineDynamicModule("MainModule");

TypeBuilder tb = modBuilder.DefineType("MyType", 
                            TypeAttributes.Public | TypeAttributes.Class);

MethodBuilder mb = tb.DefineMethod("MyMethod", 
     MethodAttributes.Static | MethodAttributes.Public, 
     CallingConventions.Standard,
     typeof(int),                          // Return type
     new[] { typeof(int), typeof(int) });  // Parameter types

mb.DefineParameter(1, ParameterAttributes.None, "value1");  // Assign name 
mb.DefineParameter(2, ParameterAttributes.None, "value2");  // Assign name 

//using the IL code to generate the method body
mb.CreateMethodBody(il, il.Count()); 

Type realType = tb.CreateType();

var meth = realType.GetMethod("MyMethod");
try
{
    object result = meth.Invoke(null, new object[] { 10, 9878 });
    Console.WriteLine(result);  //should print 98780 (i.e 10 * 9878)
}
catch (Exception e)
{
    Console.WriteLine(e.ToString());
}
</code></pre>

<p>But instead of printing <code>98780</code> on the output window, it throws an exception saying,</p>

<blockquote>
  <p>System.Reflection.TargetInvocationException: Exception has been thrown by the target of an     invocation. ---> System.TypeLoadException: Could not load type 'Invalid_Token.0x0100001E'   from assembly 'MyDLL, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null'.<br>
  &nbsp; &nbsp;&nbsp; at MyType.MyMethod(Int32 value1, Int32 value2)
     [...]</p>
</blockquote>

<p>Please help me figuring out the cause of the error, and how to fix it.</p>
 Call and Callvirt <p>What is the difference between the CIL instructions "Call" and "Callvirt"?</p>
 Reflection.Emit vs CodeDOM <p><strong>What are some pros/cons for using the Reflection.Emit library versus CodeDOM for dynamically generating code at runtime?</strong></p>

<p>I am trying to generate some (relatively complicated) dynamic classes in a system based on metadata available at runtime in XML form. I will be generating classes that extend existing classes in the application assembly, implementing additional interfaces, adding methods, and overriding virtual and abstract members.</p>

<p>I want to make sure I select the appropriate technique before I get too deep into the implementation. Any information about how these different code-generation techniques differ would be helpful. Also, any information on open-source libraries that simplify or streamline working wither either API would be useful as well.</p>
 Real world uses of Reflection.Emit <p>In all the books I've read on reflection they often say that there aren't many cases where you want to generate IL on the fly, but they don't give any examples of where it does make sense.  </p>

<p>After seeing Reflection.Emit as a job requirement for a gaming company I was curious where else it's being used.</p>

<p>I'm now wondering if there are any situations you've seen in the real world were it was the best solution to the problem.  Perhaps it is used as an implementation to a design pattern?</p>

<p><strong>Note</strong>
I imagine <a href="http://www.sharpcrafters.com/">PostSharp</a> / AOP uses it.</p>
 How do I Emit a System.Linq.Expression? <p>I've got some code that generates various <code>Func&lt;&gt;</code> delegates using <code>System.Linq.Expressions</code> and <code>Expression.Lambda&lt;Func&lt;&gt;&gt;.Compile()</code> etc. I would like to be able to serialize the generated functions into an assembly for later use. In the past I've done some stuff with System.Reflection.Emit but now that Linq Expressions I'd rather not go that route again.</p>

<p>Is there a mechanism to serialize a compiled expression or some sort of bridge from the <code>Expressions</code> namespace to the <code>Emit</code> namespace?</p>

<p><strong>Edit</strong></p>

<p>Some background for context:
I am working on a query engine (mostly for my own edification and enjoyment). Given a SQL statement I would like to parse and transform it into a lambda function and then serialize it to disk for later (and repeated execution).</p>

<p>In pseudo code I am to this point:</p>

<pre><code>Func&lt;IEnumerable&lt;T&gt;, IEnumerable&lt;T1&gt;&gt; query = Query.Parse&lt;T, T1&gt;("Select field AS A, field1 AS B from T where T.field2 &gt; 5");
</code></pre>

<p>(where <strong>field</strong>, <strong>field1</strong> and <strong>field2</strong> are properties of <em>Type T</em> and <strong>A</strong> and <strong>B</strong> are properties of <em>Type T1</em>.
and I can pass any enumeration of <code>&lt;T&gt;</code> to <code>query</code> and get back and an enumeration of <code>&lt;T1&gt;</code> which matches the query criteria.</p>

<p>So I would like to serialize <code>query</code> to disk as an already compiled assembly so at a later date I can load it and evaluate different sets of <code>&lt;T&gt;</code> without parsing and compiling it. I am picturing something along the lines of:</p>

<pre><code>AssemblyBuilder builder = new AssemblyBuilder(...);
ModuleBuilder module = builder.DefineDynamicModule(...);
TypeBuilder type = module.DefineType(...);
type.AddMethod(query);  // &lt;--- where this piece does not exist as far as I know
builder.Emit(...)
</code></pre>
 Why am I getting this exception when emitting classes that reference each other via value-type generics? <p>This code snippet is a simplified extract of my class-generation code, which creates two classes that reference each other as arguments in a generic type:</p>

<pre><code>namespace Sandbox
{
    using System;
    using System.Reflection;
    using System.Reflection.Emit;

    internal class Program
    {
        private static void Main(string[] args)
        {
            var assembly = AppDomain.CurrentDomain.DefineDynamicAssembly(new AssemblyName("Test"), AssemblyBuilderAccess.Run);
            var module = assembly.DefineDynamicModule("Test");

            var typeOne = module.DefineType("TypeOne", TypeAttributes.Public);
            var typeTwo = module.DefineType("TypeTwo", TypeAttributes.Public);

            typeOne.DefineField("Two", typeof(TestGeneric&lt;&gt;).MakeGenericType(typeTwo), FieldAttributes.Public);
            typeTwo.DefineField("One", typeof(TestGeneric&lt;&gt;).MakeGenericType(typeOne), FieldAttributes.Public);

            typeOne.CreateType();
            typeTwo.CreateType();

            Console.WriteLine("Done");
            Console.ReadLine();
        }
    }

    public struct TestGeneric&lt;T&gt;
    {
    }
}
</code></pre>

<p>Which should produce MSIL equivalent to the following:</p>

<pre><code>public class TypeOne
{
    public Program.TestGeneric&lt;TypeTwo&gt; Two;
}

public class TypeTwo
{
    public Program.TestGeneric&lt;TypeOne&gt; One;
}
</code></pre>

<p>But instead throws this exception on the line <code>typeOne.CreateType()</code>:</p>

<pre><code>System.TypeLoadException was unhandled
  Message=Could not load type 'TypeTwo' from assembly 'Test, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null'.
  Source=mscorlib
  TypeName=TypeTwo
  StackTrace:
       at System.Reflection.Emit.TypeBuilder.TermCreateClass(RuntimeModule module, Int32 tk, ObjectHandleOnStack type)
       at System.Reflection.Emit.TypeBuilder.CreateTypeNoLock()
       at System.Reflection.Emit.TypeBuilder.CreateType()
       at Sandbox.Program.Main(String[] args) in C:\Users\aca1\Code\Sandbox\Program.cs:line 20
</code></pre>

<p>Interesting things to note:</p>

<ul>
<li>The circular reference isn't required to cause the exception; if I don't define field <code>One</code> on <code>TypeTwo</code>, creating <code>TypeOne</code> before <code>TypeTwo</code> still fails, but creating <code>TypeTwo</code> before <code>TypeOne</code> succeeds. Therefore, the exception is specifically caused by using a type that has not yet been created as an argument in a generic field type; however, because I need to use a circular reference, I cannot avoid this situation by creating the types in a specific order.</li>
<li>Yes, I <em>do</em> need to use a circular reference.</li>
<li>Removing the wrapper <code>TestGeneric&lt;&gt;</code> type and declaring the fields as <code>TypeOne</code> &amp; <code>TypeTwo</code> directly does not produce this error; thus I <em>can</em> use dynamic types that have been defined but not created.</li>
<li>Changing <code>TestGeneric&lt;&gt;</code> from a <code>struct</code> to a <code>class</code> does not produce this error; so this pattern <em>does</em> work with most generics, just not generic value types.</li>
<li>I can't change the declaration of <code>TestGeneric&lt;&gt;</code> in my case as it is declared in another assembly - specifically, <code>System.Data.Linq.EntityRef&lt;&gt;</code> declared in System.Data.Linq.dll.</li>
<li>My circular reference is caused by representing two tables with foreign key references to each other; hence the need for that specific generic type and this specific pattern.</li>
<li>Changing the circular reference to a self-reference <strong>edit</strong> succeeds. This failed originally because I had <code>TestGeneric&lt;&gt;</code> as a nested type in Program, so it inherited the <code>internal</code> visibility. I've fixed this now in the code sample above, and it does in fact work.</li>
<li>Compiling the generated code manually (as C# code) also works, so it's not an obscure compiler issue.</li>
</ul>

<p>Any ideas on a) why this occuring, b) how I can fix this and/or c) how I can work around it?</p>

<p>Thanks.</p>
 ILGenerator catching exceptions doesn't work <p>I'm generating wrappers for types by using <code>System.Reflection.Emit</code>. At one point it's possible that the original object is throwing a error on access ( <code>FaultException</code> ) and the error should be catched by my <code>try { } catch (Exception e) { }</code> which i have implemented, but it does not.</p>

<p>The code is shown correcly by <a href="http://wiki.sharpdevelop.net/ILSpy.ashx">ILSpy</a>.</p>

<pre><code>try
{
    if (original.Station != null)
    {
        if (objectDictionary.ContainsKey(original.Station))
        {
            this.Station = (objectDictionary[original.Station] as StationWrapper);
        }
        else
        {
            this.Station = new StationWrapper(original.Station, objectDictionary);
        }
    }
}
catch (Exception arg_6D_0)
{
    ReportManager.Log(arg_6D_0);
}
</code></pre>

<h3>Code generation</h3>

<p>This is the code for the assembly-generation.</p>

<pre><code>Label ex = il.BeginExceptionBlock();
....
// Exception block end
il.Emit(OpCodes.Leave, ex);
il.BeginCatchBlock(typeof(Exception));
il.Emit(OpCodes.Call, ReportManager_Log);
il.EndExceptionBlock();
</code></pre>

<h3>Edit</h3>

<p>The exception is getting caught by user code but not by IL-Code.</p>

<h3>Disassembly</h3>

<p>Removed some namespaces of the customer here. The write line has been added the last minutes.</p>

<pre><code>.try
{
    IL_0019: ldarg.1
    IL_001a: call instance class [...]...Station [...]...StationBase::get_Station()
    IL_001f: brfalse IL_0063

    IL_0024: ldarg.2
    IL_0025: ldarg.1
    IL_0026: call instance class [...]...Station [...]...StationBase::get_Station()
    IL_002b: call instance bool class [mscorlib]System.Collections.Generic.Dictionary`2&lt;object, object&gt;::ContainsKey(!0)
    IL_0030: brfalse IL_0051

    IL_0035: ldarg.0
    IL_0036: ldarg.2
    IL_0037: ldarg.1
    IL_0038: call instance class [...]...Station [...]...StationBase::get_Station()
    IL_003d: call instance !1 class [mscorlib]System.Collections.Generic.Dictionary`2&lt;object, object&gt;::get_Item(!0)
    IL_0042: isinst ...StationWrapper
    IL_0047: call instance void ...StationBaseWrapper::set_Station(class ...StationWrapper)
    IL_004c: br IL_0063

    IL_0051: ldarg.0
    IL_0052: ldarg.1
    IL_0053: call instance class [...]...Station [...]...StationBase::get_Station()
    IL_0058: ldarg.2
    IL_0059: newobj instance void ....StationWrapper::.ctor(class [...]...Station, class [mscorlib]System.Collections.Generic.Dictionary`2&lt;object, object&gt;)
    IL_005e: call instance void ...StationBaseWrapper::set_Station(class ...StationWrapper)

    IL_0063: leave IL_007c
} // end .try
catch [mscorlib]System.Exception
{
    IL_0068: ldstr "Its comming home"
    IL_006d: call void [mscorlib]System.Console::WriteLine(string)
    IL_0072: call void [...Report]...ReportManager::Log(class [mscorlib]System.Exception)
    IL_0077: leave IL_007c
} // end handler
</code></pre>

<h3>Edit 2</h3>

<p>When throwing a <code>System.Exception</code> in IL code, before the <code>FaultException'1</code> can occur, the exception is getting handled. Tested with <code>Exception</code> and <code>ArgumentException</code>.</p>
 C# reflection: If ... else? <p>I'm currently facing new problem with operators. I have this code:</p>

<pre><code>var method = new DynamicMethod("dummy", null, Type.EmptyTypes);
var g = method.GetILGenerator();

g.Emit(OpCodes.Ldstr, "string");
g.Emit(OpCodes.Ldstr, "string");
g.Emit(OpCodes.Call, typeof(String).GetMethod("op_Equality", new Type[]{typeof(string), typeof(string)}));
g.Emit(OpCodes.Ldc_I4, 0);
g.Emit(OpCodes.Ceq);
g.Emit(OpCodes.Brtrue_S, );

var action = (Action)method.CreateDelegate(typeof(Action));
action();

Console.Read();
</code></pre>

<p>I have now two questions: </p>

<ol>
<li>How can I get the address of an instruction to pass it as a parameter in Reflection?</li>
<li>Is there any difference between BR and BR_S, Brtrue and Brtrue_S, Brfalse and Brfalse_S and similar instructions?</li>
</ol>

<p>Thanks.</p>
 Modifying Existing .NET Assemblies <p>Is there a way to modify existing .NET assemblies without resorting to 3rd party tools? I know that <a href="http://www.postsharp.org/" rel="nofollow">PostSharp</a> makes this possible but I find it incredibly wasteful that the developler of PostSharp basically had to rewrite the functionality of the whole <code>System.Reflection</code> namespace in order to make existing assemblies modifiable.</p>

<p><code>System.Reflection.Emit</code> only allows the creation of new, dynamic assemblies. However, all the builder classes used here inherit from the basic reflection classes (e.g. <code>TypeBuilder</code> inherits from <code>System.Type</code>). Unfortunately, there doesn't seem to be a way to coerce an existing, dynamically loaded type into a type builder. At least, there's no official, supported way.</p>

<p>So what about unsupported? Does anyone know of backdoors that allow to load existing assemblies or types into such builder classes?</p>

<p>Mind, I am <strong>not</strong> searching for ways to modify the current assembly (this <em>may</em> even be an unreasonable request) but just to modify existing assemblies loaded from disc. I fear there's no such thing but I'd like to ask anyway.</p>

<p>In the worst case, one would have to resort to <code>ildasm.exe</code> to disassemble the code and then to <code>ilasm.exe</code> for reassembly but there's no toolchain (read: IL reader) contained in .NET to work with IL data (or is there?).</p>

<p>/EDIT:</p>

<p>I've got no specific use case. I'm just interested in a general-purpose solution because patching existing assemblies is a quite common task. Take obfuscators for example, or profilers, or AOP libraries (yes, the latter <em>can</em> be implemented differently). As I've said, it seems incredibly wasteful to be forced to rewrite large parts of the already existing infrastructure in <code>System.Reflection</code>.</p>

<hr>

<h2>@Wedge:</h2>

<p>You're right. However, there's no specific use case here. I've modified the original question to reflect this. My interest was sparked by another question where the asker wanted to know how he could inject the instructions <code>pop</code> and <code>ret</code> at the end of every method in order to keep Lutz Roeder's Reflector from reengineering the (VB or C#) source code.</p>

<p>Now, this scenario can be realized with a number of tools, e.g. PostSharp mentioned above and the <a href="http://sebastien.lebreton.free.fr/reflexil/" rel="nofollow">Reflexil</a> plugin for Reflector, that, in turn, uses the <a href="http://www.mono-project.com/Cecil" rel="nofollow">Cecil</a> library.</p>

<p>All in all, I'm just not satisfied with the .NET framework.</p>

<h2>@Joel:</h2>

<p>Yes, I'm aware of this limitation. Thanks anyway for pointing it out, since it's important.</p>

<h2>@marxidad:</h2>

<p>This seems like the only feasible approach. However, this would mean that you'd still have to recreate the complete assembly using the builder classes, right? I.e. you'd have to walk over the whole assembly manually.</p>

<p>Hmm, I'll look into that.</p>
 Reflection.Emit - access topmost-but-one item from stack <p>Is there a way in .NET, using <code>Reflection.Emit</code>, to access the topmost-but-one item from the stack? So if A is topmost, and B next - I want to process B then A. It would be fine to duplicate B <em>above</em> A (since I can simply "pop" the second B when I get to it).</p>

<p>Currently, I am declaring a local:</p>

<pre><code>    LocalBuilder loc = il.DeclareLocal(typeof(Foo));
    il.Emit(OpCodes.Stloc, loc); // store and pop topmost stack item
    // work with (pop) previous stack item 
    il.Emit(OpCodes.Ldloc, loc); // push old topmost stack item
</code></pre>

<p>Is there a route that doesn't need the explicit local?</p>
 How to emit explicit interface implementation using reflection.emit? <p>Observe the following simple source code:</p>

<pre><code>using System;
using System.Linq.Expressions;
using System.Reflection;
using System.Reflection.Emit;

namespace A
{
  public static class Program
  {
    private const MethodAttributes ExplicitImplementation =
      MethodAttributes.Private | MethodAttributes.Virtual | MethodAttributes.Final |
      MethodAttributes.HideBySig | MethodAttributes.NewSlot;
    private const MethodAttributes ImplicitImplementation =
      MethodAttributes.Public | MethodAttributes.Virtual | MethodAttributes.HideBySig;

    private static Type EmitMyIntfType(ModuleBuilder moduleBuilder)
    {
      var typeBuilder = moduleBuilder.DefineType("IMyInterface",
        TypeAttributes.NotPublic | TypeAttributes.Interface | TypeAttributes.Abstract);
      typeBuilder.DefineMethod("MyMethod", MethodAttributes.Assembly | MethodAttributes.Abstract |
        MethodAttributes.Virtual | MethodAttributes.HideBySig | MethodAttributes.NewSlot,
        typeof(void), new[] { typeof(int) });

      return typeBuilder.CreateType();
    }

    public static void Main()
    {
      var assemblyName = new AssemblyName("DynamicTypesAssembly");
      var assemblyBuilder = AppDomain.CurrentDomain.DefineDynamicAssembly(assemblyName, AssemblyBuilderAccess.RunAndSave);
      var moduleBuilder = assemblyBuilder.DefineDynamicModule(assemblyName.Name, assemblyName.Name + ".dll", true);
      var myIntfType = EmitMyIntfType(moduleBuilder);

      var typeBuilder = moduleBuilder.DefineType("MyType",
        TypeAttributes.Public | TypeAttributes.BeforeFieldInit | TypeAttributes.Serializable |
        TypeAttributes.Sealed, typeof(object), new[] { myIntfType });

      //var myMethodImpl = typeBuilder.DefineMethod("IMyInterface.MyMethod", ExplicitImplementation,
      //  null, new[] { typeof(int) });
      var myMethodImpl = typeBuilder.DefineMethod("MyMethod", ImplicitImplementation,
        null, new[] { typeof(int) });
      var ilGenerator = myMethodImpl.GetILGenerator();
      ilGenerator.Emit(OpCodes.Ret);

      var type = typeBuilder.CreateType();
      assemblyBuilder.Save("A.dll");
    }
  }
}
</code></pre>

<p>Below is the equivalent C# code obtained by decompiling the A.dll assembly using the Reflector:</p>

<pre><code>internal interface IMyInterface
{
    void MyMethod(int);
}
[Serializable]
public sealed class MyType : IMyInterface
{
    public override void MyMethod(int)
    {
    }
}
</code></pre>

<p>Now what if I wish the <code>MyType</code> type implement the <code>IMyInterface</code> interface explicitly?
So I take these lines:</p>

<pre><code>//var myMethodImpl = typeBuilder.DefineMethod("IMyInterface.MyMethod", ExplicitImplementation,
//  null, new[] { typeof(int) });
var myMethodImpl = typeBuilder.DefineMethod("MyMethod", ImplicitImplementation,
  null, new[] { typeof(int) });
</code></pre>

<p>and switch the comments to yield this code:</p>

<pre><code>var myMethodImpl = typeBuilder.DefineMethod("IMyInterface.MyMethod", ExplicitImplementation,
  null, new[] { typeof(int) });
// var myMethodImpl = typeBuilder.DefineMethod("MyMethod", ImplicitImplementation,
//  null, new[] { typeof(int) });
</code></pre>

<p>But now, the application fails to create the dynamic type. This line:</p>

<pre><code>var type = typeBuilder.CreateType();
</code></pre>

<p>throws the following exception:</p>

<pre><code>System.TypeLoadException was unhandled
  Message="Method 'MyMethod' in type 'MyType' from assembly 'DynamicTypesAssembly, Version=0.0.0.0, Culture=neutral, PublicKeyToken=null' does not have an implementation."
  Source="mscorlib"
  TypeName="MyType"
  StackTrace:
       at System.Reflection.Emit.TypeBuilder._TermCreateClass(Int32 handle, Module module)
       at System.Reflection.Emit.TypeBuilder.TermCreateClass(Int32 handle, Module module)
       at System.Reflection.Emit.TypeBuilder.CreateTypeNoLock()
       at System.Reflection.Emit.TypeBuilder.CreateType()
       at A.Program.Main() in C:\Home\work\A\Program.cs:line 45
  InnerException:
</code></pre>

<p>Can anyone show me what is wrong with my code?</p>

<p>Thanks.</p>
 Using Reflection.Emit to emit a "using (x) { ... }" block? <p>I'm trying to use Reflection.Emit in C# to emit a <code>using (x) { ... }</code> block.</p>

<p>At the point I am in code, I need to take the current top of the stack, which is an object that implements IDisposable, store this away in a local variable, implement a using block on that variable, and then inside it add some more code (I can deal with that last part.)</p>

<p>Here's a sample C# piece of code I tried to compile and look at in Reflector:</p>

<pre><code>public void Test()
{
    TestDisposable disposable = new TestDisposable();
    using (disposable)
    {
        throw new Exception("Test");
    }
}
</code></pre>

<p>This looks like this in Reflector:</p>

<pre><code>.method public hidebysig instance void Test() cil managed
{
    .maxstack 2
    .locals init (
        [0] class LVK.Reflection.Tests.UsingConstructTests/TestDisposable disposable,
        [1] class LVK.Reflection.Tests.UsingConstructTests/TestDisposable CS$3$0000,
        [2] bool CS$4$0001)
    L_0000: nop 
    L_0001: newobj instance void LVK.Reflection.Tests.UsingConstructTests/TestDisposable::.ctor()
    L_0006: stloc.0 
    L_0007: ldloc.0 
    L_0008: stloc.1 
    L_0009: nop 
    L_000a: ldstr "Test"
    L_000f: newobj instance void [mscorlib]System.Exception::.ctor(string)
    L_0014: throw 
    L_0015: ldloc.1 
    L_0016: ldnull 
    L_0017: ceq 
    L_0019: stloc.2 
    L_001a: ldloc.2 
    L_001b: brtrue.s L_0024
    L_001d: ldloc.1 
    L_001e: callvirt instance void [mscorlib]System.IDisposable::Dispose()
    L_0023: nop 
    L_0024: endfinally 
    .try L_0009 to L_0015 finally handler L_0015 to L_0025
}
</code></pre>

<p>I have no idea how to deal with that ".try ..." part at the end there when using Reflection.Emit.</p>

<p>Can someone point me in the right direction?</p>

<hr>

<p><strong>Edit</strong>: After asked about the code by email, I'll post my fluent interface code here, but it isn't going to be much use to anyone unless you grab some of my class libraries, and that's a bit of code as well. The code I was struggling with was part of my IoC project, and I needed to generate a class to implement automatic logging of method calls on a service, basically a decorator class for services that auto-generates the code.</p>

<p>The main loop of the method, that implements all the interface methods, is this:</p>

<pre><code>foreach (var method in interfaceType.GetMethods())
{
    ParameterInfo[] methodParameters = method.GetParameters();
    var parameters = string.Join(", ", methodParameters
        .Select((p, index) =&gt; p.Name + "={" + index + "}"));
    var signature = method.Name + "(" + parameters + ")";
    type.ImplementInterfaceMethod(method).GetILGenerator()
        // object[] temp = new object[param-count]
        .variable&lt;object[]&gt;() // #0
        .ldc(methodParameters.Length)
        .newarr(typeof(object))
        .stloc_0()
        // copy all parameter values into array
        .EmitFor(Enumerable.Range(0, methodParameters.Length), (il, i) =&gt; il
            .ldloc_0()
            .ldc(i)
            .ldarg_opt(i + 1)
            .EmitIf(methodParameters[i].ParameterType.IsValueType, a =&gt; a
                .box(methodParameters[i].ParameterType))
            .stelem(typeof(object))
        )
        // var x = _Logger.Scope(LogLevel.Debug, signature, parameterArray)
        .ld_this()
        .ldfld(loggerField)
        .ldc(LogLevel.Debug)
        .ldstr(signature)
        .ldloc(0)
        .call_smart(typeof(ILogger).GetMethod("Scope", new[] { typeof(LogLevel), typeof(string), typeof(object[]) }))
        // using (x) { ... }
        .EmitUsing(u =&gt; u
            .ld_this()
            .ldfld(instanceField)
            .ldargs(Enumerable.Range(1, methodParameters.Length).ToArray())
            .call_smart(method)
            .EmitCatch&lt;Exception&gt;((il, ex) =&gt; il
                .ld_this()
                .ldfld(loggerField)
                .ldc(LogLevel.Debug)
                .ldloc(ex)
                .call_smart(typeof(ILogger).GetMethod("LogException", new[] { typeof(LogLevel), typeof(Exception) }))
            )
        )
        .ret();
}
</code></pre>

<p>EmitUsing spits out the BeginExceptionBlock that Jon answered with, so that's what I needed to know.</p>

<p>The above code is from <a href="http://hg.vkarlsen.no/hgweb.cgi/LVK-for-NET/file/40156cf88829/LVK.IoC/Resolvers/Decorators/LoggingDecorator.cs">LoggingDecorator.cs</a>, the IL extensions are mostly in <a href="http://hg.vkarlsen.no/hgweb.cgi/LVK-for-NET/file/40156cf88829/LVK.Reflection/ILExtensions.Designer.cs">ILGeneratorExtensions.Designer.cs</a>, and other files in the <a href="http://hg.vkarlsen.no/hgweb.cgi/LVK-for-NET/file/40156cf88829/LVK.Reflection">LVK.Reflection</a> namespace.</p>
 How do I add attributes to a method at runtime? <p>We're using Microsoft.Practices.CompositeUI.EventBroker to handle event subscription and publication in our application.  The way that works is that you add an attribute to your event, specifying a topic name, like this:</p>

<pre><code>[EventPublication("example", PublicationScope.Global)]
public event EventHandler Example;
</code></pre>

<p>then you add another attribute to your handler, with the same topic name, like this:</p>

<pre><code>[EventSubscription("example", ThreadOption.Publisher)]
public void OnExample(object sender, EventArgs e)
{
    ...
}
</code></pre>

<p>Then you pass your objects to an EventInspector which matches everything up.</p>

<p>We need to debug this, so we're trying to create a debug class that subscribes to <em>all</em> the events.  I can get a list of all the topic names... but only at runtime.  So I need to be able to add attributes to a method at runtime, before we pass our debug object to the EventInspector.</p>

<p>How do I add attributes to a method at runtime?</p>
 Alternatives to Reflection.Emit for the Compact Framework <p>It seems that .NET CF is missing the very useful Reflection.Emit.
So far, I found this library as an alternative: <a href="http://www.codeplex.com/EmitCF" rel="nofollow">http://www.codeplex.com/EmitCF</a>. </p>

<p>However it seems to be an abandoned early version, so I'm looking for more options.</p>

<p>Does anyone know of another alternative to Emit? 
Or perhaps someone used EmitCF and can comment on its status?</p>

<p>BTW, the bigger picture: I'm trying to get Emit for the CF, so that I can get <a href="http://dynamic.codeplex.com" rel="nofollow">http://dynamic.codeplex.com</a> to work under the CF, so I can optimize the serialization code I'm using (<a href="http://www.codeproject.com/KB/XML/GR%5FCustomXmlSerializer.aspx" rel="nofollow">http://www.codeproject.com/KB/XML/GR%5FCustomXmlSerializer.aspx</a>)</p>
 How do I emit code and inject it into a loaded assembly? <p>I've built some Types dynamically using System.CodeDom.CodeCompileUnit, want to compile those into IL code in memory, and inject that IL code into an assembly loaded in memory - there is no need to save any of this to disk. Maybe my stated plan is wrong. Open to other suggestions about how to get that CodeCompileUnit instance to the said destination.</p>
 Reflection.Emit better than GetValue & SetValue :S <p>I've been told to use  Reflection.Emit instead of PropertyInfo.GetValue / SetValue because it is faster this way.
But I don't really know what stuff from Reflection.Emit and how to use it to substitute GetValue and SetValue. Can anybody help me with this ?</p>
 Why does `OpCode.Value` have the "wrong" endianness? <p><strong>Facts:</strong></p>

<ol>
<li><p>The correct encoding for the CIL instruction <a href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.opcodes.rethrow.aspx" rel="nofollow" title="MSDN reference page for System.Reflection.Emit.OpCodes.Rethrow"><code>rethrow</code></a>'s op-code is the two-byte sequence <code>FE 1A</code>.</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.opcode.value.aspx" rel="nofollow" title="MSDN reference page for System.Reflection.Emit.OpCode.Value"><code>OpCodes.Rethrow.Value</code></a> (which has type <code>short</code>) has value <code>0xFE1A</code> on my little-endian machine.</p></li>
<li><p><a href="http://msdn.microsoft.com/en-us/library/system.bitconverter.aspx" rel="nofollow" title="MSDN reference page for System.BitConverter"><code>BitConverter</code></a> honours the machine's endianness when converting to/from byte sequences.</p></li>
<li><p>On my little-endian machine, <code>BitConverter.GetBytes(OpCodes.Rethrow.Value)</code> results in the byte sequence <code>1A FE</code>.</p></li>
</ol>

<p>That means, serializing an <code>OpCode.Value</code> on a little-endian machine using <code>BitConverter</code> does not produce the correct encoding for the op-code; the byte order is reversed.</p>

<p><strong>Questions:</strong></p>

<ul>
<li><p>Is the byte ordering of <a href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.opcode.value.aspx" rel="nofollow" title="MSDN reference page for System.Reflection.Emit.OpCode.Value"><code>OpCode.Value</code></a> documented (and if so, where?), or is it an "implementation detail"?</p></li>
<li><p>Does step 4 above on a big-endian machine also result in the wrong byte ordering? That is, would <code>OpCodes.Rethrow.Value</code> be <code>0x1AFE</code> on a big-endian machine?</p></li>
</ul>
 ILGenerator.DeclareLocal() takes a type of a class not yet compiled <p>Toying with making a compiler for my own language, I'm trying to generate some MSIL code using the Reflection.Emit framework. It works fine when using <code>int</code> when I declare local variables. However, when I want to declare a local variable of a type I have not yet compiled I get into trouble since the <code>DeclareLocal()</code> takes a <code>Type</code> as argument. That is my uncompiled class, say <code>A</code>, still needs to be defined using </p>

<pre><code> assemblyBuilder = Thread.GetDomain().DefineDynamicAssembly(assemName, AssemblyBuilderAccess.RunAndSave);
 module = assemblyBuilder.DefineDynamicModule(Filename); 
 module.DefineType(name, TypeAttributes.Public | TypeAttributes.Class)
</code></pre>

<p>So how will I ever be able to compile the following program</p>

<pre><code>class A {
    void M() { B b = new B(); }
}
class B
    void M() { A a = new A(); }
}
</code></pre>
 Getting types in mscorlib 2.0.5.0 (aka Silverlight mscorlib) via reflection on? <p>I am trying to add Silverlight support to my favorite programming langauge Nemerle. </p>

<p>Nemerle , on compilation procedure, loads all types via reflection mainly in 2 steps</p>

<p>1-) Uses Assembly.LoadFrom to load assembly
2-) Usese  Assembly.GetTypes() to get the types</p>

<p>Then at the end of compilation it emits the resolved types with Reflection.Emit.</p>

<p>This procedure works for all assemblies including Silverlight ones except mscorlib of silverlight.</p>

<p>In c# this fails:</p>

<pre><code> var a = System.Reflection.Assembly.LoadFrom(@"c:\mscorlib.dll");
</code></pre>

<p>but this passes :</p>

<pre><code>var a = System.Reflection.Assembly.ReflectionOnlyLoadFrom(@"c:\mscorlib.dll");
</code></pre>

<p>Bu in the latter , a.GetTypes() throws an exception sayin System.Object's parent does not exist.</p>

<p>Is there a way out ?</p>
 Creating a class for an interface at runtime, in C# <p>I'm looking at taking a set of objects, let's say there's 3 objects alive at the moment, which all implement a common interface, and then wrap those objects inside a fourth object, also implementing the same interface.</p>

<p>The fourth object's implementations of methods and properties would simply call the relevant bits on those 3 underlying objects. I know that there will be cases here where it won't make sense to do that, but this is for a service multicast architecture so there's already a good set of limitations in place.</p>

<p>My question is where to start. The generation of that fourth object should be done in memory, at runtime, so I'm thinking <code>Reflection.Emit</code>, unfortunately I don't have enough experience with that to even know where to begin.</p>

<p>Do I have to construct an in-memory assembly? It sure looks that way, but I'd just like a quick pointer to where I should start.</p>

<p>Basically I'm looking at taking an interface, and a list of object instances all implementing that interface, and constructing a new object, also implementing that interface, which should "multicast" all method calls and property access to all the underlying objects, at least as much as possible. There will be heaps of problems with exceptions and such but I'll tackle those bits when I get to them.</p>

<p>This is for a service-oriented architecture, where I would like to have existing code that takes, as an example, a logger-service, to now access multiple logger services, without having to change the code that uses the services. Instead, I'd like to runtime-generate a logger-service-wrapper that internally simply calls the relevant methods on multiple underlying objects.</p>

<p>This is for .NET 3.5 and C#.</p>
 Is it possible to invoke internal method from a dynamic method in .NET? <p>I am trying to invoke an internal method from a dynamically generated one. The il code is simple: ldarg_0, callvirt, ret.</p>

<p>Executing the method fails with TypeLoadException saying it cannot load the type on which the internal method is defined.</p>

<p>When I think of it, this seems logical, because the dynamic method host assembly is not a friend of the method's declaring type assembly.</p>

<p>However, I have expected the dynamic method still to work, just like Delegate.CreateDelegate works. After all, I did manage to get the MethodInfo of the internal method, so the permissions barrier are behind me.</p>

<p>Anyway, the question is "is it possible to invoke an internal method from a dynamically generated one?"</p>

<p>Thanks.</p>

<p><strong>EDIT:</strong></p>

<p>Here is a simple code sample demonstrating the problem:</p>

<pre><code>using System;
using System.Linq.Expressions;
using System.Reflection;
using System.Reflection.Emit;

namespace A
{
  internal class Data
  {
    internal string String { get; set; }
  }

  public static class Program
  {
    public static void Main()
    {
      Expression&lt;Func&lt;Data, string&gt;&gt; expr = x =&gt; x.String;
      var getterInfo = ((PropertyInfo)((MemberExpression)expr.Body).Member).GetGetMethod(true);
      var getter1 = (Func&lt;Data, string&gt;)Delegate.CreateDelegate(typeof(Func&lt;Data, string&gt;), getterInfo);
      var dm = new DynamicMethod(string.Empty, typeof(object), new Type[] { typeof(object) });
      var gen = dm.GetILGenerator();
      gen.Emit(OpCodes.Ldarg_0);
      gen.Emit(OpCodes.Castclass, typeof(Data));
      gen.Emit(OpCodes.Callvirt, getterInfo);
      gen.Emit(OpCodes.Ret);
      var getter2 = (Func&lt;object, object&gt;)dm.CreateDelegate(typeof(Func&lt;object, object&gt;));

      var data = new Data() { String = "Hello" };
      var str1 = getter1(data);
      var str2 = getter2(data);
    }
  }
}
</code></pre>

<p>In the code I create two open instance delegates to access the Data.String instance property:</p>

<ul>
<li>type safe getter1 using Delegate.CreateDelegate</li>
<li>type unsafe getter2 using DynamicMethod</li>
</ul>

<p>The type safe delegate created by Delegate.CreateDelegate works, while the one using DynamicMethod fails with the TypeLoadException.</p>

<p>Note, that I do not wish to take the type safe approach, since the context where the getter is created is not generic. Of course, I can solve this issue, but the question is now that of principal - why DynamicMethod fails where Delegate.CreateDelegate succeeds?</p>
 Is there kind of runtime C++ assembler library around? <p>For my small hobby project I need to emit machine code from C++ program in runtime. I have base address 0xDEADBEEF and want to write something like this:</p>

<pre><code>Assembler a((void*)0xDEADBEEF);
a.Emit() &lt;&lt; 
  Push(Reg::Eax) &lt;&lt;
  Push(Reg::Ebx) &lt;&lt;
  Jmp(0xFEFEFEFE);
</code></pre>

<p>Inline assembler isn't my choice because generated machine code is dependent of the program state. </p>

<p>Does anybody know any existing library for doing this? If no, would it be a good idea to develop one from scratch and make it open source? (I mean, will anybody ever use this library if it existed?)</p>
 Replacing instructions in a method's MethodBody <p>(First of all, this is a very lengthy post, but don't worry: I've already implemented all of it, I'm just asking your opinion, or possible alternatives.)</p>

<p>I'm having trouble implementing the following; I'd appreciate some help:</p>

<ol>
<li>I get a <code>Type</code> as parameter.</li>
<li>I define a subclass using reflection. Notice that I don't intend to modify the original type, but create a new one.</li>
<li><p>I create a property per field of the original class, like so:</p>

<pre><code>public class OriginalClass {
    private int x;
}


public class Subclass : OriginalClass {
    private int x;


<pre><code>public int X {
    get { return x; }
    set { x = value; }
}
</code></pre>

}
</code></pre></li>
<li><p>For every method of the superclass, I create an analogous method in the subclass. The method's body must be the same except that I replace the instructions <code>ldfld x</code> with <code>callvirt this.get_X</code>, that is, instead of reading from the field directly I call the get accessor.</p></li>
</ol>

<p>I'm having trouble with step 4. I know you're not supposed to manipulate code like this, but I really need to.</p>

<p>Here's what I've tried:</p>

<p><strong>Attempt #1:</strong> Use Mono.Cecil. This would allow me to parse the body of the method into human-readable <code>Instructions</code>, and easily replace instructions. However, the original type isn't in a .dll file, so I can't find a way to load it with Mono.Cecil. Writing the type to a .dll, then load it, then modify it and write the new type to disk (which I think is the way you create a type with Mono.Cecil), and then load it seems like a <em>huge</em> overhead.</p>

<p><strong>Attempt #2:</strong> Use Mono.Reflection. This would also allow me to parse the body into <code>Instructions</code>, but then I have no support for replacing instructions. I've implemented a very ugly and inefficient solution using Mono.Reflection, but it doesn't yet support methods that contain try-catch statements (although I guess I can implement this) and I'm concerned that there may be other scenarios in which it won't work, since I'm using the <code>ILGenerator</code> in a somewhat unusual way. Also, it's very ugly ;). Here's what I've done:</p>

<pre><code>private void TransformMethod(MethodInfo methodInfo) {

    // Create a method with the same signature.
    ParameterInfo[] paramList = methodInfo.GetParameters();
    Type[] args = new Type[paramList.Length];
    for (int i = 0; i &lt; args.Length; i++) {
        args[i] = paramList[i].ParameterType;
    }
    MethodBuilder methodBuilder = typeBuilder.DefineMethod(
        methodInfo.Name, methodInfo.Attributes, methodInfo.ReturnType, args);
    ILGenerator ilGen = methodBuilder.GetILGenerator();

    // Declare the same local variables as in the original method.
    IList&lt;LocalVariableInfo&gt; locals = methodInfo.GetMethodBody().LocalVariables;
    foreach (LocalVariableInfo local in locals) {
        ilGen.DeclareLocal(local.LocalType);
    }

    // Get readable instructions.
    IList&lt;Instruction&gt; instructions = methodInfo.GetInstructions();

    // I first need to define labels for every instruction in case I
    // later find a jump to that instruction. Once the instruction has
    // been emitted I cannot label it, so I'll need to do it in advance.
    // Since I'm doing a first pass on the method's body anyway, I could
    // instead just create labels where they are truly needed, but for
    // now I'm using this quick fix.
    Dictionary&lt;int, Label&gt; labels = new Dictionary&lt;int, Label&gt;();
    foreach (Instruction instr in instructions) {
        labels[instr.Offset] = ilGen.DefineLabel();
    }

    foreach (Instruction instr in instructions) {

        // Mark this instruction with a label, in case there's a branch
        // instruction that jumps here.
        ilGen.MarkLabel(labels[instr.Offset]);

        // If this is the instruction that I want to replace (ldfld x)...
        if (instr.OpCode == OpCodes.Ldfld) {
            // ...get the get accessor for the accessed field (get_X())
            // (I have the accessors in a dictionary; this isn't relevant),
            MethodInfo safeReadAccessor = dataMembersSafeAccessors[((FieldInfo) instr.Operand).Name][0];
            // ...instead of emitting the original instruction (ldfld x),
            // emit a call to the get accessor,
            ilGen.Emit(OpCodes.Callvirt, safeReadAccessor);

        // Else (it's any other instruction), reemit the instruction, unaltered.
        } else {
            Reemit(instr, ilGen, labels);
        }

    }

}
</code></pre>

<p>And here comes the horrible, horrible <code>Reemit</code> method:</p>

<pre><code>private void Reemit(Instruction instr, ILGenerator ilGen, Dictionary&lt;int, Label&gt; labels) {

    // If the instruction doesn't have an operand, emit the opcode and return.
    if (instr.Operand == null) {
        ilGen.Emit(instr.OpCode);
        return;
    }

    // Else (it has an operand)...

    // If it's a branch instruction, retrieve the corresponding label (to
    // which we want to jump), emit the instruction and return.
    if (instr.OpCode.FlowControl == FlowControl.Branch) {
        ilGen.Emit(instr.OpCode, labels[Int32.Parse(instr.Operand.ToString())]);
        return;
    }

    // Otherwise, simply emit the instruction. I need to use the right
    // Emit call, so I need to cast the operand to its type.
    Type operandType = instr.Operand.GetType();
    if (typeof(byte).IsAssignableFrom(operandType))
        ilGen.Emit(instr.OpCode, (byte) instr.Operand);
    else if (typeof(double).IsAssignableFrom(operandType))
        ilGen.Emit(instr.OpCode, (double) instr.Operand);
    else if (typeof(float).IsAssignableFrom(operandType))
        ilGen.Emit(instr.OpCode, (float) instr.Operand);
    else if (typeof(int).IsAssignableFrom(operandType))
        ilGen.Emit(instr.OpCode, (int) instr.Operand);
    ... // you get the idea. This is a pretty long method, all like this.
}
</code></pre>

<p>Branch instructions are a special case because <code>instr.Operand</code> is <code>SByte</code>, but <code>Emit</code> expects an operand of type <code>Label</code>. Hence the need for the <code>Dictionary labels</code>.</p>

<p>As you can see, this is pretty horrible. What's more, it doesn't work in all cases, for instance with methods that contain try-catch statements, since I haven't emitted them using methods <code>BeginExceptionBlock</code>, <code>BeginCatchBlock</code>, etc, of <code>ILGenerator</code>. This is getting complicated. I guess I can do it: <code>MethodBody</code> has a list of <code>ExceptionHandlingClause</code> that should contain the necessary information to do this. But I don't like this solution anyway, so I'll save this as a last-resort solution.</p>

<p><strong>Attempt #3:</strong> Go bare-back and just copy the byte array returned by <code>MethodBody.GetILAsByteArray()</code>, since I only want to replace a single instruction for another single instruction of the same size that produces the exact same result: it loads the same type of object on the stack, etc. So there won't be any labels shifting and everything should work exactly the same. I've done this, replacing specific bytes of the array and then calling <code>MethodBuilder.CreateMethodBody(byte[], int)</code>, but I still get the same error with exceptions, and I still need to declare the local variables or I'll get an error... even when I simply copy the method's body and don't change anything.
So this is more efficient but I still have to take care of the exceptions, etc.</p>

<p>Sigh.</p>

<p>Here's the implementation of attempt #3, in case anyone is interested:</p>

<pre><code>private void TransformMethod(MethodInfo methodInfo, Dictionary&lt;string, MethodInfo[]&gt; dataMembersSafeAccessors, ModuleBuilder moduleBuilder) {

    ParameterInfo[] paramList = methodInfo.GetParameters();
    Type[] args = new Type[paramList.Length];
    for (int i = 0; i &lt; args.Length; i++) {
        args[i] = paramList[i].ParameterType;
    }
    MethodBuilder methodBuilder = typeBuilder.DefineMethod(
        methodInfo.Name, methodInfo.Attributes, methodInfo.ReturnType, args);

    ILGenerator ilGen = methodBuilder.GetILGenerator();

    IList&lt;LocalVariableInfo&gt; locals = methodInfo.GetMethodBody().LocalVariables;
    foreach (LocalVariableInfo local in locals) {
        ilGen.DeclareLocal(local.LocalType);
    }

    byte[] rawInstructions = methodInfo.GetMethodBody().GetILAsByteArray();
    IList&lt;Instruction&gt; instructions = methodInfo.GetInstructions();

    int k = 0;
    foreach (Instruction instr in instructions) {

        if (instr.OpCode == OpCodes.Ldfld) {

            MethodInfo safeReadAccessor = dataMembersSafeAccessors[((FieldInfo) instr.Operand).Name][0];

            // Copy the opcode: Callvirt.
            byte[] bytes = toByteArray(OpCodes.Callvirt.Value);
            for (int m = 0; m &lt; OpCodes.Callvirt.Size; m++) {
                rawInstructions[k++] = bytes[put.Length - 1 - m];
            }

            // Copy the operand: the accessor's metadata token.
            bytes = toByteArray(moduleBuilder.GetMethodToken(safeReadAccessor).Token);
            for (int m = instr.Size - OpCodes.Ldfld.Size - 1; m &gt;= 0; m--) {
                rawInstructions[k++] = bytes[m];
            }

        // Skip this instruction (do not replace it).
        } else {
            k += instr.Size;
        }

    }

    methodBuilder.CreateMethodBody(rawInstructions, rawInstructions.Length);

}


private static byte[] toByteArray(int intValue) {
    byte[] intBytes = BitConverter.GetBytes(intValue);
    if (BitConverter.IsLittleEndian)
        Array.Reverse(intBytes);
    return intBytes;
}



private static byte[] toByteArray(short shortValue) {
    byte[] intBytes = BitConverter.GetBytes(shortValue);
    if (BitConverter.IsLittleEndian)
        Array.Reverse(intBytes);
    return intBytes;
}
</code></pre>

<p>(I know it isn't pretty. Sorry. I put it quickly together to see if it would work.)</p>

<p>I don't have much hope, but can anyone suggest anything better than this?</p>

<p>Sorry about the extremely lengthy post, and thanks.</p>

<hr>

<p><strong>UPDATE #1:</strong> Aggh... I've just read this <a href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.opcodes.constrained%28v=VS.100%29.aspx" rel="nofollow">in the msdn documentation</a>:</p>

<blockquote>
  <p>[The CreateMethodBody method] is
  currently not fully supported. The
  user cannot supply the location of
  token fix ups and exception handlers.</p>
</blockquote>

<p>I should really read the documentation before trying anything. Some day I'll learn...</p>

<p>This means option #3 can't support try-catch statements, which makes it useless for me. Do I really have to use the horrible #2? :/  Help! :P</p>

<hr>

<p><strong>UPDATE #2:</strong> I've successfully implemented attempt #2 with support for exceptions. It's quite ugly, but it works. I'll post it here when I refine the code a bit. It's not a priority, so it may be a couple of weeks from now. Just letting you know in case someone is interested in this.</p>

<p>Thanks for your suggestions.</p>
 Actual Performance of Fields vs. Properties <p>I'm doing some post-build CIL weaving that adds CIL to all methods in an assembly (in other words tons of methods). Each method checks if a specific value is null. Example (C# Reflector'd version of CIL code):</p>

<pre><code>// CIL woven region start
if (MyType.Something == null) {
 // ... some new stuff
}
// CIL woven region end
</code></pre>

<p>What is the performance impact of having MyType.Something as a Property vs. a Field? I know I've read that the C# compiler performs special optimizations and there should be no performance impact in that case...but what about in the case of direct CIL code (no C# compiler)...? Or is it the JIT compiler that allows for these optimizations (so direct CIL code still benefits)?</p>

<p>Will emitting OpCode.Call for the static property's accessor have poorer performance than Ldsfld (bear in mind this is across tens of thousands of invocations since every method in the assembly is woven)?</p>

<p>Thanks.</p>
 Reflection.Emit.ILGenerator Exception Handling "Leave" instruction <p>First, some background info:</p>

<p>I am making a compiler for a school project. It is already working, and I'm expending a lot of effort to bug fix and/or optimize it. I've recently run into a problem with is that I discovered that the ILGenerator object generates an extra <code>leave</code> instruction when you call any of the following member methods:</p>

<pre><code>BeginCatchBlock()
BeginExceptFilterBlock()
BeginFaultBlock()
BeginFinallyBlock()
EndExceptionBlock()
</code></pre>

<p>So, you start a try statement with a call to <code>BeginExceptionBlock()</code>, add a couple of catch clauses with <code>BeginCatchBlock()</code>, possibly add a finally clause with <code>BeginFinallyBlock()</code>, and then end the protected code region with <code>EndExceptionBlock()</code>. </p>

<p>The methods I listed automatically generate a <code>leave</code> instruction branching to the first instruction after the try statement. I don't want these, for two reasons. One, because it always generates an unoptimized <code>leave</code> instruction, rather than a <code>leave.s</code> instruction, even when it's branching just two bytes away. And two, because you can't control where the leave instruction goes.</p>

<p>So, if you wanted to branch to some other location in your code, you have to add a compiler-generated local variable, set it depending on where you want to go inside of the try statement, let <code>EndExceptionBlock()</code> auto-generate the <code>leave</code> instruction, and then generate a switch statement below the try block. OR, you could just emit a <code>leave</code> or <code>leave.s</code> instruction yourself, before calling one of the previous methods, resulting in an ugly and unreachable extra 5 bytes, like so:</p>

<pre><code>L_00ca: leave.s L_00e5
L_00cc: leave L_00d1
</code></pre>

<p>Both of these options are unacceptable to me. Is there any way to either prevent the automatic generation of <code>leave</code> instructions, or else any other way to specify protected regions rather than using these methods (which are extremely annoying and practically undocumented)?</p>

<p>EDIT
Note: the C# compiler itself does this, so it's not as if there is a good reason to force it on us. For example, if you have .NET 4.5 beta, disassemble the following code and check their implementation: (exception block added internally)</p>

<pre><code>public static async Task&lt;bool&gt; TestAsync(int ms)
{
    var local = ms / 1000;
    Console.WriteLine("In async call, before await " + local.ToString() + "-second delay.");
    await System.Threading.Tasks.Task.Delay(ms);
    Console.WriteLine("In async call, after await " + local.ToString() + "-second delay.");

    Console.WriteLine();
    Console.WriteLine("Press any key to continue.");
    Console.ReadKey(false);
    return true;
}
</code></pre>
 Dynamically create type and call constructor of base-class <p>I need to create a class dynamically. Most things work fine but i'm stuck in generating the constructor.</p>

<pre><code>AssemblyBuilder _assemblyBuilder =
        AppDomain.CurrentDomain.DefineDynamicAssembly(new AssemblyName("MyBuilder"),                                                        AssemblyBuilderAccess.Run);

ModuleBuilder _moduleBuilder = _assemblyBuilder.DefineDynamicModule("MyModule");

public static object GetInstance&lt;TSource, TEventArgs&gt;(this TSource source, string eventName)
    where TSource : class
{
    var typeName = "MyTypeName";
    var typeBuilder = _moduleBuilder.DefineType(typeName, TypeAttributes.Class | TypeAttributes.Public);

    // create type like class MyClass : GenericType&lt;MyClass, TSource, TEventArgs&gt;
    var baseNotGenericType = typeof(GenericType&lt;,,&gt;);
    var baseType = baseNotGenericType.MakeGenericType(typeBuilder, typeof(TSource), typeof(TEventArgs)); 
    typeBuilder.SetParent(baseType);


    // the base class contains one constructor with string as param
    var baseCtor = baseNotGenericType.GetConstructor(BindingFlags.NonPublic | BindingFlags.Instance, null, new[] { typeof(string) }, null);

    var ctor = typeBuilder.DefineConstructor(MethodAttributes.Public, CallingConventions.Standard | CallingConventions.HasThis, new Type[0]);
    var ilGenerator = ctor.GetILGenerator();

    // i want to call the constructor of the baseclass with eventName as param
    ilGenerator.Emit(OpCodes.Ldarg_0); // push "this"
    ilGenerator.Emit(OpCodes.Ldstr, eventName); // push the param
    ilGenerator.Emit(OpCodes.Call, baseCtor);
    ilGenerator.Emit(OpCodes.Ret);

    var type = typeBuilder.CreateType();

    // return ...
}
</code></pre>

<p>On call of the constructor i'm getting a BadImageFormatException. What am i doing wrong?</p>

<p>As requested:</p>

<p>The BaseClass looks something like this:</p>

<pre><code>public abstract class GenericType&lt;GT, TEventSource, TEventArgs&gt; : BaseClass
    where GT: GenericType&lt;GT, TEventSource, TEventArgs&gt;, new()
    where TEventArgs : EventArgs
    where TEventSource : class
{
    protected GenericType(string eventName)
    {
        _eventName = eventName;
    }
    // ...
}
</code></pre>

<p>What i would like to have as a result in runtime:</p>

<pre><code>public class MyType : BaseClass&lt;MyType, ConcreteSourceType, ConcreteEventArgsType&gt;
{
    protected MyType() : base("SomeName")
    {

    }
}
</code></pre>
 Is it possible to indirectly load a value type on the stack <p>In Microsoft IL, to call a method on a value type you need an indirect reference. Lets say we have an ILGenerator named "il" and that currently we have a Nullable on top of the stack, if we want to check whether it has a value then we could emit the following:</p>

<pre><code>var local = il.DeclareLocal(typeof(Nullable&lt;int&gt;));
il.Emit(OpCodes.Stloc, local);
il.Emit(OpCodes.Ldloca, local);
var method = typeof(Nullable&lt;int&gt;).GetMethod("get_HasValue");
il.EmitCall(OpCodes.Call, method, null);
</code></pre>

<p>However it would be nice to skip saving it as a local variable, and simply call the method on the address of the variable already on the stack, something like:</p>

<pre><code>il.Emit(/* not sure */);
var method = typeof(Nullable&lt;int&gt;).GetMethod("get_HasValue");
il.EmitCall(OpCodes.Call, method, null);
</code></pre>

<p>The ldind family of instructions looks promising (particularly ldind_ref) but I can't find sufficient documentation to know whether this would cause boxing of the value, which I suspect it might.</p>

<p>I've had a look at the C# compiler output, but it uses local variables to achieve this, which makes me believe the first way may be the only way. Anyone have any better ideas?</p>

<p><strong>** Edit: Additional Notes **</strong></p>

<p>Attempting to call the method directly, as in the following program with the lines commented out, doesn't work (the error will be "Operation could destabilise the runtime"). Uncomment the lines and you'll see that it does work as expected, returning "True".</p>

<pre><code>var m = new DynamicMethod("M", typeof(bool), Type.EmptyTypes);
var il = m.GetILGenerator();
var ctor = typeof(Nullable&lt;int&gt;).GetConstructor(new[] { typeof(int) });
il.Emit(OpCodes.Ldc_I4_6);
il.Emit(OpCodes.Newobj, ctor);
//var local = il.DeclareLocal(typeof(Nullable&lt;int&gt;));
//il.Emit(OpCodes.Stloc, local);
//il.Emit(OpCodes.Ldloca, local);
var getValue = typeof(Nullable&lt;int&gt;).GetMethod("get_HasValue");
il.Emit(OpCodes.Call, getValue);
il.Emit(OpCodes.Ret);
Console.WriteLine(m.Invoke(null, null));
</code></pre>

<p>So you can't simply call the method with the value on the stack because it's a value type (though you could if it was a reference type).</p>

<p>What I'd like to achieve (or to know whether it is possible) is to replace the three lines that are shown commented out, but keep the program working, without using a temporary local.</p>
 Feeding an object literal to ILGenerator <pre><code>Food obj = ...;
ILGenerator gen = (...).GetILGenerator();
gen.Emit( ?? obj ?? ); // replace this 
gen.Emit(OpCodes.Call, typeof(Person).GetMethod("Eat"));
</code></pre>

<p>It's apparently not possible to cleanly push obj onto the evaluation stack, but I am open to ugly hacks which might compromise e.g. portability. ModuleBuilder.DefineInitializedData allows one to store a System.Byte[] in the .sdata. Any ideas?</p>

<p>Edit: the generated method is being emitted as part of a new assembly.</p>
 Using Reflection.Emit to create a class implementing an interface <p>I need to generate a class using Reflection.Emit that implements the following interface.</p>

<pre><code>public interface IObject
{
    T Get&lt;T&gt;(string propertyName); 
}
</code></pre>

<p>Does anyone have an example of how I would emit the following as a simple test case?</p>

<pre><code>class GeneratedObject : IObject
{
    public T Get&lt;T&gt;(string propertyName)
    {
        // this is the simplest possible implementation
        return default(T);
    }
}
</code></pre>
 Using a Delegate to call a constructor <p>I found <a href="http://blogs.msdn.com/haibo_luo/archive/2005/11/17/494009.aspx">this</a> but tried to use it and failed.</p>

<p>How can i create an object using reflections and make it fast by putting it in a delegate? </p>

<pre><code>        DynamicMethod dm = new DynamicMethod("MyCtor", t, new Type[] { });            
        var ctor = t.GetConstructor(new Type[] { });
        ILGenerator ilgen = dm.GetILGenerator();
        ilgen.Emit(OpCodes.Ldarg_0);
        ilgen.Emit(OpCodes.Newobj, ctor);
        ilgen.Emit(OpCodes.Ret);
        var d = (Func&lt;T&gt;)dm.CreateDelegate(t);
        dm.Invoke(null, new object[] { });
</code></pre>

<p>Before putting it in a deleage i tried to at least invoke it and when i did above i get the error</p>

<pre><code>An unhandled exception of type 'System.Reflection.TargetInvocationException' occurred in mscorlib.dll
</code></pre>

<p>Additional information: Exception has been thrown by the target of an invocation.</p>

<p>If i call d() instead i get the exception</p>

<pre><code>An unhandled exception of type 'System.ArgumentException' occurred in mscorlib.dll

Additional information: Type must derive from Delegate.
</code></pre>

<p>How do i put a no param constructor into a delegate and call it?</p>
 How can I define multiple types with the same name and different type parameters using Reflection Emit? <p>How can I generate types like these using the System.Reflection.Emit libraries:</p>

<pre><code>public class Test&lt;T&gt; {}
public class Test&lt;T1, T2&gt; {}
</code></pre>

<p>When I call ModuleBuilder.DefineType(string) with the second type declaration, I get an exception because there is already another type in the module with the same name (I've already defined the type parameter on the first type). Any ideas?</p>
 How can in inject a literal expression using Reflection.Emit? <p>I am working on a project to evaluate tokenized user-defined expressions of varying complexity, using C# as the scripting language.</p>

<p>I have a working model using CodeDOM and reflection to generate an evaluator class, create and load the assembly (GenerateInMemory = true), instantiate the class, and Execute the evaluate method.  However, I want to load the assembly in an AppDomain so that I can unload it when execution is complete.  While researching this issue, I was directed to the AppDomain.DefineDynamicAssembly method.  This seems to be exactly what I need, as I can create a collectible assembly.</p>

<p>Here are a couple of examples of the user-defined expressions, and the classes generated by my CodeDOM project:</p>

<p>Simple user-defined expression:</p>

<pre><code>return Abs(@HDL@/@LDL@ * 5.5);
</code></pre>

<p>Generated class:</p>

<pre><code>namespace Lab.ResultProcessing
{

    public sealed class ExpressionEvaluator
    {
        public double Evaluate()
        {
            return System.Math.Abs(449.86881550861/74.934407754305 * 5.5);
        }
    }
}
</code></pre>

<p>More complex user-defined expression:</p>

<pre><code>double GFR;
double MA_GFR;
double MB_GFR;
double FA_GFR;
double FB_GFR;

GFR = (170 *
        Pow(@CREAT@, -0.999) *
        Pow(@YEARS@, -0.176) *
        Pow(@BUN@, -0.170) *
        Pow(@ALBUMIN@, 0.318));

MA_GFR = GFR;
MB_GFR = GFR * 1.180;
FA_GFR = GFR * 0.762;
FB_GFR = GFR * 1.180 * 0.762;

if (("@RACE@" != "B") &amp;&amp; ("@GENDER@" == "M"))
{
    return MA_GFR;
}
else if (("@RACE@" == "B") &amp;&amp; ("@GENDER@" == "M"))
{
    return MB_GFR;
}
else if (("@RACE@" != "B") &amp;&amp; ("@GENDER@" == "F"))
{
    return FA_GFR;
}
else if (("@RACE@" == "B") &amp;&amp; ("@GENDER@" == "F"))
{
    return FB_GFR;
}
else
{
    return GFR;
}
</code></pre>

<p>Generated class:</p>

<pre><code>namespace Lab.ResultProcessing
{

    public sealed class ExpressionEvaluator
    {
        public double Evaluate()
        {
            double GFR;
double MA_GFR;
double MB_GFR;
double FA_GFR;
double FB_GFR;

GFR = (170 *
        System.Math.Pow(0.797258181752292, -0.999) *     
        System.Math.Pow(63.6814545438073, -0.176) *
        System.Math.Pow(5.47258181752292, -0.170) *       
        System.Math.Pow(3.79725818175229, 0.318));    

MA_GFR = GFR;                                   
MB_GFR = GFR * 1.180;                           
FA_GFR = GFR * 0.762;                           
FB_GFR = GFR * 1.180 * 0.762;                   

if (("B" != "B") &amp;&amp; ("M" == "M"))
{
    return MA_GFR;                              
}
else if (("B" == "B") &amp;&amp; ("M" == "M"))
{
    return MB_GFR;                              
}
else if (("B" != "B") &amp;&amp; ("M" == "F"))
{
    return FA_GFR;                              
}
else if (("B" == "B") &amp;&amp; ("M" == "F"))
{
    return FB_GFR;                              
}
else
{
    return GFR;
}
;
        }
    }
}
</code></pre>

<p>I am now attempting to duplicate the functionality described above using Reflection.Emit.  My problem is that I haven't found a way to inject the detokenized formula into the emitted class.</p>

<p>Here is the code I am using:</p>

<pre><code>public static object DynamicEvaluate2(string expression)
{
    AssemblyName assemblyName = new AssemblyName("Lab.ResultProcessing");
    AppDomain appDomain = AppDomain.CurrentDomain;
    AssemblyBuilder assemblyBuilder = appDomain.DefineDynamicAssembly(assemblyName, AssemblyBuilderAccess.RunAndCollect);
    ModuleBuilder moduleBuilder = assemblyBuilder.DefineDynamicModule(assemblyName.Name);
    TypeBuilder typeBuilder = moduleBuilder.DefineType("ExpressionEvaluator", TypeAttributes.Sealed);
    MethodBuilder methodBuilder = typeBuilder.DefineMethod("Evaluate", MethodAttributes.Public | MethodAttributes.Final, typeof(double), null);
    ILGenerator methodGenerator = methodBuilder.GetILGenerator();

    methodGenerator.Emit(OpCodes.Ldobj, expression);
    methodGenerator.Emit(OpCodes.Ret);

    Type evaluatorType = typeBuilder.CreateType();
    MethodInfo methodInfo = evaluatorType.GetMethod("Evaluate");

    object evaluator = Activator.CreateInstance(evaluatorType);
    object result = methodInfo.Invoke(evaluator, null);

    return result;
}
</code></pre>

<p>When the methodInfo.Invoke method is called I get the following error:</p>

<p>Test method ResultCalculatorTest.ResultCalculatorClassFactoryTest.DynamicEvaluate2Test threw exception: 
System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---> System.BadImageFormatException: Bad class token.</p>

<p>So I have a couple of questions:</p>

<p>How can in inject the detokenized user-defined expression using Reflection.Emit?<br>
Is there any way to see C# code for the emitted class, or is it only in IL?<br>
How do I debug the emitted class?</p>

<p>Any help would be greatly appreciated.</p>
 Runtime code injection using DynamicMethod? <p>Consider the following trivial code:</p>

<pre><code>using System;   
class Test
{
    delegate int FooDelegate(int i);
    FooDelegate Foo = FooImplementation;
    static int FooImplementation(int i)
    {
        return i + 1;
    }

    public static void Main()
    {
         Foo(1);
    }
}
</code></pre>

<p>What I would like to do is inject some debugging code into the Foo delegate, which would be equivalent:</p>

<pre><code>FooDelegate Foo = delegate(int i)
{
    try
    {
        DebugPrologue();
        return FooImplementation(i);
    }
    finally
    {
        DebugEpilogue();
    }
};
</code></pre>

<p>The twist is that I must be able to do this at <em>runtime</em>, so compile-time and post-processing methods are out of the question.</p>

<p>My initial approach used Delegate.Combine() to add the prologue and epilogue methods to the Foo delegate. Alas, this won't work as it munges return values.</p>

<p>My current idea is to use System.Reflection.Emit and DynamicMethod as a potential solution. As far as I can tell, I need to get the MethodInfo for FooImplementation, get its MethodBody, convert that to a DynamicMethod and inject my try-finally block into that.</p>

<p>Unfortunately, I have absolutely no idea how to do this. Anyone willing to lend a hand? Or do you have another (preferably simpler) idea?</p>

<p>Edit: the use-case here is debugging an OpenGL binding (http://www.opentk.com). We have to inject 2226 methods with wildly different parameters, so a general approach is necessary.</p>
 "AccessViolationException was unhandled" error in C# Managed Code <p>I have new problem. My code:</p>

<pre><code>.method public static void  Main() cil managed
{
  .entrypoint
  // Code size       3 (0x3)
  .maxstack  1
  IL_0000:  ldnull
  IL_0001:  stloc.0
  IL_0002:  ret
} // end of method Program::Main
</code></pre>

<p>C# code:</p>

<pre><code>il.Emit(OpCodes.Ldnull);
il.Emit(OpCodes.Stloc_0);
il.Emit(OpCodes.Ret);
</code></pre>

<p>I'm generating this code via System.Reflection and System.Reflection.Emit classes. Does anybody known why this cannot works? Please help.</p>

<p><img src="http://i.stack.imgur.com/pukuK.png" alt="My error"></p>

<p>One small question - should I generate constructor?</p>
 How to Emit event at runtime <p>I wish to generate (emit) class that implement an Interface at run-time with C#.</p>

<p>I have succeeded to emit methods and properties, but I failed to emit an event.</p>

<p>Here is the code I wish to emit:</p>

<p>Namespace: TestInterfaces, Class: TestIImplementMe.</p>

<pre><code>public event EventHandler SimpleEvent;
</code></pre>

<p>Here is the IL code generated:</p>

<pre><code>.event [mscorlib]System.EventHandler SimpleEvent
{
    .addon instance void TestInterfaces.TestIImplementMe::add_SimpleEvent(class [mscorlib]System.EventHandler)
    .removeon instance void TestInterfaces.TestIImplementMe::remove_SimpleEvent(class [mscorlib]System.EventHandler)
}

.method public final hidebysig specialname newslot virtual 
    instance void add_SimpleEvent (
        class [mscorlib]System.EventHandler 'value'
    ) cil managed 
{
    // Method begins at RVA 0x330c
    // Code size 48 (0x30)
    .maxstack 3
    .locals init (
        [0] class [mscorlib]System.EventHandler,
        [1] class [mscorlib]System.EventHandler,
        [2] class [mscorlib]System.EventHandler,
        [3] bool
    )

    IL_0000: ldarg.0
    IL_0001: ldfld class [mscorlib]System.EventHandler TestInterfaces.TestIImplementMe::SimpleEvent
    IL_0006: stloc.0
    // loop start (head: IL_0007)
        IL_0007: ldloc.0
        IL_0008: stloc.1
        IL_0009: ldloc.1
        IL_000a: ldarg.1
        IL_000b: call class [mscorlib]System.Delegate [mscorlib]System.Delegate::Combine(class [mscorlib]System.Delegate, class [mscorlib]System.Delegate)
        IL_0010: castclass [mscorlib]System.EventHandler
        IL_0015: stloc.2
        IL_0016: ldarg.0
        IL_0017: ldflda class [mscorlib]System.EventHandler TestInterfaces.TestIImplementMe::SimpleEvent
        IL_001c: ldloc.2
        IL_001d: ldloc.1
        IL_001e: call !!0 [mscorlib]System.Threading.Interlocked::CompareExchange&lt;class [mscorlib]System.EventHandler&gt;(!!0&amp;, !!0, !!0)
        IL_0023: stloc.0
        IL_0024: ldloc.0
        IL_0025: ldloc.1
        IL_0026: ceq
        IL_0028: ldc.i4.0
        IL_0029: ceq
        IL_002b: stloc.3
        IL_002c: ldloc.3
        IL_002d: brtrue.s IL_0007
    // end loop
    IL_002f: ret
} // end of method TestIImplementMe::add_SimpleEvent

.method public final hidebysig specialname newslot virtual 
    instance void remove_SimpleEvent (
        class [mscorlib]System.EventHandler 'value'
    ) cil managed 
{
    // Method begins at RVA 0x3348
    // Code size 48 (0x30)
    .maxstack 3
    .locals init (
        [0] class [mscorlib]System.EventHandler,
        [1] class [mscorlib]System.EventHandler,
        [2] class [mscorlib]System.EventHandler,
        [3] bool
    )

    IL_0000: ldarg.0
    IL_0001: ldfld class [mscorlib]System.EventHandler TestInterfaces.TestIImplementMe::SimpleEvent
    IL_0006: stloc.0
    // loop start (head: IL_0007)
        IL_0007: ldloc.0
        IL_0008: stloc.1
        IL_0009: ldloc.1
        IL_000a: ldarg.1
        IL_000b: call class [mscorlib]System.Delegate [mscorlib]System.Delegate::Remove(class [mscorlib]System.Delegate, class [mscorlib]System.Delegate)
        IL_0010: castclass [mscorlib]System.EventHandler
        IL_0015: stloc.2
        IL_0016: ldarg.0
        IL_0017: ldflda class [mscorlib]System.EventHandler TestInterfaces.TestIImplementMe::SimpleEvent
        IL_001c: ldloc.2
        IL_001d: ldloc.1
        IL_001e: call !!0 [mscorlib]System.Threading.Interlocked::CompareExchange&lt;class [mscorlib]System.EventHandler&gt;(!!0&amp;, !!0, !!0)
        IL_0023: stloc.0
        IL_0024: ldloc.0
        IL_0025: ldloc.1
        IL_0026: ceq
        IL_0028: ldc.i4.0
        IL_0029: ceq
        IL_002b: stloc.3
        IL_002c: ldloc.3
        IL_002d: brtrue.s IL_0007
    // end loop
    IL_002f: ret
} // end of method TestIImplementMe::remove_SimpleEvent
</code></pre>

<p>I managed to do all but this line:
    IL_001e: call !!0 [mscorlib]System.Threading.Interlocked::CompareExchange(!!0&amp;, !!0, !!0)</p>

<p>What is the meaning of: !!0, !!0&amp;?</p>

<p>How do I call this method with IL emit?</p>

<p>I tried to call the method, but when I add handler:</p>

<pre><code>obj.SimpleEvent += new EventHandler(obj_SimpleEvent);
</code></pre>

<p>I get this exception:</p>

<pre><code>System.BadImageFormatException was unhandled
  Message=An attempt was made to load a program with an incorrect format. (Exception from HRESULT: 0x8007000B)
  Source=DataBuilderAssembly
  StackTrace:
       at NewTest.add_SimpleEvent(EventHandler value)
       at TestInterfaces.Program.Main(String[] args) in D:\Dev\Private\TestInterfaces\TestInterfaces\Program.cs:line 47
       at System.AppDomain._nExecuteAssembly(RuntimeAssembly assembly, String[] args)
       at System.AppDomain.ExecuteAssembly(String assemblyFile, Evidence assemblySecurity, String[] args)
       at Microsoft.VisualStudio.HostingProcess.HostProc.RunUsersAssembly()
       at System.Threading.ThreadHelper.ThreadStart_Context(Object state)
       at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean ignoreSyncCtx)
       at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)
       at System.Threading.ThreadHelper.ThreadStart()
</code></pre>

<p>Here is the code to emit event's add method
where</p>

<pre><code>methodName = "add_SimpleEvent";
actionHanler = typeof(Delegate).GetMethod("Combine", new Type[]{typeof(Delegate),typeof(Delegate)});
eventField = typeBuilder.DefineField(info.Name, info.EventHandlerType, FieldAttributes.Private);
compareExchange = GetGenericMethod(typeof(Interlocked), "CompareExchange");// finds the correct method to call.
// thanks to @marc, create the specific method with the correct type
compareExchange = compareExchange.MakeGenericMethod(info.EventHandlerType);
</code></pre>

<p>GenerateEventMethod</p>

<pre><code>private static MethodBuilder GenerateEventMethod(string methodName, MethodInfo actionHanler, TypeBuilder typeBuilder, EventInfo info, FieldBuilder eventField, MethodInfo compareExchange)
{
    MethodBuilder method = typeBuilder.DefineMethod(methodName, InternalMethodsAttributes, null, new Type[] { info.EventHandlerType });
    method.DefineParameter(0, ParameterAttributes.Retval, null);
    method.DefineParameter(1, ParameterAttributes.In, "value");
    ILGenerator il = method.GetILGenerator();
    il.DeclareLocal(info.EventHandlerType);
    il.DeclareLocal(info.EventHandlerType);
    il.DeclareLocal(info.EventHandlerType);
    il.DeclareLocal(typeof (bool));

    Label loop = il.DefineLabel();

    il.Emit(OpCodes.Ldarg_0);
    il.Emit(OpCodes.Ldfld, eventField);
    il.Emit(OpCodes.Stloc_0);

    il.MarkLabel(loop);// loop start (head: IL_0007)

    il.Emit(OpCodes.Ldloc_0);
    il.Emit(OpCodes.Stloc_1);
    il.Emit(OpCodes.Ldloc_1);
    il.Emit(OpCodes.Ldarg_1);

    il.Emit(OpCodes.Call, actionHanler);
    il.Emit(OpCodes.Castclass, info.EventHandlerType);

    il.Emit(OpCodes.Stloc_2);
    il.Emit(OpCodes.Ldarg_0);

    il.Emit(OpCodes.Ldflda, eventField);

    il.Emit(OpCodes.Ldloc_2);
    il.Emit(OpCodes.Ldloc_1);

    // How to do this?
    //IL_001e: call !!0 [mscorlib]System.Threading.Interlocked::CompareExchange&lt;class [mscorlib]System.EventHandler`1&lt;class [mscorlib]System.ConsoleCancelEventArgs&gt;&gt;(!!0&amp;, !!0, !!0)
    //il.Emit(OpCodes.Call, !!0 compareExchange(!!0&amp;,!!0, !!0));
    il.Emit(OpCodes.Call, compareExchange);

    il.Emit(OpCodes.Stloc_0);
    il.Emit(OpCodes.Ldloc_0);
    il.Emit(OpCodes.Ldloc_1);
    il.Emit(OpCodes.Ceq);
    il.Emit(OpCodes.Ldc_I4_0);
    il.Emit(OpCodes.Ceq);
    il.Emit(OpCodes.Stloc_3);
    il.Emit(OpCodes.Ldloc_3);
    il.Emit(OpCodes.Brtrue_S, loop);
    // end loop
    il.Emit(OpCodes.Ret);

    return method;
}
</code></pre>

<p>GetGenericMethod (specific for this issue):</p>

<pre><code>private static MethodInfo GetGenericMethod(Type type, string methodName)
{
    var q = from m in type.GetMethods()
            where m.Name == methodName &amp;&amp; m.IsGenericMethod
            select m;
    return q.FirstOrDefault();
}
</code></pre>

<p>Thanks,
Ofir</p>
 Emitting function with optional parameter <p>I have the following C# code:</p>

<pre class="lang-cs prettyprint-override"><code>public static double f(double x1, double x2 = 1)
{
    return x1 * x2;
}
</code></pre>

<p>And here it's IL code (ILSpy):</p>

<pre class="lang-cs prettyprint-override"><code>.method public hidebysig static 
    float64 f (
        float64 x1,
        [opt] float64 x2
    ) cil managed 
{
    .param [2] = float64(1)
    // Method begins at RVA 0x20c6
    // Code size 4 (0x4)
    .maxstack 8

    IL_0000: ldarg.0
    IL_0001: ldarg.1
    IL_0002: mul
    IL_0003: ret
} // end of method A::f
</code></pre>

<p>How can I get it with <strong>System.Reflection.Emit</strong> or better with the <strong>Mono.Cecil</strong>?</p>
 Using .NET's Reflection.Emit to generate an interface  <p>I need to generate a new interface at run-time with all the same members as an existing interface, except that I will be putting different attributes on some of the methods (some of the attribute parameters are not known until run-time). How can it be achieved?</p>
 What's the MSIL to call a base class's event handler? <p>I have a class called EventConsumer which defines an event EventConsumed and a method OnEventConsumed as follows:</p>

<pre><code>public event EventHandler EventConsumed;

public virtual void OnEventConsumed(object sender, EventArgs e)
{
    if (EventConsumed != null)
        EventConsumed(this, e);
}
</code></pre>

<p>I need to add attributes to the at OnEventConsumed runtime, so I'm generating a subclass using System.Reflection.Emit.  What I want is the MSIL equivalent of this:</p>

<pre><code>public override void OnEventConsumed(object sender, EventArgs e)
{
    base.OnEventConsumed(sender, e);
}
</code></pre>

<p>What I have so far is this:</p>

<pre><code>...

MethodInfo baseMethod = typeof(EventConsumer).GetMethod("OnEventConsumed");
MethodBuilder methodBuilder = typeBuilder.DefineMethod("OnEventConsumed",
                                                       baseMethod.Attributes,
                                                       baseMethod.CallingConvention,
                                                       typeof(void),
                                                       new Type[] {typeof(object),
                                                                   typeof(EventArgs)});

ILGenerator ilGenerator = methodBuilder.GetILGenerator();

// load the first two args onto the stack
ilGenerator.Emit(OpCodes.Ldarg_1);
ilGenerator.Emit(OpCodes.Ldarg_2);

// call the base method
ilGenerator.EmitCall(OpCodes.Callvirt, baseMethod, new Type[0] );

// return
ilGenerator.Emit(OpCodes.Ret);

...
</code></pre>

<p>I create the type, create an instance of the type, and call its OnEventConsumed function, and I get:</p>

<pre><code>Common Language Runtime detected an invalid program.
</code></pre>

<p>...which is not exactly helpful.  What am I doing wrong?  What's the correct MSIL to call the base class's event handler?</p>
 DynamicMethod with generic type parameters <p>Is it possible to define a DynamicMethod with generic type parameters? The MethodBuilder class has the DefineGenericParameters method. Does the DynamicMethod have a counterpart? For example is it possible to create method with a signature like the one given blow using DynamicMethod?</p>

<pre><code>void T Foo&lt;T&gt;(T a1, int a2)
</code></pre>
 Why does getting the mocked instance created with Moq throw a System.BadImageFormatException? <p>This question may be related to <a href="http://stackoverflow.com/questions/305345/moq-multi-interface-question">another</a> question and it certainly results with a System.BadImageFormatException. Maybe it's the same thing but exposed differently?</p>

<p>I have the following the code:</p>

<pre><code>public interface IFoo&lt;T&gt; where T : class, new() {
  T FooMethod(object o);
}

public interface IFooRepo {
  F GetFoo&lt;T, F&gt;() where T : class, new() where F : IFoo&lt;T&gt;;
}
</code></pre>

<p>Then I have a test that mocks IFooRepo using Moq like so:</p>

<pre><code>var instance = new Mock&lt;IFooRepo&gt;().Object;
</code></pre>

<p>The above code runs fine except when debugging the test with Visual Studio 2008. When I step over the above line a System.BadImageFormatException is thrown from System.Reflection.Emit via Castle.DynamicProxy. Could this be similar to <a href="http://groups.google.com/group/RhinoMocks/msg/500daa19f20c9748" rel="nofollow">something</a> Ayende Rahien posted?</p>

<p>Now the workaround is to implement a fake for IFooRepo but I'm curious as to why a bad image is generated for this kind of scenario and is there a fix? Is System.Reflection.Emit buggy? Or am I missing something obvious in my own code?</p>

<p><strong>EDIT</strong>: Posted the incorrect signature for GetFoo(). Corrected the signature to GetFoo&lt;T, F&gt;(), which correctly reproduces the problem. With the GDR installed this problem persists.</p>

<p><strong>EDIT</strong>: It seems that if the constraint on F includes type parameter T BadImageFormatException is raised. But I change it to, say <code>where F : class, new()</code>, then everything works as expected.</p>
 Is it possible to write an assembly which dynamically generates a new class and patches itself with the new class? <p>Is it possible to write an assembly which dynamically generates/emits a new class and patches itself to include the new class?</p>

<p>How?</p>
 Dynamic C#.NET Webservice <p>I am using a class in a C# ASP.NET project to allow a script written in some random scripting language to expose webservice methods dynamically - in other words, the script should be able to expose a method of any name with any signature (as long as it's valid, anyway) to the outside world through this SOAP interface (able to add and remove them at will, without needing a hard code change), and as such I need to be able to create a webservice class in C# while being able to dynamically add and remove methods at runtime.</p>

<p>Now, the best plan I've been able to come up with so far is (runtime) generating C# code to represent the webservice, using System.Reflection.Emit to compile it and then loading the assembly at runtime - all whenever the script adds or removes a method to/from the service (should not happen very often, mind).</p>

<p>Does anyone have a better idea than this?</p>
 DynamicMethod returns incorrect value when property type is Int64 <p>I'm working on a routine to use DynamicMethod to retrieve values from a object. It worked fine with most of data types, except for DateTime.Ticks, which is int64</p>

<p>In the following test app. I uses both MethodInfo and DynamicMethod, the methodInfo returns correct value but DynamicMethod doesn't.   Any ideas?</p>

<pre><code>using System;
using System.Reflection;
using System.Reflection.Emit;

namespace ConsoleApplication2
{
    public delegate object MemberGetDelegate(object obj);

    class Program
    {
        static void Main(string[] args)
        {
            DateTime dat = DateTime.Today;
            PropertyInfo pi = typeof(DateTime).GetProperty("Ticks");
            MethodInfo mi = pi.GetGetMethod();
            Type type = pi.PropertyType;
            object ticks = mi.Invoke(dat, new object[] { });
            Console.WriteLine("Get by MethodInfo " + ticks.ToString());

            MemberGetDelegate mget=TypeUtils.GetMemberFunc(pi);
            object ret = mget(dat);
            Console.WriteLine("Get by DynamicMethod " + ret.ToString());

            Console.Read();
        }
    }

    static class TypeUtils
    {
        public static readonly Type objectType = typeof(object);
        public static readonly Type[] typeArray = new[] { typeof(object) };

        public static MemberGetDelegate GetMemberFunc(PropertyInfo pi)
        {

            MethodInfo mi = pi.GetGetMethod();

            if (mi != null)
            {
                DynamicMethod dm = new DynamicMethod("_" + mi.Name,
                                                     objectType,
                                                     typeArray,
                                                     pi.Module, true);
                ILGenerator il = dm.GetILGenerator();

                // Load the instance of the object (argument 0) onto the stack
                il.Emit(OpCodes.Ldarg_0);

                // Call underlying get method
                il.EmitCall(OpCodes.Callvirt, mi, null);

                //boxing
                if (pi.PropertyType.IsValueType)
                {
                    il.Emit(OpCodes.Box, pi.PropertyType);                   
                }

                // return the value on the top of the stack
                il.Emit(OpCodes.Ret);

                return  (MemberGetDelegate) dm.CreateDelegate(typeof (MemberGetDelegate));

            }
            return null;
        }
    }
}
</code></pre>
 Linking a .NET Expression Tree into a new assembly <p>I'm trying to write my own toy My Toy Language -> MSIL compiler in order to get a better understanding of how compilers work. I got the parsing and lexing working, I have built the expression trees and using the System.Linq.Expressions expression tree API, I have a working interpreter. Now I would like to emit some real MSIL assemblies.</p>

<p>The problem is, I can't figure out how to actually build these assemblies. The <a href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.methodbuilder.aspx" rel="nofollow">MethodBuilder</a> class only accepts raw MSIL method bodies, so I have to get the raw MSIL of my expression tree. Calling <a href="http://msdn.microsoft.com/en-us/library/bb345362.aspx" rel="nofollow">Expression.Compile()</a> returns a working delegate but I'm not able to get its underlying MSIL. Calling <a href="http://msdn.microsoft.com/en-us/library/system.reflection.methodbase.getmethodbody.aspx" rel="nofollow">MethodInfo.GetMethodBody()</a> throws an InvalidOperationException since it's not implemented in that specific child class.</p>

<p>How can I link that delegate into a new assembly?</p>
 Reflect.Emit Dynamic Type Memory Blowup <p>Using C# 3.5 I am trying to generate dynamic types at runtime using reflection emit. I used the <a href="http://msdn2.microsoft.com/en-us/vcsharp/bb894665.aspx" rel="nofollow">Dynamic Query Library</a> sample from Microsoft to create a class generator. Everything works, my problem is that 100 generated types inflate the memory usage by approximately 25MB. This is a completely unacceptable memory profile as eventually I want to support having several hundred thousand types generated in memory. </p>

<p>Memory profiling shows that the memory is apparently being held by various System.Reflection.Emit types and methods though I can't figure out why. I haven't found others talking about this problem so I am hoping someone in this community either knows what I am doing wrong or if this is expected behavior.</p>

<p>Contrived Example below:</p>

<pre><code>using System;
using System.Collections.Generic;
using System.Text;
using System.Reflection;
using System.Reflection.Emit;

namespace SmallRelfectExample
{
    class Program
    {
        static void Main(string[] args)
        {
            int typeCount = 100;
            int propCount = 100;
            Random rand = new Random();
            Type dynType = null;
            SlimClassFactory scf = new SlimClassFactory();
            for (int i = 0; i &lt; typeCount; i++)
            {
                List&lt;DynamicProperty&gt; dpl = new List&lt;DynamicProperty&gt;(propCount);
                for (int j = 0; j &lt; propCount; j++)
                {
                    dpl.Add(new DynamicProperty("Key" + rand.Next().ToString(), typeof(String)));
                }
                dynType = scf.CreateDynamicClass(dpl.ToArray(), i);
                //Optionally do something with the type here
            }
            Console.WriteLine("SmallRelfectExample: {0} Types generated.", typeCount);
            Console.ReadLine();
        }
    }
    public class SlimClassFactory
    {
        private readonly ModuleBuilder module;
        public SlimClassFactory()
        {
            AssemblyName name = new AssemblyName("DynamicClasses");
            AssemblyBuilder assembly = AppDomain.CurrentDomain.DefineDynamicAssembly(name, AssemblyBuilderAccess.Run);
            module = assembly.DefineDynamicModule("Module");

        }
        public Type CreateDynamicClass(DynamicProperty[] properties, int Id)
        {
            string typeName = "DynamicClass" + Id.ToString();
            TypeBuilder tb = module.DefineType(typeName, TypeAttributes.Class |
                TypeAttributes.Public, typeof(DynamicClass));
            FieldInfo[] fields = GenerateProperties(tb, properties);
            GenerateEquals(tb, fields);
            GenerateGetHashCode(tb, fields);
            Type result = tb.CreateType();
            return result;
        }
        static FieldInfo[] GenerateProperties(TypeBuilder tb, DynamicProperty[] properties)
        {
            FieldInfo[] fields = new FieldBuilder[properties.Length];
            for (int i = 0; i &lt; properties.Length; i++)
            {
                DynamicProperty dp = properties[i];
                FieldBuilder fb = tb.DefineField("_" + dp.Name, dp.Type, FieldAttributes.Private);
                PropertyBuilder pb = tb.DefineProperty(dp.Name, PropertyAttributes.HasDefault, dp.Type, null);
                MethodBuilder mbGet = tb.DefineMethod("get_" + dp.Name,
                    MethodAttributes.Public | MethodAttributes.SpecialName | MethodAttributes.HideBySig,
                    dp.Type, Type.EmptyTypes);
                ILGenerator genGet = mbGet.GetILGenerator();
                genGet.Emit(OpCodes.Ldarg_0);
                genGet.Emit(OpCodes.Ldfld, fb);
                genGet.Emit(OpCodes.Ret);
                MethodBuilder mbSet = tb.DefineMethod("set_" + dp.Name,
                    MethodAttributes.Public | MethodAttributes.SpecialName | MethodAttributes.HideBySig,
                    null, new Type[] { dp.Type });
                ILGenerator genSet = mbSet.GetILGenerator();
                genSet.Emit(OpCodes.Ldarg_0);
                genSet.Emit(OpCodes.Ldarg_1);
                genSet.Emit(OpCodes.Stfld, fb);
                genSet.Emit(OpCodes.Ret);
                pb.SetGetMethod(mbGet);
                pb.SetSetMethod(mbSet);
                fields[i] = fb;
            }
            return fields;
        }
        static void GenerateEquals(TypeBuilder tb, FieldInfo[] fields)
        {
            MethodBuilder mb = tb.DefineMethod("Equals",
                MethodAttributes.Public | MethodAttributes.ReuseSlot |
                MethodAttributes.Virtual | MethodAttributes.HideBySig,
                typeof(bool), new Type[] { typeof(object) });
            ILGenerator gen = mb.GetILGenerator();
            LocalBuilder other = gen.DeclareLocal(tb);
            Label next = gen.DefineLabel();
            gen.Emit(OpCodes.Ldarg_1);
            gen.Emit(OpCodes.Isinst, tb);
            gen.Emit(OpCodes.Stloc, other);
            gen.Emit(OpCodes.Ldloc, other);
            gen.Emit(OpCodes.Brtrue_S, next);
            gen.Emit(OpCodes.Ldc_I4_0);
            gen.Emit(OpCodes.Ret);
            gen.MarkLabel(next);
            foreach (FieldInfo field in fields)
            {
                Type ft = field.FieldType;
                Type ct = typeof(EqualityComparer&lt;&gt;).MakeGenericType(ft);
                next = gen.DefineLabel();
                gen.EmitCall(OpCodes.Call, ct.GetMethod("get_Default"), null);
                gen.Emit(OpCodes.Ldarg_0);
                gen.Emit(OpCodes.Ldfld, field);
                gen.Emit(OpCodes.Ldloc, other);
                gen.Emit(OpCodes.Ldfld, field);
                gen.EmitCall(OpCodes.Callvirt, ct.GetMethod("Equals", new Type[] { ft, ft }), null);
                gen.Emit(OpCodes.Brtrue_S, next);
                gen.Emit(OpCodes.Ldc_I4_0);
                gen.Emit(OpCodes.Ret);
                gen.MarkLabel(next);
            }
            gen.Emit(OpCodes.Ldc_I4_1);
            gen.Emit(OpCodes.Ret);
        }
        static void GenerateGetHashCode(TypeBuilder tb, FieldInfo[] fields)
        {
            MethodBuilder mb = tb.DefineMethod("GetHashCode",
                MethodAttributes.Public | MethodAttributes.ReuseSlot |
                MethodAttributes.Virtual | MethodAttributes.HideBySig,
                typeof(int), Type.EmptyTypes);
            ILGenerator gen = mb.GetILGenerator();
            gen.Emit(OpCodes.Ldc_I4_0);
            foreach (FieldInfo field in fields)
            {
                Type ft = field.FieldType;
                Type ct = typeof(EqualityComparer&lt;&gt;).MakeGenericType(ft);
                gen.EmitCall(OpCodes.Call, ct.GetMethod("get_Default"), null);
                gen.Emit(OpCodes.Ldarg_0);
                gen.Emit(OpCodes.Ldfld, field);
                gen.EmitCall(OpCodes.Callvirt, ct.GetMethod("GetHashCode", new Type[] { ft }), null);
                gen.Emit(OpCodes.Xor);
            }
            gen.Emit(OpCodes.Ret);
        }
    }
    public abstract class DynamicClass
    {
        public override string ToString()
        {
            PropertyInfo[] props = GetType().GetProperties(BindingFlags.Instance | BindingFlags.Public);
            StringBuilder sb = new StringBuilder();
            sb.Append("{");
            for (int i = 0; i &lt; props.Length; i++)
            {
                if (i &gt; 0) sb.Append(", ");
                sb.Append(props[i].Name);
                sb.Append("=");
                sb.Append(props[i].GetValue(this, null));
            }
            sb.Append("}");
            return sb.ToString();
        }
    }
    public class DynamicProperty
    {
        private readonly string name;
        private readonly Type type;

        public DynamicProperty(string name, Type type)
        {
            if (name == null) throw new ArgumentNullException("name");
            if (type == null) throw new ArgumentNullException("type");
            this.name = name;
            this.type = type;
        }

        public string Name
        {
            get { return name; }
        }

        public Type Type
        {
            get { return type; }
        }
    }
}
</code></pre>
 Using Reflection.Emit to match existing constructor <p>First, here is the C# code and the disassembled IL:</p>

<pre><code>public class Program&lt;T&gt;
{
    private List&lt;T&gt; _items;

    public Program(T x, [Microsoft.Scripting.ParamDictionary] Microsoft.Scripting.IAttributesCollection col)
    {
        _items = new List&lt;T&gt;();
        _items.Add(x);
    }
}
</code></pre>

<p>Here is the IL of that constructor:</p>

<pre><code>.method public hidebysig specialname rtspecialname 
        instance void  .ctor(!T x,
                             class [Microsoft.Scripting]Microsoft.Scripting.IAttributesCollection col) cil managed
{
  .param [2]
  .custom instance void [Microsoft.Scripting]Microsoft.Scripting.ParamDictionaryAttribute::.ctor() = ( 01 00 00 00 ) 
  // Code size       34 (0x22)
  .maxstack  8
  IL_0000:  ldarg.0
  IL_0001:  call       instance void [mscorlib]System.Object::.ctor()
  IL_0006:  nop
  IL_0007:  nop
  IL_0008:  ldarg.0
  IL_0009:  newobj     instance void class [mscorlib]System.Collections.Generic.List`1&lt;!T&gt;::.ctor()
  IL_000e:  stfld      class [mscorlib]System.Collections.Generic.List`1&lt;!0&gt; class Foo.Program`1&lt;!T&gt;::_items
  IL_0013:  ldarg.0
  IL_0014:  ldfld      class [mscorlib]System.Collections.Generic.List`1&lt;!0&gt; class Foo.Program`1&lt;!T&gt;::_items
  IL_0019:  ldarg.1
  IL_001a:  callvirt   instance void class [mscorlib]System.Collections.Generic.List`1&lt;!T&gt;::Add(!0)
  IL_001f:  nop
  IL_0020:  nop
  IL_0021:  ret
} // end of method Program`1::.ctor
</code></pre>

<p>I am trying to understand the IL code by emitting it myself.  This is what I have managed to emit:</p>

<pre><code>.method public hidebysig specialname rtspecialname 
        instance void  .ctor(!T A_1,
                             class [Microsoft.Scripting]Microsoft.Scripting.IAttributesCollection A_2) cil managed
{
  // Code size       34 (0x22)
  .maxstack  4
  IL_0000:  ldarg.0
  IL_0001:  call       instance void [mscorlib]System.Object::.ctor()
  IL_0006:  ldarg.0
  IL_0007:  newobj     instance void class [mscorlib]System.Collections.Generic.List`1&lt;!T&gt;::.ctor()
  IL_000c:  stfld      class [mscorlib]System.Collections.Generic.List`1&lt;!0&gt; class MyType&lt;!T&gt;::_items
  IL_0011:  ldarg.0
  IL_0012:  ldfld      class [mscorlib]System.Collections.Generic.List`1&lt;!0&gt; class MyType&lt;!T&gt;::_items
  IL_0017:  ldarg.s    A_1
  IL_0019:  nop
  IL_001a:  nop
  IL_001b:  nop
  IL_001c:  callvirt   instance void class [mscorlib]System.Collections.Generic.List`1&lt;!T&gt;::Add(!0)
  IL_0021:  ret
} // end of method MyType::.ctor
</code></pre>

<p>There are a few differences that I just can't figure out.  I'm really close...</p>

<ol>
<li><p>How do I take care of the parameter attribute (ParamDictionaryAttribute)?  I can't find a 'custom' opcode.</p></li>
<li><p>Is the .param [2] important?  How do I emit that?</p></li>
<li><p>Why is the C# code stack size 8, while my emitted version is 4?  Is this important?</p></li>
</ol>
 Where can I find information on the Get, Set and Address methods for multidimensional System.Array instances in .NET? <p><a href="http://msdn.microsoft.com/en-us/library/system.array.aspx" rel="nofollow">System.Array</a> serves as the base class for all arrays in the Common Language Runtime (CLR). According to <a href="http://blogs.msdn.com/haibo_luo/archive/2006/11/26/1157785.aspx" rel="nofollow" title="Late-bound array SetValue">this article</a>:</p>

<blockquote>
  <p>For each concrete array type, [the] runtime adds three special methods: <code>Get</code>/<code>Set</code>/<code>Address</code>.</p>
</blockquote>

<p>and indeed if I disassemble this C# code,</p>

<pre><code>int[,] x = new int[1024,1024];
x[0,0] = 1;
x[1,1] = 2;
x[2,2] = 3;
Console.WriteLine(x[0,0]);
Console.WriteLine(x[1,1]);
Console.WriteLine(x[2,2]);
</code></pre>

<p>into CIL I get,</p>

<pre><code>IL_0000:  ldc.i4     0x400
IL_0005:  ldc.i4     0x400
IL_000a:  newobj     instance void int32[0...,0...]::.ctor(int32,
                                                         int32)
IL_000f:  stloc.0
IL_0010:  ldloc.0
IL_0011:  ldc.i4.0
IL_0012:  ldc.i4.0
IL_0013:  ldc.i4.1
IL_0014:  call       instance void int32[0...,0...]::Set(int32,
                                                       int32,
                                                       int32)
IL_0019:  ldloc.0
IL_001a:  ldc.i4.1
IL_001b:  ldc.i4.1
IL_001c:  ldc.i4.2
IL_001d:  call       instance void int32[0...,0...]::Set(int32,
                                                       int32,
                                                       int32)
IL_0022:  ldloc.0
IL_0023:  ldc.i4.2
IL_0024:  ldc.i4.2
IL_0025:  ldc.i4.3
IL_0026:  call       instance void int32[0...,0...]::Set(int32,
                                                       int32,
                                                       int32)
IL_002b:  ldloc.0
IL_002c:  ldc.i4.0
IL_002d:  ldc.i4.0
IL_002e:  call       instance int32 int32[0...,0...]::Get(int32,
                                                        int32)
IL_0033:  call       void [mscorlib]System.Console::WriteLine(int32)
IL_0038:  ldloc.0
IL_0039:  ldc.i4.1
IL_003a:  ldc.i4.1
IL_003b:  call       instance int32 int32[0...,0...]::Get(int32,
                                                        int32)
IL_0040:  call       void [mscorlib]System.Console::WriteLine(int32)
IL_0045:  ldloc.0
IL_0046:  ldc.i4.2
IL_0047:  ldc.i4.2
IL_0048:  call       instance int32 int32[0...,0...]::Get(int32,
                                                        int32)
IL_004d:  call       void [mscorlib]System.Console::WriteLine(int32)
</code></pre>

<p>where the calls to the aforementioned <code>Get</code> and <code>Set</code> methods can be clearly seen. It seems the arity of these methods is related to the dimensionality of the array, which is presumably why they are created by the runtime and are not pre-declared.  I couldn't locate any information about these methods on MSDN and their simple names makes them resistant to Googling. I'm writing a compiler for a language which supports multidimensional arrays, so I'd like to find some official documentation about these methods, under what conditions I can expect them to exist and what I can expect their signatures to be.</p>

<p>In particular, I'd like to know whether its possible to get a <code>MethodInfo</code> object for <code>Get</code> or <code>Set</code> for use with <code>Reflection.Emit</code> without having to create an <em>instance</em> of the array with correct type and dimensionality on which to reflect, as is done in the linked example.</p>
 Can't access CodeBase from a dynamically generated assembly <p>I'm trying to create an assembly dynamically in .Net.  I can't seem to figure out how to get the CodeBase property to return a value, however.  Here's an example:</p>

<pre><code>var assemblyName = new AssemblyName
                        {
                            Name = "Whatever",
                            CodeBase = Directory.GetCurrentDirectory()
                        };
var assemblyBuilder = AppDomain.CurrentDomain
    .DefineDynamicAssembly(assemblyName, AssemblyBuilderAccess.RunAndSave);
var moduleBuilder = assemblyBuilder.DefineDynamicModule("WhateverModule", "Whatever.dll");
var typeBuilder = moduleBuilder.DefineType("WhateverType", TypeAttributes.Public);
var type = typeBuilder.CreateType();
assemblyBuilder.Save("Whatever.dll");
var codeBase = type.Assembly.CodeBase; // throws the below exception

System.NotSupportedException was unhandled
  Message=The invoked member is not supported in a dynamic assembly.
  Source=mscorlib
  StackTrace:
       at System.Reflection.Emit.InternalAssemblyBuilder.get_CodeBase()
       at Stupid.Program.Main(String[] args) in C:\Users\Walking Disaster\Documents\Visual Studio 10\Projects\Lingual.Proxy\Stupid\Program.cs:line 25
       at System.AppDomain._nExecuteAssembly(RuntimeAssembly assembly, String[] args)
       at System.AppDomain.ExecuteAssembly(String assemblyFile, Evidence assemblySecurity, String[] args)
       at Microsoft.VisualStudio.HostingProcess.HostProc.RunUsersAssembly()
       at System.Threading.ThreadHelper.ThreadStart_Context(Object state)
       at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state, Boolean ignoreSyncCtx)
       at System.Threading.ExecutionContext.Run(ExecutionContext executionContext, ContextCallback callback, Object state)
       at System.Threading.ThreadHelper.ThreadStart()
</code></pre>

<p>Can anyone see what I'm doing wrong?</p>

<p>Explanation: I'm trying to extend NUnit with an addin that generates test methods at runtime. It does this by taking an array of Action delegates. Unfortunately, Reflection is baked pretty deep into the framework, so I have had to emit classes with a method for each Action delegate. This works fine when I'm using the NUnitTestMethod classes only, but when I use the NUnitTestFixture, it fails because it tries to read the CodeBase from the assembly. I didn't want to create a physical assembly, but this project has been one compromise after another.</p>
 
mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil mono.cecil Mono Cecil documentation and tutorials? <p>I am new to Mono Cecil!</p>

<p>Any comprehensive documentations and tutorials on Mono Cecil?</p>

<p>I have seen these articles and video below, so don't give me these links again:</p>

<p><a href="http://www.mono-project.com/Cecil:FAQ">http://www.mono-project.com/Cecil:FAQ</a></p>

<p><a href="http://blog.paul-mason.co.nz/2009/08/protecting-your-precious-code-monocecil.html">http://blog.paul-mason.co.nz/2009/08/protecting-your-precious-code-monocecil.html</a></p>

<p><a href="http://www.dimecasts.net/Casts/CastDetails/59">http://www.dimecasts.net/Casts/CastDetails/59</a></p>
 CCI vs. Mono.Cecil -- advantages and disadvantages <p>I have seen articles discussing these two similar frameworks, but most of them are two years old or so. I assume both projects are much more mature now than they were two years ago, and the situation is a more complex one.</p>

<p>So given the current states of each of the libraries, I was hoping someone could provide a detailed explanation of the advantages and disadvantages of each, and which should be preferred at present time.</p>
 Mono Cecil vs. PostSharp Core vs. Microsoft CCI for implementing AOP framework <p>Which is the better in terms of capabilities, easy of use, documentation, samples, community/support, VS integration, known implementations, long-term viability, and build speed to implement a custom AOP framework?</p>

<p>I'll start with what I know (I have only tried PostSharp to so far):</p>

<ul>
<li><strong>Microsoft Common Compiler
Instrastruture (CCI)</strong>: I've read that
is used for FxCop, ILMerge, Spec# and
Code Contracts. It seems to be very low level <a href="http://www.jasonbock.net/JB/Default.aspx?blog=entry.3dc8f8f4b5564b3380ce6e21bc56449c" rel="nofollow">as it does not even take care of correcting offsets for branch codes that are borken when IL is modified with it</a>.</li>
<li><strong>PostSharp</strong> is 5 years old, has many
capabilities for AOP (e.g. abstracts
some things you would need to have to
do manually with IL away), source
code available, developed/supported
by only one guy but he is planning on
making this a business, has
documentation but could be better,
builds take about twice as long, very
little samples on how to inject IL
and version 2.0 will be released soon
which promises to be much improved.</li>
<li><strong>Mono Cecil</strong>:  Written by one guy, part
of the Mono suite and there is a
plug-in for Reflector called Reflexil
that uses Mono Cecil.</li>
</ul>
 How do I replace embedded resources in a .NET assembly programmatically? <p>I am trying to replace a Resource of an exe(.NET, C#) file using C# code.</p>

<p>I have found this article: <a href="http://rongchaua.net/blog/c-how-to-edit-resource-of-an-assembly/">http://rongchaua.net/blog/c-how-to-edit-resource-of-an-assembly/</a> and made this code (using Mono.Cecil 0.6):</p>

<pre><code>AssemblyDefinition asdDefinition = AssemblyFactory.GetAssembly("C:\\File.exe");
EmbeddedResource erTemp = new EmbeddedResource("encFile", ManifestResourceAttributes.Public);
erTemp.Data = myNewFileBytes;
asdDefinition.MainModule.Resources.RemoveAt(0);
asdDefinition.MainModule.Resources.Add(erTemp);
AssemblyFactory.SaveAssembly(asdDefinition, "C:\\newFile.exe");
</code></pre>

<p>The code is actually removing the resource and then adding a new one with the same name.
The resource name is <code>encFile</code> and stored as <code>encFile.exe</code> (tried both).</p>

<p>I tested the code and the remove is working (i can tell by the size of the file) and the adding too, but the new file crash just like the file i created with the remove only (for the testing) - it acts like he can't see the replaced resource.</p>

<p>What can i do to fix it up? maybe some changes in the edited EXE file?
the EXE file read its resource this way:
<code>byte[] buffer = ProjectName.Properties.Resources.encFile;</code></p>
 Replacing instructions in a method's MethodBody <p>(First of all, this is a very lengthy post, but don't worry: I've already implemented all of it, I'm just asking your opinion, or possible alternatives.)</p>

<p>I'm having trouble implementing the following; I'd appreciate some help:</p>

<ol>
<li>I get a <code>Type</code> as parameter.</li>
<li>I define a subclass using reflection. Notice that I don't intend to modify the original type, but create a new one.</li>
<li><p>I create a property per field of the original class, like so:</p>

<pre><code>public class OriginalClass {
    private int x;
}


public class Subclass : OriginalClass {
    private int x;


<pre><code>public int X {
    get { return x; }
    set { x = value; }
}
</code></pre>

}
</code></pre></li>
<li><p>For every method of the superclass, I create an analogous method in the subclass. The method's body must be the same except that I replace the instructions <code>ldfld x</code> with <code>callvirt this.get_X</code>, that is, instead of reading from the field directly I call the get accessor.</p></li>
</ol>

<p>I'm having trouble with step 4. I know you're not supposed to manipulate code like this, but I really need to.</p>

<p>Here's what I've tried:</p>

<p><strong>Attempt #1:</strong> Use Mono.Cecil. This would allow me to parse the body of the method into human-readable <code>Instructions</code>, and easily replace instructions. However, the original type isn't in a .dll file, so I can't find a way to load it with Mono.Cecil. Writing the type to a .dll, then load it, then modify it and write the new type to disk (which I think is the way you create a type with Mono.Cecil), and then load it seems like a <em>huge</em> overhead.</p>

<p><strong>Attempt #2:</strong> Use Mono.Reflection. This would also allow me to parse the body into <code>Instructions</code>, but then I have no support for replacing instructions. I've implemented a very ugly and inefficient solution using Mono.Reflection, but it doesn't yet support methods that contain try-catch statements (although I guess I can implement this) and I'm concerned that there may be other scenarios in which it won't work, since I'm using the <code>ILGenerator</code> in a somewhat unusual way. Also, it's very ugly ;). Here's what I've done:</p>

<pre><code>private void TransformMethod(MethodInfo methodInfo) {

    // Create a method with the same signature.
    ParameterInfo[] paramList = methodInfo.GetParameters();
    Type[] args = new Type[paramList.Length];
    for (int i = 0; i &lt; args.Length; i++) {
        args[i] = paramList[i].ParameterType;
    }
    MethodBuilder methodBuilder = typeBuilder.DefineMethod(
        methodInfo.Name, methodInfo.Attributes, methodInfo.ReturnType, args);
    ILGenerator ilGen = methodBuilder.GetILGenerator();

    // Declare the same local variables as in the original method.
    IList&lt;LocalVariableInfo&gt; locals = methodInfo.GetMethodBody().LocalVariables;
    foreach (LocalVariableInfo local in locals) {
        ilGen.DeclareLocal(local.LocalType);
    }

    // Get readable instructions.
    IList&lt;Instruction&gt; instructions = methodInfo.GetInstructions();

    // I first need to define labels for every instruction in case I
    // later find a jump to that instruction. Once the instruction has
    // been emitted I cannot label it, so I'll need to do it in advance.
    // Since I'm doing a first pass on the method's body anyway, I could
    // instead just create labels where they are truly needed, but for
    // now I'm using this quick fix.
    Dictionary&lt;int, Label&gt; labels = new Dictionary&lt;int, Label&gt;();
    foreach (Instruction instr in instructions) {
        labels[instr.Offset] = ilGen.DefineLabel();
    }

    foreach (Instruction instr in instructions) {

        // Mark this instruction with a label, in case there's a branch
        // instruction that jumps here.
        ilGen.MarkLabel(labels[instr.Offset]);

        // If this is the instruction that I want to replace (ldfld x)...
        if (instr.OpCode == OpCodes.Ldfld) {
            // ...get the get accessor for the accessed field (get_X())
            // (I have the accessors in a dictionary; this isn't relevant),
            MethodInfo safeReadAccessor = dataMembersSafeAccessors[((FieldInfo) instr.Operand).Name][0];
            // ...instead of emitting the original instruction (ldfld x),
            // emit a call to the get accessor,
            ilGen.Emit(OpCodes.Callvirt, safeReadAccessor);

        // Else (it's any other instruction), reemit the instruction, unaltered.
        } else {
            Reemit(instr, ilGen, labels);
        }

    }

}
</code></pre>

<p>And here comes the horrible, horrible <code>Reemit</code> method:</p>

<pre><code>private void Reemit(Instruction instr, ILGenerator ilGen, Dictionary&lt;int, Label&gt; labels) {

    // If the instruction doesn't have an operand, emit the opcode and return.
    if (instr.Operand == null) {
        ilGen.Emit(instr.OpCode);
        return;
    }

    // Else (it has an operand)...

    // If it's a branch instruction, retrieve the corresponding label (to
    // which we want to jump), emit the instruction and return.
    if (instr.OpCode.FlowControl == FlowControl.Branch) {
        ilGen.Emit(instr.OpCode, labels[Int32.Parse(instr.Operand.ToString())]);
        return;
    }

    // Otherwise, simply emit the instruction. I need to use the right
    // Emit call, so I need to cast the operand to its type.
    Type operandType = instr.Operand.GetType();
    if (typeof(byte).IsAssignableFrom(operandType))
        ilGen.Emit(instr.OpCode, (byte) instr.Operand);
    else if (typeof(double).IsAssignableFrom(operandType))
        ilGen.Emit(instr.OpCode, (double) instr.Operand);
    else if (typeof(float).IsAssignableFrom(operandType))
        ilGen.Emit(instr.OpCode, (float) instr.Operand);
    else if (typeof(int).IsAssignableFrom(operandType))
        ilGen.Emit(instr.OpCode, (int) instr.Operand);
    ... // you get the idea. This is a pretty long method, all like this.
}
</code></pre>

<p>Branch instructions are a special case because <code>instr.Operand</code> is <code>SByte</code>, but <code>Emit</code> expects an operand of type <code>Label</code>. Hence the need for the <code>Dictionary labels</code>.</p>

<p>As you can see, this is pretty horrible. What's more, it doesn't work in all cases, for instance with methods that contain try-catch statements, since I haven't emitted them using methods <code>BeginExceptionBlock</code>, <code>BeginCatchBlock</code>, etc, of <code>ILGenerator</code>. This is getting complicated. I guess I can do it: <code>MethodBody</code> has a list of <code>ExceptionHandlingClause</code> that should contain the necessary information to do this. But I don't like this solution anyway, so I'll save this as a last-resort solution.</p>

<p><strong>Attempt #3:</strong> Go bare-back and just copy the byte array returned by <code>MethodBody.GetILAsByteArray()</code>, since I only want to replace a single instruction for another single instruction of the same size that produces the exact same result: it loads the same type of object on the stack, etc. So there won't be any labels shifting and everything should work exactly the same. I've done this, replacing specific bytes of the array and then calling <code>MethodBuilder.CreateMethodBody(byte[], int)</code>, but I still get the same error with exceptions, and I still need to declare the local variables or I'll get an error... even when I simply copy the method's body and don't change anything.
So this is more efficient but I still have to take care of the exceptions, etc.</p>

<p>Sigh.</p>

<p>Here's the implementation of attempt #3, in case anyone is interested:</p>

<pre><code>private void TransformMethod(MethodInfo methodInfo, Dictionary&lt;string, MethodInfo[]&gt; dataMembersSafeAccessors, ModuleBuilder moduleBuilder) {

    ParameterInfo[] paramList = methodInfo.GetParameters();
    Type[] args = new Type[paramList.Length];
    for (int i = 0; i &lt; args.Length; i++) {
        args[i] = paramList[i].ParameterType;
    }
    MethodBuilder methodBuilder = typeBuilder.DefineMethod(
        methodInfo.Name, methodInfo.Attributes, methodInfo.ReturnType, args);

    ILGenerator ilGen = methodBuilder.GetILGenerator();

    IList&lt;LocalVariableInfo&gt; locals = methodInfo.GetMethodBody().LocalVariables;
    foreach (LocalVariableInfo local in locals) {
        ilGen.DeclareLocal(local.LocalType);
    }

    byte[] rawInstructions = methodInfo.GetMethodBody().GetILAsByteArray();
    IList&lt;Instruction&gt; instructions = methodInfo.GetInstructions();

    int k = 0;
    foreach (Instruction instr in instructions) {

        if (instr.OpCode == OpCodes.Ldfld) {

            MethodInfo safeReadAccessor = dataMembersSafeAccessors[((FieldInfo) instr.Operand).Name][0];

            // Copy the opcode: Callvirt.
            byte[] bytes = toByteArray(OpCodes.Callvirt.Value);
            for (int m = 0; m &lt; OpCodes.Callvirt.Size; m++) {
                rawInstructions[k++] = bytes[put.Length - 1 - m];
            }

            // Copy the operand: the accessor's metadata token.
            bytes = toByteArray(moduleBuilder.GetMethodToken(safeReadAccessor).Token);
            for (int m = instr.Size - OpCodes.Ldfld.Size - 1; m &gt;= 0; m--) {
                rawInstructions[k++] = bytes[m];
            }

        // Skip this instruction (do not replace it).
        } else {
            k += instr.Size;
        }

    }

    methodBuilder.CreateMethodBody(rawInstructions, rawInstructions.Length);

}


private static byte[] toByteArray(int intValue) {
    byte[] intBytes = BitConverter.GetBytes(intValue);
    if (BitConverter.IsLittleEndian)
        Array.Reverse(intBytes);
    return intBytes;
}



private static byte[] toByteArray(short shortValue) {
    byte[] intBytes = BitConverter.GetBytes(shortValue);
    if (BitConverter.IsLittleEndian)
        Array.Reverse(intBytes);
    return intBytes;
}
</code></pre>

<p>(I know it isn't pretty. Sorry. I put it quickly together to see if it would work.)</p>

<p>I don't have much hope, but can anyone suggest anything better than this?</p>

<p>Sorry about the extremely lengthy post, and thanks.</p>

<hr>

<p><strong>UPDATE #1:</strong> Aggh... I've just read this <a href="http://msdn.microsoft.com/en-us/library/system.reflection.emit.opcodes.constrained%28v=VS.100%29.aspx" rel="nofollow">in the msdn documentation</a>:</p>

<blockquote>
  <p>[The CreateMethodBody method] is
  currently not fully supported. The
  user cannot supply the location of
  token fix ups and exception handlers.</p>
</blockquote>

<p>I should really read the documentation before trying anything. Some day I'll learn...</p>

<p>This means option #3 can't support try-catch statements, which makes it useless for me. Do I really have to use the horrible #2? :/  Help! :P</p>

<hr>

<p><strong>UPDATE #2:</strong> I've successfully implemented attempt #2 with support for exceptions. It's quite ugly, but it works. I'll post it here when I refine the code a bit. It's not a priority, so it may be a couple of weeks from now. Just letting you know in case someone is interested in this.</p>

<p>Thanks for your suggestions.</p>
 Mono.Cecil type.IsAssignableFrom(derivedType) equivalent <p>I'm using Mono.Cecil to find types in Assembly that are derived from given on. 
Normaly it can be done with IsAssignableFrom() method, but I cannot fing it's equivalent in Cecil. 
Is there any such method or other way to check it?
Thanks
Mike</p>
 Can Mono.Cecil modify code already loaded in the AppDomain? <p>I want to add some behavior to a certain class at runtime. I know how to subclass at runtime using Reflection.Emit but thats not enough, Depending on some external configuration I need to inject opcodes in a method on a type T so all classes that inherit from it automatically gain this behavior.(I cant use the .NET Profiling API) </p>

<p>Can something like this be done with Mono.Cecil?</p>

<p>If it isnt possible to modify code on a loaded assembly, It is fine If I can make the modifications before the assembly is loaded and then load the modified assembly in memory, but I dont know how I can control assembly loading. </p>
 mono.cecil: not able to find AssemblyFactory class <p>I am using mono.cecil dll and writing this code.</p>

<pre><code>AssemblyDefinition sourceAssembly = AssemblyFactory.GetAssembly(assemblyPath);
</code></pre>

<p>here my project is not getting compiled because it is not able to find the class "AssemblyFactory". As if this class is not present in the dll at all. I have added the mono.cecil.dll as reference to my project. Is this class present somewhere outside the dll, maybe in some other dll at .net level?</p>
 Visual Studio Watch window not taking into account usings <p>I have the following code in a view model:</p>

<pre><code>public Point Location
{
    get
    {
        var rangePixels = Range * PixelsPerMile;
        var xCoordinate = OwnLocation.X * MapScale + rangePixels * Math.Cos(Theta);
        var yCoordinate = OwnLocation.Y * MapScale - rangePixels * Math.Sin(Theta);
        return new Point(xCoordinate, yCoordinate);
    }
}
</code></pre>

<p>One of the usings at the top of the code file is <code>System</code>, which contains <code>Math</code>.</p>

<p>If I view <code>Math.Sin(Theta)</code> in the Watch window (by selecting the code, right clicking, and choosing "Add Watch"), I get the following error:</p>

<blockquote>
  <p>The name 'Math' does not exist in the current context  </p>
</blockquote>

<p>What I want to know is:</p>

<ol>
<li>Is this expected/default behavior for Visual Studio 2010? I could swear this never used to be a problem, but maybe it's always worked that way and I somehow never noticed.</li>
<li>If it's not normal to get this error, any thoughts on what the problem could be? There are a million settings in Visual Studio, and I wouldn't know where to begin.</li>
</ol>

<p>I should note this question is vaguely similar to <a href="http://stackoverflow.com/questions/8672620/out-of-context-variables-in-visual-studio-2010-debugger">this</a>, but I'm not having any issues mousing over my local variables, and I'm not using PostSharp.</p>

<p><strong>Edit</strong></p>

<p>I just tried resetting all my Visual Studio settings backs to default, and I'm still getting the same error. If someone wants to try a simple test in Visual Studio, I just want to know if you get an error if you add a watch for <code>Math.Sin(1)</code>.</p>

<p><strong>Edit 2</strong></p>

<p>Here are a couple screen captures to show what I'm experiencing:</p>

<p><img src="http://i.stack.imgur.com/DaDRk.png" alt="Adding Math.Sin(1) to watch"></p>

<p><img src="http://i.stack.imgur.com/ta6yQ.png" alt="Showing error for Watch"></p>

<p><strong>Edit 3</strong></p>

<p>Interestingly, intellisense works if I type <code>Math.</code> into the Watch window, but if I complete the expression, I still get the error:</p>

<p><img src="http://i.stack.imgur.com/7OkDT.png" alt="Showing intellisense working"></p>

<p><strong>Edit 4</strong></p>

<p>To address BACON's questions:</p>

<ol>
<li>I get the same behavior with QuickWatch and Immediate.</li>
<li>Closing and reopening all the windows does not solve the problem.</li>
<li>I'm using Visual Studio 2010 Professional (version 10.0.40219.1 SP1Rel)</li>
<li>I tried targeting .NET 4.0 Client Profile and full .NET 4.0. Made no difference. I created a Console App (rather than a WPF app) targeting .NET 4.0 Client Profile, and finally, the error did not occur. So, WPF may be an issue (or WPF with some third-party libraries). (Will check on that next.)</li>
</ol>
 Emitting function with optional parameter <p>I have the following C# code:</p>

<pre class="lang-cs prettyprint-override"><code>public static double f(double x1, double x2 = 1)
{
    return x1 * x2;
}
</code></pre>

<p>And here it's IL code (ILSpy):</p>

<pre class="lang-cs prettyprint-override"><code>.method public hidebysig static 
    float64 f (
        float64 x1,
        [opt] float64 x2
    ) cil managed 
{
    .param [2] = float64(1)
    // Method begins at RVA 0x20c6
    // Code size 4 (0x4)
    .maxstack 8

    IL_0000: ldarg.0
    IL_0001: ldarg.1
    IL_0002: mul
    IL_0003: ret
} // end of method A::f
</code></pre>

<p>How can I get it with <strong>System.Reflection.Emit</strong> or better with the <strong>Mono.Cecil</strong>?</p>
 Mono.Cecil TypeReference to Type? <p>Is there anyways to go from a TypeReference in Mono.Cecil to a Type?</p>
 Where can I get Mono.Cecil.Pdb.dll? <p>I'm trying to write a IL Weaver with Mono.Cecil, and for it to remain debugable in VS2010, I need the PdbReaderProvider class, or some similar implementation of ISymbolProvider. I've downloaded the latest Mono dlls from <a href="http://mono.ximian.com/daily/" rel="nofollow">http://mono.ximian.com/daily/</a>, but in the zip there is no Mono.Cecil.Pdb.dll. I've downloaded the source code from <a href="https://github.com/jbevain/cecil/tree/master/Mono.Cecil" rel="nofollow">https://github.com/jbevain/cecil/tree/master/Mono.Cecil</a> but I can't seem to be able to get that particular project compile under .net 4.<br>
Could somebody help me out and point to a compiled working .net dll of Mono.Cecil.Pdb, preferably with a working PdbReaderProvider inside? </p>
 Mono.Cecil: Operation could destabilize at runtime <p>I followed the hints <a href="http://johnhmarks.wordpress.com/" rel="nofollow">here</a>, I even put the following lines in:</p>

<pre><code>var MSILWorker = prop.SetMethod.Body.GetILProcessor();
MSILWorker.Body.InitLocals = true;
</code></pre>

<p>I have two properties in two classes:</p>

<pre><code> [NotifyProperty]
 public int Number { get; set; }
</code></pre>

<p>and</p>

<pre><code> [NotifyProperty]
 public string Name { get; set; }
</code></pre>

<p>The generated IL code is perfectly identical, except of course in the name of the properties and the type of the backing field. Yet the first one throws VerificationException (“Operation could destabilize the runtime”), the second one does not.
What could have I possibly done wrong?</p>

<p>edit: here is the offending IL:</p>

<pre><code>.method public hidebysig specialname instance void set_Number(int32 'value') cil managed
{
    .custom instance void [mscorlib]System.Runtime.CompilerServices.CompilerGeneratedAttribute::.ctor()
    .maxstack 3
    L_0000: nop 
    L_0001: ldarg.0 
    L_0002: ldarg.1 
    L_0003: stfld int32 TestApplication.SLTest.SLBOComposite::&lt;Number&gt;k__BackingField
    L_0008: ldarg.0 
    L_0009: ldstr "Number"
    L_000e: call instance void TestApplication.SLTest.SLBOComposite::RaisePropertyChanged(string)
    L_0013: nop 
    L_0014: ldarg.0 
    L_0015: ldstr "Number"
    L_001a: ldarg.1 
    L_001b: call instance void W3B.TestApplication.SLTest.SLBOComposite::Validate(string, object)
    L_0020: nop 
    L_0021: ret 
}
</code></pre>
 Finding type hierarchy assemblies using Mono.Cecil <p>I am trying to implement a method that receives a type and returns all the assemblies that contain its base types.</p>

<p>For example:<br>
Class <em><code>A</code></em> is a base type (class <em><code>A</code></em> belongs to assembly <em>c:\A.dll</em>)<br>
Class <em><code>B</code></em> inherits from <em><code>A</code></em> (class <em><code>B</code></em> belongs to assembly <em>c:\B.dll</em>)<br>
Class <em><code>C</code></em> inherits from <em><code>B</code></em> (class <em><code>C</code></em> belongs to assembly <em>c:\c.dll</em>)  </p>

<pre><code>public IEnumerable&lt;string&gt; GetAssembliesFromInheritance(string assembly, 
                                                        string type)
{
    // If the method recieves type C from assembly c:\C.dll
    // it should return { "c:\A.dll", "c:\B.dll", "c:\C.dll" }
}
</code></pre>

<p>My main problem is that <code>AssemblyDefinition</code> from Mono.Cecil does not contain any property like <em>Location</em>.</p>

<p>How can an assembly location be found given an <em><code>AssemblyDefinition</code></em>?</p>
 Mono.Cecil Module of BaseType is incorrect <p>I am loading two assemblies using AssembliyDefinition.ReadAssembly</p>

<p>In AssemblyA I define ClassA.</p>

<p>In AssemblyB I define ClassB : ClassA.</p>

<p>When  I inspect the TypeDefinition.BaseType of ClassB I get that its Module is AssemblyB.</p>

<p>I wouldbe expected that the its module would be AssemblyA, since the base type of ClassB is ClassA and it is defined in AssemblyA.</p>

<p>This shows up as an error for me because when i try to do classB.BaseType.Resolve() i get an error, which probably happens since it searches for ClassA in the wrong assembly.</p>

<p>Any ideas anyone?</p>

<p>Thanks</p>
 How to create an override method using Mono.Cecil? <p>I'm using Mono.Cecil to generate an assembly that contains a derived class that overrides a specific method in an imported base class. The override method is an 'implicit' override.  The problem is that I cannot figure out how to designate it as an override.</p>

<p>I'm using the following code to create the override method.</p>

<pre><code>    void CreateMethodOverride(TypeDefinition targetType,
        TypeDefinition baseClass, string methodName, MethodInfo methodInfo)
    {
        // locate the matching base class method, which may
        // reside in a different module
        MethodDefinition baseMethod = baseClass
            .Methods.First(method =&gt; method.Name.Equals(methodName));

        MethodDefinition newMethod = targetType.Copy(methodInfo);
        newMethod.Name = baseMethod.Name;
        newMethod.Attributes = baseMethod.Attributes;
        newMethod.ImplAttributes = baseMethod.ImplAttributes;
        newMethod.SemanticsAttributes = baseMethod.SemanticsAttributes;
        targetType.Methods.Add(newMethod);
    }
</code></pre>

<p>It is my understanding that an implicit override must have the same signature as the inherited method.  Using the above code, when I view the resulting method in Reflector, the base class and the derived class methods have the exact same signature, namely "public virtual void f(int param)".</p>

<p>I've tried removing the explicit "virtual" attribute, but then the derived method ends up as "public void f(int param)'.</p>

<p>How do I get the derived method to have the correct "public override void f(int param)" signature?</p>

<p>NOTE: I have an extension method ("TypeDefinition.Copy") that clones a MethodInfo and returns a MethodDefinition by importing all of the referenced types, etc.</p>
 How to get attribute value for an assembly in Cecil <p>Is there a way to get <code>str1</code> in code ?</p>

<pre><code>[MyAttribute("str1")]
class X {}
</code></pre>

<p>The instance of <code>Mono.Cecil.CustomAttribute.Fields</code> is empty.</p>
 How can I use Mono.Cecil to check if .pdb and .dll file match? <p>We're using Mono.Cecil in our project. Does it have any functionality that allows me to check whether a specific PDB and DLL match?</p>

<p>Thanks!</p>
 Mono.Cecil Exception thrown when analyzing .NET 4.5 version of System.Xml DLL, why? <p>I'm using Mono.Cecil 0.9.5.3, and after installing VS2012 RC (which causes the .NET 4.0 System.XML.DLL to be replaced with its .NET 4.5 counterpart), I get an System.ArugmentException in some code that iterates each methods' custom attributes. It appears the cause is that in certain cases, the <code>AsyncStateMachine</code> attribute's ctor argument, which should be a Type, is empty.  </p>

<p>The following piece of code reproduces it:</p>

<pre><code>string path = Assembly.Load("System.Xml, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089").Location;

AssemblyDefinition systemXmlAssembly = AssemblyDefinition.ReadAssembly(path);

var query =

    from ModuleDefinition module in systemXmlAssembly.Modules
    from TypeDefinition td in module.Types
    from MethodDefinition method in td.Methods
    from CustomAttribute att in method.CustomAttributes
    where method.Name == "System.Xml.IDtdParser.ParseInternalDtdAsync" &amp;&amp;
            att.AttributeType.Name == "AsyncStateMachineAttribute"
    select att;

CustomAttribute attribute = query.Single();

var args = attribute.ConstructorArguments; // &lt;---- this line throws an ArgumentException
</code></pre>

<p>The exception is thrown from </p>

<pre><code>Mono.Cecil.ModuleDefinition.CheckFullName(string fullName = "")
</code></pre>

<p>My question is - is this a bug in Mono.Cecil, or the System.Xml.DLL? Does the spec allow for an "empty" Type to appear as the ctor argument?</p>
 Add a try-catch with Mono Cecil  <p>I am using Mono Cecil to inject Code in another Method. I want to add a Try-Catch block around my code.</p>

<p>So i wrote a HelloWorld.exe with a try catch block and decompiled it.</p>

<p>It looks like this in Reflector for the Try-Catch:</p>

<pre><code>.try L_0001 to L_0036 catch [mscorlib]System.Exception handler L_0036 to L_003b
</code></pre>

<p>How can i inject a try catch like this via mono cecil? </p>
 .NET CIL manipulation of evaluation stack <p>I have this sequence of CIL codes which I injected through the use of <code>Mono.Cecil</code>. However, the modified .NET C# application will not run.</p>

<p><strong>Objective: 
Manually load and pop values from stack to display in <code>Console.WriteLine</code></strong></p>

<pre><code> for (int i = 0; i &lt; 3; i++)
        {
            int z = some value popped manually from stack;                 
            Console.WriteLine(z);
        }
</code></pre>

<p><strong>This is the simple main() program I modified:</strong></p>

<pre><code>.method private hidebysig static void Main(string[] args) cil managed
{

    .entrypoint
    .maxstack 5
    .locals init (
        [0] int32 num,
        [1] int32 num2)
    L_0000: ldc.i4.6 //manually push value 6 to stack
    L_0001: ldc.i4.5 //manually push value 5 to stack
    L_0002: ldc.i4.4 //manually push value 4 to stack
    L_0003: ldc.i4.0 //push int i initial value 0 to stack 
    L_0004: stloc.0 //pop and store to int i variable to variable num
    L_0005: br.s L_0013
    L_0007: nop 
    L_0008: stloc.1 //pop the pushed values 6,5 and 4 to variable num2
    L_0009: ldloc.1 //load value of num2 to stack
    L_000a: call void [mscorlib]System.Console::WriteLine(int32) //pop value of num2 and print
    L_000f: ldloc.0 //load previous value in variable num to stack
    L_0010: ldc.i4.1 //load incremental value 1 to stack
    L_0011: add //pop and add the top 2 values, result is pushed to stack
    L_0012: stloc.0 //store the new result to variable num. (int i)
    L_0013: ldloc.0 //push int i variable value to stack
    L_0014: ldc.i4.3 //push value 3 to stack as number of times to loop
    L_0015: blt.s L_0007 //branch less than (pop and cmp the top 2 values in stack)
    L_0017: ret 
}
</code></pre>

<p><strong>However, the above code cannnot run. I tried changing <code>blt.s</code> to <code>clt</code> and <code>br_true.s</code> but it doesn't work either. Does anyone know if it is possible to attain my objective? Thanks.</strong></p>

<p>EDIT:
According to ECMA-335, III.1.7.5, there might be a backward branch constraint. Not sure if this is the case.</p>

<blockquote>
  <p>In particular, if that single-pass analysis arrives at an instruction, call it location X, that
  immediately follows an unconditional branch, and where X is not the target of an earlier branch
  instruction, then the state of the evaluation stack at X, clearly, cannot be derived from existing
  information. In this case, the CLI demands that the evaluation stack at X be empty.</p>
</blockquote>
 Detect whether the assembly was built for .NET Compact Framework <p>Having a .NET assembly, how can I detect whether it was built for .NET CF or a full framework?</p>
 How do I find all the type dependecies of a given type in any CLR based language assembly? <p>I am trying to find all the types that a given type is dependent on, including interfaces, abstract classes, enums, structs, etc. I want to load up an assembly, and print out a list of all the types defined within it, and their dependencies.</p>

<p>So far I have been able to find all the the external types a CLR assembly depends on using Mono.Cecil, e.g.</p>

<pre><code>using System;
using Mono.Cecil;
using System.IO;

FileInfo f = new FileInfo("SomeAssembly.dll");
AssemblyDefinition assemDef = AssemblyFactory.GetAssembly (f.FullName); 
List&lt;TypeReference&gt; trList = new List&lt;TypeReference&gt;();

foreach(TypeReference tr in assemblyDef.MainModule.TypeReferences){
    trList.Add(tr.FullName);
}
</code></pre>

<p>This list can also be obtained using the mono disasembler, eg "monodis SomeAssembly.dll --typeref", but this list doesnt seem to include primitives, eg System.Void, System.Int32, etc</p>

<p>I need to treat each type individually, and get all types that a given type depends on, even if the types are defined in the same assembly.
Is there any way to do this using Mono.Cecil, or any other project?</p>

<p>I know it can be done by loading the assembly, then iterating over each defined type, then loading the IL of the type and scanning it for references, but I am sure that there is a better way. Ideally it will also work with anonymous inner classes.</p>

<p>It should also work if multiple modules are defined in the same assembly.</p>
 How to determine which methods are called in a method? <p>I'd like to list all the methods that are called from a specific method. E.g. if I have the following code:</p>

<pre><code>public void test1() {

   test2();


   test3();
}
</code></pre>

<p>The list should contain test2() and test3(). It would be great if methods of the same class but also methods of another class could be listed.</p>

<p>Additionaly I'd like to find a way to detect which fields are used of a method:</p>

<pre><code>public class A {

   private String test1 = "";
   private String test2 = "";

   public void test() {
      Console.WriteLine(test1);
   }

}
</code></pre>

<p>Should therefore list test1.</p>

<p>I tried this using Mono.Cecil, but unfortunately I couldn't find lot of documentation about the project. So does anybody know how to do that?</p>

<p>Edit: I'd like to do it with Mono.Cecil because over its API I can directly use the results in my application. If I use built in tools in Visual Studio or similar, it's quite difficult to furhter process the results.</p>
 What kind of compiler magic do we need more? <p>I develop lot view models which are:</p>

<p>1) All have to implement INotifyPropertyChanged to be bindable to UI. </p>

<p>2) Property setters have to raise PropertyChanged on change.</p>

<p>3) PropertyChanged event has to provide proper property name.</p>

<p>If you (like me) tied of writing something like this:</p>

<pre><code>
public string Name 
{
  get 
  { 
    return _name; 
  }
  set 
  { 
    if (_name != value) 
    {
      _name = value;
      RaisePropertyChanged("Name");
    }
  }
} 
</code></pre>

<p>Then refactor this method like this and sometimes forget to update property name literal:</p>

<pre><code>
string _fundName;
public string FundName 
{
  get 
  { 
    return _fundName; 
  }
  set 
  { 
    if (_fundName != value) 
    {
      _fundName = value;
      RaisePropertyChanged("Name");
    }
  }
} 
</code></pre>

<p>And then spend a day to debug why your UI is not refreshing and databinding doesn't work properly.</p>

<p>Then all we need is some kind of magic.</p>

<p>What if I just need to write this:</p>

<pre><code>
[Magic] // implicit transformation
public string FundName { get; set; }
</code></pre>

<p>or if I have many properties:</p>

<pre><code>
[Magic]
public class MyViewModel
{
  public string FundName { get; set; }
  public string FundType { get; set; }

  [NoMagic] // suppress transformation
  public int InternalId { get; set; }
}
</code></pre>

<p>So I have just developed a MSBuild task to do this magic after the build (<a href="http://kindofmagic.codeplex.com" rel="nofollow">http://kindofmagic.codeplex.com</a>).</p>

<p>The question is, what kind of magical postprocessing would you like more?</p>

<p>Does automatic implementation of INotifyPropertyChanging makes sense?</p>
 Mono.Cecil, Missing compiler required member 'System.Runtime.CompilerServices.ExtensionAttribute..ctor' <p>I downloaded the latest Mono.Cecil and now whenever I start up my project it gives me that error. It goes away if I remove and add mono.cecil. But that is a pain to do every time I open my project.</p>
 Mono.Cecil something like Type.GetInterfaceMap? <p><strong>System.Reflection.Type</strong> contains <a href="http://msdn.microsoft.com/en-us/library/system.type.getinterfacemap.aspx" rel="nofollow">GetInterfaceMap</a> which help to determine what method implement some method from interface.</p>

<p>Does <strong>Mono.Cecil</strong> contain something like this?
Or how to implement such behaviour?</p>
 cecil: Instruction.Operand types corresponding to Instruction.OpCode.Code value <p>Is there any documentation or is there a part of the cecil source code that I can consult to get a comprehensive view of which <code>Operand</code> types cecil will use for a given <code>Code</code> value? Eg: I can glean from <code>MethodBodyRocks</code> that <code>Ldloc</code> takes an <code>Operand</code> of type <code>VariableDefinition</code>, but I haven't been able to track down this down for some of the other instruction codes.</p>
 What is the most interesting and promising approach to implement a compiler in C#? <p>I am just in the beginning of my graduation project that is supposed to last for 6 months. 
The goal of the project is to implement a .Net-compiler for one scripting language. I had the Compiler Construction as a subject in my curriculum and am aware of the basic steps how to implement a compiler in general, but we used Bison and simple compiler with GCC as back-end and thus I don't know much about implementing compilers on .Net platform.</p>

<p>Having carried out some research on this topic I found the following alternative solutions for code generation (I am not talking about other essential parts of compiler, like a parser -- it is out of scope here):</p>

<ol>
<li>Direct code generation using <a href="http://msdn.microsoft.com/en-us/library/h0x241a0.aspx" rel="nofollow">Reflection.Emit</a>.</li>
<li>Using <a href="http://ccimetadata.codeplex.com/wikipage?title=An%20Introduction%20to%20the%20Common%20Compiler%20Interface" rel="nofollow">Common Compiler Interface</a> abstraction over Reflection.Emit for automation of some code generation. </li>
<li>Using <a href="http://www.15seconds.com/issue/020917.htm" rel="nofollow">CodeDOM</a> for C# and VB compilation at runtime.</li>
<li>There is a new emerging C# "compiler as a service" called <a href="http://social.msdn.microsoft.com/forums/en-us/roslyn" rel="nofollow">Roslyn</a>, available as a CTP now.</li>
<li><a href="http://msdn.microsoft.com/en-us/library/dd233052.aspx" rel="nofollow">DLR</a> offers support for dynamic code generation and has some interfaces for runtime code generation via expression trees etc.</li>
<li>Mono is shipped with <a href="http://mono-framework.com/Cecil" rel="nofollow">Mono.Cecil</a> library that seems to have some functionality for code generation as well.</li>
</ol>

<p>The primary goal of my project is to delve deeper into the guts of .Net, to learn Compiler Construction and to get good grade for my work. The secondary goal is to come up with a compiler implementation that can be later opened to the community under a permissive open-source license. </p>

<p>So, what would be a most interesting, educative, entertaining and promising approach here? I would have definitely tried all of them if I had some more time, but I need to submit my work in 6 months sharp to get a positive grade...</p>

<p>Thank you in advance,
Alexander.</p>
 Adding custom attributes using mono.cecil? <p>I can't figure how to add custom attribute to a method using Mono.Cecil
The attributes that I would want to add is like this :</p>

<pre><code>.custom instance void [mscorlib]System.Diagnostics.DebuggerHiddenAttribute::.ctor() = ( 01 00 00 00 ) 
</code></pre>

<p>Does anyone know how to add custom attributes </p>
 Mono.Cecil fails to process a Silverlight 5 assembly <p>When I am trying to read Silverlight 5 assembly via  Mono.Cecil version 0.9.3.0, I am getting the following exception:</p>

<pre><code>System.NotSupportedException: Version not supported: 5.0.5.0
------   
at Mono.Cecil.BaseAssemblyResolver.GetCorlib(AssemblyNameReference reference) in C:\programming\mono.cecil\jbevain-cecil-5df660e\Mono.Cecil\BaseAssemblyResolver.cs:line 200
------  
at Mono.Cecil.BaseAssemblyResolver.Resolve(AssemblyNameReference name) in C:\programming\mono.cecil\jbevain-cecil-5df660e\Mono.Cecil\BaseAssemblyResolver.cs:line 117
....
</code></pre>

<p>It happens because the reference in SIlverlight project is to mscorlib 5.0.5.0 while the GetCorlib function doesn't seem to be handling these cases.</p>

<p>Is there a solution to this issue?</p>
 How to create a GenericParameter return type for a MethodReference in Mono.Cecil? <p>I'm trying to reproduce the following IL using Mono.Cecil:</p>

<pre><code>call !!0 [mscorlib]System.Threading.Interlocked::CompareExchange&lt;class [System]System.ComponentModel.PropertyChangedEventHandler&gt;(!!0&amp;, !!0, !!0)
</code></pre>

<p>When I use Mono.Cecil to inspect this IL, I see that the operand of the instruction is a GenericInstanceMethod, which holds an ElementMethod of type MethodReference. This MethodReference in turn has a return type of type GenericParameter.</p>

<p>I'd like to create the same objects by hand, but reach a catch-22 it seems. To create a GenericParameter, I need an IGenericParameterOwner, which seems to be the very same MethodReference above. So I'd like to pass the MethodReference to the GenericParameter constructor. However, I can't create the MethodReference without a TypeReference for the return type either, which I assume should be the GenericParameter.</p>

<p>How do I resolve this? What I am misunderstanding?</p>
 Creating an IL instruction with an inline argument using Mono.Cecil <p>I'm playing with mutation testing at the moment. One of the mutations I'm looking at involves swapping parameters, for which I may need to swap, for example <code>Ldarg.0</code> and <code>Ldarg_S</code> with an operand indicating the index.</p>

<p>The operand type for this is an inline arg, which in Mono.Cecil I believe requires me to create a properly instantiated <code>ParameterDefinition</code> to store the 32-bit int index. Does anyone have enough experience with Cecil to point me in the right direction of an easy way to create an <code>Instruction</code> instance with <code>OpCode</code> of <code>Ldarg_S</code> and an <code>Operand</code> of the appropriate type?</p>
 How to run method from byte array (in memory)? <p>I have a dynamic method and I have the byte[] from the real method (using Cecil).
Now how to assign this byte array to the dynamic method and execute it? I'm sure it's not only one way thing, there must be a way to invoke byte arrays.</p>
 How to make a dynamic method which uses static variables from the same assembly? <p>I created a dynamic method, but when I try to access outside resources, it gives me an exception </p>

<blockquote>
  <p>TargetInvocationException: Exception has been thrown by the target of
  an invocation.</p>
</blockquote>

<p>Basically I want to write a method to byte array, then load it as a dynamic method. I know a simple byte array isn't enough to reconstruct the metadata links, but how make a dynamic method which uses a variable from the same assembly?</p>

<p>I tried to convert that code:</p>

<pre><code>public static int z = 10;
public static int sum(int x, int y) {
    return x + y + z;
}
</code></pre>

<p>Which gives me the IL:</p>

<pre><code>0        L_0000:      ldarg.0      
1        L_0001:      ldarg.1      
2        L_0002:      add          
3        L_0003:      ldsfld       System.Int32 CodeGen.Program::z
4        L_0008:      add          
5        L_0009:      ret  
</code></pre>

<p>Which is the bytes:</p>

<pre><code>02 03 58 7E 06 00 00 04 58 2A
</code></pre>

<p>The I tested it like that:</p>

<pre><code>public static int z = 10;

static void Main(string[] args) {

    DynamicMethod sum = new DynamicMethod("sum", typeof(int), new Type[] { typeof(int), typeof(int) });
    var info = sum.GetDynamicILInfo();
    var bytes = new byte[] { 0x02, 0x03, 0x58, 0x7E, 0x06, 0x00, 0x00, 0x04, 0x58, 0x2A }; // { 0x02, 0x17, 0x58, 0x2A }; // this is a code for int sum(int x, int y) { return x + y; }

    info.SetCode(bytes, 8);

    var sig = SignatureHelper.GetMethodSigHelper(CallingConventions.Standard, typeof(int));
    byte[] bsig = sig.GetSignature();
    bsig[0] = 0x7;

    info.SetLocalSignature(bsig);

    int x = (int) sum.Invoke(null, new object[] { 10, 20 });
    Console.WriteLine(x.ToString());
    Console.ReadLine();
}
</code></pre>

<p>TL;DR I want to fix the references of a byte array which represents a dynamic method's IL. How to do that? Also, I don't want to use the ILGenerator(), I want a byte array.</p>
 Mono.Cecil - How to get custom attributes <p>I am trying to use Cecil to inspect the attributes associated with a given method. It seems to find it, but I cannot get its name using the following code:</p>

<pre><code>AssemblyDefinition assembly = AssemblyFactory.GetAssembly(pathBin);
assembly.MainModule.Types[0].Methods[1].CustomAttributes[0].ToString()
</code></pre>

<p>I know this must be the attribute I've set my function to, because when I remove it from the dll, the second line of code will turn out to null. What I'd like to do is be able to get the attribute's name. Currently the second line of code will return just a "Mono.Cecil.CustomAttribute". I'd guess there should be a way of getting an attribute's name(class type) name, right?</p>

<p>Thanks!</p>
 Preprocessing C# - Detecting Methods <p>I require the ability to preprocess a number of C# files as a prebuild step for a project, detect the start of methods, and insert generated code at the start of the method, before any existing code.  I am, however, having a problem detecting the opening of a method.  I initially tried a regular expression to match, but ended up with far too many false positives.  </p>

<p>I would use reflection, but the MethodInfo class does not reference the point in the original source.</p>

<p><strong>EDIT</strong>: What I am really trying to do here is to support pre-conditions on methods, that pre-condition code being determined by attributes on the method. My initial thought being that I could look for the beginning of the method, and then insert generated code for handling the pre-conditions.</p>

<p>Is there a better way to do this? I am open to creating a Visual Studio Addin if need be.</p>

<p>This is a .NET 2.0 project.</p>

<p>Cheers</p>
 Detect Silverlight version required by an assembly <p>How can I tell whether Silverlight 2 is sufficient for an assembly or Silverlight 3 is required?<br>
I have all information that is available through reflection (Mono.Cecil).</p>

<p>Same question for SL 3 versus 4.</p>

<p>Thanks in advance.</p>
 DynamicMethod in Cecil <p>Is there anything similar to Reflection.Emit.DynamicMethod in Cecil? Thanks.</p>

<ol>
<li><strong>DynamicMethod</strong></li>
</ol>

<p><strong>Edit:</strong>   </p>

<p>What about for the following things? </p>

<ol>
<li><strong>EmitCall</strong>  (e.g.<br>
IL.EmitCall(OpCodes.Callvirt, GetBuildKey, null);
IL.Emit(OpCodes.Unbox_Any, dependencyType);
)</li>
<li><strong>LocalBuilder</strong>   (e.g. LocalBuilder resolving = ilContext.IL.DeclareLocal(typeof(bool));)</li>
<li>System.Reflection.Emit.Label   (e.g. Label existingObjectNotNull = buildContext.IL.DefineLabel();)    //Do I have to use TextMap? </li>
<li><strong>ILGenerator.BeginCatchBlock</strong> (e.g.  ilContext.IL.BeginCatchBlock(typeof(Exception)); )</li>
<li><strong>ILGenerator.MarkLabel</strong>  (e.g. ilContext.IL.MarkLabel(parameterResolveFailed); )</li>
<li><strong>ILGenerator.EndExceptionBlock()</strong>  (e.g. ilContext.IL.EndExceptionBlock(); )</li>
</ol>
 How to inject call to System.Object.Equals with Mono.Cecil? <p>Using Mono.Cecil I want to rewrite the following property:</p>

<pre><code>public string FirstName
{
    get { return _FirstName; }
    set
    {
        _FirstName = value;
    }
}
</code></pre>

<p>to this:</p>

<pre><code>public string FirstName
{
    get { return _FirstName; }
    set
    {
        if (System.Object.Equals(_FirstName, value))
        {
            return;
        }
        _FirstName = value;
    }
}
</code></pre>

<p>This is just a snippet of what the rewrite will be but it is where I'm having a problem.</p>

<p>Using Reflector I can see the following code rewrites the property as required except the call to System.Object.Equals(). If expect the IL code to be:</p>

<pre><code>call bool [mscorlib]System.Object::Equals(object, object)
</code></pre>

<p>but it is being written as:</p>

<pre><code>call instance void RewriteSharp.Person::.ctor()
</code></pre>

<p>The code to write the call to System.Object.Equals is:</p>

<pre><code>setMethodWriter.InsertBefore(
    firstExistingInstruction, 
    setMethodWriter.Create(OpCodes.Call, objectEqualsMethodReference));
</code></pre>

<p>The method used to init objectEqualsMethodReference is:</p>

<pre><code>private static MethodReference GetSystemObjectEqualsMethodReference(
    AssemblyDefinition assembly
)
{

    var typeReference = assembly.MainModule.GetTypeReferences()
        .Single(t =&gt; t.FullName == "System.Object");

    var typeDefinition = typeReference.Resolve();

    var methodDefinition = typeDefinition.Methods.Single(
                            m =&gt; m.Name == "Equals"
                                &amp;&amp; m.Parameters.Count == 2
                                &amp;&amp; m.Parameters[0].ParameterType.Name == "Object"
                                &amp;&amp; m.Parameters[1].ParameterType.Name == "Object"
    );

    return methodDefinition;
}
</code></pre>

<p>It seems to me setMethodWriter.Create() or GetSystemObjectEqualsMethodReference() is incorrect and no amount of debugging has solved the problem.</p>

<p>The property being written and code to rewrite the property have the same framework target. 3.5 and 4.0 both fail.</p>

<p>I'm using the master branch <a href="https://github.com/jbevain/cecil" rel="nofollow">https://github.com/jbevain/cecil</a> to build Mono.Cecil.</p>

<p><strong>Complete Code Listing</strong></p>

<pre><code>using Mono.Cecil;
using Mono.Cecil.Cil;
using System;
using System.Linq;

namespace RewriteNotifyPropertyChanged
{
class Program
{
static void Main(string[] args)
{
    var rewrite = "..\\RewriteSharp.dll";
    var rewritten  = "..\\RewritenSharp.dll";

    var typeName = "Person";
    var propertyName = "FirstName";

    var assembly = AssemblyDefinition.ReadAssembly(rewrite);
    var typeDefinition = assembly.MainModule.Types.Single(t =&gt; t.Name == typeName);
    var propertyDefintion = typeDefinition.Properties
        .Single(p =&gt; p.Name == propertyName);

    var setMethodWriter = propertyDefintion.SetMethod.Body.GetILProcessor();
    var backingFieldReference = GetBackingFieldReference(typeDefinition, propertyName);
    var objectEqualsMethodReference = GetSystemObjectEqualsMethodReference(assembly);
    var firstExistingInstruction = setMethodWriter.Body.Instructions[0];

    setMethodWriter.InsertBefore(
        firstExistingInstruction, 
        setMethodWriter.Create(OpCodes.Ldarg_0));

    setMethodWriter.InsertBefore(
        firstExistingInstruction, 
        setMethodWriter.Create(OpCodes.Ldfld, backingFieldReference));

    setMethodWriter.InsertBefore(
        firstExistingInstruction, 
        setMethodWriter.Create(OpCodes.Ldarg_1));

    setMethodWriter.InsertBefore(
        firstExistingInstruction, 
        setMethodWriter.Create(OpCodes.Call, objectEqualsMethodReference));

    setMethodWriter.InsertBefore(
        firstExistingInstruction, 
        setMethodWriter.Create(OpCodes.Brfalse_S, firstExistingInstruction));

    setMethodWriter.InsertBefore(
        firstExistingInstruction, 
        setMethodWriter.Create(OpCodes.Ret));

    assembly.Write(rewritten, new WriterParameters { WriteSymbols = true });

    Console.WriteLine("Done.");
    Console.ReadKey();
}

private static MethodReference GetSystemObjectEqualsMethodReference(
    AssemblyDefinition assembly
)
{

    var typeReference = assembly.MainModule.GetTypeReferences()
        .Single(t =&gt; t.FullName == "System.Object");

    var typeDefinition = typeReference.Resolve();

    var methodDefinition = typeDefinition.Methods.Single(
                            m =&gt; m.Name == "Equals"
                                &amp;&amp; m.Parameters.Count == 2
                                &amp;&amp; m.Parameters[0].ParameterType.Name == "Object"
                                &amp;&amp; m.Parameters[1].ParameterType.Name == "Object"
    );

    return methodDefinition;
}

private static FieldReference GetBackingFieldReference(
    TypeDefinition typeDefinition, 
    string propertyName
)
{
    var fieldName = "_" + propertyName;
    var fieldReference = typeDefinition.Fields.Single(f =&gt; f.Name == fieldName);

    return fieldReference;
}
}
}
</code></pre>
 Injecting GeneratedCodeAttribute with Mono.Cecil <p>I'm manupulating my .net 2.0 assemblies with Mono.Cecil.
After manipulation I want to mark assembly as processed by injecting a module attribute</p>

<pre><code>var stringType = _module.Import(typeof(string));
var baseCtor = _module.Import(typeof(GeneratedCodeAttribute).GetConstructor(new[] { typeof(string), typeof(string) }));
var result = new CustomAttribute(baseCtor);
result.ConstructorArguments.Add(new CustomAttributeArgument(stringType, "ProcessedBySomething"));
result.ConstructorArguments.Add(new CustomAttributeArgument(stringType, "1.0"));
</code></pre>

<p>After saving the assembly it become dependent on .net 4.0, since manipulating app is written in .net 4.0.
GeneratedCodeAttribute exists in .net 2.0, so what am I doing wrong?</p>
 Mono.Cecil: call GENERIC base class' method from other assembly <p>I'm following up on my earlier question: <a href="http://stackoverflow.com/questions/4899710/mono-cecil-call-base-class-method-from-other-assembly">Mono.Cecil: call base class' method from other assembly</a>.<br>
I'm doing the same thing, but if my base class is generic it doesn't work.  </p>

<pre><code>//in Assembly A
class BaseVM&lt;T&gt; {}

//in Assembly B
class MyVM : Base&lt;SomeModel&gt; {
 [NotifyProperty]
 public string Something {get;set;}
}
</code></pre>

<p>It weaves the following code:</p>

<pre><code>L_000e: call instance void [AssemblyA]Base`1::RaisePropertyChanged(string)
</code></pre>

<p>instead of    </p>

<pre><code>L_000e: call instance void [AssemblyA]Base`1&lt;class SomeModel&gt;::RaisePropertyChanged(string)
</code></pre>

<p>What is there to change?</p>
 NRefactory has missing dlls <p>Heys all, I've tried to use NRefactory(Vb) <a href="https://github.com/icsharpcode/NRefactory/" rel="nofollow">https://github.com/icsharpcode/NRefactory/</a> but it didn't come with mono.cecil.dll so i downloaded that too, but when i merged it together the versions seem 
to be off (i had error Mono.Collections missing class)</p>

<p>does anyone seem to be able to get NRefactory working?</p>

<p>Edit:
btw i've changed to Mono.Cecil 0.9.4. However when i try to build ICSharpCode.NRefactory i had some errors:</p>

<blockquote>
<pre><code>Error 6   'Mono.Cecil.PInvokeInfo' does not contain a definition for
</code></pre>
  
  <p>'IsBestFitDisabled' and no extension
  method 'IsBestFitDisabled' accepting a
  first argument of type
  'Mono.Cecil.PInvokeInfo' could be
  found (are you missing a using
  directive or an assembly
  reference?)   C:\Users\Joseph\Desktop\Test\NRefactory\ICSharpCode.NRefactory\TypeSystem\CecilLoader.cs    376 14  ICSharpCode.NRefactory
      post)</p>
</blockquote>
 Get generic parameters from a ByReferenceType with Mono.Cecil <p>I have a method which gets a parameter such as:</p>

<pre><code>public void Foo(ref Action&lt;string&gt; bar);
</code></pre>

<p>Using Cecil to enumerate the parameters yields a ByReferenceType. Calling GetElementType() in an attempt to dereference the parameter returns a TypeReference with fullname:</p>

<pre><code>System.Action`1
</code></pre>

<p>Somehow it has lost the generic parameters, and is no longer a GenericInstanceType. </p>

<p>How can I properly dereference the byref parameter, and get to the actual generic instance type?</p>
 KindOfMagic (INotifyPropertyChange Attributes) not working with Silverlight 5 beta? <p><a href="http://kindofmagic.codeplex.com/" rel="nofollow">http://kindofmagic.codeplex.com/</a> is a cool project to implement the INotifyPropertyChanged Interface using just Attributes instead of writing verbose property-setters.
As far as I understand it is a MS build task that manipulates the IL using Mono.Cecil.</p>

<p>However - it seems that it is not working with Silverlight 5 beta projects. 
At least not on my machine. Can anybody confirm this?</p>

<p>And does anybody know the reason, why it works with Silverlight 4 but breaks with Version 5? Mono.Cecil?</p>

<p>(Unfortunately I didn't get an answer on the Codeplex project site.)</p>

<p>cheers,
Thomas</p>
 How can I create a new Windows Phone 7 assembly from scratch using CCI or Mono.Cecil <p>I am working on a tool to generate assemblies for WP7. I am doing this from the full framework. Since Reflection.Emit doesn't work with WP7 but either CCI or Mono.Cecil do I am wondering if there is a way to create new assemblies from scratch. I already know that I can modify existing assemblies, but being able to create one would be pretty useful.
I guess a workaround would be to generate an empty assembly in visual studio and keep it as a template, but I think that there should be a better way.</p>
 Using Mono.Cecil to add an Indexer to a TypeDefinition <p>I'm using JB Evain's Mono.Cecil to perform some byte-code manipulation on compiled DLL's. Part of this project is to inject properties into TypeDefinitions, effectively turning compiled getters/setters into the C# Properties pattern using PropertyDefinitions. This part is working well.</p>

<p>However, I would like to add an indexer to the TypeDefinition but I cannot find any documentation or advice on how best to achieve this. The methods which will be used to process the index requests are already in place:</p>

<pre><code>Object getObjectViaIndexer(String str);
void setObjectViaIndexer(String str, object obj);
</code></pre>

<p>All i need to do is add the metadata to convert these into indexers....</p>

<p>Any ideas / thoughts would be greatly apprecaited!</p>
 Does Mono.Cecil take care of branches etc location? <p>Well this question may seem odd but its simple - my point is if i have a "goto" (brtrue etc) in the decompiled code like example</p>

<pre><code>br IL_0003
call *****
IL_0003: ret
</code></pre>

<p>and i add a command after that <em>*</em>* call will the br at the top point to ret like it should or to that code.</p>

<p>does Cecil do it by itself or i have to take care of all those branches ? :/
it wouldnt be very hard to fix them but if Cecil doesnt then i simply wont start this project, ive no time (or knowledge) for advanced IL magic :P</p>

<p>PS. sorry if im confusing things but im a begginer in .NET stuff ;/ i was allways repulsed by it same as Java or anything that has a VM TBH.</p>

<p>*(yes i know it wont be IL_0003 its just for example)*</p>
 How to get source/line number for IL instruction using Mono.Cecil <p>I'm using Mono.Cecil to write a simple utility that looks for type/method usage within .NET assemblies (ex. calling ToString on enums).</p>

<p>I am able to get find the method, but it would be cool to display the source/line information to the user. Is this possible with Mono.Cecil?</p>
 Can Mono.Cecil rewrite debugging symbols as VB.NET? <p>After rewriting a VB.NET assembly with Mono.Cecil the 'Call Stack' debugging window in Visual Studio 2010 shows the language as C# and not VB.NET. Is it possible configure Mono.Cecil to rewrite an assembly so the debugger recognises the rewritten assembly as VB.NET?</p>

<p>The following Mono.Cecil simply reads and saves an assembly without modification. However, the debugger reads the new assembly as C# instead of VB.NET.</p>

<pre><code>Dim readerParameters = New ReaderParameters() With {.ReadSymbols = True}
Dim writerParameters = New WriterParameters() With {.WriteSymbols = True}

Dim appToRewrite = AssemblyDefinition.ReadAssembly(
    appToRewriteExe, 
    readerParameters
)

appToRewrite.Write(appToRewriteExe, writerParameters)
</code></pre>

<p>It is desirable for the rewritten assembly to be VB.NET so the debugging windows 'Local' and 'Immediate Window' are the VB.NET versions rather than the C# versions.</p>
 
aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects aspects Is AspectF (a Fluent Aspect Framework) an AOP-like design that can be used without much concern? <p><a href="http://msmvps.com/blogs/omar/Default.aspx" rel="nofollow">Omar Al Zabir</a> is looking for "a simpler way to do AOP style coding".</p>

<p>He created a framework called <a href="http://code.google.com/p/aspectf/" rel="nofollow">AspectF</a>, which is "a fluent and simple way to add Aspects to your code".</p>

<p><strong>It is not true AOP</strong>, because it doesn't do any compile time or runtime weaving, but does it accomplish the same goals as AOP?</p>

<p>Here's an example of AspectF usage:</p>

<pre><code>    public void InsertCustomerTheEasyWay(string firstName, string lastName, int age,
        Dictionary&lt;string, string&gt; attributes)
    {
        AspectF.Define
            .Log(Logger.Writer, "Inserting customer the easy way")
            .HowLong(Logger.Writer, "Starting customer insert", "Inserted customer in {1} seconds")
            .Retry()
            .Do(() =&gt;
                {
                    CustomerData data = new CustomerData();
                    data.Insert(firstName, lastName, age, attributes);
                });
    }
</code></pre>

<p>Here are some posts by the author that further clarify the aim of AspectF:</p>

<ul>
<li><a href="http://msmvps.com/blogs/omar/archive/2009/09/19/aspectf-fluent-way-to-put-aspects-into-your-code-for-separation-of-concern.aspx" rel="nofollow">AspectF fluent way to put Aspects into your code for separation of concern</a> (Blog)</li>
<li><a href="http://code.google.com/p/aspectf/" rel="nofollow">AspectF</a> (google code)</li>
<li><a href="http://www.codeproject.com/KB/tips/aspectf.aspx" rel="nofollow">AspectF Fluent Way to Add Aspects for Cleaner Maintainable Code</a> (CodeProject)</li>
</ul>

<p>According to the author, I gather that AspectF is <strong>not designed so much as an AOP replacement</strong>, but a way to achieve "separation of concern and keep code nice and clean".</p>

<p>Some thoughts/questions:</p>

<ul>
<li>Any thoughts on using this style of coding as project grows?        </li>
<li>Is it a scalable architecture?</li>
<li><strike>performance concerns?</strike></li>
<li>How does maintainability compare against a true AOP solution?</li>
</ul>
 How do you globally modify page output sent from IIS without modifying the page source? <p>A couple sites of mine recently got "hacked". Someone was able to add a line of JavaScript to the bottom of every page on the site. </p>

<p>The server is a Windows Server 2003, and has Cold Fusion 8 and MySQL 5.x installed and running.</p>

<p>Looking into the code on each page shows that none of the pages were modified. The JavaScript is not in the code files themselves. This leads me to believe it is an IIS problem, but I am unsure and cannot find anything that would be able to do this within IIS. </p>

<p>The JavaScript being added redirects a user to another page only when they come from Google, or at least it appears to work this way.</p>

<p>Any help on how someone was able to accomplish this as well as removing it would be greatly appreciated. </p>

<p>Another way to word the question thanks to @Jeffrey Hantin</p>

<p><strong>How do you systematically modify output from IIS without modifying individual pages?</strong></p>

<p><hr></p>

<p><strong>EDIT</strong>: A bit more testing has shown that only the .cfm pages add the extra javascript. Added a new .cfm and the js was there but a .html did not have it. </p>

<p><hr></p>

<p>Edit2: Turns out to have been a coldfusion problem after all. Somehow the pages OnRequestEnd.cfm were created on the sites and added that js.</p>
 Any PostSharp alternative? <p>I have to abandon using PostSharp, because it won't work with obfuscated/merged assemblies. At least, I don't see any way to get it working (it crashes on app start, when assemblies are obfuscated)<br>
I need to intercept some methods in my app (call special code instead of original methods - OnMethodInvocationAspect)<br>
Any advice?</p>
 PostSharp on assemblies I don't have source for <p>In the examples on their website, PostSharp has a demo of intercepting calls in main system assemblies.  I have tried a few times to setup and replicate said intercept calls on assemblies I don't have the source code for with no success.</p>

<p>My approach was to simply place the assembly level attribute targeting the namespace and method I wanted to instrument.  This has never worked for me.</p>

<p>something like:    </p>

<p>[assembly: Trace("MyCategory", AttributeTargetTypes = "My.BusinessLayer.*")]</p>

<p>Am I missing something here? Can I not do a runtime injection of my instrumentation aspect on a assembly if I don't have the source pulled in for it?  I thought I could do runtime injections...</p>

<p>Thanks.</p>
 Scala and Aspects <p>Scala and Aspects can be used together? Are there benefits in this case?</p>

<p>Thanks</p>
 Use Spring @Transactional in Scala <p>We have a mixed Java and Scala project, which uses Spring transaction management. We are using the Spring aspects to weave the files with @Transactional annotated methods.</p>

<p>The problem is, that the Scala classes aren't woven with the Spring transaction aspects. How can I configure Spring to regard the transaction in Scala?</p>
 Replace Property Getter/Setter with Reflection or similar (no 3rd party libraries) in c# <p>I've got a property contained in a class for example</p>

<pre><code>public class Greeter {
   private Hashtable _data;
   public string HelloPhrase { get; set; }

   public Greeter(data) {
      _data = data;
   }
}
</code></pre>

<p>What I would like to do is add an Attribute to the HelloPhrase property, like this</p>

<pre><code>[MyCustomAttribute("Hello_Phrase")]
public string SayHello { get; set; }
</code></pre>

<p>Such that during the constructor I can reflect over the Properties in the Class(Greeter) where MyCustomAttribute has been defined and set the Get/Set methods of the property to an anonymous method / delegate.  </p>

<pre><code>  public Greeter(data) {
      _data = data;
      ConfigureProperties();
   }
</code></pre>

<p>I've managed to get the PropertyInfo's from the class but this only exposes GetSetMethod (http://msdn.microsoft.com/en-us/library/system.reflection.propertyinfo.getsetmethod.aspx) and the corresponding GetGetMethod.</p>

<p>I've read through some of the questions here and online but can't find an answer that doesn't use an Aspects library of some sort.</p>

<p>Could anyone provider pointers to setting the Get/Set methods at runtime? Ideally to a delegate like </p>

<pre><code>x =&gt;_data[keyDefinedByAttribute]; 
</code></pre>
 C# AOP Method Interception on child method calls? <p>My AOP (C#) implementation always intercepts the first (public) method call but not subsequent methods called within the first intercepted method, is this a limitation with ContextBoundObject AOP implementations or am I doing it wrong?</p>

<pre><code>[InterceptMe]
public void MethodOne()
{
    MethodTwo();
}

[InterceptMe]
public void MethodTwo() 
{ 
   //not intecepted from MethodOne Call 
}
</code></pre>

<p>Any Ideas?</p>
 How to separate logging logic from business logic in a C program? And in a C++ one? <p>I am currently coding in C and I have lots of printfs so that I can track, at some times, the flow of my application. The problem is that some times I want more detail than others, so I usually spend my time commenting/uncommenting my C code, so I can get the appropriate output.</p>

<p>When using Java or C#, I can generally separate both my implementation code from the logging logic by using Aspects.</p>

<p>Is there any similar technique you use in C to get around this problem?</p>

<p>I know I could put a flag called DEBUG that could be either on or off, so I wouldn't have to go all around and comment/uncomment my whole code every time I want to either show or hide the printfs. The question is I'd like to also get rid of the logging logic in my code.</p>

<p>If instead of C I was coding in C++, would it be any better?</p>

<h2>Edit</h2>

<p>It seems there is an AspectC++, so for C++ there seems to be a solution. What about C?</p>

<p>Thanks</p>
 Which are the most suitable languages to apply Aspect's Theme approach? <p>I am thinking about reading <a href="http://rads.stackoverflow.com/amzn/click/0321246748" rel="nofollow">Aspect-Oriented Analysis and Design: The Theme Approach</a>, yet I am hesitant. Is it possible to use what's taught in the book with AspectJ (for Java) or Post# in C#? Maybe with Aquarium in Ruby?</p>

<p>What would be the perfect language to suit the design process that's made with the book? I am more interested in the symmetrical approach to aspects.</p>

<p>Thanks</p>
 Spring 3 Compile Time Weaving Problems for Objects in jar dependency with @Configurable (using Maven) <p>Been googling and working on this for way too long now. Been over various stackoverflow posts as well, but still stumped on what's going on here.</p>

<p>First off, what I want:</p>

<p>I have a persistence jar that is used as dependency in my web project. Within this persistence jar, daos are set up just fine using the spring config from the web project. <strong>What I want to do now, though, is in a base class (abstract) I want to be able to inject a property set on a String yet the classes that extends this abstract class aren't directly controlled via Spring (eg instantiated via new MyImp().)</strong></p>

<p>From everything I gather, I'll need to leverage using <strong>@Configurable</strong>. </p>

<p>The odd thing is, the code all compiles (with Maven using aspects plugin) and I do think some weaving must be taking place because calls to the objects extending the @Configurable abstract class seem to fall into a "black hole" - no errors yet nothing even can be printed to the system via old skool System.out.print statements??? Really odd. </p>

<p>Below I think is the relevant information of how I have things set up...(obviously not showing everything):</p>

<p>Web project spring config:</p>

<pre><code>&lt;util:properties id="props" location="classpath:application.properties"/&gt;

&lt;context:annotation-config /&gt;
&lt;context:spring-configured/&gt;
&lt;context:component-scan base-package="com.foo" /&gt;

&lt;bean class="com.foo.MyAbstractClass" abstract="true" scope="prototype"&gt;
    &lt;property name="xlsDir" value="${xlsDir}"/&gt;
&lt;/bean&gt; 

//some DAOs are injected with datasources..not shown. Props being set just fine for the 
//datasources from application.properties, and the DAOs will work fine
</code></pre>

<p>The jar used by the above web project (that holds MyAbstractClass and its descendants) does not have any XML. Various files extends MyAbstractClass and are created within the application via new:
MyImp imp = new MyImp();
imp.bar();</p>

<p>MyAbstractClass relevant info:</p>

<pre><code>@Configurable
public abstract class MyAbstractClass {
    private String xlsDir;

    public void setXlsDir(String xlsDir) {
        this.xlsDir = xlsDir;
     }  

    public void bar() {
        System.out.println("this won't even get printed, yet no errors!");
        System.out.println("xlsDir is "+xlsDir);
     }
 }
</code></pre>

<p>I can play around with @Autowiring later and using @Value (which is what I first tried anyway), but right now I'm not even sure weaving is working correctly. Is the issue maybe that the persistence jar is compiled up first via maven (with weaving) - yet it doesn't know what the setter for xlsDir is until later on based on the web project ? That wouldn't explain though why calls to bar() just disappear though - so something's going on.</p>

<p>For both projects I've set up maven to compile based on what I saw Spring Roo's pom doing (It's extremely difficult nailing down online what really needs to be in this pom for maven aspect weaving with spring .)</p>

<p>Here is relevant pom info (left spring roo's comments in below - they aren't mine):</p>

<pre><code>&lt;plugin&gt;
    &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
    &lt;artifactId&gt;aspectj-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;1.2&lt;/version&gt; &lt;!-- NB: do use 1.3 or 1.3.x due to MASPECTJ-90 - wait for 1.4 --&gt;
    &lt;dependencies&gt;
        &lt;!-- NB: You must use Maven 2.0.9 or above or these are ignored (see 
            MNG-2972) --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
            &lt;artifactId&gt;aspectjrt&lt;/artifactId&gt;
            &lt;version&gt;${aspectj.version}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
            &lt;artifactId&gt;aspectjtools&lt;/artifactId&gt;
            &lt;version&gt;${aspectj.version}&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;goals&gt;
                &lt;goal&gt;compile&lt;/goal&gt;
                &lt;goal&gt;test-compile&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
    &lt;configuration&gt;
        &lt;outxml&gt;true&lt;/outxml&gt;
        &lt;aspectLibraries&gt;
            &lt;aspectLibrary&gt;
                &lt;groupId&gt;org.springframework&lt;/groupId&gt;
                &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;
            &lt;/aspectLibrary&gt;
        &lt;/aspectLibraries&gt;
        &lt;source&gt;1.6&lt;/source&gt;
        &lt;target&gt;1.6&lt;/target&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
    &lt;artifactId&gt;aspectjrt&lt;/artifactId&gt;
    &lt;version&gt;${aspectj.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
    &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;
    &lt;version&gt;${aspectj.version}&lt;/version&gt;
&lt;/dependency&gt; 
 &lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;
    &lt;version&gt;${spring.version}&lt;/version&gt;
&lt;/dependency&gt; 
 &lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-aop&lt;/artifactId&gt;
    &lt;version&gt;${spring.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>Any help much appreciated. I'm about to give up soon and just load my properties file in a static block and be done with it:) </p>
 Interceptors vs aspect in spring? <p>am trying to use interceptors in spring, i want to implement an interceptor on some methods, to handle specific logic when these methods called, i want also to be apart from using web framework, as am tending to use spring as back end, without any headers,</p>

<p>after searching i think spring approach is called Aspects, could you please mention best practice to do this,</p>

<p>Regards,</p>
 Aspect Oriented Programming in Ruby <p>What frameworks exist to add AOP to Ruby?  </p>
 PostSharp & Critical Code Parts <p>Supposing a critical part of an application's business rules are dependent on a given behavior, but that coding this behavior explicitly will clutter your code, would you rely on encapsulating it in an aspect with PostSharp (or with any other aspect framework for that matter)? Is that a "safe" and "wise" option, or is it always better to explicitly code the behavior no matter how it will clutter the code? What about the maintainability of such a solution?</p>
 Best way for logging exceptions in Spring.NET with Log4net or nlog <p>I would like to know which way of log exception in <a href="http://www.springframework.net/" rel="nofollow">Spring.NET</a> is prefered and why.
I found two common scenarios.</p>

<p><strong>1.Use IThrowAdvice.</strong></p>

<p>I created throws advice and in method AfterThrowing handle / log exception.</p>

<pre><code>namespace Aspects
{
    public class ExLogThrowsAdvice : IThrowsAdvice
    {
        private ILog _logger;

        public ExLogThrowsAdvice()
        {
            _logger = LogManager.GetLogger("Error_file");
        }

        public void AfterThrowing(MethodInfo methodInfo,
            Object []args, Object target, Exception exception)
        {
            _logger.Error(exception);
        }
    }
}
</code></pre>

<p>and use Common.Loggin API (<a href="http://netcommon.sourceforge.net/docs/2.0.0/reference/html/ch01.html#d4e45" rel="nofollow">Common Loggin API</a>) for configuring for example <a href="http://logging.apache.org/log4net/" rel="nofollow">Log4net</a> for logging.</p>

<pre><code>&lt;sectionGroup name="common"&gt;
    &lt;section name="logging" type="Common.Logging.ConfigurationSectionHandler, Common.Logging"/&gt;
&lt;/sectionGroup&gt;

&lt;section name="log4net" type="log4net.Config.Log4NetConfigurationSectionHandler, log4net"/&gt;
&lt;log4net&gt;
    &lt;appender name="ErrorFileAppender"
              type="log4net.Appender.FileAppender"&gt;
        &lt;file value="errors.txt"/&gt;
        &lt;filter type="log4net.Filter.LevelRangeFilter"&gt;
          &lt;levelMin value="ERROR" /&gt;
          &lt;levelMax value="FATAL" /&gt;
        &lt;/filter&gt;
        &lt;layout type="log4net.Layout.PatternLayout"&gt;
          &lt;conversionPattern value="%date%newline%username%newline[%thread] %message %newline"/&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;

    &lt;root&gt;
      &lt;level value="ERROR"/&gt;
      &lt;appender-ref ref="ErrorFileAppender"/&gt;
    &lt;/root&gt;
&lt;/log4net&gt;
</code></pre>

<p>And last, create a proxy for the object in the businees layer.</p>

<pre><code>  &lt;!--ex log advice--&gt;
  &lt;object id="theExLogAdvice" type="Aspects.ExLogThrowsAdvice, ExceptionLogging"/&gt;

  &lt;!--auto proxy creator--&gt;
  &lt;object type="Spring.Aop.Framework.AutoProxy.TypeNameAutoProxyCreator, Spring.Aop"&gt;
      &lt;property name="TypeNames" value="Aspects*"/&gt;
      &lt;property name="InterceptorNames"&gt;
          &lt;list&gt;
              &lt;value&gt;theExLogAdvice&lt;/value&gt;
          &lt;/list&gt;
      &lt;/property&gt;
  &lt;/object&gt;
</code></pre>

<p>This is first concept. The second which I found is to use aspect fo exception handling from the Spring Aspect library.</p>

<p><strong>2.Exception aspects from Spring.NET</strong></p>

<p>I would like create a handler for log exception and this handler will use the Log4net logger.</p>

<p><strong>Handler for exception:</strong></p>

<pre><code>&lt;object id="exLogHandler"
        type="Spring.Aspects.Exceptions.LogExceptionHandler, Spring.Aop"&gt;
    &lt;property name="LogName" value="???"/&gt;
    &lt;property name="LogLevel" value="Error"/&gt;
&lt;/object&gt;
</code></pre>

<p>and then use this handler in exception handle advice:</p>

<pre><code>&lt;object id="exLogAspect"
      type="Spring.Aspects.Exceptions.ExceptionHandlerAdvice, Spring.Aop"&gt;
    &lt;property name="ExceptionHandlerDictionary"&gt;
        &lt;dictionary&gt;
            &lt;entry key="log" ref="exLogHandler"/&gt;
        &lt;/dictionary&gt;
    &lt;/property&gt;

    &lt;property name="ExceptionHandlers"&gt;
        &lt;list&gt;
            &lt;value&gt;on exception name SomeException log 'Ex:' + #e&lt;/value&gt;
        &lt;/list&gt;
    &lt;/property&gt;
</code></pre>

<p></p>

<p>I am not sure if second way is good. Maybe it is stupidity.</p>

<p>It is possible configure LogExceptionHandler to use the Log4net logger?</p>
 How to use Spring AOP aspects with Groovy and Grails, specific caching example <p>We built a large insurance policy and claim management system using Grails and Groovy. Performance problems are slowing down the site because all 'READS' fetch from the database, which is not necessary since most data is static. We want to introduce a simple key/value cache in the Grails layer, but we don't want to litter the existing code with cache.get() and cache.set() code, we want to use aspects instead.</p>

<p>Here is a sample from our main controller....</p>

<pre><code>InsuranceMainController {
  def customer {
    //handles all URI mappings for /customer/customerId
  }

  def policy {
    //handles all URI mappings for /policy/policyId, 
  }

  def claim {
    //handles all URL mappings for /claim/claimId
  }
</code></pre>

<p>As far as the cache goes, assume for the moment it's a simple Map named "cache" that's available as a globally-scoped object, and objects in the cache are keyed by request URI...</p>

<pre><code>cache.put("/customer/99876", customerObject)
cache.put("/policy/99-33-ARYT", policyObject) 
</code></pre>

<p>Going back to the controller, if we just litter the code with cache.get()/set(), which is what we want to avoid using Spring AOP, we'll end up with messy code. We want to achieve the following functionality with apsects, or with just a simpler and cleaner implementation...</p>

<pre><code>InsuranceMainController {
  def customer {

    Object customer = cache.get(request.getRequestURI())
    if ( customer != null)
       //render response with customer object
    }else
       //get the customer from the database, then add to cache
       CustomerPersistenceManager customerPM = ...
       customer = customerPM.getCustomer(customerId)
       cache.put(request.getRequestURI(), customer)
    }
  }
</code></pre>

<p>We need examples that show how we can achieve the above functionality using Spring AOP or something simpler in Grails while avoiding the littering of the code with cache.get()/set(). Suggestions to refactor the existing controller are welcome if it's required to get AOP working properly.</p>

<p>Thanks in advance</p>
 how to get started with aspects in c# <p>I'v heard about aspects in a programming language and I was pretty enthusiastic about it. However I do not know how to get started with them. And I tought you guys may be set in the right direction.</p>
 Why a defined pointcut with @target doesn't work? <p>I'm trying to use Spring aspects to do save aditional data while storing documents with <code>MongoRepository</code>. The target is this interface:</p>

<pre><code>@InSearch
public interface ItemRepository extends MongoRepository&lt;Item, Long&gt;, 
    ItemRepositoryCustom 
{
    List&lt;Item&gt; findAllByUsername( String username );
    List&lt;Item&gt; findAllBySessionId( Long sessionId );
}
</code></pre>

<p>When I use this pointcut:</p>

<pre><code>@Pointcut( "execution(* save(..)) &amp;&amp; " + 
    "target(org.springframework.data.mongodb.repository.MongoRepository)" )
private void saveEntity()
{}
</code></pre>

<p>This method runs ok before <code>open</code> method is called:</p>

<pre><code>@Before( "saveEntity() &amp;&amp; args(entity)" )
public void beforeSavingEntity( JoinPoint jp, AuditedBean entity )
{ ... }
</code></pre>

<p>But I want it to run only with interfaces annotated with <code>@InSearch</code> so I tried to define the pointcut that way:</p>

<pre><code>@Pointcut( "execution(* save(..)) &amp;&amp; " +
    "target(org.springframework.data.mongodb.repository.MongoRepository) &amp;&amp; " +
    "@target(xx.annotations.InSearch)" )
private void saveEntity()
{}
</code></pre>

<p>The annotation definition:</p>

<pre><code>@Target( { ElementType.TYPE} )
@Retention(RetentionPolicy.RUNTIME)
public @interface InSearch
{}
</code></pre>

<p>With this pointcut the method <code>beforeSavingEntity</code> is not called. I've not any error on log. I'm not sure if I had understood the documentation about <code>@target</code> and his differences with <code>@within</code>. I've tried also with <code>@within</code> and didn't work either.</p>

<p>How must I define this pointcut to select <code>save</code> methods execution in a class that implements an interface that extends <code>MongoRepository</code> and is annotated with <code>@InSearch</code>?</p>

<p>Thank you!</p>
 Polymorphism in AspectJ <p>I am trying to decide which is the better way to dispatch on a type in AspectJ.
Suppose I am performing a computation on a tree with three kinds of nodes. I could then write a simple Java method:</p>

<pre><code>private void computation(TreeNode node) {
    if (node instanceof Node0) {
        // Do stuff.
    } else 
    if (node instanceof Node0) {
        // Do stuff.
    } else 
    if (node instanceof Node0) {
        // Do stuff.
    }
}
</code></pre>

<p>or</p>

<pre><code>private void computation(TreeNode node) {
    switch (node.kindNode()) {
        case NODE0:
            // Do stuff.
            break;
        case NODE1:
            // Do stuff.
            break;
        case NODE2:
            // Do stuff.
            break;
    }
}
</code></pre>

<p>or I could inject a method into each node type:</p>

<pre><code>private void Node.computation() {
    throw new UnsupportedOperationException(getClass() + ".computation()");
}

private void Node0.computation() {
    // Do stuff.
}

private void Node1.computation() {
    // Do stuff.
}

private void Node2.computation() {
    // Do stuff.
}
</code></pre>

<p>Which method is preferable and why?</p>
 PostSharp - break other aspects <p>I have two method that execute first the "Cache" aspect and next the "Log" aspect.
I want that, if I have a "cache hit" I don't have to Log anything! In other words, if a certain condition in "Cache" aspect is satisified then the "Log" aspect must be skipped.</p>

<p>Is it possible?</p>

<p>Thanks</p>
 Help create AspectJ equivellent to @PrePersist and @PreUpdate for audit use case <p>In JPA, there is @PrePersist and @PreUpdate annotations that allow operations before CRUD operations.
I am trying to find out the ApsectJ equivalent to this.</p>

<p>My use case is a JPA application that was built by one team, now would like to add an Audit Aspect to each Pre-Persist and Pre-Update that occurs, without adding a lifecycle listener to the original Entity.</p>
 Spring AOP with annotations Help Needed ! <p>Can anyone help me with some sample code?</p>

<p>I need to implement Spring AOP and Annotations to achieve a Db Audit or Logging, in a Services Level.</p>

<p>Some code I found online, but nothing very clear and tidy.</p>

<p>I tried it with examples, but I never could get the Interceptors work properly. And I could not run either of Advisors for example @Before or @After.</p>

<p>I've seen in the examples, most using the XML configuration file, but I know that in some cases use may be omitted. How and when?</p>

<p>And finally, it is really necessary and mandatory use of the @ Audit annotation and / or @ Pointcut?</p>

<p>I would greatly appreciate your help. I'm pretty clueless about it,</p>

<p>Thank you so much...
Cheers,</p>

<p>-CaktusJP-</p>
 What are the drawbacks of the Facade design pattern? <p>…and how can we overcome them using the aspect-oriented programming?</p>
 
